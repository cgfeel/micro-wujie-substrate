# micro-wujie-substrate

ä¸€ä¸ª `wujie` åŸºåº§ï¼Œå®Œæ•´å†…å®¹æŸ¥çœ‹å¾®å‰ç«¯ä¸»ä»“åº“ï¼šhttps://github.com/cgfeel/zf-micro-app

`wujie` å’Œå…¶ä»–çš„å¾®å‰ç«¯ï¼ˆ`qiankun`ã€`micro-app`ï¼‰è§£å†³æ–¹æ¡ˆä¸åŒç‚¹ï¼š

| å¯¹æ¯”é¡¹ | `wujie`                                        | å…¶ä»–å¾®å‰ç«¯                                  |
| ------ | ---------------------------------------------- | ------------------------------------------- |
| `js`   | ç›´æ¥æ”¾åˆ° `iframe` é‡Œ                           | æ”¾åˆ°è‡ªå·±å®ç°çš„æ²™ç®±ï¼Œå¦‚ï¼š`proxy`ã€å¿«ç…§ä¸­å®ç° |
| `css`  | ç›´æ¥æ”¾åˆ° `web component` é€šè¿‡ `shadowDOM` æ¸²æŸ“ | ä¿®æ”¹ `css` ä½œç”¨åŸŸ `scopedCSS`               |

ä¼˜ç‚¹ï¼Œå¤©ç„¶éš”ç¦»ï¼š

- ä¸éœ€è¦è‡ªå®šä¹‰æ²™ç®±ï¼Œç›´æ¥ä½¿ç”¨ `iframe`
- ä¸éœ€è¦éå† `css` è®¡ç®— `scoped`

äº®ç‚¹ï¼š

- ç†è®ºä¸Š `wujie` å¯ä»¥æŠŠä»»ä½•å¯¹å¤–æä¾›è®¿é—®çš„ç½‘é¡µåšæˆå­åº”ç”¨
- æä¾› `iframe` é™çº§æ–¹æ¡ˆï¼Œå¯¹äºä¸æ”¯æŒ `proxy` å’Œ `shadowDOM` çš„æƒ…å†µ

ç¼ºç‚¹ï¼š

- å¯¹ `React v18` å¹¶ä¸å‹å¥½ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šäº§ç”Ÿåè®®é”™è¯¯ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/issues/672)]
- è·¯ç”±åŒæ­¥å¹¶ä¸å‹å¥½ï¼Œå­åº”ç”¨è·¯ç”±åªèƒ½é€šè¿‡ `hash` ååº”åˆ°ä¸»åº”ç”¨ä¸­ï¼Œç›®å‰è¿˜æ²¡çœ‹åˆ°è§£å†³æ–¹æ¡ˆ

ç–‘æƒ‘ï¼š

- é¢‘ç¹çš„è‰å“Ÿ `Dom` æ˜¯ H ç›´æ¥å½±å“ `js` æ€§èƒ½çš„åŸå› 
- ç›®å‰å¾®å‰ç«¯æ¡†æ¶éƒ½ä¼šæœ‰è®¾ç½®åˆ°ï¼Œä½† `wujie` éœ€è¦é¢‘ç¹åŠ«æŒ `iframe` å’Œ `shadowDom` è¿›è¡Œé€šä¿¡
- æ¯”å¦‚è¯´é»˜è®¤æƒ…å†µä¸‹ `wuijie` çš„æ¯æ¬¡åº”ç”¨åˆ‡æ¢ï¼Œå°±æ˜¯ä¸€æ¬¡ `iframe` çš„æ³¨é”€å’Œé‡å»º

æ¸²æŸ“åŸç†ï¼š

| åˆ†ç±»        | åŸç†                                                                        |
| ----------- | --------------------------------------------------------------------------- |
| `wujie`     | æ‹‰å– `template` æ”¾å…¥ `web component`ï¼Œå°†è‡ªå®šä¹‰ç»„ä»¶æ’å…¥ `Dom`                |
| `micro-app` | åˆ›å»º `web component` æ‹‰å–èµ„æºï¼Œæ›¿æ¢æ ‡ç­¾ä¸ºè‡ªå®šä¹‰ç»„ä»¶ï¼Œå±•ç¤ºåœ¨ `Dom tree` ä¸­   |
| `qiankun`   | åŸºäº `single-spa`ï¼Œæ‹‰å– `template`ï¼ŒåŠ«æŒ `url` ç»è¿‡è®¡ç®—å°†èµ„æºæ¸²æŸ“åˆ°æŒ‡å®šå®¹å™¨ |

> `micro-app` ä¹Ÿæ”¯æŒ `shadowDom` å’Œ `iframe` æ²™ç®±ï¼Œä½†éœ€è¦åœ¨ `start` æ—¶æ‰‹åŠ¨å¯ç”¨

---

æœ¬æ¬¡æ€»ç»“åˆ†æˆ 3 ä¸ªéƒ¨åˆ†

- `wujie` ä½¿ç”¨
- `wujie` å¤ç°ï¼Œç®€å•å®ç° `iframe` å’Œ `shadowRoot` é€šä¿¡
- `wujie` åŸç†

å…³äº `wujie` æ‰€æœ‰çš„é¡¹ç›®å…¨éƒ¨æ•´åˆåœ¨ï¼š

- `/wujie` [[æŸ¥çœ‹](https://github.com/cgfeel/zf-micro-app/tree/main/wujie)]

## `wujie` ä½¿ç”¨

åŒ…å«é¡¹ç›®ï¼š

- `react-project`ï¼šé€šè¿‡ `create-react-app` æ­å»ºçš„å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra)]
- `substrate`ï¼šé€šè¿‡ `create-react-app` æ­å»ºçš„åŸºåº§ä¸»åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-qiankun-substrate)]
- `vue-project`ï¼šé€šè¿‡ `vue-cli` æ­å»ºçš„å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-vue3)]

### æ­å»ºåŸºåº§ä¸»åº”ç”¨

å…ˆå›é¡¾ä¸‹ `micro-app` åŸºåº§æµç¨‹ï¼š

- å…¥å£æ–‡ä»¶ `start` é…ç½®å¯åŠ¨é¡¹
- æŒ‡å®šé¡µé¢æ’å…¥è‡ªå®šä¹‰ç»„ä»¶ `<micro-app />`

> `micro-app` ä¼šå°†åŠ è½½çš„èµ„æºä¼ å…¥ `web component`

`wujie` å¯ä»¥ä¸ä½¿ç”¨ `start` å¯åŠ¨é…ç½®ï¼š

- åˆ›å»ºä¸€ä¸ªå…¬å…±çš„ç»„ä»¶ `Wujie.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/components/Wujie.tsx)]ï¼Œé€šè¿‡ `startApp` å°† `web component` æ·»åŠ çš„å­åº”ç”¨æ’å…¥æŒ‡å®šçš„ `ref`
- ä»»ä½•é¡µé¢å¯ä»¥é€šè¿‡è°ƒç”¨ç»„ä»¶çš„æ–¹å¼ï¼Œä¾‹å¦‚åŠ è½½ `react` å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/ReactPage.tsx)]

> `wujie` ä¸éœ€è¦å¼ºåˆ¶å¯åŠ¨é…ç½®ï¼Œä½†å¹¶ä¸ä»£è¡¨ä¸æ”¯æŒï¼Œè§ `setupApp` [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

ç å³°çš„è¯¾ç¨‹ä¸­æœ‰ä¸¤ä¸ªé”™è¯¯ï¼š

- å®˜æ–¹æ–‡æ¡£ä¸å»ºè®®æ‰‹åŠ¨æ³¨é”€ `destroyApp` å­åº”ç”¨ï¼Œå¦‚æœè¿˜éœ€è¦ä½¿ç”¨å­åº”ç”¨çš„è¯ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/destroyApp.html)]
- `startApp` ä¼šè¿”å›ä¸€ä¸ªæ–¹æ³• `destory`ï¼Œå¯ä»¥ç›´æ¥ç”¨äºæ³¨é”€åº”ç”¨ï¼Œè€Œä¸ç”¨ä¼ ç»™ `destroyApp`ï¼ŒåŒæ ·ä¹Ÿä¸å»ºè®®ä¸»åŠ¨æ³¨é”€ï¼Œä¼šå¯¼è‡´ä¸‹æ¬¡æ‰“å¼€è¯¥å­åº”ç”¨æœ‰ç™½å±æ—¶é—´

### æ­å»ºå­åº”ç”¨

`react` å­åº”ç”¨ï¼š

- éœ€è¦ä¿®æ”¹ç«¯å£å·ï¼š`.env` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra/blob/main/.env)]

`vue` å­åº”ç”¨ï¼š

- éœ€è¦å…è®¸ `cors`ï¼š`vue.config.js` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-vue3/blob/main/vue.config.js)]

### æ€»ç»“

`wujie` é…ç½®ç›¸å¯¹æ¥è¯´æ›´ç®€å•ï¼Œä½†æ˜¯å®ƒå­˜åœ¨ä¸¤ä¸ªè‡´å‘½çš„ç¼ºç‚¹ï¼š

- å¯¹ `React v18` å¹¶ä¸å‹å¥½ã€è·¯ç”±åŒæ­¥åªèƒ½ä½¿ç”¨ `hash`

> è·¯ç”±åŒæ­¥è¿™å—æˆ‘ç¿»äº†å®˜æ–¹æ–‡æ¡£ï¼Œè¿˜æ²¡æœ‰æ‰¾åˆ°è§£å†³æ–¹æ³•ï¼Œè¿™ç‚¹æˆ‘è‡ªå·±éƒ½æœ‰ç‚¹ä¸å¤ªç›¸ä¿¡

é€šè¿‡ä»¥ä¸Šäº†è§£å¯¹ `wujie` åˆæ­¥å°è±¡ï¼š

- `Tencent` çœŸçš„å¯¹é€šä¿¡éå¸¸åçˆ±ï¼Œæ¯”å¦‚ï¼š`alloy-worker` [[æŸ¥çœ‹](https://github.com/AlloyTeam/alloy-worker)]ï¼Œè¿˜æœ‰å°ç¨‹åº `postMessage`

---- åˆ†å‰²çº¿ ----

## `wujie` å¤ç°

ç®€å•å®ç° `iframe` å’Œ `shadowRoot` é€šä¿¡ï¼Œè¯¦ç»†è§é¡¹ç›®ä¸­çš„æºç ï¼š

- é¡¹ç›®ï¼š`static-project` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static)]
- æ–‡ä»¶ï¼š`index.html` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static/blob/main/index.html)]
- è¿è¡Œæ–¹å¼ï¼šç›´æ¥ç‚¹å¼€æµè§ˆå™¨é¢„è§ˆ

æ•´ä½“åˆ† 4 éƒ¨åˆ†ï¼š

- `index.html`ï¼šåŸºåº§ `html` æ–‡ä»¶
- `template`ï¼šå­åº”ç”¨è¦è¿è¡Œçš„ `css` å’Œ `html`ï¼Œè¦æ”¾å…¥ `shadowDOM` ä¸­
- `script string`ï¼šå­åº”ç”¨è¦æ‰§è¡Œçš„è„šæœ¬å­—ç¬¦ï¼Œè¦æ”¾å…¥ `iframe` ä¸­
- `web component`ï¼šä¸»åº”ç”¨è‡ªå®šä¹‰ç»„ä»¶

æµç¨‹åˆ† 4 éƒ¨åˆ†ï¼š

1. `createSandbox`ï¼šåˆ›å»ºæ²™ç®±
2. `attachShadow`ï¼šåˆ›å»º `shadowDom`
3. `injectTemplate`ï¼šå°† `css` å’Œ `html` æ³¨å…¥ `shadowDom`
4. `runScriptInSandbox`ï¼šå°† `js` æ³¨å…¥ `iframe`

æ²™ç®±åˆ† 2 ä¸ªï¼š

- `shadowRoot`ï¼šç›´æ¥å°† `css` å’Œ `html` å…¨éƒ¨æ‰“åŒ…åˆ°ä¸€ä¸ª `div`ï¼Œå¡å…¥ `shadowRoot`
- `iframe`ï¼šåˆ›å»ºä¸€ä¸ª `script` å…ƒç´ ï¼Œå°†æ‰§è¡Œçš„ `js` ä½œä¸ºå…ƒç´ å†…å®¹æ’å…¥ `iframe` çš„ `head`

éš¾ç‚¹ï¼ŒåŠ«æŒ `iframe` å†… `script` çš„æ–¹æ³•ï¼Œå°†ä¸Šä¸‹æ–‡æŒ‡å‘ `shadowRoot`ï¼š

- åœ¨ `script` æ’å…¥åˆ° `iframe` ä¹‹å‰ï¼Œé€šè¿‡ `Object.defineProperty` åŠ«æŒ `iframe` ä¸­çš„ `document.querySelector`
- è¿”å›ä¸€ä¸ª `Proxy` å¯¹è±¡ï¼Œä»£ç† `sandbox.shadowRoot.querySelector`
- åœ¨ `Proxy` ä¸­é€šè¿‡ `apply` çº æ­£ä¸Šä¸‹æ–‡ `this` æŒ‡å‘ `shadowDOM` è¿›è¡Œé€šä¿¡

`Object.defineProperty` åŠ«æŒå¯¹è±¡ä¼šæ‰§è¡Œä¸¤æ¬¡ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static/blob/d89ae52aa0418d9f7e3cec8ff289cd8dd5edbb1e/index.html#L80)]ï¼Œç¬¬ä¸€æ¬¡ï¼š

- ç”± `iframe` ä¸­çš„å­åº”ç”¨å‘èµ· `document.querySelector`
- é€šè¿‡ `Object.defineProperty` åŠ«æŒ `iframeWindow.Document.prototype` å¹¶è¿”å› `Promise` å¯¹è±¡
- åœ¨ `Promise` å¯¹è±¡é¦–æ¬¡ `apply` æ—¶ï¼Œå‚æ•° `thisArgs` æŒ‡å‘ `Object.defineProperty` åŠ«æŒçš„å¯¹è±¡
- å¹¶è¿”å› `thisArgs.querySelector`ï¼Œç›¸å½“äº `iframeWindow.Document.prototype.querySelector`ï¼Œé€šè¿‡ `apply` å°†ä¸Šä¸‹æ–‡æŒ‡å‘ `sandbox.shadowRoot`

ç¬¬äºŒæ¬¡ï¼š

- ç”±äºè¿”å›çš„å¯¹è±¡å†æ¬¡è°ƒç”¨äº† `iframe` å¯¹è±¡çš„ `querySelector`ï¼Œäºæ˜¯ç¬¬äºŒæ¬¡è¿›å…¥ `Object.defineProperty`
- è¿™ä¸ªæ—¶å€™è¿”å›çš„ `Promise` å¯¹è±¡ `apply` ä¸­ `thisArgs` æŒ‡å‘ `sandbox.shadowRoot`
- äºæ˜¯ç›¸å½“äºåœ¨ `shadowDOM` ä¸­æ‰§è¡Œäº† `sandbox.shadowRoot.querySelector.apply(sandbox.shadowRoot, args)`

> å¯ä»¥æ‰“å¼€è°ƒè¯•çª—å£ `sources` åœ¨ `Proxy` å¯¹è±¡çš„ `apply` æ–¹æ³•ä¸­æ‰“ä¸Šæ–­ç‚¹ï¼Œåˆ·æ–°æŸ¥çœ‹æ¯æ¬¡æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ `thisArgs` çš„å˜åŒ–

åŠ«æŒå¯¹è±¡åœºæ™¯å‘æ•£ï¼š

- æµ®çª—ï¼ŒåŠ«æŒåˆ°å…¨å±€çš„ `window` å»æ‰§è¡Œï¼š`document.body.appendChild(document.createElement())`
- `iframe` ä¸­çš„è·¯ç”±ç®¡ç† `history.pushState`ï¼Œå°†è¿™äº›æ–¹æ³•åŒæ­¥åˆ°ä¸»åº”ç”¨

---- åˆ†å‰²çº¿ ----

## `wujie` åŸç†

å’Œ `qiankun` è§£è¯»ä¸€æ ·ï¼Œä¸ºäº†ä¾¿äºé˜…è¯»å…¨éƒ¨ä»¥å½“å‰å®˜æ–¹ç‰ˆæœ¬ `9733864b0b5e27d41a2dc9fac216e62043273dd3` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/tree/9733864b0b5e27d41a2dc9fac216e62043273dd3)] ä¸ºå‡†

> è¿™ä¸€ç« èŠ‚é“¾æ¥æŒ‡å‘å®˜æ–¹ä»“åº“ï¼Œç”±äºå†…å®¹æ¯”è¾ƒé•¿ï¼Œæ¯ä¸€æ¡ä¿¡æ¯æˆ‘éƒ½æš´éœ²äº†å…³é”®çš„å¯¹è±¡åï¼Œå¯ä»¥æ‰“å¼€é“¾æ¥å¤åˆ¶å…³é”®çš„å¯¹è±¡åï¼ŒæŸ¥çœ‹ä¸Šä¸‹æ–‡å¯¹ç…§ç†è§£ã€‚

å…ˆå¤§è‡´çœ‹ä¸‹ `wujie` æä¾›çš„åŒ…ï¼Œåˆ†åˆ«ä¸º [[æŸ¥çœ‹](https://github.com/Tencent/wujie/tree/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages)]ï¼š

- `wujie-core`ï¼šæ ¸å¿ƒåŒ… [[æŸ¥çœ‹](#å®šä¹‰-web-component)]
- `wujie-react`ï¼š`React` å°è£…ç»„ä»¶ [[æŸ¥çœ‹](#packages---wujie-react)]
- `wujie-vue2`ï¼š`Vue2` å°è£…ç»„ä»¶
- `wujie-vue3`ï¼š`Vue3` å°è£…ç»„ä»¶

> ä¸æ˜¯ `vue` æŠ€æœ¯æ ˆï¼Œæ‰€ä»¥è¿™é‡Œæš‚ä¸”ç•¥è¿‡ï¼Œ`wujie` å°è£…çš„ç»„ä»¶åŒ…æ˜¯ä½œä¸ºå¯é€‰ä½¿ç”¨

### å®šä¹‰ `web component`

`wujie` å’Œ `micro-app` ç»„ä»¶å®šä¹‰ä¸åŒå¤„ï¼š

| åˆ†ç±»                       | `micro-app`                                                                                                                                                                                       | `wujie`                                                                                                                      |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- |
| æŒ‚è½½æ–¹å¼                   | æ‰‹åŠ¨ï¼šæŒ‚è½½ `web component` åˆ°æŒ‡å®š `components tree` ä¸­æ¸²æŸ“                                                                                                                                        | è‡ªåŠ¨ï¼šåˆæ¬¡æ¿€æ´» `active` åº”ç”¨æ—¶é€šè¿‡ `createWujieWebComponent` è‡ªåŠ¨åˆ›å»ºå®¹å™¨æ¸²æŸ“åˆ°æŒ‡å®šå®¹å™¨ï¼Œè§ï¼šæŒ‚è½½å­åº”ç”¨ [[æŸ¥çœ‹](æŒ‚è½½å­åº”ç”¨)] |
| è‡ªå®šä¹‰ç»„ä»¶å               | æ”¯æŒ                                                                                                                                                                                              | ä¸æ”¯æŒ                                                                                                                       |
| æ¥å—çš„å±æ€§                 | `name`ã€`url`ã€`iframe` ç­‰é…ç½®ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://micro-zoe.github.io/micro-app/docs.html#/zh-cn/configure?id=%e9%85%8d%e7%bd%ae%e9%a1%b9)]                                                | ä»…æ”¯æŒ `WUJIE_APP_ID`                                                                                                        |
| `attributeChangedCallback` | æ£€æŸ¥å­åº”ç”¨ `name` å’Œ `url` å±æ€§å˜æ›´ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#11-attributechangedcallback-%E8%A7%82%E5%AF%9F%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9)] | ä¸æ”¯æŒï¼Œä½†æ˜¯å­åº”ç”¨çš„ `name` å’Œ `url` å¯ä»¥ä½œä¸º `React` ç»„ä»¶çš„ `props`ï¼Œæ›´æ–°åé‡æ–°æ¸²æŸ“å¹¶æŒ‚è½½åˆ°å®¹å™¨                             |
| `connectedCallback`        | å£°æ˜ç»„ä»¶è‡ªå¢å˜ç¼–å·æ·»åŠ åˆ°ç»„ä»¶æ˜ å°„è¡¨ã€å‘èµ·åº”ç”¨æŒ‚è½½                                                                                                                                                  | æ ¹æ® `name` å±æ€§æ‹¿åˆ°å®ä¾‹ï¼šä¸ºæ²™ç®± `iframeWinow` æ‰“è¡¥ä¸ã€å°†å½“å‰ç»„å»ºæŒ‡å‘å®ä¾‹çš„ `shadowRoot`                                     |
| `disconnectedCallback`     | ç”¨ç»„ä»¶ç¼–å·ä»ç»„ä»¶æ˜ å°„è¡¨ä¸­ä¸‹çº¿ã€å‘èµ·åº”ç”¨å¸è½½                                                                                                                                                        | æ ¹æ® `name` å±æ€§æ‹¿åˆ°å®ä¾‹å¹¶å‘èµ·å¸è½½                                                                                           |
| è‡ªå®šä¹‰æ›´æ–°è§„åˆ™             | ä¸æ¥å—ï¼Œæ›´æ–°è§„åˆ™ç»„ä»¶å†…éƒ¨å®šä¹‰å¥½äº†åˆ™                                                                                                                                                                | ç”±å¼€å‘äººå‘˜è‡ªå·±å†³å®šï¼Œä¸€æ—¦æ›´æ–°åº”ç”¨å°±ä¸€å®šæ˜¯é‡æ–°æ¸²æŸ“                                                                             |
| å…¶ä»–ç”¨é€”                   | åº”ç”¨é€šä¿¡ã€èµ„æºå®¹å™¨ã€æ´¾å‘äº‹ä»¶ã€å†³å®šå¯åŠ¨å’Œæ³¨é”€æ–¹å¼                                                                                                                                                  | èµ„æºå®¹å™¨                                                                                                                     |
| ä¼˜ç¼ºç‚¹                     | å¼ºå¤§ï¼Œä½†åŠŸèƒ½ä¸Š `MicroAppElement` å¤„ç†å®Œä¹‹å `CreateApp` è¿˜è¦åšä¸€éå¯¹åº”æ“ä½œï¼Œå¦‚ï¼šç»„ä»¶å’Œåº”ç”¨åˆ†åˆ« `mount`                                                                                            | ç®€å•ï¼Œå¼€å‘è€…å‡ ä¹ä¸ç”¨å…³å¿ƒ `web component` çš„å­˜åœ¨                                                                              |

åŠ è½½ `WujieApp` è‡ªå®šä¹‰ç»„ä»¶æ–¹å¼ï¼š

- åœ¨å…¥å£æ–‡ä»¶ä¸­ç›´æ¥è°ƒç”¨ `defineWujieWebComponent` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L170)]
- å½“å¼•å…¥ `startApp` çš„æ—¶å€™ï¼Œå°±å·²ç»å®šä¹‰å¥½äº† `web component`

å…³äº `defineWujieWebComponent`ï¼š

ç›®å½•ï¼š`shadow.ts` - `defineWujieWebComponent` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L39)]

åªæä¾›äº†ä¸¤ä¸ªæ–¹æ³•ï¼š

- `connectedCallback`ï¼šå®ŒæˆæŒ‚è½½å°†è‡ªèº«è®¾ç½®ä¸º `shadowDOM`ï¼Œé€šè¿‡åº”ç”¨åè·å–å®ä¾‹ `sandbox`ï¼Œå°†è‡ªèº«ä½œä¸ºå®ä¾‹çš„ `shadowRoot`
- `disconnectedCallback`ï¼šå¸è½½ç»„ä»¶é€šè¿‡åº”ç”¨åè·å–å®ä¾‹ `sandbox`ï¼Œå¹¶è°ƒç”¨å®ä¾‹ `unmount`

åœ¨æŒ‚è½½ç»„ä»¶æ—¶ï¼Œå°†è‡ªèº«ä½œä¸ºå®ä¾‹ `shadowRoot` ä¹‹å‰éœ€è¦é€šè¿‡ `patchElementEffect` æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]

### `startApp` å¯åŠ¨æµç¨‹

ç›®å½•ï¼š`index.ts` - `startApp` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L185)]

åˆ† 3 æ­¥ï¼š

1. è·å–ã€æ›´æ–°é…ç½®ä¿¡æ¯
2. å­˜åœ¨æ²™ç®±å®ä¾‹å°±åˆ‡æ¢æˆ–é”€æ¯åº”ç”¨
3. ä¸å­˜åœ¨æ²™ç®±å®ä¾‹æˆ–è¢«é”€æ¯çš„åº”ç”¨ï¼Œåˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹

åˆ‡æ¢åº”ç”¨åˆ†ä¸º 3 ä¸ªæƒ…å†µï¼š

1. `alive` ä¿æ´»æ¨¡å¼å¯åŠ¨
2. å­åº”ç”¨é€šè¿‡ `window.__WUJIE_MOUNT` å‘èµ·æ¸²æŸ“
3. å…¶ä»–æ–¹å¼éƒ½æ³¨é”€å½“å‰å®ä¾‹

è¯¦ç»†è§æ–‡æ¡£ï¼šè¿è¡Œæ¨¡å¼ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/mode.html)]

![ä¼ä¸šå¾®ä¿¡æˆªå›¾_69bf2b27-521a-451b-9413-fa370efe73bd](https://github.com/cgfeel/micro-wujie-substrate/assets/578141/c4473f5d-9845-4df4-bac6-4506f8202a3d)

> `alive` æ¨¡å¼å’Œå­åº”ç”¨ `mount` åˆ‡æ¢åº”ç”¨åä¼šç›´æ¥è¿”å›ï¼Œå…¶ä»–æƒ…å†µé”€æ¯åº”ç”¨åä¼šé‡æ–°åˆ›å»ºå®ä¾‹ï¼Œå¦‚æœä½ çš„åº”ç”¨åœ¨åˆ‡æ¢æ—¶çœ‹åˆ°ç™½å±å»ºè®®ä½¿ç”¨ `alive` æˆ– `mount`

#### 1.1 `getWujieById`ï¼šè·å–å·²å­˜åœ¨çš„æ²™ç®±çš„å®ä¾‹

- ä½¿ç”¨åº”ç”¨åï¼Œé€šè¿‡ `getWujieById` [[æºç ](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L15)] ä»æ˜ å°„è¡¨ `idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)] è·å–æ²™ç®±ä¸­çš„å®ä¾‹
- å¦‚æœæ²™ç®±ä¸å­˜åœ¨è¿”å› `null`

#### 1.2 è·å–åº”ç”¨é…ç½®

`getOptionsById` è·å–é…ç½®ä¿¡æ¯ï¼š

- æ‹¿åº”ç”¨åï¼Œä»æ˜ å°„è¡¨ `idToSandboxCacheMap` è·å–å®ä¾‹é…ç½® `options`ï¼Œä¸å­˜åœ¨è¿”å› `null`

`mergeOptions` åˆå¹¶é…ç½®é…ç½®ï¼š

- å°† `startApp` æ‹¿åˆ°çš„ `options` å’Œå·²å­˜åœ¨å®ä¾‹çš„ `options` åˆå¹¶å¾—åˆ°æ–°çš„é…ç½®ä¿¡æ¯ï¼Œå¹¶ç»“æ„æå–å¿…è¦çš„ä¿¡æ¯ï¼Œè§æºæ–‡ä»¶ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L190)]

#### 2. å­˜åœ¨æ²™ç®±å®ä¾‹ï¼Œåˆ‡æ¢åº”ç”¨

åº”ç”¨åœºæ™¯ï¼š

| æ¨¡å¼         | `preloadApp` ååˆæ¬¡åŠ è½½                                                               | åˆ‡æ¢å·²åŠ è½½çš„åº”ç”¨         |
| ------------ | ------------------------------------------------------------------------------------- | ------------------------ |
| `alive` æ¨¡å¼ | æ”¯æŒ                                                                                  | æ”¯æŒ                     |
| `mount` æ¨¡å¼ | ç”±é¢„åŠ è½½æ—¶ `exec` é…ç½®å†³å®šï¼Œæ²¡æœ‰ `start` è‡ªç„¶ä¹Ÿä¸ä¼š `mount` æ–¹æ³•æŒ‚è½½åˆ° `iframeWindow` | æ”¯æŒ                     |
| å…¶ä»–æ¨¡å¼     | å°†é”€æ¯åº”ç”¨åé‡æ–°åˆ›å»ºå®ä¾‹                                                              | å°†é”€æ¯åº”ç”¨åé‡æ–°åˆ›å»ºå®ä¾‹ |

æ¸²æŸ“å‰çš„å‡†å¤‡ï¼š

- é€šè¿‡ `getPlugins` æ›´æ–°å®ä¾‹çš„ `plugins`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#plugins)]
- æ›´æ–°å®ä¾‹çš„ `lifecycles`ï¼Œ è§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/lifecycle.html)]
- è·å–å®ä¾‹çš„ `iframeWindow` å¯¹è±¡ï¼Œç”¨äºæŸ¥çœ‹å­åº”ç”¨æŒ‚è½½æ–¹æ³• `__WUJIE_MOUNT`
- å¦‚æœå®ä¾‹é¢„åŠ è½½åº”ç”¨ï¼Œéœ€è¦ç­‰å¾…é¢„åŠ è½½æ‰§è¡Œå®Œæ¯•ï¼Œè§ï¼š`runPreload` [[æŸ¥çœ‹](#3-é¢„åŠ è½½å¾®ä»»åŠ¡-runpreload)]

#### 2.1 `alive` ä¿æ´»æ¨¡å¼åˆ‡æ¢åº”ç”¨

å’Œ `micro-app` çš„ `keep-alive` æ¨¡å¼ä¸€æ ·ï¼š

- ä¼˜ç‚¹ï¼šåˆ‡æ¢è·¯ç”±ä¸é”€æ¯åº”ç”¨å®ä¾‹ï¼Œè·¯ç”±ã€çŠ¶æ€ä¸ä¼šä¸¢å¤±ï¼Œåœ¨æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æƒ…å†µä¸‹ï¼Œå‡å°‘ç™½å±æ—¶é—´
- ç¼ºç‚¹ï¼šå¤šä¸ªèœå•æ è·³è½¬åˆ°å­åº”ç”¨çš„ä¸åŒé¡µé¢ï¼Œä¸åŒèœå•æ æ— æ³•è·³è½¬åˆ°æŒ‡å®šå­åº”ç”¨è·¯ç”±

æµç¨‹åˆ† 3 æ­¥ï¼š

**ç¬¬ä¸€æ­¥ï¼šæ¿€æ´»åº”ç”¨**

- å°†æ‹¿åˆ°çš„é…ç½®ä¿¡æ¯æ¿€æ´»å­åº”ç”¨ï¼š`active`ï¼Œè§ï¼š1. `active` æ¿€æ´»åº”ç”¨ [[æŸ¥çœ‹](#1-active-æ¿€æ´»åº”ç”¨)]

è¿™é‡Œä¼šæœ‰ä¸ªé—®é¢˜ï¼š

- åœºæ™¯ï¼šé¢„åŠ è½½åº”ç”¨åå¯åŠ¨åº”ç”¨ï¼Œæ¯æ¬¡åˆ‡æ¢åº”ç”¨
- éƒ½ä¼šé‡å¤ `active` æ¿€æ´»åº”ç”¨ï¼Œå½±å“æ•ˆç‡

åŸå› ï¼š

- `active` æ¿€æ´»åº”ç”¨æœ¬èº«çš„æ„ä¹‰å°±æ˜¯å°†åº”ç”¨å®¹å™¨æ ¹æ®åŠ è½½çŠ¶æ€ï¼Œåœ¨ä¸åŒæŒ‚è½½ç‚¹æ¥å›åˆ‡æ¢
- è¿™æ˜¯ `wujie` å¤©ç„¶ç¼ºé™·ï¼Œä½†é€šå¸¸ä¸ä¼šå½±å“ä½¿ç”¨

**ç¬¬äºŒæ­¥ï¼š`start` åº”ç”¨**

é¢„åŠ è½½ä½†æ˜¯æ²¡æœ‰ `exec` å¯åŠ¨çš„æƒ…å†µä¸‹éœ€è¦ `start` åº”ç”¨ï¼š

- è°ƒç”¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ `beforeLoad`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#beforeload)]
- é€šè¿‡ `importHTML` æå–éœ€è¦åŠ è½½çš„ `script`ï¼Œè§ï¼š`importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- å°†æå–çš„æ–¹æ³• `getExternalScripts` ä¼ å…¥åº”ç”¨ `sandbox.start` å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

> åº”ç”¨å¯åŠ¨æ²¡æœ‰æ ¹æ® `execFlag` æ¥åˆ¤æ–­

åº”ç”¨ä¸­çš„ `css` åœ¨å“ªé‡Œå¤„ç†ï¼Ÿ

- `preloadApp` é¢„åŠ è½½å·²ç»é€šè¿‡ `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)] å¤„ç†åº”ç”¨å†…çš„é™æ€æ ·å¼
- `startApp` æ—¶æ— è®ºé¢„åŠ è½½

`alive` æ¨¡å¼æˆ– `umd` æ¨¡å¼ä¸‹åŠ è½½æ ·å¼çš„åœºæ™¯ï¼š

- é¢„åŠ è½½æ—¶æ›¿æ¢åº”ç”¨èµ„æºé€šè¿‡ `active` å°† `template` æŒ‚è½½åˆ°å®¹å™¨ï¼Œå¾…å¯åŠ¨åº”ç”¨æ—¶å°†å®¹å™¨ç§»åŠ¨åˆ°æŒ‡å®š `el` èŠ‚ç‚¹ï¼Œ`template` ä¸éœ€è¦å˜æ›´
- åˆæ¬¡å¯åŠ¨åº”ç”¨é€šè¿‡ `active` å°† `template` æŒ‚è½½åˆ°å®¹å™¨ï¼Œä¸‹æ¬¡åˆ‡æ¢åº”ç”¨æ—¶å®¹å™¨èµ„æºä¸å˜

å…¶ä»–æ¨¡å¼å¾€ä¸‹çœ‹åˆå§‹åŒ–åº”ç”¨å®ä¾‹

**ç¬¬ä¸‰æ­¥ï¼š`alive` åŠ è½½å®Œæˆ**

- è°ƒç”¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ `activated` å¹¶è¿”å›å­åº”ç”¨æ³¨é”€å‡½æ•° `sandbox.destroy`
- è¿™é‡Œå­˜åœ¨ `activated` è°ƒç”¨ 2 æ¬¡çš„æƒ…å†µï¼Œè§ï¼š6.é¢„åŠ è½½ä¸­çš„ `bug` [[æŸ¥çœ‹](#6é¢„åŠ è½½ä¸­çš„-bug)]

#### 2.2 `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨

é€šè¿‡ `umd` åˆ‡æ¢åº”ç”¨çš„æ¡ä»¶ï¼š

- å­åº”ç”¨å­˜åœ¨ `__WUJIE_MOUNT` æ–¹æ³•æŒ‚è½½åˆ° `window`
- é¢„åŠ è½½æ—¶é€šè¿‡ `exec` é¢„æ‰§è¡Œå `startApp`ï¼Œæˆ–å®Œæˆé¦–æ¬¡ `startApp` åæ¯æ¬¡åˆ‡æ¢å›åº”ç”¨

**ç¬¬ä¸€æ­¥ï¼šé‡æ–°åŠ è½½èµ„æº**

- å¸è½½åº”ç”¨å®ä¾‹ï¼Œè§ï¼š`unmount` [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]
- é‡æ–°æ¿€æ´»åº”ç”¨ï¼Œè§ï¼š`active` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
- æ¢å¤åŠ¨æ€åŠ è½½çš„æ ·å¼ï¼Œè§ `rebuildStyleSheets` [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]

`active` æ¿€æ´»åº”ç”¨ï¼š

- æ— è®ºæ˜¯ `preloadApp` å·²åŠ è½½è¿‡èµ„æºï¼Œè¿˜æ˜¯ `unmount` æ¸…ç©ºèµ„æºï¼Œæ¿€æ´»åº”ç”¨æ—¶éƒ½ä¼šé‡æ–°å°†èµ„æºæ³¨å…¥å®¹å™¨

`rebuildStyleSheets` æ¢å¤æ ·å¼ï¼š

- `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨åï¼Œåªä¿ƒå‘ `mount` å‡½æ•°æŒ‚è½½åº”ç”¨
- åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„æ ·å¼éœ€è¦é€šè¿‡ `styleSheetElements` æ”¶é›†å¹¶æ¢å¤ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]
- åº”ç”¨ä¸­çš„é™æ€æ ·å¼é€šè¿‡ `processCssLoader` æå–å¹¶æ›¿æ¢èµ„æº [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]

**ç¬¬äºŒæ­¥ï¼šæŒ‚è½½åº”ç”¨**

å’Œ `mount` æŒ‚è½½ `umd` æ¨¡å¼çš„åº”ç”¨æ˜¯ä¸€æ ·çš„ï¼Œè§ï¼š`umd` æ–¹å¼å¯åŠ¨ [[æŸ¥çœ‹](#1-umd-æ–¹å¼å¯åŠ¨)]ï¼Œä¸»è¦åšäº† 4 ä»¶äº‹ï¼š

1. ä½¿ç”¨æ²™ç®±çš„ `iframeWindow` æŒ‚è½½å‰è°ƒç”¨ `beforeMount`ï¼ŒæŒ‚è½½åè°ƒç”¨ `afterMount`
2. æŒ‚è½½åº”ç”¨ï¼Œè°ƒç”¨å­åº”ç”¨ `__WUJIE_MOUNT`
3. æ¿€æ´» `mountFlag` è¡¨æ˜å·²æŒ‚è½½ï¼Œé¿å…é‡å¤æŒ‚è½½
4. å°† `destroy` æ³¨é”€æ–¹æ³•è¿”å›

#### 2.3 `destory` æ³¨é”€åº”ç”¨

æ³¨é”€åº”ç”¨çš„åœºæ™¯åŒ…å«ï¼š

- `umd` é¦–æ¬¡ `startApp` åº”ç”¨ï¼ŒåŒ…æ‹¬é¢„åŠ è½½ `preloadApp` æ²¡æœ‰ `exec` é¢„æ‰§è¡Œå¯åŠ¨å¼•ç”¨
- é `alive` å’Œ `umd` æ¨¡å¼çš„åº”ç”¨ï¼Œæ— è®ºæ˜¯é¦–æ¬¡å¯åŠ¨è¿˜æ˜¯åˆ‡æ¢åº”ç”¨ï¼Œè¿˜æ˜¯é¢„åŠ è½½åå†å¯åŠ¨

æ‰€ä»¥ï¼š

- ä»¥ä¸Šåœºæ™¯ä¸‹åº”ç”¨éƒ½ä¼šæ³¨é”€å…ˆå‰çš„å®ä¾‹åå†é‡æ–°åˆ›å»ºå®ä¾‹
- åŒ…æ‹¬é‡æ–°æå–èµ„æºã€æ›¿æ¢èµ„æºã€è½¬å˜ä¸º `html` æ³¨å…¥å®¹å™¨ï¼ŒæŒ‚è½½å®¹å™¨ï¼Œç­‰ä¸€ç³»åˆ—æ“ä½œ
- å› æ­¤å¯èƒ½ä¼šå¯¼è‡´çŸ­æš‚ç™½å±çš„ç°è±¡ï¼Œè¦é¿å…è¿™ç§æƒ…å†µå»ºè®®ä½¿ç”¨ `alive` æˆ– `umd` æ¨¡å¼
- ä¹Ÿå› å¯¹äºé `alive` æ¨¡å¼çš„åº”ç”¨ï¼Œé¢„åŠ è½½å¯èƒ½æ˜¯ä¸€ä¸ªå¤šä½™çš„æ­¥éª¤ï¼Œè§ï¼šé¢„åŠ è½½ä¸­çš„ `bug` [[æŸ¥çœ‹](#6é¢„åŠ è½½ä¸­çš„-bug)]

### `preloadApp` é¢„åŠ è½½æµç¨‹

ç›®å½•ï¼š`index.ts` - `preloadApp` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L282)]

å‚æ•°ï¼š`preOptions`ï¼Œè§å®˜æ–¹æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/preloadApp.html)]

`preloadApp` é¢„åŠ è½½é€šè¿‡ `requestIdleCallback` åœ¨ç©ºé—²æ—¶é—´å¤„ç†ï¼Œä¸å¤„ç†çš„æƒ…å†µæœ‰ 2 ä¸ªï¼š

- åº”ç”¨å®ä¾‹å·²å­˜åœ¨
- å½“å‰çš„ `url` æŒ‚è½½çš„åº”ç”¨ä¸­åŒ…å«é¢„åŠ è½½çš„åº”ç”¨ï¼Œæ— éœ€é¢„åŠ è½½ç›´æ¥åŠ è½½

æ•´ä½“åˆ† 3 æ­¥ï¼š

1. è·å–é…ç½®
2. å£°æ˜ä¸€ä¸ªåº”ç”¨å®ä¾‹ `sandbox`
3. æŒ‚èµ·é¢„åŠ è½½å¾®ä»»åŠ¡ `runPreload`

#### 1. è·å–é…ç½®

- é€šè¿‡ `getOptionsById` è·å–é…ç½®ä¿¡æ¯ `cacheOptions`
- é€šè¿‡ `mergeOptions` åˆå¹¶å‚æ•° `preOptions` å’Œ `cacheOptions`ï¼Œä¼˜å…ˆé‡‡ç”¨ `preOptions`
- ä»åˆå¹¶çš„ `options` ä¸­æå–é…ç½®ç”¨äºé¢„åŠ è½½

> `cacheOptions` å­˜åœ¨äºï¼š
>
> - é€šè¿‡ `startApp` æå‰é…ç½® [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]ï¼Œå¦‚æœæ²¡æœ‰é…ç½®åˆ™ä¸å­˜åœ¨ã€‚
> - é…ç½®ä¿¡æ¯åªèƒ½é€šè¿‡ `startApp` ç¼“å­˜

#### 2. å£°æ˜ä¸€ä¸ªå®ä¾‹

- å°†æ‹¿åˆ°çš„é…ç½®ä¿¡æ¯é€šè¿‡ `Wujie` å£°æ˜å®ä¾‹ `sandbox`
- é€šè¿‡ `runPreload` ä¸ºå®ä¾‹æŒ‚èµ·ä¸€ä¸ªå¾®ä»»åŠ¡ `preload`

> å¾®ä»»åŠ¡æŒ‚è½½åœ¨å®ä¾‹ä¸Š `sandbox.preload`ï¼Œåœ¨åº”ç”¨åˆ‡æ¢æ—¶å€™ä¼šä½œä¸º `await`ï¼Œè¿™ç§æ–¹å¼å’Œ `qiankun` ä¸­çš„ `frameworkStartedDefer` åŸç†æ˜¯ä¸€æ ·çš„

#### 3. é¢„åŠ è½½å¾®ä»»åŠ¡ `runPreload`

- ä½¿ç”¨ `iframeWindow` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `beforeLoad`
- é€šè¿‡ `importHTML` è·å–ï¼š`template`ã€`getExternalScripts`ã€`getExternalStyleSheets`ï¼Œè§ `importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- é€šè¿‡ `processCssLoader` å°†æ‰§è¡Œ `importHTML` æ—¶ï¼Œæ›¿æ¢æˆæ³¨é‡Šçš„æ ·å¼æ›´æ–°ä¸ºå¯¹åº”çš„å†…è”æ ·å¼
- æ¿€æ´»åº”ç”¨ `active` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
- æ ¹æ®é…ç½® `exec` å†³å®šæ˜¯å¦å¯åŠ¨åº”ç”¨ `start`

> è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå½“ `exec` ä¸æˆç«‹æ—¶ `await getExternalScripts()` æ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œè§ï¼šæ³¨ n `scriptResultList` [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]

#### 4. å¯¹æ¯” `startApp` çš„é…ç½®

åªè¯´å‡ ä¸ªå…³é”®æ€§çš„é…ç½®

é¢„åŠ è½½ç¼ºå°‘ `loading`ï¼š

- é¢„åŠ è½½çš„åº”ç”¨ä¸éœ€è¦ `loading`ï¼Œè€Œ `startApp` å³ä¾¿ä¸ä¼ å…¥ `loadinng` çš„æƒ…å†µä¸‹ä¹Ÿä¼šæ’å…¥ä¸€ä¸ªç©ºçš„ `loading`
- æ— è®ºæ’å…¥ `loading` ä¸å¦ï¼Œéƒ½ä¼šåœ¨èµ„æºæ³¨å…¥å®¹å™¨å‰éå†å¹¶æ¸…ç©ºå®¹å™¨
- ä¸åŒçš„æ˜¯ï¼šæä¾› `loading` çš„ `startApp` æ˜¯åœ¨ `addLoading` æ¸…ç©ºå®¹å™¨ï¼Œé¢„åŠ è½½æ˜¯é€šè¿‡ `active` åœ¨ `renderElementToContainer` æ¸…ç©ºå®¹å™¨ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]

é¢„åŠ è½½ä¸éœ€è¦æä¾›æŒ‚è½½å®¹å™¨ `el`ï¼š

- åº”ç”¨æ²™ç®±çš„ `iframe` å°†ä½œä¸ºä¸´æ—¶çš„å®¹å™¨ï¼Œåº”ç”¨ä¼šåœ¨æ¿€æ´»æ—¶ `active` æ³¨å…¥ `iframe`
- è€Œ `iframe` åœ¨é¡µé¢ä¸­æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤ä¹Ÿçœ‹ä¸åˆ°é¢„åŠ è½½çš„åº”ç”¨
- åœ¨å¯åŠ¨åº”ç”¨æ—¶ `active` ä¼šä»æ²™ç®± `iframe` å–å‡ºæ¥æ”¾å…¥æŒ‡å®š `el` ä¸­

åœ¨è¿™é‡Œå¼•å‘äº†ä¸€ä¸ªæ€è€ƒï¼š

- æŠŠæ‰€æœ‰çš„å­åº”ç”¨å…¨éƒ¨é¢„åŠ è½½åˆ° `iframe` ä¸­ï¼Œä¼šä¸ä¼šå¯¹åŸºåº§çš„ `document` äº§ç”Ÿå½±å“
- ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå¯¹æ­¤åšäº†ä¸€ä¸ªæµ‹è¯•ï¼š10w è¡¨å•åœ¨ `document` å’Œ `iframe` ä»¥åŠ `shadowDom` ä¸‹ä¸åŒçš„è¡¨ç° [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/xxoVLXx)]

#### 5. é€šè¿‡ `exec` é¢„æ‰§è¡Œ

- ä»… `preloadApp` æ”¯æŒçš„é…ç½®é¡¹ï¼Œ`exec` ä¼šåœ¨é¢„åŠ è½½æ—¶å¯åŠ¨åº”ç”¨ `start`
- å’Œ `startApp` ä¸€æ ·ï¼Œä¹Ÿä¼šå°†å­åº”ç”¨ä¸­çš„ `script` æ’å…¥æ²™ç®± `iframe`ï¼Œè°ƒç”¨ `mount` ç­‰ç›¸å…³äº‹ä»¶å’Œæ–¹æ³•

åœ¨ `micro-app` ä¸­ä¹Ÿæœ‰é¢„åŠ è½½ï¼ŒåŒºåˆ«åœ¨äºï¼š

| åˆ†ç±»                         | `micro-app`                                                  | `wujie`                                                  |
| ---------------------------- | ------------------------------------------------------------ | -------------------------------------------------------- |
| åŠ è½½æ–¹å¼                     | é€šè¿‡ `start` é…ç½® `preFetchApps`ï¼Œæˆ–é€šè¿‡ `microApp.preFetch` | åªèƒ½é€šè¿‡ `preloadApp`                                    |
| ä»…åŠ è½½é™æ€èµ„æº               | æ”¯æŒ                                                         | ä¸æ”¯æŒ                                                   |
| å°†è½½é™æ€èµ„æºè§£ææˆå¯æ‰§è¡Œä»£ç  | è§£æå¹¶å¤„ç†èµ„æºï¼Œä¸æ¸²æŸ“                                       | å°†èµ„æºä¸­çš„ `script` å’Œæ ·å¼æ›¿æ¢æˆæ³¨é‡Šï¼Œæš‚å­˜åœ¨æ²™ç®±ä¸­ä¸å¯è§ |
| æ‰§è¡Œä»£ç å¹¶åœ¨åå°æ¸²æŸ“         | æ”¯æŒ                                                         | `active` æ³¨å…¥èµ„æºï¼Œ`start` å¯åŠ¨åº”ç”¨                      |
| å…³é—­æ²™ç®±å’Œæ ·å¼ä½œç”¨åŸŸ         | å¯é€‰                                                         | ä¸æ”¯æŒ                                                   |
| å…³é—­å­åº”ç”¨è¯·æ±‚çš„è‡ªåŠ¨è¡¥å…¨     | å¯é€‰                                                         | ä¸æ”¯æŒ                                                   |

- é¢„åŠ è½½å‚è€ƒï¼Œè§ï¼š`microApp.start` - æ³¨ â‘¥ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#microappstart-%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8)]
- `wujie` é¢„æ‰§è¡Œä¸»è¦ä½“ç°åœ¨æ²™ç®±å¯¹é¢„æ¸²æŸ“çš„å¤„ç†ï¼Œè§ï¼š2.3. `WithSandBox` é»˜è®¤æ²™ç®± - çœ‹é¢„æ¸²æŸ“ç›¸å…³éƒ¨åˆ† [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#23-withsandbox-%E9%BB%98%E8%AE%A4%E6%B2%99%E7%AE%B1)]

#### 6.é¢„åŠ è½½ä¸­çš„ `bug`

é—®é¢˜ 1ï¼š`activated` é‡å¤è°ƒç”¨

- é¢„åŠ è½½ `alive` æ¨¡å¼çš„åº”ç”¨ï¼Œé»˜è®¤ `exec` ä¸é¢„æ‰§è¡Œï¼Œåœ¨ `startApp` å¯åŠ¨åº”ç”¨çš„æ—¶å€™ç”Ÿå‘½å‘¨æœŸ `activated` ä¼šè°ƒç”¨ 2 æ¬¡

ä¸ºä»€ä¹ˆ 2 æ¬¡ï¼š

- `start` åº”ç”¨æ—¶ `mount` è°ƒç”¨ 1 æ¬¡
- `start` ä¹‹åè¿”å› `destory` å‰è°ƒç”¨ 1 æ¬¡

é—®é¢˜ 2ï¼šé¢„åŠ è½½é€»è¾‘é—®é¢˜

åŒ…å«åœºæ™¯ï¼š

- é¢„åŠ è½½ä½†æ²¡æœ‰é¢„æ‰§è¡Œçš„ `umd` æ¨¡å¼çš„åº”ç”¨
- é `alive` ä¹Ÿé `umd` æ¨¡å¼çš„åº”ç”¨

è¯•æƒ³ä¸‹é¢„åŠ è½½æµç¨‹ï¼š

1. é¢„åŠ è½½ä¸€ä¸ªé `alive` æ¨¡å¼çš„åº”ç”¨ï¼Œé€šè¿‡ `WuJie` åˆ›å»ºä¸€ä¸ªå®ä¾‹ [[æŸ¥çœ‹](#wujie-åº”ç”¨ç±»)]ï¼Œå¹¶æ·»åŠ åˆ°æ˜ å°„è¡¨ `idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]
2. `startApp` å¯åŠ¨åº”ç”¨ï¼Œé€šè¿‡ `getWujieById` æ‹¿åˆ°åº”ç”¨å®ä¾‹ï¼Œç”±äºä¸æ˜¯ `alive` æ¨¡å¼ï¼Œéšå³é”€æ¯å®ä¾‹ `destroy`
3. æœ€åé‡æ–°é€šè¿‡ `WuJie` åˆ›å»ºå®ä¾‹ï¼Œå†æ¬¡æ¿€æ´»ã€å¯åŠ¨å¹¶æŒ‚è½½åº”ç”¨

é—®é¢˜æ¥äº†ï¼š

- ä¸Šè¿°è¿‡ç¨‹ä¸­çš„ç¬¬ä¸€æ­¥ `preloadApp` çš„æ„ä¹‰åœ¨å“ªé‡Œå‘¢
- åæ­£éƒ½ä¼šåœ¨ `startApp` å¯åŠ¨åº”ç”¨æ—¶æ³¨é”€ï¼Œåè€Œæ˜¯ä¸é€šè¿‡ `preloadApp` è¿˜èƒ½å‡å°‘ `destory` è¿™ä¸€æ­¥éª¤

è¿™ä¹ŸåŒ…æ‹¬äº†é¢„åŠ è½½æ²¡æœ‰é¢„æ‰§è¡Œçš„ `umd` æ¨¡å¼åº”ç”¨ï¼š

- å› ä¸ºæ²¡æœ‰ `start` å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]ï¼Œé˜Ÿåˆ—æ‰§è¡Œ `script`
- åˆæ¬¡ `startApp` æ²¡æœ‰ `__WUJIE_MOUNT` æ–¹æ³•ï¼ŒåŒæ ·ä¹Ÿä¼š `destory` åé‡æ–°åˆ›å»ºå®ä¾‹

### `Wujie` åº”ç”¨ç±»

ç›®å½•ï¼š`sandbox.ts` - `Wujie` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L50)]

ç”¨äºåˆ›å»ºä¸€ä¸ªåº”ç”¨å®ä¾‹ï¼Œå’Œ `micro-app` çš„ `CreateApp` æ˜¯ä¸€æ ·çš„ï¼š

| åˆ†ç±»           | `micro-app`                                                                                               | `wujie`                                                                  |
| -------------- | --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| åˆ›å»ºå®ä¾‹       | `CreateApp`ï¼šåº”ç”¨å®ä¾‹                                                                                     | `Wujie`ï¼šåº”ç”¨å®ä¾‹ï¼Œä¹Ÿæ˜¯æ²™ç®±å®ä¾‹                                          |
| æ˜ å°„è¡¨         | `appInstanceMap` å­˜åº”ç”¨å®ä¾‹ï¼Œå’Œç»„ä»¶æ˜ å°„è¡¨ä¸åŒ                                                             | `idToSandboxCacheMap` å”¯ä¸€æ˜ å°„è¡¨ï¼Œç»„ä»¶æŒ‚è½½æ—¶é€šè¿‡ `name` ä»æ˜ å°„è¡¨è·å–å®ä¾‹ |
| æ˜ å°„è¡¨æ·»åŠ æ–¹å¼ | `appInstanceMap.set`                                                                                      | `addSandboxCacheWithWujie`                                               |
| åŠ è½½èµ„æº       | è‡ªåŠ¨ï¼šæ„é€ å‡½æ•°è°ƒç”¨ `loadSourceCode`                                                                       | æ‰‹åŠ¨ï¼š`active` æ¿€æ´»åº”ç”¨                                                  |
| å¯åŠ¨æ²™ç®±       | æ„é€ å‡½æ•°è°ƒç”¨ `createSandbox`                                                                              | æ„é€ å‡½æ•°è°ƒç”¨ `iframeGenerator`                                           |
| æ²™ç®±æ”¯æŒ       | `proxy`ã€`iframe`                                                                                         | `iframe`                                                                 |
| æ‰‹åŠ¨ `start`   | ä¸æ”¯æŒæ‰‹åŠ¨å¯åŠ¨ï¼Œé€šè¿‡ `mount` æŒ‚è½½                                                                         | `startApp` æˆ– `preloadApp` æ—¶è°ƒç”¨åº”ç”¨ `start` æ–¹æ³•                       |
| `mount` åº”ç”¨   | è‡ªåŠ¨ï¼šç”±ç»„ä»¶æˆ–èµ„æºåŠ è½½å®Œæ¯•å†³å®šï¼Œåœ¨ `mount` ä¸­ä¼š `start` æ²™ç®±                                              | ä¸æ”¯æŒå¤–éƒ¨è°ƒç”¨ï¼Œç”± `start` æ–¹æ³•é€šè¿‡é˜Ÿåˆ—æ‰§è¡Œ                              |
| `unmount` åº”ç”¨ | ç”±ç»„ä»¶ `disconnectedCallback` å‘èµ·                                                                        | ç”±ç»„ä»¶ `disconnectedCallback` å‘èµ·                                       |
| å¤æ‚åº¦         | åˆ†äº† 3 ç±»ï¼Œç»„ä»¶å®ä¾‹ï¼š`MicroAppElement`ï¼Œåº”ç”¨å®ä¾‹ï¼š`CreateApp`ï¼Œæ²™ç®±å®ä¾‹ï¼š`IframeSandbox` æˆ– `WithSandBox` | åªè¦å…³å¿ƒå®ä¾‹ `Wujie`ã€ç»„ä»¶å®ä¾‹å‡ ä¹å¯ä»¥å¿½ç•¥                               |
| ä¼˜ç‚¹           | æ”¯æŒæ›´å¹¿æ³›ï¼Œæ”¯æŒå¤šç§æ²™ç®±ï¼Œå¤šä¸ªéš”ç¦»æ–¹å¼                                                                    | ç®€å•ï¼Œä¸“æ³¨ `iframe` æ²™ç®±ï¼Œæ”¯æŒé™çº§å¤„ç†                                   |
| ç¼ºç‚¹           | è¿‡äºå¤æ‚ï¼Œä»è¯­æ„ä¸Šçœ‹ï¼Œæœ‰çš„æ–¹æ³•åœ¨ 3 ä¸ªå®ä¾‹ä¸Šç›¸äº’é‡å ï¼Œå®¹æ˜“æ··æ·†ï¼Œé™¤æ­¤ä¹‹å¤–å¹¶ä¸æ”¯æŒé™çº§å¤„ç†                   | è¿‡äºé›¶æ•£ï¼Œç¼ºä¹é€»è¾‘æŠ½è±¡åˆ†ç¦»                                               |

> æ— è®ºæ˜¯ `wujie` è¿˜æ˜¯ `micro-app` åœ¨è§£è¯»çš„åˆ†æ”¯æºç ä¸­éƒ½å­˜åœ¨ä¸åŒçš„é€»è¾‘é—®é¢˜

#### ğŸ“ `constructor` æ„é€ å‡½æ•°

#### 1. `inject` æ³¨å…¥å­åº”ç”¨ 3 ä¸ªå¯¹è±¡ï¼š

- `idToSandboxMap`ï¼š`appInstanceMap` åº”ç”¨å®ä¾‹æ˜ å°„è¡¨ [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]
- `appEventObjMap`ï¼š`EventBus` äº‹ä»¶æ˜ å°„è¡¨ [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]
- `mainHostPath` ä¸»åº”ç”¨ `host`

è¿™é‡Œåšäº†ä¸ªåˆ¤æ–­ï¼š

| æ‰€åœ¨ç¯å¢ƒ                 | åµŒå¥—æƒ…å†µ   | æ³¨å…¥æ–¹å¼                                               |
| ------------------------ | ---------- | ------------------------------------------------------ |
| åŸºåº§åˆ›å»ºåº”ç”¨å®ä¾‹         | ä½œä¸ºå­åº”ç”¨ | é€šè¿‡ `window.__WUJIE.inject` ä»ä¸Šä¸€å±‚è·å–æ•´ä¸ªæ³¨å…¥å¯¹è±¡  |
| åŸºåº§åˆ›å»ºåº”ç”¨å®ä¾‹         | æœ€é¡¶å±‚åŸºåº§ | å£°æ˜æœ€åˆè¦æ³¨å…¥çš„å¯¹è±¡ `this.inject`                     |
| å­åº”ç”¨é€šè¿‡ `window` è°ƒç”¨ | ä½œä¸ºå­åº”ç”¨ | `window.__WUJIE.inject[name]` ä»ä¸Šä¸€å±‚è·å–å¯¹åº”çš„æ˜ å°„è¡¨ |

> è¿™æ ·æ— è®ºæ˜¯å­åº”ç”¨è¿˜æ˜¯åŸºåº§ï¼Œæœ€ç»ˆæ‹¿åˆ°çš„ `inject` å¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªï¼Œè§ï¼š`appEventObjMap` æµç¨‹å›¾ [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]

#### 2. æå–é…ç½®åˆå§‹åŒ–å±æ€§

è§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]ï¼Œåˆ—ä¸¾å‡ ä¸ªå…³é”®å±æ€§ï¼š

**`degrade` ä¸»åŠ¨é™çº§**

- ç”±é…ç½®æä¾›ï¼Œå¦‚æœæ²¡æœ‰æä¾›ä¹Ÿä¼šæ ¹æ®å½“å‰ç¯å¢ƒå†³å®šæ˜¯å¦é‡‡ç”¨é™çº§æ–¹æ¡ˆ

**`plugins` æ’ä»¶ç³»ç»Ÿ**

- é€šè¿‡ `getPlugins` æ‹å¹³é…ç½®ï¼Œå¹¶åˆå¹¶é»˜è®¤çš„æ’ä»¶è¿”å›ä¸€ä¸ªæ•°ç»„

**`bus` äº‹ä»¶é€šä¿¡**

- é€šè¿‡ `EventBus` è¿›è¡Œé€šä¿¡ï¼Œ`EventBus` ä¾èµ– `appEventObjMap` ç¡®ä¿çˆ¶å­é€šä¿¡å¯¹è±¡å”¯ä¸€æ€§ï¼Œè§ï¼šå­˜å‚¨ `eventBus` æ‰˜ç®¡çš„äº‹ä»¶ [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]
- åŒæ—¶å°† `bus` èµ‹å€¼ç»™ `provide` å¯¹è±¡ï¼Œä½¿å­åº”ç”¨å†…éƒ¨å¯ä»¥é€šè¿‡ `window.$wujie?.bus` è¿›è¡Œé€šä¿¡

#### 3. åˆ›å»ºæ²™ç®± `iframe`

**æå–é“¾æ¥**

- é€šè¿‡ `appRouteParse` æå– `urlElement`ã€`appHostPath`ã€`appRoutePath` [[æŸ¥çœ‹](#approuteparse-æå–é“¾æ¥)]
- è·å–åŸºåº§çš„ `host`ï¼š`mainHostPath`

#### ğŸ“ `active` æ¿€æ´»åº”ç”¨

åˆ† 2 éƒ¨åˆ†ï¼š

1. æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯ï¼ŒåŒ…å«ï¼šæ²™ç®± `iframe` åˆå§‹åŒ–ã€ä¿®æ­£ `fetch`ã€åŒæ­¥è·¯ç”±
2. æŒ‚è½½å­åº”ç”¨

æŒ‚è½½å­åº”ç”¨åˆå¯ä»¥åˆ†ä¸º 3 ç§æƒ…å†µï¼š

1. `degrade` ä¸»åŠ¨é™çº§æ¸²æŸ“
2. åˆ‡æ¢åº”ç”¨
3. åº”ç”¨åˆå§‹åŒ–ï¼ŒåŒ…å«ï¼šæ­£å¸¸åŠ è½½ã€é¢„åŠ è½½

æœ‰ 4 ç§æƒ…å†µä¼š `active` æ¿€æ´»åº”ç”¨ï¼š

- `startApp` åˆ‡æ¢ `alive` ä¿æ´»æ¨¡å¼çš„åº”ç”¨
- `startApp` åˆ‡æ¢ `umd` æ¨¡å¼çš„åº”ç”¨
- `startApp` åˆ›å»ºæ–°çš„åº”ç”¨å®ä¾‹
- `preloadApp` é¢„åŠ è½½åº”ç”¨

åœ¨ `active` æ¿€æ´»åº”ç”¨æ—¶å®¹å™¨èŠ‚ç‚¹å˜æ›´æœ‰ 4 ç§æƒ…å†µï¼š

| åœºæ™¯                     | å®¹å™¨        | `degrade` é™çº§ | `el` å®¹å™¨æŒ‚è½½ç‚¹ | å®¹å™¨æŒ‚è½½ä½ç½®    |
| ------------------------ | ----------- | -------------- | --------------- | --------------- |
| é¢„åŠ è½½åº”ç”¨ã€åˆæ¬¡å¯åŠ¨åº”ç”¨ | `iframe`    | `true`         | æ²¡æœ‰            | æ²™ç®± `iframe`   |
| å¯åŠ¨åº”ç”¨ã€æ¯æ¬¡åˆ‡æ¢åº”ç”¨   | `iframe`    | `true`         | å·²æä¾›          | `el` å®¹å™¨æŒ‚è½½ç‚¹ |
| é¢„åŠ è½½åº”ç”¨ã€åˆæ¬¡å¯åŠ¨åº”ç”¨ | `shadowDom` | `false`        | æ²¡æœ‰            | æ²™ç®± `iframe`   |
| å¯åŠ¨åº”ç”¨ã€æ¯æ¬¡åˆ‡æ¢åº”ç”¨   | `shadowDom` | `false`        | å·²æä¾›          | `el` å®¹å™¨æŒ‚è½½ç‚¹ |

> æ¯æ¬¡ `active` ä¼šæ ¹æ®å½“å‰æƒ…å†µæ¥é€‰æ‹©å®¹å™¨å’ŒæŒ‚è½½çš„èŠ‚ç‚¹

#### å…ˆçœ‹æ¿€æ´»åº”ç”¨çš„ `bug`

å¯åŠ¨åº”ç”¨ä¸æä¾› `el` å®¹å™¨

- è™½ç„¶åœ¨ `ts` è§„èŒƒé‡Œå·²æ˜ç¡®è¦æ±‚å¿…é¡»æä¾› `el` å®¹å™¨ï¼Œä½†æ˜¯å¦‚æœ `ignore` æˆ– `js` é¡¹ç›®å°±æ²¡æä¾›æ€ä¹ˆåŠå‘¢ï¼Ÿ

è§¦å‘æƒ…å†µï¼š

- å—å½±å“ï¼šåˆ‡æ¢ `shadowDom` å®¹å™¨çš„åº”ç”¨
- ä¸å—å½±å“ï¼šé¢„åŠ è½½ã€æ²¡æœ‰é¢„åŠ è½½åˆæ¬¡å¯åŠ¨ã€é™çº§å¤„ç†ï¼Œä¼šå°†æ²™ç®± `iframe` ä½œä¸ºå¤‡ç”¨å®¹å™¨

è§£å†³åŠæ³•ï¼š

- å’Œ `micro-app` ä¸€æ ·åšæ¡ä»¶åˆ¤æ–­ï¼Œæ¡ä»¶ä¸æ»¡è¶³çš„æƒ…å†µç›´æ¥è¿”å›ä¸åšä»»ä½•æ¸²æŸ“

#### 1. æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯

ç¬¬ä¸€æ­¥ï¼šæ›´æ–°é…ç½®ä¿¡æ¯

- å°† `props` æ‹¿åˆ°çš„ä¿¡æ¯æ›´æ–°å½“å‰å®ä¾‹

å…¶ä¸­ `this.replace` éœ€è¦è¯´æ˜ä¸‹ï¼š

- æ¥è‡ªï¼š`startApp`ã€`setupApp`ã€`preloadApp` é…ç½® `replace`ï¼Œè¯¦ç»†è§æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#replace)]

ç”¨é€”ï¼š

- `processCssLoader`ï¼šæ›¿æ¢åº”ç”¨çš„ `template` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
- `insertScriptToIframe`ï¼šé€šè¿‡ `getJsLoader` æ›¿æ¢æ¯ä¸€ä¸ª `script` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]
- `getCssLoader`ï¼šæ›¿æ¢æ ·å¼ï¼ŒåŒ…å« `rewriteAppendOrInsertChild` å’Œ `processCssLoaderForTemplate` [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)]

> `getCssLoader` ä¸èƒ½å¤„ç†å­åº”ç”¨å†…ç½®æ ·å¼

`this.replace` å¹¶éå¿…è¦å‚æ•°ï¼Œä¸éœ€è¦æ›¿æ¢å°±ä¸ç”¨æä¾›ï¼š

- `replace` çš„å›è°ƒçš„å‚æ•°åªæœ‰ `code`ï¼Œæ‹¿ä¸åˆ°å…·ä½“çš„ç±»å‹ï¼Œåªèƒ½æ ¹æ®å…·ä½“ä»£ç è¿›è¡Œæ›¿æ¢

ç¬¬äºŒæ­¥ï¼šç­‰å¾… `iframe` åˆå§‹åŒ– `await this.iframeReady`

> å…³äº `iframeReady`ï¼š
>
> ç›®å½•ï¼š`iframe.ts` - `iframeGenerator` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L815)]
>
> - ç›®çš„ç”¨äºç¡®ä¿ `iframe` åˆå§‹åŒ–
> - åœ¨ `Wujie` å®ä¾‹æ„é€ å‡½æ•°æ—¶ `iframeGenerator` å·²å‘èµ·äº† `stopIframeLoading` å¾®ä»»åŠ¡
> - åœ¨æ¿€æ´»æ—¶é€šè¿‡ `this.iframeReady` ç¡®ä¿å·²å®Œæˆäº†åˆå§‹åŒ–
> - ä¿æ´»çš„æƒ…å†µä¸‹åˆ‡å›åº”ç”¨å¯èƒ½ä¸éœ€è¦è€ƒè™‘ï¼Œé™¤æ­¤ä¹‹å¤–åœ¨åº”ç”¨åŠ è½½ä¹Ÿéœ€è¦é€šè¿‡ `active` æ¥æ¿€æ´»åº”ç”¨ï¼Œè¿™ä¸ªæ—¶å€™ `frameworkStartedDefer` å°±å¾ˆæœ‰ç”¨äº†
>
> åœ¨ `qiankun` ä¸­æœ‰ä¸€ä¸ª `frameworkStartedDefer`ï¼Œå’Œ `iframeReady` ç”¨é€”æ˜¯ä¸€æ ·çš„

ç¬¬ä¸‰æ­¥ï¼šåŠ¨æ€ä¿®æ”¹ `fetch`

- æ›¿æ¢ `fetch` ä¸ºè‡ªå®šä¹‰å‡½æ•°ï¼Œåœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨ `getAbsolutePath` [[æŸ¥çœ‹](#getabsolutepathè·å–ç»å¯¹è·¯å¾„)] å°† `url` ç»“åˆ `baseurl`
- å°†æ›¿æ¢çš„ `fetch` ä½œä¸º `iframe` çš„ `fetch`ï¼Œå¹¶æ›´æ–°å®ä¾‹ç¼“å­˜ä¸‹æ¥ï¼Œä»¥ä¾¿ä¸‹æ¬¡è·å–

ç¬¬å››æ­¥ï¼šåŒæ­¥è·¯ç”±

- `syncUrlToIframe` å…ˆå°†è·¯ç”±åŒæ­¥åˆ° `iframe`ï¼Œç„¶åé€šè¿‡ `syncUrlToWindow` åŒæ­¥è·¯ç”±åˆ°æµè§ˆå™¨ `url`
- åŒç†å½“ `wujie` å¥— `wujie` çš„æ—¶å€™ä¹Ÿä¼šä¼˜å…ˆåŒæ­¥ `iframe` ä¸­çš„å­åº”ç”¨

> å¦‚æœå­åº”ç”¨å·²å¯åŠ¨ï¼Œåˆæ˜¯ `alive` æ¨¡å¼ï¼Œåˆ‡æ¢åº”ç”¨é‡æ–°æ¿€æ´»ä¸éœ€è¦ `syncUrlToIframe`

ç¬¬äº”æ­¥ï¼šé€šè¿‡ `template` æ›´æ–° `this.template`ï¼Œä¸ºåé¢æ¸²æŸ“åº”ç”¨åšå‡†å¤‡

#### 2. `degrade` ä¸»åŠ¨é™çº§æ¸²æŸ“

æ¦‚è¿°ï¼š

- é‡‡ç”¨ `iframe` æ›¿æ¢ `webcomponent`ï¼Œ`Object.defineProperty` æ›¿æ¢ `proxy`
- å¯¹äºä¸æ”¯æŒçš„ç¯å¢ƒä¼šè‡ªåŠ¨é™çº§ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜å¯ä»¥é€šè¿‡ `degrade` ä¸»åŠ¨é™çº§
- ä¸€æ—¦é‡‡ç”¨é™çº§æ–¹æ¡ˆï¼Œå¼¹çª—ç”±äºåœ¨ `iframe` å†…éƒ¨å°†æ— æ³•è¦†ç›–æ•´ä¸ªåº”ç”¨
- å…³è”å±æ€§ `degradeAttrs`ï¼Œé…ç½®è¯¦ç»†è§ `start` æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]

ä¸»åŠ¨é™çº§åˆ† 3 ä¸ªéƒ¨åˆ†ï¼š

1. åˆ›å»º `iframe` å¹¶æŒ‚è½½åˆ°å®¹å™¨
2. é”€æ¯æ²™ç®±è®°å½•ï¼Œä¸ºåˆ›å»ºçš„ `iframe` æ–°å®¹å™¨æ‰“è¡¥ä¸
3. æ³¨å…¥ `template` æ¸²æŸ“

> ä¸ºäº†ä¾¿äºç†è§£åœ¨â€œ1.2. ä¸»åŠ¨é™çº§æ¸²æŸ“â€æè¿°ä¸­ `iframeBody` æŒ‡æ²™ç®± `iframe` çš„ `body`ï¼Œæ–°åˆ›å»ºçš„ `iframe` ç§°ä½œâ€œæ–°å®¹å™¨â€ï¼Œç”¨äºä»£æ›¿ `web component`ã€‚

æ¸²æŸ“åˆ† 3 ç§æƒ…å†µï¼š

1. `alive` æ¨¡å¼åˆ‡æ¢åº”ç”¨
2. é `alive` æ¨¡å¼åˆ‡æ¢åº”ç”¨
3. åˆæ¬¡æ¸²æŸ“

> åœ¨è¿™é‡Œé€šè¿‡ `this.document` æ¥åŒºåˆ†æ˜¯åˆ‡æ¢åº”ç”¨è¿˜æ˜¯åˆæ¬¡åŠ è½½

ç¬¬ä¸€æ­¥ï¼šåˆ›å»º `iframe`

- `rawDocumentQuerySelector` è·å– `window` æˆ–å­åº”ç”¨å†…çš„ `iframeBody`
- `initRenderIframeAndContainer` åˆ›å»ºä¸€ä¸ªæ–°çš„ `iframe` ç”¨äºä»£æ›¿ `shadowDom`
- ä¼˜å…ˆæŒ‚è½½ `iframe` åˆ°æŒ‡å®šå®¹å™¨ï¼Œä¸å­˜åˆ™åœ¨æŒ‚è½½åˆ° `iframeBody`

> `initRenderIframeAndContainer` å†…éƒ¨åšäº†ä¸¤ä»¶äº‹ï¼ši. åˆ›å»º `iframe` å¹¶å†™å…¥ `attrs`ï¼Œii. æ¸²æŸ“åˆ°å®¹å™¨åé‡å†™ `iframe` çš„ `document`

ç¬¬äºŒæ­¥ï¼šæ›´æ–°å®¹å™¨ï¼Œé”€æ¯ `iframeBody`

- å°†æŒ‚è½½çš„å®¹å™¨æ›´æ–°ä¸º `this.el`
- `clearChild`ï¼šæ¸…ç©º `iframeBody`ï¼Œå¦‚æœæä¾›äº† `el` å®¹å™¨çš„è¯
- `patchEventTimeStamp`ï¼šä¿®å¤ `vue` çš„ `event.timeStamp` é—®é¢˜
- `onunload`ï¼šå½“é”€æ¯å­åº”ç”¨æ—¶ä¸»åŠ¨ `unmount` å­åº”ç”¨

> `onunload` æ˜¯ä¸€ä¸ªåºŸå¼ƒçš„æ–¹æ³•ï¼Œéšæ—¶å¯èƒ½è¢«æµè§ˆå™¨å¼ƒç”¨ã€‚è¿™ä¸ªç›‘å¬æ–¹æ³•åªåœ¨ `iframe` é™çº§å¤„ç†æ—¶å­˜åœ¨ä¸å®¹å™¨ä¸­ï¼Œç›®çš„åº”è¯¥ç”¨äºç‚¹å‡»åº”ç”¨ä¸­ç¬¬ä¸‰æ–¹é“¾æ¥ç¦»å¼€é¡µé¢æ—¶æ³¨é”€åº”ç”¨ã€‚

ç¬¬ä¸‰æ­¥ï¼š`åˆ†æ”¯ 1` - `alive` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨

- æ¢å¤ `html`ï¼šå°†ä¹‹å‰è®°å½•å­åº”ç”¨çš„ `<html>` æ›¿æ¢â€œæ–°å®¹å™¨â€çš„ `<html>`
- åœ¨ä¿æ´»åœºæ™¯æ¢å¤æ‰€æœ‰å…ƒç´ äº‹ä»¶ï¼Œè§ï¼šè®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]

ç¬¬ä¸‰æ­¥ï¼š`åˆ†æ”¯ 2` - é `alive` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨

- é€šè¿‡ `renderTemplateToIframe` å°† `template` æ³¨å…¥åˆ›å»º `iframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe)]
- `recoverDocumentListeners` éä¿æ´»åœºæ™¯éœ€è¦æ¢å¤æ ¹èŠ‚ç‚¹çš„äº‹ä»¶ï¼Œé˜²æ­¢ `react16` ç›‘å¬äº‹ä»¶ä¸¢å¤±ï¼Œè§ï¼šè®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]

ç¬¬ä¸‰æ­¥ï¼š`åˆ†æ”¯ 3` - åˆæ¬¡æ¸²æŸ“

- é€šè¿‡ `renderTemplateToIframe` å°† `template` æ³¨å…¥åˆ›å»º `iframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe)]

æœ€åï¼š

- æ— è®ºå“ªç§æ–¹å¼æ¸²æŸ“ï¼Œéƒ½å°†â€œæ–°å®¹å™¨â€çš„ `document` ä½œä¸ºå½“å‰å®ä¾‹çš„ `document`ï¼Œæ–¹ä¾¿ä¸‹æ¬¡åˆ‡æ¢åº”ç”¨ `active` æ—¶ç›´æ¥ä½¿ç”¨ã€‚
- è‡³æ­¤æ•´ä¸ªé™çº§è¿‡ç¨‹å®Œæˆï¼Œç›´æ¥è¿”å›ä¸å†æ‰§è¡Œä¸‹é¢æµç¨‹

#### 3. æŒ‚è½½å­åº”ç”¨ï¼šåˆ‡æ¢ã€åˆå§‹åŒ–ã€é¢„åŠ è½½

ç¬¬ä¸€æ­¥ï¼šæŒ‚è½½å­åº”ç”¨åˆ°å®¹å™¨

`degrade` ä¸»åŠ¨é™çº§é€šè¿‡ `this.document` æ¥åŒºåˆ†åˆ‡æ¢åº”ç”¨å’Œåˆæ¬¡åŠ è½½ï¼Œè€ŒæŒ‚è½½åº”ç”¨é€šè¿‡ `this.shadowRoot` æ¥åŒºåˆ†ï¼Œå¦‚ä¸‹æœ‰ 3 ä¸ªåˆ†æ”¯ã€‚

åˆ†æ”¯ 1ï¼šåˆ‡æ¢åº”ç”¨

- é€šè¿‡ `renderElementToContainer` [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)] å°† `this.shadowRoot.host` æŒ‚è½½åˆ°æŒ‡å®šå®¹å™¨
- å¦‚æœæ˜¯ `alive` æ¨¡å¼è·³å‡ºæ¥ï¼Œä»¥ä¸‹æµç¨‹ä¸å†ç»§ç»­

> `this.shadowRoot.host`ï¼š
>
> - æŒ‡çš„æ˜¯ `shadowRoot` å¤–å±‚çš„ `web component`
> - è€Œ `this.shadowRoot` æ˜¯åœ¨ç»„ä»¶ `connectedCallback` æ—¶å®šä¹‰ä¸ºç»„ä»¶çš„ `shadowRoot`
> - åœ¨ `active` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨ï¼Œ`shadowRoot` çš„ `template` å·²åœ¨åˆå§‹åŒ–æ—¶æ³¨å…¥ï¼Œæ‰€ä»¥æ¿€æ´»åå¯ä»¥ç›´æ¥è¿”å›
> - è€Œé `active` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨ï¼Œä¼šå†æ¬¡æ›´æ–° `template`

åˆ†æ”¯ 2ï¼šåº”ç”¨åˆå§‹åŒ–

- å…ˆè·å– `iframeBody`ï¼Œå¦‚æœå®¹å™¨ä¸å­˜åœ¨æ—¶ä½œä¸ºå¤‡ç”¨å®¹å™¨
- é€šè¿‡ `createWujieWebComponent` åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶
- é€šè¿‡ `renderElementToContainer` [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)] å°†åˆ›å»ºçš„ç»„ä»¶æŒ‚è½½åˆ°æŒ‡å®šå®¹å™¨

> ä»è¿™é‡Œå¯ä»¥çŸ¥é“ï¼š
>
> - åˆå§‹åŒ–åº”ç”¨æ˜¯åˆ›å»ºä¸€ä¸ª `web component`ï¼ŒæŒ‚è½½åˆ°æŒ‡å®šå®¹å™¨
> - åˆ›å»ºç»„ä»¶æ—¶ï¼Œé€šè¿‡ `defineWujieWebComponent` ä¼šé…ç½® `this.shadowRoot`
> - è¿™æ ·ä¸‹æ¬¡åˆ‡æ¢å†æ¿€æ´»åº”ç”¨æ—¶ä¼šé€šè¿‡ï¼š`åˆ†æ”¯ 1` çš„æµç¨‹

åˆ†æ”¯ 3ï¼š é¢„åŠ è½½åº”ç”¨

- é¢„åŠ è½½åº”ç”¨æ˜¯ä¸éœ€è¦æŒ‡å®šå®¹å™¨ç”¨æ¥æŒ‚è½½åº”ç”¨ï¼Œæ‰€ä»¥ä¼šæŒ‚è½½åˆ°æ²™ç®±çš„ `iframeBody` ä¸­
- ç­‰åˆ°åˆ‡æ¢åº”ç”¨çš„æ—¶å€™ï¼Œ`this.shadowRoot` å·²ç»å­˜åœ¨ï¼Œä¼šç›´æ¥å°†ç»„ä»¶é‡æ–° `appendChild` åˆ° `shadowRoot`

> æ‹“å±•é˜…è¯»ï¼š`renderElementToContainer` [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°æ¥äº†è§£åŠ è½½åº”ç”¨æ—¶ `loading` å¤„ç†

ç¬¬äºŒæ­¥ï¼šé€šè¿‡ `renderTemplateToShadowRoot` å°† `template` æ¸²æŸ“åˆ° `shadowRoot` [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]

ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡ `patchCssRules` ä¸ºå­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]

ç¬¬å››æ­¥ï¼šæ›´æ–° `this.provide.shadowRoot`

- `this.provide` å°±æ˜¯å­åº”ç”¨ä¸­å…¨å±€å¯¹è±¡çš„ `$wujie`ï¼Œè¯¦ç»†è§æ–‡æ¡£ï¼šå…¨å±€å˜é‡ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/variable.html)]
- åœ¨å®ä¾‹æ„é€ æ—¶é€šè¿‡ `iframeGenerator` åˆ›å»º `iframe` çš„åŒæ—¶ä½¿ç”¨ `patchIframeVariable` å°†å…¶æ³¨å…¥ `iframeWindow`

#### ğŸ“ `start` å¯åŠ¨åº”ç”¨

å‚æ•°ï¼š

- `getExternalScripts`ï¼šè¿”å›ä¸€ä¸ªè¦åŠ è½½çš„ `script` é›†åˆçš„å‡½æ•°

`start` æœ¬èº«æ˜¯ä¸€ä¸ªè¿”å› `Promise<void>` å¼‚æ­¥å‡½æ•°ï¼š

- ä½†å¦‚æœ `this.iframe` è¢«é”€æ¯çš„æƒ…å†µä¼šç›´æ¥è¿”å›ä¸å†å¤„ç†ï¼Œ`this.iframe` åªæœ‰åœ¨é”€æ¯åº”ç”¨ `destroy` è®¾ä¸º `null`ï¼Œè§ `destroy`

`start` æœ‰ 3 ä¸ªåœ°æ–¹è°ƒç”¨ï¼š

- `startApp` åˆ‡æ¢ä¸€ä¸ª `alive` æ¨¡å¼çš„å­åº”ç”¨æ—¶ï¼Œå­åº”ç”¨æœªå¯åŠ¨
- `startApp` åˆ›å»ºä¸€ä¸ªåº”ç”¨å®ä¾‹å
- `preloadApp` é¢„åŠ è½½åº”ç”¨é…ç½® `exec` é¢„æ‰§è¡Œ

> æ‰§è¡Œ `start` å¯åŠ¨åº”ç”¨å‰å¿…é¡»å…ˆ `active` æ¿€æ´»åº”ç”¨

#### 1. æ”¶é›†é˜Ÿåˆ—

æ•´ä¸ª `start` çš„æµç¨‹å°±æ˜¯å¯¹ `this.execQueue` é˜Ÿåˆ—çš„æ”¶é›†å’Œæå–å¹¶æ‰§è¡Œï¼š

- åœ¨é˜Ÿåˆ—ä¸­ `push` çš„ä¸‹æ ‡éƒ½æ˜¯åŒæ­¥çš„æ‰§è¡Œå‡½æ•°ï¼Œæ‰§è¡Œé˜Ÿåˆ—é€šè¿‡ `shift` å®ç°å…ˆå…¥å…ˆå‡º
- åœ¨é˜Ÿåˆ—ä¸‹æ ‡çš„æ¯ä¸ªå‡½æ•°ä¸­æœ‰å¯èƒ½å­˜åœ¨å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡ï¼Œä½†æ‰§è¡Œé¡ºåºçœ‹æ‰€åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—å‰åé¡ºåº
- å› ä¸ºæ¯ä¸ªé˜Ÿåˆ—çš„æ‰§è¡Œéƒ½æ˜¯åœ¨ä¸Šä¸€ä¸ªé˜Ÿåˆ—è°ƒç”¨è¿‡ç¨‹ä¸­çš„æå–

**`this.execQueue.push` å…±è®¡ 7 å¤„ï¼š**

- `beforeScriptResultList`ï¼šæ’å…¥ä»£ç å‰
- `syncScriptResultList` + `deferScriptResultList`ï¼šåŒæ­¥ä»£ç 
- `this.mount`ï¼šæ¡†æ¶ä¸»åŠ¨è°ƒç”¨ `mount` æ–¹æ³•
- `domContentLoadedTrigger`ï¼šè§¦å‘ `DOMContentLoaded` äº‹ä»¶
- `afterScriptResultList`ï¼šæ’å…¥ä»£ç å
- `domLoadedTrigger`ï¼šè§¦å‘ `loaded` äº‹ä»¶
- è¿”å› `promise`ï¼šæ‰€æœ‰çš„ `execQueue` é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•ï¼Œ`start` æ‰ç®—ç»“æŸï¼Œä¿è¯ä¸²è¡Œçš„æ‰§è¡Œå­åº”ç”¨

**æœ‰ 1 å¤„å­˜åœ¨å³æ‰§è¡Œï¼š**

- `asyncScriptResultList`ï¼šå¼‚æ­¥ä»£ç 

> ä»¥ä¸Šè¯´æ˜æ¥è‡ªæºç æ³¨é‡Šï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶å…³é”®è¯æœç´¢ï¼›å¦‚æœä»¥ä¸Šæ€»ç»“è¿˜æ²¡çœ‹æ˜ç™½æ²¡å…³ç³»ï¼Œè¯·ç»§ç»­å¾€ä¸‹çœ‹

æ€»å…± 8 å¤„ï¼Œç„¶åæ ¹æ®ç”¨é€”è¿˜å¯ä»¥ç»†åˆ†å¦‚ä¸‹

**å¿…é¡»ä¼šæ·»åŠ åˆ°é˜Ÿåˆ—æœ‰ 4 å¤„ï¼š**

- `this.mount`ã€`domContentLoadedTrigger`ã€`domLoadedTrigger`ã€è¿”å› `promise`

**æ ¹æ®é›†åˆæ·»åŠ åˆ°é˜Ÿåˆ—æœ‰ 3 å¤„ï¼š**

- `beforeScriptResultList`ï¼šè§ `js-before-loaders` [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-before-loaders)]
- `afterScriptResultList`ï¼šè§ `js-after-loader` [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-after-loader)]
- `syncScriptResultList` + `deferScriptResultList`ï¼šæ ¹æ®å‚æ•° `getExternalScripts` æå–å­åº”ç”¨çš„ `script`

> `beforeScriptResultList` å’Œ `afterScriptResultList` ä¸‹æ ‡ç±»å‹æ–‡æ¡£ä»‹ç»æœ‰é™ï¼Œå»ºè®®æŸ¥çœ‹æºç  `TS` ç±»å‹ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L22)]

**æå–å­åº”ç”¨çš„ `script`ï¼š**

é€šè¿‡ `getExternalScripts` å¾—åˆ° `scriptResultList`ï¼Œè¯¦ç»†è§ï¼š`importHTML` [[æŸ¥çœ‹](#importhtml)]

å£°æ˜ 3 ä¸ªé›†åˆï¼š

- `syncScriptResultList`ï¼šåŒæ­¥ä»£ç 
- `asyncScriptResultList`ï¼š`async` ä»£ç æ— éœ€ä¿è¯é¡ºåºï¼Œæ‰€ä»¥ä¸ç”¨æ”¾å…¥æ‰§è¡Œé˜Ÿåˆ—
- `deferScriptResultList`ï¼š`defer` ä»£ç éœ€è¦ä¿è¯é¡ºåºå¹¶ä¸” `DOMContentLoaded` å‰å®Œæˆï¼Œè¿™é‡Œç»Ÿä¸€æ”¾ç½®åŒæ­¥è„šæœ¬åæ‰§è¡Œ

éå† `scriptResultList` æ ¹æ®å±æ€§åˆ†ç±»æ·»åŠ åˆ°ä¸Šè¿° 3 ä¸ªé›†åˆï¼Œå…³äºå±æ€§è§ï¼š`processTpl` æå–èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

> æ³¨æ„ï¼šåœ¨è¿™é‡Œæ— è®ºæ˜¯åŒæ­¥ä»£ç è¿˜æ˜¯å¼‚æ­¥ä»£ç ï¼Œæ‰€æœ‰çš„ `script` éƒ½æ˜¯åº”ç”¨ä¸­çš„é™æ€ `script`ï¼Œè€Œä¸æ˜¯åŠ¨æ€æ·»åŠ çš„ `script`ï¼Œè€Œåƒ `React` å’Œ `Vue` è¿™æ ·çš„ `SPA` åº”ç”¨æ˜¯é€šè¿‡åŠ¨æ€æ·»åŠ çš„ `script`ï¼Œè§ï¼š`execQueue` åº”ç”¨å¯åŠ¨æ‰§è¡Œé˜Ÿåˆ— [[æŸ¥çœ‹](#1-execqueue-åº”ç”¨å¯åŠ¨æ‰§è¡Œé˜Ÿåˆ—)]

**éå†çš„é›†åˆä¸‹æ ‡æ˜¯ `promise` æœ‰ 2 å¤„ï¼š**

- åŒæ­¥å’Œå¼‚æ­¥ä»£ç æ‰§è¡Œï¼š`syncScriptResultList`ã€`asyncScriptResultList`
- å…±åŒç‚¹ï¼šé›†åˆä¸­çš„æ¯ä¸€é¡¹å‡½æ•°æ‰§è¡Œå¹¶è¿”å› `promise`ã€éœ€è¦åœ¨å¾®ä»»åŠ¡ä¸­æ‰§è¡Œ `insertScriptToIframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]
- ä¸åŒç‚¹ï¼š`syncScriptResultList` éœ€è¦ç­‰å¾…é˜Ÿåˆ—æŒ‰é¡ºåºæå–æ‰§è¡Œï¼Œ`asyncScriptResultList` éå†åŒæ—¶ç«‹å³å‘èµ·å¾®ä»»åŠ¡

#### 2. æ‰§è¡Œé˜Ÿåˆ—

æ— è®ºæ€ä¹ˆæ·»åŠ ï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡ `this.execQueue.shift()()` ä»å¤´éƒ¨å¼¹å‡ºæ’å…¥é˜Ÿåˆ—çš„å‡½æ•°å¹¶æ‰§è¡Œ

å¼€å§‹æ‰§è¡Œï¼š

- æ‰§è¡Œé˜Ÿåˆ—ä» 334 è¡Œå¼€å§‹ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L334)]ï¼ŒæŒ‰ç…§ä¸Šä¸‹æ–‡ä¸»åŠ¨æå–å¹¶å‘èµ·æ‰§è¡Œ
- `asyncScriptResultList`ï¼šå¼‚æ­¥ä»£ç ä¸åŠ å…¥é˜Ÿåˆ—ï¼Œä¼šä»¥ `promise` å¾®ä»»åŠ¡çš„å½¢å¼åœ¨å½“å‰ä¸Šä¸‹æ–‡æ‰§è¡Œå®Œæ¯•åä¾æ¬¡æ‰§è¡Œ

å¾ªç¯æ’å…¥é˜Ÿåˆ—å…±æœ‰ 3 å¤„ï¼š

- åˆ†åˆ«æ˜¯ï¼š`beforeScriptResultList`ã€`syncScriptResultList` + `deferScriptResultList`ã€`afterScriptResultList`
- æ‰§è¡Œçš„é€šè¿‡ `insertScriptToIframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)] å°† `window.__WUJIE.execQueue.shift()()` æ³¨å…¥å®¹å™¨
- è¿™æ ·æ¯ä¸ª `push` æ·»åŠ çš„é˜Ÿåˆ—ï¼Œä¼šåœ¨å®¹å™¨ä¸­ `shift` æå–ä¸‹ä¸€ä¸ªä»»åŠ¡å¹¶æ‰§è¡Œ

åŒæ­¥ä»£ç  `syncScriptResultList` + `deferScriptResultList`ï¼š

- æ¯ä¸ªé˜Ÿåˆ—éƒ½æ˜¯ä¸€ä¸ª `promise` å¾®ä»»åŠ¡ï¼Œåœ¨å¾®ä»»åŠ¡ä¸­æ ¹æ® `fiber` å†³å®šç«‹å³æ‰§è¡Œè¿˜æ˜¯é€šè¿‡ `requestIdleCallback` ç©ºé—²æ‰§è¡Œ

> æ— è®ºæ˜¯åŒæ­¥ä»£ç è¿˜æ˜¯å¼‚æ­¥ä»£ç ï¼Œåœ¨ `fiber` æƒ…å†µä¸‹æ¯ä¸ªå¾®ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­éƒ½ä¼šæ·»åŠ ä¸€ä¸ªå®ä»»åŠ¡ `requestIdleCallback`ï¼Œå…¶é¡ºåºä¾æ—§æ˜¯æŒ‰ç…§é˜Ÿåˆ—ï¼Œæå–ä¸€æ¬¡æ‰§è¡Œä¸€æ¬¡

ä¸»åŠ¨æ’å…¥é˜Ÿåˆ—æœ‰ 4 å¤„ï¼š

- `mount`ã€`domContentLoadedTrigger`ã€`domLoadedTrigger`ã€è¿”å›çš„ `Promise` å®ä¾‹å‡½æ•°ä¸­
- è¿™ç§æƒ…å†µä¼šåœ¨æ‰§å‡½æ•°æœ«å°¾æ·»åŠ  `this.execQueue.shift()?.();` æ‰§è¡Œä¸€æ¬¡æå–ä¸€æ¬¡

å¦‚æœ `fiber` ä¸º `true`ï¼ˆé»˜è®¤ï¼‰ï¼š

- å¾ªç¯æ’å…¥é˜Ÿåˆ—ï¼šä¼šåœ¨ç©ºé—²æ—¶é—´ `requestIdleCallback` æ‰§è¡Œ `insertScriptToIframe`
- ä¸»åŠ¨æ’å…¥é˜Ÿåˆ—ï¼šä¼šåœ¨ç©ºé—²æ—¶é—´ `requestIdleCallback` æ‰§è¡ŒæŒ‡å®šçš„å‡½æ•°
- ç”±äºæ‰§è¡Œé˜Ÿåˆ—éœ€è¦å…ˆæå–é˜Ÿåˆ—ï¼Œæ‰€ä»¥æ— è®ºæ˜¯å®ä»»åŠ¡è¿˜æ˜¯å¾®ä»»åŠ¡ï¼Œéƒ½ä¼šæ˜¯åœ¨ä»»åŠ¡æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æå–ä¸‹ä¸€ä¸ªé˜Ÿåˆ—å†æ‰§è¡Œ

> åœ¨ `Wujie` å®ä¾‹ä¸­é€šè¿‡ `this.requestIdleCallback` æ‰§è¡Œç©ºé—²åŠ è½½ï¼Œå®ƒå’Œ `requestIdleCallback` çš„åŒºåˆ«åœ¨äºï¼Œæ¯æ¬¡æ‰§è¡Œå‰å…ˆåˆ¤æ–­å®ä¾‹æ˜¯å¦å·²é”€æ¯ `this.iframe`

é€šè¿‡è¿”å›çš„ `Promise` æ·»åŠ åˆ°æœ«å°¾çš„é˜Ÿåˆ—ï¼š

- åªåšä¸€ä»¶äº‹ï¼šæ‰§è¡Œ `resolve`ï¼Œä»¥ä¾¿é€šçŸ¥å¤–éƒ¨ `start` å®Œæˆ

#### 3. é˜Ÿåˆ—æ‰§è¡Œé¡ºåº

é˜Ÿåˆ—æœ‰ 3 å¤„å¾®ä»»åŠ¡ï¼š

- `syncScriptResultList` + `deferScriptResultList`ï¼šåŒæ­¥ä»£ç 
- `asyncScriptResultList`ï¼šå¼‚æ­¥ä»£ç 
- è¿”å›çš„ `promise` å¯¹è±¡

> è¿”å›çš„ `promise` å¯¹è±¡ç”¨äº `start` å¤–éƒ¨é€šçŸ¥æ‰§è¡Œå®Œæ¯•ï¼Œåœ¨ `start` å†…éƒ¨ `promise` çš„å‡½æ•°æ˜¯åŒæ­¥çš„ï¼Œé˜Ÿåˆ—çš„æ‰§è¡Œéœ€è¦é€šè¿‡ä¸Šä¸‹æ–‡è°ƒç”¨ `this.execQueue.shift`

`fiber` å¼€å¯çš„æƒ…å†µä¸‹æœ‰ 7 å¤„å®ä»»åŠ¡ï¼š

- é™¤äº†é€šè¿‡è¿”å›çš„ `promise` æ’å…¥æœ«å°¾çš„é˜Ÿåˆ—ï¼Œéƒ½ä¼šé€šè¿‡ `requestIdleCallback` æ’å…¥å®ä»»åŠ¡
- å…¶ä¸­ `syncScriptResultList` + `deferScriptResultList` å’Œ `asyncScriptResultList` ä¼šåœ¨å¾®ä»»åŠ¡ä¸­æ·»åŠ å®ä»»åŠ¡

æ— è®º `this.fiber` çš„å€¼ä¸å¦éƒ½æ˜¯æŒ‰ç…§é˜Ÿåˆ—çš„é¡ºåºæ‰§è¡Œï¼š

- å³ä¾¿å¼€å¯ `fiber` çŠ¶æ€ä¸‹ï¼Œæ¯æ¬¡éƒ½å°†è°ƒç”¨çš„å‡½æ•°é€šè¿‡ `requestIdleCallback` å°†å…¶æ”¾å…¥ä¸€ä¸ªå®ä»»åŠ¡ä¸­æ‰§è¡Œ
- ä½†æ˜¯è¦æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå°±ä¸€å®šè¦åœ¨ä¸Šä¸€ä¸ªå®ä»»åŠ¡ä¸­æå– `this.execQueue.shift` å¹¶æ‰§è¡Œ

ä¸åŒçš„æ˜¯ï¼š

- å¼€å¯ `fiber` ä¼šå°†æ‰§è¡Œæ–¹æ³•åŒ…è£¹åœ¨ `requestIdleCallback`ï¼Œåœ¨æµè§ˆå™¨ç©ºé—²æ—¶äº¤ç»™ä¸‹ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œ

æ‰§è¡Œé¡ºåºï¼š

1. `asyncScriptResultList` éå†å¼‚æ­¥ä»£ç ï¼Œæ·»åŠ å¾®ä»»åŠ¡ç­‰å¾…æ‰§è¡Œï¼Œæ³¨ n (`asyncScriptResultList`)
2. 334 è¡Œå¼€å§‹æ‰§è¡Œç¬¬ä¸€ä¸ªé˜Ÿåˆ— `this.execQueue.shift()()`
3. æ‰§è¡Œ `beforeScriptResultList`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
4. æ‰§è¡Œ `syncScriptResultList` + `deferScriptResultList`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
5. ä¾æ¬¡æ‰§è¡Œ `mount`ã€`domContentLoadedTrigger`
6. æ‰§è¡Œ `afterScriptResultList`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
7. æ‰§è¡Œ `domLoadedTrigger`
8. æ‰§è¡Œè¿”å›çš„ `promise` å¯¹è±¡ä¸­æ·»åŠ çš„æœ«å°¾çš„é˜Ÿåˆ—

> æ³¨ nï¼š`fiber` æ¨¡å¼ä¸‹ `asyncScriptResultList` æ‰§è¡Œé¡ºåºå¦‚ä¸‹
>
> - å¦‚æœ `beforeScriptResultList` å­˜åœ¨ï¼Œä¼šåœ¨é›†åˆçš„å®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œï¼Œå¦‚æœä¸å­˜åœ¨ç»§ç»­å¾€ä¸‹
> - å¦‚æœ `syncScriptResultList` + `deferScriptResultList` å­˜åœ¨ï¼Œä¼šåœ¨é›†åˆçš„å¾®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œï¼Œå¦‚æœä¸å­˜åœ¨ç»§ç»­å¾€ä¸‹
> - å¦‚æœä»¥ä¸Šéƒ½ä¸å­˜åœ¨ï¼Œä¼šåœ¨ `mount` ä¹‹å‰æ‰§è¡Œ
>   - å› ä¸º `fiber` æ¨¡å¼ä¸‹ `mount` æ˜¯æ”¾åœ¨ `requestIdleCallback` ä¸­ä½œä¸ºä¸‹ä¸€ä¸ªå®ä»»åŠ¡ä¸­
>   - è€Œ `mount` æ˜¯å¿…é¡»æ’å…¥é˜Ÿåˆ—çš„æ–¹æ³•ï¼Œæ‰€ä»¥è¦æ‰§è¡Œ `mount` æ–¹æ³•ä»¥åŠåç»­é˜Ÿåˆ—ï¼Œä¸€å®šè¦æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡
>   - è¦æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ä¸€å®šè¦å…ˆæ‰§è¡Œå½“å‰å®ä»»åŠ¡ä¸­çš„ `asyncScriptResultList` å¾®ä»»åŠ¡é›†åˆ
>
> é `fiber` æ¨¡å¼ä¸‹ï¼Œé€šè¿‡ `beforeScriptResultList` å¾ªç¯æ’å…¥é˜Ÿåˆ—é›†åˆï¼Œå¸¦æœ‰ `src` çš„å¤–è” `script`ï¼š
>
> - è™½ç„¶å®ä»»åŠ¡ `requestIdleCallback` ä¸å­˜åœ¨
> - ä½†å¸¦æœ‰ `src` çš„ `script` ä¼šé€šè¿‡ `onload` å»è°ƒç”¨ `window.__WUJIE.execQueue.shift()()`
> - `onload` ä¹Ÿæ˜¯å®ä»»åŠ¡ï¼Œä¼šåœ¨å½“å‰å®ä»»åŠ¡ä¸‹å¾®ä»»åŠ¡ç»“æŸåå¼€å§‹æ‰§è¡Œ
>
> é `fiber` æ¨¡å¼ä¸‹ï¼Œå­˜åœ¨åŒæ­¥ä»£ç ï¼š
>
> - ä¼šåœ¨ `syncScriptResultList` + `deferScriptResultList` é›†åˆçš„å¾®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œ
>
> é `fiber` æ¨¡å¼ä¸‹ï¼Œé€šè¿‡ `afterScriptResultList` å¾ªç¯æ’å…¥é˜Ÿåˆ—é›†åˆï¼Œå¸¦æœ‰ `src` çš„å¤–è” `script`ï¼š
>
> - åŒ `beforeScriptResultList`
>
> é `fiber` æ¨¡å¼ä¸‹ï¼Œå¦‚æœä»¥ä¸Šéƒ½ä¸å­˜åœ¨ï¼š
>
> - ä¼šåœ¨ `start` ä¹‹åæ‰§è¡Œï¼Œä½†æ˜¯è¿™é‡Œå­˜åœ¨ä¸€ä¸ª `bug`ï¼Œè§ï¼š4. `start` å¯åŠ¨åº”ç”¨çš„ `bug` [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)]

é™¤äº† `asyncScriptResultList` ä¹‹å¤–ä»¥ä¸Šå¾®ä»»åŠ¡å®ä»»åŠ¡éƒ½ä¼šæŒ‰ç…§é˜Ÿåˆ—æ‰§è¡Œé¡ºåºæ‰§è¡Œï¼Œå› ä¸ºè¦æ‰§è¡Œé˜Ÿåˆ—å°±å¿…é¡»åœ¨ä¸Šä¸€ä¸ªé˜Ÿåˆ—ä»»åŠ¡ä¸­è°ƒç”¨ `this.execQueue.shift()()`

> ä¸€é“æ€è€ƒé¢˜ï¼šåœ¨å­åº”ç”¨ä¸­æ‰€æœ‰å¸¦æœ‰ `src` çš„é“¾æ¥å°†è¢«åˆ†ç±»ä¸ºâ€œåŒæ­¥ä»£ç â€å’Œâ€œå¼‚æ­¥ä»£ç â€ï¼Œè¿™ç±» `script` ä¼šæ€æ ·æ’å…¥ `iframe`ï¼Ÿè¿™ä¸ªé—®é¢˜ä¼šåœ¨ä¸‹é¢è§£ç­”ï¼š5. é˜Ÿåˆ—å‰çš„å‡†å¤‡ [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]

**å…³äºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š**

åœ¨ `micro-app` æœ‰ä¸€ä¸ª `injectFiberTask`ï¼Œè§ `micro-app` æºç åˆ†æä¸­æ³¨ â‘­ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#13-extractsourcedom-%E6%88%90%E5%8A%9F%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E5%9B%9E%E8%B0%83)]ï¼Œå¯¹æ¯”å¦‚ä¸‹ï¼š

| å¯¹æ¯”é¡¹   | `wujie`                                                      | `micro-app`                                                 |
| -------- | ------------------------------------------------------------ | ----------------------------------------------------------- |
| æ·»åŠ é˜Ÿåˆ— | æ ¹æ®ä¸åŒç±»å‹ï¼Œæ‰‹åŠ¨æ·»åŠ æ¯ä¸€ç»„é˜Ÿåˆ—                             | `injectFiberTask`                                           |
| é›†åˆå¯¹è±¡ | `execQueue`                                                  | `fiberLinkTasks`                                            |
| æ·»åŠ æ–¹å¼ | `push`                                                       | `push`                                                      |
| æ‰§è¡Œæ–¹å¼ | `this.execQueue.shift()?.()`ï¼Œåœ¨å½“å‰é˜Ÿåˆ—æå–ä¸‹ä¸€ä¸ªé˜Ÿåˆ—å¹¶æ‰§è¡Œ | `serialExecFiberTasks`ï¼Œé€šè¿‡ `array.redus` æ‹å¹³é˜Ÿåˆ—ä¾æ¬¡æ‰§è¡Œ |
| ç«‹å³æ‰§è¡Œ | `asyncScriptResultList`ï¼Œéå†é›†åˆæ·»åŠ åˆ°å¾®ä»»åŠ¡ä¸­æ‰§è¡Œ          | `injectFiberTask`ï¼Œæä¾›çš„ `fiberTasks` ä¸º `null`            |

> æ¯”è¾ƒè€Œè¨€ `micro-app` çš„ `injectFiberTask`ï¼Œæ›´ç®€æ´ã€æŠ½è±¡ï¼Œçµæ´»åº¦ä¹Ÿæ›´é«˜

#### 4. `start` å¯åŠ¨åº”ç”¨çš„ `bug`

å…ˆè¯´é—®é¢˜ï¼š

- é—®é¢˜ 1ï¼šå¦‚æœ `start` ä¸­æ²¡æœ‰å¾®ä»»åŠ¡ï¼Œä¹Ÿæ²¡æœ‰å®ä»»åŠ¡ï¼Œç”±äºé˜Ÿåˆ—æœ€åæ˜¯é€šè¿‡ `Promise` å‡½æ•°æ’å…¥é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ°¸è¿œä¸ä¼šæ‰§è¡Œæœ«å°¾é˜Ÿåˆ—
- é—®é¢˜ 2ï¼šå¦‚æœ `beforeScriptResultList` æˆ– `afterScriptResultList` å­˜åœ¨ `async` çš„ `script`ï¼Œå¯¼è‡´æ— æ³•æå–æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—é€ æˆæµç¨‹ä¸­æ–­ï¼Œåé¢çš„ `script` å°†ä¸èƒ½æ’å…¥æ²™ç®± `iframe`

å¯¼è‡´ç»“æœï¼š

- æš‚åœé˜Ÿåˆ—ï¼Œæ— æ³•å®Œæˆ `await sandbox.start()` å¾®ä»»åŠ¡

åŸå› ï¼š

- `this.execQueue.shift()()` ä¼˜å…ˆäºè¿”å›çš„ `promise` å‡½æ•°å†…éƒ¨æ‰§è¡Œï¼Œä»–ä»¬æ˜¯ä¸Šä¸‹æ–‡å…³ç³»
- å¦‚æœæå–æ‰§è¡Œé˜Ÿåˆ—è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡ï¼Œé‚£ä¹ˆå½“æœ€åä¸€ä¸ªé˜Ÿåˆ— `this.execQueue.shift()()` æ‰§è¡Œå®Œï¼Œæ‰å°†æœ€åè¿”å›çš„ `promise` å‡½æ•°ä¸­æ’å…¥ `execQueue` é˜Ÿåˆ—ä¸­
- è€Œæœ€åçš„ `promise` éœ€è¦åœ¨ `execQueue` é˜Ÿåˆ—çš„æ–¹æ³•ä¸­æ‰§è¡Œ `resove`ï¼Œå› æ­¤è¢«ä¸­æ–­
- æˆ–å› ä¸ºæ‰‹åŠ¨æ’å…¥ `async` çš„ `script` å¯¼è‡´é˜Ÿåˆ—ä¸­æ–­

`preloadApp` å‡ºç°é—®é¢˜çš„åœºæ™¯ï¼š

- é¢„åŠ è½½æœ¬èº«ä¸ä¼šå¯¼è‡´é—®é¢˜ï¼Œå› ä¸ºé¢„åŠ è½½é»˜è®¤ä¸ä¼š `start`ï¼Œå³ä¾¿é…ç½® `exec` å¯åŠ¨åº”ç”¨ `start`ï¼Œé—®é¢˜ä¹Ÿä¼šå‘ç”Ÿåœ¨ `startApp` åˆ‡æ¢åº”ç”¨æ—¶

`startApp` å¯åŠ¨åº”ç”¨ `start` é—®é¢˜çš„åœºæ™¯ï¼š

| è§¦å‘æ¡ä»¶             | åŒ…å«çš„åœºæ™¯                                                        | é—®é¢˜ 1                                              | é—®é¢˜ 2                             |
| -------------------- | ----------------------------------------------------------------- | --------------------------------------------------- | ---------------------------------- |
| `alive` é¢„åŠ è½½åå¯åŠ¨ | æ¿€æ´»è¿˜æœª `start` å¯åŠ¨çš„ `alive` åº”ç”¨                              | ç”Ÿå‘½å‘¨æœŸ `activated` å¯èƒ½ä¼šä¸æ‰§è¡Œï¼Œ`destroy` ä¸è¿”å› | æµç¨‹ä¸­æ–­å¯¼è‡´åç»­ `script` åŠ è½½å¤±è´¥ |
| é `alive` åº”ç”¨å¯åŠ¨  | `umd` é¢„åŠ è½½åé¦–æ¬¡å¯åŠ¨ï¼Œé `active` å’Œ `umd` çš„åº”ç”¨æ¯æ¬¡å¯åŠ¨å’Œåˆ‡æ¢ | ç”Ÿå‘½å‘¨æœŸ `activated` å¯èƒ½ä¼šä¸æ‰§è¡Œï¼Œ`destroy` ä¸è¿”å› | æµç¨‹ä¸­æ–­å¯¼è‡´åç»­ `script` åŠ è½½å¤±è´¥ |
| `exec` é¢„æ‰§è¡Œåå¯åŠ¨  | æ‰€æœ‰æ¨¡å¼                                                          | å¡åœ¨ `await sandbox.preload` æš‚åœä¸å†æ‰§è¡Œ           | æµç¨‹ä¸­æ–­å¯¼è‡´åç»­ `script` åŠ è½½å¤±è´¥ |

> åœ¨è§¦å‘æ¡ä»¶ä¸­æœ‰ä¸¤ä¸ªæ¦‚å¿µï¼šé¢„åŠ è½½å’Œé¢„æ‰§è¡Œï¼Œè§ï¼šé€šè¿‡ `exec` é¢„æ‰§è¡Œ [[æŸ¥çœ‹](#5-é€šè¿‡-exec-é¢„æ‰§è¡Œ)]

é `fiber` æ¨¡å¼ä¸‹å‡ºç°é—®é¢˜çš„åœºæ™¯ï¼š

| æ¨¡å¼                                        | è§¦å‘å‰æ                             | é—®é¢˜åŸå›                                                                                                                         |
| ------------------------------------------- | ------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------- |
| æ¨¡å¼ â‘ ï¼šæ²¡æœ‰è¦æ’å…¥çš„ `script`               | åªæœ‰å¿…é¡»æ’å…¥ `execQueue` çš„ 4 ä¸ªæ–¹æ³• | æŒ‰ç…§ä¸Šä¸‹æ–‡æ‰§è¡Œé˜Ÿåˆ—ï¼Œæœ€åä¸€ä¸ª `this.execQueue.shift()?.()` æå–æ‰§è¡Œåï¼Œè¿”å›çš„ `Promise` å‡½æ•°ä¸­è¿˜æ²¡æœ‰ `push` æ·»åŠ é€šçŸ¥å·²å®Œæˆçš„é˜Ÿåˆ— |
| æ¨¡å¼ â‘¡ï¼šåªæœ‰é€šè¿‡å¾ªç¯æ’å…¥é˜Ÿåˆ—çš„å†…è” `script` | `script` å…¨éƒ¨ä¸ºå†…è”å…ƒç´ æ²¡æœ‰ `src`    | å’Œæ¨¡å¼ â‘  ä¸€æ ·                                                                                                                   |

é›†åˆé˜Ÿåˆ—å­˜åœ¨ä¸€ä¸ªå¸¦æœ‰ `async` çš„ `script`ï¼Œæ— è®ºæ˜¯å¦ `fiber` éƒ½ä¼šå‡ºç°é—®é¢˜ï¼š

| æ¨¡å¼                                                          | è§¦å‘å‰æ                                                                       | é—®é¢˜åŸå›                                                                                                                                                  |
| ------------------------------------------------------------- | ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------- |
| æ¨¡å¼ â‘¢ï¼šé€šè¿‡ `beforeScriptResultList` æ’å…¥é˜Ÿåˆ—çš„å¼‚æ­¥ `script` | å¯åŠ¨å‰é€šè¿‡ `js-before-loaders`é…ç½®ï¼Œå½“é›†åˆä¸­æœ‰ä¸€ä¸ªé˜Ÿåˆ—å¸¦æœ‰ `async` çš„ `script` | é˜Ÿåˆ—é€šçŸ¥å·²å®Œæˆçš„ `Promise` å·²æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œä½†åœ¨æ’å…¥ `script` åˆ° `iframe` ä¸­ç”±äº `script` æ˜¯ `async`ï¼Œä¸ä¼šæ‰§è¡Œ `nextScriptElement` ä»è€Œå¯¼è‡´åç»­é˜Ÿåˆ—æ— æ³•æ‰§è¡Œ |
| æ¨¡å¼ â‘£ï¼šé€šè¿‡ `afterScriptResultList` å¼‚æ­¥æ’å…¥é˜Ÿåˆ—çš„ `script`  | å¯åŠ¨å‰é€šè¿‡ `js-after-loader`é…ç½®ï¼Œå½“é›†åˆä¸­æœ‰ä¸€ä¸ªé˜Ÿåˆ—å¸¦æœ‰ `async` çš„ `script`   | å’Œæ¨¡å¼ â‘¢ ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äº `afterScriptResultList` åœ¨æ‰§è¡Œå‰ï¼Œåº”ç”¨çš„ `script` å·²æ’å…¥æ²™ç®± `iframe`ï¼Œä¹Ÿå®Œæˆäº† `mount`ï¼Œä¸­æ–­çš„åªæœ‰ `loaded` äº‹ä»¶                |

`fiber` æ¨¡å¼ä¸‹åœ¨æ¨¡å¼ â‘ ã€æ¨¡å¼ â‘¡ æƒ…å†µä¸‹éƒ½æ˜¯æ­£å¸¸çš„ï¼š

- é»˜è®¤çš„æ¨¡å¼ï¼Œè¦æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—å°±è¦é€šè¿‡å®ä»»åŠ¡ `requestIdleCallback`
- è¿”å›çš„ `promise` å‡½æ•°å†…éƒ¨åœ¨å½“å‰ä»»åŠ¡å±äºä¸Šä¸‹æ–‡ï¼Œä¼˜å…ˆäºä¸‹ä¸€ä¸ªå®ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—

æ‰€æœ‰æ¨¡å¼ä¸‹åŒæ­¥ä»£ç ä¼šæ­£å¸¸æ‰§è¡Œï¼š

- åŒæ­¥ä»£ç å’Œå¼‚æ­¥ä»£ç æŒ‡çš„æ˜¯å­åº”ç”¨çš„ `script`
- åŒæ­¥ä»£ç æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡é›†åˆï¼Œæ‰§è¡Œå‰è¿”å›çš„ `Promise` å‡½æ•°å†…éƒ¨å·² `push` æœ€åä¸€ä¸ªä»»åŠ¡
- å¯¹äºå­åº”ç”¨ä¸­å¸¦æœ‰ `async` å±æ€§çš„ `script` åˆ†åˆ°å¼‚æ­¥ä»£ç ä¸­æ‰§è¡Œ

æ‰€æœ‰æ¨¡å¼ä¸‹å¼‚æ­¥ä»£ç ä¼šæ­£å¸¸æ‰§è¡Œï¼š

- å¼‚æ­¥ä»£ç ç›´æ¥éå† `promise` é˜Ÿåˆ—ï¼Œä¸å— `execQueue` å½±å“ï¼Œå³ä¾¿ä¸æå–é˜Ÿåˆ—ä¹Ÿä¼šæŒ‰ç…§å¾®ä»»åŠ¡æ·»åŠ çš„é¡ºåºæ‰§è¡Œ

é `fiber` æ¨¡å¼ï¼Œæ‰‹åŠ¨æ’å…¥å¸¦æœ‰ `src` ä¸” `content` ä¸ºç©ºçš„ `script`ï¼Œä¸å­˜åœ¨å±æ€§ `async` å¯æ­£å¸¸æ‰§è¡Œï¼š

- å› ä¸º `window.__WUJIE.execQueue.shift()()` æ˜¯é€šè¿‡ `script` çš„ `onload` æ‰§è¡Œ
- `onload` æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼Œä¼šåœ¨å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åå†æ‰§è¡Œ
- æ²¡æœ‰ `async` å°±ä¸ä¼šä¸­æ–­æµç¨‹

å¤ç°é—®é¢˜ 1ï¼šæ²¡æœ‰ `script`

- `static-app`ï¼šåˆ›å»ºä¸€ä¸ªæ²¡æœ‰ `script`ï¼Œæ²¡æœ‰ `style` çš„é™æ€å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static)]
- æ·»åŠ ä¸€ä¸ª `StaticPage.tsx` é¡µé¢ç»„ä»¶ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/StaticPage.tsx)]ï¼Œå…³é—­ `fiber`ï¼Œä¸æ·»åŠ  `js-before-loaders`ã€`js-after-loader`
- åº”ç”¨ç»„ä»¶ `Wujie.tsx`ï¼šæ·»åŠ  `startApp` è¿”å›çš„å‡½æ•° `destroy` å¹¶æ‰“å° [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/components/Wujie.tsx)]

å¤ç°ç»“æœï¼š

- ç‚¹å¼€ `static` åº”ç”¨ï¼Œæ‰“å¼€è°ƒè¯•é¢æ¿ï¼Œåˆ·æ–°é¡µé¢ä»€ä¹ˆéƒ½æ²¡è¿”å›
- ç‚¹å¼€ `react` åº”ç”¨ï¼Œè¿”å› `destroy` æ–¹æ³•

å¤ç°é—®é¢˜ 2ï¼šå­˜åœ¨ `async` çš„ `script`

- åŸç†å’Œé—®é¢˜ 1 ä¸€æ ·ï¼Œå­åº”ç”¨ä¸­æ·»åŠ è·¯ç”± `/async`ï¼Œåœ¨é¡µé¢ä¸­æ·»åŠ ä¸€æ®µ `async` å±æ€§çš„ `script` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static/blob/main/async/index.html)]
- åœ¨ä¸»åº”ç”¨ä¸­æŒ‰ç…§ `StaticPage.tsx` æ·»åŠ ç›¸åº”çš„ç»„ä»¶ `AsyncPage.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/AsyncPage.tsx)]

å¤ç°ç»“æœï¼š

- å’Œé—®é¢˜ 1 ä¸€æ ·ï¼Œå­åº”ç”¨ä¸­ `script` çš„ `async` ä¼šé€šè¿‡å¼‚æ­¥é›†åˆ `asyncScriptResultList` æ·»åŠ åˆ°æ²™ç®± `iframe` ä¸­
- `asyncScriptResultList` ä¸ä¼šå½±å“ `execQueue`

å¤ç°é—®é¢˜ 3ï¼š`jsBeforeLoaders` æ‰“æ–­åº”ç”¨åŠ è½½

- å¤ç°å‰ç¡®ä¿ `react` åº”ç”¨æ­£å¸¸ï¼Œå¤åˆ¶ä¸€ä»½ `ReactPage.tsx` ä½œä¸º `BeforePage.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/BeforePage.tsx)]
- æ·»åŠ  `jsBeforeLoaders`ï¼šè¦æ±‚å¸¦æœ‰ `src` å’Œ `async`

å¤ç°ç»“æœï¼š

- `ReactPage.tsx` æ­£å¸¸ï¼Œ`BeforePage.tsx` åº”ç”¨åŠ è½½è¿‡ç¨‹ä¸­è¢« `jsBeforeLoaders` æ‰“æ–­ä¸ä¼š `mount` åº”ç”¨

ä¿®å¤é—®é¢˜ 1ã€é—®é¢˜ 2ï¼š

- åœ¨ 334 è¡Œ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L334)]ï¼Œç¬¬ä¸€ä¸ªæ‰§è¡Œé˜Ÿåˆ—å…¥å£ `this.execQueue.shift()();` ä¹‹å‰ä¸»åŠ¨æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡
- è¿™æ ·ç¡®ä¿æœ€åä¸€ä¸ªé˜Ÿåˆ—æå–ä¸€å®šæ˜¯åœ¨å¾®ä»»åŠ¡ä¸‹æ‰§è¡Œï¼Œè€Œå½“å‰ä¸Šä¸‹æ–‡ä¸€å®šä¼šåœ¨æœ€åä¸€ä¸ªå¾®ä»»åŠ¡ä¹‹å‰æ’å…¥é˜Ÿåˆ—
- è¿™æ ·ç¡®ä¿äº†é˜Ÿåˆ—æœ€åèƒ½å¤Ÿé¡ºåˆ© `resolve`

```
this.execQueue.push(() => Promise.resolve().then(
  () => this.execQueue.shift()?.()
));
this.execQueue.shift()();
```

é—®é¢˜ 3 çš„è®¾è®¡åˆè¡·ï¼š

- å› ä¸ºå¼‚æ­¥ä»£ç  `asyncScriptResultList` å®ƒæœ¬èº«å’Œ `execQueue` é˜Ÿåˆ—é›†åˆæ˜¯æ²¡æœ‰å…³ç³»çš„
- ä½†å¼‚æ­¥ä»£ç ä¹Ÿæ˜¯æ‰§è¡Œ `insertScriptToIframe` å°† `script` æ’å…¥æ²™ç®± `iframe` ä¸­
- å¦‚æœå¼‚æ­¥ä»£ç ä¹Ÿå»è°ƒç”¨ `execQueue.shift()()`ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆé˜Ÿåˆ—æ‰§è¡Œé¡ºåºé”™ä¹±äº†

ä¿®å¤é—®é¢˜ 3ï¼š

- éå† `beforeScriptResultList` å’Œ `afterScriptResultList` æ—¶å»æ‰ `script` çš„ `async`ï¼Œå¦‚ä¸‹ï¼š

```
beforeScriptResultList.forEach(({ async, ...beforeScriptResult }) => {})
afterScriptResultList.forEach(({ async, ...afterScriptResult }) => {})
```

å› ä¸ºåªæœ‰åœ¨å¯åŠ¨æ—¶ï¼Œé…ç½®æ·»åŠ  `async` çš„ `script` æ‰ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜

> ç”±äºç›®å‰è¿˜åœ¨ç ”ç©¶é˜¶æ®µï¼Œæ²¡æœ‰å¯¹å®˜æ–¹æ PRã€‚

**æ€»ç»“ï¼š**

1. ä½¿ç”¨ `wujie` è¿‡ç¨‹ä¸­è°¨æ…å…³é—­ `fiber`ï¼Œé»˜è®¤æ˜¯ä¸ä¼šå…³é—­ `fiber` çš„
2. ä¸è¦åœ¨ `beforeScriptResultList` æˆ– `afterScriptResultList` ä¼ å…¥å¸¦æœ‰ `async` å±æ€§çš„å¯¹è±¡ï¼Œè™½ç„¶ `ScriptObjectLoader` è¿™ä¸ªå¯¹è±¡æ˜¯å…è®¸é…ç½® `async` çš„ï¼Œè™½ç„¶å®˜æ–¹åœ¨æ–‡æ¡£ä¸­ä¹Ÿå¹¶æ²¡æœ‰è¯´ `async` æ˜¯å¯é€‰é…ç½®ï¼Œä½†æ˜¯æ“…è‡ªæ·»åŠ  `async` åœ¨æºç ä¸­æ˜¯æœ‰é€»è¾‘é—®é¢˜çš„

#### 5. é˜Ÿåˆ—å‰çš„å‡†å¤‡

åŒ…å«ï¼š

- `execFlag` è®¾ç½®ä¸º `true`ï¼Œä»è¿™é‡ŒçŸ¥é“ `execFlag` è¡¨ç¤ºæ˜¯å¦å¯åŠ¨åº”ç”¨
- `execFlag` ä¼šåœ¨ `destroy` è®¾ `null`ï¼Œä»è¿™é‡ŒçŸ¥é“æ³¨é”€åº”ç”¨ååªèƒ½é‡æ–°åˆ›é€ åº”ç”¨å®ä¾‹
- `scriptResultList` æå–è¦æ‰§è¡Œçš„ `script`ï¼Œæ³¨ n (`scriptResultList`)
- `iframeWindow` æå–æ²™ç®±çš„ `window`
- ä¸ºå­åº”ç”¨æ³¨å…¥å…¨å±€å¯¹è±¡ï¼š`__POWERED_BY_WUJIE__`

> æ³¨ nï¼š`scriptResultList`ï¼Œè¿™æ˜¯ä¸ªä¸å½±å“ä½¿ç”¨çš„é—®é¢˜
>
> - ç±»å‹å£°æ˜ `getExternalScripts` æ˜¯ `() => ScriptResultList`ï¼Œæ²¡æœ‰ `promise` æ˜¯ä¸éœ€è¦ `await` çš„
> - `getExternalScripts` è¿”å›ä¸€ä¸ªæ•°ç»„é›†åˆï¼Œé›†åˆä¸­åŒ…å«å¸¦æœ‰ç±»å‹ä¸º `promise` çš„å±æ€§ `contentPromise`ï¼Œå‡½æ•°æœ¬èº«ä¸æ˜¯å¾®ä»»åŠ¡
>
> ç”±æ­¤å¯ä»¥çŸ¥é“ï¼š
>
> - åœ¨éå†å­åº”ç”¨æ¯ä¸€é¡¹ `script` æ—¶ï¼Œ`contentPromise` é¡¹éƒ½æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡
> - è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåŒæ­¥ä»£ç å’Œå¼‚æ­¥ä»£ç éƒ½æ˜¯é€šè¿‡å¾®ä»»åŠ¡å°† `script` æ·»åŠ åˆ° `iframe` ä¸­æ‰§è¡Œçš„åŸå› äº†
> - è€Œå…¶ä»–çš„å¾ªç¯æ’å…¥é˜Ÿåˆ—çš„ `script` ä¸éœ€è¦é€šè¿‡å¾®ä»»åŠ¡å»æ‰§è¡Œæ“ä½œ
> - ä¸ºäº†ä¿è¯å…¶é¡ºåºï¼Œä¹Ÿå› æ­¤ä¸ç®¡æ˜¯å¾®ä»»åŠ¡ä¹Ÿå¥½ï¼Œè¿˜æ˜¯å®ä»»åŠ¡ä¹Ÿå¥½ï¼Œéƒ½è¦æ±‚åœ¨ä¸Šä¸€ä¸ªé˜Ÿåˆ—æ‰§è¡Œå®Œåæå–æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—
>
> ä¸€é“æ€è€ƒé¢˜ï¼šå­åº”ç”¨ä¸­æ‰€æœ‰å¸¦æœ‰ `src` çš„å¤–è” `script` åœ¨ `wujie` ä¸­ä¼šæ€ä¹ˆå¤„ç†
>
> 1. é€šè¿‡ `importHTML` å°†å°†å­åº”ç”¨æ•´ä¸ªèµ„æºåˆ†ç±»ï¼š`template`ã€`assetPublicPath`ã€`script`ã€`css` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
> 2. é€šè¿‡ `processTpl` å°† `script` åˆ†ç±»é…ç½®ï¼š`scr`ã€`async`ã€`defer`ã€`content` ç­‰ [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
> 3. é€šè¿‡ `getExternalScripts` éå† `script` é›†åˆ
> 4. ä¸ºæ¯é¡¹ `script` å¢åŠ ä¸€ä¸ªç±»å‹ä¸º `promise` çš„å±æ€§ `contentPromise`ï¼Œè¯¦ç»†è§ï¼š`importHTML` åŠ è½½èµ„æº - 4.1. `getExternalScripts` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
>
> å› æ­¤ï¼š
>
> - å­åº”ç”¨ `script` åªæœ‰å¤–è”çš„ `ES` æ¨¡å—æˆ–å¸¦æœ‰ `ignore` å±æ€§ï¼Œä¼šå½“åšç©ºå†…å®¹
> - å…¶ä»–æƒ…å†µéƒ½ä½œä¸ºå†…è” `script` å¤„ç†ï¼Œå¤–è”çš„ `script` ä¼šåœ¨æ’å…¥ `iframe` å‰ä¸‹è½½ä¸‹æ¥ï¼Œå³ä¾¿æ˜¯ `async` æˆ– `defer`

å…³é—­åŠ è½½çŠ¶æ€ï¼š

- åœ¨ç¬¬ä¸€æ¬¡æå–é˜Ÿåˆ— `this.execQueue.shift()?.()` ä¹‹å‰ï¼Œä¼šé€šè¿‡ `removeLoading` å…³é—­ `loading` çŠ¶æ€

> åœ¨ `wujie` ä¸­å¯ä»¥é€šè¿‡ `loading` è‡ªå®šä¹‰ä¸€ä¸ªåŠ è½½å…ƒç´ ï¼Œè§æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]

æ‰§è¡Œæ¡ä»¶ï¼š

- æ²¡æœ‰æä¾› `__WUJIE_UNMOUNT` çš„ `umd` æ¨¡å¼ï¼Œæˆ–é `umd` æ¨¡å¼

> è¿™é‡Œè™½ç„¶æä¾›äº† `this.alive` æ¨¡å¼ä½œä¸ºæ£€æµ‹ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå¢åŠ äº† `!isFunction(this.iframe.contentWindow.__WUJIE_UNMOUNT)` åˆ¤æ–­ï¼Œåªè¦ä¸æ˜¯ `umd` æ–¹å¼å¸è½½åº”ç”¨ï¼Œéƒ½ä¼šæ‰§è¡Œå…³é—­ `loading` çŠ¶æ€

#### 6. å¿…é¡»æ·»åŠ é˜Ÿåˆ—çš„ 4 ä¸ªæ–¹æ³•

**1. ä¸»åŠ¨è°ƒç”¨ `mount` æ–¹æ³•**

- è§ï¼š`mount` æŒ‚è½½åº”ç”¨ [[æŸ¥çœ‹](#-mount-æŒ‚è½½åº”ç”¨)]

**2. è§¦å‘ `DOMContentLoaded` äº‹ä»¶**

- åˆ›å»ºä¸€ä¸ª `DOMContentLoaded` è‡ªå®šä¹‰äº‹ä»¶ï¼Œåˆ†åˆ«ç”± `iframeWindow.document` å’Œ `iframeWindow` è§¦å‘

**3. è§¦å‘ `loaded` äº‹ä»¶**

- è‡ªå®šä¹‰äº‹ä»¶ `readystatechange`ï¼Œç”± `iframeWindow.document` è§¦å‘
- è‡ªå®šä¹‰äº‹ä»¶ `load`ï¼Œç”± `iframeWindow` è§¦å‘

**4. è¿”å› `Promise`**

- é€šè¿‡åœ¨è¿”å›çš„ `Promise` å‡½æ•°ä¸­æ·»åŠ é˜Ÿåˆ—æœ€åè¦æ‰§è¡Œçš„ä»»åŠ¡
- `resolve` é‡Šæ”¾è¿”å›çš„å¾®ä»»åŠ¡ï¼Œç”¨äºé€šçŸ¥ `start` å®Œæ¯•

#### ğŸ“ `mount` æŒ‚è½½åº”ç”¨

è§¦å‘åœºæ™¯ï¼š

- åªèƒ½åœ¨åº”ç”¨ `start` æ—¶é€šè¿‡ `execQueue` é˜Ÿåˆ—æ‰§è¡Œ `mount`

æŒ‚è½½åº”ç”¨ä¼šåš 3 ä»¶äº‹

#### 1. `umd` æ–¹å¼å¯åŠ¨

- å¦‚æœåº”ç”¨æ˜¯ `umd` æ–¹å¼æŒ‚è½½åº”ç”¨æ—¶è§¦å‘
- å†æ¬¡å…³é—­æŒ‚è½½å®¹å™¨ `loading` çŠ¶æ€ï¼Œè§ï¼š5. é˜Ÿåˆ—å‰çš„å‡†å¤‡ [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]
- ä½¿ç”¨ `iframeWindow` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `beforeMount`
- è°ƒç”¨å­åº”ç”¨çš„ `__WUJIE_MOUNT` å»æŒ‚è½½åº”ç”¨
- ä½¿ç”¨ `iframeWindow` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `afterMount`
- è®¾ç½® `mountFlag` é¿å…é‡å¤æŒ‚è½½ï¼Œ`mountFlag` ä¼šåœ¨ `unmount` å’Œ `destroy` æ—¶æ›´æ–°

#### 2. `alive` æ¨¡å¼

- ä½¿ç”¨ `iframeWindow` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `activated`

#### 3. æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—

- `this.execQueue.shift()?.()`

#### ğŸ“ `unmount` å¸è½½åº”ç”¨

è§¦å‘åœºæ™¯ï¼š

- `startApp` åˆ‡æ¢ `umd` æ¨¡å¼çš„åº”ç”¨å‰å…ˆå¸è½½
- `iframe` é™çº§å¤„ç†å­åº”ç”¨ `onunload`ï¼Œä¾‹å¦‚ï¼šå­åº”ç”¨è·³è½¬ç¬¬ä¸‰æ–¹é¡µé¢
- `destroy` æ³¨é”€åº”ç”¨
- `web component` ç»„ä»¶ä» `Dom` ä¸­å¸è½½
- æµè§ˆå™¨å‰è¿›åé€€è§¦å‘å­åº”ç”¨ `iframe` é™çº§å®¹å™¨ `onunload`

`unmount` æ˜¯å­˜åœ¨é‡å¤è§¦å‘çš„å¯èƒ½çš„ï¼Œä¾‹å¦‚ï¼š

- è·¯ç”±åˆ‡æ¢å¯¼è‡´ `web component` ä» `Dom` ä¸­å¸è½½ï¼Œè€Œåº”ç”¨å®¹å™¨æ˜¯ `iframe`

é‡å†™ `onunload` äº‹ä»¶

- ç›‘å¬ `popstate` åé€€ï¼Œæ ¹æ® `hrefFlag` [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)] å†³å®šæ˜¯å¦è¦é‡ç»˜ `iframe` è§¦å‘ `onunload`

å¸è½½æµç¨‹åˆ†ä¸º 3 éƒ¨åˆ†ï¼š

#### 1. å¸è½½åº”ç”¨ - æ‰€æœ‰æ¨¡å¼

- `activeFlag` å¤±æ´»ï¼Œè§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- æ¸…ç†è·¯ç”±ï¼Œè§ `clearInactiveAppUrl` [[æŸ¥çœ‹](#clearinactiveappurlæ¸…ç†è·¯ç”±)]

#### 2. å¸è½½ `alive` æ¨¡å¼çš„åº”ç”¨

- ä½¿ç”¨æ²™ç®± `iframeWindow` è§¦å‘ç”Ÿå‘½å‘¨æœŸ `deactivated`

#### 3. å¸è½½ `umd` æ¨¡å¼çš„åº”ç”¨

å‡†å¤‡å¸è½½ `umd` æ¨¡å¼å­åº”ç”¨ï¼Œè¦æ±‚ï¼š

- `mountFlag` å·²å¸è½½ä¸å¤„ç†ï¼Œè§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- å­åº”ç”¨ä¸­ä¸å­˜åœ¨ `__WUJIE_UNMOUNT` ä¸å¤„ç†
- `alive` æ¨¡å¼æˆ–å½“å‰çš„ `url` ä¸æ˜¯æ¥è‡ªåŸºåº§ä¸å¤„ç†ï¼Œè§ï¼šæ³¨ n `hrefFlag` [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

å¸è½½ `umd` æ¨¡å¼å­åº”ç”¨ï¼š

- ä½¿ç”¨æ²™ç®± `iframeWindow` è§¦å‘ç”Ÿå‘½å‘¨æœŸ `beforeUnmount`
- è°ƒç”¨å­åº”ç”¨æŒ‚è½½åœ¨ `window` ä¸Šçš„ `__WUJIE_UNMOUNT`
- ä½¿ç”¨æ²™ç®± `iframeWindow` è§¦å‘ç”Ÿå‘½å‘¨æœŸ `afterUnmount`
- `mountFlag` å¤±æ´»
- `this.bus.$clear`ï¼šæ¸…ç©ºå­åº”ç”¨æ‰€æœ‰ç›‘å¬çš„äº‹ä»¶ï¼Œè§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

é `degrade` ä¸»åŠ¨é™çº§ `umd` æ¨¡å¼è¡¥å……æ“ä½œï¼š

- è¿™é‡Œåˆ¤æ–­ `degrade` æ˜¯å› ä¸ºä¸»åŠ¨é™çº§æ¨¡å¼ä¸‹æ²¡æœ‰ `shadowRoot`
- è¿™é‡Œä¼šæ¸…ç©º `shadowRoot` ä¸‹æ‰€æœ‰å…ƒç´ ï¼Œå¹¶æ¸…ç†è®°å½•åœ¨å®ä¾‹ `head`ã€`body` çš„äº‹ä»¶

æœ€åå°†å®ä¾‹çš„ `head`ã€`body` ä¸‹çš„å…ƒç´ å…¨éƒ¨åˆ é™¤

- æ‰€æœ‰åˆ é™¤çš„å…ƒç´ ä¼šåœ¨ä¸‹æ¬¡ `active` æ¿€æ´»åº”ç”¨æ—¶ï¼Œä¼šé‡æ–°æ³¨å…¥åº”ç”¨èµ„æº
- æ‰€æœ‰æ¸…ç©ºçš„ç›‘å¬è®°å½•ï¼Œä¹Ÿä¼šåœ¨ä¸‹æ¬¡ `active` æ¿€æ´»åº”ç”¨æ—¶ï¼Œé‡æ–°æ”¶é›†

#### ğŸ“ `patchCssRules` å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸

åœ¨å­åº”ç”¨æ¸²æŸ“å®Œæ¯•ä¹‹åï¼Œæå–å­åº”ç”¨æ‰€æœ‰çš„æ ·å¼ï¼Œç­›é€‰æŒ‚è½½åˆ°å¤–éƒ¨ï¼š

1. å…¼å®¹ `:root` é€‰æ‹©å™¨æ ·å¼åˆ° `:host` é€‰æ‹©å™¨ä¸Š
2. å°† `@font-face` å®šä¹‰åˆ° `shadowRoot` å¤–éƒ¨

è°ƒç”¨åœºæ™¯ï¼š

- `active` ä¸­æ¸²æŸ“åˆ° `shadowRoot` ä¹‹å
- `rebuildStyleSheets` åœ¨ `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨é‡å»ºæ ·å¼ä¹‹å

ä¸ä¼šæ‰§è¡Œæ“ä½œçš„æƒ…å†µï¼š

- `degrade` ä¸»åŠ¨é™çº§ä¸å¤„ç†ã€`WUJIE_DATA_ATTACH_CSS_FLAG` å·²å¤„ç†è¿‡ä¸å¤„ç†

æ³¨æ„ï¼š

- `patchCssRules` ä¸€å®šæ˜¯æ¸²æŸ“å®Œæˆåè°ƒç”¨ï¼Œå¦åˆ™æ‹¿ä¸åˆ°æœ€ç»ˆæ ·å¼
- åœ¨æ²™ç®± `iframe` æå–æœ€ç»ˆæ ·å¼ï¼Œå› ä¸ºå®¹å™¨æ·»åŠ å…ƒç´ åŒæ—¶ä¹Ÿä¼šåœ¨æ²™ç®± `iframe` ä¸­æ·»åŠ ï¼Œè§ï¼šåŒæ—¶æ·»åŠ å…ƒç´  [[æŸ¥çœ‹](#åŒæ—¶æ·»åŠ å…ƒç´ )]

`patchCssRules` å­˜åœ¨åˆç†çš„é‡å¤è°ƒç”¨ï¼š

- åˆ‡æ¢ `umd` æ¨¡å¼åº”ç”¨æ—¶ï¼Œ`active` æ¸²æŸ“æ¨¡æ¿ä¹‹åï¼Œå­åº”ç”¨ä¸ä¼šå†æ¬¡åŠ¨æ€æ·»åŠ æ ·å¼ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡ `mount` æŒ‚è½½åº”ç”¨
- è¿™ä¸ªæ—¶å€™éœ€è¦å†æ¬¡é€šè¿‡ `rebuildStyleSheets` å°†åˆå§‹åŒ–æ—¶è®°å½•çš„æ ·å¼æ·»åŠ åˆ°å®¹å™¨ä¸­

#### ğŸ“ `rebuildStyleSheets` é‡æ–°æ¢å¤æ ·å¼

å½“å­åº”ç”¨å†æ¬¡æ¿€æ´»åï¼Œåªè¿è¡Œ `mount` å‡½æ•°ï¼Œæ ·å¼éœ€è¦é‡æ–°æ¢å¤ã€‚`styleSheetElements` çš„æ ·å¼æ¥è‡ª 2 å¤„ï¼Œè§ï¼š`styleSheetElements` [[æŸ¥çœ‹](#åŒæ—¶æ·»åŠ å…ƒç´ )]

æ¢å¤æ–¹å¼ï¼š

- éå† `styleSheetElements` é›†åˆï¼Œå¦‚æœä¸å­˜åœ¨æˆ–è€…ä¸ºç©ºåˆ™è·³è¿‡æ¢å¤
- æ ¹æ®å®¹å™¨å†³å®šå°†é›†åˆä¸­çš„æ ·å¼æ·»åŠ åˆ° `shadowRoot` è¿˜æ˜¯ `iframe` å®¹å™¨ä¸­

#### ğŸ“ `Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§

è¿™é‡Œåªåˆ—ä¸¾éƒ¨åˆ†å…³é”®çš„å±æ€§ï¼š

| å±æ€§                   | å®šä¹‰                                                                                                                                           | `constructor` åˆå§‹åŒ–                                                           | `destroy` æ³¨é”€          |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ | ----------------------- |
| `activeFlag`           | å®ä¾‹å·²æ¿€æ´»                                                                                                                                     | `undefined`ï¼Œåœ¨ `active` æ—¶ä¸º `true`                                           | åœ¨ `unmount` ä¸­ `false` |
| `bus`                  | é€šä¿¡å¯¹è±¡ï¼Œä½¿ç”¨ `appEventObjMap` è·å–äº‹ä»¶æ˜ å°„è¡¨ï¼Œé€šè¿‡ `inject` å®ç°çˆ¶å­åº”ç”¨æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œè§ `inject` [[æŸ¥çœ‹](#1-inject-æ³¨å…¥å­åº”ç”¨-3-ä¸ªå¯¹è±¡)]  | `EventBus`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/bus.html)]  | `null`                  |
| `degrade`              | ä¸»åŠ¨é™çº§ï¼Œç”¨ `iframe` ä½œä¸ºåº”ç”¨å®¹å™¨                                                                                                             | é€šè¿‡é…ç½®æ–‡ä»¶åœ¨æ„é€ å‡½æ•°ä¸­å£°æ˜                                                   | ä¸å¤„ç†                  |
| `elementEventCacheMap` | å­åº”ç”¨ `dom` ç›‘å¬äº‹ä»¶ç•™å­˜ï¼Œå½“é™çº§æ—¶ç”¨äºä¿å­˜å…ƒç´ äº‹ä»¶                                                                                            | `WeakMap`ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­é€šè¿‡ `iframeGenerator` å‘èµ·è®°å½•                         | `null`                  |
| `execFlag`             | `start` åº”ç”¨åˆ™ä¸º `true`                                                                                                                        | `undefined`                                                                    | `null`                  |
| `execQueue`            | `start` åº”ç”¨ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—                                                                                                                       | `undefined`                                                                    | `null`                  |
| `hrefFlag`             | åˆ¤æ–­å­åº”ç”¨çš„ `url`ï¼Œæ³¨ n `hrefFlag`                                                                                                            | `undefined`                                                                    | `null`                  |
| `mountFlag`            | `umd` æ¨¡å¼æŒ‚è½½ `true`ï¼Œå¸è½½ `false`                                                                                                            | `undefined`                                                                    | `null`                  |
| `provide`              | ä¸ºå­åº”ç”¨æä¾›é€šä¿¡ã€ä¼ é€’æ•°æ®ã€è·å– `shadowRoot` å’Œå­åº”ç”¨çš„ `location`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/wujie.html#wujie)] | åœ¨æ„é€ å‡½æ•°é‡Œæä¾› `bus`ã€`location`ï¼Œåœ¨ `active` ä¸­æä¾› `props` å’Œ `shadowRoot` | `null`                  |
| `styleSheetElements`   | æ”¶é›†åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„æ ·å¼ï¼Œé™æ€ `:root` æ ·å¼ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]                                                         | `[]`                                                                           | `null`                  |
| `sync`                 | å•å‘åŒæ­¥è·¯ç”±ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#sync)]                                                      | `unndefined`ï¼Œåªåœ¨ `active` æ—¶é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®                                 | ä¸å¤„ç†                  |
| `template`             | `string` ç±»å‹ï¼Œè®°å½•é€šè¿‡ `processCssLoader` å¤„ç†åçš„èµ„æºï¼Œåœ¨ `alive` æˆ– `umd` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨æ—¶å¯ä¿è¯èµ„æºä¸€è‡´æ€§                                  | `unndefined`ï¼Œåªåœ¨ `active` æ—¶å€™è®°å½•                                           | ä¸å¤„ç†                  |

> æ³¨ nï¼š`hrefFlag`ï¼š
>
> - `locationHrefSet` ä¿®æ”¹ `URL`ï¼šåœ¨åº”ç”¨ä¸­é€šè¿‡ `location` è®¾ç½® `href` æ—¶å€™ä¸º `true`
> - `popstate` åé€€æ—¶ï¼Œå‰ä¸€ä¸ªé¡µé¢çš„ `location.search` æ˜¯ `http` å¼€å¤´ä¸º `true`
> - `popstate` åé€€æ—¶ `hrefFlag` ä¸º `true`ï¼Œæˆ– `active` æ¿€æ´»åº”ç”¨æ—¶ä¸º `false`
>
> ç”±æ­¤å¯ä»¥å¾—å‡º `hrefFlag` è¡¨ç¤ºå½“å‰åº”ç”¨çš„é“¾æ¥å¹¶éæ¥è‡ªåŸºåº§ï¼Œå› æ­¤ `hrefFlag` ä¸º `true` æ—¶ï¼š
>
> - `umd` æ¨¡å¼ `unmount` æ—¶ï¼Œå¦‚æœå½“å‰åº”ç”¨é“¾æ¥å¹¶éæ¥è‡ªåŸºåº§ï¼Œä¸ä¼šè§¦å‘å­åº”ç”¨ `__WUJIE_UNMOUNT` ç­‰æ“ä½œ
> - å¸è½½åº”ç”¨æ—¶ï¼Œ`clearInactiveAppUrl` ä¸ä¼šæ¸…ç† `queryMap`
> - `popstate` åé€€æ—¶åˆ¤æ–­åé€€è·¯ç”±çš„æ¥è·¯å†³å®šæ˜¯å¦é‡ç»˜åº”ç”¨

### `packages` - `wujie-react`

åªçœ‹ `wujie-core` å’Œ `wujie-react`ï¼Œå…¶ä¸­ `WujieReact` è¿™ä¸ªç»„ä»¶å’ŒåŸºåº§æ¼”ç¤ºçš„è‡ªå®šä¹‰ç»„ä»¶æ˜¯å¦‚å‡ºä¸€è¾™ï¼Œè§è‡ªå®šä¹‰ç»„ä»¶ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/components/Wujie.tsx)]ã€‚

å…ˆçœ‹å®˜æ–¹æä¾›çš„ `react` ç»„ä»¶ï¼Œåªæœ‰ä¸€ä¸ªæ–‡ä»¶ `index.js` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-react/index.js)]

é™æ€å±æ€§ï¼š

- `propTypes`ï¼šå®šä¹‰ç»„ä»¶çš„å±æ€§ç±»å‹ï¼Œç”¨äºç±»å‹æ£€æŸ¥ã€‚
- `bus`ï¼Œ`setupApp`ï¼Œ`preloadApp`ï¼Œ`destroyApp`ï¼šä» `wujie` åº“å¼•å…¥çš„é™æ€å±æ€§å’Œæ–¹æ³•ï¼Œå¯èƒ½ç”¨äºå­åº”ç”¨çš„ç®¡ç†å’Œæ§åˆ¶ã€‚

> å¤–éƒ¨å¯ä»¥ç›´æ¥é€šè¿‡ `WujieReact` è¿™ä¸ªç±»è·å–é™æ€å±æ€§

çŠ¶æ€å’Œå¼•ç”¨ï¼š

- `state`ï¼šå®šä¹‰äº†ä¸€ä¸ª `myRef`ï¼Œç”¨äºå­˜å‚¨å¯¹ `DOM` å…ƒç´ çš„å¼•ç”¨ã€‚
- `destroy` å’Œ `startAppQueue` æ˜¯å®ä¾‹å±æ€§ï¼Œç”¨äºå­˜å‚¨é”€æ¯æ–¹æ³•å’Œå¯åŠ¨åº”ç”¨çš„ `Promise` é˜Ÿåˆ—ï¼Œåœ¨ç»„ä»¶ä¸­åªåšäº†å®šä¹‰æ²¡æœ‰ä½¿ç”¨ã€‚

**æ–¹æ³•ï¼š**

`startApp`ï¼š

- å¼‚æ­¥æ–¹æ³•ï¼Œç”¨äºå¯åŠ¨å­åº”ç”¨ã€‚
- ä½¿ç”¨ `startApp` æ–¹æ³•ä¼ å…¥ç»„ä»¶çš„å±æ€§å’Œå¼•ç”¨çš„ `DOM` å…ƒç´ ã€‚

ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼š

- `componentDidMount`ï¼šåœ¨ç»„ä»¶æŒ‚è½½åè°ƒç”¨ `startApp` æ–¹æ³•å¯åŠ¨å­åº”ç”¨ã€‚
- `componentDidUpdate`ï¼šå½“ç»„ä»¶çš„ `name` æˆ– `url` å±æ€§å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°å¯åŠ¨å­åº”ç”¨ã€‚

`render` æ–¹æ³•ï¼š

- æ¸²æŸ“ä¸€ä¸ª `div` å…ƒç´ ï¼Œå¹¶å°†ç»„ä»¶çš„å®½åº¦å’Œé«˜åº¦è®¾ç½®ä¸ºå±æ€§ä¸­çš„å€¼ã€‚
- é€šè¿‡ `ref` å±æ€§å°† `div` çš„å¼•ç”¨å­˜å‚¨åˆ° `myRef` ä¸­ã€‚

æ–‡æ¡£ï¼š

- `React` å°è£…ç»„ä»¶ä½¿ç”¨ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/pack/react.html)]
- å°è£…ç»„ä»¶çš„ `props` å‚è€ƒ `startApp` [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]

æ€»ç»“ï¼š

`WujieReact` ç»„ä»¶ä½¿ç”¨ `wujie` åº“æ¥ç®¡ç†å­åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œé€šè¿‡ `startApp` æ–¹æ³•å¯åŠ¨å­åº”ç”¨ï¼Œå¹¶åœ¨ç»„ä»¶æ›´æ–°æ—¶é‡æ–°å¯åŠ¨å­åº”ç”¨ã€‚é€šè¿‡é™æ€å±æ€§å’Œç±»å‹æ£€æŸ¥ç¡®ä¿ç»„ä»¶çš„ä½¿ç”¨ç¬¦åˆé¢„æœŸã€‚

### è¾…åŠ©æ–¹æ³• - æå–åº”ç”¨èµ„æº

å›´ç»•æå–åº”ç”¨èµ„æºå½’çº³ç›¸å…³çš„æ–¹æ³•

#### `importHTML` åŠ è½½èµ„æº

åŠ è½½å­åº”ç”¨èµ„æºã€è·å–æå–èµ„æºçš„æ–¹æ³•

ç›®å½•ï¼š`entry.ts` - `importHTML` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L200)]

ç”¨äºåŠ è½½å’Œå¤„ç†èµ„æºå†…å®¹ï¼Œç›¸å½“äºï¼š

- `qiankun` çš„ `importEntry` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-qiankun-substrate?tab=readme-ov-file#212-prefetch-%E6%89%A7%E8%A1%8C%E9%A2%84%E5%8A%A0%E8%BD%BD)]
- `micro-app` çš„ `HTMLLoader` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#12-htmlloader-%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90)]

> é™¤äº† `qiankun` ä½¿ç”¨çš„æ˜¯ `import-html-entry` [[æŸ¥çœ‹](https://github.com/kuitos/import-html-entry)]ï¼Œå…¶ä»–éƒ½æ˜¯å•ç‹¬å¼€å‘çš„

å…ˆä»å…¥å‚çœ‹ï¼Œå‚æ•°ä¸ºåŒ…å« 3 ä¸ªå±æ€§çš„ `params`ï¼š

- `url`ï¼šè¿œç¨‹èµ„æºè¿æ¥
- `html`ï¼šé™æ€èµ„æºï¼Œå­˜åœ¨åˆ™ä¼˜å…ˆä½¿ç”¨
- `opts`ï¼šåŒ…å«åŠ è½½å’Œå¤„ç† `HTML` çš„ç›¸å…³é…ç½®

`opts` åŒ…å« 4 ä¸ªå¯é€‰å±æ€§ï¼š

- `fetch`ï¼šé»˜è®¤çš„ `fetch` è¿˜æ˜¯è‡ªå®šä¹‰çš„ `fetch`
- `plugins`ï¼šå­åº”æ’ä»¶ï¼Œè¯¦ç»†è§æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#plugins)]
- `loadError`ï¼šå­åº”ç”¨åŠ è½½èµ„æºå¤±è´¥åè§¦å‘ï¼Œ`startApp` æ—¶é…ç½®
- `fiber`ï¼šç©ºé—²åŠ è½½

æœ€ç»ˆè¿”å› `Promise<htmlParseResult>`ï¼Œå…¶ä¸­ `htmlParseResult` åŒ…å«ï¼š

- `template`ï¼šå¤„ç†åçš„èµ„æºå†…å®¹
- `assetPublicPath`ï¼šèµ„æºè·¯å¾„
- `getExternalScripts`ï¼šæå–å¤–éƒ¨ `script` çš„æ–¹æ³•ï¼Œè¿”å› `ScriptResultList[]` é›†åˆ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L19)]
- `getExternalStyleSheets`ï¼šæå–å¤–éƒ¨ `style` çš„æ–¹æ³•ï¼Œè¿”å› `StyleResultList[]` é›†åˆ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L20)]

è¿”å›çš„èµ„æºä¼šæ ¹æ® `plugins` æ˜¯å¦å­˜åœ¨ `htmlLoader` æ¥å¤„ç†ç»“æœï¼š

- å­˜åœ¨ï¼šä½¿ç”¨è‡ªå®šä¹‰çš„ `loader` å‡½æ•°å¤„ç† `html`ï¼Œä¸ç¼“å­˜
- ä¸å­˜åœ¨ï¼šä½¿ç”¨é»˜è®¤çš„ `loader` å‡½æ•° `defaultGetTemplate` å¤„ç†ï¼Œå°†ç»“æœç¼“å­˜åˆ° `embedHTMLCache` ä»¥é¿å…é‡å¤åŠ è½½èµ„æº

ç”¨åˆ° `importHTML` çš„åœ°æ–¹æœ‰ 3 å¤„ï¼š

- `preloadApp` é¢„åŠ è½½
- `startApp` åˆ‡æ¢ `alive` æ¨¡å¼çš„åº”ç”¨
- `startApp` åˆæ¬¡åŠ è½½æ²™ç®±å®ä¾‹

å­åº”ç”¨æ ·å¼æå–æ¦‚è§ˆï¼š

- åŒ¹é…çš„å¤–è”æ ·å¼å’Œå†…è”æ ·å¼ä¼šé€šè¿‡ `processTpl` æ›¿æ¢ä¸ºæ³¨é‡Š [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- é€šè¿‡ `getExternalStyleSheets` ä¸ºæ¯ä¸ª `style` åŒ…è£¹ä¸€ä¸ª `Promise` å±æ€§ `contentPromise`ï¼ˆå½“å‰ç« èŠ‚.4ï¼‰
- é€šè¿‡ `processCssLoader` ç»Ÿä¸€åœ¨ `getEmbedHTML` ä¸­å†æ¬¡æ›¿æ¢æˆå†…è”æ ·å¼ [[æŸ¥çœ‹](#getembedhtml-è½¬æ¢æ ·å¼)]

å­åº”ç”¨ `script` æå–æ¦‚è§ˆï¼š

- åªå¯¹ `ignore` å’Œ `ES` ä¸åŒ¹é…çš„æƒ…å†µçš„ `script` æ³¨é‡Šï¼Œæ³¨é‡Šåä¸ä¼šå†è¿˜åŸ [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- å…¶ä»–æƒ…å†µé€šè¿‡ `getExternalScripts` ä¸ºæ¯ä¸ª `script` åŒ…è£¹ä¸€ä¸ª `Promise` å±æ€§ `contentPromise`ï¼ˆå½“å‰ç« èŠ‚.4ï¼‰
- åœ¨å¯åŠ¨åº”ç”¨ `start` æ—¶ï¼Œä¼šå°†å­åº”ç”¨çš„ `script` åˆ†ä¸ºï¼šåŒæ­¥ä»£ç é€šè¿‡ `execQueue` é˜Ÿåˆ—æ‰§è¡Œã€å¼‚æ­¥ä»£ç é€šè¿‡å¾®ä»»åŠ¡æ‰§è¡Œ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

æ•´ä¸ªæµç¨‹åˆ† 3 æ­¥ï¼š

1. æå–å¿…è¦çš„é…ç½®
2. è¿œç¨‹åŠ è½½æˆ–ç›´æ¥è¿”å›è¦åŠ è½½çš„èµ„æº
3. å¤„ç†èµ„æº

**1. æå–å¿…è¦çš„èµ„æºï¼š**

- `fetch`ï¼šåªèƒ½æ˜¯è‡ªå®šä¹‰çš„ `fetch` æˆ– `window.fetch`
- `fiber`ï¼šæ˜¯å¦ç©ºé—²åŠ è½½
- æå– `plugins` ç”¨äºè‡ªå®šä¹‰ `loader` å¤„ç†èµ„æºï¼Œæå– `loadError` ç”¨äºæå–å¤–éƒ¨èµ„æºå¤±è´¥æ—¶ä½¿ç”¨
- `htmlLoader`ï¼šæ ¹æ® `plguins` è¿”å›è‡ªå®šä¹‰å¤„ç† `loader` å‡½æ•°ï¼Œä¸å­˜åœ¨ä½¿ç”¨é»˜è®¤æä¾›çš„ `defaultGetTemplate`
- é€šè¿‡ `getEffectLoaders` æå– `jsExcludes`ï¼š`js` æ’é™¤åˆ—è¡¨ï¼Œæ³¨ n (`getEffectLoaders`)
- é€šè¿‡ `getEffectLoaders` æå– `cssExcludes`ï¼š`css` æ’é™¤åˆ—è¡¨
- é€šè¿‡ `getEffectLoaders` æå– `jsIgnores`ï¼š`js` å¿½ç•¥åˆ—è¡¨
- é€šè¿‡ `getEffectLoaders` æå– `cssIgnores`ï¼š`css` å¿½ç•¥åˆ—è¡¨
- é€šè¿‡ `defaultGetPublicPath` å°†å­åº”ç”¨çš„ `url` å’Œ `localhost.href` è®¡ç®—å‡ºèµ„æºè·¯å¾„

> æ³¨ nï¼š`getEffectLoaders` æå–çš„èµ„æºé€šè¿‡ `reduce` æœ€ç»ˆæ‹·è´è¿”å›ä¸€ä¸ªæ–°çš„ `Array<string | RegExp>` å¯¹è±¡

**2. è·å–èµ„æºï¼š**

é€šè¿‡ `getHtmlParseResult` è·å–èµ„æºï¼Œæ¥å— 3 ä¸ªå‚æ•°ï¼š

- `url`ï¼šèµ„æºè¿œç¨‹é“¾æ¥
- `html`ï¼šç°æœ‰çš„èµ„æº
- `htmlLoader`ï¼šé€šè¿‡ `plugins` ä¼ å…¥çš„ `htmlLoader`ï¼Œä¸å­˜åœ¨ä½¿ç”¨ `defaultGetTemplate`

> é»˜è®¤çš„ `defaultGetTemplate` å°†ä¸å¤„ç†èµ„æºç›´æ¥å°†ä¼ å…¥çš„ `template` è¿”å›

æä¾› `html` æ—¶ä¼˜å…ˆä½¿ç”¨ï¼Œå¦åˆ™é€šè¿‡ `fetch` è·å–èµ„æºé“¾æ¥ï¼Œå¦‚æœè·å–å¤±è´¥è®°å½•åœ¨ `embedHTMLCache`ï¼Œä¸‹æ¬¡ä¸å†è·å–ã€‚

> `getHtmlParseResult` ç›¸å½“äº `micro-app` ä¸­çš„ `extractSourceDom` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#13-extractsourcedom-%E6%88%90%E5%8A%9F%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E5%9B%9E%E8%B0%83)]

**3. å¤„ç†è¿”å›èµ„æºï¼š**

- è·å–èµ„æºè·¯å¾„ `assetPublicPath`ï¼Œæ³¨ n (`assetPublicPath`)
- é€šè¿‡ `htmlLoader` å¤„ç†è·å–çš„èµ„æº
- å¦‚æœé€šè¿‡ `plugins` ä¼ å…¥ `htmlLoader` å¤„ç†ï¼Œä¼šå°†è·å–çš„èµ„æºä½œä¸ºå­—ç¬¦å‚æ•°ä¼ é€’è¿‡å»
- é€šè¿‡ `processTpl` ä¼ å…¥å¤„ç†è¿‡åçš„ `html`ã€`assetPublicPath`ï¼Œæå– `template`ã€`script`ã€`style`ï¼Œè§ï¼š`processTpl` æå–èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- æœ€ç»ˆè¿”å›èµ„æºå¯¹è±¡ï¼Œå³ä¸Šè¿°æœ€ç»ˆè¿”å›çš„ `Promise<htmlParseResult>`

> æ³¨ nï¼š`assetPublicPath`
>
> - `qiankun` å’Œ `micro-app` é€šè¿‡ `__webpack_public_path__` é…ç½®èµ„æºè·¯å¾„
> - `qiankun` æ ¹æ® `window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__` é…ç½®
> - `micro-app` æ ¹æ® `window.__MICRO_APP_PUBLIC_PATH__` é…ç½®
> - `wujie` ä¸éœ€è¦é…ç½® `__webpack_public_path__`ï¼Œé€šè¿‡ `defaultGetPublicPath` è®¡ç®—å­åº”ç”¨å…¥å£ `url` ä¸º `baseurl`

**4. è·å–å¤–éƒ¨èµ„æºï¼š**

`getExternalScripts` è·å– `script`ï¼Œ`getExternalStyleSheets` è·å– `css`ï¼Œè·å–å‰éƒ½å°†èµ„æºéå†ä¸€éï¼š

- å‰”é™¤æ‹¥æœ‰å¤–é“¾ä¸”è¢« `jsExcludesï½œcssExcludes` æ’é™¤çš„èµ„æº
- éå†è¿‡æ»¤åçš„é›†åˆï¼Œå¯¹æ‹¥æœ‰å¤–é“¾ä¸”è¢« `jsIgnores|cssIgnores` èµ„æºå¯¹è±¡æ‰“ä¸Š `ignore` çš„å±æ€§

é™¤æ­¤ä¹‹å¤–ä»–ä»¬éƒ½ä¼šå°† `fetch`ã€`loadError` ä¼ è¿‡å»ä½œä¸ºå¤„ç†ï¼Œä¸åŒåœ¨äº `script` è¿˜ä¼šå°† `fiber` ä¼ è¿‡å»

**4.1. `getExternalScripts`ï¼š**

ä¼ è¿‡å»ä¸€ä¸ªé›†åˆ `ScriptObject[]`ï¼Œç›´æ¥ `map` åè¿”å›ã€‚ä¸åŒçš„æ˜¯ä¸ºæ¯ä¸€é¡¹èµ„æºæ·»åŠ äº†ä¸€ä¸ª `promise` æ–¹æ³• `contentPromise`ï¼Œåˆ†ä¸º 3 ä¸ªæƒ…å†µï¼š

1. æœ‰ `src`ï¼Œä¸”ä¸æ˜¯ `ES` æ¨¡å—ï¼Œé€šè¿‡ `fetchAssets` åŠ è½½èµ„æº
2. æœ‰ `src` çš„ `ES` æ¨¡å—ï¼Œè¿”å›ä¸€ä¸ªç©ºå­—ç¬¦çš„ `promise`
3. å†…è”è„šæœ¬å†…å®¹ä½œä¸º `promise` è¿”å›

> å¯¹äºå¤–é“¾ `script` ä¸”å­˜åœ¨ `async` æˆ– `defer`ï¼Œä¼šæ ¹æ® `fiber` å†³å®šæ˜¯åœ¨ `requestIdleCallback` ç©ºé—²æƒ…å†µä¸‹ `fetchAssets` åŠ è½½èµ„æº

**4.2. `getExternalStyleSheets`ï¼š**

ä¼ è¿‡å»ä¸€ä¸ªé›†åˆ `StyleObject[]`ï¼Œç›´æ¥ `map` åè¿”å›ã€‚åˆ†ä¸º 2 ä¸ªæƒ…å†µï¼š

1. å†…è”æ ·å¼ç”¨ `content` æ¢æˆä¸€ä¸ª `promise` å¯¹è±¡ `contentPromise`
2. å¤–é“¾æ ·å¼æ·»åŠ  `promise` å¯¹è±¡ `contentPromise`ï¼Œæ ¹æ® `ignore` å†³å®šè¿”å›ç©ºå­—ç¬¦è¿˜æ˜¯é€šè¿‡ `fetchAssets` åŠ è½½èµ„æº

**5. å­˜åœ¨çš„ 2 ä¸ªé—®é¢˜ï¼š**

ä¸€ä¸ªä¼¼ä¹ä¸å½±å“ä½¿ç”¨çš„é—®é¢˜ï¼š

- å…ˆå…¨å±€æœç´¢ `styles.push` åªæœ‰ 2 å¤„ï¼Œä¸”éƒ½æ²¡æœ‰è®¾ç½® `ignore`ï¼Œè§ï¼š`processTpl` æºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/template.ts#L143)]
- é‚£ä¹ˆåœ¨æ‰€æœ‰é€šè¿‡ `importHTML` æå–å‡ºæ¥çš„ `StyleObject` éƒ½ä¼šè¢«å¿½ç•¥ `ignore`

äº§ç”Ÿçš„é—®é¢˜ï¼š

- å­åº”ç”¨åŸç‰ˆ `ignore` å±æ€§çš„æ ·å¼å°±çœŸçš„è¢«æ³¨é‡Šäº†å•Šã€‚ã€‚ã€‚ã€‚

è¯´å®ƒä¸å½±å“ä½¿ç”¨æ˜¯å› ä¸ºï¼š

- å³ä¾¿ `ignore` æ­£ç¡®æ”¶é›†ï¼Œæœ€ç»ˆ `contentPromise` è¿˜æ˜¯ä»¥ç©ºå­—ç¬¦è¾“å‡º `Promise.resolve("")`
- `getEmbedHTML` åœ¨å¤„ç†å¤–è” `css` ç¨å¾®ä¸åŒï¼Œä½†æœ€ç»ˆç»“æœè¿˜æ˜¯è¢«å¿½ç•¥ï¼Œè§ `getEmbedHTML` [[æŸ¥çœ‹](#getembedhtmlè½¬æ¢æ ·å¼)]

ä¸€ä¸ªé‡å¤åŠ è½½çš„é—®é¢˜ï¼ŒåŒ…å«åœºæ™¯ï¼š

- `preloadApp` é¢„åŠ è½½åº”ç”¨åï¼Œ`startApp` å¯åŠ¨é `alive` æ¨¡å¼çš„åº”ç”¨
- `startApp` åˆ‡æ¢é `alive` æ¨¡å¼æˆ– `umd` æ¨¡å¼çš„åº”ç”¨

æ¯æ¬¡åˆ‡æ¢é `alive` æ¨¡å¼æˆ– `umd` æ¨¡å¼çš„åº”ç”¨ï¼Œä¼šé‡å¤æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š

| æ“ä½œæ­¥éª¤                           | å¿…è¦æ€§                                                                                           | `micro-app` æ€ä¹ˆåš                                                                                                                                                                                                                                                                                                                                                     |
| ---------------------------------- | ------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1. æ¸…ç©ºå®¹å™¨ï¼Œæ³¨å…¥ `loading`        | æ ¹æ®æƒ…å†µå†³å®š                                                                                     | æ³¨é”€ç»„ä»¶æ—¶éœ€è¦è€ƒè™‘æ¸…ç†å­åº”ç”¨çš„çŠ¶æ€å’Œäº‹ä»¶                                                                                                                                                                                                                                                                                                                               |
| 2. åˆ›å»ºæ–°çš„åº”ç”¨å®ä¾‹ `Wujie`        | éå¿…è¦ï¼Œ`Wujie` æ¯æ¬¡æ³¨é”€åº”ç”¨éƒ½æ˜¯å½»åº•é”€æ¯ä¸‹æ¬¡åˆ‡æ¢é‡å»ºæ–°å®ä¾‹                                       | æ›´æ”¹å®ä¾‹å¯¹åº”çš„å±æ€§ç”¨äºå¯¹åº”ä¸‹çº¿çš„åº”ç”¨ï¼Œå¾…ä¸‹æ¬¡æŒ‚è½½æ—¶å†æ¬¡æ›´æ–°                                                                                                                                                                                                                                                                                                             |
| 3. æŒ‚è½½å‰è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ              | å¿…è¦                                                                                             | å¿…è¦                                                                                                                                                                                                                                                                                                                                                                   |
| 4. åŠ è½½ `css`                      | éå¿…è¦æ¯æ¬¡éƒ½åŠ è½½ï¼Œè§ï¼š`processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]              | æ‰€æœ‰çš„æ ·å¼èµ„æºæ”¶é›†åœ¨èµ„æºæ˜ å°„è¡¨ä¸­ `sourceCenter.link`ï¼Œè§ï¼š`micro-app` - æ³¨ â‘¥ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#microappstart-%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8)]ï¼Œä¸‹æ¬¡ç›´æ¥ä»æ˜ å°„è¡¨è·å–                                                                                                                                       |
| 5. æå–å…¥å£èµ„æº                    | éå¿…è¦æ¯æ¬¡éƒ½åŠ è½½ï¼Œè§ï¼š`importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]                                | åº”ç”¨å®ä¾‹åˆå§‹åŒ–æ—¶é€šè¿‡ `loadSourceCode` åŠ è½½èµ„æº [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#11-loadsourcecode-%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90)]ï¼Œå®Œæˆåé€šè¿‡ `onLoad` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#31-onload-%E5%8A%A0%E8%BD%BD%E5%AE%8C%E6%AF%95)] è®°å½•åœ¨ `this.source.html` ä¾¿äºä¸‹æ¬¡è·å– |
| 6. æ¿€æ´»åº”ç”¨ `active`               | å¿…è¦ï¼Œæ¯æ¬¡æ¿€æ´»åº”ç”¨å°±æ˜¯å¯¹åº”ç”¨å®¹å™¨èŠ‚ç‚¹åˆ‡æ¢çš„æ“ä½œï¼Œè§ï¼š`active` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]         | ä¸éœ€è¦æ¯æ¬¡æ‰‹åŠ¨æ¿€æ´»ï¼Œå®ä¾‹ `unmount` å¹¶ä¸ä¼šé”€æ¯å®ä¾‹å¯¹åº”çš„èµ„æº                                                                                                                                                                                                                                                                                                            |
| 7.1. `start` åº”ç”¨é˜Ÿåˆ—åŠ è½½ `script` | éå¿…è¦æ¯æ¬¡éƒ½åŠ è½½ï¼Œè§ï¼š`start` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜éœ€è¦æ¸…ç†ä¹‹å‰æ³¨å…¥çš„ `loading` | ä¸éœ€è¦æ¯æ¬¡æ‰‹åŠ¨å¯åŠ¨ï¼Œæ‰€æœ‰çš„ `script` èµ„æºæ”¶é›†åœ¨èµ„æºæ˜ å°„è¡¨ä¸­ `sourceCenter.script`ï¼Œè§ï¼š`micro-app` - æ³¨ â‘¥ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#microappstart-%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8)]ï¼Œä¸‹æ¬¡ç›´æ¥ä»æ˜ å°„è¡¨è·å–                                                                                                           |
| 7.2. `start` åº”ç”¨é˜Ÿè§¦å‘äº‹ä»¶        | å¿…è¦ï¼Œå¦‚ï¼š`mount` ç­‰ [[æŸ¥çœ‹](#-mount-æŒ‚è½½åº”ç”¨)]                                                  | å¿…è¦                                                                                                                                                                                                                                                                                                                                                                   |
| 8. æŒ‚è½½åè°ƒç”¨ç”Ÿå‘½å‘¨æœŸ              | å¿…è¦ï¼Œä½†å­˜åœ¨é‡å¤è°ƒç”¨çš„é—®é¢˜ï¼Œè§ï¼š6.é¢„åŠ è½½ä¸­çš„ `bug` [[æŸ¥çœ‹](#6é¢„åŠ è½½ä¸­çš„-bug)]                    | å¿…è¦                                                                                                                                                                                                                                                                                                                                                                   |

> å› æ­¤ï¼Œå¯¹äºé `alive` æ¨¡å¼æˆ– `umd` æ¨¡å¼çš„åº”ç”¨ï¼Œåœ¨ `wujie` åˆ‡æ¢æ—¶å®¹å™¨å¯èƒ½ä¼šæœ‰çŸ­æš‚çš„ç™½å±é—®é¢˜

#### `processTpl` æå–èµ„æº

ç›®å½•ï¼š`template.ts` - `processTpl` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/template.ts#L143)]

ç”¨äºä»åŠ è½½å†…å®¹ä¸­æå–å‡º `scripts` å’Œ `styles`ï¼Œç›¸å½“äºï¼š

- `micro-app` ä¸­çš„ `flatChildren`ï¼Œè§ï¼š`micro-app` æºç åˆ†æï¼Œæ³¨ â‘­ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate)]

ä»å…¥å‚å¼€å§‹ï¼Œæ¥å— 3 ä¸ªå‚æ•°ï¼š

- `tpl`ï¼šå­—ç¬¦ç±»å‹ï¼Œè¦æå–çš„æºå†…å®¹
- `baseURI`ï¼šå­—ç¬¦ç±»å‹ï¼Œèµ„æº `url`
- `postProcessTemplate`ï¼šå¯é€‰å‚æ•°ï¼Œä¼ å…¥ä¼šåœ¨æå–èµ„æºè¿”å›å‰è¿›è¡Œæœ€åå¤„ç†

è¿”å›ä¸€ä¸ª `TemplateResult` å¯¹è±¡ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/template.ts#L64)] åŒ…å« 4 ä¸ªå±æ€§ï¼š

- `template`ï¼šæ›¿æ¢ç‰¹å®šå†…å®¹åçš„èµ„æº
- `scripts`ï¼šæå–çš„è„šæœ¬
- `styles`ï¼šæå–çš„æ ·å¼
- `entry`ï¼šå…¥å£èµ„æº

å‡½æ•°å†…éƒ¨ä½œäº† 2 ä»¶äº‹ï¼š

- å£°æ˜å¯¹è±¡ç”¨äºæ”¶é›†æå–çš„èµ„æºï¼Œåˆ†åˆ«æ˜¯ï¼š`scripts`ã€`styles`ã€`entry`ã€`moduleSupport`ã€`template`
- æ‰§è¡Œæ›¿æ¢ï¼ŒæŒ‰ç…§ `replace` åˆ†åˆ«æ‰§è¡Œå¦‚ä¸‹

**1.æ›¿æ¢å¤‡æ³¨ï¼š**

å…¨éƒ¨æ›¿æ¢ä¸ºç©º

**2.æå–æˆ–æ›¿æ¢ `link` æ ‡ç­¾ï¼š**

æœ‰ 2 ä¸ªæƒ…å†µä¼šå°† `link` æ ‡ç­¾æ›¿æ¢ä¸ºå¤‡æ³¨ï¼š

1. `ref="stylesheet"` çš„å¤–è”æ ·å¼
2. `preload|prefetch|modulepreload` æ¨¡å¼ä¸‹ï¼Œå­˜åœ¨ `href` çš„ `font` ç±»å‹èµ„æº

> ä»¥ä¸Šæƒ…å†µéƒ½ä¸ç¬¦åˆï¼Œä¼šåŸå°ä¸åŠ¨å°†æ•°æ®è¿”å›ï¼Œå¯¹äº `link` æ ‡ç­¾ä¸åšæ›¿æ¢ï¼Œä¾‹å¦‚ï¼š`favicon`

æ›¿æ¢å¤‡æ³¨æœ‰ 2 ç§æ–¹å¼ï¼š

- `genIgnoreAssetReplaceSymbol`ï¼šå¸¦æœ‰ `ignore` å±æ€§çš„å¤–è”æ ·å¼
- `genLinkReplaceSymbol`ï¼šé»˜è®¤æ›¿æ¢çš„æ–¹å¼

`genLinkReplaceSymbol` åœ¨ 2 ä¸­æƒ…å†µæ³¨é‡Šçš„ä¸åŒå¤„ï¼š

- æ ·å¼ï¼šä¸æä¾›ç¬¬äºŒä¸ªå‚æ•°ï¼Œæ— æ— åŠ è½½
- å­—ä½“ï¼šæä¾›ç¬¬äºŒä¸ªå‚æ•°ï¼Œä½œä¸º `perfetch` æˆ– `preload`

> è®°ä½è¿™ä¸ªæ¨¡å¼åœ¨å¯åŠ¨åº”ç”¨å‰ `processCssLoader` æ ¹æ®æ³¨é‡Šæ›¿æ¢èµ„æº

**3.æå–æˆ–æ›¿æ¢ `style` å†…è”æ ·å¼ï¼š**

æ‰€æœ‰å†…è”æ ·å¼éƒ½ä¼šè¢«æ³¨é‡Šæ›¿æ¢ï¼Œæ›¿æ¢æ³¨é‡Šæœ‰ 2 ç§ï¼š

- `genIgnoreAssetReplaceSymbol`ï¼šå¸¦æœ‰ `ignore` å±æ€§çš„å†…è”æ ·å¼
- `getInlineStyleReplaceSymbol`ï¼šé»˜è®¤æ›¿æ¢æ–¹å¼

é»˜è®¤æ›¿æ¢æ–¹å¼åš 2 ä»¶äº‹ï¼š

- å°† `{ src: "", content: code }` æ·»åŠ åˆ° `styles`
- è®°å½•å½“å‰æ ·å¼åœ¨ `styles` ä¸­çš„ `index`ï¼Œåœ¨å¯åŠ¨åº”ç”¨å‰ `processCssLoader` æ ¹æ®æ³¨é‡Šæ›¿æ¢èµ„æº

**4.æå–æˆ–æ›¿æ¢ `script`ï¼š**

å…ˆè·å–ä»¥ä¸‹å¯¹è±¡ï¼š

- `scriptIgnore`ï¼šæå–å¸¦æœ‰ `ignore` å±æ€§çš„ `script`
- `isModuleScript`ï¼šåˆ¤æ–­æ˜¯å¦æ˜¯ `ES` æ¨¡å—çš„ `script`
- `isCrossOriginScript`ï¼šæå–è·¨åŸŸè¡Œä¸º `crossorigin` çš„ `script`
- `crossOriginType`ï¼šè·¨ç«¯çš„ç±»å‹çš„å€¼
  - è¿™é‡Œåªæå– `anonymous` ä¸å‘é€å‡­æ®å’Œ `use-credentials` å‘é€å‡­æ® 2 ä¸ªç±»å‹
  - `crossorigin` ä¸å­˜åœ¨é»˜è®¤ä¸ºç©ºå­—ç¬¦
- `moduleScriptIgnore`ï¼š`script` ä½œä¸ºè¢«å¿½ç•¥çš„ `ES` æ¨¡å—
  - å½“æµè§ˆå™¨æ”¯æŒ `ES` æ¨¡å—è€Œ `script` æ ‡ç­¾å¸¦æœ‰ `nomodule` å±æ€§
  - æˆ–æµè§ˆå™¨ä¸æ”¯æŒ `ES` æ¨¡å—å¹¶ä¸”å½“å‰ `script` æ˜¯ `module` ç±»å‹
- `matchedScriptTypeMatch`ï¼šæå– `script` çš„ `type`ï¼Œä¸å­˜åœ¨ä¸º `null`
- `matchedScriptType`ï¼š`script` çš„ `type` å€¼ï¼Œä¸å­˜åœ¨ä¸º `undefined`

åˆ† 3 ä¸ªæƒ…å†µï¼š

- ä¸æ˜¯æœ‰æ•ˆçš„å¯æ‰§è¡Œ `script`ï¼Œç›´æ¥è¿”å›ä¸å¤„ç†
- æœ‰æ•ˆçš„å¤–éƒ¨é“¾æ¥ï¼šä¸åŒ…å« `type="text/ng-template"` ä¸”æœ‰ `src` çš„å¤–éƒ¨ `script`
- å…¶ä»–æƒ…å†µï¼Œå¦‚ï¼šå†…è” `script`ã€`ng-template`

ç”¨æ³¨é‡Šæ›¿æ¢ `script` æœ‰ 2 ç§ï¼š

- `scriptIgnore`ã€`moduleScriptIgnore`

**4.1 æœ‰æ•ˆçš„å¤–éƒ¨é“¾æ¥ï¼Œå…ˆæå– 3 ä¸ªå¯¹è±¡ï¼š**

- `matchedScriptEntry`ï¼šæå–çš„ `script` æ˜¯å¸¦æœ‰ `entry` çš„ä¸»å…¥å£
- `matchedScriptSrcMatch`ï¼šæå–çš„ `script` æ˜¯å¸¦æœ‰ `src` å±æ€§
- `matchedScriptSrc`ï¼š`script` çš„ `src` é“¾æ¥æˆ– `undefined`

ä»¥ä¸‹æƒ…å†µä¼š `throw`ï¼š

- å¤šå…¥å£ï¼š`entry` å’Œ `matchedScriptEntry` åŒæ—¶å­˜åœ¨

ä»¥ä¸‹æƒ…å†µä¼šè®¾ç½®å…¥å£ `entry`

- `entry` ä¸º `null`ï¼Œ`matchedScriptEntry` å­˜åœ¨ï¼Œè®¾ç½®ä¸º `matchedScriptSrc`
- åœ¨è®¾ç½®ä¹‹å‰ä¼šæ£€æŸ¥å¹¶æ›´æ–° `matchedScriptSrc` ä¸ºæœ‰æ•ˆçš„ `url`

> å¦‚æœ `src` æä¾›çš„æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¼šæ ¹æ®èµ„æºè·¯ç”± `baseURI` è·å–ç›¸å¯¹ `url`

`matchedScriptSrc`ï¼šå¯¹äºå·²æå–å‡º `src` çš„æƒ…å†µä¼šæå–å‡ºä¸€ä¸ªå¯¹è±¡æ’å…¥ `scripts`

```
{
    src: matchedScriptSrc,
    module: isModuleScript,
    crossorigin: !!isCrossOriginScript,
    crossoriginType: crossOriginType,
    attrs: parseTagAttributes(match),
}
```

> ä»¥ä¸Šå±æ€§ä¸Šè¿°å·²è¯´æ˜ï¼Œ `parseTagAttributes` ä¼šæå– `<script(.*)>` æ ‡ç­¾ä¸­æ‰€æœ‰å¸¦æœ‰ `=` çš„å±æ€§ï¼Œå°†å…¶ä½œä¸º `key`ã€`value` çš„é”®å€¼å¯¹è±¡è¿”å›

é™¤æ­¤ä¹‹å¤–è¿˜ä¼šæå– `script` ä¸­çš„ `async` å’Œ `defer` å±æ€§ï¼Œåªæœ‰æœ‰ä¸€ä¸ªå±æ€§å­˜åœ¨ï¼Œä¼šåœ¨æ’å…¥å¯¹è±¡ä¸­æ·»åŠ å¦‚ä¸‹å±æ€§

```
{
    async: isAsyncScript,
    defer: isDeferScript,
}
```

å…¶ä»–æƒ…å†µå¸¦æœ‰å¤–é“¾çš„ `script` å°†ç›´æ¥è¿”å›ä¸åšä»»ä½•å¤„ç†

**4.2 å†…è” `script`ï¼š**

æ— è®ºå“ªç§æƒ…å†µå†…è” `script` éƒ½ä¼šè¢«æ³¨é‡Šä»£æ›¿ï¼Œå½“å†…è” `script` ä¸å­˜åœ¨ `scriptIgnore`ï¼Œä¹Ÿä¸å­˜åœ¨ `moduleScriptIgnore` æ—¶ï¼š

- é€šè¿‡ `getInlineCode` æå– `script` ä¸­çš„è„šæœ¬å†…å®¹
- éå†æ¯ä¸€è¡ŒæŸ¥çœ‹æ˜¯å¦ä¸ºç©ºæˆ–å·²å•è¡Œæ³¨é‡Šå¾—åˆ° `isPureCommentBlock`
- å¦‚æœæ˜¯æœ‰æ•ˆçš„å†…è” `script` å’Œä¸Šé¢å¤–é“¾ `script` ä¸€æ ·æ·»åŠ åˆ° `scripts`

> è¿™é‡Œ `wujie` å¥½åƒæ²¡æœ‰è€ƒè™‘å¤šè¡Œæ³¨é‡Š

æ’å…¥ `scripts` çš„ `item` å’Œå¤–é“¾ä¸åŒç‚¹

```
{
    src: "",
    content: code,
}
```

#### `processCssLoader`ï¼šå¤„ç† `css-loader`

ç›®å½•ï¼š`entry.ts` - `processCssLoader` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L56)]

è§¦å‘åœºæ™¯æœ‰ 3 ä¸ªï¼š

- `preloadApp`ï¼šé¢„åŠ è½½åº”ç”¨
- `startApp`ï¼šåˆæ¬¡åŠ è½½åº”ç”¨ï¼ˆä¸åŒ…å«é¢„åŠ è½½å `alive` æ¨¡å¼çš„åº”ç”¨ï¼‰
- `startApp`ï¼šæ¯æ¬¡åˆ‡æ¢é `alive` æ¨¡å¼æˆ– `umd` æ¨¡å¼çš„åº”ç”¨

å‚æ•°ï¼š

- `sandbox`ï¼šåº”ç”¨å®ä¾‹
- `template`ï¼šå·²å®Œæˆæ›¿æ¢çš„å…¥å£èµ„æºï¼Œè§ï¼š`processTpl` æå–èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- `getExternalStyleSheets`ï¼šæå– `css` èµ„æºçš„å‡½æ•°ï¼Œè¿”å› `css` é›†åˆï¼Œè§ï¼š`importHTML` åŠ è½½èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

è·å–å¹¶æ›´æ–°æ ·å¼é›†åˆï¼š

- é€šè¿‡ `getCurUrl` è·å– `base url`
- é€šè¿‡ `compose` æŸ¯é‡ŒåŒ–è·å–æ’ä»¶ `cssLoader`ï¼Œè§ï¼š`insertScriptToIframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)] - `compose`
- éå† `getExternalStyleSheets()`ï¼Œè§ï¼š`importHTML` åŠ è½½èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)] - `getExternalStyleSheets`
- ç›®çš„æ˜¯ç”¨ `cssLoader` æ›¿æ¢æ¯ä¸€é¡¹ `css` çš„ `contentPromise`ï¼Œè§æ–‡æ¡£ï¼š`css-loader` [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-loader)]

æ›¿æ¢èµ„æºä¸­çš„æ ·å¼ï¼š

- é€šè¿‡ `getEmbedHTML` å°†ä¹‹å‰æ³¨é‡Šçš„æ ·å¼æ›¿æ¢æˆå†…è”æ ·å¼ [[æŸ¥çœ‹](#getembedhtmlè½¬æ¢æ ·å¼)]
- å¦‚æœæœ‰æä¾›çš„è¯é€šè¿‡ `replace` æ›´æ–°èµ„æº [[æŸ¥çœ‹](#1-æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯)]
- æœ€åå°†æ›´æ–°çš„èµ„æºè¿”å›

`processCssLoader` å­˜åœ¨çš„é‡å¤æ‰§è¡Œçš„é—®é¢˜ï¼Œè§ï¼š`importHTML` - 5. å­˜åœ¨çš„ 2 ä¸ªé—®é¢˜ [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

#### `getEmbedHTML`ï¼šè½¬æ¢æ ·å¼

ç›®å½•ï¼š`entry.ts` - `getEmbedHTML` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L77)]

æ— è®ºå¤–è”çš„ `link` è¿˜æ˜¯å†…è”çš„ `style`ï¼Œç»Ÿä¸€è½¬æ¢æˆå†…è”æ ·å¼ï¼Œç”¨æ¥æå‡æ•ˆç‡ï¼Œè¿˜è®°å¾—åœ¨ `processTpl` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)] ä¸­æ ·å¼æ›¿æ¢æˆç‰¹å®šçš„å¤‡æ³¨å—ï¼Œåœ¨è¿™é‡Œå°†æ›¿æ¢å›æ¥ã€‚

å‚æ•°ï¼š

- `template`ï¼šå­åº”ç”¨çš„èµ„æºï¼Œè™½ç„¶æ˜¯ `any` ä½†å®ƒåªèƒ½æ˜¯ `string`ï¼Œå› ä¸º `processCssLoader` ä¼ è¿‡æ¥å°±æ˜¯ `string`
- `styleResultList`ï¼šé€šè¿‡ `getExternalStyleSheets` æå–å‡ºæ¥çš„ `styles` é›†åˆï¼Œè§ï¼š`importHTML` åŠ è½½èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)] - 4.2. `getExternalStyleSheets`

è¿”å›ï¼š

- å°†æ›¿æ¢åçš„èµ„æºé€šè¿‡ `promise` çš„æ–¹å¼è¿”å›

æµç¨‹ï¼Œå…³è”å‚è€ƒï¼š`processTpl` æå–èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]ï¼š

- é€šè¿‡ `Promise.all` è¿­ä»£ `style` é›†åˆä¸­æ¯ä¸€é¡¹çš„ `contentPromise`
- å¦‚æœæ˜¯å¸¦æœ‰ `src` çš„å¤–è” `style` æ›¿æ¢ `genLinkReplaceSymbol` æ³¨é‡Šçš„æ ·å¼
- å¦‚æœæ˜¯å¸¦æœ‰ `content` çš„å†…è” `style` æ›¿æ¢ `getInlineStyleReplaceSymbol` æ³¨é‡Šçš„æ ·å¼

> ä»è¿™é‡ŒçŸ¥é“æ¯ä¸€ä¸ª `style` å·²é€šè¿‡å¾®ä»»åŠ¡ç¡®ä¿æ›¿æ¢å‰å·²å®ŒæˆåŠ è½½

æ›¿æ¢æ ·å¼çš„ `bug`ï¼Œ`ignore` æ— æ•ˆï¼Œè§ï¼š[[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)] - 4.2. `getExternalStyleSheets`

- é¦–å…ˆåœ¨æå–æ ·å¼æ—¶ä¸ä¼šè®°å½• `ignore`ï¼Œæ‰€ä»¥åœ¨æ›¿æ¢æ—¶å€™å– `ignore` æ˜¯ä¸€ä¸ªæ— æ•ˆå€¼
- å…¶æ¬¡å¯¹äºåŒ…å« `ignore` çš„å¤–è” `style`ï¼Œæ³¨é‡Šé€šè¿‡ `genIgnoreAssetReplaceSymbol` æ›¿æ¢ï¼Œè€Œä¸æ˜¯ `genLinkReplaceSymbol`
- æ°å·§ä¸¤ä¸ªé”™è¯¯èµ·åˆ°äº†â€œè´Ÿè´Ÿå¾—æ­£â€çš„æ•ˆæœï¼Œæ°¸è¿œä¸ä¼šå› ä¸ºæ‰¾åˆ°é”™è¯¯çš„æ³¨é‡Šæ›¿æ¢æˆäº†é”™è¯¯çš„æ ·å¼é“¾æ¥
- æœ€åå¯¹äºå†…è” `style`ï¼Œåœ¨æ›¿æ¢æ—¶å°±æ²¡æœ‰è€ƒè™‘ `ignore`ï¼Œå³ä¾¿ `ignore` å­˜åœ¨ï¼Œä¹Ÿä¼šåœ¨ `getExternalStyleSheets` æ—¶å€™ä½œä¸ºç©ºå€¼

### è¾…åŠ©æ–¹æ³• - å®¹å™¨æ¸²æŸ“

å›´ç»•åº”ç”¨çš„æ¸²æŸ“å®¹å™¨å½’çº³ç›¸å…³çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼š`shadowRoot` å®¹å™¨ã€`iframe` å®¹å™¨

#### `renderElementToContainer`ï¼šå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨

ç›®å½•ï¼š`shadow.ts` - `renderElementToContainer` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L70)]

å‚æ•°ï¼š

- `element`ï¼šæŒ‚è½½çš„èŠ‚ç‚¹ï¼Œç±»å‹ï¼š`Element | ChildNode`
- `selectorOrElement`ï¼šå®¹å™¨ï¼Œç±»å‹ï¼š`string | HTMLElement`

æµç¨‹ï¼š

- é€šè¿‡ `getContainer` å®šä½åˆ°å®¹å™¨ `container`
- å¦‚æœ `container` å­˜åœ¨ï¼Œä¸”ä¸åŒ…å«æä¾›çš„èŠ‚ç‚¹å…ƒç´ ï¼Œå°†å…¶æ·»åŠ åˆ°å®¹å™¨
- è¿”å›å®šä½çš„å®¹å™¨ `container`

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

- ä¸å­˜åœ¨ `LOADING_DATA_FLAG` èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼ŒæŒ‚è½½åˆ°å®¹å™¨å‰éœ€è¦å…ˆ `clearChild` æ¸…ç©ºå®¹å™¨

ä»€ä¹ˆæ—¶å€™ä¼šæä¾› `LOADING_DATA_FLAG`ï¼š

- `addLoading` æ—¶è®¾ç½®ä¸€ä¸ª `div` ç”¨äºæŒ‚è½½ `loading` å…ƒç´ 
- è€Œä½¿ç”¨ `addLoading` åªæœ‰ `startApp` åˆå§‹åŒ–åº”ç”¨å‰æ‰§è¡Œ

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼š
>
> - `startApp` æ—¶å¯ä»¥é€šè¿‡é…ç½® `loading` æ¥å®šä¹‰åŠ è½½å…ƒç´ ï¼Œè§ï¼šæ–‡æ¡£[[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#loading)]
> - ä¸æä¾› `loading` ä¹Ÿä¼šæ‰§è¡Œ `addLoading` æ·»åŠ ä¸€ä¸ªç©ºçš„ `loading` åˆ°å®¹å™¨

ä¸ºä»€ä¹ˆ `addLoading` åå°±ä¸éœ€è¦æ¸…ç©ºå®¹å™¨ï¼š

- å› ä¸º `addLoading` å¼€å¤´ä¸¤è¡Œå’Œ `renderElementToContainer` ä¸€æ ·ï¼Œç°å®šä½å®¹å™¨å†æ¸…ç©ºå®¹å™¨
- æ¸…ç©ºå®¹å™¨ä¹‹åå†æ·»åŠ æ ·å¼ã€æŒ‚è½½ `loading`

å¦‚æœæ‰§è¡Œ `addLoading` åï¼Œ`loading` åœ¨å“ªæ¸…é™¤ï¼š

- `start` å¯åŠ¨åº”ç”¨æ—¶ï¼Œé˜Ÿåˆ—ä¹‹å‰ä¼š `removeLoading`ï¼Œè§ï¼š5. é˜Ÿåˆ—å‰çš„å‡†å¤‡ [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]
- `mount` æŒ‚è½½ `umd` æ¨¡å¼åº”ç”¨æ—¶ï¼Œè¿™é‡Œå¯èƒ½ä¼šé‡å¤æ¸…é™¤

æ€»ç»“ï¼š

- åªè¦ä¸æ˜¯é€šè¿‡ `startApp` åˆå§‹åŒ–æ·»åŠ  `loading` å…ƒç´ ï¼Œæ¯æ¬¡æ‰§è¡Œ `renderElementToContainer` éƒ½ä¼šæ¸…ç©ºå®¹å™¨

#### `renderTemplateToIframe` æ¸²æŸ“èµ„æºåˆ° `iframe`

ç›®å½•ï¼š`shadow.ts` - `renderTemplateToIframe` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L252)]

å‚æ•°ï¼š

- `renderDocument`ï¼šé™çº§ `iframe` å®¹å™¨çš„ `document`
- `iframeWindow`ï¼šæ²™ç®±çš„ `iframeWindow`
- `template`ï¼šé€šè¿‡ `importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)] æå–ï¼Œå¹¶ç”± `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)] å¤„ç†è¿‡çš„åº”ç”¨èµ„æº

ä¸»åŠ¨é™çº§æ—¶å°†èµ„æºæ¸²æŸ“åˆ° `iframe`ï¼Œè°ƒç”¨åœºæ™¯ï¼š

- åº”ç”¨åˆæ¬¡æ¿€æ´» `active`
- é `active` æ¨¡å¼åˆ‡æ¢åº”ç”¨

æµç¨‹ï¼š

- é€šè¿‡ `renderTemplateToHtml` å°† `template` æ¸²æŸ“ä¸º `html` å…ƒç´  [[æŸ¥çœ‹](#rendertemplatetohtmlæ¸²æŸ“-template-ä¸º-html-å…ƒç´ )]
- é€šè¿‡ `processCssLoaderForTemplate` æ‰‹åŠ¨æ·»åŠ æ ·å¼ [[æŸ¥çœ‹](#rendertemplatetohtmlæ¸²æŸ“-template-ä¸º-html-å…ƒç´ )]
- å°†æ›´æ–°åçš„ `html` æ›¿æ¢å®¹å™¨ `iframe` çš„ `html`
- é€šè¿‡ `Object.defineProperty` åŠ«æŒå®¹å™¨ `html` å…ƒç´ çš„ `parentNode`ï¼ŒæŒ‡å‘æ²™ç®± `iframeWindow.document`
- é€šè¿‡ `patchRenderEffect` ç»™å®¹å™¨æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

æ³¨æ„å‘å®¹å™¨æ·»åŠ å…ƒç´ ï¼Œä¼šåŒæ—¶åœ¨æ²™ç®± `iframe` ä¸­ä¹Ÿæ·»åŠ ä¸€ä»½ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚è§ï¼šåŒæ—¶æ·»åŠ å…ƒç´  [[æŸ¥çœ‹](#åŒæ—¶æ·»åŠ å…ƒç´ )]

```
renderDocument.replaceChild(processedHtml, renderDocument.documentElement);
```

#### `renderTemplateToShadowRoot` æ¸²æŸ“èµ„æºåˆ° `shadowRoot`

ç›®å½•ï¼š`shadow.ts` - `renderTemplateToShadowRoot` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L212)]

å‚æ•°ï¼š

- `shadowRoot`ï¼šæ³¨å…¥çš„å®¹å™¨
- `iframeWindow`ï¼šæ²™ç®±çš„ `iframeWindow`
- `template`ï¼šé€šè¿‡ `importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)] æå–ï¼Œå¹¶ç”± `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)] å¤„ç†è¿‡çš„åº”ç”¨èµ„æº

è°ƒç”¨åœºæ™¯ï¼š

- åªè¦ä¸æ˜¯ `degrade` ä¸»åŠ¨é™çº§ï¼Œä¹Ÿä¸æ˜¯ `alive` æ¨¡å¼åˆ‡æ¢åº”ç”¨
- å…¶ä»–æ‰€æœ‰æ¨¡å¼æ¿€æ´»åº”ç”¨éƒ½ä¼šé€šè¿‡ `renderTemplateToShadowRoot` æ¸²æŸ“ `shadowRoot`

æµç¨‹å’Œ `renderTemplateToIframe` ä¸€æ · [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe)]ï¼Œä¸åŒåœ¨äºï¼š

| åˆ†ç±»           | `renderTemplateToIframe` | `renderTemplateToShadowRoot`   |
| -------------- | ------------------------ | ------------------------------ |
| å®¹å™¨           | `iframe.document`        | `shadowRoot`                   |
| æŒ‡å‘å®ä¾‹å±æ€§   | `this.document`          | `this.shadowRoot`              |
| å®¹å™¨ `head`    | `this.document.head`     | `this.shadowRoot.head`         |
| å®¹å™¨ `body`    | `this.document.body`     | `this.shadowRoot.body`         |
| é®ç½©å±‚ `shade` | ä¸æ”¯æŒ                   | ä½œä¸ºåœ¨å®¹å™¨ `html` ç¬¬ä¸€ä¸ªå­å…ƒç´  |

> å› æ­¤ `patchRenderEffect` æ‰“è¡¥ä¸çš„å®¹å™¨å¯¹è±¡ä¹Ÿä¸ä¸€æ · [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

æ³¨æ„å‘å®¹å™¨æ·»åŠ å…ƒç´ ï¼Œä¼šåŒæ—¶åœ¨æ²™ç®± `iframe` ä¸­ä¹Ÿæ·»åŠ ä¸€ä»½ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚è§ï¼šåŒæ—¶æ·»åŠ å…ƒç´  [[æŸ¥çœ‹](#åŒæ—¶æ·»åŠ å…ƒç´ )]

```
shadowRoot.appendChild(processedHtml);
```

å…³äº `head`ã€`body`ï¼š

- å®¹å™¨çš„ `head`ã€`body` ä¸»è¦ç”¨äºå®¹å™¨äº‹ä»¶ã€å…ƒç´ æ“ä½œçš„ä»£ç†å’ŒåŠ«æŒ
- é™¤æ­¤ä¹‹å¤–æ— è®ºæ˜¯ `iframe` è¿˜æ˜¯ `shadowRoot`ï¼Œéƒ½æœ‰ä¸€ä¸ªå®ä¾‹çš„ `head`ã€`body`ï¼Œç”¨äºæ¸²æŸ“å­åº”ç”¨çš„ `template`ï¼Œè§ï¼š`renderTemplateToHtml` [[æŸ¥çœ‹](#rendertemplatetohtmlæ¸²æŸ“-template-ä¸º-html-å…ƒç´ )]

é®ç½©å±‚ `shade`ï¼š

- åœ¨å®¹å™¨ä¸­çœ‹ä¸è§ï¼Œç”¨é€”æ˜¯ä¸ºäº†æ’‘å¼€å®¹å™¨ä¸­çš„å¼¹çª—å’Œæµ®å±‚
- ç”±äºåœ¨ `iframe` å®¹å™¨ä¸­æ— æ³•æ’‘å¼€å®¹å™¨åŒºåŸŸï¼Œæ‰€ä»¥ä»…é™ `shadowRoot`

#### `renderTemplateToHtml`ï¼šæ¸²æŸ“ `template` ä¸º `html` å…ƒç´ 

ç›®å½•ï¼š`shadow.ts` - `renderTemplateToHtml` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L176)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `iframeWindow`
- `template`ï¼šé€šè¿‡ `importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)] æå–ï¼Œå¹¶ç”± `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)] å¤„ç†è¿‡çš„åº”ç”¨èµ„æº

è¿”å›ï¼š

- æ•´ä¸ªæ¸²æŸ“å®Œæˆå¹¶æ›´æ–°èµ„æºçš„ `html` å…ƒç´ 

åšäº† 3 ä»¶äº‹ï¼š

- é€šè¿‡æ²™ç®± `iframe` ä¸‹çš„ `document` åˆ›å»ºä¸€ä¸ª `html` å…ƒç´ ï¼Œå¹¶å°† `template` ä½œä¸º `innerHTML`
- éå† `html` ä¸‹æ‰€æœ‰å¯è§å…ƒç´ ï¼Œé€šè¿‡ `patchElementEffect` ä¸ºæ¯ä¸ªå…ƒç´ æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]
- è·å–æ‰€æœ‰ `a`ã€`img`ã€`source` å…ƒç´ ï¼Œä¿®æ­£èµ„æºç›¸å¯¹è·¯å¾„

ä¼˜åŒ– `umd` æ¨¡å¼åŠ è½½çš„åº”ç”¨ï¼š

- ç»„ä»¶å¤šæ¬¡æ¸²æŸ“ï¼Œ`head` å’Œ `body` å¿…é¡»ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªæ¥åº”å¯¹è¢«ç¼“å­˜çš„åœºæ™¯
- æ‰€ä»¥å¯åŠ¨ä¹‹å‰å°† `head` å’Œ `body` æŒ‡å‘åº”ç”¨å®ä¾‹ï¼Œä»¥ä¾¿ä¸‹æ¬¡é€šè¿‡ `replaceHeadAndBody` ç›´æ¥æ›¿æ¢

åœ¨æœ«å°¾å¯èƒ½æ˜¯æ‹…å¿ƒä¸å­˜åœ¨ `head` æˆ– `body` çš„æƒ…å†µè¿›è¡Œäº†è¡¥å…¨ï¼š

- ä½†ç›®å‰æ¥çœ‹ä¼¼ä¹åšäº†å¤šä½™çš„å·¥ä½œ
- å› ä¸ºå½“ä¸ºä¸€ä¸ª `html` å…ƒç´ è®¾ç½® `innerHTML` æ—¶å€™ï¼Œä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨è¡¥å…¨
- æ‰€ä»¥å®Œå…¨ä¸ç”¨æ‹…å¿ƒ `head` æˆ– `body` ç¼ºå¤±é€ æˆä¸‹æ¬¡åˆ‡æ¢åº”ç”¨æå–å®ä¾‹æ—¶æ‹¿ä¸åˆ°å¯¹è±¡

ä¿®æ­£ç›¸å¯¹è·¯å¾„çš„ç»†èŠ‚ï¼š

- é€šè¿‡ `patchElementEffect` ä¸ºéå†ä¸­æ¯ä¸€ä¸ªå¯è§å…ƒç´ æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]
- é€šè¿‡ `relativeElementTagAttrMap` æ‹¿åˆ°èµ„æºé“¾æ¥ `url`

åªæœ‰å½“èµ„æºçš„ `url` å­˜åœ¨æ—¶æ‰è¿›è¡Œå¤„ç†ï¼Œæœ‰ 2 ç§æƒ…å†µï¼š

- ç»å¯¹è·¯å¾„ï¼š`new URL(ç»å¯¹è·¯å¾„ï¼ŒbaseUrl).href`ï¼ŒåŸå°ä¸åŠ¨è¿”å›ç»å¯¹è·¯å¾„
- ç›¸å¯¹è·¯å¾„ï¼š`new URL(ç›¸å¯¹è·¯å¾„, baseUrl).href`ï¼Œè¿”å›ï¼š`baseUrl/ç›¸å¯¹è·¯å¾„`

ä¸ºä»€ä¹ˆè¦é€šè¿‡æ²™ç®±åˆ›å»º `html` å…ƒç´ ï¼Œè€Œä¸æ˜¯ç›´æ¥æ³¨å…¥ `template` åˆ°å®¹å™¨

- éœ€è¦é€šè¿‡ `iframeWindow` è·å– `sandbox` å®ä¾‹ï¼Œå°† `html` å…ƒç´ çš„ `head` å’Œ `body` åˆ†åˆ«æŒ‡å‘å®ä¾‹
- æ¸²æŸ“å®¹å™¨çš„ `document` æŒ‡å‘æ²™ç®± `iframe`

#### `processCssLoaderForTemplate`ï¼šæ‰‹åŠ¨æ·»åŠ æ ·å¼

ç›®å½•ï¼š`shadow.ts` - `processCssLoaderForTemplate` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L109)]

å‚æ•°ï¼š

- `sandbox`ï¼šåº”ç”¨å®ä¾‹
- `html`ï¼šç”± `renderTemplateToHtml` [[æŸ¥çœ‹](#rendertemplatetohtmlæ¸²æŸ“-template-ä¸º-html-å…ƒç´ )] æ¸²æŸ“çš„ `html` å…ƒç´ 

è¿”å›ï¼š

- å°†æ›´æ–°åçš„ `html` ä½œä¸º `promise` ä¼ å›å»ï¼Œæ— è®ºæ˜¯ `resolve` æˆåŠŸï¼Œè¿˜æ˜¯ `reject` æ‹’ç»

å…ˆæå–äº† 3 ä¸ª `plugin`ï¼š

- `cssLoader`ï¼šç”¨äºæ¯æ¡æ ·å¼åŠ è½½æˆåŠŸåè‡ªå®šä¹‰å¤„ç†ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-loader)]
- `cssBeforeLoaders`ï¼šç”¨äºæ’å…¥åº”ç”¨ `html` å¤´éƒ¨çš„æ ·å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-before-loaders)]
- `cssAfterLoaders`ï¼šç”¨äºæ’å…¥åº”ç”¨ `html` æœ«å°¾çš„æ ·å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-after-loaders)]

> å…¶ä¸­ `cssLoader` é€šè¿‡ `getCssLoader` æŸ¯é‡ŒåŒ–ï¼Œæ–¹å¼å’Œ `getJsLoader` ä¸€è‡´ï¼Œè§ï¼š`insertScriptToIframe` - ç¬¬ä¸€æ­¥ [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

æå–æ ·å¼çš„æ­¥éª¤å’Œ `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)] æå–åº”ç”¨å†…éƒ¨æ ·å¼ä¸€æ ·ï¼š

- é€šè¿‡ `getExternalStyleSheets` ä¸ºæ¯ä¸ªæ ·å¼æ·»åŠ ä¸€ä¸ª `promise` å¯¹è±¡ `contentPromise`
- é€šè¿‡ `contentPromise` å°†æ‰€æœ‰æ ·å¼éƒ½å˜æˆå†…è”æ ·å¼
- å°†æ‹¿åˆ°çš„å†…è”æ ·å¼åˆ›å»º `style` å…ƒç´ ï¼Œæ ¹æ®é…ç½®æ’å…¥åº”ç”¨ `html` çš„å¤´éƒ¨æˆ–å°¾éƒ¨

#### è®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶

ç›®å½•ï¼š`shadow.ts` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts)]

ä»…ç”¨äº `degrade` ä¸»åŠ¨é™çº§ï¼š

- `recordEventListeners`ï¼šè®°å½•å®¹å™¨ä¸­æ‰€æœ‰äº‹ä»¶
- `recoverEventListeners`ï¼šæ¢å¤å®¹å™¨ä¸­æ‰€æœ‰å…ƒç´ äº‹ä»¶
- `recoverDocumentListeners`ï¼šæ¢å¤å®¹å™¨ `document` äº‹ä»¶

**1. è®°å½•äº‹ä»¶ï¼š**

- é‡å†™å­åº”ç”¨ `addEventListener` å’Œ `removeEventListener`
- æ ¹æ®æ“ä½œä»å®ä¾‹ `elementEventCacheMap` æ˜ å°„è¡¨ä¸­æ·»åŠ æˆ–åˆ é™¤è®°å½•ï¼Œè§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- ç„¶åå†ç›‘å¬å­åº”ç”¨ç›¸å…³äº‹ä»¶

**2. æ¢å¤å®¹å™¨å…ƒç´ äº‹ä»¶ï¼š**

- ä»…ç”¨äº `degrade` é™çº§å¤„ç†åˆ‡æ¢ `alive` æ¨¡å¼çš„åº”ç”¨
- é€šè¿‡ `createTreeWalker` æ‹¿åˆ°åº”ç”¨ä¸‹æ‰€æœ‰çš„å¯è§å…ƒç´ 
- éå†å…ƒç´ ï¼Œé€šè¿‡ `elementEventCacheMap` è·å–äº‹ä»¶ç›‘å¬å¯¹è±¡ï¼Œå°†æ‹¿åˆ°çš„äº‹ä»¶å¯¹è±¡è®°å½•åˆ°ä¸€ä¸ªæ–°çš„ `WeakMap`
- æ›´æ–°å®ä¾‹ `elementEventCacheMap`

**3. æ¢å¤å®¹å™¨ `document` äº‹ä»¶ï¼š**

- ä»…ç”¨äº `degrade` é™çº§å¤„ç†åˆ‡æ¢é `alive` æ¨¡å¼çš„åº”ç”¨
- å’Œæ¢å¤å®¹å™¨å…ƒç´ äº‹ä»¶ä¸€æ ·çš„æ­¥éª¤ï¼Œä¸åŒçš„æ˜¯ä»…è·å–ã€æ¢å¤å®¹å™¨ `document` çš„ç›‘å¬äº‹ä»¶

### è¾…åŠ©æ–¹æ³• - æ‰“è¡¥ä¸

å›´ç»• `patch*` æ‰“è¡¥ä¸å½’çº³æ–¹æ³•

#### `patchRenderEffect` ä¸ºå®¹å™¨æ‰“è¡¥ä¸

ç›®å½•ï¼š`effect.ts` - `patchRenderEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L427)]

å‚æ•°ï¼š

- `render`ï¼šå®¹å™¨çš„ `shadowRoot` æˆ– `document`
- `id`ï¼šåº”ç”¨åç§°
- `degrade`ï¼šæ˜¯å¦ä¸»åŠ¨é™çº§

åšçš„äº‹æƒ…ï¼ˆéƒ¨åˆ†ï¼‰ï¼š

- ç”¨äºå­åº”ç”¨ä¸­åŠ¨æ€æ“ä½œ `Dom`ï¼Œæ¯”å¦‚ï¼š`appendChild` å’Œ `insertBefore`
- åœ¨å­åº”ç”¨åŠ¨æ€æ·»åŠ  `script` æ—¶ï¼Œä¼šé€šè¿‡ `insertScriptToIframe` æ·»åŠ åˆ°æ²™ç®±çš„ `iframe` ä¸­
- åœ¨å­åº”ç”¨åŠ¨æ€æ·»åŠ å†…è”æˆ–å¤–è”æ ·å¼åŒæ—¶ï¼Œä¼šé€šè¿‡ `styleSheetElements.push` æ”¶é›†æ·»åŠ çš„æ ·å¼ï¼Œä»¥ä¾¿ `umd` åˆ‡æ¢åº”ç”¨æ—¶é€šè¿‡ `rebuildStyleSheets` æ¢å¤æ ·å¼
- éä¸»åŠ¨é™çº§æƒ…å†µä¸‹ï¼Œè®°å½•å­åº”ç”¨ `head` å’Œ `body` æ‰€æœ‰ç›‘å¬çš„äº‹ä»¶ï¼Œé›†åˆåœ¨ `_cacheListeners`

> ä¸»åŠ¨é™çº§ä¸éœ€è¦è®°å½•ï¼šé™çº§åœºæ™¯ `dom` æ¸²æŸ“åœ¨ `iframe` ä¸­ï¼Œ`iframe` ç§»åŠ¨åäº‹ä»¶è‡ªåŠ¨é”€æ¯ï¼Œä¸éœ€è¦è®°å½•
>
> å…³äº `_cacheListeners` çš„ç”¨é€”å°±æœ‰ç‚¹ä¸æ˜æ‰€ä»¥äº†ï¼š
>
> - å¯ä»¥åœ¨å­åº”ç”¨ä¸­é€šè¿‡ `[body|head]._cacheListeners` è·å–æ‰€æœ‰ç›‘å¬çš„å®ä¾‹ï¼Œä½†æ˜¯éœ€è¦è·å–å—ï¼Ÿ
> - å¯ä»¥åœ¨å¸è½½åº”ç”¨æ—¶é€šè¿‡ `removeEventListener` æ¸…ç©ºæ‰€æœ‰è®°å½•ï¼Œæ„ä¹‰æ˜¯ï¼Ÿ

#### `patchElementEffect`ï¼šä¸ºå…ƒç´ æ‰“è¡¥ä¸

ç›®å½•ï¼š`iframe.ts` - `patchElementEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L668)]

å‚æ•°ï¼š

- `element`ï¼š`html` èŠ‚ç‚¹å…ƒç´ ã€`ShadowRoot`
- `iframeWindow`ï¼šæ²™ç®±çš„ `iframeWindow`

**å†…éƒ¨è¡¥ä¸ 1ï¼š`baseURI`**

- é€šè¿‡ `proxyLocation` å®šä½åˆ°å½“å‰åº”ç”¨çš„ `protocol` + `host` + `pathname`

ç”¨é€”ï¼š

- é€šè¿‡è·å–å…ƒç´ çš„ `baseURI` å»çº æ­£å­åº”ç”¨ä¸­å¸¦æœ‰ç›¸å¯¹è·¯å¾„çš„èµ„æºï¼Œæ¯”å¦‚ï¼š`a`ã€`img` ç­‰
- ä½¿å…¶è·¯å¾„ç›¸å¯¹äºå­åº”ç”¨ï¼Œè€Œä¸æ˜¯åŸºåº§

**å†…éƒ¨è¡¥ä¸ 2ï¼š`ownerDocument`**

- æŒ‡å‘å½“å‰æ²™ç®± `iframeWindow.document`

ç”¨é€”ï¼š

- çº æ­£å­åº”ç”¨ä¸­åŠ¨æ€åˆ›å»º `style` æ—¶ `document` å¯¹è±¡
- çº æ­£å­åº”ç”¨ä¸­åŠ¨æ€åˆ›å»º `iframe` æ—¶ `querySelector` ä¸Šä¸‹æ–‡æŒ‡å‘
- è®©æ¸²æŸ“å®¹å™¨æ‰€æœ‰çš„å…ƒç´  `document` éƒ½æŒ‡å‘æ²™ç®± `iframeWindow.document`

**å†…éƒ¨è¡¥ä¸ 3ï¼š`_hasPatch`**

- è¡¨æ˜å·²ç»™å…ƒç´ æ‰“è¿‡è¡¥ä¸ï¼Œä¸ç”¨å†æ‰“è¡¥ä¸

**å¤–éƒ¨è¡¥ä¸ï¼š`patchElementHook`**

é€šè¿‡ `execHooks` æå– `plugins`ï¼Œæä¾›åˆ™ä½¿ç”¨ `patchElementHook` ä¸ºæ¯ä¸ªå…ƒç´ æ‰“è¡¥ä¸ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#patchelementhook)]

#### `patchIframeVariable` ä¸ºå­åº”ç”¨ `window` æ·»åŠ å±æ€§

ç›®å½•ï¼š`iframe.ts` - `patchIframeVariable` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L155)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡
- `wujie`ï¼šåº”ç”¨å®ä¾‹
- `appHostPath`ï¼šå­åº”ç”¨çš„ `host`

æ·»åŠ çš„å±æ€§ï¼š

- `__WUJIE`ï¼šæŒ‡å‘åº”ç”¨å®ä¾‹ `wujie`
- `__WUJIE_PUBLIC_PATH__`ï¼šå­åº”ç”¨çš„ `host`
- `$wujie`ï¼šå­åº”ç”¨çš„ `provide`ï¼Œè§ï¼š`WuJie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- `__WUJIE_RAW_WINDOW__`ï¼šæŒ‡å‘ `iframeWindow`

#### `patchIframeHistory` åŠ«æŒæ²™ç®± `iframe` çš„ `history`

ç›®å½•ï¼š`iframe.ts` - `patchIframeHistory` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L170)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡
- `appHostPath`ï¼šå­åº”ç”¨çš„ `host`
- `mainHostPath`ï¼šåŸºåº§çš„ `host`

è°ƒç”¨åœºæ™¯ï¼š

- `initIframeDom`ï¼šåˆå§‹åŒ– `iframe` çš„ `dom` ç»“æ„

åœ¨æ­¤ä¹‹å‰éœ€è¦æ˜ç™½ä¸€ä¸ªæ¦‚å¿µï¼š

- åœ¨åŠ«æŒ `history` ä¹‹å‰ï¼Œä¼šé€šè¿‡ `initBase` [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)] ä¸ºå­åº”ç”¨ä¸­æ‰€æœ‰ç›¸å¯¹è·¯å¾„çš„èµ„æºé“¾æ¥ï¼ŒæŒ‡å®šä¸ºå­åº”ç”¨ `host` çš„åŸºç¡€é“¾æ¥
- å½“ç‚¹å‡»é“¾æ¥æ—¶éœ€è¦æ‹¦æˆªè¿™éƒ¨åˆ†çš„é“¾æ¥ï¼Œæ›¿æ¢ä¸ºåŸºåº§ `host` ç„¶åæ›´æ–°æ²™ç®± `iframe` çš„ `url`
- æ›´æ–°å®Œä¹‹åå†é€šè¿‡ `updateBase` [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]ï¼Œå°† `iframe` çš„ `url` ä¸­åŸºåº§çš„ `host` æ›¿æ¢å›å­åº”ç”¨çš„ `host`

åŠ«æŒ `history` çš„æ–¹æ³•ï¼š

- `pushState`ï¼šæ’å…¥é“¾æ¥
- `replaceState`ï¼šæ›¿æ¢é“¾æ¥

æµç¨‹éƒ½ä¸€è‡´ï¼š

- å°† `baseUrl` æŒ‡å®šä¸ºï¼šåŸºåº§ `host` + `iframe` çš„ `pathname` + `search` + `hash`
- åœ¨æ›´æ–°çš„è¿æ¥ä¸­ï¼Œå°†å­åº”ç”¨çš„ `host` æ›¿æ¢ä¸ºç©ºå˜æˆä¸€ä¸ª `pathname`ï¼Œé€šè¿‡ `new URL` ä½¿å…¶æˆä¸º `baseUrl` çš„ç›¸å¯¹é“¾æ¥
- é€šè¿‡ `rawHistoryPushState.call` æ‰§è¡Œ `history` çš„æ›´æ–°ï¼Œé™¤éå½“å‰æ›´æ–°çš„ `url` ä¸å­˜åœ¨åˆ™åœæ­¢å¹¶è¿”å›
- é€šè¿‡ `updateBase` æ›´æ–°å‘¢ `base` å…ƒç´ ï¼Œä»¥ä¾¿å­åº”ç”¨åšçš„ç›¸å¯¹è·¯å¾„ç»™äºˆè·¯ç”±çš„ `pathname` [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]
- é€šè¿‡ `syncUrlToWindow` åŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°åŸºåº§ï¼Œä»¥ `hash` å½¢å¼å­˜åœ¨ [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)]

å…³äº `rawHistoryPushState.call`ï¼š

- è¿™é‡Œéœ€è¦æ³¨æ„æŒ‡å®šçš„ä¸Šä¸‹æ–‡æ˜¯ `iframeWindow.history`
- è¿™æ ·å°±ä¸º `syncIframeUrlToWindow` ä¸­ç›‘å¬ `iframeWindow` çš„ `popstate` å’Œ `hashchange` æä¾›äº†æ”¯æŒ [[æŸ¥çœ‹](#synciframeurltowindow-ç›‘å¬æ²™ç®±å‰è¿›åé€€)]

#### `patchIframeEvents` åŠ«æŒæ²™ç®± `iframe` çš„ `EventListener`

ç›®å½•ï¼š`iframe.ts` - `patchIframeEvents` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L115)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡

è°ƒç”¨åœºæ™¯ï¼š

- `initIframeDom`ï¼šåˆå§‹åŒ– `iframe` çš„ `dom` ç»“æ„

åŠ«æŒçš„æ–¹æ³•ï¼š

- `addEventListener`ï¼šæ·»åŠ ç›‘å¬äº‹ä»¶
- `removeEventListener`ï¼šåˆ é™¤ç›‘å¬äº‹ä»¶

æµç¨‹éƒ½ä¸€è‡´ï¼š

**1. é€šè¿‡ `execHooks` æå–å¹¶æ‰§è¡Œæ’ä»¶å‡½æ•°**

- `addEventListener`ï¼š`windowAddEventListenerHook` è§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#windowaddeventlistenerhook)]
- `removeEventListener`ï¼š`windowRemoveEventListenerHook` è§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#windowremoveeventlistenerhook)]

`windowAddEventListenerHook` çš„æ„ä¹‰åœ¨äºï¼š

- æ— ç•Œå­åº”ç”¨çš„ `dom` æ¸²æŸ“åœ¨ `webcomponent` ä¸­ï¼Œ`js` åœ¨ `iframe` ä¸­è¿è¡Œ
- å½“å­åº”ç”¨éœ€è¦é€šè¿‡ `window.addEventListener` ç›‘å¬æ»šåŠ¨æ—¶éœ€è¦é€šè¿‡æ’ä»¶ä»åŸºåº§æ·»åŠ ç›‘å¬å¯¹è±¡

**2. è®¾ç½® `__WUJIE_EVENTLISTENER__`**

- `addEventListener` ä¸­æ·»åŠ ï¼Œ`removeEventListener` ä¸­åˆ é™¤
- åˆ é™¤ç›‘å¬é¡¹éœ€è¦ `type`ã€`listener`ã€`optionns` å…¨éƒ¨éƒ½åŒ¹é…

å¯¹äº `__WUJIE_EVENTLISTENER__` ä¸ç†è§£å­˜åœ¨çš„æ„ä¹‰ï¼š

- åœ¨æºç ä¸­ `__WUJIE_EVENTLISTENER__` åªå­˜åœ¨æ·»åŠ å’Œåˆ é™¤ï¼Œæ²¡æœ‰è·å–å’Œè°ƒç”¨
- é‚£æœ‰ä¸ªå¯èƒ½æ˜¯ç•™ç»™å­åº”ç”¨å†…éƒ¨ä½¿ç”¨ï¼Ÿä½†å­åº”ç”¨å†…éƒ¨ç”¨ `window` äº‹ä»¶ç›‘å¬é›†åˆåšè®¾ä¹ˆå‘¢ï¼Ÿ
- é‚£åªå‰©ä¸‹æ¢å¤äº‹ä»¶ç›‘å¬ï¼Œä½†æ˜¯ç›®å‰åªæœ‰ä¸»åŠ¨é™çº§éœ€è¦æ¢å¤äº‹ä»¶ï¼Œä¸”é€šè¿‡ `recoverEventListeners` æ‰§è¡Œ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate?tab=readme-ov-file#%E8%AE%B0%E5%BD%95%E6%81%A2%E5%A4%8D-iframe-%E5%AE%B9%E5%99%A8%E4%BA%8B%E4%BB%B6)]

**3. æ‰§è¡Œæ·»åŠ æˆ–åˆ é™¤äº‹ä»¶ç›‘å¬**

ä½¿ç”¨åŠ«æŒçš„æ–¹æ³•æ‰§è¡Œæ·»åŠ æˆ–åˆ é™¤ï¼Œè°ƒç”¨æ–¹æ³•æ—¶ä¼šå°†åŠ«æŒçš„ `type`ã€`listener` å’Œ `options` é€ä¼ è¿‡å»ï¼Œä¸åŒçš„æ˜¯ä¸Šä¸‹æ–‡ä¸­ `this` æŒ‡å‘ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

- `appWindowAddEventListenerEvents` åŒ…å«çš„ `type`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L169)]ï¼Œ`this` ä¼˜å…ˆæŒ‡å‘ `targetWindow`ï¼Œä¸å­˜åœ¨ä½¿ç”¨ `iframeWindow`
- `options` æä¾› `targetWindow`ï¼Œ`this` æŒ‡å‘ `targetWindow`
- ä»¥ä¸Šæƒ…å†µéƒ½ä¸æ˜¯çš„æƒ…å†µä¼˜å…ˆä½¿ç”¨ `iframeWindow` å¦åˆ™ä½¿ç”¨åŸºåº§ `window`

> å¯¹äºæœ€åä¸€ç‚¹ï¼Œå­åº”ç”¨ä¸­ `__WUJIE_RAW_WINDOW__` æŒ‡å‘éƒ½æ˜¯ `iframeWindow`ï¼Œè§ï¼š`patchIframeVariable` [[æŸ¥çœ‹](#patchiframevariable-ä¸ºå­åº”ç”¨æ·»åŠ -window-å±æ€§)]

#### `patchWindowEffect`ï¼šä¿®æ­£ `iframeWindow` çš„ `effect`

ç›®å½•ï¼š`iframe.ts` - `patchWindowEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L215)]

åšäº† 3 ä»¶äº‹ï¼š

1. å°† `window` ä¸Šçš„å±æ€§ç»‘å®šåˆ° `iframe` ä¸Š
2. å°† `window` ä¸Šçš„äº‹ä»¶ç”¨ `iframe` åšåŠ«æŒ
3. é€šè¿‡æ’ä»¶ `windowPropertyOverride` è‡ªå®šä¹‰ç»™ `iframeWindow` æ‰“è¡¥ä¸

**ç»‘å®š `window` ä¸Šçš„å±æ€§**

å†…éƒ¨å®šä¹‰çš„å‡½æ•° `processWindowProperty` ç”¨å¤„ï¼š

- æ˜¯å°† `window` ä¸Šçš„å±æ€§ç»‘å®šåˆ° `iframeWindow`
- éœ€è¦é€šè¿‡ `isConstructable` æ¥åˆ¤æ–­æä¾›çš„å±æ€§æ˜¯å¦å¯ä»¥é€šè¿‡ `new` å£°æ˜å®ä¾‹ [[æŸ¥çœ‹](#isconstructableåˆ¤æ–­å‡½æ•°æ˜¯å¦å¯ä»¥-new)]

æœ‰ 3 ç§æƒ…å†µï¼š

- å…è®¸é€šè¿‡ `new` å£°æ˜å®ä¾‹çš„æ„é€ æ–¹æ³•ï¼Œç›´æ¥ç»‘å®šåˆ° `iframeWindow`ï¼Œ`this` é»˜è®¤æŒ‡å‘ `window`
- ä¸å…è®¸é€šè¿‡ `new` å£°æ˜å®ä¾‹çš„å‡½æ•°ï¼Œé€šè¿‡ `bind` å°†æ–¹æ³•ç»‘å®šåˆ° `iframe`ï¼Œå¹¶å°† `this` æŒ‡å‘ `window`
- ä¸æ˜¯å‡½æ•°çš„ `window` å±æ€§ï¼Œç›´æ¥ç»‘å®šè¦†ç›– `iframeWindow` é»˜è®¤çš„å±æ€§

æ–¹æ³•ï¼š

- é€šè¿‡ ` Object.getOwnPropertyNames` éå† `iframeWindow` è·å–å±æ€§åå»ç»‘å®š

`getSelection` å±è§„åˆ™ï¼š

- åŠ«æŒå±æ€§ï¼Œ`get` æ—¶æŒ‡å‘ `iframeWindow.document`
- å› ä¸ºåº”ç”¨æ˜¯æ¸²æŸ“åœ¨å®¹å™¨é‡Œçš„ï¼Œè€Œå®¹å™¨æ‰€æœ‰çš„å…ƒç´ é€šè¿‡ `patchElementEffect` æŒ‡å‘ `iframeWindow.document` [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]

å•ç‹¬å±æ€§å±è§„åˆ™ï¼š

- `windowProxyProperties`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L192)]
- è¿™è¿™éƒ¨åˆ†å±æ€§é€šè¿‡ `processWindowProperty` ä» `window` æå–å‡ºæ¥ç»‘å®šåˆ° `iframeWinndow`

æ­£åˆ™åŒ¹é…å±æ€§è§„åˆ™ï¼š

- `windowRegWhiteList`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L195)]
- è§„åˆ™æ–¹å¼å’Œâ€œå•ç‹¬å±æ€§â€ä¸€æ ·ï¼Œé€šè¿‡ `processWindowProperty` ç»‘å®š
- ä½†æ˜¯åœ¨æ‰§è¡Œå‰éœ€è¦å…ˆç¡®ä¿ `iframeWindow.parent` å­˜åœ¨è¿™ä¸ªå±æ€§

è¿™é‡Œå­˜åœ¨ä¸€ä¸ª `bug`ï¼š

- é€šå¸¸æ¥è¯´ `iframeWindow.parent` æŒ‡çš„æ˜¯åŸºåº§çš„ `window`
- ä½†æ˜¯æœ‰ä¸€ç§æƒ…å†µæ˜¯åº”ç”¨çš„åŸºåº§ä¹Ÿæ˜¯å­åº”ç”¨ï¼Œé‚£ä¹ˆ `iframeWindow.parent` ä¾ç„¶æ˜¯ `iframeWindow`
- å½“æˆ‘åœ¨ä½œä¸ºå­åº”ç”¨çš„åŸºåº§ `widnow` ä¸Šå®šä¹‰äº†æœ€é¡¶å±‚ `window` ä¸å­˜åœ¨çš„å±æ€§ï¼Œè¢«æ­£åˆ™åŒ¹é…åˆ°äº†
- é€šè¿‡ `processWindowProperty` å» `window` æ‹¿å¯¹åº”çš„å±æ€§å¾—åˆ°çš„å¯èƒ½æ˜¯ `undefinde`

**ç»‘å®š `window` ä¸Šæ‰€æœ‰çš„ `onEvent`**

- ç›‘å¬é™¤äº† `onload`ã€`onbeforeunload`ã€`onunload` ä¹‹å¤–æ‰€æœ‰ `on` å¼€å¤´çš„æ–¹æ³•
- é€šè¿‡ `Object.getOwnPropertyNames` éå† `window` ç­›é€‰å­˜åœ¨çš„äº‹ä»¶

æµç¨‹ï¼š

- é€šè¿‡ `Object.getOwnPropertyDescriptor` æ‹¿åˆ° `iframeWindow` ç›‘å¬äº‹ä»¶çš„æè¿°ä¿¡æ¯
- é€šè¿‡ `Object.defineProperty` åŠ«æŒ `iframeWindow` ä¸Šçš„ç›‘å¬äº‹ä»¶
- é€šè¿‡ `set` å°† `iframeWindow` ç›‘å¬çš„äº‹ä»¶ç»‘å®šåˆ° `window`
- åœ¨ `set` ä¸­å¯¹äºç±»å‹ä¸ºå‡½æ•°çš„ `handle` é€šè¿‡ `bind` å°†ä¸Šä¸‹æ–‡ `this` æŒ‡å‘ `iframe`
- åœ¨ `get` ä¸­ç›´æ¥è¿”å›è¿”å›ç»‘å®šåœ¨ `window` ä¸Šçš„ç›‘å¬äº‹ä»¶

è·å–æè¿°ä¿¡æ¯çš„ç›®çš„ï¼š

- `enumerable`ï¼šåˆ¤æ–­æ˜¯å¦å¯æšä¸¾
- `set`ï¼šé‡å†™å‰åˆ¤æ–­å±æ€§æ˜¯å¦å¯å†™æˆ–å­˜åœ¨ `set`ï¼Œä¸æ»¡è¶³è®¾ä¸º `undefined`

ä¸¾ä¸ªä¾‹å­ï¼š

```
// å­åº”ç”¨å†…
(function(window, self, global, location) {
  window.onfocus = () => {
    this;
  }
}).bind(window.__WUJIE.proxy)(
  window.__WUJIE.proxy,
  window.__WUJIE.proxy,
  window.__WUJIE.proxy,
  window.__WUJIE.proxyLocation,
);

// é€šè¿‡ `Object.getOwnPropertyDescriptor` å°†äº‹ä»¶ç»‘å®šåœ¨åŸºåº§ `window`
window.onfocus = () => {
  this; // ä½†æ˜¯ this æŒ‡å‘ iframeWindow
}

// è¿™æ ·å½“åŸºåº§è§¦å‘ `window.onfocus` æ—¶ï¼Œå°±ä¼šè°ƒç”¨æ¥è‡ªå­åº”ç”¨çš„ç›‘å¬äº‹ä»¶
// å› ä¸ºå­åº”ç”¨é‚£ä¸ªä¸­ä¸€å¼€å§‹ç›‘å¬äº‹ä»¶çš„ç›®çš„å°±æ˜¯å¥”ç€ `window` æ¥çš„ï¼Œè€Œä¸æ˜¯ `iframeWindow`
```

**é€šè¿‡æ’ä»¶æ‰“è¡¥ä¸**

- `windowPropertyOverride` æ–‡æ¡£å±…ç„¶æ²¡æï¼Œå¥½åœ¨å½“å‰æ€»ç»“å·²å¤šæ¬¡ç½—åˆ—æ’ä»¶ç³»ç»Ÿ
- ä¼šå°† `iframeWindow` ä½œä¸ºå‚æ•°ç›´æ¥ä¼ è¿‡å»ï¼Œç›´æ¥è¿›è¡Œè¦†ç›–

#### `patchDocumentEffect`ï¼šä¿®æ­£æ²™ç®± `document` çš„ `effect`

ç›®å½•ï¼š`iframe.ts` - `patchDocumentEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts)]

åšäº† 6 ä»¶äº‹ï¼š

**1. å¤„ç† `addEventListener` å’Œ `removeEventListener`**

å£°æ˜ 2 ä¸ª `WeakMap` æ˜ å°„è¡¨ï¼š

- `handlerCallbackMap`ï¼šæ ¹æ® `handle` è®°å½• `callback`
- `handlerTypeMap`ï¼šæ ¹æ® `handle` å°†æ‰€æœ‰ç›‘å¬çš„ç±»å‹é›†åˆæˆä¸€ä¸ªæ•°ç»„

å¤„ç† `callbabck`ï¼š

- é¦–æ¬¡æ·»åŠ ï¼šå¦‚æœ `handle` æ˜¯å‡½æ•°ï¼Œ`bind` æ²™ç®±çš„ `document` ä¸º `this`ï¼Œå¦åˆ™ç›´æ¥é‡‡ç”¨ `handle`
- å†æ¬¡æ·»åŠ ï¼šç›´æ¥ä½¿ç”¨é¦–æ¬¡ç¼“å­˜çš„ `callback`
- åˆ é™¤ï¼šåªåˆ é™¤å·²ç¼“å­˜çš„è®°å½•ï¼Œå°†è®°å½•ä» `handlerTypeMap` ä¸­å‰”å‡ºæŒ‡å®šç±»å‹
- å¦‚æœå‰”å‡ºç±»å‹å `handle` ä¸ºç©ºï¼Œå°† `handle` ä» `handlerCallbackMap` å’Œ `handlerTypeMap` éƒ½åˆ é™¤

é€šè¿‡ `execHooks` æå–å¹¶æ‰§è¡Œæ’ä»¶å‡½æ•°ï¼š

- `addEventListener`ï¼š`documentAddEventListenerHook`
- `removeEventListener`ï¼š`documentRemoveEventListenerHook`
- æ’ä»¶å‡½æ•°çš„æ„ä¹‰å’Œ `windowAddEventListenerHook` ä¸€æ ·ï¼Œè§ï¼š`patchIframeEvents` [[æŸ¥çœ‹](#patchiframeevents-åŠ«æŒæ²™ç®±-iframe-çš„-eventlistener)]

æ‰§è¡Œæ·»åŠ æˆ–åˆ é™¤äº‹ä»¶ç›‘å¬ï¼š

- æ— è®ºæ·»åŠ è¿˜æ˜¯åˆ é™¤ï¼Œå‚æ•°éƒ½ä¸€æ ·ï¼š`type`ã€`callback`ã€`options`ï¼Œä¸åŒçš„æ˜¯ä¸Šä¸‹æ–‡ä¸­ `this` å¯¹è±¡

`this` å¯¹è±¡çš„ä¸åŒåœºæ™¯ï¼š

- ç±»å‹åœ¨ `appDocumentAddEventListenerEvents` ä¸­ï¼š`iframeWindow`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L151)]
- `degrade` ä¸»åŠ¨é™çº§ï¼š`sandbox.document` æ²™ç®± `iframe` æ¸²æŸ“å®¹å™¨
- ç±»å‹åœ¨ `mainAndAppAddEventListenerEvents` ä¸­ï¼Œéœ€è¦åŒæ—¶ç›‘å¬åŸºåº§å’Œå­åº”ç”¨ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L166)]
- å…¶ä»–æƒ…å†µï¼š`sandbox.shadowRoot` æ¸²æŸ“å®¹å™¨

**2. å¤„ç† `onEvent`**

æå– 2 ä¸ªé›†åˆï¼š

- `elementOnEvents`ï¼šæå– `iframeWindow.HTMLElement.prototype` æ‰€æœ‰ `on` å¼€å¤´çš„äº‹ä»¶
- `documentOnEvent`ï¼šæå– `iframeWindow.Document.prototype` æ‰€æœ‰ `on` å¼€å¤´çš„äº‹ä»¶ï¼Œä½†ä¸åŒ…å« `onreadystatechange`

å–ä»–ä»¬çš„äº¤é›†è¿›è¡Œå¤„ç†ï¼Œå¤„ç†çš„æ–¹æ³•å’Œ `patchWindowEffect` ä¸­å¤„ç† `onEvent` ä¸€æ · [[æŸ¥çœ‹](#patchwindoweffectä¿®æ­£-iframewindow-çš„-effect)]ï¼š

- é€šè¿‡ `Object.getOwnPropertyDescriptor` æ‹¿åˆ° `iframeWindow.Document.prototype` ç›‘å¬äº‹ä»¶çš„æè¿°ä¿¡æ¯
- é€šè¿‡ `Object.defineProperty ` åŠ«æŒ `iframeWindow.Document.prototype` ä¸Šçš„ç›‘å¬äº‹ä»¶
- åœ¨ `set` å°†ç›‘å¬çš„äº‹ä»¶ç»‘å®šåˆ°æ¸²æŸ“å®¹å™¨ä¸Šï¼Œæ¸²æŸ“å®¹å™¨ç”± `degrade` å†³å®šæ˜¯ `iframe` è¿˜æ˜¯ `shadowRoot`
- åœ¨ `get` ä¸­ç›´æ¥è¿”å›è¿”å›ç»‘å®šåœ¨æ¸²æŸ“å®¹å™¨ä¸Šçš„ç›‘å¬äº‹ä»¶

> æ³¨æ„ï¼šå¦‚æœæ¸²æŸ“å®¹å™¨æ˜¯ `shadowDom`ï¼Œé‚£ä¹ˆåŠ«æŒçš„äº‹ä»¶ä¼šç»‘å®šåˆ° `shadowDom` çš„ `html` å…ƒç´ ä¸Šï¼Œè€Œå¦‚æœæ¸²æŸ“å®¹å™¨æ˜¯ `iframe` åˆ™ä¼šç»‘å®šåˆ°å®¹å™¨çš„ `document` ä¸Š

è·å–æè¿°ä¿¡æ¯çš„ç›®çš„ï¼š

- `enumerable`ï¼šåˆ¤æ–­æ˜¯å¦å¯æšä¸¾
- `set`ï¼šé‡å†™å‰åˆ¤æ–­å±æ€§æ˜¯å¦å¯å†™æˆ–å­˜åœ¨ `set`ï¼Œä¸æ»¡è¶³è®¾ä¸º `undefined`

ä¸ºä»€ä¹ˆè¦åŠ«æŒï¼š

- å› ä¸ºå­åº”ç”¨æ˜¯æ¸²æŸ“åœ¨å®¹å™¨é‡Œï¼Œè€Œ `script` æ˜¯å­˜æ”¾åœ¨æ²™ç®± `iframe` é‡Œ
- é€šè¿‡åŠ«æŒäº‹ä»¶ï¼Œè®©æ²™ç®± `document` è§¦å‘ç”±äºæ¸²æŸ“å®¹å™¨æ·»åŠ çš„äº‹ä»¶

**3. å¤„ç†å±æ€§ `get` æ—¶æŒ‡å‘æ²™ç®± `proxyDocument`**

å±æ€§æ¥è‡ªï¼š

- `documentProxyProperties`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L42)]

æ–¹æ³•å’Œå¤„ç† `onEvent` ä¸€æ ·ï¼š

- é€šè¿‡ `Object.getOwnPropertyDescriptor` æ‹¿åˆ° `iframeWindow.Document.prototype` å±æ€§çš„æè¿°ä¿¡æ¯
- é€šè¿‡ `Object.defineProperty ` åŠ«æŒ `iframeWindow.Document.prototype` ä¸Šçš„å±æ€§

ä¸åŒåœ¨äºï¼š

- ä¸å¯ `set`ï¼Œ`get` æ“ä½œæŒ‡å‘ `proxyDocument`

**4. å¤„ç† `document` ä¸“å±äº‹ä»¶**

å±æ€§æ¥è‡ªï¼š

- `documentEvents`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L131)]

æ–¹æ³•å’Œå¤„ç† `onEvent` ä¸€æ ·ï¼š

- é€šè¿‡ `Object.getOwnPropertyDescriptor` æ‹¿åˆ° `iframeWindow.Document.prototype` ç›‘å¬äº‹ä»¶çš„æè¿°ä¿¡æ¯
- é€šè¿‡ `Object.defineProperty ` åŠ«æŒ `iframeWindow.Document.prototype` ä¸Šçš„ç›‘å¬äº‹ä»¶
- å¯¹äºç±»å‹ä¸ºå‡½æ•°çš„ `handle` å°† `this` æŒ‡å‘ `iframeWindow`

ä¸åŒåœ¨äºï¼š

- æ–¹æ³•æ ¹æ® `degrade` å†³å®šç»‘å®šå¯¹è±¡æ˜¯æ¸²æŸ“å®¹å™¨ `iframe`ï¼Œè¿˜æ˜¯æœ€é¡¶å±‚åŸºåº§çš„ `window`
- åœ¨å½“å®šå¯¹è±¡çš„ `document` ä¸­ç»‘å®šç›‘å¬äº‹ä»¶çš„æ–¹æ³•ï¼ŒåŒç†è·å–ä¹Ÿæ˜¯ä»æŒ‡å®šå¯¹è±¡çš„ `document` ä¸­è·å–

**5. å¤„ç† `head` å’Œ `body`**

- éå† `ownerProperties` é›†åˆè¿›è¡ŒåŠ«æŒ
- ä» `iframeWindow.document` ä¸­åŠ«æŒå¯¹è±¡ï¼Œ`get` æ—¶æŒ‡å‘ `proxyDocument`

**6. è¿è¡Œæ’ä»¶é’©å­å‡½æ•°**

æ–‡æ¡£æ²¡æ `documentPropertyOverride`ï¼Œå’Œ `windowPropertyOverride` ä¸€æ ·ï¼Œè§ï¼š`patchWindowEffect` [[æŸ¥çœ‹](#patchwindoweffectä¿®æ­£-iframewindow-çš„-effect)]

- å°† `iframeWindow` ä½œä¸ºå‚æ•°ç›´æ¥ä¼ è¿‡å»ï¼Œåœ¨åŸºåº§ä¸­é€šè¿‡ `plugin` çš„æ–¹å¼åŠ«æŒç‰¹å®šå±æ€§æˆ–äº‹ä»¶

#### `patchNodeEffect`ï¼šä¿®æ­£ `node` çš„ `effect`

ç›®å½•ï¼š`iframe.ts` - `patchNodeEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L563)]

è¦†ç›–äº† 3 ä¸ªæ–¹æ³•ï¼š

- `getRootNode`ï¼šè·å– `document`ã€`appendChild`ï¼šè¿½åŠ å…ƒç´ ã€`insertBefore`ï¼šåœ¨å†…éƒ¨å…ƒç´ ä¹‹å‰æ’å…¥å…ƒç´ 

`appendChild`ã€`insertBefore` çš„ç›®çš„ï¼š

- ä¸ºæ¯ä¸€ä¸ªæ·»åŠ çš„ `node` é€šè¿‡ `patchElementEffect` æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]
- ç”±äºå­åº”ç”¨çš„ `Dom` æ¥è‡ªæ¸²æŸ“å®¹å™¨ï¼Œæ¸²æŸ“æ—¶å·²é€šè¿‡ `patchElementEffect` æ‰“è¡¥ä¸
- åœ¨æ¸²æŸ“å®¹å™¨é€šè¿‡ `appendChild`ã€`insertBefore` æ’å…¥å…ƒç´ ä¼šè¢«åŠ«æŒé‡å†™
- é‡å†™çš„æ–¹æ³•ä¸­ä¸ºæ–°å¢çš„å…ƒç´ é€šè¿‡ `patchElementEffect` å†æ¬¡æ‰“è¡¥ä¸ï¼Œä½¿å…¶å…·æœ‰å’Œå­åº”ç”¨ä¸­å…¶ä»– `Dom` å…ƒç´ æ‹¥æœ‰ä¸€æ ·çš„æ“ä½œæ–¹æ³•

`getRootNode` è¿™é‡Œåšäº†ä¸€ä¸ªå¾ˆâ€œå¥‡å¦™â€çš„æ“ä½œï¼š

- æ¸²æŸ“å®¹å™¨é‡Œæ¯ä¸ªå…ƒç´ éƒ½é‡å†™äº† `ownerDocument` æŒ‡å‘ `iframeWindow.document`
- å½“é€šè¿‡ `getRootNode` æ‹¿åˆ°çš„æ˜¯æ¸²æŸ“å®¹å™¨ `shadowRoot`ï¼Œè¯´æ˜å‡ºç°äº†å¼‚å¸¸æƒ…å†µ
- äºæ˜¯å°†æ²™ç®±é™çº§å®¹å™¨ `iframe` çš„ `document` è¿”å›ï¼Œè¿™ä¸ªæ—¶å€™ `iframeWindow.document` æ˜¯ `undefinned`ï¼Œä¹Ÿå°±ä»€ä¹ˆä¹Ÿæ‹¿ä¸åˆ°
- å…¶ä»–æƒ…å†µæ­£å¸¸è¿”å›ï¼Œä¹Ÿå°±æ˜¯ `iframeWindow.document`

é‚£é™çº§å®¹å™¨ `ifram` ä¸ºä»€ä¹ˆä¸åšå¤„ç†ï¼š

- å¯èƒ½è¿˜æ˜¯è¦è€ƒè™‘ç”¨æˆ·åœ¨å®¹å™¨é‡Œè·³è½¬åˆ°ç¬¬ä¸‰æ–¹é¡µé¢çš„æƒ…å†µ

#### `patchRelativeUrlEffect`ï¼šä¿®å¤åŠ¨æ€æ·»åŠ å…ƒç´ èµ„æº

ä¿®å¤èµ„æºå…ƒç´ çš„ç›¸å¯¹è·¯å¾„é—®é¢˜ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰

ç›®å½•ï¼š`iframe.ts` - `patchRelativeUrlEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L588)]

æµç¨‹ï¼š

- é€šè¿‡ `fixElementCtrSrcOrHref` é‡å†™ `setAttribute`ï¼Œ`Object.defineProperty` åŠ«æŒèµ„æºå±æ€§ [[æŸ¥çœ‹](#fixelementctrsrcorhrefå¯¹å…ƒç´ èµ„æºæ‰“è¡¥ä¸)]
- ä»è€Œå¯¹åŠ¨æ€è®¾ç½®ç›¸å¯¹è·¯å¾„çš„èµ„æºä¿®å¤ä¸ºç»å¯¹è·¯å¾„

#### `fixElementCtrSrcOrHref`ï¼šå¯¹å…ƒç´ èµ„æºæ‰“è¡¥ä¸

åŠ«æŒå…ƒç´ åŸå‹å¯¹ç›¸å¯¹åœ°å€çš„èµ‹å€¼è½¬ç»å¯¹åœ°å€

ç›®å½•ï¼š`utils.ts` - `fixElementCtrSrcOrHref` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L167)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window`
- `elementCtr`ï¼šèµ„æºå…ƒç´ 
- `attr`ï¼šèµ„æºå±æ€§ï¼Œä¾‹å¦‚ï¼š`src`

åšäº† 2 ä»¶äº‹ï¼š

- é‡å†™ `setAttribute`ã€åŠ«æŒ `elementCtr.prototype`

ç›®çš„ï¼š

- æ¥è‡ªå­åº”ç”¨åŠ¨æ€è®¾ç½®èµ„æºé“¾æ¥ï¼Œé€šè¿‡ `getAbsolutePath` é‡æ–°é…ç½®æœ€ç»ˆçš„é“¾æ¥ [[æŸ¥çœ‹](#getabsolutepathè·å–ç»å¯¹è·¯å¾„)]

å¤„ç†é“¾æ¥æœ‰ 3 ç§æƒ…å†µï¼š

- ç›¸å¯¹è·¯å¾„ï¼ŒæŒ‰ç…§ `baseURI` å–è½¬æ¢ä¸ºç»å¯¹è·¯å¾„ï¼Œ`baseURI` è§ï¼š`base` å…ƒç´  [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]
- ç»å¯¹è·¯å¾„æˆ–æ˜¯ `hash`ï¼Œä¸å¤„ç†ç›´æ¥è¿”å›

### è¾…åŠ©æ–¹æ³• - æ²™ç®± `iframe`

å›´ç»•æ²™ç®± `iframe` å½’çº³ç›¸å…³çš„æ–¹æ³•

#### `insertScriptToIframe`ï¼šä¸ºæ²™ç®±æ’å…¥ `script`

å‘æ²™ç®± `iframe` ä¸­æ’å…¥ `script`ï¼Œè€Œå¹¶é `shadowDom`

ç›®å½•ï¼š`iframe.ts` - `insertScriptToIframe` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L710)]

å‚æ•°ï¼š

- `scriptResult`ï¼šéœ€è¦æ’å…¥çš„ `script` å¯¹è±¡ï¼Œç±»å‹ï¼š`ScriptObject | ScriptObjectLoader`
- `iframeWindow`ï¼šæ²™ç®±çš„ `window`
- `rawElement`ï¼šå­åº”ç”¨é€šè¿‡å¦‚ï¼š`insertBefore` æŒ‡å®šçš„ç¬¬äºŒä¸ªå‚è€ƒèŠ‚ç‚¹

ä¸éœ€è¦è¿”å›ï¼Œè¿™ä¸ªå‡½æ•°å›´ç»• 2 ä¸ªå¯¹è±¡å±•å¼€ï¼š

- `scriptResult`ï¼šæ’å…¥æ²™ç®± `iframe` çš„ `script`
- `nextScriptElement`ï¼šéœ€è¦æ’å…¥åˆ°æ²™ç®±ä¸­ï¼Œæå–æ‰§è¡Œä¸‹ä¸€ä¸ª `execQueue`ï¼Œè§ï¼š`start å¯åŠ¨åº”ç”¨` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

è°ƒç”¨åœºæ™¯æœ‰ 2 ä¸ªï¼š

- `rewriteAppendOrInsertChild`ï¼šé‡å†™æ¸²æŸ“å®¹å™¨å¯¹äº `script`èŠ‚ç‚¹çš„æ“ä½œæ–¹æ³•
- `Wujie.start`ï¼šå¯åŠ¨åº”ç”¨ï¼Œè¯¦ç»†è§ï¼š`start` å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

> `rewriteAppendOrInsertChild` æœ‰ 2 ç§æƒ…å†µï¼Œä¸”éƒ½æ¥è‡ª `active` æ¿€æ´»åº”ç”¨ï¼Œè§ï¼š`active` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]ï¼š
>
> - `degrade` é™çº§å¤„ç†ï¼šä¼˜åŒ– `iframe` å®¹å™¨
> - é `dagrade`ï¼šä¼˜åŒ– `shadowDom` å®¹å™¨
>
> å®ƒä»¬çš„ç›®çš„åªæœ‰å…¨éƒ½æ»¡è¶³ä»¥ä¸‹ 2 ä¸ªæ¡ä»¶æ‰å¯ä»¥ï¼š
>
> - é€šè¿‡ `patchRenderEffect` é‡å†™å­åº”ç”¨ `node` æ“ä½œ [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]
> - æ“ä½œçš„èŠ‚ç‚¹å…ƒç´ ä¸º `script`ï¼Œè®©å…¶æ·»åŠ åˆ°æ²™ç®±çš„ `iframe` ä¸­

**ç¬¬ä¸€æ­¥ï¼šè·å–é…ç½®**

å°† `scriptResult` å¼ºåˆ¶ä½œä¸º `ScriptObjectLoader` åˆ†åˆ«æå–é…ç½®ï¼Œè¯¦ç»†è§ï¼š`processTpl` æå–èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)] - 4.æå–æˆ–æ›¿æ¢ `script`ï¼š

- `src`ï¼š`script` çš„ `url`ï¼Œå¯é€‰ç±»å‹ï¼š`string`
- `module`ï¼šæ˜¯å¦ä¸º `ES` æ¨¡å—ï¼Œå¯é€‰ç±»å‹ï¼š`boolean`
- `content`ï¼š`script` çš„å†…å®¹ï¼Œå¯é€‰ç±»å‹ï¼š`string`
- `crossorigin`ï¼šæ˜¯å¦ä¸ºè·¨åŸŸç±»å‹çš„ `script`ï¼Œå¯é€‰ç±»å‹ï¼š`boolean`
- `crossoriginType`ï¼šè·¨åŸŸç±»å‹ï¼Œå¯é€‰ç±»å‹ï¼š`"" | "anonymous" | "use-credentials"`
- `async`ï¼šæ˜¯å¦ä¸ºå¼‚æ­¥åŠ è½½çš„ `script`ï¼Œå¯é€‰ç±»å‹ï¼š`boolean`
- `attrs`ï¼š`script` å¸¦æœ‰ `=` å±æ€§çš„é”®å€¼å¯¹è±¡
- `callback`ï¼š`plugins` é¡¹ä¸­è®¾ç½® `callback`ï¼Œä¼šåœ¨ `insertScriptToIframe` æ‰§è¡Œæœ€åè°ƒç”¨ï¼Œè§æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html)]
- `onload`ï¼šå’Œ `callback` ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯ `onload` æ˜¯å¯¹äºå¸¦æœ‰ `src` çš„ `script`ï¼Œåœ¨åŠ è½½å®Œæ¯•åæˆ–åŠ è½½å¤±è´¥åè°ƒç”¨

> è¿™é‡Œåæ§½ä¸€ä¸‹ï¼Œæ—¢ç„¶å¼ºåˆ¶ä½œä¸º `ScriptObjectLoader` åˆä½•å¿…ä¼ å…¥è”åˆç±»å‹å‘¢ï¼Œéš¾é“ä¸æ˜¯åº”è¯¥åˆ†å¼€æå–å—ï¼Ÿ

åˆ›å»ºä¸¤ä¸ª `script` å¯¹è±¡ï¼š

- `scriptElement`ã€`nextScriptElement`

ä»æ²™ç®±å¯¹è±¡ä¸­æå– 3 ä¸ªé…ç½®ï¼š

- `replace`ï¼šæ›¿æ¢ `script` å†…å®¹çš„å‡½æ•°ï¼Œè§ï¼š1. æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯ [[æŸ¥çœ‹](#1-æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯)]
- `plugins`ï¼šææ¡¶çš„ `plugins`ï¼Œè§æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html)]
- `proxyLocation`ï¼šæ ¹æ®å¼•ç”¨å…¥åº“é“¾æ¥æå–çš„ `location` å¯¹è±¡

é€šè¿‡ `getJsLoader` æå–è¦æ’å…¥ `script` æœ€ç»ˆçš„ä»£ç ï¼š

- `getJsLoader` æ˜¯ä¸€ä¸ªæŸ¯é‡ŒåŒ–å‡½æ•°ï¼Œæ¥å—ä¸¤ä¸ªå‚æ•°ï¼š`plugins`ã€`replace`
- è¿”å›ä¸€ä¸ªæ‰§è¡Œå‡½æ•°ï¼Œå‡½æ•°æ¥å— 3 ä¸ªå‚æ•°ï¼š
  - `code` æ›¿æ¢å‰çš„ `script` å†…å®¹
  - `src` è„šæœ¬ `url`
  - `base`ï¼šå­åº”ç”¨å…¥å£é“¾æ¥ï¼ŒåŒ…æ‹¬ `protocol`ã€`host`ã€`pathname`
- è¿”å›çš„å‡½æ•°å†…éƒ¨é€šè¿‡ `compose`ï¼Œéå† `plugins` æå– `jsLoader` ä½œä¸ºå‚æ•°ï¼Œå¹¶å°†ä¸Šé¢æ”¶åˆ°çš„ 3 ä¸ªå‚æ•°ä¼ è¿‡å»ä½œä¸ºå‚æ•°

`compose` ä¹Ÿæ˜¯ä¸€ä¸ªæŸ¯é‡ŒåŒ–å‡½æ•°ï¼š

- è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œæ¥å—ä¸Šé¢æä¾›çš„ 3 ä¸ªå‚æ•°
- åœ¨å‡½æ•°å†…éƒ¨é€šè¿‡ `array.redus` å°† `plugins` æ‹å¹³
- å­˜åœ¨ `js-loader` å‡½æ•°äº¤ç”±å‡½æ•°å¤„ç†ï¼Œå¦åˆ™å°†å¤„ç†è¿‡çš„ `code` äº¤ç»™ä¸‹ä¸€ä¸ª `js-loader`ï¼Œè§æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-loader)]

æœ€ç»ˆè¿”å›ï¼š

- `js-loader` è¿‡æ»¤åçš„ä»£ç ï¼Œå¦‚æœ `js-loader` æ²¡æœ‰æä¾›ï¼Œåˆ™å°†ä¼ å…¥çš„ `code` åŸå°ä¸åŠ¨è¿”å›
- å¦‚æœæå–çš„æ˜¯å¸¦æœ‰ `src` çš„ `script`ï¼Œè„šæœ¬çš„ `code` å†…å®¹æ˜¯ç©ºï¼Œä¸”æ²¡æœ‰æä¾› `js-loader`ï¼Œé‚£ä¹ˆè¿”å›çš„æ˜¯ä¸€ä¸ªç©ºå­—ç¬¦

ä»ä¸Šé¢çŸ¥é“ï¼š

- ä¸Šé¢çš„å¤„ç†è¿‡ç¨‹å›´ç»• `js-loader` å±•å¼€ï¼Œ`js-loader` åªèƒ½ä½œä¸ºè¿‡æ»¤æ›¿æ¢ï¼Œä¸æ˜¯åŠ è½½èµ„æºçš„å‡½æ•°
- `js-loader` æ˜¯é€šè¿‡æŸ¯é‡ŒåŒ–å»¶è¿Ÿå¤„ç†ï¼Œåœ¨å‡½æ•°å†…éƒ¨é€šè¿‡ `map` è¿‡æ»¤ï¼Œé€šè¿‡ `redus` æ‹å¹³
- éƒ½æ˜¯åœ¨åŒä¸€ä¸ªå®ä»»åŠ¡ä¸­è¿›è¡Œï¼Œå³ä¾¿ `script` åªæä¾›äº† `src` é“¾æ¥ï¼Œä¹Ÿä¸å¯ä»¥é€šè¿‡ `fetch` è¿™æ ·çš„æ–¹å¼ç”¨å¾®ä»»åŠ¡è·å–è„šæœ¬
- åŠ è½½è„šæœ¬åœ¨æ­¤ä¹‹å‰é€šè¿‡ `importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)] åŠ è½½

ä¸º `scriptElement` æ·»åŠ å±æ€§ï¼š

- å°† `attrs` æå–æ’é™¤å’Œä¸Šè¿° `scriptResult` æå–çš„é…ç½®åŒåçš„å±æ€§æ·»åŠ åˆ° `scriptElement`

**ç¬¬äºŒæ­¥ï¼šé…ç½® `script`**

å†…è” `script`ï¼š

- åœ¨éé™çº§ `degrade` çŠ¶æ€ä¸‹å¹¶ä¸”ä¸æ˜¯ `es` æ¨¡å—çš„æƒ…å†µä¸‹ï¼Œå°†æ•´ä¸ª `script` å†…å®¹åŒ…è£¹åœ¨ä¸€ä¸ªå‡½æ•°æ¨¡å—é‡Œ
- ä½¿ç”¨æ²™ç®±çš„ `proxy` ä½œä¸ºæ¨¡å—çš„ï¼š`this`ã€`window`ã€`self`ã€`global`ï¼Œä½¿ç”¨ `proxyLocation` ä½œä¸ºæ¨¡å—çš„ `location`

æå–å†…è” `script` çš„ `src` å±æ€§ï¼š

- ä½†å‡¡æ˜¯ä¸ªæ­£è§„æµè§ˆå™¨ï¼Œé€šè¿‡ `Object.getOwnPropertyDescriptor` æ‹¿ `script` çš„ `src` éƒ½æ˜¯ `undefined`
- å› ä¸º `src` å±æ€§æ˜¯ä» `HTMLScriptElement` æ¥å£ç»§æ‰¿çš„ï¼Œè€Œä¸æ˜¯ç›´æ¥å®šä¹‰åœ¨ç‰¹å®šçš„ `scriptElement` å¯¹è±¡ä¸Šï¼Œè§æ¼”ç¤º [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/abgvWQj)]

> é‚£è¿™é‡Œçš„æ„ä¹‰æ˜¯å•¥å‘¢ï¼Ÿæˆ‘çŒœå¯èƒ½å’Œæ³¨é‡Šä¸€æ ·ï¼šè§£å†³ `webpack publicPath` ä¸º `auto` æ— æ³•åŠ è½½èµ„æºçš„é—®é¢˜ï¼Œåœ¨ `node` ç¯å¢ƒä¸‹å¯èƒ½ä¸ä¸€æ ·ï¼Œå¾…æŒ‡æ­£

å¤–è” `script`ï¼š

- è®¾ç½® `src`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
- è®¾ç½® `crossorigin`ï¼Œå¦‚æœå­˜åœ¨çš„è¯

`script` è¡¥å……æ“ä½œï¼š

- å¦‚æœ `module` æˆç«‹ï¼Œè®¾ç½® `scriptElement` ä¸º `es` æ¨¡å—ï¼Œ
- è®¾ç½® `textContent`ï¼Œå¤–è” `script` ä¹Ÿä¼šè®¾ç½®è„šæœ¬å†…å®¹ï¼Œä½†æ˜¯åŒæ—¶å­˜åœ¨ `src` å’Œ `textContent`ï¼Œä¼šé‡‡ç”¨å±æ€§ `src`
- è®¾ç½® `nextScriptElement` çš„è„šæœ¬å†…å®¹ï¼Œç”¨äºæ’å…¥ `script` å®Œæˆåï¼Œè°ƒç”¨ä¸‹ä¸€ä¸ªé˜Ÿåˆ—

**ç¬¬ä¸‰æ­¥ï¼šå£°æ˜ç›‘å¬æ–¹æ³•å¹¶å¤„ç† `script`**

å£°æ˜ `script` å®Œæˆåè¦æ‰§è¡Œçš„å‡½æ•°ï¼š

- å°†æ²™ç®±çš„ `iframe` çš„ `head` ä½œä¸ºå®¹å™¨ `container`
- å£°æ˜ä¸€ä¸ªå‡½æ•° `execNextScript`ï¼Œåªè¦ `async` ä¸å­˜åœ¨å°±ä¼šå°† `nextScriptElement` æ·»åŠ åˆ°å®¹å™¨å¹¶æ‰§è¡Œ
- å£°æ˜ä¸€ä¸ª `afterExecScript`ï¼Œç”¨äºåœ¨ `scriptElement` æ·»åŠ åˆ°å®¹å™¨åæ‰§è¡Œï¼Œå‡½æ•°åš 2 ä»¶äº‹ï¼š
  - è§¦å‘ `onload`ï¼šé€šè¿‡ `jsBeforeLoaders` æˆ– `jsAfterLoaders` æ·»åŠ 
  - è§¦å‘ `execNextScript`ï¼šä»¥ä¾¿æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ— `window.__WUJIE.execQueue.shift()()`

> è¿™é‡Œçš„é€»è¾‘æ˜¯æœ‰é—®é¢˜çš„ï¼Œè§ï¼š`start` å¯åŠ¨åº”ç”¨çš„ `bug` [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)]

æ£€æŸ¥é”™è¯¯ï¼šå¦‚æœæ’å…¥çš„ `script` å†…å®¹æ˜¯ `html`

- é€šè¿‡ `error` è¾“å‡ºé”™è¯¯ï¼Œè°ƒç”¨ `execNextScript` ä»¥ä¾¿æ‰§è¡Œä¸‹ä¸ªé˜Ÿåˆ—

> ç†è®ºä¸Šè¯´è¿™é‡Œçš„é€»è¾‘åœ¨é `fiber` ä¸‹æ˜¯ä¼šæœ‰é—®é¢˜çš„ï¼Œå¯¼è‡´ `start` å¯åŠ¨åº”ç”¨ä¸­æ–­ï¼Œä½†ç”±äºæ•è·çš„æƒ…å†µæœ¬èº«å°±æ˜¯é”™è¯¯çš„ï¼Œé‚£é€»è¾‘é”™è¯¯åˆå¦‚ä½•å‘¢ï¼Ÿ

æ‰“æ ‡è®°ï¼š

- æ ¹æ®æä¾›çš„ `script` ä¸ºæ’å…¥çš„ `script` æ‰“ä¸Šæ ‡è®° `WUJIE_SCRIPT_ID`ï¼Œå€¼æ˜¯ä¸€ä¸ªè‡ªå¢æ•°å­—
- åªæœ‰é€šè¿‡å­åº”ç”¨ `rewriteAppendOrInsertChild` åŠ¨æ€æ·»åŠ çš„ `script` æ‰éœ€è¦æ‰“æ ‡è®°ï¼Œè§ï¼š`patchRenderEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

å¤–è”è„šæœ¬æ‰§è¡Œåçš„å¤„ç†ï¼š

- è¦æ±‚ï¼š`script` å¸¦æœ‰ `src`ï¼Œå†…å®¹ä¸ºç©º
- æ»¡è¶³æ¡ä»¶æ— è®ºæ˜¯ `onload` è¿˜æ˜¯ `onerror` éƒ½ä¼šè°ƒç”¨ `afterExecScript`

**ç¬¬å››æ­¥ï¼šæ’å…¥ `script`**

- åœ¨å®¹å™¨ `container` ä¸­æ·»åŠ  `scriptElement`
- è°ƒç”¨ `callback` å¹¶å°†æ²™ç®±çš„ `iframeWindow` ä½œä¸ºå‚æ•°
- æå–å¹¶æ‰§è¡Œ `appendOrInsertElementHook`ï¼Œè§æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#appendorinsertelementhook)]
- å¯¹äºå†…è” `script` å…ƒç´ æ— æ³•è§¦å‘ `onload`ï¼Œç›´æ¥è°ƒç”¨ `afterExecScript`

**æ€»ç»“ï¼š**

- `insertScriptToIframe`ï¼šç”¨å¤„æ˜¯å°† `script` æ·»åŠ åˆ°æ²™ç®± `iframe` ä¸­
- åŒ…å«ï¼šå­åº”ç”¨çš„ `script`ã€å¯åŠ¨åº”ç”¨æ—¶æ‰‹åŠ¨é…ç½®çš„ã€åœ¨åº”ç”¨ä¸­é€šè¿‡èŠ‚ç‚¹æ“ä½œæ·»åŠ çš„
- å¯¹äºå†…è” `script` ä¼šåŒ…è£¹ä¸€ä¸ªæ¨¡å—ï¼Œé€šè¿‡ `proxy` æ›´æ”¹ `window` ç­‰å¯¹è±¡çš„æŒ‡å‘ï¼Œé¿å…å…¨å±€æ±¡æŸ“
- è¿™ä¸ªå‡½æ•°å­˜åœ¨é€»è¾‘é—®é¢˜ï¼Œè§ï¼š`start` å¯åŠ¨åº”ç”¨çš„ `bug` [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)]

#### `iframeGenerator`ï¼šåˆ›å»ºæ²™ç®± `iframe`

ç›®å½•ï¼š`iframe.ts` - `iframeGenerator` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L815)]

`js` æ²™ç®±ï¼Œæ¥è‡ªå¤‡æ³¨ï¼š

- åˆ›å»ºå’Œä¸»åº”ç”¨åŒæºçš„ `iframe`ï¼Œè·¯å¾„æºå¸¦äº†å­è·¯ç”±çš„è·¯ç”±ä¿¡æ¯ï¼Œ`iframe` å¿…é¡»ç¦æ­¢åŠ è½½ `html`ï¼Œé˜²æ­¢è¿›å…¥ä¸»åº”ç”¨çš„è·¯ç”±é€»è¾‘

å‚æ•°ï¼š

- `sandbox`ï¼šåº”ç”¨å®ä¾‹
- `attrs`ï¼šé…ç½® `iframe`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#attrs)]
- `mainHostPath`ï¼šåŸºåº§ `host`
- `appHostPath`ï¼šå­åº”ç”¨ `host`
- `appRoutePath`ï¼šå­åº”ç”¨çš„ `pathname`

**ç¬¬ä¸€æ­¥ï¼šåˆ›å»º `iframe`**

- åˆ›å»ºä¸€ä¸ª `iframe` å…ƒç´ ï¼Œå¹¶è®¾ç½®å±æ€§
- å±æ€§åŒ…å«ï¼š`src` ä¸ºåŸºåº§ `host`ï¼Œæ ·å¼ä¸å¯è§ï¼Œè‡ªå®šä¹‰å±æ€§ï¼Œ`id` ä¸ºåº”ç”¨åä»¥åŠ `wujie` ç‰¹æœ‰çš„ `flag`
- å°† `iframe` æ·»åŠ åˆ° `body` æœ«å°¾
- é€šè¿‡ `patchIframeVariable` ä¸º `iframeWindow` æ·»åŠ å±æ€§ [[æŸ¥çœ‹](#patchiframevariable-ä¸ºå­åº”ç”¨-window-æ·»åŠ å±æ€§)]

å…³äº `patchIframeVariable`

- å¤‡æ³¨æ˜¯è¿™æ ·çš„ï¼šå˜é‡éœ€è¦æå‰æ³¨å…¥ï¼Œåœ¨å…¥å£å‡½æ•°é€šè¿‡å˜é‡é˜²æ­¢æ­»å¾ªç¯ã€‚
- ä½†åœ¨å…¥å£å‡½æ•°å€’æ˜¯æ²¡æœ‰æ‰¾åˆ°éœ€è¦ç”¨åˆ°æ³¨å…¥ `iframeWindow` å±æ€§çš„åœ°æ–¹
- å€’æ˜¯åœ¨ `localGenerator` ä¸»åŠ¨é™çº§çš„ä»£ç†æ–¹æ³•ä¸­éœ€è¦ç”¨åˆ° `iframe.contentWindow.__WUJIE`
- è€Œ `localGenerator` å¯¹äº `iframeGenerator` æ¥è¯´æ˜¯ä¸Šä¸‹æ–‡å…³ç³»ï¼Œä¼˜å…ˆäºå¾®ä»»åŠ¡å…ˆæ‰§è¡Œ

**ç¬¬äºŒæ­¥ï¼šå‘èµ·å¾®ä»»åŠ¡**

- å‘èµ·å¾®ä»»åŠ¡ `stopIframeLoading` å¹¶æŒ‚åœ¨åˆ°å®ä¾‹å±æ€§ `iframeReady` ä¸Š
- è¿”å›åˆ›å»ºçš„æ²™ç®± `iframe`

`iframeReady` ç”¨äºç¡®ä¿ `iframe` å®Œæˆåˆå§‹åŒ–ï¼š

- åœ¨ `active` æ¿€æ´»ä»»åŠ¡å‰ä¼šå…ˆé€šè¿‡ `await this.iframeReady` ç¡®ä¿å®Œæˆ
- åœ¨ `active` ä¹‹å‰è¿˜ä¼šå‘èµ· 2 è½®å¾®é˜Ÿåˆ—ï¼š`importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]ã€`processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
- å¦‚æœåŠ è½½é¡ºåˆ©çš„è¯ `iframeReady` ä¼šåœ¨ `importHTML` ä¹‹å‰å®Œæˆ `stopIframeLoading` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

#### `initIframeDom`ï¼šåˆå§‹åŒ– `iframe` çš„ `dom` ç»“æ„

ç›®å½•ï¼š`iframe.ts` - `initIframeDom` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L616)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡
- `wujie`ï¼šåº”ç”¨å®ä¾‹
- `mainHostPath`ï¼šåŸºåº§ `host`
- `appHostPath`ï¼šå­åº”ç”¨ `host`

**ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ–°çš„ `html`**

- é€šè¿‡ `iframeWindow` æ‹¿åˆ° `iframeDocument`
- é€šè¿‡ `window.document.implementation.createHTMLDocument` åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç™½ `html` å…ƒç´ 
- å¦‚æœæ²™ç®±çš„ `iframe` çš„ `html` å…ƒç´ å­˜åœ¨å°±æ˜¯ç”¨æ–°çš„ `html` æ›¿æ¢ï¼Œå¦åˆ™æ·»åŠ åˆ° `iframeDocument`

**ç¬¬äºŒæ­¥ï¼šæ³¨å…¥ `iframeWindow` å…¨å±€å±æ€§**

- `__WUJIE_RAW_DOCUMENT_HEAD__`ï¼šæŒ‡å‘æ²™ç®± `head` å…ƒç´ 

åœ¨é€šè¿‡æ‰“è¡¥ä¸æ–¹å¼è¦†ç›–åŸç”Ÿæ–¹æ³•å‰ï¼Œå…ˆè®°å½• `Document` å‡ ä¸ªåŸç”Ÿçš„æ–¹æ³•ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

- `__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__`ï¼š`querySelector`
- `__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__`ï¼š`querySelectorAll`
- `__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__`ï¼š`createElement`
- `__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__`ï¼š`createTextNode`

**ç¬¬ä¸‰æ­¥ï¼šæ‰“è¡¥ä¸**

- `initBase`ï¼šåˆå§‹åŒ– `base` æ ‡ç­¾ [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]
- `patchIframeHistory`ï¼šåŠ«æŒæ²™ç®± `iframe` çš„ `history` [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)]
- `patchIframeEvents`ï¼šåŠ«æŒæ²™ç®± `iframe` çš„ `EventListener` [[æŸ¥çœ‹](#patchiframeevents-åŠ«æŒæ²™ç®±-iframe-çš„-eventlistener)]
- `recordEventListeners`ï¼šå¦‚æœ `degrade` é™çº§å¤„ç†ï¼Œè®°å½• `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]
- `syncIframeUrlToWindow`ï¼šç›‘å¬æ²™ç®±å‰è¿›åé€€ [[æŸ¥çœ‹](#synciframeurltowindow-ç›‘å¬æ²™ç®±å‰è¿›åé€€)]
- `patchWindowEffect`ï¼šä¿®æ­£ `iframeWindow` çš„ `effect` [[æŸ¥çœ‹](#patchwindoweffectä¿®æ­£-iframewindow-çš„-effect)]
- `patchDocumentEffect`ï¼šä¿®æ­£æ²™ç®± `document` çš„ `effect` [[æŸ¥çœ‹](#patchdocumenteffectä¿®æ­£æ²™ç®±-document-çš„-effect)]
- `patchNodeEffect`ï¼šä¿®æ­£ `node` çš„ `effect` [[æŸ¥çœ‹](#patchnodeeffectä¿®æ­£-node-çš„-effect)]
- `patchRelativeUrlEffect`ï¼šä¿®å¤åŠ¨æ€æ·»åŠ å…ƒç´ èµ„æº [[æŸ¥çœ‹](#patchrelativeurleffectä¿®å¤åŠ¨æ€æ·»åŠ å…ƒç´ èµ„æº)]

#### `base`ï¼šæ ‡ç­¾æ“ä½œ

ç›®çš„ï¼š

- åœ¨æ²™ç®± `iframe` ä¸­æ·»åŠ ä¸€ä¸ª `base` å…ƒç´ 
- ç”±äºæ¸²æŸ“çš„å®¹å™¨ä¸­é€šè¿‡ `patchElementEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)] å°† `ownerDocument` æŒ‡å‘ `iframeWindow.document`
- æ‰€ä»¥åº”ç”¨çš„æ¸²æŸ“å®¹å™¨ä¸­æ‰€æœ‰èµ„æºçš„ç›¸å¯¹é“¾æ¥ä¼šé€šè¿‡æ²™ç®± `iframe` æŒ‡å‘ `base` å…ƒç´ 

æ“ä½œåˆ† 2 éƒ¨åˆ†ï¼Œå³ï¼šåˆå§‹åŒ–å’ŒåŠ¨æ€æ›´æ–°

**`initBase` åˆå§‹åŒ– `base` æ ‡ç­¾**

ç›®å½•ï¼š`iframe.ts` - `initBase` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L600)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡
- `url`ï¼šå­åº”ç”¨çš„å…¥å£é“¾æ¥

æµç¨‹ï¼š

- é€šè¿‡ `iframeWindow` æ‹¿åˆ°æ²™ç®±çš„ `iframeDocument` å¹¶åˆ›å»ºä¸€ä¸ª `base` å…ƒç´ 
- å°† `iframe` çš„ `href`ï¼ˆå³åŸºåº§çš„ `host`ï¼‰ï¼Œå’Œåº”ç”¨çš„å…¥å£é“¾æ¥é€šè¿‡ `anchorElementGenerator` [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)] åˆ›å»º 2 ä¸ª `HTMLAnchorElement` å¯¹è±¡
- ä½¿ç”¨å­åº”ç”¨çš„ `host` + åŸºåº§çš„ `pathname` ä½œä¸º `base` å…ƒç´ çš„ `href`
- å°† `base` å…ƒç´ æ’å…¥æ²™ç®± `iframe` ä¸­

æ³¨æ„ï¼š

- æ²™ç®± `iframe` çš„ `src` ä¸ºåŸºåº§åº”ç”¨çš„ `host`ï¼Œè€Œ `initBase` æ˜¯åœ¨åˆå§‹åŒ– `iframe` æ—¶åˆ›å»º
- æ‰€ä»¥æ— è®ºå¦‚ä½• `pathname` å§‹ç»ˆæ‹¿åˆ°çš„æ˜¯ `/`

**`updateBase` åŠ¨æ€æ›´æ–° `base` æ ‡ç­¾**

ç›®å½•ï¼š`iframe.ts` - `updateBase` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L204)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡
- `appHostPath`ï¼šå­åº”ç”¨çš„ `host`
- `mainHostPath`ï¼šåŸºåº§çš„ `host`

æµç¨‹ï¼š

- å°† `iframe` çš„ `host` å–å‡º `mainHostPath` å˜æˆç›¸å¯¹è·¯å¾„ï¼Œé€šè¿‡ `new URL` ä½¿å…¶ä½œä¸º `appHostPath` çš„ `pathname`
- è°ƒç”¨ `iframe` åŸç”Ÿçš„æ–¹æ³•æŸ¥æ‰¾ `base` å…ƒç´ å¹¶æ›´æ–° `href` å±æ€§

#### `stopIframeLoading`ï¼šå®ç°ä¸€ä¸ªçº¯å‡€çš„æ²™ç®± `iframe`

é˜²æ­¢è¿è¡Œä¸»åº”ç”¨çš„ `js` ä»£ç ï¼Œç»™å­åº”ç”¨å¸¦æ¥å¾ˆå¤šå‰¯ä½œç”¨ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰

ç›®å½•ï¼š`iframe.ts` - `stopIframeLoading` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sync.ts#L9)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡

åŸå› ï¼š

- å­åº”ç”¨çš„ `script` è¿è¡Œåœ¨ä¸€ä¸ªå’Œä¸»åº”ç”¨åŒåŸŸçš„ `iframe` æ²™ç®±ä¸­
- è®¾ç½® `src` ä¸º `mainHostPath`ï¼ˆä¸»åŸŸå `host`ï¼‰ï¼Œä¼šä¸»åŠ¨åŠ è½½ä¸»åº”ç”¨
- æ‰€ä»¥å¿…é¡»åœ¨ `iframe` å®ä¾‹åŒ–å®Œæˆå‰ï¼Œè¿˜æ²¡æœ‰åŠ è½½å®Œ `html` æ—¶ä¸­æ–­åŠ è½½ï¼Œé˜²æ­¢æ±¡æŸ“å­åº”ç”¨

`iframe` å®ä¾‹åŒ–ä¹‹å‰ `stop` å¯ä»¥å—ï¼Ÿ

- ä¸è¡Œï¼Œæ­¤æ—¶ `iframe` çš„ `location.origin` è¿˜æ˜¯ `about:blank`
- ä¼šå¯¼è‡´åç»­è·å– `iframeWindow.location` æ— æ•ˆ

é‚£ `iframe` å®ä¾‹åŒ–åé€šè¿‡ `document.write` æ“¦é™¤å¯ä»¥å—ï¼Ÿ

- ä¸è¡Œï¼Œè·¯ç”±å™¨çš„åŒæ­¥åŠŸèƒ½å°†å¤±è´¥

æµç¨‹ï¼š

- è®°å½•ä¸€ä¸ªè¿˜æœªå®ŒæˆåŠ è½½çš„ `iframeWindow.document` ä½œä¸º `oldDoc`ï¼Œæ­¤æ—¶çš„ `location.origin` æ˜¯ `about:blank`
- è¿”å›ä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œå¾®ä»»åŠ¡ä¸­åˆ›å»ºä¸€ä¸ª `loop` å‡½æ•°ä½œä¸º `document` æ£€æµ‹
- åœ¨ `loop` ä¸­å†åˆ›å»ºä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œç”±äº `appendChild` æ˜¯åŒæ­¥æ“ä½œï¼Œæ‰€ä»¥æ‰§è¡Œå¾®ä»»åŠ¡å‰ä¼šä¼˜å…ˆæŒ‚è½½ `iframe` é¿å…æ­»å¾ªç¯
- åœ¨ `loop` å¾®ä»»åŠ¡ä¸­è·å–å½“å‰ `iframe.document` å’Œ `oldDoc` è¿›è¡Œæ¯”è¾ƒ
- å¦‚æœ `iframe` æ²¡æœ‰å®Œæˆå®ä¾‹åŒ–å¯¼è‡´ `document` ä¸å˜ï¼Œå°†é‡æ–°å‘èµ·ä¸€è½® `loop` å¾®ä»»åŠ¡
- ç›´åˆ° `iframe` å®ä¾‹åŒ–å®Œæ¯• `document` å‘ç”Ÿæ”¹å˜ï¼Œç«‹å³ `stop` åœæ­¢ `iframe` åŠ è½½åé‡Šæ”¾å¾®ä»»åŠ¡

> ç”±äºæ²™ç®± `iframe` åœ¨åˆå§‹åŒ–ä¹‹å‰å·²ç»è®¾ç½®ä¸å¯è§ï¼Œæ‰€ä»¥åŠ è½½è¿‡ç¨‹ä¹Ÿå…¨ç¨‹ä¸å¯è§

#### `syncIframeUrlToWindow` ç›‘å¬æ²™ç®±å‰è¿›åé€€

å­åº”ç”¨å‰è¿›åé€€ï¼ŒåŒæ­¥è·¯ç”±åˆ°ä¸»åº”ç”¨

ç›®å½•ï¼š`iframe.ts` - `syncIframeUrlToWindow` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L697)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡

ç›‘å¬çš„äº‹ä»¶ï¼š

- `hashchange`ï¼šç›‘å¬ `hash` å˜åŒ–
- `popstate`ï¼šç›‘å¬å‰è¿›åé€€

è¦åšçš„äº‹ï¼š

- é€šè¿‡ `syncUrlToWindow` åŒæ­¥è·¯ç”±åˆ°åŸºåº§ [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)]

#### `isConstructable`ï¼šåˆ¤æ–­å‡½æ•°æ˜¯å¦å¯ä»¥ `new`

ç›®å½•ï¼š`utils.ts` - `isConstructable` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L60)]

å‚æ•°ï¼š

- `fn`ï¼šä»»æ„å‡½æ•°ï¼ŒåŒ…æ‹¬æ„é€ å‡½æ•°

**ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å‡½æ•°æ˜¯å¦æœ‰åŸå‹æ–¹æ³•**

- å­˜åœ¨ `prototype` ä¸” `prototype.constructor` æŒ‡å‘è‡ªèº«ï¼Œ`prototype` ä¸Šçš„å±æ€§é™¤äº† `constructor` è¿˜æœ‰å…¶ä»–å±æ€§
- å¦‚æœä»¥ä¸Šæ¡ä»¶éƒ½å­˜åœ¨è¿”å› `true`

**ç¬¬äºŒæ­¥ï¼šä»ç¼“å­˜ä¸­è·å–**

- ä¹‹å‰è®¡ç®—è¿‡çš„ä¼šå­˜åœ¨åœ¨æ˜ å°„è¡¨ `fnRegexCheckCacheMap` ä¸­ï¼Œå­˜åœ¨ç›´æ¥è¿”å›

**ç¬¬ä¸‰æ­¥ï¼šé€šè¿‡æ­£åˆ™è¡¨è¾¾å¼æ£€æŸ¥å‡½æ•°å­—ç¬¦ä¸²**

- `constructableFunctionRegex`ï¼šæ£€æŸ¥å¤§å†™å¼€å¤´çš„å‡½æ•°ï¼Œ`classRegex`ï¼šæ£€æŸ¥ä»¥ `class` å¼€å¤´çš„ç±»
- ä»¥ä¸Šä»»æ„æ¡ä»¶å­˜åœ¨å³å¯

**ç¬¬å››æ­¥ï¼šç¼“å­˜å¹¶è¿”å›ç»“æœ**

- å°†è·å–çš„ç»“æœ `constructable` å­˜å‚¨åœ¨ `fnRegexCheckCacheMap`ï¼Œå¹¶è¿”å›

### è¾…åŠ©æ–¹æ³• - è·¯ç”±åŒæ­¥å’Œé“¾æ¥å¤„ç†

å›´ç»•åº”ç”¨ä¸­çš„è·¯ç”±ã€é“¾æ¥å½’çº³ç›¸å…³æ–¹æ³•

#### `syncUrlToWindow`ï¼šåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨

ç›®å½•ï¼š`sync.ts` - `syncUrlToWindow` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sync.ts#L9)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡

è°ƒç”¨åœºæ™¯ï¼š

- `active` æ¿€æ´»åº”ç”¨æ—¶åŒæ­¥è·¯ç”±ï¼ŒåŒ…å«ï¼šé¢„åŠ è½½ã€åˆæ¬¡å¯åŠ¨åº”ç”¨ã€åˆ‡æ¢åº”ç”¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
- `syncIframeUrlToWindow`ï¼šç›‘å¬ `iframeWindow` åé€€å’Œå‰è¿› [[æŸ¥çœ‹](#synciframeurltowindow-ç›‘å¬æ²™ç®±å‰è¿›åé€€)]
- `patchIframeHistory`ï¼šåŠ«æŒ `iframeWindowã€‚history` å¯¹è±¡çš„ `pushState` å’Œ `replaceState` [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)]

ä¸åšå¤„ç†çš„æƒ…å†µï¼š

- æ²¡æœ‰é…ç½® `sync` åŒæ­¥è·¯ç”±ï¼Œå¹¶ä¸”åŸºåº§ `url.search` æ‰¾ä¸åˆ°å½“å‰åº”ç”¨ååŒ¹é…çš„å€¼

**ç¬¬ä¸€æ­¥ï¼šæå–é…ç½®**

- ä»åº”ç”¨å®ä¾‹ä¸­è·å–ï¼š`sync` åŒæ­¥è·¯ç”±ã€`id` åº”ç”¨åã€`prefix` çŸ­é“¾æ¥ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]
- æå–å½“å‰çš„ `url` è½¬å˜ä¸º `HTMLAnchorElement` å¯¹è±¡ï¼Œè§ï¼š`anchorElementGenerator` [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]
- é€šè¿‡ `HTMLAnchorElement` æ‹¿åˆ° `queryMap`ï¼Œè§ï¼š`getAnchorElementQueryMap` [[æŸ¥çœ‹](#getanchorelementquerymap-è½¬åŒ–-urlsearch-ä¸ºé”®å€¼å¯¹è±¡)]
- æ‹¿åˆ° `iframeWindow.location` ä¸­çš„ `pathnname` + `search` + `hash`ï¼Œä½œä¸ºå½“å‰å­åº”ç”¨ç›®æ ‡è·¯ç”± `curUrl`
- å£°æ˜ä¸€ä¸ªå˜é‡ `validShortPath` ç”¨äºè®°å½•åŒ¹é…çš„çŸ­é“¾æ¥å

**ç¬¬äºŒæ­¥ï¼šå¤„ç†çŸ­è·¯å¾„**

éå† `prefix` æ‹¿åˆ°çŸ­é“¾åå’Œå¯¹åº”çš„ `url`ï¼ŒåŒ¹é…å¹¶æ›´æ–° `validShortPath`ï¼Œè¦æ±‚ï¼š

- `curUrl` å¿…é¡»æ˜¯ç”¨éå†çš„ `url` å¼€å¤´ï¼Œä¸” `url` å°½å¯èƒ½åŒ¹é… `curUrl`

**ç¬¬ä¸‰æ­¥ï¼šåŒæ­¥è·¯ç”±**

`sync` å·²é…ç½®ï¼š

- é€šè¿‡ `encodeURIComponent` æ›´æ–° `queryMap[id]` çš„å€¼ä¸º `curUrl`
- å¦‚æœ `validShortPath` åŒ¹é…åˆ°å€¼ï¼Œä¼˜å…ˆæ›¿æ¢ `curUrl` ä¸­åŒ¹é…çŸ­é“¾å¯¹åº”çš„ `url` ä¸º `{çŸ­é“¾å}`

`sync` æœªé…ç½®ï¼š

- ä» `queryMap` ä¸­åˆ é™¤åº”ç”¨å¯¹åº”çš„å€¼

**ç¬¬å››æ­¥ï¼šæ›´æ–°è·¯ç”±**

- å°†åŒæ­¥åçš„ `queryMap` è¿˜åŸæˆ `url.search`ï¼Œå¹¶æ›´æ–° `winUrlElement` å¯¹è±¡
- å½“ `winUrlElement` é“¾æ¥å‘ç”Ÿæ”¹å˜ï¼Œé€šè¿‡ `window.history.replaceState` æ›´æ–°å½“å‰ `url`

#### `syncUrlToIframe`ï¼šåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨

ç›®å½•ï¼š`sync.ts` - `syncUrlToIframe` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sync.ts#L51)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window` å¯¹è±¡

è°ƒç”¨åœºæ™¯ï¼š

- åªæœ‰ `alive` æ¨¡å¼åˆ‡æ¢è·¯ç”±ä¸ä¼šè°ƒç”¨
- å…¶ä»–æ‰€æœ‰åœºæ™¯ï¼Œæ— è®ºæ˜¯é¢„åŠ è½½ã€åˆæ¬¡å¯åŠ¨ã€åˆ‡æ¢åº”ç”¨éƒ½ä¼šæ˜¾åŒæ­¥ä¸»åº”ç”¨è·¯ç”±ï¼Œå†ä»å­åº”ç”¨åŒæ­¥è·¯ç”±åˆ°ä¸»åº”ç”¨

**ç¬¬ä¸€æ­¥ï¼šæ‹¿åˆ°é…ç½®**

- ä»æ²™ç®± `iframe` çš„ `location` ä¸­æå–ï¼š `pathname`ã€`search`ã€`hash`
- ä»åº”ç”¨å®ä¾‹ä¸­æ‹¿åˆ°å¿…è¦çš„å±æ€§ï¼Œè§æºç 

è®¡ç®—å­åº”ç”¨çš„è·¯ç”±ï¼š

- å¦‚æœ `sync` åŒæ­¥è·¯ç”±ï¼Œä¸”åˆæ¬¡å¯åŠ¨æˆ–é¢„åŠ è½½ `active`ï¼Œé€šè¿‡ `getSyncUrl` [[æŸ¥çœ‹](#getsyncurlè·å–éœ€è¦åŒæ­¥çš„-url)] è·å–å­åº”ç”¨è·¯ç”±
- å¦åˆ™æ²¡æœ‰é…ç½®åŒæ­¥è·¯ç”±ï¼Œæˆ–è€… `umd` åˆ‡æ¢åº”ç”¨ï¼Œéƒ½ä¼šä½¿ç”¨å­åº”ç”¨å…¥å£é“¾æ¥ä½œä¸ºè·¯ç”±

**ç¬¬äºŒæ­¥ï¼šæ¯”è¾ƒè·¯ç”±**

- å°†æ‹¿åˆ°çš„è·¯ç”±é€šè¿‡ `appRouteParse` [[æŸ¥çœ‹](#approuteparse-æå–é“¾æ¥)]ï¼Œè®¡ç®—å¾—åˆ° `appRoutePath` ä½œä¸ºæœ€ç»ˆé¢„æœŸçš„å­åº”ç”¨è·¯ç”±
- æ¯”è¾ƒ `appRoutePath` å’Œæœ€åˆä»æ²™ç®± `iframe` ä¸­æ‹¿åˆ°çš„ `pathname` + `search` + `hash` è¿›è¡Œæ¯”è¾ƒ
- å¦‚æœä¸åŒåˆ™é€šè¿‡ `iframeWindow.history.replaceState` è¿›è¡Œæ›¿æ¢è·³è½¬

#### `clearInactiveAppUrl`ï¼šæ¸…ç†è·¯ç”±

ç›®å½•ï¼š`sync.ts` - `clearInactiveAppUrl` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sync.ts#L72)]

æ¸…ç†éæ¿€æ´»æ€çš„å­åº”ç”¨åŒæ­¥å‚æ•°ï¼š

- é€šè¿‡ `anchorElementGenerator` å°†å½“å‰çš„é“¾æ¥è½¬æ¢ä¸ºä¸€ä¸ª `HTMLAnchorElement` å¯¹è±¡
- é€šè¿‡ `getAnchorElementQueryMap` å°†é“¾æ¥çš„ `search` è½¬åŒ–ä¸ºé”®å€¼å¯¹ [[æŸ¥çœ‹](#getanchorelementquerymap-è½¬åŒ–-urlsearch-ä¸ºé”®å€¼å¯¹è±¡)]

éå† `search` å¯¹è±¡æ‰€æœ‰çš„ `key`ï¼Œä½œä¸º `name` æå–å¹¶ç­›é€‰åº”ç”¨ï¼š

- åº”ç”¨å¿…é¡»å­˜åœ¨ï¼Œä¸”å·²ç» `start` å¯åŠ¨ã€å­˜åœ¨ `sync` åŒæ­¥è·¯ç”±ã€è·¯ç”±å…¨éƒ¨æ¥è‡ªåŸºåº§ã€ä¸”åº”ç”¨å·²æ¿€æ´»

å°†æ¡ä»¶åŒ¹é…çš„ `searchkey` å…¨éƒ¨åˆ é™¤ï¼Œç»„åˆæ–°çš„é“¾æ¥ï¼š

- å’Œå½“å‰é“¾æ¥è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœä¸ä¸€è‡´ `replace` æ›¿æ¢é“¾æ¥

#### `appRouteParse` æå–é“¾æ¥

ç›®å½•ï¼š`utils.ts` - `appRouteParse` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L122)]

å‚æ•°ï¼š

- `url`ï¼šå­—ç¬¦ç±»å‹çš„é“¾æ¥

æ ¹æ®ä¼ å…¥çš„é“¾æ¥æå– 3 ä¸ªå¯¹è±¡ï¼š

- `urlElement`ï¼šé€šè¿‡ `anchorElementGenerator` è½¬æ¢ `url` ä¸º `HTMLAnchorElement` å¯¹è±¡ [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]
- `appHostPath`ï¼šæ ¹æ®æä¾›çš„ `url` æå– `host`
- `appRoutePath`ï¼šåŒ…å«äº† `pathname` + `search` + `hash`

è°ƒç”¨åœºæ™¯æœ‰ 2 ä¸ªï¼š

- `WuJie` å®ä¾‹åˆå§‹åŒ–
- `syncUrlToIframe` åŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨

#### `anchorElementGenerator`ï¼šè½¬æ¢ `url`

å°† `url` è½¬æ¢ä¸º `HTMLAnchorElement` å¯¹è±¡

ç›®å½•ï¼š`utils.ts` - `anchorElementGenerator` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L138)]

å‚æ•°ï¼š

- `url`ï¼šé“¾æ¥ `string` ç±»å‹

è¿”å›ï¼š

- `HTMLAnchorElement` å¯¹è±¡

#### `getAnchorElementQueryMap` è½¬åŒ– `url.search` ä¸ºé”®å€¼å¯¹è±¡

ç›®å½•ï¼š`utils.ts` - `getAnchorElementQueryMap` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L145)]

å‚æ•°ï¼š

- `anchorElement`ï¼š`HTMLAnchorElement` ç±»å‹çš„å¯¹è±¡

æµç¨‹ï¼š

- å°† `url.search` æŒ‰ç…§ `&` æ‹†åˆ†æˆæ•°ç»„ï¼Œéå†å¹¶æ ¹æ® `=` æ‹†åˆ†æˆ `key` å’Œ `value`
- å¦‚æœ `key` å’Œ `value` éƒ½å­˜åœ¨è´£ä½œä¸ºé”®å€¼å¯¹æ·»åŠ åˆ°å¯¹è±¡
- æœ€åå°†æ·»åŠ çš„å¯¹è±¡è¿”å›ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•åŒ¹é…çš„é”®å€¼å¯¹ï¼Œè¿”å›ä¸€ä¸ªç©ºå¯¹è±¡

#### `getSyncUrl`ï¼šè·å–éœ€è¦åŒæ­¥çš„ `url`

ä»æå– `url.search` ä¸­é€šè¿‡åº”ç”¨åï¼Œæå–åº”ç”¨è·¯ç”±

ç›®å½•ï¼š`utils.ts` - `getSyncUrl` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L221)]

å‚æ•°ï¼š

- `id`ï¼šåº”ç”¨å
- `prefix`ï¼šçŸ­é“¾æ¥ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/sync.html#%E7%9F%AD%E8%B7%AF%E5%BE%84)]

è¿”å›ï¼š

- å­åº”ç”¨è·¯ç”±ï¼š`string`

æµç¨‹ï¼š

- æ‹¿åˆ° `url.search` é”®å€¼å¯¹ `queryMap`ï¼Œè§ï¼š`anchorElementGenerator` [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]ã€`getAnchorElementQueryMap` [[æŸ¥çœ‹](#getanchorelementquerymap-è½¬åŒ–-urlsearch-ä¸ºé”®å€¼å¯¹è±¡)]
- ä½¿ç”¨åº”ç”¨åæå– `queryMap` ä½¿ç”¨ `decodeURIComponent` è§£æè·¯ç”±ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨ç©ºå€¼
- æå–è·¯ç”±ä¸­çš„çŸ­é“¾ `validShortPath`ï¼Œè§ï¼š`syncUrlToWindow` [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)]
- å¦‚æœæä¾›çŸ­é“¾é›†åˆï¼Œå¹¶ä¸”æå–å‡ºçŸ­é“¾åï¼Œé€šè¿‡æå–çš„å€¼è¿”å›å­è·¯ç”±
- å¦åˆ™å°†è§£æçš„è·¯ç”± `syncUrl` ç›´æ¥è¿”å›

å­˜åœ¨çš„ `bug`ï¼š

- å³ä¾¿æä¾›äº†çŸ­é“¾é›†åˆï¼Œä¹Ÿå³ä¾¿ä»è·¯ç”±ä¸­æå–åˆ°äº†çŸ­é“¾åï¼Œä½†æ˜¯æœªå¿…çŸ­é“¾é›†åˆä¸­å°±å­˜åœ¨æå–çš„çŸ­é“¾å
- æœ‰å¯èƒ½å› ä¸ºåœ¨é›†åˆä¸­æ‰¾ä¸åˆ°çŸ­é“¾å `replace` ä¸ºä¸€ä¸ª `undefined` å­—ç¬¦

#### `getAbsolutePath`ï¼šè·å–ç»å¯¹è·¯å¾„

ç›®å½•ï¼š`utils.ts` - `getAbsolutePath` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L206)]

å‚æ•°ï¼š

- `url`ï¼šå¯ä»¥æ˜¯ `url`ã€`pathname`ã€`search`ã€`hash`ã€ç©ºå­—ç¬¦
- `base`ï¼šå‚è€ƒçš„ `url` æˆ– `host`
- `hash`ï¼šæå– `hash`ï¼Œå¯é€‰ `boolean` å€¼

è¿”å›æœ‰ 3 ä¸ªæƒ…å†µï¼š

- `url` æ˜¯ `pathname`ã€`search`ã€`hash`ï¼Œé€šè¿‡ `new URL` æŒ‰ç…§ `base` è¿”å›ç»å¯¹è·¯å¾„çš„é“¾æ¥
- `url` æ˜¯ä¸€ä¸ªç»å¯¹è·¯å¾„çš„é“¾æ¥ï¼Œé€šè¿‡ `new URL` ä¼šå¿½è§† `base`ï¼ŒåŸæ ·è¿”å› `url`
- å…¶ä»–æƒ…å†µç›´æ¥è¿”å› `url`ï¼ŒåŒ…æ‹¬ `hash` æ¨¡å¼

> å‚æ•° `hash` å­˜åœ¨çš„æ„ä¹‰åœ¨äº `url` æ˜¯ `hash` æ—¶ç›´æ¥è¿”å›è€Œä¸ç”¨åˆå¹¶ `base`

### æ˜ å°„è¡¨å’Œé˜Ÿåˆ—

#### ğŸ“ å…¨å±€æ˜ å°„è¡¨

#### 1. `idToSandboxCacheMap`ï¼šå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®

ç›®å½•ï¼š`common.ts` - `idToSandboxCacheMap` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L11)]

å…¨éƒ¨æ— ç•Œå®ä¾‹å’Œé…ç½®å­˜å‚¨ `map`ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰ï¼š

- ç±»å‹ï¼š`new Map<String, SandboxCache>()`ï¼Œåº”ç”¨åä¸º `key`ï¼Œå®ä¾‹ä¸º `SandboxCache`
- `SandboxCache` åŒ…å« 2 ä¸ªå±æ€§ï¼š`wujie`ï¼š`Wujie` ç±»çš„å®ä¾‹ï¼Œ`options`ï¼šæ¥è‡ª `setupApp` å­˜å‚¨çš„é…ç½®ä¿¡æ¯

æ·»åŠ æ˜ å°„è¡¨æœ‰ 2 ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ä¸ºï¼š

- `addSandboxCacheWithWujie`ï¼šæ”¶é›† `Wujie` å®ä¾‹å¯¹è±¡ï¼Œæ”¶é›†åœ¨æ¯ä¸ªæ˜ å°„å¯¹è±¡çš„ `wujie` å±æ€§ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L23)]
- `addSandboxCacheWithOptions`ï¼šæ”¶é›† `setupApp` è®¾ç½®åº”ç”¨ä¿¡æ¯ï¼Œæ”¶é›†åœ¨æ¯ä¸ªæ˜ å°„å¯¹è±¡çš„ `options` å±æ€§ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

ä½¿ç”¨ `addSandboxCacheWithWujie` åªæœ‰ 1 å¤„è°ƒç”¨ï¼›

- `Wujie` æ„é€ å‡½æ•°ï¼Œè§ï¼šæºç [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L532)]

åˆ›å»º `Wujie` å®ä¾‹æœ‰ 2 ä¸ªåœ°æ–¹ï¼š

- `preloadApp`ï¼šé¢„åŠ è½½ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/preloadApp.html)]
- `startApp`ï¼šå¯åŠ¨åº”ç”¨ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]

ä½¿ç”¨ `addSandboxCacheWithOptions` åªæœ‰ä¸€å¤„ï¼š

- `setupApp` ç¼“å­˜å­åº”ç”¨é…ç½®ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L179)]

ä»è¿™é‡Œå¯ä»¥çŸ¥é“ï¼š

- `preloadApp`ï¼šé¢„åŠ è½½å¯ä»¥æå¤§çš„æå‡å­åº”ç”¨é¦–æ¬¡æ‰“å¼€é€Ÿåº¦
- `startApp`ï¼šåªè¦åº”ç”¨åå’Œé“¾æ¥æ²¡å˜ï¼Œé€šè¿‡ç»„ä»¶é‡å¤æ’å…¥å­åº”ç”¨ä¸ä¼šé‡å¤åˆ›å»ºå®ä¾‹
- `setupApp`ï¼šå¯ä»¥é¢„å…ˆä¸º `startApp` å’Œ `preloadApp` æä¾›ä¿¡æ¯

> `startApp` è™½ç„¶æ¯æ¬¡éƒ½ä¼šä»æ˜ å°„è¡¨æ‹¿å–å®ä¾‹ï¼Œä½†å®ä¾‹åªè¦ä¸æ˜¯ `alive` æ¨¡å¼æˆ– `umd` æ¨¡å¼ï¼Œæ‰€æœ‰å®ä¾‹éƒ½ä¼šé€šè¿‡ `destroy` æ³¨é”€åé‡å»º

å®ä¾‹æ˜ å°„è¡¨åœ¨åº”ç”¨ä¸­å…·æœ‰å”¯ä¸€æ€§ï¼š

- å’Œ `appEventObjMap` ä¸€æ ·ï¼Œé€šè¿‡ `window.__WUJIE.inject.appEventObjMap` æŒ‡å‘ä¸Šä¸€çº§æ˜ å°„è¡¨ï¼Œè§ï¼šæ„é€ å‡½æ•° `inject` [[æŸ¥çœ‹](#1-inject-æ³¨å…¥å­åº”ç”¨-3-ä¸ªå¯¹è±¡)]

#### 2. `appEventObjMap`ï¼šå­˜å‚¨ `eventBus` æ‰˜ç®¡çš„äº‹ä»¶

ç›®å½•ï¼š`event.ts` - `appEventObjMap` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/event.ts#L7)]

å…¨éƒ¨äº‹ä»¶å­˜å‚¨ `map`ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰ï¼š

- ç±»å‹ï¼š`new Map<String, EventObj>()`ï¼Œå®ä¾‹åä¸º `key`ï¼Œç›‘å¬äº‹ä»¶ä¸º `EventObj`
- `key` åˆ†ä¸¤ç§æƒ…å†µï¼šåŸºåº§ä»¥æ—¶é—´å‘½åã€å­åº”ç”¨ä»¥å­åº”ç”¨å‘½å
- `EventObj`ï¼šæ˜¯ä¸€ä¸ªäº‹ä»¶é›†åˆï¼Œ`event_name` æ˜¯é”®åï¼Œé”®å€¼æ˜¯ç›‘å¬å‡½æ•°é›†åˆçš„æ•°ç»„

äº‹ä»¶æ˜ å°„è¡¨å…³è”æµç¨‹å›¾ï¼ˆç‚¹å¼€æ–°çª—å£æ”¾å¤§ç¼©å°æŸ¥çœ‹ç»†èŠ‚ï¼‰ï¼š

![äº‹ä»¶æ˜ å°„è¡¨å…³è”æµç¨‹å›¾](https://github.com/user-attachments/assets/0139adca-49bb-40e3-bbe3-87838db32be8)

å½“å­åº”ç”¨æ˜¯åµŒå¥—å…³ç³»çš„åŸºåº§æ—¶ï¼š

- å­åº”ç”¨çš„åŸºåº§ï¼Œä»¥åŠåŸºåº§ä¸‹çš„å­åº”ç”¨ä¼šé€šè¿‡ `window.__WUJIE.inject.appEventObjMap` æŒ‡å‘ä¸Šä¸€çº§æ˜ å°„è¡¨ï¼Œè§ï¼šæ„é€ å‡½æ•° `inject` [[æŸ¥çœ‹](#1-inject-æ³¨å…¥å­åº”ç”¨-3-ä¸ªå¯¹è±¡)]
- è¿™æ ·å°±ä¿è¯äº†æ•´ä¸ªæ˜ å°„è¡¨å‘ˆæ ‘çŠ¶ç»“æ„

ç®€å•ç†è§£ï¼š

- `appEventObjMap` é¡¶å±‚æ˜¯ä¸€ä¸ª `Map` å¯¹è±¡
- è¿™ä¸ªå¯¹è±¡ä¸ºé¡¶å±‚çš„åŸºåº§å’Œæ¯ä¸ªåº”ç”¨åˆ†é…ä¸€ä¸ª `Map item`
- å­åº”ç”¨æ— è®ºæ˜¯åº”ç”¨è¿˜æ˜¯åŸºåº§ï¼Œéƒ½é€šè¿‡ `inject` æŒ‡å‘å­åº”ç”¨åç§°å¯¹åº”çš„ `Map item`

å¦‚ä½•æ”¶é›†è®¢é˜…çš„ï¼š

- `EventBus` æ„é€ å‡½æ•°ä¸­ä½¿ç”¨ `key` ä»æ˜ å°„è¡¨æ‰¾å‡ºå¯¹åº”çš„äº‹ä»¶å¯¹è±¡ï¼Œæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªç©ºå¯¹è±¡ `{}`
- é€šè¿‡ `$on` å°†è¦ç›‘å¬çš„äº‹ä»¶åå’Œæ–¹æ³•ä»¥ `EventObj` çš„æ–¹å¼æ·»åŠ åˆ°äº‹ä»¶å¯¹è±¡ä¸­

å¦‚ä½•æ´¾å‘äº‹ä»¶ï¼š

- éå†æ‰€æœ‰çš„äº‹ä»¶å¯¹è±¡ï¼Œä»äº‹ä»¶å¯¹è±¡æ‰¾åˆ°è¦è§¦å‘çš„ç›‘å¬å‡½æ•°é›†åˆï¼Œæ·»åŠ åˆ°é˜Ÿåˆ— `cbs` æ•°ç»„ä¸­
- éå†å¹¶æ‰§è¡Œæ‹¿åˆ°çš„ç›‘å¬å‡½æ•°é›†åˆ `cbs`

ç¼ºç‚¹ï¼šäº‹ä»¶å¯¹è±¡åªæœ‰ 1 çº§

- ç”±äºå­åº”ç”¨æ˜¯é€šè¿‡ `inject` æ³¨å…¥é“¾ä¸€çº§çº§å¾€ä¸Šæ‰¾ï¼Œæ‰€ä»¥æ— è®ºå±‚çº§ï¼Œæœ€ç»ˆåªä¼šæœ‰ 1 çº§ç›‘å¬å¯¹è±¡
- ä¸è¿‡å¥½åœ¨åº”ç”¨å®ä¾‹ `idToSandboxCacheMap` ä¹Ÿåªæœ‰ 1 çº§ï¼Œå®ä¾‹åä¸èƒ½é‡å¤

å¸¦æ¥çš„é—®é¢˜ï¼š

- é—®é¢˜ 1ï¼šäº‹ä»¶é‡åé€ æˆé”™è¯¯è®¢é˜…ï¼Œå¦‚æœå­åº”ç”¨å¾ˆå¤šï¼Œå¯èƒ½å¾ˆéš¾ä¿è¯äº‹ä»¶çš„å”¯ä¸€æ€§
- é—®é¢˜ 2ï¼šåµŒå¥—è‡ªèº«ä½œä¸ºå­åº”ç”¨ï¼Œäº‹ä»¶è®¢é˜…ä¼šé€ æˆé‡å¤ç›‘å¬

è§£å†³åŠæ³•ï¼š

- é—®é¢˜ 1ï¼šè‡ªè¡Œä¸ºæ¯ä¸€ä¸ªç›‘å¬äº‹ä»¶åç§°åŠ ä¸Šè‡ªèº«åº”ç”¨åä½œä¸ºå‰ç¼€ï¼Œä½¿å…¶æˆä¸ºä¸€ä¸ªå‘½åç©ºé—´ï¼Œå¦‚ï¼š`{project_name}_{event_name}`
- é—®é¢˜ 2ï¼šè¿™æ˜¯ä¸ªæ— è§£çš„é—®é¢˜ï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯å°½é‡ä¸è¦å±‚å±‚æ½œé€ƒï¼Œå±‚å±‚åµŒå¥—åœ¨ `wujie` ä¸ä»…ä»…åªæ˜¯äº‹ä»¶é€šä¿¡å­˜åœ¨é—®é¢˜

é™¤æ­¤ä¹‹å¤–ï¼š

- `wujie` è¿˜æä¾›äº† `props` é€šä¿¡é€šä¿¡å’Œ `window` é€šä¿¡ï¼Œæ¥é¿å… `EventBut`æ‰¿è½½è¿‡å¤šï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/communication.html)]

#### ğŸ“ `Wujie` å®ä¾‹ä¸­æ˜ å°„è¡¨å’Œé˜Ÿåˆ—

æ‰€æœ‰å±æ€§åˆå§‹å’Œæ³¨é”€çŠ¶æ€è§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

#### 1. `execQueue` åº”ç”¨å¯åŠ¨æ‰§è¡Œé˜Ÿåˆ—

é˜Ÿåˆ—æ”¶é›†æ¥è‡ª 2 ä¸ªåŒºåŸŸï¼š

| æ‰€åœ¨ä½ç½®                                                                                                                                                                       | ç”¨é€”                                                                                                                |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------- |
| `rewriteAppendOrInsertChild` å…± 2 å¤„ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L158)] | æ”¶é›†æ¥è‡ªå­åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„å†…è”å’Œå¤–è” `script`                                                                       |
| `start` å…± 7 å¤„ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L251)]                     | æ”¶é›†é…ç½®æ–‡ä»¶æ‰‹åŠ¨æ’å…¥å’ŒåŒæ­¥åº”ç”¨ä¸­é™æ€ `script`ï¼Œæ´¾å‘äº‹ä»¶ï¼Œé€šçŸ¥ `start` å®Œæˆï¼Œè§ï¼šå¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)] |

> å¯¹äºåƒ `React` æˆ– `Vue` è¿™æ ·çš„ `SPA` åº”ç”¨ï¼Œ`script` æ˜¯é€šè¿‡åŠ¨æ€æ·»åŠ åˆ°åº”ç”¨ä¸­çš„ï¼Œéœ€è¦é€šè¿‡ `rewriteAppendOrInsertChild` æ¥æ”¶é›†

å€’æ¨æµç¨‹ï¼š

- `rewriteAppendOrInsertChild` æ¥è‡ª `patchRenderEffect`
- `patchRenderEffect` æœ‰ 2 å¤„ï¼š`renderTemplateToShadowRoot` [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]ã€`renderTemplateToIframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe)]
- æ¸²æŸ“å®¹å™¨çš„ 2 ä¸ªæ–¹æ³•éƒ½æ¥è‡ª `active` æ¿€æ´»åº”ç”¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]

ç”±æ­¤å¾—å‡ºå¯åŠ¨åº”ç”¨è¿‡ç¨‹æ—¶ï¼š

1.  é€šè¿‡ `active` æ¿€æ´»åº”ç”¨ï¼Œæ¸²æŸ“ `template` åˆ°å®¹å™¨
2.  é€šè¿‡ `patchRenderEffect` ç»™å®¹å™¨æ‰“è¡¥ä¸æ”¶é›†æ¥è‡ªåº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„ `script`
3.  å¯åŠ¨åº”ç”¨ `start`ï¼Œæ”¶é›†é…ç½®æ–‡ä»¶æ‰‹åŠ¨æ’å…¥å’ŒåŒæ­¥åº”ç”¨ä¸­é™æ€ `script`ã€æ´¾å‘äº‹ä»¶ç­‰

#### 2. `styleSheetElements` æ”¶é›†æ ·å¼è¡¨

æ•°ç»„ç±»å‹ï¼Œåˆ† 2 ä¸ªéƒ¨åˆ†ï¼š

- `patchCssRules`ï¼šå®ä¾‹æ–¹æ³•ï¼Œç”¨äºå­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]
- `rewriteAppendOrInsertChild`ï¼šæ”¶é›†æ¥è‡ªåº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„å†…è”å’Œå¤–è”æ ·å¼

åŠ è½½æµç¨‹å’Œ `execQueue` ç¨å¾®ä¸ä¸€æ ·ï¼š

1.  é¢„åŠ è½½åº”ç”¨æˆ–åˆæ¬¡å¯åŠ¨åº”ç”¨æ—¶é€šè¿‡ `processCssLoader` æ›¿æ¢åº”ç”¨ä¸­çš„é™æ€æ ·å¼ [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]ï¼Œè¿™éƒ¨åˆ†æ ·å¼ä¸ä¼šè¢«æ”¶é›†
2.  é€šè¿‡ `active` æ¿€æ´»åº”ç”¨ï¼Œæ¸²æŸ“ `template` åˆ°å®¹å™¨
3.  é€šè¿‡ `patchRenderEffect` ç»™å®¹å™¨æ‰“è¡¥ä¸æ”¶é›†æ¥è‡ªåº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„ `style`ï¼Œå¹¶å°†åŠ¨æ€æ ·å¼æ’å…¥å®¹å™¨
4.  `active` æ¿€æ´»æœ€å `shadowRoot` ä¸‹ä¼šéå†å®¹å™¨ä¸­æ‰€æœ‰ `style`ï¼Œæå–å¹¶è®°å½• `:root` æ ·å¼

é—®é¢˜ï¼š

- `styleSheetElements` å¹¶ä¸æ”¶é›†åº”ç”¨å†…çš„é™¤ `:root` ä»¥å¤–çš„é™æ€æ ·å¼
- è€Œæ˜¯æ¯æ¬¡æ¿€æ´»åº”ç”¨æ—¶é‡å¤æå–å¹¶åŠ è½½æ ·å¼ï¼Œè§ï¼š`importHTML` - 5. å­˜åœ¨çš„ 2 ä¸ªé—®é¢˜ [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- å½“ç„¶å¯ä»¥é€šè¿‡ `alive` æ¨¡å¼å’Œ `umd` æ¨¡å¼ï¼Œåœ¨åˆ‡æ¢åº”ç”¨æ—¶é¿å…é‡å¤åŠ è½½

#### 3. `elementEventCacheMap` è®°å½•é™çº§å®¹å™¨äº‹ä»¶

- è®°å½•æ–¹æ³•è§ï¼šè®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]

### è¿˜æ²¡æœ‰è§£å¼€çš„é—®é¢˜

è®°å½•è¿˜æ²¡æœ‰æ‰¾åˆ°ç­”æ¡ˆçš„ç–‘é—®ï¼Œå¾…åç»­æ·±å…¥ã€‚å¦‚æœæœ‰äººçŸ¥é“å¯ä»¥é€šè¿‡ `issue` å‘Šè¯‰æˆ‘

#### åŒæ—¶æ·»åŠ å…ƒç´ 

æ¥è‡ªï¼š

- `renderTemplateToShadowRoot` ä¸­ `shadowRoot.appendChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L221)]
- `renderTemplateToIframe` ä¸­ `renderDocument.replaceChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L261)]

ç°è±¡ï¼š

- é€šå¸¸ `appendChild` ç§»åŠ¨å…ƒç´ æ—¶å€™ï¼Œå…ƒç´ ä¹‹å‰çš„çˆ¶çº§å°†ä¼šè¢«æ¸…ç©º
- ä½†æ˜¯å½“æˆ‘å‘å®¹å™¨æ·»åŠ  `html` å…ƒç´ çš„æ—¶å€™ï¼Œæ²™ç®±ä¹Ÿä¼šä¸€æ¨¡ä¸€æ ·æ·»åŠ äº†ä¸€ä»½

å…ˆæƒ³åˆ°çš„çš„æ˜¯ `patchElementEffect`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L668)]

- é€šè¿‡åŠ«æŒ `ownerDocument` æ‰€æœ‰å…ƒç´ çš„ `ownerDocument` æŒ‡å‘ `iframeWindow.document`
- ä½†è¿™å’Œå®¹å™¨ `appendChild` æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

ç„¶åæˆ‘æƒ³å¯èƒ½æ˜¯ `cloneNode` æ‹·è´äº†å…ƒç´ å‰¯æœ¬ï¼š

- æŸ¥è¿‡æ‰€æœ‰æºç ï¼Œåªæœ‰ `replaceHeadAndBody` æœ‰ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L153)]
- ä½†å®ƒçš„ç”¨é€”ä»…ä»…æ˜¯ç”¨æ¥å¼•ç”¨ `template` ç”Ÿæˆçš„ `html` èµ„æº

æœ€åæˆ‘æƒ³åˆ°çš„å¯èƒ½æ˜¯ `proxy`ï¼š

- åœ¨ `proxyDocument` ä¼šä»£ç† `document` ä¸­ `createElement`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/proxy.ts#L94)]
- è€Œ `proxyDocument` ä¼šåœ¨ `patchDocumentEffect` éå†æŒ‡å®šçš„å±æ€§é›†åˆè¿›è¡ŒåŠ«æŒï¼Œå…±è®¡ 2 å¤„ï¼Œè§ï¼š[[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L513)]
- ä½†æ˜¯è¿™æ˜¯æ·»åŠ å…ƒç´ ï¼Œ`patchDocumentEffect` åŠ«æŒçš„å±æ€§ä¸å­˜åœ¨ `appendChild`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L42)]
- è€ŒåŠ«æŒ `createElement` ç›®çš„ä¹Ÿåªæ˜¯ä¸ºåŠ¨æ€åˆ›å»ºçš„å…ƒç´ é€šè¿‡ `patchElementEffect` æ‰“è¡¥ä¸

ç›®å‰èƒ½ç¡®å®šçš„æ˜¯ï¼š

- å‘ `shadowRoot` æ·»åŠ çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½ä¼šåœ¨æ²™ç®± `iframe` ä¸­ä¹Ÿæ·»åŠ ä¸€ä»½
- åŠ¨æ€æ·»åŠ çš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½ä¼šé€šè¿‡ `patchElementEffect` æ‰“è¡¥ä¸
