# micro-wujie-substrate

ä¸€ä¸ª `wujie` åŸºåº§ï¼Œå®Œæ•´å†…å®¹æŸ¥çœ‹å¾®å‰ç«¯ä¸»ä»“åº“ï¼šhttps://github.com/cgfeel/zf-micro-app

`wujie` å’Œ `qiankun`ã€`micro-app` çš„ä¸åŒè§£å†³æ–¹æ¡ˆï¼š

| å¯¹æ¯”é¡¹   | `wujie`                    | `micro-app`                | `wujie`             |
| -------- | -------------------------- | -------------------------- | ------------------- |
| æ¸²æŸ“å®¹å™¨ | `shadowDOM`ã€`iframe` å®¹å™¨ | `shadowDOM`ã€`iframe` å®¹å™¨ | `single-spa`        |
| `script` | æ²™ç®± `iframe`              | `proxy`ã€æ²™ç®± `iframe`     | `proxy`ã€å¿«ç…§ä¸­å®ç° |
| `css`    | æ¸²æŸ“å®¹å™¨                   | `scopedCSS`ã€æ¸²æŸ“å®¹å™¨      | `scopedCSS`         |

ä¼˜ç‚¹ï¼šå¤©ç„¶éš”ç¦»

- ç›´æ¥ä½¿ç”¨ `iframe`ï¼Œä¸éœ€è¦éå† `css` è®¡ç®— `scoped`

äº®ç‚¹ï¼š

- ç†è®ºä¸Š `wujie` å¯ä»¥æŠŠä»»ä½•å¯¹å¤–æä¾›è®¿é—®çš„ç½‘é¡µåšæˆå­åº”ç”¨
- å¯¹äºä¸æ”¯æŒ `proxy` å’Œ `shadowDOM` çš„æƒ…å†µæä¾› `iframe` é™çº§æ–¹æ¡ˆ

ç¼ºç‚¹ï¼š

- å¯¹ `React v18` å¹¶ä¸å‹å¥½ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šäº§ç”Ÿåè®®é”™è¯¯ï¼Œè§ï¼šissue [[æŸ¥çœ‹](https://github.com/Tencent/wujie/issues/672)]
- è·¯ç”±åŒæ­¥å¹¶ä¸å‹å¥½ï¼Œå­åº”ç”¨è·¯ç”±åªèƒ½é€šè¿‡ `search` åŒæ­¥åˆ°ç½‘é¡µé“¾æ¥ä¸­å›½ï¼Œä¸èƒ½ä½¿ç”¨ `pathname`

ç–‘æƒ‘ï¼š`wujie` é¢‘ç¹æ“ä½œ `Dom` ç›´æ¥å½±å“ `js` æ€§èƒ½

- æ¯”å¦‚è¯´é»˜è®¤çš„é‡å»ºæ¨¡å¼ä¸‹ï¼Œ`wuijie` æ¯æ¬¡åˆ‡æ¢åº”ç”¨å°±æ˜¯ä¸€æ¬¡æ³¨é”€å’Œé‡å»º

æ¸²æŸ“åŸç†ï¼š

| åˆ†ç±»        | åŸç†                                                                        |
| ----------- | --------------------------------------------------------------------------- |
| `wujie`     | æ‹‰å– `template` æ”¾å…¥ `shadowRoot`ï¼Œå°†å®¹å™¨æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹                     |
| `micro-app` | åˆ›å»º `web component` æ‹‰å–èµ„æºï¼Œæ›¿æ¢æ ‡ç­¾ä¸ºè‡ªå®šä¹‰ç»„ä»¶ï¼Œç”± `Dom tree` æ¸²æŸ“ç»„ä»¶ |
| `qiankun`   | åŸºäº `single-spa`ï¼Œæ‹‰å– `template`ï¼ŒåŠ«æŒ `url` ç»è¿‡è®¡ç®—å°†èµ„æºæ¸²æŸ“åˆ°æŒ‡å®šå®¹å™¨ |

> `micro-app` ä¹Ÿæ”¯æŒ `shadowDom` å’Œ `iframe` æ²™ç®±ï¼Œä½†éœ€è¦åœ¨ `start` æ—¶æ‰‹åŠ¨å¯ç”¨

æ€»ç»“åˆ†æˆ 3 ä¸ªéƒ¨åˆ†ï¼š

- `wujie` ä½¿ç”¨ [[æŸ¥çœ‹](#wujie-ä½¿ç”¨)]
- `wujie` å¤ç° [[æŸ¥çœ‹](#wujie-å¤ç°)]
- `wujie` åŸç† [[æŸ¥çœ‹](#wujie-åŸç†)]

> é¡¹ç›®å…¨éƒ¨æ•´åˆåœ¨ï¼š`/wujie` [[æŸ¥çœ‹](https://github.com/cgfeel/zf-micro-app/tree/main/wujie)]

## `wujie` ä½¿ç”¨

åŒ…å«é¡¹ç›®ï¼š

- `react-project`ï¼šé€šè¿‡ `create-react-app` æ­å»ºçš„å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra)]
- `static-project`ï¼šè‡ªå®šä¹‰é™æ€åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static)]
- `substrate`ï¼šé€šè¿‡ `create-react-app` æ­å»ºçš„åŸºåº§ä¸»åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate)]
- `vue-project`ï¼šé€šè¿‡ `vue-cli` æ­å»ºçš„å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-vue3)]

### æ­å»ºåŸºåº§ä¸»åº”ç”¨

å…ˆå›é¡¾ä¸‹ `micro-app` åŸºåº§æµç¨‹ï¼š

- å…¥å£æ–‡ä»¶ `start` é…ç½®å¯åŠ¨é¡¹
- æŒ‡å®šé¡µé¢æ’å…¥è‡ªå®šä¹‰ç»„ä»¶ `<micro-app />`

> `micro-app` ä¼šå°†åŠ è½½çš„èµ„æºæ³¨å…¥ `web component`

`wujie` å¯ä»¥ä¸ä½¿ç”¨ `start` è®¾ç½®å…¥å£é…ç½®ï¼š

- åˆ›å»ºä¸€ä¸ªå…¬å…±çš„ç»„ä»¶ `Wujie.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/components/Wujie.tsx)]
- é€šè¿‡ `startApp` å¯åŠ¨å­åº”ç”¨å¹¶æŒ‚è½½åˆ°æŒ‡å®šçš„ `ref` èŠ‚ç‚¹ï¼Œè§ï¼š`startApp` [[æŸ¥çœ‹](#startapp-å¯åŠ¨æµç¨‹)]
- é€šè¿‡è°ƒç”¨ç»„ä»¶çš„æ–¹å¼åŠ è½½å­åº”ç”¨ï¼Œä¾‹å¦‚: `react` å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/ReactPage.tsx)]

> `wujie` ä¸éœ€è¦é€šè¿‡ `start` å¼ºåˆ¶é…ç½®å¯åŠ¨ï¼Œä½†æä¾› `setupApp` ç”¨æ¥ç¼“å­˜é…ç½®ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

ç å³°çš„è¯¾ç¨‹ä¸­æœ‰ä¸ªé”™è¯¯ï¼š

- å®˜æ–¹æ–‡æ¡£ä¸å»ºè®®æ‰‹åŠ¨æ³¨é”€ `destroyApp` å­åº”ç”¨ï¼Œå¦‚æœè¿˜éœ€è¦ä½¿ç”¨å­åº”ç”¨çš„è¯ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/destroyApp.html)]
- `startApp` ä¼šè¿”å›ä¸€ä¸ªæ–¹æ³• `destroy`ï¼Œå¯ä»¥ç›´æ¥ç”¨äºæ³¨é”€åº”ç”¨ï¼Œè€Œä¸ç”¨ä¼ ç»™ `destroyApp`ï¼ŒåŒæ ·ä¹Ÿä¸å»ºè®®ä¸»åŠ¨æ³¨é”€ï¼Œä¼šå¯¼è‡´ä¸‹æ¬¡æ‰“å¼€è¯¥å­åº”ç”¨æœ‰ç™½å±æ—¶é—´

### æ­å»ºå­åº”ç”¨

ä¿®æ”¹å­åº”ç”¨ï¼š

- `react`ï¼šé€šè¿‡ `.env` ä¿®æ”¹ç«¯å£å· [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra/blob/main/.env)]
- `vue`ï¼šé…ç½® `vue.config.js` å…è®¸ `cors` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-vue3/blob/main/vue.config.js)]

å¯é€‰ï¼šå¯¹äº `umd` æ¨¡å¼åŠ è½½åº”ç”¨

- `global.d.ts`ï¼šæ·»åŠ å…¨å±€ç±»å‹å£°æ˜ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra/blob/main/src/global.d.ts)]
- å…¥å£æ–‡ä»¶æš´éœ² `__WUJIE_MOUNT` å’Œ `__WUJIE_UNMOUNT` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra/blob/main/src/index.tsx)]

é€šè¿‡ä»¥ä¸Šäº†è§£åˆæ­¥å°è±¡æ˜¯ï¼š`Tencent` å¯¹é€šä¿¡éå¸¸åçˆ±

- æ¯”å¦‚ï¼šåº”ç”¨å’ŒåŸºåº§é€šä¿¡ï¼Œæ²™ç®±å’Œå®¹å™¨ `Dom` é€šä¿¡ã€`proxy` å’Œæ²™ç®± `window` é€šä¿¡ç­‰ç­‰
- é™¤æ­¤ä¹‹å¤–åœ¨å…¶å®ƒäº§å“ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œæ¯”å¦‚ï¼šå°ç¨‹åº `postMessage`ï¼Œè¿˜æœ‰ `alloy-worker` [[æŸ¥çœ‹](https://github.com/AlloyTeam/alloy-worker)]

## `wujie` å¤ç°

ç®€å•å®ç° `iframe` å’Œ `shadowRoot` é€šä¿¡ï¼Œè¯¦ç»†è§é¡¹ç›®ä¸­çš„æºç ï¼š

- é¡¹ç›®ï¼š`static-project` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static)]
- æ–‡ä»¶ï¼š`ifram2shadow-dom.html` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static/blob/main/ifram2shadow-dom.html)]
- è¿è¡Œæ–¹å¼ï¼šç›´æ¥ç‚¹å¼€æµè§ˆå™¨é¢„è§ˆã€æˆ– `http-server`

æ•´ä½“åˆ† 4 éƒ¨åˆ†ï¼š

- `index.html`ï¼šåŸºåº§ `html` æ–‡ä»¶
- `template`ï¼šå­åº”ç”¨è¦è¿è¡Œçš„ `css` å’Œ `html`ï¼Œè¦æ”¾å…¥ `shadowDOM` ä¸­
- `strScript`ï¼šå­åº”ç”¨è¦æ‰§è¡Œçš„è„šæœ¬å­—ç¬¦ï¼Œè¦æ”¾å…¥ `iframe` ä¸­
- `createCustomElement`ï¼šä¸»åº”ç”¨è‡ªå®šä¹‰ç»„ä»¶

`createCustomElement` æµç¨‹åˆ† 4 éƒ¨åˆ†ï¼š

1. `createSandbox`ï¼šåˆ›å»ºæ²™ç®±
2. `attachShadow`ï¼šåˆ›å»º `shadowRoot`
3. `injectTemplate`ï¼šå°† `css` å’Œ `html` æ³¨å…¥ `shadowRoot`
4. `runScriptInSandbox`ï¼šå°† `js` æ³¨å…¥ `iframe`

å®¹å™¨åˆ† 2 ä¸ªï¼š

- `shadowRoot`ï¼šç›´æ¥å°† `css` å’Œ `html` å…¨éƒ¨æ‰“åŒ…åˆ° `div` æ³¨å…¥ `shadowRoot`
- `iframe`ï¼šåˆ›å»ºä¸€ä¸ª `script` å…ƒç´ ï¼Œå°†æ‰§è¡Œçš„ `js` ä½œä¸ºå…ƒç´ å†…å®¹æ³¨å…¥ `iframe` çš„ `head`

åœ¨ `script` æ·»åŠ åˆ° `iframe` ä¹‹å‰ï¼š

- éœ€è¦åœ¨ `script` ä¸­åŠ«æŒ `Dom` æŸ¥è¯¢æ–¹æ³•ï¼Œå°†ä¸Šä¸‹æ–‡æŒ‡å‘ `shadowRoot`

æµç¨‹ï¼š

- é€šè¿‡ `Object.defineProperty` åŠ«æŒ `iframe.contentWindow.Document.prototype.querySelector`
- è¿”å›ä¸€ä¸ª `Proxy` å¯¹è±¡ï¼Œä»£ç† `sandbox.shadowRoot.querySelector`
- åœ¨ `Proxy` ä¸­é€šè¿‡ `apply` çº æ­£ä¸Šä¸‹æ–‡ `this` æŒ‡å‘ `shadowRoot`

`Object.defineProperty` åŠ«æŒå¯¹è±¡ä¼šæ‰§è¡Œä¸¤æ¬¡ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static/blob/d89ae52aa0418d9f7e3cec8ff289cd8dd5edbb1e/index.html#L80)]

ç¬¬ä¸€æ¬¡ï¼šç”± `iframe` ä¸­çš„å­åº”ç”¨å‘èµ· `document.querySelector`

- é€šè¿‡ `Object.defineProperty` åŠ«æŒ `Dom` æŸ¥è¯¢æ–¹æ³•å¹¶è¿”å› `Proxy` å¯¹è±¡
- åœ¨ `Proxy` å¯¹è±¡é¦–æ¬¡ `apply` æ—¶ï¼Œå‚æ•° `thisArgs` æŒ‡å‘åŠ«æŒçš„å¯¹è±¡ `iframeWindow.Document.prototype`
- è¿”å› `thisArgs.querySelector` ç›¸å½“äº `iframeWindow.Document.prototype.querySelector.apply(sandbox.shadowRoot, args)`
- é€šè¿‡ `apply` å°†ä¸Šä¸‹æ–‡æŒ‡å‘ `sandbox.shadowRoot`

ç¬¬äºŒæ¬¡ï¼šç”±äº `Proxy` å¯¹è±¡å†æ¬¡è°ƒç”¨äº† `iframe` çš„ `querySelector`ï¼Œäºæ˜¯å†æ¬¡ `Object.defineProperty`

- æ­¤æ—¶è¿”å›çš„ `Proxy` å¯¹è±¡æ–¹æ³• `apply` ä¸­ `thisArgs` æŒ‡å‘ `sandbox.shadowRoot`
- è¿”å› `thisArgs.querySelector` ç›¸å½“äºï¼š`sandbox.shadowRoot.querySelector.apply(sandbox.shadowRoot, args)`
- ç”±äºè¿™æ¬¡æ˜¯é€šè¿‡ `sandox` å‘èµ· `querySelector`ï¼Œå°†ä¸å†è¢« `iframe` åŠ«æŒ

> å¯ä»¥æ‰“å¼€è°ƒè¯•çª—å£ `sources` åœ¨ `Proxy` å¯¹è±¡çš„ `apply` æ–¹æ³•ä¸­æ‰“ä¸Šæ–­ç‚¹ï¼Œåˆ·æ–°æŸ¥çœ‹æ¯æ¬¡æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ `thisArgs` çš„å˜åŒ–

åŠ«æŒå¯¹è±¡åœºæ™¯å‘æ•£ï¼š

- æµ®çª—ï¼šåŠ«æŒ `shadowRoot` ä¸‹çš„ `body`ï¼Œåˆ›å»º `Dom` å¯¹è±¡æ·»åŠ åˆ° `body` ä¸‹
- `iframe` ä¸­ `history` å¯¹è±¡ï¼šå®ç°åŒæ­¥åŒæ­¥ [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)]

> è¿™éƒ¨åˆ†å°†é€šè¿‡ `wujie` æºç è§£è¯»åœ¨ä¸‹æ–¹æ€»ç»“

## `wujie` åŸç†

å’Œ `qiankun` è§£è¯»ä¸€æ ·ï¼Œä¸ºäº†ä¾¿äºé˜…è¯»ä»¥å®˜æ–¹ç‰ˆæœ¬ `9733864b0b5e27d41a2dc9fac216e62043273dd3` ä¸ºå‡† [[æŸ¥çœ‹](https://github.com/Tencent/wujie/tree/9733864b0b5e27d41a2dc9fac216e62043273dd3)]

> æ€»ç»“ä¸­é“¾æ¥æŒ‡å‘ç›¸å…³æºç å’Œæ–‡æ¡£ï¼Œæ¯æ¡ä¿¡æ¯éƒ½æä¾›äº†å…³é”®è¯ï¼Œå¯ä»¥æ‰“å¼€é“¾æ¥å¤åˆ¶å¹¶æœç´¢å…³é”®è¯ï¼ŒæŸ¥çœ‹ä¸Šä¸‹æ–‡å¯¹ç…§ç†è§£ã€‚

`wujie` æä¾›äº† 4 ä¸ªåŒ…ï¼Œåˆ†åˆ«ä¸º [[æŸ¥çœ‹](https://github.com/Tencent/wujie/tree/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages)]ï¼š

- `wujie-core`ï¼šæ ¸å¿ƒä»£ç  [[æŸ¥çœ‹](#å®šä¹‰-web-component)]
- `wujie-react`ï¼š`React` å°è£…ç»„ä»¶ [[æŸ¥çœ‹](#packages---wujie-react)]
- `wujie-vue2`ï¼š`Vue2` å°è£…ç»„ä»¶
- `wujie-vue3`ï¼š`Vue3` å°è£…ç»„ä»¶

> å°è£…çš„åŒ…æ˜¯ä½œä¸ºå¯é€‰ä½¿ç”¨çš„å•ä¸ªç»„ä»¶ï¼Œç›®å‰ä¸æä¾› `vue` ç»„ä»¶æ€»ç»“

ç”±äºæ€»ç»“ä¼šå¾ˆé•¿ï¼Œæ‰€ä»¥æˆ‘å°†æ•´ä¸ªæµç¨‹æ€»ç»“ç²¾ç®€æ”¾åœ¨å‰é¢ï¼š

1. `preloadApp` é¢„åŠ è½½ï¼ˆå¯é€‰ï¼‰[[æŸ¥çœ‹](#preloadapp-é¢„åŠ è½½æµç¨‹)]
2. `startApp` æ ¹æ®å®ä¾‹æƒ…å†µå†³å®šåˆå§‹åŒ–è¿˜æ˜¯åˆ‡æ¢åº”ç”¨ [[æŸ¥çœ‹](#startapp-å¯åŠ¨æµç¨‹)]
3. é¦–æ¬¡å¯åŠ¨å’Œåˆ‡æ¢é‡å»ºæ¨¡å¼çš„åº”ç”¨ï¼Œä¼š `destroy` é”€æ¯åé‡æ–°åˆå§‹åŒ– [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]
4. å£°æ˜å®ä¾‹ï¼Œåˆ›å»ºæ²™ç®± `iframe`ã€`proxy` ä»£ç†ã€`EventBus` é€šä¿¡ç­‰ [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]
5. `importHTML` åŠ è½½èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
6. `processCssLoader` å¤„ç† `css-loader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
7. `active` æ¿€æ´»åº”ç”¨ï¼šå°† `template` æ³¨å…¥å®¹å™¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
8. `start` å¯åŠ¨åº”ç”¨ï¼šå°† `script` æ³¨å…¥æ²™ç®± `iframe`ï¼Œå‘èµ·é€šçŸ¥äº‹ä»¶å’Œ `mount` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
9. è¿”å› `destroy` ä»¥ä¾¿æ‰‹åŠ¨é”€æ¯ [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]

é˜…è¯»å»ºè®®ï¼Œå¦‚æœä½ åšå¥½å‡†å¤‡é˜…è¯»ä»¥ä¸‹å†…å®¹ï¼Œè¿™æ ·å¯ä»¥æé«˜æ•ˆç‡ï¼š

- é“¾æ¥æŒ‡å‘æºç æˆ–ç›¸å…³è¯´æ˜ï¼Œè®°å½•ä¸­ç½—åˆ—äº†å…³é”®è¯ï¼Œå¯ä»¥é€šè¿‡å¤åˆ¶æŸ¥æ‰¾å®šä½
- å»ºè®®æŒ‰ç…§æµç¨‹çº¿å»é˜…è¯»

æ¯”å¦‚è¯´ï¼š

- é¦–æ¬¡åŠ è½½åº”ç”¨ï¼šä» `startApp` å¼€å§‹ï¼Œå¿½ç•¥å·²å­˜åœ¨åº”ç”¨å®ä¾‹çš„æƒ…å†µï¼Œåªçœ‹é¦–æ¬¡åˆ›å»ºå®ä¾‹
- åˆ‡æ¢åº”ç”¨ï¼šä» `startApp` å¼€å§‹ï¼Œåªçœ‹å­˜åœ¨åº”ç”¨å®ä¾‹çš„æƒ…å†µ
- é¢„åŠ è½½ï¼šä» `preloadApp` å¼€å§‹çœ‹

### å®šä¹‰ `web component`

`wujie` å’Œ `micro-app` ç»„ä»¶å®šä¹‰ä¸åŒå¤„ï¼š

| åˆ†ç±»                       | `micro-app`                                                                                                                                                                                       | `wujie`                                                                                                                             |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| æŒ‚è½½æ–¹å¼                   | æ‰‹åŠ¨æŒ‚è½½ `web component` åˆ°æŒ‡å®š `components tree` ä¸­æ¸²æŸ“                                                                                                                                          | è‡ªåŠ¨æŒ‚è½½ï¼Œ`active` æ¿€æ´»åº”ç”¨æ—¶é€šè¿‡ `createWujieWebComponent` åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶ï¼ŒæŒ‚è½½åˆ°æŒ‡å®šå®¹å™¨ [[æŸ¥çœ‹](#42-æŒ‚è½½å­åº”ç”¨åˆ‡æ¢åˆå§‹åŒ–é¢„åŠ è½½)] |
| è‡ªå®šä¹‰ç»„ä»¶å               | æ”¯æŒ                                                                                                                                                                                              | ä¸æ”¯æŒ                                                                                                                              |
| æ¥å—çš„å±æ€§                 | `name`ã€`url`ã€`iframe` ç­‰é…ç½®ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://micro-zoe.github.io/micro-app/docs.html#/zh-cn/configure?id=%e9%85%8d%e7%bd%ae%e9%a1%b9)]                                                | ä»…æ”¯æŒ `WUJIE_APP_ID` [[æŸ¥çœ‹](#7-æ¿€æ´»åº”ç”¨çš„è¡¥å……)]                                                                                   |
| `attributeChangedCallback` | æ£€æŸ¥å­åº”ç”¨ `name` å’Œ `url` å±æ€§å˜æ›´ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#11-attributechangedcallback-%E8%A7%82%E5%AF%9F%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9)] | ä¸æ”¯æŒï¼Œä½†æ˜¯å­åº”ç”¨çš„ `name` å’Œ `url` å¯ä»¥ä½œä¸º `React` ç»„ä»¶çš„ `props`ï¼Œæ›´æ–°åé‡æ–°æ¸²æŸ“å¹¶æŒ‚è½½åˆ°å®¹å™¨                                    |
| `connectedCallback`        | ä½¿ç”¨ç»„ä»¶è‡ªå¢ç¼–å·æ·»åŠ å½“å‰ç»„ä»¶åˆ°æ˜ å°„è¡¨ï¼Œå¹¶å‘èµ·åº”ç”¨æŒ‚è½½                                                                                                                                              | æ ¹æ®åº”ç”¨åæ‹¿åˆ°å®ä¾‹ï¼Œæ‰“è¡¥ä¸åå°† `shadowRoot` ç»‘å®šåˆ°å®ä¾‹ä¸­ [[æŸ¥çœ‹](#connectedcallbackæŒ‚è½½ç»„ä»¶)]                                       |
| `disconnectedCallback`     | ç”¨ç»„ä»¶ç¼–å·ä»æ˜ å°„è¡¨ä¸­ä¸‹çº¿ç»„ä»¶ï¼Œå¹¶å‘èµ·åº”ç”¨å¸è½½                                                                                                                                                      | æ ¹æ®åº”ç”¨åæ‹¿åˆ°å®ä¾‹å¹¶å‘èµ·å¸è½½ [[æŸ¥çœ‹](#disconnectedcallback-å¸è½½ç»„ä»¶)]                                                               |
| è‡ªå®šä¹‰æ›´æ–°ç»„ä»¶             | è§„åˆ™ç»„ä»¶å†…éƒ¨å®šä¹‰å¥½äº†ï¼Œåªæ¥å— `name` å’Œ `url` çš„å˜æ›´åˆ™                                                                                                                                             | ä¸€æ—¦æ›´æ–°åº”ç”¨å°±ä¸€å®šæ˜¯é‡æ–°æ¸²æŸ“                                                                                                        |
| ç»„ä»¶ç”¨é€”                   | åº”ç”¨é€šä¿¡ã€èµ„æºå®¹å™¨ã€æ´¾å‘äº‹ä»¶ã€å†³å®šå¯åŠ¨å’Œæ³¨é”€æ–¹å¼                                                                                                                                                  | èµ„æºå®¹å™¨                                                                                                                            |
| ä¼˜ç‚¹                       | å¼ºå¤§                                                                                                                                                                                              | ç®€å•ï¼Œå‡ ä¹ä¸ç”¨å…³å¿ƒ `web component`                                                                                                  |
| ç¼ºç‚¹                       | åŠŸèƒ½ä¸Šåˆ†å·¥ä¸æ¸…æ™°ï¼Œ`MicroAppElement` å¤„ç†å®Œä¹‹å `CreateApp` è¿˜è¦åšä¸€éå¯¹åº”æ“ä½œï¼Œå¦‚ï¼šç»„ä»¶å’Œåº”ç”¨åˆ†åˆ« `mount`                                                                                         | å¾ˆç²—æš´ï¼Œåªå­˜åœ¨æŒ‚è½½å’Œå¸è½½ï¼Œä¸€æ—¦æ›´æ–°å°±ä¸€å®šæ˜¯é”€æ¯åé‡æ–°æŒ‚è½½ï¼Œæ•ˆç‡ä¸é«˜                                                                  |

#### å…³äº `defineWujieWebComponent`

ç›®å½•ï¼š`shadow.ts` - `defineWujieWebComponent` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L39)]

å£°æ˜ `WujieApp` è‡ªå®šä¹‰ç»„ä»¶ï¼Œåœ¨å…¥å£æ–‡ä»¶ä¸­é»˜è®¤æ‰§è¡Œ [[æŸ¥çœ‹](#definewujiewebcomponent-å®šä¹‰è‡ªå®šä¹‰ç»„ä»¶)]

- å› æ­¤åœ¨é¡¹ç›®ä¸­å¼•å…¥ `wujie` çš„æ—¶å€™å°±å·²ç»å®šä¹‰äº† `web component`

#### `connectedCallback`ï¼šæŒ‚è½½ç»„ä»¶

- è®¾ç½® `shadowRoot` æ¨¡å¼ä¸º `open`
- é€šè¿‡ `getWujieById` ä½¿ç”¨å±æ€§ `WUJIE_APP_ID` æ‹¿åˆ°åº”ç”¨å®ä¾‹ï¼Œè§ï¼š`idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]
- é€šè¿‡ `patchElementEffect` ä¸º `shadowRoot` æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]
- å°† `shadowRoot` ç»‘å®šåˆ°å®ä¾‹ä¸Š

å‡ ä¸ªæ¦‚å¿µåè¯ï¼š

- `web component`ï¼šé€šè¿‡ `WujieApp` å®šä¹‰çš„ç»„ä»¶ï¼Œè¿™é‡Œå®šä¹‰çš„ç»„ä»¶åæ˜¯ `wujie-app`
- `shadowRoot`ï¼š`shadowDom` çš„æ ¹èŠ‚ç‚¹ï¼Œä¸ä¹‹ç›¸ä¼¼æœ‰ `document` æ˜¯ `Dom` çš„æ ¹èŠ‚ç‚¹
- `shadowRoot.host`ï¼šè¿”å› `shadowRoot` é™„åŠ åˆ° `Dom` å…ƒç´ çš„å¼•ç”¨ï¼Œå³ï¼š`web component`
- `shadowRoot.host.parentElement`ï¼š`web component` çš„çˆ¶èŠ‚ç‚¹ï¼Œç”¨äºè·å– `shadowRoot` æŒ‚è½½èŠ‚ç‚¹
- `shadowRoot.firstChild`ï¼š`shadowRoot` ä¸‹ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨ `wujie` ä¸­æ˜¯ `html` å…ƒç´ 
- `documet.documentElement`ï¼š`document` ä¸‹çš„æ ¹å…ƒç´ ï¼Œå¦‚ï¼š`html` å…ƒç´ 

> ä»¥ä¸Šå‡ ä¸ªå¯¹è±¡å°†ä¼šåœ¨ `wujie` ä¸­é«˜é¢‘å‡ºç°

#### `disconnectedCallback` å¸è½½ç»„ä»¶

- é€šè¿‡ `getWujieById` ä½¿ç”¨å±æ€§ `WUJIE_APP_ID` æ‹¿åˆ°åº”ç”¨å®ä¾‹ï¼Œè§ï¼š`idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]
- å‘èµ·å¸è½½æ“ä½œï¼Œè§ï¼š`unmount` [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]

### `startApp` å¯åŠ¨æµç¨‹

ç›®å½•ï¼š`index.ts` - `startApp` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L185)]

åˆ† 3 æ­¥ï¼š

1. è·å–ã€æ›´æ–°é…ç½®ä¿¡æ¯
2. å­˜åœ¨æ²™ç®±å®ä¾‹å°±åˆ‡æ¢æˆ–é”€æ¯åº”ç”¨
3. ä¸å­˜åœ¨æ²™ç®±å®ä¾‹æˆ–è¢«é”€æ¯çš„åº”ç”¨ï¼Œåˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹

è¿è¡Œåº”ç”¨åˆ†ä¸º 3 ä¸ªæ¨¡å¼ï¼š

- `alive` ä¿æ´»æ¨¡å¼ï¼šå¯åŠ¨å’Œåˆ‡æ¢åº”ç”¨ä¸ä¼šé”€æ¯å®ä¾‹ [[æŸ¥çœ‹](#21-alive-ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨)]
- `umd` å•ä¾‹æ¨¡å¼ï¼šåˆ‡æ¢åº”ç”¨æ—¶é€šè¿‡ `window.__WUJIE_MOUNT` é‡æ–°æ¸²æŸ“ [[æŸ¥çœ‹](#22-umd-æ¨¡å¼åˆ‡æ¢åº”ç”¨)]
- é‡å»ºæ¨¡å¼ï¼šåˆ›å»ºåº”ç”¨å‰ï¼Œå¦‚æœå­˜åœ¨åº”ç”¨å®ä¾‹ä¼šå°†å…¶å…ˆæ³¨é”€ï¼Œè§ï¼š`destroy` [[æŸ¥çœ‹](#23-destroy-æ³¨é”€åº”ç”¨)]

æœ‰å…³ `wujie` çš„è¿è¡Œæ¨¡å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/mode.html)]

![`wujie` çš„è¿è¡Œæ¨¡å¼](https://github.com/cgfeel/micro-wujie-substrate/assets/578141/c4473f5d-9845-4df4-bac6-4506f8202a3d)

å¤‡æ³¨ï¼š

- `umd` åœ¨æ–‡æ¡£ä¸­ç§°ä¸ºå•ä¾‹æ¨¡å¼ï¼Œä¸ºäº†å’Œ `qiankun`ã€`micro-app` å¯¹é½ï¼Œä»¥ä¸‹ç»Ÿç§° `umd` æ¨¡å¼
- å¦‚æœåœ¨åˆ‡æ¢åº”ç”¨æ—¶çœ‹åˆ°ç¬é—´ç™½å±ï¼Œå»ºè®®ä½¿ç”¨ `alive` æ¨¡å¼æˆ– `umd` æ¨¡å¼

#### 1. è·å–åº”ç”¨å®ä¾‹å’Œé…ç½®

ä»æ˜ å°„è¡¨ `idToSandboxCacheMap` è·å–å·²è®°å½•çš„å®ä¾‹å’Œé…ç½® [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]ï¼š

- `getWujieById`ï¼šä½¿ç”¨åº”ç”¨åè·å–åº”ç”¨å®ä¾‹ï¼Œä¸å­˜åœ¨è¿”å› `null`
- `getOptionsById`ï¼šä½¿ç”¨åº”ç”¨åè·å–å·²ç¼“å­˜çš„é…ç½®ï¼Œä¸å­˜åœ¨è¿”å› `null`

> é…ç½®åªèƒ½é€šè¿‡ `setupApp` ç¼“å­˜ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

åˆå¹¶å¹¶æå–é…ç½®ï¼š

- é€šè¿‡ `mergeOptions` åˆå¹¶å‚æ•°æä¾›çš„é…ç½®å’Œç¼“å­˜çš„é…ç½®
- è§£æ„å¹¶æå–å¿…è¦çš„é…ç½®ï¼Œå…³äºé…ç½®è§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]

#### 2. å­˜åœ¨åº”ç”¨å®ä¾‹ï¼Œè¿è¡Œæˆ–é”€æ¯åº”ç”¨

åº”ç”¨åœºæ™¯ï¼š

| æ¨¡å¼    | é¢„åŠ è½½åå¯åŠ¨ | é¢„æ‰§è¡Œåå¯åŠ¨ | åˆ‡æ¢åº”ç”¨ |
| ------- | ------------ | ------------ | -------- |
| `alive` | è¿è¡Œ         | è¿è¡Œ         | è¿è¡Œ     |
| `umd`   | é”€æ¯         | è¿è¡Œ         | è¿è¡Œ     |
| é‡å»º    | é”€æ¯         | é”€æ¯         | é”€æ¯     |

> æ²¡æœ‰é¢„åŠ è½½åˆæ¬¡ `startApp` ä¸å­˜åœ¨åº”ç”¨å®ä¾‹ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½å¿…é¡»åˆ›å»ºå®ä¾‹ [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)]

æ¸²æŸ“å‰çš„å‡†å¤‡ï¼š

- é€šè¿‡ `getPlugins` æ›´æ–°å®ä¾‹çš„ `plugins`ï¼Œè§ï¼šç‰¹æ®Šå±æ€§ - `plugins` æ’ä»¶é›†åˆ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)]
- è·å–æ²™ç®± `window` ç”¨äºè·å–å­åº”ç”¨æŒ‚è½½æ–¹æ³• `__WUJIE_MOUNT`ï¼Œä¸å­˜åœ¨åˆ™ä¸º `undefined`
- å¦‚æœæ˜¯é¢„åŠ è½½å `startApp`ï¼Œéœ€è¦ç­‰å¾… `runPreload` æ‰§è¡Œå®Œæ¯• [[æŸ¥çœ‹](#3-é¢„åŠ è½½å¾®ä»»åŠ¡-runpreload)]

#### 2.1 `alive` ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨

å’Œ `micro-app` çš„ `keep-alive` æ¨¡å¼ä¸€æ ·ï¼š

- ä¼˜ç‚¹ï¼šåˆ‡æ¢è·¯ç”±ä¸é”€æ¯åº”ç”¨å®ä¾‹ï¼Œè·¯ç”±ã€çŠ¶æ€ä¸ä¼šä¸¢å¤±ï¼Œåœ¨æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æƒ…å†µä¸‹ï¼Œå‡å°‘ç™½å±æ—¶é—´
- ç¼ºç‚¹ï¼šå¤šä¸ªèœå•æ è·³è½¬åˆ°å­åº”ç”¨çš„ä¸åŒé¡µé¢ï¼Œä¸åŒèœå•æ æ— æ³•è·³è½¬åˆ°æŒ‡å®šå­åº”ç”¨è·¯ç”±

**ç¬¬ä¸€æ­¥ï¼š`active` æ¿€æ´»åº”ç”¨**

- å°† `shadowRoot.host` æŒ‚è½½åˆ°æŒ‡å®š `el` èŠ‚ç‚¹ï¼Œè§ï¼šåˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]
- ç”±äº `alive` æ¨¡å¼ä¸ä¼šé”€æ¯å®¹å™¨ï¼Œæ‰€ä»¥æ¿€æ´»æ—¶ä¹Ÿä¸éœ€è¦æ³¨å…¥èµ„æºï¼Œè§ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]

**ç¬¬äºŒæ­¥ï¼š`start` åº”ç”¨**

é¢„åŠ è½½ä½†æ˜¯æ²¡æœ‰ `exec` é¢„æ‰§è¡Œçš„æƒ…å†µä¸‹éœ€è¦ `start` åº”ç”¨ï¼š

- è°ƒç”¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ `beforeLoad`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#beforeload)]
- é€šè¿‡ `importHTML` æå–éœ€è¦åŠ è½½çš„ `script` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- å°†æå–çš„æ–¹æ³• `getExternalScripts` ä¼ å…¥ `sandbox.start` å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

é¢„åŠ è½½ååŠ è½½çš„èµ„æºå·²æ³¨å…¥å®¹å™¨ï¼Œå¯åŠ¨æ—¶ä¸ç”¨é‡æ–°æ³¨å…¥ï¼Œä½† `importHTML` å­˜åœ¨é‡å¤è°ƒç”¨ï¼š

- ç„¶è€Œåº”ç”¨ä¸­çš„é™æ€èµ„æºå·²æå‰åŠ è½½ï¼Œä¸å—é‡å¤è°ƒç”¨å†æ¬¡è¯·æ±‚ï¼Œè§ï¼šèµ„æºç¼“å­˜é›†åˆ [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]

**ç¬¬ä¸‰æ­¥ï¼š`alive` åŠ è½½å®Œæˆ**

- è°ƒç”¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ `activated` å¹¶è¿”å›å­åº”ç”¨æ³¨é”€å‡½æ•° `sandbox.destroy`
- è¿™é‡Œå­˜åœ¨ `activated` è°ƒç”¨ 2 æ¬¡çš„æƒ…å†µï¼Œè§ï¼š6.é¢„åŠ è½½ä¸­çš„ `bug` [[æŸ¥çœ‹](#6é¢„åŠ è½½ä¸­çš„-bug)]

#### 2.2 `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨

é€šè¿‡ `umd` åˆ‡æ¢åº”ç”¨çš„æ¡ä»¶ï¼š

- å­åº”ç”¨å­˜åœ¨ `__WUJIE_MOUNT` æ–¹æ³•æŒ‚è½½åˆ°æ²™ç®± `window`
- åŒ…å«ï¼šé€šè¿‡ `exec` é¢„æ‰§è¡Œå `startApp`ï¼Œæˆ–å®Œæˆé¦–æ¬¡ `startApp` åæ¯æ¬¡åˆ‡æ¢å›åº”ç”¨

**ç¬¬ä¸€æ­¥ï¼šé‡æ–°åŠ è½½èµ„æº**

`unmount` å¸è½½åº”ç”¨ [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]ï¼š

- æ¸…ç©ºå®¹å™¨ã€æ¸…ç†è·¯ç”±å’Œäº‹ä»¶ï¼Œå°†åº”ç”¨è¿˜åŸè‡³åˆå§‹çŠ¶æ€
- å¦åˆ™ `active` æ—¶å¯èƒ½ä¼šå¯¹å®¹å™¨ä¸­çš„å…ƒç´ é‡å¤ç›‘å¬äº‹ä»¶ï¼Œè§ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]

`active` æ¿€æ´»åº”ç”¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]ï¼š

- æ— è®ºæ˜¯ `preloadApp` å·²åŠ è½½è¿‡èµ„æºï¼Œè¿˜æ˜¯åˆ‡æ¢åº”ç”¨ï¼Œå®¹å™¨éƒ½ä¼šåœ¨ `unmount` æ—¶æ¸…ç©º
- æ¿€æ´»åº”ç”¨æ—¶ä¼šå†æ¬¡åŒæ­¥è·¯ç”±ï¼Œå¹¶é‡æ–°å°†èµ„æºæ³¨å…¥å®¹å™¨

`rebuildStyleSheets` æ¢å¤åŠ¨æ€åŠ è½½å’Œæ‰“è¡¥ä¸çš„æ ·å¼ [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]ï¼š

- `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨åï¼Œåªè§¦å‘ `__WUJIE_MOUNT` å‡½æ•°æŒ‚è½½åº”ç”¨
- åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ ä»¥åŠæ‰“è¡¥ä¸çš„æ ·å¼éœ€è¦é€šè¿‡ `styleSheetElements` æ”¶é›†å¹¶æ¢å¤ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]
- å®Œæ•´çš„æ ·å¼åŠ è½½æµç¨‹ï¼Œè§ï¼šåº”ç”¨ä¸­çš„æ ·å¼å¦‚ä½•åŠ è½½ [[æŸ¥çœ‹](#5-åº”ç”¨ä¸­çš„æ ·å¼å¦‚ä½•åŠ è½½)]

**ç¬¬äºŒæ­¥ï¼šæŒ‚è½½åº”ç”¨**

å’Œ `mount` æŒ‚è½½ `umd` æ¨¡å¼çš„åº”ç”¨æ˜¯ä¸€æ ·çš„ï¼Œè§ï¼š`umd` æ–¹å¼å¯åŠ¨ [[æŸ¥çœ‹](#1-umd-æ–¹å¼å¯åŠ¨)]

- æŒ‚è½½å‰ä½¿ç”¨æ²™ç®± `window` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `beforeMount`
- æŒ‚è½½åº”ç”¨ï¼Œä»æ²™ç®± `window` è°ƒç”¨å­åº”ç”¨ `__WUJIE_MOUNT`
- æŒ‚è½½åä½¿ç”¨æ²™ç®± `window` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `afterMount`
- æ¿€æ´» `mountFlag` è¡¨æ˜å·²æŒ‚è½½ï¼Œé¿å…é‡å¤æŒ‚è½½ï¼Œç„¶åè¿”å› `destroy` æ³¨é”€æ–¹æ³• [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]

#### 2.3 `destroy` æ³¨é”€åº”ç”¨

- æµç¨‹è§ï¼š`WuJie` åº”ç”¨ç±»çš„ `destroy` æ–¹æ³• [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]
- æ³¨é”€åº”ç”¨çš„åœºæ™¯è§ï¼šå­˜åœ¨åº”ç”¨å®ä¾‹ï¼Œè¿è¡Œæˆ–é”€æ¯åº”ç”¨ - åº”ç”¨åœºæ™¯è¡¨æ ¼ [[æŸ¥çœ‹](#2-å­˜åœ¨åº”ç”¨å®ä¾‹è¿è¡Œæˆ–é”€æ¯åº”ç”¨)]

æ¡ä»¶åŒ¹é…çš„åº”ç”¨ä¼šæ³¨é”€å·²ç¼“å­˜å®ä¾‹åï¼Œå†é‡æ–°åˆ›å»ºæ–°å®ä¾‹ï¼š

- åŒ…æ‹¬é‡æ–°æå–èµ„æºã€æ›¿æ¢èµ„æºã€è½¬å˜ä¸º `html` æ³¨å…¥å®¹å™¨ï¼ŒæŒ‚è½½å®¹å™¨ï¼Œç­‰ä¸€ç³»åˆ—æ“ä½œ
- å› æ­¤å¯èƒ½ä¼šå¯¼è‡´çŸ­æš‚ç™½å±çš„ç°è±¡ï¼Œè¦é¿å…è¿™ç§æƒ…å†µå»ºè®®ä½¿ç”¨ `alive` æˆ– `umd` æ¨¡å¼

> æ³¨é”€åº”ç”¨åå†æ¬¡åˆ›å»ºå®ä¾‹ï¼Œä¼šä¼˜å…ˆä½¿ç”¨ç¼“å­˜æå–å¹¶åŠ è½½èµ„æº [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]

#### 3. åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹

è¿™ä¸€è¿‡ç¨‹å’Œ `preloadApp` é¢„åŠ è½½åº”ç”¨æµç¨‹æ˜¯ä¸€æ ·çš„ [[æŸ¥çœ‹](#preloadapp-é¢„åŠ è½½æµç¨‹)]ï¼š

| æµç¨‹               | æè¿°                                                                                                                 | `preloadApp`                   | `startApp`                                                               |
| ------------------ | -------------------------------------------------------------------------------------------------------------------- | ------------------------------ | ------------------------------------------------------------------------ |
| `addLoading`       | å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ  `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]                                                       | ä¸éœ€è¦                         | éœ€è¦                                                                     |
| `sandbox`          | é€šè¿‡ `WuJie` å£°æ˜å®ä¾‹ï¼Œè§ï¼š`constructor` [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]                                            | éœ€è¦                           | éœ€è¦                                                                     |
| `beforeLoad`       | ä¼ é€’æ²™ç®± `window` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/lifecycle.html#beforeload)] | éœ€è¦                           | éœ€è¦                                                                     |
| `importHTML`       | æå–åº”ç”¨èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]                                                                          | éœ€è¦                           | éœ€è¦                                                                     |
| `processCssLoader` | å¤„ç† `css-loader`ï¼Œå¹¶æ›´æ–°å·²æå–çš„èµ„æº [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]                                     | éœ€è¦                           | éœ€è¦                                                                     |
| `active`           | æ¿€æ´»åº”ç”¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]                                                                                 | éœ€è¦                           | é™¤äº†é¢„åŠ è½½æä¾›çš„å‚æ•°å¤–ï¼Œè¿˜åŒ…æ‹¬ï¼š`sync` åŒæ­¥è·¯ç”±ã€`el` æŒ‚è½½å®¹å™¨           |
| `start`            | å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]                                                                                  | ä»…åœ¨æä¾› `exec` é¢„åŠ è½½æ—¶æ‰æ‰§è¡Œ | éœ€è¦                                                                     |
| `destroy`          | è¿”å›æ³¨é”€æ–¹æ³• [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]                                                                            | ä¸è¿”å›                         | ä»…åœ¨ `start` æ­£å¸¸æƒ…å†µä¸‹è¿”å›ï¼Œè§ï¼š`bug` [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)] |

#### 4. `startApp` çš„ `bug`

åŒæ ·é€‚ç”¨äº `preloadApp`ï¼šå¯åŠ¨æˆ–é¢„åŠ è½½åº”ç”¨æ—¶ä¸æä¾› `name` å’Œ `url` æ€ä¹ˆå¤„ç†ï¼Ÿ

> è™½ç„¶åœ¨ `ts` ä¸­å·²å´æ˜è¦æ±‚ä¸ºå¿…å¡«å‚æ•°ï¼Œä½†å¦‚æœ `ignore` å¼ºåˆ¶å¿½ç•¥æˆ–æä¾›ç©ºå­—ç¬¦æ€ä¹ˆåŠï¼Ÿ

`micro-app` ä¸­åªæœ‰éƒ½ç¬¦åˆè¦æ±‚æ‰å¼€å§‹æŒ‚è½½ç»„ä»¶ï¼š

- åœ¨ `defineElement` çš„ `attributeChangedCallback` ä¸­æ£€æŸ¥ `name` å’Œ `url` ä¸¤ä¸ªå±æ€§

#### 5. åº”ç”¨ä¸­çš„æ ·å¼å¦‚ä½•åŠ è½½

| åˆ†ç±»                  | åŠ è½½æ–¹å¼                                                                                           | åœºæ™¯                                        |
| --------------------- | -------------------------------------------------------------------------------------------------- | ------------------------------------------- |
| åº”ç”¨å†…çš„é™æ€æ ·å¼      | `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]                                      | `preloadApp`ã€é¦–æ¬¡ `startApp` åˆå§‹åŒ–å®ä¾‹    |
| æ‰‹åŠ¨é…ç½® `css-loader` | `processCssLoaderForTemplate` [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)]                   | `alive` æ¨¡å¼é¦–æ¬¡æ¿€æ´»ã€å…¶å®ƒæ¨¡å¼æ¯æ¬¡æ¿€æ´»      |
| åº”ç”¨å†…çš„åŠ¨æ€æ ·å¼      | `rewriteAppendOrInsertChild` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)] | `alive` å’Œ `umd` é¦–æ¬¡æ¿€æ´»ã€é‡å»ºæ¨¡å¼æ¯æ¬¡æ¿€æ´» |
| `umd` æ¨¡å¼æ¢å¤æ ·å¼    | `rebuildStyleSheets` [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]                                   | åˆ‡æ¢ `umd` åº”ç”¨ã€`umd` é¢„æ‰§è¡Œåå¯åŠ¨         |

> åŠ è½½çš„é¡ºåºä»ä¸Šè‡³ä¸‹ï¼Œå•ä¾‹åº”ç”¨æ˜¯é€šè¿‡åŠ¨æ€åŠ è½½æ ·å¼çš„

åˆ‡æ¢åº”ç”¨æ—¶å¦‚ä½•åŠ è½½æ ·å¼ï¼š

- `alive` æ¨¡å¼ï¼šåˆ‡æ¢åº”ç”¨ä¸ä¼šé”€æ¯å®ä¾‹ï¼Œæ‰€ä»¥ä¸‹æ¬¡æ¿€æ´»æ—¶ä¸ç”¨é‡å¤åŠ è½½æ ·å¼
- `umd` æ¨¡å¼ï¼šåˆ‡å›åº”ç”¨æ—¶é€šè¿‡ `__WUJIE_MOUNT` æ¸²æŸ“ï¼Œä¹‹å‰åŠ è½½çš„æ ·å¼éœ€è¦è°ƒç”¨ `rebuildStyleSheets` æ¢å¤ [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]
- é‡å»ºæ¨¡å¼ï¼šæ¯æ¬¡å¯åŠ¨éƒ½ä¼šé‡æ–°æ³¨å…¥æ ·å¼

> `umd` ä¸å­˜åœ¨åˆæ¬¡åŠ è½½ï¼Œå’Œé‡å»ºæ¨¡å¼ä¸€æ ·éƒ½éœ€è¦å®ä¾‹åˆå§‹åŒ–åæ¿€æ´»åº”ç”¨ï¼ŒåŠ¨æ€åŠ è½½æ ·å¼

#### 6. åº”ç”¨ä¸­çš„ `script` åœ¨å“ªé‡ŒåŠ è½½

- `start`ï¼šé€šè¿‡ `execQueue` é˜Ÿåˆ—åŠ è½½ï¼š`js-loader`ã€å­åº”ç”¨é™æ€ `script` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
- `rewriteAppendOrInsertChild`ï¼šåŠ¨æ€æ·»åŠ  `chunk script` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

> åŠ è½½é¡ºåºä»ä¸Šè‡³ä¸‹ï¼šå•ä¾‹åº”ç”¨å…¥å£ `script` é€šè¿‡ `start` æ³¨å…¥æ²™ç®±ï¼Œç„¶ååŠ¨æ€åŠ è½½ `chunk script`

åˆ‡æ¢åº”ç”¨æ—¶å¦‚ä½•åŠ è½½ `script`ï¼š

- `alive` æ¨¡å¼ï¼šåˆ‡æ¢åº”ç”¨ä¸ä¼šé”€æ¯å®ä¾‹ï¼Œåˆ‡å›åº”ç”¨æ—¶ä¸ç”¨é‡å¤åŠ è½½ `script`
- `umd` æ¨¡å¼ï¼š`unmount` å¸è½½åº”ç”¨æ—¶åªæ¸…ç©º `shadowRoot` ä¸æ¸…ç©ºæ²™ç®±ï¼Œåˆ‡å›åº”ç”¨æ—¶ä¸ç”¨é‡å¤åŠ è½½ `script`
- é‡å»ºæ¨¡å¼ï¼šæ¯æ¬¡å¯åŠ¨éƒ½ä¼šé‡æ–°æ³¨å…¥ `script`

> `degrade` é™çº§æ—¶ `umd` æ¨¡å¼ä¸æ¸…ç©ºå®¹å™¨ï¼Œå› ä¸º `iframe` ç§»åŠ¨åäº‹ä»¶è‡ªåŠ¨é”€æ¯ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰

### `preloadApp` é¢„åŠ è½½æµç¨‹

ç›®å½•ï¼š`index.ts` - `preloadApp` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L282)]

å‚æ•°ï¼š`preOptions`ï¼Œè§å®˜æ–¹æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/preloadApp.html)]

`preloadApp` é¢„åŠ è½½é€šè¿‡å®ä»»åŠ¡ `requestIdleCallback` ç©ºé—²æ—¶å¤„ç†ï¼Œä¸å¤„ç†çš„æƒ…å†µæœ‰ 2 ä¸ªï¼š

- åº”ç”¨å®ä¾‹å·²å­˜åœ¨ï¼Œè¯´æ˜å·²åŠ è½½è¿‡äº†
- å½“å‰ç½‘å€ `search` ä¸­èƒ½å¤Ÿæ‰¾åˆ°é¢„åŠ è½½çš„åº”ç”¨åï¼Œæ­¤æ—¶éœ€è¦ç›´æ¥åŠ è½½

> ç›¸åŒåº”ç”¨ä¸èƒ½é‡å¤é¢„åŠ è½½ï¼Œå¦åˆ™ä¼šé€ æˆè¯¯åˆ¤ï¼Œå¦‚ï¼š`active` æ—¶ `shadowRoot` å­˜åœ¨ä½†æ‰¾ä¸åˆ° `el` æŒ‚è½½ç‚¹

#### 1. è·å–é…ç½®

- é€šè¿‡ `getOptionsById` è·å–é…ç½®ä¿¡æ¯ `cacheOptions`
- é€šè¿‡ `mergeOptions` åˆå¹¶å‚æ•° `preOptions` å’Œ `cacheOptions`ï¼Œä¼˜å…ˆé‡‡ç”¨ `preOptions`
- ä»åˆå¹¶çš„ `options` ä¸­æå–é…ç½®ç”¨äºé¢„åŠ è½½

> é…ç½®ä¿¡æ¯åªèƒ½é€šè¿‡ `setupApp` ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜åˆ™è¿”å› `null`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

#### 2. å£°æ˜ä¸€ä¸ªå®ä¾‹

- å°†æ‹¿åˆ°çš„é…ç½®ä¿¡æ¯é€šè¿‡ `Wujie` å£°æ˜å®ä¾‹ `sandbox`
- é€šè¿‡ `runPreload` ä¸ºå®ä¾‹æŒ‚èµ·ä¸€ä¸ªå¾®ä»»åŠ¡ `preload`

> å¾®ä»»åŠ¡æŒ‚è½½åœ¨å®ä¾‹ä¸Š `sandbox.preload`ï¼Œåœ¨ `startApp` æ—¶ä¼šé€šè¿‡ `await` ç¡®ä¿é¢„åŠ è½½å·²å®Œæˆæ‰èƒ½ç»§ç»­åŠ è½½åº”ç”¨ï¼Œè¿™ç§æ–¹å¼å’Œ `qiankun` ä¸­çš„ `frameworkStartedDefer` åŸç†æ˜¯ä¸€æ ·çš„

#### 3. é¢„åŠ è½½å¾®ä»»åŠ¡ `runPreload`

- ä½¿ç”¨æ²™ç®± `window` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `beforeLoad`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/lifecycle.html#beforeload)]
- é€šè¿‡ `importHTML` è·å–åº”ç”¨èµ„æºï¼Œæ­¤æ—¶èµ„æºä¸­çš„æ ·å¼å’Œ `script` éƒ½æ›¿æ¢æˆæ³¨é‡Š [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- é€šè¿‡ `processCssLoader` å¤„ç† `css-loader` å¹¶åŠ è½½èµ„æºä¸­çš„é™æ€æ ·å¼æ›¿æ¢å¯¹åº”æ³¨é‡Š [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
- æ¿€æ´»åº”ç”¨ `active` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
- æ ¹æ®é…ç½® `exec` å†³å®šæ˜¯å¦å¯åŠ¨åº”ç”¨ `start` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

é»˜è®¤ `exec` ä¸ä¼šé¢„æ‰§è¡Œï¼š

- ä» `importHTML` æå– `getExternalScripts` å¹¶æ‰§è¡Œï¼Œè§ï¼šå‘æŒ¥çš„ä½œç”¨ [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- é€šè¿‡ `await` ä¼šå°†æ­¤å‰å·²ç»æäº¤å¾®ä»»åŠ¡çš„é˜Ÿåˆ—ä½œä¸ºä¸Šä¸‹æ–‡åŒæ­¥ä»»åŠ¡æ‰§è¡Œ

#### 4. å¯¹æ¯” `startApp` çš„é…ç½®

å¯¹æ¯”æ–‡æ¡£ä¼šå‘ç° `preloadApp` çš„é…ç½®å’Œ `startApp` å·®åˆ«æŒºå¤§ï¼š

- ä½†æ˜¯å¯ä»¥é€šè¿‡ `setupApp` æå‰ç¼“å­˜é…ç½®ï¼Œæ‰€ä»¥å•çº¯ä»æ–‡æ¡£å¯¹æ¯”å°±å¤±å»æ„ä¹‰äº†
- ä»å£°æ˜å®ä¾‹æ¯”è¾ƒï¼Œ`preloadApp` å’Œ `startApp` æä¾›çš„å‚æ•°æ˜¯ä¸€æ ·çš„
- åªæœ‰ `active` æ¿€æ´»åº”ç”¨æ—¶å‚æ•°å„æœ‰ä¸åŒ

é¢„åŠ è½½ç¼ºå°‘ `loading`ï¼š

- é¢„åŠ è½½çš„åº”ç”¨ä¸éœ€è¦ `loading`ï¼Œè€Œ `startApp` ä¼šé€šè¿‡ `addLoading` åˆ›å»º `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]
- æœ‰æ²¡æœ‰ `loading` å°†ä¼šå†³å®š `renderElementToContainer` æ³¨å…¥èµ„æºæ—¶æ˜¯å¦æ¸…ç©ºæŒ‚è½½èŠ‚ç‚¹ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]

é¢„åŠ è½½ä¸éœ€è¦æä¾›æŒ‚è½½å®¹å™¨ `el`ï¼š

- æ²™ç®±çš„ `iframe` å°†ä½œä¸ºä¸´æ—¶çš„å®¹å™¨ï¼Œåº”ç”¨ä¼šåœ¨ `active` æ¿€æ´»æ—¶æ³¨å…¥æ²™ç®±
- è€Œæ²™ç®± `iframe` åœ¨é¡µé¢ä¸­æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤ä¹Ÿçœ‹ä¸åˆ°é¢„åŠ è½½çš„åº”ç”¨

> `startApp` æ—¶ä¼šé€šè¿‡ `active` ä»æ²™ç®±ä¸­é”€æ¯å®¹å™¨ï¼Œæˆ–å–å‡ºæŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ï¼Œè§ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]

å¼•å‘äº†ä¸€ä¸ªæ€è€ƒï¼š

- æŠŠæ‰€æœ‰çš„å­åº”ç”¨å…¨éƒ¨é¢„åŠ è½½åˆ° `iframe` ä¸­ï¼Œä¼šä¸ä¼šå¯¹åŸºåº§çš„ `document` äº§ç”Ÿå½±å“
- ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå¯¹æ­¤åšäº†ä¸€ä¸ªæµ‹è¯•ï¼š10w è¡¨å•åœ¨ä¸åŒå®¹å™¨ä¸‹çš„è¡¨ç° [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/xxoVLXx)]

#### 5. é€šè¿‡ `exec` é¢„æ‰§è¡Œ

- ä»… `preloadApp` æ”¯æŒçš„é…ç½®é¡¹ï¼Œ`exec` ä¼šåœ¨é¢„åŠ è½½æ—¶å¯åŠ¨åº”ç”¨ `start`
- å’Œ `startApp` ä¸€æ ·ï¼Œä¹Ÿä¼šå°†å­åº”ç”¨ä¸­çš„ `script` æ’å…¥æ²™ç®± `iframe`ï¼Œè°ƒç”¨ `mount` ç­‰ç›¸å…³äº‹ä»¶å’Œæ–¹æ³•

åœ¨ `micro-app` ä¸­ä¹Ÿæœ‰é¢„åŠ è½½ï¼ŒåŒºåˆ«åœ¨äºï¼š

| åˆ†ç±»                         | `micro-app`                                                  | `wujie`                                                      |
| ---------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| åŠ è½½æ–¹å¼                     | é€šè¿‡ `start` é…ç½® `preFetchApps`ï¼Œæˆ–é€šè¿‡ `microApp.preFetch` | åªèƒ½é€šè¿‡ `preloadApp`                                        |
| ä»…åŠ è½½é™æ€èµ„æº               | æ”¯æŒ                                                         | ä¸æ”¯æŒ                                                       |
| å°†è½½é™æ€èµ„æºè§£ææˆå¯æ‰§è¡Œä»£ç  | è§£æå¹¶å¤„ç†èµ„æºï¼Œä¸æ¸²æŸ“                                       | é™¤äº† `script` å’ŒåŠ¨æ€åŠ è½½çš„æ ·å¼ï¼Œå…¨éƒ¨æ³¨å…¥å®¹å™¨æš‚å­˜æ²™ç®±ä¸­ä¸å¯è§ |
| æ‰§è¡Œä»£ç å¹¶åœ¨åå°æ¸²æŸ“         | æ”¯æŒ                                                         | `active` æ³¨å…¥èµ„æºï¼Œ`start` å¯åŠ¨åº”ç”¨                          |
| å…³é—­æ²™ç®±å’Œæ ·å¼ä½œç”¨åŸŸ         | å¯é€‰                                                         | ä¸æ”¯æŒ                                                       |
| å…³é—­å­åº”ç”¨è¯·æ±‚çš„è‡ªåŠ¨è¡¥å…¨     | å¯é€‰                                                         | ä¸æ”¯æŒ                                                       |

- `micro-app` é¢„åŠ è½½å‚è€ƒï¼Œè§ï¼š`microApp.start` - æ³¨ â‘¥ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#microappstart-%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8)]
- `micro-app` é¢„æ‰§è¡Œä¸»è¦ä½“ç°åœ¨æ²™ç®±å¯¹é¢„æ¸²æŸ“çš„å¤„ç†ï¼Œè§ï¼š`WithSandBox` é»˜è®¤æ²™ç®± - é¢„æ¸²æŸ“éƒ¨åˆ† [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#23-withsandbox-%E9%BB%98%E8%AE%A4%E6%B2%99%E7%AE%B1)]

#### 6.é¢„åŠ è½½ä¸­çš„ `bug`

**é—®é¢˜ 1ï¼š`activated` é‡å¤è°ƒç”¨**

é¢„åŠ è½½ `alive` æ¨¡å¼çš„åº”ç”¨ï¼Œé»˜è®¤ `exec` ä¸é¢„æ‰§è¡Œï¼Œåœ¨å¯åŠ¨åº”ç”¨æ—¶ç”Ÿå‘½å‘¨æœŸ `activated` ä¼šè°ƒç”¨ 2 æ¬¡ï¼š

- `start` åº”ç”¨æ—¶é˜Ÿåˆ—æ‰§è¡Œ `mount` è°ƒç”¨ 1 æ¬¡
- `start` ä¹‹åè¿”å› `destroy` å‰è°ƒç”¨ 1 æ¬¡

**é—®é¢˜ 2ï¼šç¼ºå¤±å¿…è¦çš„å‚æ•°æ£€æŸ¥**

- è§ï¼š`startApp` çš„ `bug` [[æŸ¥çœ‹](#4-startapp-çš„-bug)]

#### 7.é¢„åŠ è½½çš„æ„ä¹‰

é¢„åŠ è½½ä¼˜åŒ–æœ‰ 4 ç‚¹ï¼š

1. æå‰ç¼“å­˜åº”ç”¨å…¥å£èµ„æºï¼ŒåŠ è½½å¹¶ç¼“å­˜èµ„æºä¸­çš„æ ·å¼å’Œ `script` [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]
2. æå‰å°† `template` æ³¨å…¥æ²™ç®± `body` ä½œä¸ºä¸´æ—¶å®¹å™¨ï¼Œè§ï¼šåˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]
3. æå‰å°† `script` æ³¨å…¥æ²™ç®± `head`ï¼Œè§ï¼š`start` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
4. æå‰æ”¶é›†æ ·å¼å…ƒç´ æ‰“è¡¥ä¸ï¼Œè§ï¼š`styleSheetElements` [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]

ä¸åŒæ¨¡å¼ä¸‹é¢„åŠ è½½å¯¹åº”çš„ä¼˜åŒ–ç‚¹ï¼š

| æ¨¡å¼    | é¢„åŠ è½½ | é¢„æ‰§è¡Œ  |
| ------- | ------ | ------- |
| `alive` | 1ã€2   | 1ã€2ã€3 |
| `umd`   | 1      | 1ã€3ã€4 |
| é‡å»º    | 1      | 1       |

`umd` æ¨¡å¼é¢„åŠ è½½è¡¥å……è¯´æ˜ï¼š

- å’Œé‡å»ºæ¨¡å¼ä¸€æ ·ï¼Œé¢„åŠ è½½å `startApp` ä¼šé”€æ¯å®ä¾‹ï¼Œåªèƒ½ç”¨äºæå‰ç¼“å­˜èµ„æº
- é¢„æ‰§è¡Œå `startApp` ä¼šæ¸…ç©ºå®¹å™¨é‡æ–°æ³¨å…¥èµ„æº
- åªæœ‰ `umd` éœ€è¦ç”¨åˆ° `styleSheetElements` æ¢å¤æ ·å¼ï¼Œå…¶å®ƒæ¨¡å¼åªè®°å½•ä¸ä½¿ç”¨

é™¤æ­¤ä¹‹å¤–å¯ä»¥é€šè¿‡ `setupApp` æå‰ç¼“å­˜é…ç½®ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

- è¿™æ ·é¿å…é¢„åŠ è½½å’Œå¯åŠ¨åº”ç”¨æ—¶é‡å¤å¡«å†™é…ç½®ä¿¡æ¯

### `WuJie` åº”ç”¨ç±»

ç›®å½•ï¼š`sandbox.ts` - `WuJie` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L50)]

ç”¨äºåˆ›å»ºåº”ç”¨å®ä¾‹ï¼Œå’Œ `micro-app` çš„ `CreateApp` çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#createapp-%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E7%B1%BB)]ï¼š

| åˆ†ç±»           | `micro-app`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `wujie`                                                                                                                |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------- |
| åˆ›å»ºå®ä¾‹       | `CreateApp`ï¼šåº”ç”¨å®ä¾‹ç±» [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#createapp-%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E7%B1%BB)]                                                                                                                                                                                                                                                                                                                                                                           | `WuJie`ï¼šåº”ç”¨å®ä¾‹ç±»ï¼Œä¹Ÿæ˜¯æ²™ç®±å®ä¾‹ç±»                                                                                    |
| æ˜ å°„è¡¨         | `appInstanceMap` åº”ç”¨å®ä¾‹æ˜ å°„è¡¨ï¼Œå’Œç»„ä»¶æ˜ å°„è¡¨ä¸åŒ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `idToSandboxCacheMap` å®ä¾‹æ˜ å°„è¡¨ï¼Œå¯ä»¥é€šè¿‡åº”ç”¨åä»æ˜ å°„è¡¨è·å–å®ä¾‹ [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]    |
| æ˜ å°„è¡¨æ·»åŠ æ–¹å¼ | `appInstanceMap.set`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `addSandboxCacheWithWujie` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]                                          |
| åŠ è½½èµ„æº       | è‡ªåŠ¨ï¼šæ„é€ å‡½æ•°è°ƒç”¨ `loadSourceCode` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#11-loadsourcecode-%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90)]                                                                                                                                                                                                                                                                                                                                                                | æ‰‹åŠ¨ï¼šåŠ è½½æå– `template` åé€šè¿‡ `active` æ³¨å…¥èµ„æºåˆ°å®¹å™¨ [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]                                 |
| å¯åŠ¨æ²™ç®±       | æ„é€ å‡½æ•°è°ƒç”¨ `createSandbox` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#21-createsandbox-%E5%88%9B%E5%BB%BA%E6%B2%99%E7%AE%B1)]                                                                                                                                                                                                                                                                                                                                                                        | æ„é€ å‡½æ•°è°ƒç”¨ `iframeGenerator` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]                                               |
| `Proxy`        | `Proxy`ã€`iframe`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `Proxy` æˆ–é™çº§æ—¶ç”¨ `localProxy` [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]                                                              |
| æ‰‹åŠ¨ `start`   | ä¸æ”¯æŒæ‰‹åŠ¨å¯åŠ¨                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `startApp` æˆ– `preloadApp` æ—¶è°ƒç”¨åº”ç”¨ `start` æ–¹æ³• [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]                                          |
| `mount` åº”ç”¨   | è‡ªåŠ¨ï¼šç”±ç»„ä»¶æˆ–èµ„æºåŠ è½½å®Œæ¯•å†³å®šï¼Œåœ¨ `mount` ä¸­ä¼š `start` æ²™ç®± [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#32-mount-%E6%8C%82%E8%BD%BD%E5%BA%94%E7%94%A8)]                                                                                                                                                                                                                                                                                                                                                | ä»…æ”¯æŒç”± `start` æ–¹æ³•é€šè¿‡é˜Ÿåˆ—æ‰§è¡ŒæŒ‚è½½ [[æŸ¥çœ‹](#-mount-æŒ‚è½½åº”ç”¨)]                                                       |
| `unmount` åº”ç”¨ | ç”±ç»„ä»¶ `disconnectedCallback` å‘èµ· [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#22-disconnectedcallback-%E5%8D%B8%E8%BD%BD%E7%BB%84%E4%BB%B6)]                                                                                                                                                                                                                                                                                                                                                           | ç»„ä»¶ `disconnectedCallback` [[æŸ¥çœ‹](#disconnectedcallback-å¸è½½ç»„ä»¶)]ã€æ‰‹åŠ¨é”€æ¯ `destroy` [[æŸ¥çœ‹](#å…¶å®ƒé»˜è®¤æä¾›çš„æ–¹æ³•)] |
| å¤æ‚åº¦         | åˆ†äº† 3 ç±»ï¼Œç»„ä»¶å®ä¾‹ï¼š`MicroAppElement` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#defineelement-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6-microappelement)]ï¼Œåº”ç”¨å®ä¾‹ï¼š`CreateApp` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#createapp-%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E7%B1%BB)]ï¼Œæ²™ç®±å®ä¾‹ï¼š`IframeSandbox` æˆ– `WithSandBox` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#21-createsandbox-%E5%88%9B%E5%BB%BA%E6%B2%99%E7%AE%B1)] | åªè¦å…³å¿ƒ `WuJie` åº”ç”¨å®ä¾‹ã€ç»„ä»¶å®ä¾‹å‡ ä¹å¯ä»¥å¿½ç•¥                                                                        |
| ä¼˜ç‚¹           | æ”¯æŒå¤šç§éš”ç¦»æ–¹æ¡ˆï¼Œè‡ªåŠ¨åŠ è½½èµ„æºã€é…ç½®æ²™ç®±ã€æŒ‚è½½åº”ç”¨                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ç®€å•ï¼Œåªæœ‰ `iframe` ä½œä¸ºæ²™ç®±å¤©ç„¶éš”ç¦»ï¼Œæ”¯æŒå®¹å™¨é™çº§å¤„ç†                                                                 |
| ç¼ºç‚¹           | è¿‡äºå¤æ‚ï¼Œä»è¯­æ„ä¸Šçœ‹æœ‰çš„æ–¹æ³•åœ¨ 3 ä¸ªå®ä¾‹ä¸Šç›¸äº’é‡å ï¼Œå®¹æ˜“æ··æ·†ï¼›ä¸æ”¯æŒå®¹å™¨é™çº§å¤„ç†                                                                                                                                                                                                                                                                                                                                                                                                                                                      | è¿‡äºé›¶æ•£ï¼Œç¼ºä¹é€»è¾‘æŠ½è±¡åˆ†ç¦»ï¼Œæºç  `bug` æœ‰ç‚¹å¤š                                                                          |

> æ— è®ºæ˜¯ `wujie` è¿˜æ˜¯ `micro-app` åœ¨è§£è¯»çš„åˆ†æ”¯æºç ä¸­éƒ½å­˜åœ¨ä¸åŒçš„é€»è¾‘é—®é¢˜

#### ğŸ“ `constructor` æ„é€ å‡½æ•°

#### 1. `inject` æ³¨å…¥å­åº”ç”¨ 3 ä¸ªå¯¹è±¡ï¼š

- `idToSandboxMap`ï¼š`appInstanceMap` åº”ç”¨å®ä¾‹æ˜ å°„è¡¨ [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]
- `appEventObjMap`ï¼š`EventBus` äº‹ä»¶æ˜ å°„è¡¨ [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]
- `mainHostPath` ä¸»åº”ç”¨ `origin`

è¿™é‡Œåšäº†ä¸ªåˆ¤æ–­ï¼š

| æ‰€åœ¨ç¯å¢ƒ                 | åµŒå¥—æƒ…å†µ   | æ³¨å…¥æ–¹å¼                                               |
| ------------------------ | ---------- | ------------------------------------------------------ |
| åŸºåº§åˆ›å»ºåº”ç”¨å®ä¾‹         | ä½œä¸ºå­åº”ç”¨ | é€šè¿‡ `window.__WUJIE.inject` ä»ä¸Šä¸€å±‚è·å–æ•´ä¸ªæ³¨å…¥å¯¹è±¡  |
| åŸºåº§åˆ›å»ºåº”ç”¨å®ä¾‹         | æœ€é¡¶å±‚åŸºåº§ | å£°æ˜æœ€åˆè¦æ³¨å…¥çš„å¯¹è±¡ `this.inject`                     |
| å­åº”ç”¨é€šè¿‡ `window` è°ƒç”¨ | ä½œä¸ºå­åº”ç”¨ | `window.__WUJIE.inject[name]` ä»ä¸Šä¸€å±‚è·å–å¯¹åº”çš„æ˜ å°„è¡¨ |

> è¿™æ ·æ— è®ºæ˜¯å­åº”ç”¨è¿˜æ˜¯åŸºåº§ï¼Œæœ€ç»ˆæ‹¿åˆ°çš„ `inject` å¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªï¼Œè§ï¼š`appEventObjMap` [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]

#### 2. æå–é…ç½®åˆå§‹åŒ–å±æ€§

è§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

åˆ—ä¸¾å‡ ä¸ªå…³é”®å±æ€§ï¼š

**`degrade` ä¸»åŠ¨é™çº§**

- ç”±é…ç½®æä¾›ï¼Œå¦‚æœæ²¡æä¾›ä¹Ÿä¼šæ ¹æ® `wujieSupport` ä»¥å½“å‰ç¯å¢ƒå†³å®šæ˜¯å¦é™çº§

**`plugins` æ’ä»¶ç³»ç»Ÿ**

- é€šè¿‡ `getPlugins` æ‹å¹³æ’ä»¶ï¼Œå¹¶åˆå¹¶é»˜è®¤æ’ä»¶è¿”å›æ•°ç»„ï¼Œè§ï¼šç‰¹æ®Šå±æ€§ - plugins æ’ä»¶é›†åˆ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)]

**`bus` äº‹ä»¶é€šä¿¡**

- é€šè¿‡ `EventBus` è¿›è¡Œé€šä¿¡ï¼Œä¾èµ– `appEventObjMap` ç¡®ä¿çˆ¶å­é€šä¿¡å¯¹è±¡å”¯ä¸€æ€§ï¼Œè§ï¼š`EventBus` [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]
- å°† `bus` ç»‘å®šåœ¨å®ä¾‹å±æ€§ `provide`ï¼Œåœ¨åº”ç”¨å†…å¯ä»¥é€šè¿‡ `window.$wujie?.bus` é€šä¿¡ï¼Œè§ï¼šå¸¸è§„å±æ€§ [[æŸ¥çœ‹](#1-å¸¸è§„å±æ€§)]

#### 3. åˆ›å»ºæ²™ç®± `iframe`

- é€šè¿‡ `appRouteParse` æå–åº”ç”¨ `urlElement`ã€`appHostPath`ã€`appRoutePath` [[æŸ¥çœ‹](#approuteparse-æå–é“¾æ¥)]
- è·å–åŸºåº§çš„ `origin`ï¼š`mainHostPath`
- é€šè¿‡ `iframeGenerator` åˆå§‹åŒ–æ²™ç®± `iframe` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]

#### 4. åˆ›å»ºä»£ç†

| `degrade` | ä»£ç†       | è¯´æ˜                                                          |
| --------- | ---------- | ------------------------------------------------------------- |
| `true`    | é™çº§ä»£ç†   | `localGenerator` [[æŸ¥çœ‹](#-localgenerator-é™çº§æƒ…å†µä¸‹çš„ä»£ç†)]  |
| `false`   | éé™çº§ä»£ç† | `proxyLocation` [[æŸ¥çœ‹](#-proxygenerator-éé™çº§æƒ…å†µä¸‹çš„ä»£ç†)] |

åŒºåˆ«ï¼š

| åˆ†ç±»       | `localGenerator` | `proxyLocation` |
| ---------- | ---------------- | --------------- |
| `window`   | æ²™ç®± `window`    | `proxyWindow`   |
| `document` | `proxyDocument`  | `proxyDocument` |
| `location` | `proxyLocation`  | `proxyLocation` |

é€šè¿‡æµç¨‹å›¾äº†è§£ä¸¤ä¸ªä»£ç†çš„åŒºåˆ« [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]ï¼š

- `proxyWindow` åœ¨ `degrade` é™çº§ä¸‹ä¸å¯ç”¨ [[æŸ¥çœ‹](#proxywindow-åœ¨å“ªè°ƒç”¨)]
- `proxyLocation` åœ¨ `degrade` ä¸‹å­åº”ç”¨å†…ä¸èƒ½é€šè¿‡ `location` è°ƒç”¨ [[æŸ¥çœ‹](#proxylocation-çš„é—®é¢˜)]
- `proxyDocument` çš„å·®åˆ«ï¼Œè§ï¼š`localGenerator` - `proxyDocument` [[æŸ¥çœ‹](#1-åŠ«æŒç©ºå¯¹è±¡ä½œä¸º-proxydocument)]

æµç¨‹ï¼š

- é€šè¿‡ä»£ç†æ–¹æ³•æ‹¿åˆ°ä¸Šè¿°ä»£ç†å¯¹è±¡ç»‘å®šåœ¨ `wujie` å®ä¾‹ä¸­ï¼Œè§ï¼šä»£ç†åœ¨å“ªè°ƒç”¨ [[æŸ¥çœ‹](#proxywindow-åœ¨å“ªè°ƒç”¨)]

#### 5. å°†å®ä¾‹æ·»åŠ åˆ°æ˜ å°„è¡¨

åœ¨æ·»åŠ å®ä¾‹åˆ°æ˜ å°„è¡¨ä¹‹å‰è¦å°† `proxyLocation` ç»‘å®šåœ¨ `provide`ï¼Œè¿™æ ·ï¼š

- å­åº”ç”¨å°±å¯ä»¥é€šè¿‡ `window.$wujie.location` å»è°ƒç”¨ `proxyLocation`
- åœ¨ `WuJie` æ„é€ å‡½æ•°ä¸­ `provide` ç»‘å®šäº† `bus` å’Œ `location`ï¼Œè§ï¼šå¸¸è§„å±æ€§ [[æŸ¥çœ‹](#1-å¸¸è§„å±æ€§)]

æœ€åé€šè¿‡ `addSandboxCacheWithWujie` ç¼“å­˜å½“å‰å®ä¾‹æ·»åŠ åˆ°æ˜ å°„è¡¨ï¼Œè§ï¼š`idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]

#### ğŸ“ `active` æ¿€æ´»åº”ç”¨

å‚æ•°åªæœ‰ 1 ä¸ª `options` å¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å±æ€§ï¼š

- `template`ï¼šæ³¨å…¥åˆ°å®¹å™¨çš„åº”ç”¨èµ„æº
- `el`ï¼šå®¹å™¨æŒ‚è½½èŠ‚ç‚¹ï¼Œé¢„åŠ è½½æ—¶ä¸æä¾›æŒ‚è½½èŠ‚ç‚¹ï¼Œå®¹å™¨æŒ‚è½½åˆ°æ²™ç®± `body`
- `props`ï¼šéœ€è¦ä¼ å…¥åº”ç”¨çš„æ•°æ®
- `alive`ï¼šæ˜¯å¦ç”¨ä¿æ´»æ¨¡å¼æ¿€æ´»åº”ç”¨
- `fetch`ï¼šè‡ªå®šä¹‰åŠ è½½æ–¹æ³•ï¼Œä¸æä¾›é‡‡ç”¨å…¨å±€ `window` çš„ `fetch` æ–¹æ³•
- `replace`ï¼šç”¨äºæ›¿æ¢èµ„æºï¼Œå­˜åœ¨ `bug`ï¼Œè§ï¼šé€šè¿‡é…ç½®æ›¿æ¢èµ„æº [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]

åˆ† 5 éƒ¨åˆ†ï¼š

1. æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯ [[æŸ¥çœ‹](#1-æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯)]
2. å¤„ç†å­åº”ç”¨ `fetch` [[æŸ¥çœ‹](#2-åŠ¨æ€ä¿®æ”¹-fetch)]
3. è·¯ç”±åŒæ­¥ [[æŸ¥çœ‹](#3-åŒæ­¥è·¯ç”±)]
4. å°† `template` æ³¨å…¥å®¹å™¨ï¼Œå¦‚æœå®¹å™¨ä¸å­˜åœ¨åˆ™éœ€è¦åˆ›å»ºæ–°å®¹å™¨ [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]
5. å®Œæˆæ¿€æ´»åº”ç”¨ï¼šæ ·å¼æ‰“è¡¥ä¸ã€æ›´æ–° `provide` [[æŸ¥çœ‹](#5-å®Œæˆæ¿€æ´»åº”ç”¨)]

æ³¨å…¥å®¹å™¨åˆ†ä¸º 3 ç§æƒ…å†µï¼š

- `degrade` ä¸»åŠ¨é™çº§ï¼šæ— è®ºåˆ‡æ¢åº”ç”¨è¿˜æ˜¯åˆå§‹åŒ–éƒ½ä¼šåˆ›å»ºæ–°çš„ `iframe` å®¹å™¨
- `shadowRoot` åˆ‡æ¢åº”ç”¨ï¼šåªæœ‰ `alive` æ¨¡å¼æ›´æ¢æŒ‚è½½èŠ‚ç‚¹ï¼Œå…¶å®ƒæ¨¡å¼é‡æ–°æ³¨å…¥èµ„æº
- `shadowRoot` åº”ç”¨åˆå§‹åŒ–ï¼šåˆ›å»ºå®¹å™¨åæ³¨å…¥èµ„æº

æœ‰ 2 ç§æƒ…å†µä¼š `active` æ¿€æ´»åº”ç”¨ï¼š

- `startApp` æ— è®ºæ˜¯åˆ‡æ¢åº”ç”¨è¿˜æ˜¯åˆå§‹åŒ–å®ä¾‹ [[æŸ¥çœ‹](#startapp-å¯åŠ¨æµç¨‹)]
- `preloadApp` é¢„åŠ è½½åº”ç”¨ [[æŸ¥çœ‹](#preloadapp-é¢„åŠ è½½æµç¨‹)]

åœ¨ `active` æ¿€æ´»åº”ç”¨æ—¶å®¹å™¨èŠ‚ç‚¹å˜æ›´æœ‰ 4 ç§æƒ…å†µï¼š

| åœºæ™¯                     | å®¹å™¨        | `degrade` é™çº§ | `el` å®¹å™¨æŒ‚è½½ç‚¹ | å®¹å™¨æŒ‚è½½ä½ç½®    |
| ------------------------ | ----------- | -------------- | --------------- | --------------- |
| é¢„åŠ è½½åº”ç”¨ã€åˆæ¬¡å¯åŠ¨åº”ç”¨ | `iframe`    | `true`         | æ²¡æœ‰            | æ²™ç®± `iframe`   |
| æ¯æ¬¡å¯åŠ¨åº”ç”¨             | `iframe`    | `true`         | å·²æä¾›          | `el` å®¹å™¨æŒ‚è½½ç‚¹ |
| é¢„åŠ è½½åº”ç”¨ã€åˆæ¬¡å¯åŠ¨åº”ç”¨ | `shadowDom` | `false`        | æ²¡æœ‰            | æ²™ç®± `iframe`   |
| æ¯æ¬¡å¯åŠ¨åº”ç”¨             | `shadowDom` | `false`        | å·²æä¾›          | `el` å®¹å™¨æŒ‚è½½ç‚¹ |

> å…³äºå®¹å™¨çš„æ“ä½œï¼Œè§ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]

#### 1. æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯

ç¬¬ä¸€æ­¥ï¼šç”¨å‚æ•° `options` æ›´æ–°å®ä¾‹ï¼Œç›¸å…³å±æ€§ï¼Œè§ï¼šå®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

éœ€è¦é¢å¤–è¯´æ˜çš„å±æ€§ï¼š

- `hrefFlag`ï¼šè®¾ç½®ä¸º `false` è¡¨æ˜å½“å‰å®¹å™¨æ¥è‡ªåŸºåº§ï¼Œè§ï¼šç‰¹æ®Šå±æ€§ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)]
- `provide`ï¼šç»‘å®šåœ¨ `this.provide.props`ï¼Œåº”ç”¨ä¸­é€šè¿‡ `window.$wujie.props` è·å–
- `activeFlag`ï¼šè¡¨æ˜åº”ç”¨å·²æ¿€æ´»

ç¬¬äºŒæ­¥ï¼šç­‰å¾… `iframe` åˆå§‹åŒ– `await this.iframeReady`

è§ `iframeGenerator` - `iframeReady` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]

éœ€è¦ç­‰å¾… `iframeReady` çš„åœºæ™¯ï¼š

- é™¤äº† `alive` å’Œ `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨æ—¶ `iframeReady` å·²åŠ è½½å®Œæ¯•ï¼Œå…¶å®ƒæƒ…å†µéƒ½æœ‰å¯èƒ½éœ€è¦ç­‰å¾…
- å¦‚æœåŠ è½½é¡ºåˆ©çš„è¯ï¼Œ`iframeReady` ä¼šåœ¨ `active` ä¹‹å‰åŠ è½½å®Œæ¯•ï¼Œè§ï¼š`iframeGenerator` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]

> åœ¨ `qiankun` ä¸­æœ‰ä¸ª `frameworkStartedDefer`ï¼Œç”¨é€”æ˜¯ä¸€æ ·çš„ï¼Œè§ï¼š`startSingleSpa` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-qiankun-substrate?tab=readme-ov-file#23-startsinglespa-%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8)]
>
> - éƒ½æ˜¯å…ˆå‘èµ·ä¸€ä¸ªå¾®ä»»åŠ¡åï¼Œç»§ç»­æ‰§è¡Œåç»­æµç¨‹ï¼›
> - åœ¨å¯åŠ¨åº”ç”¨æ—¶ä¼šç­‰å¾…å¾®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰å¼€å§‹æŒ‚è½½åº”ç”¨

#### 2. åŠ¨æ€ä¿®æ”¹ `fetch`

ä»…é™æä¾› `fetch` é…ç½®ï¼ŒåŸå› ï¼š

- é…ç½®é‡å†™ `fetch` å‡½æ•°æ—¶ï¼šç›¸å¯¹è·¯å¾„é€šè¿‡åŸºåº§çš„ `url` è¿›è¡Œè¡¥å…¨
- å­åº”ç”¨ `fetch` æ—¶ï¼šç›¸å¯¹è·¯å¾„é€šè¿‡æ²™ç®±ä¸­ `base` å…ƒç´ è¿›è¡Œè¡¥å…¨

äºæ˜¯ï¼š

- é‡å†™ `fetch` å‡½æ•°é€šè¿‡ `getAbsolutePath` æŒ‡å‘ `proxyLocation` [[æŸ¥çœ‹](#getabsolutepathè·å–ç»å¯¹è·¯å¾„)]
- å°†é‡å†™çš„ `fetch` ç»‘å®šåˆ°æ²™ç®± `window` å’Œåº”ç”¨å®ä¾‹ä¸­

ä½†æ˜¯åŸºåº§åŠ è½½èµ„æºæ—¶ç”¨ä¸åˆ°ï¼š

- `importHTML`ï¼šæå–åº”ç”¨èµ„æºï¼Œ`fetch` è¿˜æœªæŒ‡å‘ `proxyLocation`
- `processCssLoaderForTemplate`ï¼šæ‰‹åŠ¨åŠ è½½æ ·å¼ï¼Œé’ˆå¯¹æ‰€æœ‰åº”ç”¨ï¼Œé€šå¸¸ä¼šæŒ‡å®šä¸€ä¸ªå…¬å…±èµ„æºè·¯å¾„

> åŠ è½½èµ„æºé€šå¸¸æ˜¯ç»å¯¹è·¯å¾„ï¼›å½“é…ç½®æ²¡æœ‰æä¾› `fetch` æ—¶ï¼Œä¼šé»˜è®¤ä»å…¨å±€å¯¹è±¡ä¸­è·å–

å­åº”ç”¨ä¸éœ€è¦è¡¥å…¨è·¯å¾„ï¼š

- å­åº”ç”¨ `fetch` ç›¸å¯¹è·¯å¾„æ—¶ï¼Œé€šè¿‡ `base` å…ƒç´ è‡ªåŠ¨è½¬æ¢æˆç»å¯¹é“¾æ¥

åªé€‚åˆé€šè¿‡åŸºåº§ä¿®æ”¹ `fetch` è¿™ä¸€åœºæ™¯ï¼š

- å› ä¸º `fetch` æ˜¯åœ¨åŸºåº§çš„ä½œç”¨åŸŸä¸‹ï¼Œæ‹¿ä¸åˆ°åº”ç”¨çš„ `base` å…ƒç´ 
- å¦‚æœå­åº”ç”¨ `fetch` æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œéœ€ä½¿ç”¨ `proxyLocation` é€šè¿‡ `getAbsolutePath` è¡¥å…¨

æ¯”å¦‚è¯´åœ¨é…ç½® `fetch` çš„æƒ…å†µä¸‹ï¼š

- é€šè¿‡åŸºåº§ç»Ÿä¸€è·å– `authorization` ä½œä¸ºä¸ºæ¯ä¸ªåº”ç”¨å½“ç‹¬ `fetch` è¯·æ±‚é‰´æƒ
- å­åº”ç”¨ä¸­é€šè¿‡ç›¸å¯¹è·¯å¾„è·å–æœ¬åœ°èµ„æºï¼Œå°†è·¯å¾„æ ¹æ®ä¸åŒçš„åº”ç”¨è¿›è¡ŒåŒ¹é…

è¡¥å……ï¼š

- å…³äº `fetch` ç­‰ç›¸å…³çš„é“¾æ¥ï¼Œè§ï¼šå­åº”ç”¨ä¸­çš„é“¾æ¥æŒ‡å‘ [[æŸ¥çœ‹](#å­åº”ç”¨ä¸­çš„é“¾æ¥æŒ‡å‘)]
- `importHTML` åŠ è½½èµ„æº - 6. ä» `fetch` çœ‹å…¼å®¹æ€§ [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

#### 3. åŒæ­¥è·¯ç”±

ä»¥ä¸‹å±æ€§ç”¨äºåŒæ­¥è·¯ç”±ï¼š

| åŒæ­¥æ–¹æ³•                                                           | `sync`                                  | `url`        | `prefix`   |
| ------------------------------------------------------------------ | --------------------------------------- | ------------ | ---------- |
| `syncUrlToIframe` [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)] | åŒæ­¥è·¯ç”±æ¥è‡ªå½“å‰ `url` è¿˜æ˜¯èµ„æºå…¥å£é“¾æ¥ | èµ„æºå…¥å£é“¾æ¥ | çŸ­è¿æ¥é›†åˆ |
| `syncUrlToWindow` [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)] | æ˜¯å¦åŒæ­¥è·¯ç”±åˆ°åŸºåº§                      | ä¸éœ€è¦       | çŸ­è¿æ¥é›†åˆ |

> åªæœ‰ `url` æ˜¯å¿…é€‰å±æ€§ï¼Œå…¶å®ƒéƒ½å¯é€‰ï¼›`active` çš„ `url` å­˜åœ¨ `bug`ï¼Œè§ï¼šç‰¹æ®Šå±æ€§ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)]

æ‰§è¡Œè¿‡ç¨‹ï¼Œä»å·¦åˆ°å³ï¼š

| æ‰§è¡Œæ–¹å¼                    | `syncUrlToIframe` | `syncUrlToWindow` |
| --------------------------- | ----------------- | ----------------- |
| `alive` é¢„æ‰§è¡Œ              | æ‰§è¡Œ              | æ‰§è¡Œ              |
| `alive` é¢„æ‰§è¡Œå `startApp` | ä¸æ‰§è¡Œ            | æ‰§è¡Œ              |
| `alive` åˆ‡æ¢åº”ç”¨            | ä¸æ‰§è¡Œ            | æ‰§è¡Œ              |
| å…¶å®ƒæ¨¡å¼                    | æ‰§è¡Œ              | æ‰§è¡Œ              |

- `syncUrlToIframe`ï¼šåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨ [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]
- `syncUrlToWindow`ï¼šåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨ [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)]

åµŒå¥—é¡ºåºï¼š

- å…ˆä»åŸºåº§è‡³ä¸Šè€Œä¸‹ï¼Œç„¶ååº”ç”¨ä»ä¸‹å¾€ä¸Š
- åŸºåº§åµŒå¥—åŸºåº§ï¼Œä¹Ÿæ˜¯è¿™æ ·å±‚å±‚ä¼ é€’

> `alive` æ¨¡å¼å†æ¬¡å¯åŠ¨ï¼Œä¸æ‰§è¡Œ `syncUrlToIframe` æ˜¯å› ä¸ºåˆå§‹åŒ–æ—¶å·²åŒæ­¥ï¼Œä¹‹ååªéœ€åŒæ­¥è·¯ç”±åˆ°ä¸»åº”ç”¨

#### 4. åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº

é€šè¿‡ `template` æ›´æ–° `this.template`ï¼Œä½œä¸ºéœ€è¦æ³¨å…¥å®¹å™¨çš„èµ„æºã€‚

> éé‡å»ºæ¨¡å¼å®ä¾‹å·²å­˜åœ¨æ—¶ï¼Œ`startApp` ä¸éœ€è¦æä¾›èµ„æºï¼Œå› ä¸ºåˆæ¬¡æ¿€æ´»åº”ç”¨æ—¶ `template` å·²ç»‘å®š

#### 4.1. `degrade` ä¸»åŠ¨é™çº§æ¸²æŸ“

ç”¨ `iframe` ä½œä¸ºå®¹å™¨ï¼Œåº”ç”¨ä¸­çš„å¼¹çª—ç”±äºåœ¨ `iframe` å†…éƒ¨å°†æ— æ³•è¦†ç›–æ•´ä¸ªé¡µé¢ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#degrade)]

å…³è”å±æ€§ `degradeAttrs`ï¼Œè¡¥å……æ–‡æ¡£æ²¡æœ‰çš„è¯´æ˜ï¼š

- åœ¨ `wujie` ä¸­æ‰€æœ‰çš„ `iframe` å®¹å™¨åªè®¾ç½®äº†å®½é«˜ `100%`ï¼Œè¿™å¹¶ä¸èƒ½å¤Ÿé€‚åº”å®é™…æƒ…å†µ
- ä½¿ç”¨è¿™ä¸ªé…ç½®å¯ä»¥é€šè¿‡ `style` é€‚é…å®¹å™¨èŠ‚ç‚¹çš„æ ·å¼
- åŒæ ·é€‚ç”¨äº `locationHrefSet` æ‹¦æˆª `location.href` çš„åŠ«æŒå®¹å™¨ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

`degradeAttrs` æ˜¯ä¸€ä¸ªå›ºå®šçš„é…ç½®ï¼Œå¦‚ä½•æ ¹æ®åº”ç”¨é…ç½®ä¸åŒçš„å±æ€§ï¼š

1. é€šè¿‡ `setupApp` æ ¹æ®åº”ç”¨ä¿å­˜ä¸åŒçš„é…ç½®ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]
2. é€šè¿‡ä¸åŒçš„ç»„ä»¶åˆ†å¼€ `startApp`ï¼Œä»è€Œé…ç½®ä¸åŒçš„å±æ€§

> åŒç†ä¹Ÿé€‚ç”¨äºå…¶å®ƒå›ºå®šçš„é…ç½®ä¿¡æ¯ï¼Œéœ€è¦æ ¹æ®ä¸åŒçš„åº”ç”¨åšå‡ºå·®å¼‚åŒ–çš„è¡¨ç°

ä¸è¦è¯•å›¾é€šè¿‡æ ·å¼å»åŒ¹é…ä¸åŒ `iframe` å®¹å™¨çš„ `id`ï¼š

- å½“é€šè¿‡ `locationHrefSet` åˆ›å»ºæŒå®¹å™¨æ—¶ï¼Œè®¾å®šå¥½çš„æ ·å¼ä¼šéš `iframe` å®¹å™¨çš„ `id` ä¸€åŒä¸¢å¤±

ä¸»åŠ¨é™çº§åˆ† 3 ä¸ªéƒ¨åˆ†ï¼š

1. åˆ›å»º `iframe` å®¹å™¨å¹¶æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹
2. é”€æ¯æ²™ç®±è®°å½•ï¼Œä¸ºåˆ›å»ºçš„ `iframe` æ–°å®¹å™¨æ‰“è¡¥ä¸
3. æ³¨å…¥ `template` åˆ° `iframe` å®¹å™¨ä¸­

ä¸ºäº†ä¾¿äºç†è§£ï¼Œæ•´ä¸ªæ€»ç»“ä¸­å°†å®¹å™¨åŠç›¸å…³å¯¹è±¡åˆ’åˆ†å¦‚ä¸‹ï¼š

- æ²™ç®± `iframe`ï¼šç”¨äºå­˜æ”¾åº”ç”¨ `script` çš„æ²™ç®±ï¼Œè§ï¼š`iframeGenerator` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]
- `iframe` å®¹å™¨ï¼šé™çº§æ—¶å­˜æ”¾åº”ç”¨èµ„æºçš„å®¹å™¨ï¼Œå…¶ä¸­ `script` ä¼šè¢«æ³¨é‡Š [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]
- åŠ«æŒå®¹å™¨ï¼šé€šè¿‡ `locationHrefSet` åŠ«æŒå­åº”ç”¨ä¸­é€šè¿‡ `location.href` è·³è½¬çš„é¡µé¢ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]
- `shadowRoot`ï¼šé»˜è®¤æƒ…å†µä¸‹å­˜æ”¾åº”ç”¨èµ„æºçš„å®¹å™¨ï¼Œå…¶ä¸­ `script` ä¼šè¢«æ³¨é‡Š [[æŸ¥çœ‹](#42-æŒ‚è½½å­åº”ç”¨åˆ‡æ¢åˆå§‹åŒ–é¢„åŠ è½½)]

> ç›¸åº”çš„ `iframeWindow`ã€`iframeBody`ã€`iframeDocument` å…¨éƒ¨ä¸ºæ²™ç®± `iframe` ä¸­çš„å¯¹è±¡

ç¬¬ä¸€æ­¥ï¼šåˆ›å»º `iframe`

- `rawDocumentQuerySelector` è·å–æ²™ç®± `iframeBody`
- `initRenderIframeAndContainer` åˆ›å»º `iframe` å®¹å™¨æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]

`iframe` å®¹å™¨çš„æŒ‚è½½ç‚¹ï¼š

- `el`ï¼š`startApp` æ—¶é€šè¿‡é…ç½®æŒ‡å®š
- `iframeBody`ï¼š`preloadApp` ä¸´æ—¶å­˜æ”¾åœ¨æ²™ç®±ä¸­

> å¦‚æœ `startApp` æ²¡æœ‰æä¾› `el` æŒ‚è½½èŠ‚ç‚¹ï¼Œä¹Ÿä¼šå­˜æ”¾åœ¨æ²™ç®± `iframeBoody` ä¸­ã€‚æ­¤æ—¶åº”ç”¨ä¸ä¼šæŠ¥é”™ä½†ä¸å¯è§ã€‚

ç¬¬äºŒæ­¥ï¼šæ›´æ–°å®¹å™¨ï¼Œé”€æ¯ `iframeBody`

- å°†æŒ‚è½½çš„èŠ‚ç‚¹ç»‘å®šåˆ° `this.el`
- è‹¥é…ç½®äº† `el` å®¹å™¨ï¼Œæ¸…ç©º `iframeBody`ï¼Œç¡®ä¿æ¸²æŸ“å®¹å™¨åªæœ‰ 1 ä¸ªï¼Œè§ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]
- `patchEventTimeStamp`ï¼šä¿®å¤ `vue` çš„ `event.timeStamp` é—®é¢˜
- `onunload`ï¼šå½“é”€æ¯å­åº”ç”¨æ—¶ä¸»åŠ¨ `unmount` å­åº”ç”¨

`this.el` æŒ‚è½½èŠ‚ç‚¹æœ‰å•¥ç”¨ï¼š

| æµç¨‹                                                                    | æ‰§è¡Œæ–¹æ³•                                              | ç”¨é€”                     |
| ----------------------------------------------------------------------- | ----------------------------------------------------- | ------------------------ |
| `active` [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]                                  | `renderElementToContainer`                            | å°†å®¹å™¨æ·»åŠ åˆ°æŒ‚è½½ç‚¹       |
| `start` [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]                                       | `removeLoading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)] | åˆ é™¤ `loading` çŠ¶æ€      |
| `mount` [[æŸ¥çœ‹](#1-umd-æ–¹å¼å¯åŠ¨)]                                       | `removeLoading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)] | åˆ é™¤ `loading` çŠ¶æ€      |
| `destroy` [[æŸ¥çœ‹](#2-æ¸…ç©ºå®¹å™¨é”€æ¯å®ä¾‹)]                                 | `clearChild`                                          | æ¸…ç©ºæŒ‚è½½èŠ‚ç‚¹             |
| `processAppForHrefJump` [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)] | `renderElementToContainer`                            | åº”ç”¨å†…å‰è¿›åé€€æ—¶æ›¿æ¢å®¹å™¨ |

`renderElementToContainer` åœ¨ä»¥ä¸‹æƒ…å†µé€šè¿‡ç¬¬ä¸‰æ–¹è°ƒç”¨æ‰§è¡Œ

- `active` åº”ç”¨ï¼š`degrade` æ—¶é€šè¿‡ `initRenderIframeAndContainer` [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]
- `processAppForHrefJump` å‰è¿›æ—¶é€šè¿‡ `renderIframeReplaceApp` [[æŸ¥çœ‹](#renderiframereplaceappåŠ è½½-iframe-æ›¿æ¢å­åº”ç”¨)]

`onunload` æ˜¯ä¸€ä¸ªåºŸå¼ƒçš„æ–¹æ³•ï¼Œéšæ—¶å¯èƒ½è¢«æµè§ˆå™¨å¼ƒç”¨

- ç”¨äº `iframe` å®¹å™¨åœ¨ `Dom` ä¸­é”€æ¯æ—¶å¸è½½åº”ç”¨ï¼Œç›¸å½“äº `web component` çš„ `disconnectedCallback` [[æŸ¥çœ‹](#disconnectedcallback-å¸è½½ç»„ä»¶)]

ç¬¬ä¸‰æ­¥ï¼šæ³¨å…¥ `template` åˆ°å®¹å™¨ä¸­

åœ¨é™çº§çŠ¶æ€ä¸‹æ¯æ¬¡ `active` åº”ç”¨æ—¶é€šè¿‡ `this.document` è®°å½• `iframe` å®¹å™¨

- ä¸»è¦ç”¨äºåŒºåˆ†æ˜¯å¦æ˜¯åˆæ¬¡åŠ è½½ï¼Œä»¥åŠè®°å½•ã€æ¢å¤äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]
- æ— è®ºæ˜¯åˆæ¬¡åŠ è½½è¿˜æ˜¯åˆ‡æ¢åº”ç”¨ï¼Œé™çº§çŠ¶æ€éƒ½ä¼šæ–°å»º `iframe` å®¹å™¨ï¼Œå³ä¾¿ `alive` æ¨¡å¼ä¹Ÿä¸ä¾‹å¤–

æ³¨å…¥ `template` æœ‰ 3 ç§æƒ…å†µï¼š

`åˆ†æ”¯ 1` - `alive` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨

- å°† `this.document` ä¸­çš„ `html` æ ¹å…ƒç´ æ›¿æ¢ `iframe` å®¹å™¨ä¸­çš„ `html` æ ¹å…ƒç´ 
- åœ¨ä¿æ´»åœºæ™¯æ¢å¤æ‰€æœ‰å…ƒç´ äº‹ä»¶ï¼Œè§ï¼šè®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]

`åˆ†æ”¯ 2` - é `alive` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨

- é€šè¿‡ `renderTemplateToIframe` å°† `template` æ³¨å…¥åˆ›å»º `iframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe-å®¹å™¨)]
- `recoverDocumentListeners` éä¿æ´»åœºæ™¯éœ€è¦æ¢å¤æ ¹èŠ‚ç‚¹çš„äº‹ä»¶ï¼Œé˜²æ­¢ `react16` ç›‘å¬äº‹ä»¶ä¸¢å¤±ï¼Œè§ï¼šè®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]

`åˆ†æ”¯ 3` - åˆæ¬¡æ¸²æŸ“

- é€šè¿‡ `renderTemplateToIframe` å°† `template` æ³¨å…¥åˆ›å»º `iframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe-å®¹å™¨)]

è‡³æ­¤æ•´ä¸ªé™çº§è¿‡ç¨‹å®Œæˆï¼Œç›´æ¥è¿”å›ä¸å†æ‰§è¡Œä¸‹é¢æµç¨‹

#### 4.2. æŒ‚è½½å­åº”ç”¨ï¼šåˆ‡æ¢ã€åˆå§‹åŒ–ã€é¢„åŠ è½½

ç¬¬ä¸€æ­¥ï¼šæŒ‚è½½å®¹å™¨ç”¨åˆ°æŒ‡å®šèŠ‚ç‚¹

é™çº§æ—¶é€šè¿‡ `this.document` æ¥åŒºåˆ†åˆæ¬¡åŠ è½½è¿˜æ˜¯åˆ‡æ¢åº”ç”¨ï¼Œè€Œé»˜è®¤çŠ¶æ€é€šè¿‡ `this.shadowRoot` æ¥åŒºåˆ†

æ³¨å…¥ `template` æœ‰ 3 ç§æƒ…å†µï¼š

`åˆ†æ”¯ 1`ï¼šåˆ‡æ¢åº”ç”¨

- é€šè¿‡ `renderElementToContainer` å°† `this.shadowRoot.host` æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]

åˆ‡æ¢åº”ç”¨åªæœ‰ `umd` æ¨¡å¼éœ€è¦é‡æ–°æ³¨å…¥èµ„æºï¼š

- `alive` æ¨¡å¼ï¼šå®Œæˆåˆ‡æ¢åç›´æ¥è¿”å›ï¼Œä¸å†ç»§ç»­æ‰§è¡Œèµ„æºæ³¨å…¥å®¹å™¨çš„æµç¨‹
- `umd` æ¨¡å¼ï¼šè™½ç„¶å®ä¾‹å­˜åœ¨ `shadowRoot`ï¼Œä½† `active` å‰ä¼šé€šè¿‡ `unmount` æ¸…ç©ºå®¹å™¨ [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]
- é‡å»ºæ¨¡å¼ï¼š`active` å‰ä¼šéšåº”ç”¨ä¸€åŒé”€æ¯ï¼Œä¸å­˜åœ¨ `shadowRoot`ï¼Œä¹Ÿä¸èµ°è¿™ä¸ªåˆ†æ”¯

`åˆ†æ”¯ 2`ï¼šåˆæ¬¡åŠ è½½

- è·å– `iframeBody`ï¼Œå¦‚æœæ²¡æœ‰æä¾›æŒ‚è½½èŠ‚ç‚¹ï¼Œä½œä¸ºå¤‡ç”¨
- é€šè¿‡ `createWujieWebComponent` åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶ï¼š`wujie-app`
- é€šè¿‡ `renderElementToContainer` å°†åˆ›å»ºçš„ç»„ä»¶æŒ‚è½½åˆ°æŒ‡å®šå®¹å™¨ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]

> `shadowRoot` åœ¨åˆ›å»º `web component` æ—¶å€™ç»‘å®šåˆ°å®ä¾‹ï¼Œè§ï¼š`connectedCallback` [[æŸ¥çœ‹](#connectedcallbackæŒ‚è½½ç»„ä»¶)]

`åˆ†æ”¯ 3`ï¼š é¢„åŠ è½½åº”ç”¨

- é¢„åŠ è½½ä¹Ÿæ˜¯åˆæ¬¡åŠ è½½å’Œ `åˆ†æ”¯ 2` æµç¨‹ä¸€æ¨¡ä¸€æ ·
- ä¸åŒçš„æ˜¯é¢„åŠ è½½ä¸æä¾›æŒ‚è½½èŠ‚ç‚¹ `el`ï¼Œè€Œæ˜¯ç”¨ `iframeBody` ä½œä¸ºä¸´æ—¶æŒ‚è½½èŠ‚ç‚¹
- é¢„åŠ è½½ä¹‹å `startApp` å¦‚æœæ²¡æœ‰é”€æ¯å®ä¾‹çš„æƒ…å†µä¸‹ï¼Œä¼šæŒ‰ç…§ `åˆ†æ”¯ 1` æ‰§è¡Œæµç¨‹

ç¬¬äºŒæ­¥ï¼šæ³¨å…¥ `template` åˆ°å®¹å™¨ä¸­

- é€šè¿‡ `renderTemplateToShadowRoot` å°† `template` æ¸²æŸ“åˆ° `shadowRoot` [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]
- åŒ…æ‹¬ `umd` æ¨¡å¼å’Œé‡å»ºæ¨¡å¼ï¼Œæ³¨å…¥ `template` ä¹‹å‰ `shadowRoot` ä»…ä»…æ˜¯ä¸ªç©ºå£³

> `alive` åˆæ¬¡åŠ è½½çš„æ—¶å€™ä¹Ÿéœ€è¦æ³¨å…¥èµ„æºåˆ° `shadowRoot`

æ³¨å…¥èµ„æºåä¼šå‘ç”Ÿä»€ä¹ˆï¼š

- `startApp` æ·»åŠ çš„ `loading` å› ä¸ºèµ„æºæ³¨å…¥è€Œæ’‘å¼€æŒ‚è½½èŠ‚ç‚¹ï¼Œå˜å¾—å¯è§ [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]
- ç”±äºå½“å‰åªæ³¨å…¥äº†å·²æ³¨é‡Š `script` çš„é™æ€èµ„æºï¼Œè€Œå¯¹äºå•ä¾‹åº”ç”¨æ¥è¯´æ­¤æ—¶è¿˜æœªæ¸²æŸ“
- éœ€è¦ç­‰åˆ° `start` å¯åŠ¨åº”ç”¨ï¼Œå°†å…¥å£ `script` æ·»åŠ åˆ°æ²™ç®± `iframe` åæ‰ä¼šæ¸²æŸ“åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

å¦‚ä½•æ’‘å¼€èŠ‚ç‚¹ï¼š

- é™çº§å®¹å™¨é€šè¿‡ `createIframeContainer` è®¾ç½® `iframe` å®½é«˜ [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]
- `shadowRoot` é€šè¿‡ `renderTemplateToShadowRoot` æ·»åŠ  `div` æ’‘å¼€å…ƒç´  [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]

#### 5. å®Œæˆæ¿€æ´»åº”ç”¨

- é€šè¿‡ `patchCssRules` ä¸ºå­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]
- æ›´æ–° `this.provide.shadowRoot`

`this.provide` æ˜¯å­åº”ç”¨ä¸­ `window` å…¨å±€å¯¹è±¡ä¸­çš„ `$wujie`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/wujie.html#wujie)]ï¼š

- åœ¨å®ä¾‹æ„é€ æ—¶é€šè¿‡ `patchIframeVariable` å°†å…¶æ³¨å…¥æ²™ç®± `window` [[æŸ¥çœ‹](#patchiframevariable-ä¸ºå­åº”ç”¨-window-æ·»åŠ å±æ€§)]
- `shadowRoot` ä»…é™éé™çº§çŠ¶æ€ä¸‹æ‰èƒ½æä¾›

åœ¨å­åº”ç”¨ä¸­è·å–æ ¹èŠ‚ç‚¹ï¼š

| åˆ†ç±»            | `iframe` å®¹å™¨                  | `shadowRoot` å®¹å™¨              |
| --------------- | ------------------------------ | ------------------------------ |
| `shadowRoot`    | ä¸å­˜åœ¨                         | `window.$wujie.shadowRoot`     |
| å®¹å™¨æ ¹èŠ‚ç‚¹      | `window.__WUJIE.document`      | `window.__WUJIE.shadowRoot`    |
| æ²™ç®± `document` | `Node.prototype.ownerDocument` | `Node.prototype.ownerDocument` |

å®¹å™¨ä¸­æ‰€æœ‰å…ƒç´  `document` ä¸€å®šæ˜¯æ²™ç®± `iframe.contentDocument`ï¼š

- å› ä¸ºæ¯ä¸ªå…ƒç´ éƒ½é€šè¿‡ `patchElementEffect` æ‰“äº†è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]

è€Œåœ¨å­åº”ç”¨ä¸­ `document` çš„ `property` åˆ™ä¼šæŒ‡å‘ `proxyDocument`ï¼Œå› ä¸ºï¼š

- æ²™ç®±åˆå§‹åŒ–æ—¶é€šè¿‡ `patchDocumentEffect` åŠ«æŒäº† `iframeWindow.Document.prototype` [[æŸ¥çœ‹](#patchdocumenteffectä¿®æ­£æ²™ç®±-document-çš„-effect)]
- åŠ«æŒçš„å±æ€§ä¼šåœ¨ `get` æ—¶æŒ‡å‘ `proxyDocument` [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

> è€Œ `proxyDocument` åªæœ‰è·å– `script` æŒ‡å‘æ²™ç®± `iframe.contentDocument`ï¼Œå…¶ä½™å…¨éƒ¨æŒ‡å‘å®¹å™¨ï¼Œæ¯”å¦‚ `iframe` å®¹å™¨çš„ `document`ï¼Œæˆ–æ˜¯ `shadowRoot`

ä¸ºæ­¤æ²™ç®± `iframe` åˆå§‹åŒ–æ—¶ä¿ç•™äº†æ²™ç®± `document` 4 ä¸ªåŸå§‹æ–¹æ³•ï¼š

- é€šè¿‡ `initIframeDom` ç»‘å®šåœ¨æ²™ç®± `iframe.contentWindow` [[æŸ¥çœ‹](#initiframedomåˆå§‹åŒ–-iframe-çš„-dom-ç»“æ„)]

`head` å’Œ `body`ï¼š

- æ²™ç®±ä¸‹çš„ `head`ã€`body` é€šè¿‡ `patchDocumentEffect` åŠ«æŒæŒ‡å‘ `proxyDocument` [[æŸ¥çœ‹](#patchdocumenteffectä¿®æ­£æ²™ç®±-document-çš„-effect)]
- è€Œ `proxyDocument` ä¸­çš„ `head`ã€`body` æŒ‡å‘æ²™ç®± `document`
- è€Œå®¹å™¨ä¸­çš„ `head`ã€`body` é€šè¿‡ `patchRenderEffect` é‡å†™äº† `Dom` æ“ä½œ [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

ä¸ºäº†æ–¹ä¾¿æ‹¿åˆ°å®¹å™¨çš„ `head` å’Œ `body`

- `shadowRoot`ï¼šé€šè¿‡å®ä¾‹ `sandbox.shadowRoot['head'|'body']` è·å–
- `iframe` å®¹å™¨ï¼šé€šè¿‡å®ä¾‹ `sandbox['head'|'body']` è·å–

> å­åº”ç”¨ä¸­ä¹Ÿå¯ä»¥ç›´æ¥ä» `document['head'|'body']` è·å–

#### 6. æ¿€æ´»åº”ç”¨çš„ `bug`

å¯åŠ¨åº”ç”¨ä¸æä¾› `el` æŒ‚è½½ç‚¹

- è™½ç„¶åœ¨ `ts` å·²æ˜ç¡®å¿…é¡»æä¾› `el` æŒ‚è½½ç‚¹ï¼Œä½†æ˜¯å¦‚æœ `ignore` æˆ– `js` é¡¹ç›®å°±æ²¡æä¾›æ€ä¹ˆåŠå‘¢ï¼Ÿ

è§¦å‘æƒ…å†µï¼š

- å—å½±å“ï¼šéé‡å»ºæ¨¡å¼åˆ‡æ¢ `shadowRoot` å®¹å™¨çš„åº”ç”¨
- ä¸å—å½±å“ï¼šé¢„åŠ è½½ã€åˆæ¬¡å¯åŠ¨ã€é™çº§æ¸²æŸ“ï¼Œä¼šå°†æ²™ç®± `iframe` ä½œä¸ºå¤‡ç”¨å®¹å™¨

è§£å†³åŠæ³•ï¼š

- å’Œ `micro-app` ç»„ä»¶æŒ‚è½½ä¸€æ ·åšæ¡ä»¶åˆ¤æ–­ï¼Œæ¡ä»¶ä¸æ»¡è¶³çš„æƒ…å†µç›´æ¥è¿”å›ä¸åšä»»ä½•æ¸²æŸ“

#### 7. æ¿€æ´»åº”ç”¨çš„è¡¥å……

æ— è®ºå®¹å™¨æ˜¯ `iframe` è¿˜æ˜¯ `shadowRoot`ï¼Œéƒ½è¦ç»™å®¹å™¨æ·»åŠ å±æ€§ `WUJIE_APP_ID` å€¼ä¸ºåº”ç”¨åï¼Œç”¨é€”ï¼š

- é€šè¿‡ `querySelector` æŸ¥æ‰¾ `iframe[${WUJIE_APP_ID}="${id}"]` æ‰¾åˆ° `iframe` å®¹å™¨
- é€šè¿‡è‡ªèº«å±æ€§ `WUJIE_APP_ID` è·å–åº”ç”¨å®ä¾‹

> å±æ€§æ˜¯ç”± `wujie` å†…éƒ¨å®ç°ï¼Œä½¿ç”¨è€…æ— éœ€æ‰‹åŠ¨æ·»åŠ ï¼Œè¿™é‡Œå†™å‡ºæ¥æ˜¯ä½œä¸ºå¢åŠ å¯¹ `wujie` çš„äº†è§£

æ·»åŠ æ ‡ç­¾ `WUJIE_APP_ID` éƒ½æ¥è‡ª `active` æ¿€æ´»åº”ç”¨æ—¶åˆ›å»ºå®¹å™¨ï¼š

- `createIframeContainer`ï¼šåˆ›å»º `iframe` å®¹å™¨ [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]
- `createWujieWebComponent`ï¼šåˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶ `wujie-app`

#### ğŸ“ `start` å¯åŠ¨åº”ç”¨

å‚æ•°ï¼š

- `getExternalScripts`ï¼šè¿”å›åŠ è½½åº”ç”¨ä¸­é™æ€ `script` é›†åˆçš„å‡½æ•° [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]

è¿”å›ï¼š

- ç±»å‹ `Promise<void>` çš„å¾®ä»»åŠ¡ï¼Œé€šè¿‡ `await` ç¡®ä¿åº”ç”¨æˆåŠŸå¯åŠ¨

å¦‚æœ `this.iframe` è¢«é”€æ¯çš„æƒ…å†µä¼šç›´æ¥è¿”å›ä¸å†å¤„ç†ï¼š

- `this.iframe` åªæœ‰åœ¨é”€æ¯åº”ç”¨ `destroy` è®¾ä¸º `null` [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]

`start` è°ƒç”¨åœºæ™¯æœ‰ 3 ä¸ªï¼š

- `startApp` é¢„åŠ è½½ `alive` æ¨¡å¼çš„åº”ç”¨å `startApp` [[æŸ¥çœ‹](#21-alive-ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨)]
- `startApp` åˆ›å»ºæ–°çš„åº”ç”¨å®ä¾‹ [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)]
- `preloadApp` é…ç½® `exec` é¢„æ‰§è¡Œ [[æŸ¥çœ‹](#5-é€šè¿‡-exec-é¢„æ‰§è¡Œ)]

> æ‰§è¡Œ `start` å¯åŠ¨åº”ç”¨å‰å¿…é¡»å…ˆ `active` æ¿€æ´»åº”ç”¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]

#### 1. æ”¶é›†é˜Ÿåˆ—

æ•´ä¸ª `start` çš„æµç¨‹å°±æ˜¯å¯¹ `this.execQueue` é˜Ÿåˆ—çš„æ”¶é›†å’Œæå–å¹¶æ‰§è¡Œï¼š

- åœ¨é˜Ÿåˆ—ä¸­ `push` è¿›æ¥çš„éƒ½æ˜¯åŒæ­¥çš„æ‰§è¡Œæ–¹æ³•ï¼Œæ‰§è¡Œé˜Ÿåˆ—é€šè¿‡ `shift` å®ç°å…ˆå…¥å…ˆå‡º
- åœ¨é˜Ÿåˆ—ä¸‹æ ‡çš„æ¯ä¸ªæ–¹æ³•ä¸­æœ‰å¯èƒ½å­˜åœ¨å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡ï¼Œä½†æ‰§è¡Œé¡ºåºçœ‹æ‰€åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—å‰åé¡ºåº
- å› ä¸ºæ¯ä¸ªé˜Ÿåˆ—çš„æ‰§è¡Œéƒ½æ˜¯åœ¨ä¸Šä¸€ä¸ªé˜Ÿåˆ—æ‰§è¡Œè¿‡ç¨‹ä¸­é€šè¿‡ `shift` æå–å¹¶æ‰§è¡Œ

**`this.execQueue.push` å…±è®¡ 7 å¤„ï¼š**

- `beforeScriptResultList`ï¼šæ’å…¥ä»£ç å‰é€šè¿‡æ’ä»¶æ·»åŠ çš„ `script`
- `syncScriptResultList` + `deferScriptResultList`ï¼šå­åº”ç”¨ä¸­åŒæ­¥ `script`ï¼ŒåŒ…å« `defer`
- `this.mount`ï¼šåŸºåº§ä¸»åŠ¨è°ƒç”¨ `mount` æ–¹æ³•
- `domContentLoadedTrigger`ï¼šè§¦å‘ `DOMContentLoaded` äº‹ä»¶
- `afterScriptResultList`ï¼šæ’å…¥ä»£ç åæ’ä»¶æ·»åŠ çš„ `script`
- `domLoadedTrigger`ï¼šè§¦å‘ `loaded` äº‹ä»¶
- è¿”å› `Promise`ï¼šæ‰€æœ‰çš„ `execQueue` é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•ï¼Œ`start` æ‰ä¼šåœ¨æœ€å `resolve`

**æœ‰ 1 å¤„å­˜åœ¨å³æ‰§è¡Œï¼š**

- `asyncScriptResultList`ï¼šå­åº”ç”¨ä¸­å¸¦æœ‰ `async` çš„ `script`

> è¿˜æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼ŒåŠ¨æ€åŠ è½½åº”ç”¨ä¸­çš„æ ·å¼å’Œ `script` [[æŸ¥çœ‹](#7-åŠ¨æ€åŠ è½½æ ·å¼å’Œ-script)]

æ€»å…± 8 å¤„ï¼Œç„¶åæ ¹æ®ç”¨é€”è¿˜å¯ä»¥ç»†åˆ†å¦‚ä¸‹

**å¿…é¡»ä¼šæ·»åŠ åˆ°é˜Ÿåˆ—æœ‰ 4 å¤„ï¼š**

- `this.mount`ã€`domContentLoadedTrigger`ã€`domLoadedTrigger`ã€è¿”å›çš„ `Promise` å¯¹è±¡

**æ ¹æ®é›†åˆæ·»åŠ åˆ°é˜Ÿåˆ—æœ‰ 3 å¤„ï¼š**

- `beforeScriptResultList`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-before-loaders)]
- `afterScriptResultList`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-after-loader)]
- `syncScriptResultList` + `deferScriptResultList`ï¼šæå–å­åº”ç”¨çš„ `script`

> `beforeScriptResultList` å’Œ `afterScriptResultList` ä¸‹æ ‡ç±»å‹æ–‡æ¡£ä»‹ç»æœ‰é™ï¼Œå»ºè®®æŸ¥çœ‹æºç ç±»å‹ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L22)]

**æå–å­åº”ç”¨çš„ `script`ï¼š**

é€šè¿‡ `getExternalScripts` å¾—åˆ° `scriptResultList` [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]

å£°æ˜ 3 ä¸ªé›†åˆï¼š

- `syncScriptResultList`ï¼šåŒæ­¥ä»£ç 
- `asyncScriptResultList`ï¼š`async` æ— éœ€ä¿è¯åŠ è½½é¡ºåºï¼Œæ‰€ä»¥ä¸ç”¨æ”¾å…¥æ‰§è¡Œé˜Ÿåˆ—
- `deferScriptResultList`ï¼š`defer` éœ€è¦ä¿è¯åŠ è½½é¡ºåºå¹¶ä¸”åœ¨è§¦å‘ `DOMContentLoaded` å‰å®Œæˆ

éå† `scriptResultList` æ ¹æ®å±æ€§åˆ†ç±»æ·»åŠ åˆ°ä¸Šè¿° 3 ä¸ªé›†åˆï¼Œå…³äºå±æ€§è§ï¼š`processTpl` æå–èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

> æ— è®ºæ˜¯åŒæ­¥ä»£ç è¿˜æ˜¯å¼‚æ­¥ä»£ç ï¼Œ`getExternalScripts` æå–çš„ `script` éƒ½æ˜¯åº”ç”¨ä¸­çš„é™æ€èµ„æºï¼Œè€Œä¸æ˜¯åŠ¨æ€æ·»åŠ çš„ `script`ï¼›è€Œåƒ `React` å’Œ `Vue` è¿™æ ·çš„å•ä¾‹åº”ç”¨é€šå¸¸åªæš´éœ²ä¸€ä¸ªé™æ€çš„ `script` ä½œä¸ºå…¥å£ï¼Œå…¶ä½™çš„ `script` å’Œæ ·å¼åŠ¨æ€æ·»åŠ ï¼Œè§ï¼š`rewriteAppendOrInsertChild` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

**éå†çš„é›†åˆä¸‹æ ‡æ˜¯ `promise` æœ‰ 2 å¤„ï¼š**

- åŒæ­¥å’Œå¼‚æ­¥ä»£ç æ‰§è¡Œï¼š`syncScriptResultList`ã€`asyncScriptResultList`
- å…±åŒç‚¹ï¼šé›†åˆä¸­çš„æ¯ä¸€ä¸ªæ–¹æ³•éƒ½è¿”å› `Promise`ã€éœ€è¦åœ¨å¾®ä»»åŠ¡ä¸­æ‰§è¡Œ `insertScriptToIframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]
- ä¸åŒç‚¹ï¼š`syncScriptResultList` éœ€è¦ç­‰å¾…é˜Ÿåˆ—æŒ‰é¡ºåºæå–æ‰§è¡Œï¼Œ`asyncScriptResultList` éå†åŒæ—¶ç«‹å³å‘èµ·å¾®ä»»åŠ¡

**æ’å…¥é˜Ÿåˆ— `execQueue` çš„æ–¹æ³•æ˜¯åŒæ­¥ä»»åŠ¡ï¼š**

- åœ¨é˜…è¯»æ‰§è¡Œé˜Ÿåˆ—å‰éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ‰€æœ‰é˜Ÿåˆ—éƒ½æ˜¯åœ¨ä¸Šä¸‹æ–‡ä¸­ `push`
- æ‰€æœ‰ `push` çš„æ–¹æ³•éƒ½æ˜¯åŒæ­¥ä»»åŠ¡ï¼Œè€Œæ–¹æ³•ä¸­å…è®¸å‘èµ·å¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡
- å³ä¾¿æ˜¯æœ€åè¿”å›çš„ `Promise`ï¼Œä¹Ÿæ˜¯åœ¨ `Promise` æ–¹æ³•ä¸­åŒæ­¥æ’å…¥æ‰§è¡Œçš„é˜Ÿåˆ—

#### 2. æ‰§è¡Œé˜Ÿåˆ—

æ— è®ºæ€ä¹ˆæ·»åŠ é˜Ÿåˆ—ï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡ `this.execQueue.shift()()` ä»å¤´éƒ¨å¼¹å‡ºæ’å…¥é˜Ÿåˆ—çš„æ–¹æ³•å¹¶æ‰§è¡Œ

å¼€å§‹æ‰§è¡Œï¼š

- æ‰§è¡Œé˜Ÿåˆ—ä» 334 è¡Œå¼€å§‹ï¼ŒæŒ‰ç…§ä¸Šä¸‹æ–‡ä¸»åŠ¨æå–å¹¶å‘èµ·æ‰§è¡Œï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L334)]
- `asyncScriptResultList` ä¸åŠ å…¥é˜Ÿåˆ—ï¼Œä¼šä»¥ `Promise` å¾®ä»»åŠ¡çš„å½¢å¼åœ¨å½“å‰ä¸Šä¸‹æ–‡æ‰§è¡Œå®Œæ¯•åä¾æ¬¡æ‰§è¡Œ

éœ€è¦è¯´æ˜çš„æ˜¯ï¼š

- å¼€å§‹æå– `execQueue` æ˜¯åœ¨ `start` è¿”å› `Promise` ä¹‹å‰æ‰§è¡Œï¼Œé˜Ÿåˆ—æ–¹æ³•å’Œ `Promise` å†…éƒ¨æ–¹æ³•æ˜¯ä¸Šä¸‹æ–‡
- æ‰€ä»¥é˜Ÿåˆ—å¼€å§‹æ—¶ï¼Œè¿”å›çš„ `Promise` è¿˜æ²¡æœ‰å°†æœ€åè¦æ‰§è¡Œçš„é˜Ÿåˆ—æ’å…¥ `execQueue`

å¾ªç¯æ’å…¥é˜Ÿåˆ—å…±æœ‰ 3 å¤„ï¼š

- åˆ†åˆ«æ˜¯ï¼š`beforeScriptResultList`ã€`syncScriptResultList` + `deferScriptResultList`ã€`afterScriptResultList`
- æ¯ä¸ªé˜Ÿåˆ—é€šè¿‡ `insertScriptToIframe` æ³¨å…¥ `script` åˆ°æ²™ç®± `iframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]
- æ³¨å…¥ `script` ä¹‹åå†å°† `window.__WUJIE.execQueue.shift()()` æ³¨å…¥æ²™ç®± `iframe`
- è¿™æ ·æ¯ä¸ª `push` çš„é˜Ÿåˆ—ï¼Œä¼šåœ¨æ²™ç®± `iframe` åŠ è½½å®Œ `script` åé€šè¿‡ `shift` æå–ä¸‹ä¸€ä¸ªä»»åŠ¡å¹¶æ‰§è¡Œ

ä¸»åŠ¨æ’å…¥é˜Ÿåˆ—æœ‰ 4 å¤„ï¼š

- `mount`ã€`domContentLoadedTrigger`ã€`domLoadedTrigger`ã€è¿”å›çš„ `Promise`
- ä¼šåœ¨æ‰§å‡½æ•°æœ«å°¾æ·»åŠ  `this.execQueue.shift()?.();` æå–å¹¶æ‰§è¡Œæ¥ä¸‹æ¥çš„é˜Ÿåˆ—

å¦‚æœæ²¡æœ‰ä¸»åŠ¨é…ç½® `fiber` ä¸º `false` çš„æƒ…å†µä¸‹ï¼š

- é™¤æœ€åè¿”å›çš„ `Promise` ä¹‹å¤–ï¼Œæ‰€æœ‰çš„é˜Ÿåˆ—å°†åŒ…è£¹åœ¨å®ä»»åŠ¡ `requestIdleCallback` ä¸­ç©ºé—²æ‰§è¡Œ
- ä½†æ˜¯æ¯ä¸ªé˜Ÿåˆ—çš„æ‰§è¡Œï¼Œå¿…é¡»æ˜¯åœ¨ä¸Šä¸€ä¸ªé˜Ÿåˆ—ç»“æŸåé€šè¿‡ `shift` æå–å¹¶æ‰§è¡Œ

æ— è®ºé˜Ÿåˆ—ä¸­æ‰§è¡Œçš„æ˜¯ä¸Šä¸‹æ–‡ï¼Œè¿˜æ˜¯å¾®ä»»åŠ¡ï¼Œäº¦æˆ–è€…æ˜¯å®ä»»åŠ¡ï¼Œæœ€ç»ˆéƒ½éœ€è¦æŒ‰ç…§é˜Ÿåˆ—é¡ºåºæ¥

> åœ¨ `WuJie` å®ä¾‹ä¸­é€šè¿‡ `this.requestIdleCallback` æ‰§è¡Œç©ºé—²åŠ è½½ï¼Œå®ƒå’Œ `requestIdleCallback` çš„åŒºåˆ«åœ¨äºï¼Œæ¯æ¬¡æ‰§è¡Œå‰å…ˆåˆ¤æ–­å®ä¾‹æ˜¯å¦å·²é”€æ¯æ²™ç®± `iframe`

åªæœ‰ 1 ç§æƒ…å†µå¯ä»¥æ— è§†é˜Ÿåˆ—é¡ºåºï¼š

- `asyncScriptResultList`ï¼šå­åº”ç”¨ä¸­å¼‚æ­¥åŠ è½½çš„ `script`

è€Œæœ€åè¿”å›çš„ `promise` ä¹Ÿåªåš 1 ä»¶äº‹ï¼š

- æ’å…¥æœ€ç»ˆæ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œåœ¨é˜Ÿåˆ—çš„æ–¹æ³•ä¸­å°†æ‰§è¡Œ `resolve` é€šçŸ¥å¤–éƒ¨ `start` å®Œæˆ

#### 3. é˜Ÿåˆ—æ‰§è¡Œé¡ºåº

é˜Ÿåˆ—æœ‰ 3 å¤„å¾®ä»»åŠ¡ï¼š

- `asyncScriptResultList`ï¼šå¼‚æ­¥ä»£ç 
- `syncScriptResultList` + `deferScriptResultList`ï¼šåŒæ­¥ä»£ç 
- è¿”å›çš„ `Promise` å¯¹è±¡

> åªæœ‰å¼‚æ­¥ä»£ç æ˜¯ç«‹å³æ·»åŠ å¾®ä»»åŠ¡ï¼Œå…¶å®ƒæŒ‰ç…§ `execQueue` é˜Ÿåˆ—é¡ºåºç­‰å¾…æå–å¹¶æ‰§è¡Œ

`fiber` æ²¡æœ‰å…³é—­çš„æƒ…å†µä¸‹æœ‰ 7 å¤„å®ä»»åŠ¡ï¼š

- é™¤äº†é€šè¿‡è¿”å›çš„ `Promise` æ’å…¥æœ«å°¾çš„é˜Ÿåˆ—ï¼Œéƒ½ä¼šé€šè¿‡ `requestIdleCallback` æ’å…¥å®ä»»åŠ¡

> æ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ `execQueue` é˜Ÿåˆ—å…ˆåé¡ºåºæ‰§è¡Œ

æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š

1. `asyncScriptResultList` éå†å¼‚æ­¥ä»£ç ï¼Œå°†å¾®ä»»åŠ¡æ”¾å…¥å¾®é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ
2. 334 è¡Œå¼€å§‹æå–ç¬¬ 1 ä¸ªé˜Ÿåˆ—å¹¶æ‰§è¡Œ `this.execQueue.shift()()`
3. æ‰§è¡Œ `beforeScriptResultList`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
4. æ‰§è¡Œ `syncScriptResultList` + `deferScriptResultList`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
5. ä¾æ¬¡æ‰§è¡Œ `mount`ã€`domContentLoadedTrigger`
6. æ‰§è¡Œ `afterScriptResultList`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
7. æ‰§è¡Œ `domLoadedTrigger`
8. é€šè¿‡è¿”å›çš„ `Promise` æ–¹æ³•ä¸­æ‰§è¡Œæœ€åæ·»åŠ åˆ° `execQueue` çš„æ–¹æ³•

`asyncScriptResultList` æ‰§è¡Œé¡ºåºï¼š

- ä¼šåœ¨ `execQueue` é˜Ÿåˆ—ä¸­ç¬¬ 1 ä¸ªå¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡ä¹‹å‰å®Œæˆæ‰€æœ‰å¼‚æ­¥ä»£ç æ³¨å…¥

> å› ä¸ºå¼‚æ­¥ä»£ç å±äºå¾®ä»»åŠ¡ï¼Œä¸Šä¸‹æ–‡å¿…ç„¶ä¼šä¼˜å…ˆæ‰§è¡Œ

`fiber` æ¨¡å¼ï¼Œç¬¬ 1 å¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡ï¼š

- `beforeScriptResultList` å­˜åœ¨çš„è¯ï¼Œç¬¬ 1 ä¸ªé˜Ÿåˆ—æ˜¯å®ä»»åŠ¡ï¼Œå¦åˆ™ç»§ç»­å¾€ä¸‹çœ‹
- åŒæ­¥ä»£ç å­˜åœ¨çš„è¯ï¼Œç¬¬ 1 ä¸ªé˜Ÿåˆ—æ˜¯å¾®ä»»åŠ¡ï¼Œå¦åˆ™ç»§ç»­å¾€ä¸‹çœ‹
- ä»¥ä¸Šéƒ½ä¸å­˜åœ¨çš„è¯ä¼šé€šè¿‡ `mount` å‘èµ·ç¬¬ä¸€ä¸ªå®ä»»åŠ¡

> `fiber` æ¨¡å¼ä¸‹é˜Ÿåˆ—æŒ‰ç…§é¡ºåºæ‰§è¡Œå®Œ 1 ä¸ªï¼Œæå–ä¸‹ä¸ªé˜Ÿåˆ—å†æ‰§è¡Œ

å…³é—­ `fiber` æ¨¡å¼ï¼Œç¬¬ 1 ä¸ªå¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡ï¼š

- `beforeScriptResultList` å­˜åœ¨å¤–è” `script`ï¼Œç¬¬ 1 ä¸ªå®ä»»åŠ¡ç”± `onload` å‘èµ·
- åŒæ­¥ä»£ç å­˜åœ¨ï¼Œç¬¬ 1 ä¸ªå¾®ä»»åŠ¡ç”± `Promise` å‘èµ·ï¼Œå¦åˆ™ç»§ç»­å¾€ä¸‹çœ‹
- `afterScriptResultList` å­˜åœ¨å¤–è” `script`ï¼Œç¬¬ 1 ä¸ªå®ä»»åŠ¡ç”± `onload` å‘èµ·
- åœ¨æœ€åè¿”å›çš„ `Promise` å¯¹è±¡ `resolve` å®Œæˆä»»åŠ¡å‰æ‰§è¡Œ `asyncScriptResultList`

> é¡ºåºä»ä¸Šè‡³ä¸‹æœ‰ 1 æ¡æ»¡è¶³åé¢çš„å°±ä¸ç”¨å†çœ‹

è™½ç„¶å…³é—­äº† `fiber`ï¼Œä½†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¾æ—§æ˜¯æŒ‰ç…§é¡ºåºï¼Œæ‰§è¡Œå®Œ 1 ä¸ªï¼Œæå–ä¸‹ä¸ªé˜Ÿåˆ—å†æ‰§è¡Œ

- é˜Ÿåˆ—çš„æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œè™½ç„¶æ–¹æ³•å†…éƒ¨å¯èƒ½ä¼šå‘èµ·å¾®ä»»åŠ¡

ä¸ºä»€ä¹ˆå¤–è” `script` æ˜¯å®ä»»åŠ¡ï¼š

- é˜Ÿåˆ—ä¸­æ— è®ºæ˜¯ `appendChild` è¿˜æ˜¯ `dispatchEvent` éƒ½æ˜¯åŒæ­¥æ“ä½œ
- åªæœ‰é€šè¿‡ `src` åŠ è½½çš„ `script` ä¼šé€šè¿‡å®ä»»åŠ¡ `onload` å›è°ƒæ‰§è¡Œ `execQueue.shift()()`

> `start` åœ¨è¿”å› `Promise` ä¹‹å‰ï¼Œé˜Ÿåˆ—ä¸­åªæœ‰åŒæ­¥æ–¹æ³•ä¼šå­˜åœ¨é—®é¢˜ï¼Œè§ï¼š`start` å¯åŠ¨åº”ç”¨çš„ `bug` [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)]

ä¸ºä»€ä¹ˆå…³æ³¨ `asyncScriptResultList` å¼‚æ­¥ä»£ç æ‰§è¡Œé¡ºåºï¼š

- å› ä¸º `execQueue` é˜Ÿåˆ—ä¸­æ‰€æœ‰åŒæ­¥çš„æ–¹æ³•ã€å¾®ä»»åŠ¡ã€å®ä»»åŠ¡ï¼Œéƒ½æŒ‰ç…§é˜Ÿåˆ—å…ˆåé¡ºåº
- é€šè¿‡å¼‚æ­¥ä»£ç å¯ä»¥ä½œä¸ºå‚è€ƒå¯¹è±¡ï¼Œå¾ˆå¥½çš„äº†è§£æ•´ä¸ªé˜Ÿåˆ—çš„æ‰§è¡Œé¡ºåº
- å¦‚æœå¼‚æ­¥ä»£ç ä¸å­˜åœ¨ï¼Œæ‰§è¡Œé¡ºåºä¾æ—§æ²¡å˜ï¼Œå¿½ç•¥å¼‚æ­¥ä»£ç å¾®ä»»åŠ¡é›†åˆï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œå¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡

> ä¸€é“æ€è€ƒé¢˜ï¼šåº”ç”¨ä¸­çš„ `script` æ˜¯æ€ä¹ˆæ³¨å…¥åˆ°æ²™ç®± `iframe`ï¼Œè§ï¼šé˜Ÿåˆ—å‰çš„å‡†å¤‡ [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]

**å…³äºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š**

åœ¨ `micro-app` æœ‰ä¸€ä¸ª `injectFiberTask`ï¼Œè§ `micro-app` æºç åˆ†æä¸­æ³¨ â‘­ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#13-extractsourcedom-%E6%88%90%E5%8A%9F%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E5%9B%9E%E8%B0%83)]ï¼Œå¯¹æ¯”å¦‚ä¸‹ï¼š

| å¯¹æ¯”é¡¹   | `wujie`                                                      | `micro-app`                                                  |
| -------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| æ·»åŠ é˜Ÿåˆ— | æ ¹æ®ä¸åŒç±»å‹ï¼Œæ‰‹åŠ¨æ·»åŠ æ¯ä¸€ç»„é˜Ÿåˆ—                             | `injectFiberTask`                                            |
| é›†åˆå¯¹è±¡ | `execQueue`                                                  | `fiberLinkTasks`                                             |
| æ·»åŠ æ–¹å¼ | `push`                                                       | `push`                                                       |
| æ‰§è¡Œæ–¹å¼ | `this.execQueue.shift()?.()`ï¼Œåœ¨å½“å‰é˜Ÿåˆ—æå–ä¸‹ä¸€ä¸ªé˜Ÿåˆ—å¹¶æ‰§è¡Œ | `serialExecFiberTasks`ï¼Œé€šè¿‡ `array.reduce` æ‹å¹³é˜Ÿåˆ—ä¾æ¬¡æ‰§è¡Œ |
| ç«‹å³æ‰§è¡Œ | `asyncScriptResultList`ï¼Œéå†é›†åˆæ·»åŠ åˆ°å¾®ä»»åŠ¡ä¸­æ‰§è¡Œ          | è°ƒç”¨ `injectFiberTask` æ—¶æä¾› `fiberTasks` ä¸º `null`         |

> æ¯”è¾ƒè€Œè¨€ `micro-app` çš„ `injectFiberTask`ï¼Œæ›´ç®€æ´ã€æŠ½è±¡ï¼Œçµæ´»åº¦ä¹Ÿæ›´é«˜

#### 4. `start` å¯åŠ¨åº”ç”¨çš„ `bug`

**é—®é¢˜ 1ï¼šæ‰§è¡Œå‰æœ€åè¿”å›çš„ `resolve` å¹¶æ²¡æœ‰æ’å…¥é˜Ÿåˆ—**

- å¦‚æœ `execQueue` é™¤äº†æœ€åè¿”å›çš„ `Promise` å¯¹è±¡ä¹‹å¤–ï¼Œæ²¡æœ‰å¾®ä»»åŠ¡ä¹Ÿæ²¡æœ‰å®ä»»åŠ¡
- é‚£ä¹ˆè¿”å›çš„ `Promise` å†…éƒ¨æ–¹æ³•ä¸­æ’å…¥ `execQueue` æœ«å°¾çš„é˜Ÿåˆ—æ°¸è¿œæ— æ³•æ‰§è¡Œ

åŸå› ï¼š

- å¼€å§‹æå–å¹¶æ‰§è¡Œé˜Ÿåˆ—çš„æ–¹æ³•ï¼Œç›¸å¯¹äºè¿”å›çš„ `Promise` å‡½æ•°ä¼˜å…ˆæ‰§è¡Œï¼Œå®ƒä»¬æ˜¯ä¸Šä¸‹æ–‡å…³ç³»
- å¦‚æœè¿”å›çš„ `Promise` ä¹‹å‰å…¨éƒ¨éƒ½æ˜¯ä¸Šä¸‹æ–‡åŒæ­¥å…³ç³»ï¼Œé‚£ä¹ˆå½“é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šå°† `Promise` ä¸­çš„é˜Ÿåˆ—æ’å…¥ `execQueue`
- è¿™æ ·å°±æ„å‘³ç€æ°¸è¿œä¸ä¼šæ‰§è¡Œæœ«å°¾é˜Ÿåˆ—ä¸­çš„ `resove`ï¼Œå› æ­¤ `start` è¢«ä¸­æ–­

äº§ç”Ÿé—®é¢˜çš„å‰æå¿…é¡»ä»¥ä¸‹ 2 ä¸ªæ¡ä»¶å…¨æ»¡è¶³ï¼š

- æ‰‹åŠ¨å…³é—­ `fiber`
- é™æ€åº”ç”¨æ²¡æœ‰ `script`

`preloadApp` å‡ºç°é—®é¢˜çš„åœºæ™¯ï¼š

- é¢„åŠ è½½æœ¬èº«ä¸ä¼šå¯¼è‡´é—®é¢˜ï¼Œå› ä¸ºé¢„åŠ è½½é»˜è®¤ä¸ä¼š `start`ï¼Œå³ä¾¿é…ç½® `exec` å¯åŠ¨åº”ç”¨ `start`ï¼Œé—®é¢˜ä¹Ÿä¼šå‘ç”Ÿåœ¨ `startApp` åˆ‡æ¢åº”ç”¨æ—¶

`startApp` å¯åŠ¨åº”ç”¨ `start` é—®é¢˜çš„åœºæ™¯ï¼š

| è§¦å‘æ¡ä»¶     | åŒ…å«æ¨¡å¼         | é—®é¢˜                                                |
| ------------ | ---------------- | --------------------------------------------------- |
| é¢„åŠ è½½åå¯åŠ¨ | `alive` æ¨¡å¼åº”ç”¨ | ç”Ÿå‘½å‘¨æœŸ `activated` å¯èƒ½ä¼šä¸æ‰§è¡Œï¼Œ`destroy` ä¸è¿”å› |
| é¢„æ‰§è¡Œåå¯åŠ¨ | æ‰€æœ‰æ¨¡å¼         | å¡åœ¨ `await sandbox.preload` æš‚åœä¸å†æ‰§è¡Œ           |
| åˆæ¬¡å¯åŠ¨     | `umd` å’Œé‡å»ºæ¨¡å¼ | `destroy` ä¸è¿”å›                                    |
| åˆ‡æ¢åº”ç”¨     | é‡å»ºæ¨¡å¼         | `destroy` ä¸è¿”å›                                    |

> å…³äºé¢„åŠ è½½å’Œé¢„æ‰§è¡Œï¼Œè§ï¼š`preloadApp` [[æŸ¥çœ‹](#preloadapp-é¢„åŠ è½½æµç¨‹)]

`fiber` ä¸‹èƒ½æ­£å¸¸æ‰§è¡Œï¼š

- é™¤äº†æœ€åè¿”å›çš„ `Promise`ï¼Œæ‰€æœ‰é˜Ÿåˆ—éƒ½é€šè¿‡å®ä»»åŠ¡ `requestIdleCallback` ä¸­æ‰§è¡Œ
- `start` è¿”å›çš„ `Promise` å†…éƒ¨å‡½æ•°å±äºä¸Šä¸‹æ–‡ï¼Œä¼˜å…ˆäºå®ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—

> `fiber` åªèƒ½æä¾›æ‰‹åŠ¨é…ç½®å…³é—­ï¼Œé»˜è®¤ä¸º `true`

é™æ€æå–å’ŒåŠ¨æ€æ³¨å…¥çš„ `script` èƒ½æ­£å¸¸æ‰§è¡Œï¼š

- é™æ€æå–çš„ `script` å°†ä½œä¸ºåŒæ­¥æˆ–å¼‚æ­¥ä»£ç ï¼Œæ¯ä¸€ä¸ªé˜Ÿåˆ—éƒ½æ˜¯å¾®ä»»åŠ¡
- åŠ¨æ€æ³¨å…¥çš„ `script` å‰æä¸€å®šæ˜¯æ¥è‡ªåŒæ­¥æˆ–å¼‚æ­¥ä»£ç é˜Ÿåˆ—æ“ä½œ

æ‰‹åŠ¨æ³¨å…¥ `script` ä¸”ä¸ä¸º `async`ï¼Œå°†æ ¹æ®æƒ…å†µå†³å®šï¼š

- åŒ…å«å¤–è” `script`ï¼šä¸‹ä¸ªé˜Ÿåˆ—å°†é€šè¿‡ `onload` å®ä»»åŠ¡æå–å¹¶æ‰§è¡Œï¼Œèƒ½æ­£å¸¸æ‰§è¡Œ
- ä»…æœ‰å†…è” `script`ï¼šå°†å¯¼è‡´é—®é¢˜ 1

> æ‰‹åŠ¨æ³¨å…¥å¸¦æœ‰ `async` å±æ€§çš„ `script` å°†å¯¼è‡´é—®é¢˜ 2

**é—®é¢˜ 2ï¼šé€šè¿‡æ‰‹åŠ¨æ³¨å…¥ `script` æ‰“æ–­é˜Ÿåˆ—**

- å¦‚æœ `beforeScriptResultList` æˆ– `afterScriptResultList` å­˜åœ¨ `async` å±æ€§çš„ `script`
- å°†å¯¼è‡´æ— æ³•æå–æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé€ æˆ `execQueue` é˜Ÿåˆ—åé¢çš„ `script` å°†ä¸èƒ½æ’å…¥æ²™ç®±

åŸå› ï¼š

- æ²™ç®±æ³¨å…¥å¤–è” `script` åï¼Œä¼šæ ¹æ® `async` å»åˆ¤æ–­è¦ä¸è¦æ‰§è¡Œä¸‹ä¸€æ¡é˜Ÿåˆ—

æ’é™¤èŒƒå›´ï¼š

- `processTpl` æå–å¸¦æœ‰ `async` çš„å¤–è” `script`ï¼Œå°†ä½œä¸ºå¼‚æ­¥ä»£ç æ³¨å…¥æ²™ç®±ï¼Œä¸å½±å“é˜Ÿåˆ— [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- `rewriteAppendOrInsertChild` åŠ¨æ€æ·»åŠ çš„ `script` ä¸å­˜åœ¨ `async` å±æ€§ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

é—®é¢˜ 2 çš„åœºæ™¯åŒ…å«äº†é—®é¢˜ 1ï¼Œæ­¤å¤–å› æ‰“æ–­ `nextScriptElement` ä»è€Œå¯¼è‡´åç»­é˜Ÿåˆ—æ— æ³•æ‰§ï¼š

- æ‰§è¡Œé¡ºåºè§ï¼šé˜Ÿåˆ—æ‰§è¡Œé¡ºåº [[æŸ¥çœ‹](#3-é˜Ÿåˆ—æ‰§è¡Œé¡ºåº)]

è®¾è®¡åˆè¡·ï¼š

- å› ä¸ºå¼‚æ­¥ä»£ç  `asyncScriptResultList` å’Œ `execQueue` é˜Ÿåˆ—é›†åˆæ˜¯æ²¡æœ‰å…³ç³»
- ä½†å¼‚æ­¥ä»£ç ä¹Ÿæ˜¯é€šè¿‡ `insertScriptToIframe` å°† `script` æ’å…¥æ²™ç®± `iframe`
- å¦‚æœå¼‚æ­¥ä»£ç ä¹Ÿå»è°ƒç”¨ `execQueue.shift()()`ï¼Œå¯èƒ½ä¼šé€ æˆé˜Ÿåˆ—æ‰§è¡Œé¡ºåºé”™ä¹±

å¤ç°é—®é¢˜ 1ï¼šæ²¡æœ‰ `script`

- `static-app`ï¼šåˆ›å»ºä¸€ä¸ªæ²¡æœ‰ `script`ï¼Œæ²¡æœ‰ `style` çš„é™æ€å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static)]
- æ·»åŠ ä¸€ä¸ª `StaticPage.tsx` é¡µé¢ç»„ä»¶ï¼Œå…³é—­ `fiber`ï¼Œä¸æ·»åŠ  `js-loaders` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/StaticPage.tsx)]
- åº”ç”¨ç»„ä»¶ `Wujie.tsx`ï¼šæ·»åŠ  `startApp` è¿”å›çš„å‡½æ•° `destroy` å¹¶æ‰“å° [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/components/Wujie.tsx)]

å¤ç°ç»“æœï¼š

- ç‚¹å¼€ `static` åº”ç”¨ï¼Œæ‰“å¼€è°ƒè¯•é¢æ¿ï¼Œåˆ·æ–°é¡µé¢ä»€ä¹ˆéƒ½æ²¡è¿”å›
- ç‚¹å¼€ `react` åº”ç”¨ï¼Œè¿”å› `destroy` æ–¹æ³•

å¤ç°é—®é¢˜ 1ï¼šå­˜åœ¨ `async` çš„ `script` å¯ä»¥æ­£å¸¸æ³¨å…¥

- å­åº”ç”¨ä¸­æ·»åŠ è·¯ç”± `/async`ï¼Œåœ¨é¡µé¢ä¸­æ·»åŠ ä¸€æ®µ `async` å±æ€§çš„ `script` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static/blob/main/async/index.html)]
- åœ¨åŸºåº§ä¸­æ·»åŠ ç›¸åº”çš„ç»„ä»¶ `AsyncPage.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/AsyncPage.tsx)]

å¤ç°ç»“æœï¼š

- å­åº”ç”¨ä¸­ `script` çš„ `async` ä¼šé€šè¿‡å¼‚æ­¥é›†åˆ `asyncScriptResultList` æ·»åŠ åˆ°æ²™ç®± `iframe` ä¸­
- `asyncScriptResultList` ä¸ä¼šå½±å“ `execQueue`

ä¿®å¤é—®é¢˜ 1ï¼š

- æºç  334 è¡Œï¼Œç¬¬ 1 ä¸ªæ‰§è¡Œé˜Ÿåˆ— `this.execQueue.shift()();` å‰ä¸»åŠ¨æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L334)]
- è¿™æ ·ç¡®ä¿é˜Ÿåˆ—ä¸­æœ€å°‘åŒ…å« 1 ä¸ªå¾®ä»»åŠ¡ï¼Œè€Œè¿”å›çš„ `Promise` å†…éƒ¨å‡½æ•°ä¼šåœ¨é˜Ÿåˆ—ç»“æŸå‰æ‰§è¡Œ
- è¿™æ ·ç¡®ä¿äº†é˜Ÿåˆ—æœ€åèƒ½å¤Ÿé¡ºåˆ© `resolve`

```
this.execQueue.push(() => Promise.resolve().then(
  () => this.execQueue.shift()?.()
));
this.execQueue.shift()();
```

å¤ç°é—®é¢˜ 2ï¼šæ‰‹åŠ¨æ³¨å…¥ `script` æ‰“æ–­ `execQueue` é˜Ÿåˆ—

- å¤ç°å‰ç¡®ä¿ `react` åº”ç”¨æ­£å¸¸ï¼Œå¤åˆ¶ä¸€ä»½ `ReactPage.tsx` ä½œä¸º `BeforePage.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/BeforePage.tsx)]
- é…ç½®æ‰‹åŠ¨æ³¨å…¥ `script`ï¼šè¦æ±‚å¸¦æœ‰ `src` å’Œ `async`

å¤ç°ç»“æœï¼š

- `BeforePage.tsx` åº”ç”¨åŠ è½½è¿‡ç¨‹ä¸­è¢« `jsBeforeLoaders` æ‰“æ–­ä¸ä¼š `mount` åº”ç”¨

ä¿®å¤é—®é¢˜ 2ï¼š

- éå† `beforeScriptResultList` å’Œ `afterScriptResultList` æ—¶å»æ‰ `script` çš„ `async`ï¼Œå¦‚ä¸‹ï¼š

```
beforeScriptResultList.forEach(({ async, ...beforeScriptResult }) => {})
afterScriptResultList.forEach(({ async, ...afterScriptResult }) => {})
```

ç”±äºç›®å‰è¿˜åœ¨ç ”ç©¶é˜¶æ®µï¼Œæ²¡æœ‰å¯¹å®˜æ–¹æ `PR`ã€‚

**å…³äº `bug` çš„æ€»ç»“ï¼š**

1. ä½¿ç”¨ `wujie` è¿‡ç¨‹ä¸­è°¨æ…å…³é—­ `fiber`ï¼Œé»˜è®¤æ˜¯ä¸ä¼šå…³é—­ `fiber` çš„
2. ä¸è¦åœ¨ `beforeScriptResultList` æˆ– `afterScriptResultList` ä¼ å…¥å¸¦æœ‰ `async` å±æ€§çš„å¯¹è±¡ï¼Œè™½ç„¶ `ScriptObjectLoader` è¿™ä¸ªå¯¹è±¡æ˜¯å…è®¸é…ç½® `async` çš„ï¼Œè™½ç„¶å®˜æ–¹åœ¨æ–‡æ¡£ä¸­ä¹Ÿå¹¶æ²¡æœ‰è¯´ `async` æ˜¯å¯é€‰é…ç½®ï¼Œä½†æ˜¯æ“…è‡ªæ·»åŠ  `async` åœ¨æºç ä¸­æ˜¯æœ‰é€»è¾‘é—®é¢˜çš„

#### 5. é˜Ÿåˆ—å‰çš„å‡†å¤‡

`execFlag` è®¾ç½®ä¸º `true`ï¼Œè¡¨ç¤ºå·²å¯åŠ¨åº”ç”¨ï¼š

- `execFlag` ä¼šåœ¨ `destroy` è®¾ `null`ï¼Œä»è¿™é‡ŒçŸ¥é“æ³¨é”€åº”ç”¨ååªèƒ½é‡æ–°åˆ›é€ åº”ç”¨å®ä¾‹

é€šè¿‡ `importHTML` åŒ…è£…æ–¹æ³• `getExternalScripts` æå–è¦æ³¨å…¥æ²™ç®±çš„é™æ€ `script` é›†åˆ [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]

- `getExternalScripts` è¿”å›çš„ `script` é›†åˆä¸­ï¼Œå±æ€§ `contentPromise` æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡
- è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåŒæ­¥ä»£ç å’Œå¼‚æ­¥ä»£ç éƒ½æ˜¯é€šè¿‡å¾®ä»»åŠ¡å°† `script` æ·»åŠ åˆ°æ²™ç®±ä¸­æ‰§è¡Œçš„åŸå› 

> ä¸ºäº†ä¿è¯å…¶é¡ºåºï¼Œä¹Ÿå› æ­¤ä¸ç®¡æ˜¯å¾®ä»»åŠ¡è¿˜æ˜¯å®ä»»åŠ¡ï¼Œéƒ½è¦æ±‚åœ¨ä¸Šä¸€ä¸ªé˜Ÿåˆ—æ‰§è¡Œå®Œåæå–æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—

ä¸€é“æ€è€ƒé¢˜ï¼šåº”ç”¨ä¸­çš„ `script` æ˜¯æ€ä¹ˆæ³¨å…¥åˆ°æ²™ç®± `iframe`

1. é€šè¿‡ `importHTML` æå–åº”ç”¨èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
2. é€šè¿‡ `processTpl` æå–èµ„æºä¸­çš„æ ·å¼å’Œ `script`ï¼Œå¹¶æ›¿æ¢æˆæ³¨é‡Š [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
3. é€šè¿‡ `processCssLoader` åŠ è½½æ ·å¼å¹¶è¿˜åŸåˆ°å…¥å£èµ„æº [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
4. é€šè¿‡ `active` å°†å¤„ç†çš„å…¥å£èµ„æºæ³¨å…¥å®¹å™¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
5. é€šè¿‡ `patchRenderEffect` ä¸ºå®¹å™¨æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]
6. é€šè¿‡ `start` æå– `script` åŠ å…¥é˜Ÿåˆ—ï¼Œå…¶ä¸­åŒ…æ‹¬åº”ç”¨å…¥å£ `script` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
7. é€šè¿‡ `insertScriptToIframe` å°†é˜Ÿåˆ—ä¸­çš„ `script` æ³¨å…¥æ²™ç®± `iframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]
8. ç”±äºå·²æ‰“è¡¥ä¸ï¼Œé€šè¿‡ `rewriteAppendOrInsertChild` å¤„ç†åŠ¨æ€æ·»åŠ çš„ `script` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]
9. å†æ¬¡æ‰§è¡Œ `insertScriptToIframe` å°†åŠ¨æ€æ·»åŠ çš„ `script` æ³¨å…¥æ²™ç®± `iframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

> `React` å…¥å£ `script` å°†ä½œä¸ºåŒæ­¥ä»£ç åœ¨å¾®ä»»åŠ¡ä¸­æ³¨å…¥æ²™ç®±ï¼Œç„¶åé€šè¿‡å¾®ä»»åŠ¡åŠ¨æ€åŠ è½½ `chunk script`

`iframeWindow` æå–æ²™ç®±çš„ `window`ï¼Œç”¨äºæ³¨å…¥ `script`

- åŒæ—¶ç»‘å®š `__POWERED_BY_WUJIE__` åˆ°æ²™ç®± `window`ï¼Œä¾¿äºå­åº”ç”¨ç¡®è®¤è¿è¡Œç¯å¢ƒ

æ‰§è¡Œé˜Ÿåˆ—ä¹‹å‰ä¼šé€šè¿‡ `removeLoading` å…³é—­ `loading` çŠ¶æ€ï¼š

- å…³äºåŠ è½½çŠ¶æ€ï¼Œè§ï¼šå¯åŠ¨åº”ç”¨æ—¶æ·»åŠ ã€åˆ é™¤ `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]

åˆ é™¤ `loading` çš„æ¡ä»¶ï¼š

- æ²¡æœ‰æä¾› `__WUJIE_UNMOUNT` çš„æ‰€æœ‰æ¨¡å¼ï¼Œå› ä¸º `start` ä¸èƒ½åƒ `active` é‚£æ ·åˆ¤æ–­å½“å‰åº”ç”¨æ˜¯åˆæ¬¡åŠ è½½è¿˜æ˜¯åˆ‡æ¢åº”ç”¨

`umd` æ¨¡å¼åˆæ¬¡å¯åŠ¨ä¼šé‡å¤è°ƒç”¨ `removeLoading`ï¼š

- ç¬¬ 1 éï¼šåœ¨ `execQueue` é˜Ÿåˆ—æå–æ‰§è¡Œå‰ï¼Œ`__WUJIE_UNMOUNT` è¿˜æ²¡æœ‰æŒ‚è½½
- ç¬¬ 2 éï¼šå°†åº”ç”¨å…¥å£ `script` æ³¨å…¥æ²™ç®±åï¼Œå‘èµ· `mount` æŒ‚è½½åº”ç”¨ [[æŸ¥çœ‹](#-mount-æŒ‚è½½åº”ç”¨)]

> é‡å¤åˆ é™¤ `loading` åªèƒ½å¯¼è‡´é‡å¤æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°ä½¿ç”¨ä¸Šçš„é—®é¢˜

#### 6. å¿…é¡»æ·»åŠ é˜Ÿåˆ—çš„ 4 ä¸ªæ–¹æ³•

**1. ä¸»åŠ¨è°ƒç”¨ `mount` æ–¹æ³•**

- è§ï¼š`mount` æŒ‚è½½åº”ç”¨ [[æŸ¥çœ‹](#-mount-æŒ‚è½½åº”ç”¨)]

**2. è§¦å‘ `DOMContentLoaded` äº‹ä»¶**

- åˆ›å»º `DOMContentLoaded` è‡ªå®šä¹‰äº‹ä»¶ï¼Œåˆ†åˆ«ç”±æ²™ç®± `document` å’Œæ²™ç®± `window` è§¦å‘

**3. è§¦å‘ `loaded` äº‹ä»¶**

- è‡ªå®šä¹‰äº‹ä»¶ `readystatechange`ï¼Œç”±æ²™ç®± `document` è§¦å‘
- è‡ªå®šä¹‰äº‹ä»¶ `load`ï¼Œç”±æ²™ç®± `window` è§¦å‘

**4. è¿”å› `Promise`**

- é€šè¿‡åœ¨è¿”å›çš„ `Promise` å‡½æ•°ä¸­æ·»åŠ é˜Ÿåˆ—æœ€åè¦æ‰§è¡Œçš„ä»»åŠ¡
- `resolve` é‡Šæ”¾è¿”å›çš„å¾®ä»»åŠ¡ï¼Œç”¨äºé€šçŸ¥ `start` å®Œæ¯•

#### 7. åŠ¨æ€åŠ è½½æ ·å¼å’Œ `script`

å•ä¾‹åº”ç”¨ä¼šå°†é™æ€ `script` ä½œä¸ºå…¥å£ `script`ï¼Œç„¶ååŠ¨æ€åŠ è½½æ ·å¼å’Œ `script`ï¼Œä½†æ ¹æ®æ‰“åŒ…å·¥å…·ä¸åŒï¼Œå…¥å£ `script` æ³¨å…¥æ–¹å¼ä¹Ÿä¸åŒã€‚

| æ‰“åŒ…å·¥å…·           | å…¥å£ `script`                | æ³¨å…¥æ–¹å¼                     |
| ------------------ | ---------------------------- | ---------------------------- |
| `vite`             | å¤–è” `module`                | å¤–è” `module`                |
| `react-create-app` | å¸¦æœ‰ `defer` çš„å¤–è” `script` | å†…è” `script` å¹¶å¿½ç•¥ `defer` |
| `umijs`            | å¤–è” `script`                | å†…è” `script`                |

> æ³¨å…¥æ–¹å¼è§ï¼š`getExternalScripts` [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]

æ— è®ºæ˜¯å“ªç§ç±»å‹ `script`ï¼Œéƒ½ä¼šä½œä¸ºåŒæ­¥ä»£ç æ³¨å…¥æ²™ç®±ï¼š

- æ¯ä¸ªåŒæ­¥ä»£ç é˜Ÿåˆ—éƒ½æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡
- `fiber` å¼€å¯çŠ¶æ€ä¸‹æ¯ä¸ªå¾®ä»»åŠ¡éƒ½ä¼šå‘èµ·å®ä»»åŠ¡ `requestIdleCallback`

> æ— è®ºå¾®ä»»åŠ¡è¿˜æ˜¯å®ä»»åŠ¡ï¼Œä¸‹ä¸ªé˜Ÿåˆ—ä¸€å®šæ˜¯åœ¨å½“å‰ä»»åŠ¡ç»“æŸåå‘èµ·

åŠ¨æ€åŠ è½½èµ„æºæ ¹æ®ç±»å‹ä¸åŒåŠ è½½æ–¹å¼ä¹Ÿä¸ä¸€æ ·ï¼š

| åˆ†ç±»          | `fiber`  | åŠ è½½æ–¹å¼                            | æ³¨å…¥æ–¹å¼                     |
| ------------- | -------- | ----------------------------------- | ---------------------------- |
| å†…è”æ ·å¼      | --       | æ— éœ€è½½                              | ä¸Šä¸‹æ–‡åŒæ­¥                   |
| å¤–è”æ ·å¼      | --       | `getExternalStyleSheets` å‘èµ·å¾®ä»»åŠ¡ | ä¸Šä¸‹æ–‡åŒæ­¥                   |
| å¤–è” `script` | é»˜è®¤é…ç½® | `getExternalScripts` å‘èµ·å¾®ä»»åŠ¡     | `requestIdleCallback` å®ä»»åŠ¡ |
| å¤–è” `script` | æ‰‹åŠ¨å…³é—­ | `getExternalScripts` å‘èµ·å¾®ä»»åŠ¡     | ä¸Šä¸‹æ–‡åŒæ­¥                   |
| å†…è” `script` | é»˜è®¤é…ç½® | æ— éœ€è½½                              | `requestIdleCallback` å®ä»»åŠ¡ |
| å†…è” `script` | æ‰‹åŠ¨å…³é—­ | æ— éœ€è½½                              | ä¸Šä¸‹æ–‡åŒæ­¥                   |

é»˜è®¤æƒ…å†µä¸‹åœ¨ `React` åº”ç”¨ä¸­ï¼š

- æ ·å¼ï¼šä¼šæ·»åŠ ä¸€ä¸ªç©ºçš„å†…è”æ ·å¼ï¼Œç„¶åä¸Šä¸‹æ–‡åŒæ­¥æ³¨å…¥æ ·å¼å†…å®¹
- `script`ï¼šæ— éœ€åŠ è½½ï¼Œé€šè¿‡å®ä»»åŠ¡æ³¨å…¥å†…è” `script`

> å¦‚æœåº”ç”¨ä¸­ä¸å­˜åœ¨ `chunk`ï¼Œé‚£ä¹ˆä»…éœ€æå–é™æ€çš„å…¥å£ `script`ï¼Œä¸å­˜åœ¨åŠ¨æ€åŠ è½½

æ‰§è¡Œé¡ºåºï¼š

- åªæœ‰åŒæ­¥ä¸Šä¸‹æ–‡çš„æƒ…å†µåœ¨å½“å‰ä»»åŠ¡ä¸­æ‰§è¡Œ
- å¾®ä»»åŠ¡ä¼šåœ¨ä¸‹ä¸€ä¸ªé˜Ÿåˆ—å‘èµ·çš„å¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡å‰æ‰§è¡Œ
- å®ä»»åŠ¡ä¼šåœ¨ä¸‹ä¸€ä¸ªé˜Ÿåˆ—å‘èµ·çš„å®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œ

> å› ä¸ºæ¯æ‰§è¡Œä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒæ­¥ä»»åŠ¡ä¼šå‘èµ·å¾®ä»»åŠ¡ï¼Œ`fiber` ä¼šå‘èµ·å®ä»»åŠ¡

å¦‚æœå½“å‰ä»»åŠ¡ä¸­é€šè¿‡å¾®ä»»åŠ¡å‘èµ·å®ä»»åŠ¡æ€ä¹ˆåšï¼š

- å¾®ä»»åŠ¡ä¼šåœ¨ä¸‹ä¸€ä¸ªé˜Ÿåˆ—å‘èµ·çš„å¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡å‰æ‰§è¡Œ
- å¾®ä»»åŠ¡å‘èµ·çš„å®ä»»åŠ¡ä¼šåœ¨é˜Ÿåˆ—æ‰§è¡Œçš„ä»»åŠ¡ä¹‹åï¼Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡ä¹‹å‰å¼€å§‹æ‰§è¡Œ

#### ğŸ“ `mount` æŒ‚è½½åº”ç”¨

è§¦å‘åœºæ™¯ï¼š

- åªèƒ½åœ¨åº”ç”¨ `start` æ—¶é€šè¿‡ `execQueue` é˜Ÿåˆ—æ‰§è¡Œ `mount` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

ä¸æ‰§è¡ŒæŒ‚è½½çš„æƒ…å†µï¼š

| æ¨¡å¼    | åˆ¤æ–­æ¡ä»¶    | è¯´æ˜                                        |
| ------- | ----------- | ------------------------------------------- |
| `alive` | `execFlag`  | åªæœ‰è¿˜æœªæ¿€æ´»æ—¶æ‰ä¼šé€šè¿‡ `start` æ‰§è¡Œ `mount` |
| `umd`   | `mountFlag` | å·²æŒ‚è½½åå°†ä¸å†é‡å¤æ“ä½œ                      |

> åªæœ‰åˆæ¬¡åŠ è½½æ‰ä¼šè°ƒç”¨ `mount`ï¼Œè€Œé‡å»ºæ¨¡å¼æ¯æ¬¡éƒ½æ˜¯åˆæ¬¡åŠ è½½

æ— è®ºä»€ä¹ˆæ¨¡å¼æŒ‚è½½åº”ç”¨æ˜¯ä¸ºäº†æå–æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ— `execQueue`ï¼Œé™¤æ­¤ä¹‹å¤–ï¼š

- `alive` æ¨¡å¼ï¼šé€šè¿‡æ²™ç®± `window` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `activated`
- `umd` æ¨¡å¼ï¼šå‘èµ· `__WUJIE_MOUNT`ï¼Œè°ƒç”¨ç”Ÿå‘½å‘¨æœŸï¼Œè®¾ç½®å·²æŒ‚è½½

> `activated` ä¼šé‡å¤è°ƒç”¨ï¼Œè§ï¼šé¢„åŠ è½½ä¸­çš„ `bug` [[æŸ¥çœ‹](#6é¢„åŠ è½½ä¸­çš„-bug)]

å› æ­¤é™¤äº† `execQueue` æå–æ‰§è¡Œä¸‹ä¸ªé˜Ÿåˆ—å¤–ï¼Œ`mount` åªé€‚ç”¨äº `umd` æ¨¡å¼åˆæ¬¡åŠ è½½åº”ç”¨

- `umd` åˆ‡æ¢åº”ç”¨ä¼šåœ¨ `startApp` å‘èµ· `__WUJIE_MOUNT`ï¼Œè€Œä¸éœ€ `mount` [[æŸ¥çœ‹](#22-umd-æ¨¡å¼åˆ‡æ¢åº”ç”¨)]
- `alive` åˆ‡æ¢åº”ç”¨åªéœ€è¦åˆ‡æ¢å®¹å™¨æŒ‚è½½ç‚¹ï¼Œä¸éœ€è¦é‡æ–°æŒ‚è½½ [[æŸ¥çœ‹](#21-alive-ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨)]

#### 1. `umd` æ–¹å¼å¯åŠ¨

ä»æ²™ç®± `window` ä¸­æ£€æµ‹åˆ° `__WUJIE_MOUNT` æ‰èƒ½æ‰§è¡Œå½“å‰æµç¨‹

- åº”ç”¨ `start` æ—¶ï¼Œç”±åŒæ­¥ä»£ç æ³¨å…¥æ²™ç®±æŒ‚è½½ `__WUJIE_MOUNT` æ–¹æ³• [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

> `mount` æ–¹æ³•ä¼šåœ¨åŒæ­¥ä»£ç ä¹‹ååœ¨é˜Ÿåˆ—ä¸­è°ƒç”¨ï¼Œä½†æ˜¯æ‰§è¡Œæ–¹å¼ç•¥æœ‰å·®å¼‚ï¼Œè§ä¸‹æ–‡

æµç¨‹ï¼š

- å†æ¬¡å…³é—­æŒ‚è½½èŠ‚ç‚¹ `loading` çŠ¶æ€ï¼Œè§ï¼šå¯åŠ¨åº”ç”¨æ—¶æ·»åŠ ã€åˆ é™¤ `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]
- ä½¿ç”¨æ²™ç®± `window` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `beforeMount`
- è°ƒç”¨å­åº”ç”¨çš„ `__WUJIE_MOUNT` å»æ¸²æŸ“åº”ç”¨
- ä½¿ç”¨æ²™ç®± ` window` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `afterMount`
- è®¾ç½® `mountFlag` é¿å…é‡å¤æŒ‚è½½

> åˆ é™¤ `loading` å­˜åœ¨é‡å¤æ‰§è¡Œçš„æƒ…å†µï¼Œè§ï¼šé˜Ÿåˆ—å‰çš„å‡†å¤‡ - å…³é—­åŠ è½½çŠ¶æ€ [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]

`fiber` æ¨¡å¼ä¸‹ `__WUJIE_MOUNT` éƒ½èƒ½æ­£å¸¸æ‰§è¡Œï¼š

- å…¥å£ `script` æ³¨å…¥æ²™ç®±åï¼Œæ— è®ºåŒæ­¥è¿˜æ˜¯å¼‚æ­¥ï¼Œéƒ½ä¼šåœ¨ `mount` å‰ç»‘å®š `__WUJIE_MOUNT`
- å› ä¸º `fiber` æ¨¡å¼ä¸‹ `mount` åŒ…è£¹åœ¨å®ä»»åŠ¡ `requestIdleCallback` ä¸­

é `fiber` æ¨¡å¼ä¸‹ï¼ŒåŒæ­¥ç»‘å®š `__WUJIE_MOUNT` æ­£å¸¸æ‰§è¡Œï¼š

- åŒæ ·ä¼šä¼˜å…ˆç»‘å®š `__WUJIE_MOUNT`ï¼Œå› ä¸ºä»–ä»¬æ˜¯ä¸Šä¸‹æ–‡å…³ç³»

é `fiber` æ¨¡å¼ä¸‹ï¼Œå¼‚æ­¥ç»‘å®š `__WUJIE_MOUNT` å…¥å£æ–‡ä»¶æ˜¯å¤–è” `script` æ­£å¸¸æ‰§è¡Œï¼š

- å› ä¸ºå‘èµ·æ¸²æŸ“åï¼Œé€šè¿‡ `onload` åœ¨ä¸‹ä¸ªå®ä»»åŠ¡ä¸­æ‰§è¡Œ `mount`

å¦åˆ™å…¥å£æ–‡ä»¶æ˜¯å†…è” `script` æ ¹æ®åŒæ­¥ä»£ç ä¸­æœ€åä¸€ä¸ªé˜Ÿåˆ—å†³å®šï¼š

| æœ€å 1 ä¸ªé˜Ÿåˆ—   | æ‰§è¡Œæƒ…å†µ   | è¯´æ˜                                                         |
| --------------- | ---------- | ------------------------------------------------------------ |
| å…¥å£ `script`   | ä¸æ‰§è¡Œæ¸²æŸ“ | åŒæ­¥æå–æ‰§è¡Œ `mount` æ—¶ï¼Œå¾®ä»»åŠ¡ä¸­çš„ `__WUJIE_MOUNT` è¿˜æœªç»‘å®š |
| éå…¥å£ `script` | æ­£å¸¸æ‰§è¡Œ   | è¯´æ˜å…¥å£æ–‡ä»¶åœ¨æ­¤ä¹‹å‰å·²ç»‘å®š `__WUJIE_MOUNT` åˆ°æ²™ç®± `window`   |

> å…³äºå…¥å£ `script` æ˜¯å†…è”è¿˜æ˜¯å¤–è”ï¼Œå‚è€ƒï¼šåŠ¨æ€åŠ è½½æ ·å¼å’Œ `script` [[æŸ¥çœ‹](#7-åŠ¨æ€åŠ è½½æ ·å¼å’Œ-script)]

å› æ­¤å»ºè®®ï¼š

- ç”Ÿäº§è¿‡ç¨‹ä¸­ï¼Œè¯·è°¨æ…å…³é—­ `fiber`
- å¦‚æœæ²¡æœ‰å¿…è¦çš„æƒ…å†µï¼Œè¯·å‹¿å¼‚æ­¥æŒ‚è½½ `__WUJIE_MOUNT` å’Œ `__WUJIE_UNMOUNT`

è§£å†³åŠæ³•ï¼š

- åœ¨ `processTpl` æå–å…¥å£æ–‡ä»¶åï¼Œè¿½åŠ ä¸€ä¸ªç©ºçš„ `script` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- è¿™æ ·åœ¨å…¥å£ `script` æ³¨å…¥åï¼Œè‡³å°‘è¿˜æœ‰ 1 ä¸ªå¾®ä»»åŠ¡ï¼Œç¡®ä¿å¼‚æ­¥å‘èµ· `__WUJIE_MOUNT` å…ˆæŒ‚è½½

> ç”±äºåœ¨æºç å¤‡æ³¨ä¸­æåˆ°å¼‚æ­¥æ¸²æŸ“ï¼Œæ‰€ä»¥å¯¹äºä¸åŒçš„ç»‘å®šæ–¹å¼åšäº†ä¸åŒçš„è¯´æ˜

#### 2. `alive` æ¨¡å¼

- ä½¿ç”¨æ²™ç®± `window` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `activated`
- è¿™é‡Œå­˜åœ¨ `activated` è°ƒç”¨ 2 æ¬¡çš„æƒ…å†µï¼Œè§ï¼šé¢„åŠ è½½ä¸­çš„ `bug` [[æŸ¥çœ‹](#6é¢„åŠ è½½ä¸­çš„-bug)]

> å°±ç›®å‰æ¥çœ‹è¿™ä¸€æ­¥æ˜¯å¤šä½™çš„ï¼Œé™¤äº† `alive` é¢„æ‰§è¡Œï¼Œ`activated` éƒ½ä¼šåœ¨ `startApp` ä¸­è°ƒç”¨ [[æŸ¥çœ‹](#21-alive-ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨)]

#### 3. æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—

`this.execQueue.shift()?.()`

- è¿™æ˜¯æ‰€æœ‰æ¨¡å¼å¿…é¡»åšçš„æµç¨‹ï¼Œä¹Ÿæ˜¯é‡å»ºæ¨¡å¼åœ¨ `mount` æ—¶å”¯ä¸€åšçš„äº‹
- ç»¼ä¸Šæ‰€è¿°ï¼Œ`mount` æŒ‚è½½åº”ç”¨ä¼¼ä¹åªå…³å¿ƒ `umd` åˆæ¬¡æ¸²æŸ“åº”ç”¨

#### ğŸ“ `unmount` å¸è½½åº”ç”¨

å¸è½½æµç¨‹åˆ†ä¸º 3 éƒ¨åˆ†ï¼š

#### 1. å¸è½½åº”ç”¨ - æ‰€æœ‰æ¨¡å¼

- `activeFlag` å¤±æ´»ï¼Œè§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- æ¸…ç†è·¯ç”±ï¼Œè§ï¼š`clearInactiveAppUrl` [[æŸ¥çœ‹](#clearinactiveappurlæ¸…ç†è·¯ç”±)]

> é‡å»ºæ¨¡å¼åªåšè¿™ä¸€æ­¥

#### 2. å¸è½½ `alive` æ¨¡å¼çš„åº”ç”¨

- ä½¿ç”¨æ²™ç®± `window` è§¦å‘ç”Ÿå‘½å‘¨æœŸ `deactivated`

#### 3. å¸è½½ `umd` æ¨¡å¼çš„åº”ç”¨

å‡†å¤‡å¸è½½ `umd` æ¨¡å¼å­åº”ç”¨ï¼Œè¦æ±‚ï¼š

- `mountFlag` çŠ¶æ€å·²æŒ‚è½½ï¼Œè§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- å­åº”ç”¨æ²™ç®± `window` ä¸­å·²ç»‘å®š `__WUJIE_UNMOUNT`
- ä¸æ˜¯ `alive` æ¨¡å¼å¹¶ä¸”ä¸æ˜¯ `hrefFlag` åŠ«æŒå®¹å™¨ï¼Œè§ï¼šç‰¹æ®Šå±æ€§ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)]

`umd` æ¨¡å¼å¸è½½å’ŒæŒ‚è½½æµç¨‹ä¸€è‡´ï¼Œè§ï¼š`umd` æ–¹å¼å¯åŠ¨ [[æŸ¥çœ‹](#1-umd-æ–¹å¼å¯åŠ¨)]

- ä½¿ç”¨æ²™ç®± `window` è§¦å‘ç”Ÿå‘½å‘¨æœŸ `beforeUnmount`
- è°ƒç”¨å­åº”ç”¨æŒ‚è½½åœ¨ `window` ä¸Šçš„ `__WUJIE_UNMOUNT`
- ä½¿ç”¨æ²™ç®± `window` è§¦å‘ç”Ÿå‘½å‘¨æœŸ `afterUnmount`
- `mountFlag` æ ‡è®°ä¸ºæœªæŒ‚è½½

å’ŒæŒ‚è½½åº”ç”¨ä¸åŒçš„æ˜¯ï¼š

- `this.bus.$clear`ï¼šæ¸…ç©ºå­åº”ç”¨æ‰€æœ‰è®¢é˜…çš„é€šä¿¡ï¼Œè§ï¼š`WuJie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- éé™çº§æ¸²æŸ“éœ€è¦æ¸…ç©º `shadowRoot` ä¸‹æ‰€æœ‰å…ƒç´ ï¼Œå¹¶æ¸…ç†è®°å½•åœ¨å®ä¾‹ `head`ã€`body` çš„äº‹ä»¶
- æœ€åå°†å®ä¾‹çš„ `head`ã€`body` ä¸‹çš„å…ƒç´ å…¨éƒ¨åˆ é™¤

ä¸‹æ¬¡ `active` æ¿€æ´»åº”ç”¨æ—¶ï¼Œå°†é‡æ–°æ³¨å…¥åˆ é™¤çš„èµ„æºï¼Œé‡æ–°ç»‘å®šæ¸…ç©ºçš„äº‹ä»¶ï¼š

> å…³äºäº‹ä»¶æ¸…ç†ï¼Œè§ï¼š`shadowRoot` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#shadowrootbodyhead_cachelistenerså®¹å™¨äº‹ä»¶)]

#### 4. è§¦å‘åœºæ™¯

æµç¨‹ 1ã€2ã€3 åˆ†åˆ«å¯¹åº”ä¸Šè¿°å½’çº³ 3 ç±»æµç¨‹ï¼š

| æ¨¡å¼     | å¸è½½åœºæ™¯            | æµç¨‹ 1 | æµç¨‹ 2 | æµç¨‹ 3 |
| -------- | ------------------- | ------ | ------ | ------ |
| `alive`  | å®¹å™¨æ³¨é”€            | æ‰§è¡Œ   | æ‰§è¡Œ   | ä¸æ‰§è¡Œ |
| `umd`    | å®¹å™¨æ³¨é”€            | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | æ‰§è¡Œ   |
| é‡å»ºæ¨¡å¼ | å®¹å™¨æ³¨é”€ã€`destroy` | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ |

å®¹å™¨æ³¨é”€è§¦å‘çš„æ–¹å¼ï¼š

- `iframe` å®¹å™¨ï¼š`onunload` [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]
- `shadowRoot` å®¹å™¨ï¼š`disconnectedCallback` [[æŸ¥çœ‹](#disconnectedcallback-å¸è½½ç»„ä»¶)]

`alive` æ¨¡å¼ `unmount` æ—¶åªåšäº† 3 ä»¶äº‹ï¼š

- `activeFlag` å¤±æ´»ã€æ¸…ç†è·¯ç”±ã€è§¦å‘ç”Ÿå‘½å‘¨æœŸ `deactivated`
- ä¸æ¸…ç†å®¹å™¨ï¼Œä¹Ÿä¸æ³¨é”€åº”ç”¨ï¼Œä¸‹æ¬¡åˆ‡æ¢å›åº”ç”¨æ—¶ä¹Ÿä¸éœ€è¦é‡å¤åŠ è½½èµ„æº

`startApp` è§¦å‘åº”ç”¨ `umount` çš„åœºæ™¯ï¼š

| æ¨¡å¼               | å¸è½½åœºæ™¯              | æµç¨‹ 1 | æµç¨‹ 2 | æµç¨‹ 3 |
| ------------------ | --------------------- | ------ | ------ | ------ |
| `umd` åˆ‡æ¢åº”ç”¨     | `active` å‰ `unmount` | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | æ‰§è¡Œ   |
| `umd` é¢„æ‰§è¡Œåå¯åŠ¨ | `active` å‰ `unmount` | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | æ‰§è¡Œ   |
| `umd` é¢„åŠ è½½åå¯åŠ¨ | åº”ç”¨å®ä¾‹ `destroy`    | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ |
| é‡å»ºæ¨¡å¼å­˜åœ¨å®ä¾‹   | åº”ç”¨å®ä¾‹ `destroy`    | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ |
| é‡å»ºæ¨¡å¼åˆå§‹å®ä¾‹   | ä¸æ‰§è¡Œ `unmount`      | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ |
| `alive`            | ä¸æ‰§è¡Œ `unmount`      | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ |

å­˜åœ¨åº”ç”¨å®ä¾‹çš„æƒ…å†µä¸‹ï¼Œ`umd` æ¨¡å¼å’Œé‡å»ºæ¨¡å¼ä¼šé‡å¤ `umount`ï¼š

| æ“ä½œ | æ³¨é”€æ–¹å¼                                                                      | é‡å»ºæ¨¡å¼ | `umd` æ¨¡å¼ | `alive` æ¨¡å¼ |
| ---- | ----------------------------------------------------------------------------- | -------- | ---------- | ------------ |
| åˆ‡å‡º | å®¹å™¨é”€æ¯ï¼Œè§ï¼š`disconnectedCallback` [[æŸ¥çœ‹](#disconnectedcallback-å¸è½½ç»„ä»¶)] | âœ…       | âœ…         | â—ï¸          |
| åˆ‡å› | é€šè¿‡ `startApp` å‘èµ· `unmount` [[æŸ¥çœ‹](#22-umd-æ¨¡å¼åˆ‡æ¢åº”ç”¨)]                 | â       | âœ…         | â           |
| åˆ‡å› | æ³¨é”€å®ä¾‹ `destroy` [[æŸ¥çœ‹](#23-destroy-æ³¨é”€åº”ç”¨)]                             | âœ…       | â         | â           |

- å®¹å™¨æ³¨é”€ `alive` æ¨¡å¼ä¹Ÿä¼š `unmount`ï¼Œä½†ä¸å¸è½½èµ„æº
- å…¶ä½™æ¨¡å¼åº”ç”¨åˆ‡å‡ºã€åˆ‡å›éƒ½ä¼šæ‰§è¡Œä¸€æ¬¡ `unmount`

> å‰ææ¡ä»¶ï¼šåº”ç”¨å®ä¾‹å·²å­˜åœ¨ `idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]

å…¶å®ƒè§¦å‘åº”ç”¨ `umount` çš„åœºæ™¯ï¼š

- æ‰‹åŠ¨ `destroy` æ³¨é”€åº”ç”¨ï¼Œä½†ä¸å»ºè®® [[æŸ¥çœ‹](#å…¶å®ƒé»˜è®¤æä¾›çš„æ–¹æ³•)]
- ç›‘å¬ `popstate`ï¼Œæµè§ˆå™¨å‰è¿›åé€€è§¦å‘ `iframe` å®¹å™¨ `onunload` [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

å…³äº `onunload`ï¼š

- ä»…å­˜åœ¨é™çº§æ—¶ `iframe` å®¹å™¨ï¼Œç”¨äºä»£æ›¿ `web component` ä¸­çš„ `disconnectedCallback` [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]
- ç›‘å¬ `popstate` åé€€ï¼Œä¼šæ ¹æ® `hrefFlag` å†³å®šæ˜¯å¦é‡æ–°æ¸²æŸ“å¹¶ç›‘å¬ `onunload` [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

åŠ«æŒå®¹å™¨é€šè¿‡ `renderIframeReplaceApp`ï¼Œåœ¨æ³¨é”€æ¸²æŸ“å®¹å™¨æ—¶å‘èµ· `unmount` [[æŸ¥çœ‹](#renderiframereplaceappåŠ è½½-iframe-æ›¿æ¢å­åº”ç”¨)]ï¼š

- ä¹‹åï¼Œæµè§ˆå™¨åé€€ï¼Œè¿˜åŸæ¸²æŸ“å®¹å™¨åˆ°æŒ‚è½½ç‚¹ï¼Œæ— éœ€ `unmount`
- ä¹‹åï¼Œæµè§ˆå™¨å‰è¿›ï¼Œå†æ¬¡æ³¨é”€æ¸²æŸ“å®¹å™¨å‘èµ· `unmount`
- ä¹‹åï¼Œé€šè¿‡åŸºåº§åˆ‡å›åº”ç”¨ï¼Œå‚è€ƒä¸Šè¿°ï¼šå­˜åœ¨åº”ç”¨å®ä¾‹çš„æƒ…å†µä¸‹ï¼Œä¸åŒæ¨¡å¼çš„æ“ä½œæ–¹å¼

> åº”ç”¨é€šè¿‡ `locationHrefSet` å‘èµ·çš„åŠ«æŒï¼ŒåŠ«æŒå®¹å™¨æœ¬èº«æ˜¯ä¸éœ€è¦ `unmount` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

#### 5. å®¹å™¨åœ¨å“ªæ¸…é™¤

**æ²™ç®± `iframe`**

æ‰€æœ‰æ¨¡å¼ä¸‹éƒ½åœ¨ `destroy` æ³¨é”€å®ä¾‹æ—¶è®¾ç½®ä¸º `null`ï¼š

- é‡å»ºæ¨¡å¼ï¼Œé™¤äº†åˆæ¬¡ `startApp` ä¹‹å¤–æ¯æ¬¡ä¸€æ¬¡å¯åŠ¨å°±æ˜¯ä¸€æ¬¡ `destroy`
- é™¤äº† `alive` æ¨¡å¼ï¼Œé¢„åŠ è½½æ²¡æœ‰é¢„æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œé¦–æ¬¡ `startApp` éƒ½ä¼š `destroy`

> æ¸…é™¤åçš„æ²™ç®±åªèƒ½é€šè¿‡åˆ›å»º `WuJie` å®ä¾‹æ‰èƒ½é‡å»º [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]

**å®¹å™¨ `iframe`**

å®¹å™¨ `iframe` ä¼šå°† `document` ç»‘å®šåˆ°åº”ç”¨å®ä¾‹åŒåå±æ€§ï¼š

- ç”¨äºåˆ†è¾¨åº”ç”¨æ˜¯å¦ä¸ºåˆæ¬¡ `active`ï¼Œå’Œæ²™ç®±ä¸€æ ·åªåœ¨ `destroy` æ—¶æ¸…é™¤

ä½†æ¯æ¬¡ `active` åº”ç”¨å°±æ˜¯å¯¹å®¹å™¨ä¸€æ¬¡é‡å»ºï¼š

- `alive` æ¨¡å¼ï¼šå°† `document` çš„ `html` å…ƒç´ æ·»åŠ åˆ°æ–°å®¹å™¨
- å…¶å®ƒæ¨¡å¼ï¼šé‡æ–°æ³¨å…¥ `template` åˆ°æ–°å®¹å™¨

é‚£å®ä¾‹ä¸­çš„ `document` å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼š

- `alive` æ¨¡å¼ï¼ŒåŒºåˆ«åˆ‡æ¢å’Œé¦–æ¬¡åŠ è½½ï¼Œä¸”æ¢åº”ç”¨ä¸éœ€è¦æ³¨å…¥èµ„æº
- å…¶å®ƒæ¨¡å¼è®°å½•å®¹å™¨ `document` ä¸Šçš„äº‹ä»¶ï¼Œä¸‹æ¬¡æ¿€æ´»åº”ç”¨è¿˜åŸåˆ°æ–°å®¹å™¨ï¼Œè§ï¼šäº‹ä»¶æ¢å¤ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]

> é™çº§æ¨¡å¼ä¸‹ï¼Œåˆ‡æ¢å’Œé¦–æ¬¡åŠ è½½åº”ç”¨çš„åŒºåˆ«åœ¨äº `iframe` å®¹å™¨æ˜¯å¦æ¢å¤äº‹ä»¶

é™çº§é¢„åŠ è½½ `iframe` å®¹å™¨ä¼šæ·»åŠ åˆ°æ²™ç®± `body` ä¸­ï¼š

- æ³¨å…¥èµ„æºå‰ä¼šæ ¹æ®æä¾›çš„æŒ‚è½½ç‚¹ `el`ï¼Œå°†æ¸…ç©ºæ²™ç®± `body`
- è¿™æ ·ç¡®ä¿å¯åŠ¨çš„å­åº”ç”¨èµ„æºåªä¼šå­˜æ”¾åœ¨æ–°å»ºçš„ `iframe` æ¸²æŸ“å®¹å™¨é‡Œ

> é¢„æ‰§è¡Œï¼Œå®¹å™¨å¤„ç†æ–¹å¼ä¹Ÿå’Œé¢„åŠ è½½æ˜¯ä¸€æ ·çš„

**å®¹å™¨ `shadowRoot`**

å’Œæ²™ç®± `iframe` ä¸€æ ·ï¼Œåªè¦ä¸æ˜¯ `destroy` å°±ä¸ä¼šæ¸…é™¤ï¼š

- `alive` æ¨¡å¼ï¼Œä¸ä¼šè‡ªåŠ¨æ¸…é™¤å®¹å™¨ï¼Œé‡æ–°æ¿€æ´»åº”ç”¨æ—¶ä¹Ÿä¸éœ€è¦å†æ¬¡æ³¨å…¥èµ„æº
- `umd` æ¨¡å¼ï¼Œ`unmount` æ—¶ä¼šæ¸…ç©ºå®¹å™¨ï¼Œä¸‹æ¬¡æ¿€æ´»æ—¶é‡æ–°æ³¨å…¥èµ„æº [[æŸ¥çœ‹](#3-å¸è½½-umd-æ¨¡å¼çš„åº”ç”¨)]
- é‡å»ºæ¨¡å¼ï¼Œæ¯æ¬¡åˆ‡æ¢åº”ç”¨ `active` å‰éƒ½ä¼š `destroy` åé‡å»ºå®ä¾‹

> `shadowRoot` çš„å­˜åœ¨å’Œ `iframe` å®¹å™¨ä¸­çš„ `document` ä¸€æ ·ï¼Œç”¨äºåŒºåˆ†æ˜¯å¦ä¸ºåˆæ¬¡åŠ è½½

åˆæ¬¡åŠ è½½ï¼Œé€šè¿‡ `shadowRoot.host` æŒ‚è½½å®¹å™¨åˆ°æŒ‡å®šèŠ‚ç‚¹ï¼š

| æ‰§è¡Œæ–¹å¼        | æŒ‚è½½èŠ‚ç‚¹      |
| --------------- | ------------- |
| é¢„æ‰§è¡Œ & é¢„åŠ è½½ | æ²™ç®± `body`   |
| åˆæ¬¡ `startApp` | é…ç½®èŠ‚ç‚¹ `el` |

> æŒ‚è½½ä¹‹åä¼šé€šè¿‡ `renderTemplateToShadowRoot` æ³¨å…¥èµ„æºåˆ°å®¹å™¨ [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]

é¢„åŠ è½½å `startApp`ï¼Œå®¹å™¨æ€ä¹ˆå¤„ç†ï¼š

| æ¨¡å¼     | æŒ‚è½½èŠ‚ç‚¹                                                 | å®¹å™¨èµ„æº                 |
| -------- | -------------------------------------------------------- | ------------------------ |
| `alive`  | å°† `shadowRoot.host` ä»æ²™ç®± `body` ç§»åŠ¨åˆ° `el` é…ç½®èŠ‚ç‚¹  | ä¸é”€æ¯ä¸æ¸…ç©ºä¹Ÿä¸é‡æ–°æ³¨å…¥ |
| å…¶å®ƒæ¨¡å¼ | `destroy` æ³¨é”€åº”ç”¨åé‡å»ºå®ä¾‹ï¼Œå°†å®¹å™¨æŒ‚è½½åˆ° `el` é…ç½®èŠ‚ç‚¹ | é‡æ–°æ³¨å…¥èµ„æº             |

é¢„æ‰§è¡Œå `startApp`ï¼Œå®¹å™¨æ€ä¹ˆå¤„ç†ï¼š

- `umd` æ¨¡å¼ï¼š`active` ä¹‹å‰ä¼šå…ˆé€šè¿‡ `unmount` æ¸…ç©º `shadowRoot`ï¼Œç„¶åé‡æ–°æ³¨å…¥èµ„æº
- å…¶å®ƒæ¨¡å¼ï¼šå’Œé¢„åŠ è½½ä¸€æ ·

**åŠ«æŒå®¹å™¨ `iframe`**

ç”± `locationHrefSet` åŠ«æŒå­åº”ç”¨ `location.href` åˆ›å»ºçš„å®¹å™¨ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

åŠ«æŒå®¹å™¨æœ¬èº«ä¸ä¼šä¸»åŠ¨æ¸…é™¤ï¼Œåªèƒ½é€šè¿‡é‡æ–°æ¸²æŸ“ï¼Œä»è€Œåœ¨ `Dom tree` ä¸­ç§»é™¤ï¼š

- ç”±åŸºåº§è·¯ç”±å˜æ›´å¯¼è‡´åŸºåº§é‡æ–°æ¸²æŸ“
- æˆ–ç”±æµè§ˆå™¨å‰è¿›åé€€å¯¼è‡´é‡æ–°æ¸²æŸ“

> `degrade` æ¨¡å¼ä¸‹å› ä¸ºå­˜åœ¨ `bug` ä¸ä¼šåŠ«æŒï¼Œå› æ­¤ä¸å­˜åœ¨åŠ«æŒå®¹å™¨

åŠ«æŒå®¹å™¨çš„æ¢å¤æœ‰ 2 ä¸ªåŠæ³•ï¼š

- å› ä¸ºåŸºåº§è·¯ç”±å˜æ›´ï¼Œå¯ä»¥é€šè¿‡ `popstate` å‰è¿›æ¢å¤åŠ«æŒå®¹å™¨ [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]
- é€šè¿‡åŠ«æŒå­åº”ç”¨ `location.href` é‡å»ºåŠ«æŒå®¹å™¨

**æç«¯æƒ…å†µï¼š**

- `degrade` é¢„åŠ è½½ï¼Œæ­£å¸¸å¯åŠ¨ï¼›æˆ–è€…æ­£å¸¸é¢„åŠ è½½ï¼Œ`degrade` å¯åŠ¨

`degrade` ç”±å®ä¾‹æ„é€ æ—¶å†³å®šï¼š

- `alive` é¢„åŠ è½½æ—¶å†³å®š `degrade`
- `umd` é¢„æ‰§è¡Œå°†ä¿ç•™é¢„åŠ è½½æ—¶çš„å®ä¾‹ï¼ŒåŒ…æ‹¬ `degrade`
- `umd` é¢„åŠ è½½ä¸é¢„æ‰§è¡Œï¼Œ`startApp` åé”€æ¯å®ä¾‹ï¼Œç„¶åä½¿ç”¨æ–°çš„é…ç½®é‡å»º
- é‡å»ºæ¨¡å¼æ¯æ¬¡éƒ½ä¼š `destroy` å®ä¾‹ï¼Œç„¶åä½¿ç”¨æ–°çš„é…ç½®é‡å»º

æŒ‰ç…§ä¸Šé¢çš„è§„åˆ™å†³å®šå®ä¾‹æœ€ç»ˆä¼šé‡‡ç”¨ä»€ä¹ˆå®¹å™¨ï¼Œä»è€Œä¿è¯èƒ½å¤Ÿæ­£å¸¸åŠ è½½æ¸²æŸ“å®¹å™¨ã€‚è¿™äº›å®¹å™¨è¯¥æ€ä¹ˆæ³¨é”€ã€æ€ä¹ˆæ¸…ç©ºè¯·å‚è€ƒä¸Šè¿°æ€»ç»“ã€‚

#### ğŸ“ `patchCssRules` å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸

#### 1. åŸç†é˜è¿°

åœ¨å­åº”ç”¨æ¸²æŸ“å®Œæ¯•ä¹‹åï¼Œæå–å­åº”ç”¨æ‰€æœ‰çš„æ ·å¼ï¼Œç­›é€‰æŒ‚è½½åˆ°å¤–éƒ¨ï¼š

1. å…¼å®¹ `:root` é€‰æ‹©å™¨æ ·å¼åˆ° `:host` é€‰æ‹©å™¨ä¸Šï¼Œå³è·å–æ ·å¼æ”¹ååæ–°å¢åˆ°å®¹å™¨ `head` ä¸‹
2. å°† `@font-face` å®šä¹‰åˆ° `shadowRoot` å¤–éƒ¨ï¼Œå³æ’å…¥åº”ç”¨ `shadowRoot.host` æœ«å°¾

ä¸ºä»€ä¹ˆæ‰“è¡¥ä¸ï¼Ÿ

- `shadowRoot` ä½œä¸ºè·Ÿå…ƒç´ åŒ¹é…çš„æ˜¯ä¼ªç±»æ˜¯ `:host`ï¼Œè§ï¼šMDN [[æŸ¥çœ‹](https://developer.mozilla.org/en-US/docs/Web/CSS/:host)]
- åœ¨ `shadowDom` ä¸­ä¸èƒ½è§£æ `@font-face`ï¼Œéœ€è¦å°†å…¶è½¬ç§»åˆ° `document` ä¸‹

> å…³äº `@font-face` ä¸¤ç¯‡å¤–ç½‘èµ„æ–™: robdodson [[æŸ¥çœ‹](https://robdodson.me/posts/at-font-face-doesnt-work-in-shadow-dom/)]ã€chromium [[æŸ¥çœ‹](https://issues.chromium.org/issues/41085401)]

æ”¾å…¥ä½ç½®æœ‰ä»€ä¹ˆè®²ç©¶ï¼š

- `:host` æ”¹åå³å¯ï¼Œæ”¾å…¥å®¹å™¨çš„ `head` ä¼šè‡ªåŠ¨ç”Ÿæ•ˆ
- `@font-face` æ”¾å…¥ `doocument` ä¸‹å³å¯ï¼Œä½†ä¸ºäº†ä¾¿äºç®¡ç†æ”¾åœ¨ `shadowRoot.host` é‡Œé¢

> è¡¥ä¸æ ·å¼æ¸…ç©ºçš„æ–¹å¼ï¼Œè§ï¼šå•ç‹¬æ€»ç»“ [[æŸ¥çœ‹](https://github.com/cgfeel/zf-micro-app/blob/main/doc/wujie-umd-patch_css_rules.md#3-%E6%80%BB%E7%BB%93)]

è°ƒç”¨åœºæ™¯ï¼š

- `active` æ¿€æ´»åº”ç”¨ï¼šå°†èµ„æºæ³¨å…¥ `shadowRoot` ä¹‹å [[æŸ¥çœ‹](#5-å®Œæˆæ¿€æ´»åº”ç”¨)]
- `rebuildStyleSheets`ï¼š`umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨ï¼Œé‡å»ºæ ·å¼ä¹‹å [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]

ä¸ä¼šæ‰§è¡Œæ“ä½œçš„æƒ…å†µï¼š

- `degrade` é™çº§ï¼šæ²¡æœ‰ `shadowRoot`ï¼Œ`iframe` å®¹å™¨ä¹Ÿä¸å­˜åœ¨å…¼å®¹æ ·å¼çš„é—®é¢˜
- é…ç½® `cssIgnores` ä½œä¸ºå¤–è”åŠ è½½çš„æ ·å¼ï¼šåªæå–å†…è”æ ·å¼æ‰“è¡¥ä¸
- å…¥å£èµ„æºä¸­åŒ…å« `ignore` å±æ€§çš„é™æ€æ ·å¼ï¼šå°†è¢«æ³¨é‡Šä»£æ›¿
- `WUJIE_DATA_ATTACH_CSS_FLAG` å·²å¤„ç†è¿‡ä¸å¤„ç†

ä¸ºä»€ä¹ˆå¤„ç†è¿‡ä¸å†å¤„ç†ï¼š

- æå– `:host` æ ·å¼ä¹‹åï¼Œä¼šå°†å…¶å­˜å…¥é›†åˆ `styleSheetElements` [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]
- `umd` æ¨¡å¼ï¼Œä¸‹æ¬¡åˆ‡æ¢åº”ç”¨ä¼šé€šè¿‡ `rebuildStyleSheets` æ¢å¤æ ·å¼ [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]
- `alive` æ¨¡å¼ï¼Œèµ„æºæ²¡æœ‰å˜åŒ–ä¸éœ€è¦ä»»ä½•å¤„ç†
- é‡å»ºæ¨¡å¼ï¼Œæ¯ä¸€æ¬¡å¯åŠ¨éƒ½æ˜¯ä¸€æ¬¡æ–°çš„å®ä¾‹ï¼Œæ‰€æœ‰æµç¨‹é‡æ–°æ¥ä¸€é

æ³¨æ„ï¼š

- `patchCssRules` åªèƒ½æ ¹æ®å®¹å™¨ `shadowRoot` æå–æ‰€æœ‰æ ·å¼å…ƒç´ æ‰“è¡¥ä¸
- è€Œå¯¹äºå®¹å™¨ä¸­åŠ¨æ€æ·»åŠ çš„æ ·å¼ï¼Œéœ€è¦é€šè¿‡ `handleStylesheetElementPatch` æ¥å¤„ç† [[æŸ¥çœ‹](#handlestylesheetelementpatchä¸ºåº”ç”¨ä¸­åŠ¨æ€æ ·å¼æ‰“è¡¥ä¸)]

> å‡†ç¡®æ¥è¯´ `patchCssRules` æ˜¯é€šè¿‡æ²™ç®±çš„ `iframe.contentDocument` æ¥è·å–æ‰€æœ‰çš„ `style` å…ƒç´ ï¼Œç”±äºå®¹å™¨æ‰€æœ‰å…ƒç´ çš„ `ownerDocument` éƒ½æŒ‡å‘ `iframe.contentWindow.document`ï¼Œå› æ­¤å¯ä»¥ä»æ²™ç®± `document` å¯ä»¥è·å–æ‰€æœ‰ `style` å…ƒç´ 

æµç¨‹å’Œ `handleStylesheetElementPatch` ä¸­å®ä»»åŠ¡çš„å›è°ƒå‡½æ•°æ˜¯ä¸€æ ·çš„ [[æŸ¥çœ‹](#handlestylesheetelementpatchä¸ºåº”ç”¨ä¸­åŠ¨æ€æ ·å¼æ‰“è¡¥ä¸)]ï¼š

- é€šè¿‡ `getPatchStyleElements` ä»æä¾›çš„ `stylesheet` ä¸­æå–æŒ‡å®šçš„æ ·å¼
- è‹¥å­˜åœ¨ `hostStyleSheetElement`ï¼š`:host` æ ·å¼å…ƒç´ ï¼Œå°†å…¶æ’å…¥ `shadowRoot.head`
- è‹¥å­˜åœ¨ `fontStyleSheetElement`ï¼šå­—ä½“æ ·å¼å…ƒç´ ï¼Œå°†å…¶æ’å…¥ `shadowRoot.host` æœ«å°¾
- å¦‚æœé€šè¿‡ä¸Šè¿°ä»»æ„æ ·å¼æ‰“è¿‡è¡¥ä¸ï¼Œæ ‡è®° `WUJIE_DATA_ATTACH_CSS_FLAG` é¿å…ä¸‹æ¬¡é‡å¤æ‰§è¡Œ

#### 2. é‡å¤æå–æ ·å¼çš„ `bug`

ç¯‡å¹…å¤ªé•¿å•ç‹¬æ•´ç†äº†ä¸€ç¯‡ï¼Œè§ï¼š`wujie` ä¸­ `patchCssRules` å­˜åœ¨é‡å¤åŠ è½½çš„ `Bug` [[æŸ¥çœ‹](https://github.com/cgfeel/zf-micro-app/blob/main/doc/wujie-umd-patch_css_rules.md)]

åœ¨è¿™é‡Œä¸å¾—ä¸åæ§½ä¸€ä¸‹ï¼Œ`wujie` å¤„ç†æ ·å¼çœŸçš„å¾ˆé›¶ä¹±ï¼š

| æ–¹æ³•                                                                                                  | æ ·å¼ç±»å‹ | ç”¨é€”                                             |
| ----------------------------------------------------------------------------------------------------- | -------- | ------------------------------------------------ |
| 1. `processTpl` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]                                                        | é™æ€æ ·å¼ | å°†èµ„æºä¸­çš„é™æ€æ ·å¼æ›¿æ¢æˆæ³¨é‡Š                     |
| 2. `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]                                      | é™æ€æ ·å¼ | åŠ è½½ä»èµ„æºä¸­æå–çš„é™æ€æ ·å¼å¹¶æ›¿æ¢èµ„æºä¸­å¯¹åº”çš„æ³¨é‡Š |
| 3. `processCssLoaderForTemplate` [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)]                   | é™æ€æ ·å¼ | æ‰‹åŠ¨æ·»åŠ æ ·å¼åˆ°åº”ç”¨å¤´éƒ¨å’Œå°¾éƒ¨                     |
| 4. `patchCssRules` [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]                                         | æ‰€æœ‰ç±»å‹ | ä¸ºå®¹å™¨ä¸­å·²å­˜åœ¨çš„æ ·å¼æ‰“è¡¥ä¸                       |
| 5. `rewriteAppendOrInsertChild` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)] | åŠ¨æ€æ ·å¼ | æ‹¦æˆªåº”ç”¨åŠ¨æ€æ·»åŠ æ ·å¼                             |
| 6. `patchStylesheetElement` [[æŸ¥çœ‹](#patchstylesheetelementåŠ«æŒå¤„ç†æ ·å¼å…ƒç´ çš„å±æ€§)]                   | åŠ¨æ€æ ·å¼ | åŠ«æŒå¤„ç†æ ·å¼å…ƒç´ çš„æ“ä½œ                           |
| 7. `handleStylesheetElementPatch` [[æŸ¥çœ‹](#handlestylesheetelementpatchä¸ºåº”ç”¨ä¸­åŠ¨æ€æ ·å¼æ‰“è¡¥ä¸)]       | åŠ¨æ€æ ·å¼ | ä¸ºåŠ¨æ€æ ·å¼æ‰“è¡¥ä¸                                 |

- å¯¹äºæ–¹æ³•ï¼š2ã€3ï¼Œå¯¹æ¯”åŠ è½½ `script`ï¼Œæ–¹æ³•å…¨éƒ¨å½’çº³åœ¨ `start` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
- å¯¹äºæ‰“è¡¥ä¸çš„æ–¹æ³•ï¼š4ã€7ï¼Œæ‰§è¡Œçš„è¿‡ç¨‹æ˜¯ä¸€æ ·çš„

é™¤æ­¤ä¹‹å¤–ä»¥ä¸‹æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¹Ÿé«˜åº¦ç›¸ä¼¼ï¼š

| æ–¹æ³•æˆ–æµç¨‹                                                                               | å‚è€ƒå¯¹è±¡                                                                                                                                             | ç›¸åŒç‚¹                                                                          |
| ---------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------- |
| `startApp` çš„å®ä¾‹åˆå§‹åŒ–                                                                  | é¢„åŠ è½½ä¸­ `runPreload`                                                                                                                                | æå–èµ„æºï¼Œå®ä¾‹åˆå§‹åŒ–ã€`active`ã€`start`ï¼Œè§ï¼šå¯¹æ¯” [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)] |
| `umd` åˆ‡æ¢åº”ç”¨ [[æŸ¥çœ‹](#22-umd-æ¨¡å¼åˆ‡æ¢åº”ç”¨)]                                            | åº”ç”¨ `mount` [[æŸ¥çœ‹](#1-umd-æ–¹å¼å¯åŠ¨)]                                                                                                               | æ‰§è¡Œç”Ÿå‘½å‘¨æœŸæ–¹æ³•ã€æŒ‚è½½åº”ç”¨                                                      |
| `getCssLoader`                                                                           | `getJsLoader`                                                                                                                                        | å”¯ä¸€çš„åŒºåˆ«æ˜¯æå–æ’ä»¶çš„å±æ€§åï¼Œè§ï¼šé€šè¿‡é…ç½®æ›¿æ¢èµ„æº [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]  |
| `createIframeContainer`                                                                  | `renderIframeReplaceApp`                                                                                                                             | è§ï¼šåˆ›å»º `iframe` å®¹å™¨ [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]                              |
| `renderTemplateToShadowRoot` [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)] | `renderTemplateToIframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe-å®¹å™¨)]                                                                    | åˆ›å»º `html` å…ƒç´ ã€æ‰‹åŠ¨æ’å…¥æ ·å¼ã€ä¿®æ­£å®¹å™¨ `parentNode`ï¼Œé‡å†™å®¹å™¨æ–¹æ³•             |
| `patchElementEffect` - `baseURI` [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]               | `getCurUrl`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L201)] | éƒ½æ˜¯é€šè¿‡ `proxyLocation` è·å– `protocol` + `host` + `pathname`                  |

#### ğŸ“ `rebuildStyleSheets` é‡æ–°æ¢å¤æ ·å¼

ä»…é™äº `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨ï¼Œæˆ–é¢„æ‰§è¡Œåå¯åŠ¨åº”ç”¨ï¼š

- ç”±äº `umd` æ¨¡å¼åˆæ¬¡ `start` ä¹‹åï¼Œå†æ¬¡å¯åŠ¨ä¸ä¼šé‡æ–°æ³¨å…¥æ‰§è¡Œ `script`
- å› æ­¤åº”ç”¨ä¸­çš„åŠ¨æ€æ ·å¼ä¹Ÿä¸ä¼šé‡æ–°æ³¨å…¥ï¼Œéœ€è¦åœ¨ `__WUJIE_MOUNT` å‰é€šè¿‡ `styleSheetElements` æ¢å¤æ ·å¼

> `styleSheetElements` çš„æ ·å¼æ”¶é›†æ¥è‡ª 3 å¤„ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]

æ¢å¤æ–¹å¼ï¼š

- éå† `styleSheetElements` é›†åˆä¸­çš„æ ·å¼å…ƒç´ ï¼Œæ³¨å…¥åˆ°å®¹å™¨çš„ `head` å…ƒç´ ä¸‹
- é€šè¿‡ `patchCssRules` ä¸ºæ¢å¤çš„æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]

> ä¸ºæ ·å¼æ‰“è¡¥ä¸å­˜åœ¨é‡å¤åŠ è½½çš„ `Bug`ï¼Œè§ï¼šå•ç‹¬æ€»ç»“ [[æŸ¥çœ‹](https://github.com/cgfeel/zf-micro-app/blob/main/doc/wujie-umd-patch_css_rules.md)]

#### ğŸ“ `destroy` é”€æ¯å®ä¾‹

#### 1. å¸è½½åº”ç”¨

- é€šè¿‡ `unmount` å¸è½½åº”ç”¨ [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]
- é€šè¿‡ `bus` å¯¹è±¡æ¸…ç†ç›‘å¬çš„é€šä¿¡ï¼Œè§ï¼šå®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- å°†å®ä¾‹ä¸­ç›¸å…³çš„å±æ€§è®¾ç½®ä¸º `null`ï¼Œè§ï¼šå®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

#### 2. æ¸…ç©ºå®¹å™¨ï¼Œé”€æ¯å®ä¾‹

- å¦‚æœå®¹å™¨æŒ‚è½½ç‚¹ `el` å­˜åœ¨çš„è¯ï¼Œé€šè¿‡ `clearChild` è®²å…¶å­é›†å…¨éƒ¨æ¸…ç©º
- ä»æ²™ç®± `window` ä¸­æ‰¾åˆ° `__WUJIE_EVENTLISTENER__`ï¼Œæ¸…é™¤è®°å½•çš„äº‹ä»¶
- æ‰¾åˆ°æ²™ç®±æŒ‚è½½ç‚¹ï¼Œåˆ é™¤æ²™ç®± `iframe` å…ƒç´ 
- é€šè¿‡ `deleteWujieById` ä»æ˜ å°„è¡¨ä¸­åˆ é™¤å®ä¾‹ï¼Œè§ï¼š`idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]

`__WUJIE_EVENTLISTENER__` æ¸…é™¤äº‹ä»¶ï¼š

- ç”±äºåœ¨ `patchIframeEvents` ä¸­é‡å†™äº†æ²™ç®± `window` çš„ `removeEventListener` [[æŸ¥çœ‹](#patchiframeevents-åŠ«æŒæ²™ç®±-iframe-çš„-eventlistener)]
- å½“å‘æ²™ç®±å‘èµ·åˆ é™¤äº‹ä»¶æ—¶ï¼Œä¼šå…ˆæ¸…ç©ºè®°å½•ç„¶åæ‰§è¡Œ `removeEventListener` åˆ é™¤äº‹ä»¶

> åŸå› è§ï¼šè½¬å‘ `window` äº‹ä»¶ [[æŸ¥çœ‹](#__wujie_eventlistener__è½¬å‘-window-äº‹ä»¶)]

#### ğŸ“ `Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§

#### 1. å¸¸è§„å±æ€§

è¿™é‡Œåªåˆ—ä¸¾éƒ¨åˆ†å…³é”®çš„å±æ€§ï¼š

| å±æ€§                   | å®šä¹‰                                                                                                                                                                | `constructor` åˆå§‹åŒ–                                                                             | `destroy` æ³¨é”€                                       |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ | ---------------------------------------------------- |
| `activeFlag`           | å®ä¾‹å·²æ¿€æ´»                                                                                                                                                          | `undefined`ï¼Œé€šè¿‡ `active` æ¿€æ´» [[æŸ¥çœ‹](#1-æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯)]                                    | é€šè¿‡ `unmount` å¤±æ´» [[æŸ¥çœ‹](#1-å¸è½½åº”ç”¨---æ‰€æœ‰æ¨¡å¼)] |
| `bus`                  | é€šä¿¡å¯¹è±¡ï¼Œä½¿ç”¨ `appEventObjMap` è·å–äº‹ä»¶æ˜ å°„è¡¨ï¼Œé€šè¿‡ `inject` å®ç°çˆ¶å­åº”ç”¨æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ [[æŸ¥çœ‹](#1-inject-æ³¨å…¥å­åº”ç”¨-3-ä¸ªå¯¹è±¡)]                                    | `EventBus` [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]                                   | `null`                                               |
| `degrade`              | ä¸»åŠ¨é™çº§ï¼Œç”¨ `iframe` ä½œä¸ºåº”ç”¨å®¹å™¨                                                                                                                                  | é€šè¿‡é…ç½®æ–‡ä»¶åœ¨æ„é€ å‡½æ•°ä¸­å£°æ˜                                                                     | ä¸å¤„ç†                                               |
| `elementEventCacheMap` | å½“é™çº§æ—¶ç”¨äºä¿å­˜åº”ç”¨ä¸­æ‰€æœ‰å…ƒç´ äº‹ä»¶ [[æŸ¥çœ‹](#elementeventcachemapé™çº§å®¹å™¨äº‹ä»¶)]                                                                                      | `WeakMap`ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­é€šè¿‡ `iframeGenerator` å‘èµ·è®°å½• [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)] | `null`                                               |
| `execFlag`             | åº”ç”¨å¯åŠ¨çŠ¶æ€                                                                                                                                                        | `undefined`ï¼Œé€šè¿‡ `start` æ¿€æ´» [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]                                         | `null`                                               |
| `execQueue`            | `start` åº”ç”¨ä¸­çš„ä»»åŠ¡é˜Ÿåˆ— [[æŸ¥çœ‹](#1-execqueue-åº”ç”¨å¯åŠ¨æ‰§è¡Œé˜Ÿåˆ—)]                                                                                                    | `[]`                                                                                             | `null`                                               |
| `id`                   | åº”ç”¨ååˆ—                                                                                                                                                            | `name`ï¼Œå­—ç¬¦ç±»å‹                                                                                 | ä¸å¤„ç†                                               |
| `mountFlag`            | `umd` æ¨¡å¼æŒ‚è½½åº”ç”¨                                                                                                                                                  | `undefined`ï¼Œåº”ç”¨ `mount` åä¸º `true`ï¼Œ`unmount` åä¸º `false`                                    | `null`                                               |
| `provide`              | ä¸ºå­åº”ç”¨æä¾›é€šä¿¡ `bus`ã€ä»£ç†çš„ `location`ï¼Œå¯é€‰å¯¹è±¡ï¼šä¼ é€’æ•°æ® `props`ã€`shadowRoot` å®¹å™¨ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/wujie.html#wujie)] | åœ¨æ„é€ å‡½æ•°é‡Œæä¾› `bus`ã€`location`ï¼Œåœ¨ `active` ä¸­æä¾› `props` å’Œ `shadowRoot`                   | `null`                                               |
| `styleSheetElements`   | æ”¶é›†åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„æ ·å¼ï¼Œ`:host` å’Œå­—ä½“è¡¥ä¸æ ·å¼ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]                                                                         | `[]`                                                                                             | `null`                                               |
| `sync`                 | å•å‘åŒæ­¥è·¯ç”±ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#sync)]                                                                           | `udefined`ï¼Œåªåœ¨ `active` æ—¶é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½® [[æŸ¥çœ‹](#3-åŒæ­¥è·¯ç”±)]                               | ä¸å¤„ç†                                               |
| `template`             | `string` ç±»å‹ï¼Œè®°å½•é€šè¿‡ `processCssLoader` å¤„ç†åçš„èµ„æºï¼Œåœ¨ `alive` æˆ– `umd` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨æ—¶å¯ä¿è¯èµ„æºä¸€è‡´æ€§ [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]            | `undefined`ï¼Œåªåœ¨ `active` æ—¶å€™è®°å½•                                                              | ä¸å¤„ç†                                               |

> åƒ `degrade` å’Œ `plugin` è¿™æ ·åœ¨å®ä¾‹åŒ–å°±å®šä¹‰å¥½å€¼ï¼Œé™¤äº†é”€æ¯åè®¾ç½® `null`ï¼Œä¸èƒ½ä¸­é€”æ›´æ–°å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´å¯¹äºåƒ `alive` æ¨¡å¼çš„åº”ç”¨ï¼Œé¢„åŠ è½½é…ç½®çš„ä¿¡æ¯ï¼Œä¸ä¼šå› ä¸º `startApp` é…ç½®ä¸åŒï¼Œè€ŒåŠ è½½åº”ç”¨å‘ç”Ÿæ”¹å˜

#### 2. ç‰¹æ®Šå±æ€§

**`hrefFlag`ï¼šé€šè¿‡ `iframe` åŠ è½½å­åº”ç”¨ `url`**

è¿™é‡Œçš„ `iframe` æ—¢ä¸æ˜¯æ²™ç®± `iframe`ï¼Œä¹Ÿä¸æ˜¯å®¹å™¨ `iframe`ï¼Œè€Œæ˜¯ï¼š

- ä¸“é—¨ç”¨æ¥åŠ è½½é€šè¿‡ `location.href` è·³è½¬é“¾æ¥æ—¶ï¼Œä¸´æ—¶å»ºç«‹ä¸€ä¸ª `iframe` æ¥æ›¿æ¢å®¹å™¨
- æ¯”å¦‚å­åº”ç”¨é€šè¿‡ `location.href` è½¬å‘ç¬¬ä¸‰æ–¹é¡µé¢ï¼Œè¿™æ—¶å°±æ–°å»º `iframe` å……å½“ä¸´æ—¶å®¹å™¨

> å­˜å‚¨çš„å€¼ç±»å‹ä¸º `boolean`ï¼Œä»…ç”¨äºè¡¨æ˜å½“å‰æ˜¯å¦ä¸ºåŠ«æŒå®¹å™¨

å±æ€§å€¼çš„æ›´æ–°ï¼š

- `constructor` æ„å»ºï¼Œé»˜è®¤å€¼ï¼š`undefined` [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]
- `destroy` é”€æ¯ï¼š`null` [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]
- `active` æ¿€æ´»åº”ç”¨ï¼š`false` [[æŸ¥çœ‹](#1-æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯)]
- `locationHrefSet` æ‹¦æˆªå­åº”ç”¨ï¼šè®¾ç½® `true` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]
- `popstate` å‰è¿›æ—¶ï¼Œé¡µé¢æ¥è‡ª `locationHrefSet` æ‹¦æˆªï¼š`true` [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]
- `popstate` åé€€æ—¶ï¼Œä» `locationHrefSet` æ‹¦æˆªçš„é¡µé¢ç¦»å¼€ï¼š`false` [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

å› æ­¤å¾—å‡ºï¼š

- `hrefFlag` æ ‡è®°æ—¶ï¼Œè¡¨ç¤ºå½“å‰åº”ç”¨çš„é“¾æ¥å¹¶éæ¥è‡ªåŸºåº§
- åªæœ‰å­åº”ç”¨å†…é€šè¿‡ `location.href` ä¿®æ”¹å½“å‰é¡µé¢é“¾æ¥æ‰ä¼šæ‹¦æˆªè§¦å‘

> ç”±äº `locationHrefSet` å­˜åœ¨ `bug`ï¼Œå› æ­¤ä»…é™æ¥è‡ªéé™çº§æ¨¡å¼ä¸‹çš„å­åº”ç”¨ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

ç”¨é€”ï¼š

- `unmount` æ³¨é”€åº”ç”¨ï¼š`umd` æ¨¡å¼å†³å®šæ˜¯å¦è¦å¸è½½åº”ç”¨ [[æŸ¥çœ‹](#3-å¸è½½-umd-æ¨¡å¼çš„åº”ç”¨)]
- `clearInactiveAppUrl` æ˜¯å¦æ¸…ç†è·¯ç”±ï¼šä¹Ÿæ˜¯ `unmount` æ—¶è§¦å‘ [[æŸ¥çœ‹](#clearinactiveappurlæ¸…ç†è·¯ç”±)]
- `popstate` åé€€æ—¶ï¼šåˆ¤æ–­æ˜¯å¦æ˜¯ä» `locationHrefSet` æ‹¦æˆªçš„é¡µé¢ç¦»å¼€ [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

**`el`ï¼šæŒ‚è½½å®¹å™¨**

é€šå¸¸æ¥è‡ªé…ç½®æ–‡ä»¶è®¾å®šæŒ‚è½½èŠ‚ç‚¹ï¼Œä½†æ˜¯ä¸‹é¢æƒ…å†µé™¤å¤–ï¼š

- `preloadApp` é¢„åŠ è½½ï¼šæŒ‚è½½åˆ°æ²™ç®± `iframe` çš„ `body`
- `startApp` åŠ è½½åº”ç”¨ä¸æä¾› `el`ï¼šæŒ‚è½½åˆ°æ²™ç®± `iframe` çš„ `body`
- `startApp` åˆ‡æ¢åº”ç”¨ä¸æä¾› `el`ï¼šç›´æ¥æŠ¥é”™

å±æ€§å€¼çš„æ›´æ–°ï¼š

- `constructor` æ„å»ºï¼Œé»˜è®¤å€¼ï¼š`undefined` [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]
- `destroy` é”€æ¯ï¼š`null` [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]
- `active` æ¿€æ´»åº”ç”¨ï¼šé…ç½®æŒ‡å®šçš„ `el` èŠ‚ç‚¹ï¼Œå¦åˆ™ä¸ºæ²™ç®± `iframe` çš„ `body` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]

ç”¨é€”ï¼š

- `startApp`ï¼šæŒ‚è½½å®¹å™¨ [[æŸ¥çœ‹](#startapp-å¯åŠ¨æµç¨‹)]
- `preloadApp`ï¼šé¢„åŠ è½½æ—¶å€™å°†å­åº”ç”¨ä¸´æ—¶æŒ‚è½½ [[æŸ¥çœ‹](#preloadapp-é¢„åŠ è½½æµç¨‹)]
- `locationHrefSet`ï¼šæ‹¦æˆªè·³è½¬æŒ‚è½½ä¸´æ—¶ `iframe` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

**`url`ï¼šåº”ç”¨å…¥å£é“¾æ¥**

æ— è®ºæ˜¯é¢„åŠ è½½è¿˜æ˜¯å¯åŠ¨åº”ç”¨éƒ½å¿…é¡»æä¾›çš„é…ç½®ï¼Œç„¶è€Œè¯´ `url` ç‰¹æ®Šæ˜¯å› ä¸ºï¼Œè¿™ä¸ªå±æ€§åœ¨æ„é€ å’Œ `active` æ—¶å…è®¸åˆ†åˆ«èµ‹å€¼ï¼Œé‚£ä¹ˆè¿™å°±å¯èƒ½é€ æˆå¦‚ä¸‹é—®é¢˜ã€‚

é—®é¢˜ 1ï¼šæ„é€ å‡½æ•°å’Œ `active` æä¾›çš„ `url`ä¸ä¸€æ ·

- â ç›®å‰ä¸å¯èƒ½ï¼Œæºç ä¸­åªè¦å£°æ˜å®ä¾‹ï¼Œé‚£ä¹ˆéšåä¸€å®šä¼šä½¿ç”¨ç›¸åŒçš„ `url` åŠ è½½èµ„æºï¼Œ`active` æ¿€æ´»åº”ç”¨

é—®é¢˜ 2ï¼š`preloadApp` å’Œ `startApp` æ—¶ `url` ä¸ä¸€æ ·å‘¢

- âœ… æœ‰å¯èƒ½

ä¸è¿‡ç›®å‰æ¥è¯´è¿™ä¸ªé—®é¢˜å½±å“æœ‰é™ï¼š

- å¯èƒ½ä¼šé€ æˆä¸»åº”ç”¨é€šè¿‡ `syncUrlToIframe` åŒæ­¥è·¯ç”±æ—¶ï¼Œå­åº”ç”¨çš„ `pathname` é”™è¯¯ [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]

ä¸ºä»€ä¹ˆï¼Ÿ

- å¯¹äºé‡å»ºæ¨¡å¼ï¼Œæ¯æ¬¡éƒ½ä¼šé”€æ¯å®ä¾‹é‡å»ºï¼Œ`url` ä»¥ `startApp` æä¾›çš„é…ç½®ä¸ºå‡† [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)]
- å…¶å®ƒä¸é”€æ¯å®ä¾‹çš„æ¨¡å¼ä¸‹ï¼Œ`active` è®¾ç½® `url` åä»…åšäº†åŒæ­¥è·¯ç”±çš„æ“ä½œ [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]
- å…¶å®ƒå…³äºè·¯ç”±ã€`location` ç­‰æ“ä½œå·²åœ¨æ„é€ å‡½æ•°å®Œæˆ [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]
- è€Œåº”ç”¨èµ„æºåˆ™åœ¨ `active` ä¹‹å‰å·²é€šè¿‡ `importHTML` åŠ è½½å®Œæ¯• [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

åªèƒ½è¯´ `url` åˆ†å¼€èµ‹å€¼æœ‰å¯èƒ½é€ æˆéšæ‚£ï¼Œå¦‚ä½•å½»åº•æœç»å‘¢ï¼Ÿ

- `active` å–æ¶ˆèµ‹å€¼ `url`ï¼Œç›´æ¥ä» `this.url` ä¸­è·å–ï¼Œå› ä¸ºæ„é€ å‡½æ•°å·²èµ‹å€¼äº†

`url` ä½¿ç”¨çš„åœºæ™¯ï¼š

- `WuJie`ï¼šæ„é€ å‡½æ•°å®ä¾‹åŒ– [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]
- `initBase`ï¼šåˆå§‹åŒ–è®¾ç½®æ²™ç®± `base` å…ƒç´  [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]
- `importHTML`ï¼šåŠ è½½åº”ç”¨èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- `active`ï¼šæ¿€æ´»åº”ç”¨åŒæ­¥è·¯ç”± [[æŸ¥çœ‹](#3-åŒæ­¥è·¯ç”±)]
- `syncUrlToIframe`ï¼šåŒæ­¥åŸºåº§çš„è·¯ç”±åˆ°å­åº”ç”¨ [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]

> é¡ºåºä»ä¸Šè‡³ä¸‹ï¼Œåªåˆ—ä¸¾äº†å’Œ `url` ç›´æ¥å…³è”çš„æ–¹æ³•ï¼Œä¸åŒ…å«è¡ç”Ÿå¯¹è±¡ï¼Œä¾‹å¦‚ï¼š`proxyLocation` [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

é‚£ `preloadApp` å’Œ `startApp` æä¾›çš„åº”ç”¨åä¸ä¸€æ ·å‘¢ï¼Ÿ

- é‚£å°±ä½œä¸ºä¸åŒçš„åº”ç”¨åŠ è½½äº†ï¼Œ`wujie` æŒ‰ç…§åº”ç”¨åæ¥åˆ’åˆ†åº”ç”¨

**`plugins`ï¼šæ’ä»¶é›†åˆ**

`wujie` çš„æ’ä»¶ç³»ç»Ÿï¼Œç±»å‹ä¸º `Array<plugin>`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html)]

å±æ€§å€¼çš„æ›´æ–°ï¼š

- `constructor` æ„å»ºï¼š`Array<plugin>`
- `destroy` é”€æ¯ï¼š`null`

æ„å»ºæ—¶é€šè¿‡ `getPlugins` ç¡®ä¿è‡³å°‘åŒ…å« 2 ä¸ªé»˜è®¤æ’ä»¶ã€‚

æ’ä»¶ 1ï¼š`cssBeforeLoaders` - `å†…è”æ ·å¼`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/plugin.ts#L70)]

- ç”± `processCssLoaderForTemplate` æ·»åŠ åˆ°æ¯ä¸ªåº”ç”¨å¤´éƒ¨ [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)]
- è§£å†³ `shadowRoot` ä¸‹æµ®çª—å±‚çº§é—®é¢˜ï¼Œè§ï¼š`issue` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/issues/455)]

æ’ä»¶ 2ï¼š`cssLoader` - `cssRelativePathResolve`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/plugin.ts#L57)]

å‚æ•°ï¼š

- `code`ï¼šæ ·å¼ä»£ç æˆ–ç©ºå­—ç¬¦
- `src`ï¼šå†…è”æ ·å¼æ˜¯ç©ºå­—ç¬¦ï¼Œå¤–è”æ ·å¼ä¸ºé“¾æ¥ç›¸å¯¹è·¯å¾„ï¼Œæˆ–ç»å¯¹è·¯å¾„
- `base`ï¼šä» `proxyLocation` ä¸­æå–ï¼š`host` + `pathname`

ç›®çš„ï¼š

- ä¿®æ”¹å†…è”æ ·å¼ä¸­çš„ç›¸å¯¹è·¯å¾„èµ„æºé“¾æ¥ï¼ŒæŒ‰ç…§å­åº”ç”¨å…¥å£é“¾æ¥è½¬æ¢ä¸ºç»å¯¹è·¯å¾„

`code` æ ·å¼æ ¹æ® `ignore` æ¥å†³å®šæ ·å¼åŠ è½½æ–¹å¼ï¼š

- `ignore`ï¼š`code` ä¸ºç©ºå­—ç¬¦ï¼Œä½œä¸ºå¤–è”æ ·å¼é€šè¿‡æµè§ˆå™¨åŠ è½½ï¼Œè§ï¼š`getExternalStyleSheets` [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]
- å…¶å®ƒæƒ…å†µï¼šå…¨éƒ¨æä¾›æ ·å¼ä»£ç ï¼Œå³ä¾¿æ˜¯å¤–è”æ ·å¼ä¹Ÿä¼šé€šè¿‡ `fetchAssets` åŠ è½½ [[æŸ¥çœ‹](#fetchassetsåŠ è½½èµ„æºç¼“å­˜åè¿”å›-promise)]

> å¯¹äº `cssExcludes` æ’é™¤çš„æ ·å¼ä¸ä¼šä½œä¸ºåº”ç”¨ä¸­çš„æ ·å¼è¿›è¡Œå¤„ç†

å› æ­¤ï¼š

- `ignore`ï¼šç”±äºæä¾›çš„æ˜¯ç©ºå­—ç¬¦ï¼Œä¸åšä»»ä½•å¤„ç†
- å…¶ä»–æƒ…å†µï¼šåŒ¹é…æ¢æ ·å¼ä¸­çš„ç›¸å¯¹è·¯å¾„ï¼Œæ›¿æ¢ä¸ºç»å¯¹è·¯å¾„

> é€šè¿‡å¤–è”åŠ è½½çš„æ ·å¼ï¼Œå¼•ç”¨çš„èµ„æºéœ€è¦è®¾ä¸ºç»å¯¹è·¯å¾„æˆ– `base64`ï¼Œå¦åˆ™ä¼šå› ä¸ºè·¯å¾„ä¸å¯¹æ‰¾ä¸åˆ°èµ„æº

è°ƒç”¨åœºæ™¯ï¼š

- `processCssLoader`ï¼šå¤„ç†åº”ç”¨ä¸­çš„é™æ€æ ·å¼æ›¿æ¢ [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
- `getCssLoader`ï¼šæ¥è‡ªåŠ¨æ€æ·»åŠ å’Œæ‰‹åŠ¨æ·»åŠ çš„æ ·å¼æ›¿æ¢ï¼Œè§ï¼šé€šè¿‡é…ç½®æ›¿æ¢èµ„æº [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]

å¤„ç†å‰ä¼šæ ¹æ®æ ·å¼ `src` è®¡ç®— `baseUrl`ï¼š

- ç©ºå­—ç¬¦é‡‡ç”¨åº”ç”¨çš„ `base`ï¼Œå¦‚å†…è”æ ·å¼
- å…¶ä½™å‚è€ƒ `getAbsolutePath`ï¼Œæ ·å¼çš„ `src` ä¸º `url`ï¼Œåº”ç”¨å…¥å£é“¾æ¥ä¸º `base` [[æŸ¥çœ‹](#getabsolutepathè·å–ç»å¯¹è·¯å¾„)]

ä¹‹åå†æå–æ ·å¼ä¸­çš„è·¯å¾„ï¼Œå»åŒ¹é… `baseUrl`ï¼š

- ç©ºå­—ç¬¦ï¼š`baseUrl`ï¼Œè¿™æ ·æ˜¯é”™è¯¯æƒ…å†µï¼Œæ‹¿åˆ°çš„æ˜¯ `baseUrl`ï¼Œå¾—ä¸åˆ°çœŸå®èµ„æº
- å…¶ä½™å‚è€ƒ `getAbsolutePath`ï¼Œèµ„æºé“¾æ¥ä¸º `url`ï¼Œ`baseUrl` ä¸º `base` [[æŸ¥çœ‹](#getabsolutepathè·å–ç»å¯¹è·¯å¾„)]

æœ€åè¯´è¯´æ­£åˆ™ï¼š

```
/(url\((?!['"]?(?:data):)['"]?)([^'")]*)(['"]?\))/g
```

> `//g`ï¼šè¯´æ˜æ˜¯åŒ¹é…æ ·å¼å…¨å±€ä¸­æ‰€æœ‰çš„å†…å®¹

ç¬¬ä¸€å±‚åˆ†æˆ 3 ä¸ªæ‹¬å·ï¼Œå…ˆçœ‹å 2 ä¸ªï¼š

- `(['"]?\))` åŒ…å«ï¼š`')`ã€`")`ã€`)`
- `([^'")]*)` åŒ…å«ï¼šé™¤åŒå¼•å·æˆ–å•å¼•å·ä¹‹å¤–æ‰€æœ‰å†…å®¹

ç¬¬ 1 ä¸ªæ‹¬å·é‡Œé¢çš„æ­£åˆ™ï¼š

- `(url\(.*)`ï¼šä»¥ `url(` å¼€å¤´
- `(?!)`ï¼šè´Ÿå‰ç»è§„åˆ™
- `['"]?`ï¼šæœ€å¤šæœ‰ 1 ä¸ªå•å¼•å·æˆ–åŒå¼•å·

è´Ÿå‰ç»è§„åˆ™ `exp1(?!exp2)` è§£è¯»ï¼š

- æŸ¥æ‰¾åé¢ä¸æ˜¯ `exp2` çš„ `exp1`
- è¿™é‡Œçš„ `exp2` æ˜¯ï¼š`['"]?(?:data):`ï¼Œå¼€å¤´æœ€å¤š 1 ä¸ªå¼•å· + `data:`

> `?:` è¡¨ç¤ºéæ•è·åˆ†ç»„ï¼ŒåŒ¹é…çš„å€¼ä¸ä¼šä¿å­˜ï¼Œå’Œå®ƒç›¸åçš„æ˜¯æ•è·åˆ†ç»„ `()`

è¿èµ·æ¥çœ‹ `replace` ä¸­ç¬¬äºŒä¸ªå‡½æ•°ä¸­çš„å‚æ•°ï¼š

- `_m`ï¼šåŒ¹é…çš„å…¨éƒ¨å­—ç¬¦ï¼Œè¿™é‡Œç”¨ä¸ä¸Š
- `pre`ï¼šä»¥ `url(` å¼€å¤´å¯ä»¥è·Ÿç€ 1 ä¸ªå¼•å·ï¼Œä½†ä¸èƒ½æ˜¯ `"data:`ã€`'data:`ã€`data:`
- `url`ï¼š`post` ä¹‹å‰æ‰€æœ‰çš„å†…å®¹
- `post`ï¼š`')`ã€`")`ã€`)`

> ä»è¿™èƒ½çœ‹å‡ºæ¥åŒ¹é…çš„æ˜¯ `url(.*)` çš„èµ„æºè·¯å¾„ï¼Œä½†ä¸èƒ½æ˜¯ `base64`

æœ€ç»ˆå°† `url` æ›¿æ¢æˆç»å¯¹è·¯å¾„è¿”å›ï¼š

- `pre` + `absoluteUrl` + `post`

### `wujie` ä¸­çš„ä»£ç†

![wujie-proxy](https://github.com/user-attachments/assets/25088666-fe65-442e-88a2-3e44f3bb3ba6)

#### ğŸ“ `proxyGenerator` éé™çº§æƒ…å†µä¸‹çš„ä»£ç†

éé™çº§ `degrade` æƒ…å†µä¸‹ä»£ç†ï¼š`window`ã€`document`ã€`location`

ç›®å½•ï¼š`entry.ts` - `proxyGenerator` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/proxy.ts#L40)]

å‚æ•°ï¼š

- `iframe`ï¼šæ²™ç®± `iframe`
- `urlElement`ï¼šå°†å­åº”ç”¨å…¥å£é“¾æ¥é€šè¿‡ `appRouteParse` è½¬æ¢æˆ `HTMLAnchorElement` å¯¹è±¡ [[æŸ¥çœ‹](#approuteparse-æå–é“¾æ¥)]
- `mainHostPath`ï¼šåŸºåº§ `origin`
- `appHostPath`ï¼šå­åº”ç”¨ `origin`

è¿”å› 1 å¯¹è±¡ï¼ŒåŒ…å« 3 ä¸ªå±æ€§ï¼š

- `proxyWindow`ï¼šä»£ç†æ²™ç®± `window` å¯¹è±¡ï¼Œé™çº§ä»£ç† `localGenerator` ä¸æä¾›
- `proxyDocument`ï¼šä»£ç†ç©ºå¯¹è±¡ï¼Œä½†æ ¹æ®æƒ…å†µé€‰æ‹©ä¸åŒå®¹å™¨è¿›è¡ŒåŠ«æŒæˆ–æ“ä½œ
- `proxyLocation`ï¼šä»£ç†ç©ºå¯¹è±¡ï¼Œä½†æ ¹æ®æƒ…å†µä½¿ç”¨å­åº”ç”¨é“¾æ¥æˆ–æ²™ç®± `location` åŠ«æŒæˆ–æ“ä½œ

#### 1. ä»£ç†æ²™ç®± `window` ä½œä¸º `proxyWindow`

åˆ†åˆ«å¯¹ `get`ã€`set`ã€`has` åšäº†ä»£ç†ï¼Œåœ¨æä¾›çš„æµç¨‹å›¾ä¸­å¯ä»¥çœ‹åˆ° [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]ï¼š

- `proxyWindow` æ˜¯åŒ…è£¹åœ¨ `script module` ä¸‹å·¥ä½œçš„
- å³å­åº”ç”¨ä¸­çš„ `script` å¯¹ `window` ç­‰å…¨å±€å¯¹è±¡æ“ä½œéƒ½æŒ‡å‘åŒä¸€ä¸ª `proxyWindow`
- è¿™æ ·å³ä¾¿æ˜¯æ²™ç®± `window` ä¹Ÿä¸ä¼šå—åˆ°åº”ç”¨æ±¡æŸ“
- è€Œå¯¹äºä¸åŒçš„åº”ç”¨ï¼Œå„è‡ªåº”ç”¨ä¸‹çš„ `script` éƒ½æŒ‡å‘å„è‡ªåº”ç”¨çš„ `proxyWindow`

**`get` æ“ä½œæŒ‰ç…§è·å–çš„ `property` è¿”å›ç›¸åº”å¯¹è±¡**

è¿”å› `proxyLocation` [[æŸ¥çœ‹](#3-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxylocation)]ï¼š

- `location`

è¿”å›è‡ªèº« `proxyWindow`ï¼š

- `self`
- `window`ï¼šå¿…é¡»æ˜¯å…¨å±€ `window` æè¿°ä¸­å­˜åœ¨ `get` å±æ€§

ä»æ²™ç®± `window` è·å– `property` ç›´æ¥è¿”å›ï¼Œä¸éœ€è¦ç»‘å®š `this`ï¼š

- `__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__`ï¼šè§ï¼š`initIframeDom` [[æŸ¥çœ‹](#initiframedomåˆå§‹åŒ–-iframe-çš„-dom-ç»“æ„)]
- `__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__`ï¼šè§ï¼š`initIframeDom` [[æŸ¥çœ‹](#initiframedomåˆå§‹åŒ–-iframe-çš„-dom-ç»“æ„)]
- é€šè¿‡ `getOwnPropertyDescriptor` è·å– `property` æè¿°ä¿¡æ¯ä¸ºä¸å¯é…ç½®ä¸”ä¸å¯å†™

é€šè¿‡ `getTargetValue` è·å–æ²™ç®± `window` çš„å±æ€§ [[æŸ¥çœ‹](#gettargetvalue-ä»å¯¹è±¡ä¸­è·å–å±æ€§)]ï¼š

- ç¬¦åˆ `setFnCacheMap` è¦æ±‚çš„å±æ€§ï¼Œéœ€è¦ç»‘å®š `this` ä¸ºæ²™ç®± `window` [[æŸ¥çœ‹](#1-setfncachemap-å­˜å‚¨ç»‘å®šä¸Šä¸‹æ–‡çš„æ–¹æ³•)]
- ä¸ç¬¦åˆ `setFnCacheMap` è¦æ±‚ç›´æ¥ä»æ²™ç®± `window` ä¸­æ‰¾åˆ°å±æ€§å¹¶è¿”å›ï¼Œæ‰¾ä¸åˆ°è¿”å› `undefined`
- å…¨å±€ `window` æè¿°ä¿¡æ¯ä¸­ä¸å­˜åœ¨ `get` å±æ€§ï¼Œä»æ²™ç®±ä¸­è·å–å±æ€§ `window`

**`set` æ“ä½œ**

ç›´æ¥ç»‘å®šåœ¨æ²™ç®± `window` å¯¹è±¡ä¸Šï¼š

- ç»‘å®šå‰ä¼šé€šè¿‡ `checkProxyFunction` å°†ç¬¦åˆè¦æ±‚çš„æ–¹æ³•å­˜å…¥æ˜ å°„è¡¨ï¼Œè§ï¼š`setFnCacheMap` [[æŸ¥çœ‹](#1-setfncachemap-å­˜å‚¨ç»‘å®šä¸Šä¸‹æ–‡çš„æ–¹æ³•)]
- ä»¥ä¾¿ä¸‹æ¬¡ `get` æ“ä½œæ—¶ï¼Œç›´æ¥ä»ç¼“å­˜è¡¨ä¸­è·å–

**`has` æ“ä½œ**

ä» `proxyWindow` ä¸­åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¯¹è±¡ï¼š

- `proxyWindow` æ˜¯æ²™ç®± `window` çš„ä»£ç†ï¼Œå¯ç›´é€šè¿‡ `in` åˆ¤æ–­å±æ€§æ˜¯å¦å­˜åœ¨

**ä¸€é“æ€è€ƒé¢˜ï¼š`proxyWindow` ä¸­çš„ `document` æŒ‡å‘è°ï¼Ÿ**

ä¼šé€šè¿‡ `getTargetValue` ä»æ²™ç®± `window` ä¸­ç›´æ¥è·å– `document` å±æ€§

> `proxyWindow` å’Œ `proxyLocation` å¯ä»¥åŒ…è£¹åœ¨ `script module` ä¸­ï¼Œä½†æ˜¯ `proxyDocument` ä¸è¡Œï¼Œå› ä¸º `Dom` æœ¬èº«æ˜¯ä»ä¸Šè‡³ä¸‹çš„æ ‘çŠ¶ç»“æ„

è¡ç”Ÿé—®é¢˜ï¼šæ²™ç®± `document` å¦‚ä½•æŒ‡å‘ `proxyDocument`

- é€šè¿‡ `patchDocumentEffect` è¿›è¡Œæ‹¦æˆªï¼Œè§ï¼š`proxyDocument` åœ¨å“ªè°ƒç”¨ [[æŸ¥çœ‹](#proxydocument-åœ¨å“ªè°ƒç”¨)]

#### 2. ä»£ç†ç©ºå¯¹è±¡ä½œä¸º `proxyDocument`

ä»£ç†çš„æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ `{}`ï¼Œä¸”åªæœ‰ `get` å–å€¼ï¼š

- åœ¨ `get` æ“ä½œä¸­ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¹Ÿç§°ä¸º `_fakeDocument`ï¼ˆå‡çš„ï¼‰ï¼Œä¸ä¼šä»è¿™ä¸ªå¯¹è±¡ä¸Šåšä»»ä½•æ“ä½œ

å–å€¼å‰çš„å‡†å¤‡å·¥ä½œï¼š

- ä»å…¨å±€ `window` ä¸Šè·å–ï¼š`document`ï¼Œä»åº”ç”¨å®ä¾‹ä¸Šè·å–ï¼š`shadowRoot` å®¹å™¨ã€`proxyLocation`
- ä»æ²™ç®± `window` ä¸Šè·å–åŸç”Ÿæ–¹æ³•ï¼š`rawCreateElement` åˆ›å»ºå…ƒç´ ã€`rawCreateTextNode` åˆ›å»ºæ–‡æœ¬

> åœ¨è·å–å¯¹è±¡å‰éœ€è¦ç¡®ä¿ `shadowRoot` å·²å®ä¾‹åŒ–ï¼Œå¦åˆ™é€šè¿‡ `stopMainAppRun` è¾“å‡ºè­¦å‘Šå¹¶æŠ›å‡ºé”™è¯¯ä¸­æ–­æ‰§è¡Œ

**ä»£ç† `createElement` å’Œ `createTextNode`ï¼š**

- ä»£ç†åŠ«æŒ `document` ä¸Šå¯¹çš„æ–¹æ³•ï¼Œå¹¶å°†å…¶è¿”å›ä½œä¸ºå­åº”ç”¨çš„å¯¹åº”çš„æ–¹æ³•

åœ¨ `Proxy` ä¸­é€šè¿‡ `apply` åœ¨è°ƒç”¨æ—¶ä»£ç†æ“ä½œè¡Œä¸ºï¼š

- æ ¹æ® `property` å†³å®šä½¿ç”¨ `rawCreateElement` è¿˜æ˜¯ `rawCreateTextNode`
- æ‰§è¡Œæ–¹æ³•æ—¶é€šè¿‡ `apply` ç»‘å®šæ²™ç®± `iframe.contentDocument` ä½œä¸º `this`ï¼Œé€ä¼ å‚æ•° `arg`
- é€šè¿‡ `patchElementEffect` ä¸ºåˆ›å»ºçš„æ¯ä¸ª `Dom` æ‰“è¡¥ä¸åå¹¶è¿”å› [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]

å¤‡æ³¨ï¼š

- åœ¨åº”ç”¨ä¸­æ‰€æœ‰çš„ `createElement`ã€`createTextNode` éƒ½ä¼šé€šè¿‡æ²™ç®± `iframe`
- è€Œ `appendChild`ã€`insertBefore` éƒ½ä¼šé€šè¿‡ `shadowRoot`
- è¿™æ˜¯å› ä¸ºåˆ›å»ºå…ƒç´ æ—¶éœ€è¦é€šè¿‡ `patchElementEffect` æ‰“è¡¥ä¸ï¼Œè€Œæœ€ç»ˆæ˜¯è¦åœ¨ `shadowRoot` å®¹å™¨ä¸­æŒ‚è½½

**ä»£ç† `documentURI` å’Œ `URL`ï¼š**

- è¿”å› `proxyLocation` çš„ `href`

**ä»£ç†ï¼šé€šè¿‡æ ‡ç­¾è·å–å…ƒç´ **

- åŒ…å«ï¼š`getElementsByTagName`ã€`getElementsByClassName`ã€`getElementsByName`
- åŠ«æŒ `shadowRoot.querySelectorAll` è¿”å› `Proxy` å¯¹è±¡
- åœ¨è¿”å›çš„å¯¹è±¡ä¸­é€šè¿‡ `apply` å»å¤„ç†å­åº”ç”¨è·å–ä»£ç†æ–¹æ³•åï¼Œå¤„ç†æ‰§è¡Œç»“æœå¹¶è¿”å›

å¦‚æœä¸Šä¸‹æ–‡ `this` ä¸æ˜¯ `iframe.contentDocument`ï¼š

- ç›´æ¥ä»ä¸Šä¸‹æ–‡ä¸­è·å–å…ƒç´ ï¼Œè¯´æ˜å½“å‰æ“ä½œçš„ `Dom` å¯¹è±¡æ²¡æœ‰æ‰“è¡¥ä¸æŒ‡å‘æ²™ç®± `document`

å¦‚æœ `getElementsByTagName` è·å–æ‰€æœ‰çš„ `script`ï¼š

- è¿”å› `iframe.contentDocument.scripts`ï¼Œå› ä¸ºæ‰€æœ‰çš„ `script` å­˜æ”¾åœ¨æ²™ç®± `iframe` ä¸­

å…¶å®ƒæƒ…å†µå…¨éƒ¨åœ¨ `shadowRoot` è·å–ï¼Œä½†æ˜¯è·å–å‰éœ€è¦è½¬æ¢ä¸‹å‚æ•°ï¼š

- `getElementsByTagName`ï¼šä¸éœ€è¦å¤„ç†
- `getElementsByClassName`ï¼šè½¬æ¢æˆå…ƒç´ ç±»å `.{$arg}`
- `getElementsByName`ï¼šè½¬æ¢æˆå…ƒç´ å±æ€§å `[name="${arg}"]`

**ä»£ç†ï¼š`getElementById`**

- åŠ«æŒ `shadowRoot.querySelector` è¿”å› `Proxy` å¯¹è±¡
- åœ¨è¿”å›çš„å¯¹è±¡ä¸­é€šè¿‡ `apply` å»å¤„ç†å­åº”ç”¨è·å–ä»£ç†æ–¹æ³•åï¼Œå¤„ç†æ‰§è¡Œç»“æœå¹¶è¿”å›

å¦‚æœä¸Šä¸‹æ–‡ `this` ä¸æ˜¯ `iframe.contentDocument`ï¼š

- ç›´æ¥ä»ä¸Šä¸‹æ–‡ä¸­è·å–å…ƒç´ ï¼Œè¯´æ˜å½“å‰æ“ä½œçš„ `Dom` å¯¹è±¡æ²¡æœ‰æ‰“è¡¥ä¸æŒ‡å‘æ²™ç®± `document`

å¦åˆ™ï¼š

- è½¬æ¢å‚æ•°å»åŒ¹é… `querySelector` åšæŸ¥è¯¢ï¼Œå¦‚ï¼š`[id="${arg}"]`
- ä¼˜å…ˆä» `shadowRoot` å»æŸ¥è¯¢ï¼Œæ‰¾ä¸åˆ°å†å»æ²™ç®± `iframe` ä¸­æŸ¥è¯¢ï¼Œå› ä¸ºè·å–çš„æœ‰å¯èƒ½æ˜¯ `script`

**ä»£ç†ï¼šæŸ¥è¯¢æ–¹æ³•**

- åŒ…å«ï¼š`querySelector`ã€`querySelectorAll`
- åŠ«æŒ `shadowRoot` å¯¹åº”æ–¹æ³•è¿”å› `Proxy` å¯¹è±¡
- åœ¨è¿”å›çš„å¯¹è±¡ä¸­é€šè¿‡ `apply` å»å¤„ç†å­åº”ç”¨è·å–ä»£ç†æ–¹æ³•åï¼Œå¤„ç†æ‰§è¡Œç»“æœå¹¶è¿”å›

å¦‚æœä¸Šä¸‹æ–‡ `this` ä¸æ˜¯ `iframe.contentDocument`ï¼š

- ç›´æ¥ä»ä¸Šä¸‹æ–‡ä¸­è·å–å…ƒç´ ï¼Œè¯´æ˜å½“å‰æ“ä½œçš„ `Dom` å¯¹è±¡æ²¡æœ‰æ‰“è¡¥ä¸æŒ‡å‘æ²™ç®± `document`

å¦åˆ™ï¼š

- ä¼˜å…ˆä» `shadowRoot` æŸ¥è¯¢ï¼ŒæŸ¥è¯¢ä¸åˆ°å†å»æ²™ç®± `iframe` ä¸­æŸ¥è¯¢
- ä½†ä¸ä¼šå»æŸ¥æ²™ç®± `iframe` ä¸­çš„ `base` å…ƒç´ ï¼Œå› ä¸ºä»–ä¼šå½±å“è·¯ç”±

> ä»ä¸Šé¢å¯ä»¥æ˜ç¡®çŸ¥é“ï¼Œå­˜æ”¾ `script` ä¸€å®šæ˜¯æ²™ç®± `iframe`ï¼Œå…¶å®ƒå…ƒç´ ä¸€å®šæ˜¯ `shadowRoot`ï¼Œå¦åˆ™å°±ä¼šåŒ¹é…é”™ä¹±

**ä»£ç†ï¼šæŸ¥è¯¢ `html` å…ƒç´ **

- è¿”å›çš„ä¸€å®šæ˜¯ `shadowRoot` å®¹å™¨ä¸­çš„ `shadowRoot.firstElementChild`

**ä»£ç†ï¼šæŸ¥è¯¢å…ƒç´ é›†åˆ**

åœ¨ `shadowRoot` å®¹å™¨ä¸­é€šè¿‡ `querySelectorAll` å»åŒ¹é…ç›¸åº”çš„å…ƒç´ é›†åˆï¼š

- `forms`ï¼š`form`
- `images`ï¼š`img`
- `links`ï¼š`a`

**ä»£ç†ï¼š`documentProxyProperties`**

åŒ…å«çš„å…ƒç´ è§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L42)]ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

`ownerProperties`ã€`shadowProperties`ï¼š

- å¦‚æœ `property` æ˜¯ `activeElement`ï¼Œä¸” `shadowRoot` ä¸­ä¸å­˜åœ¨çš„æƒ…å†µä¸‹è¿”å› `shadowRoot.body`
- å…¶å®ƒä¸€å¾‹ä» `shadowRoot` ä¸­è¿”å›å¯¹åº”çš„å±æ€§

`shadowMethods`ï¼š

- é€šè¿‡ `getTargetValue` ä¼˜å…ˆä» `shadowRoot` è·å–ï¼Œå¦è€…ä»å…¨å±€ `document` ä¸­è·å– [[æŸ¥çœ‹](#gettargetvalue-ä»å¯¹è±¡ä¸­è·å–å±æ€§)]

`documentProperties`ï¼š

- ç›´æ¥ä»å…¨å±€ `document` ä¸­è·å–

`documentMethods`ï¼š

- é€šè¿‡ `getTargetValue` ä»å…¨å±€ `document` ä¸­è·å– [[æŸ¥çœ‹](#gettargetvalue-ä»å¯¹è±¡ä¸­è·å–å±æ€§)]

**`proxyDocument` ä¸‹é—æ¼äº† `location`**

å­åº”ç”¨ä¸­ä» `document` æ‹¿åˆ°çš„ `location` å’Œ `window.loaction` ä¸ä¸€è‡´ï¼Œè§ï¼š`proxyLocation` [[æŸ¥çœ‹](#3-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxylocation)]

è§£å†³åŠæ³•å’Œ `proxyWindow` ä¸€æ ·ï¼Œå¢åŠ  `location` æ‹¦æˆªï¼š

```
const { shadowRoot, proxyLocation } = iframe.contentWindow.__WUJIE;
if (propKey === "location") {
  return proxyLocation;
}
```

åŒæ ·éœ€è¦åœ¨æ²™ç®± `iframe` åˆå§‹åŒ–æ—¶å¢åŠ æŒ‡å‘ï¼Œç¬¬ 545 è¡Œ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L545)]ï¼š

```
ownerProperties.concat('location').forEach((propKey) => {
  // ...
});
```

#### 3. ä»£ç†ç©ºå¯¹è±¡ä½œä¸º `proxyLocation`

ä»£ç†çš„æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ `{}`ï¼Œåœ¨ `get` å’Œ `set` ä¸­ï¼š

- ç¬¬ä¸€ä¸ªå¯¹è±¡ä¹Ÿç§°ä¸º `_fakeDocument`ï¼ˆå‡çš„ï¼‰ï¼Œä¸ä¼šä»è¿™ä¸ªå¯¹è±¡ä¸Šåšä»»ä½•æ“ä½œ
- å› æ­¤è¯»å–å±æ€§ä» `iframe.contentWindow.location` å¯¹è±¡ä¸­è·å–

è®¾è®¡åˆè¡·ï¼š

- åœ¨æ²™ç®± `iframe` åˆå§‹åŒ–æ—¶å·²å°† `src` è®¾ä¸ºå’ŒåŸºåº§åŒåŸŸï¼Œç”±æ­¤å†³å®šäº†æ²™ç®± `location`
- è€Œåœ¨æ²™ç®±ä¸­æ›´æ–°é“¾æ¥æˆ– `history`ï¼Œä¹Ÿéœ€è¦ç¡®ä¿æ›´æ–°çš„ `url` å’ŒåŸºåº§åŒåŸŸ
- ä½†æ˜¯å­åº”ç”¨ä¸­é€šè¿‡ `location` è¯»å–å±æ€§æ—¶ï¼Œåˆ™éœ€è¦ä¿æŒå’Œèµ„æºå…¥å£é“¾æ¥åŒåŸŸ

æ¦‚å¿µåè¯ï¼š

- `proxyLocation`ï¼šåœ¨æ²™ç®±ä¸­åŒ…è£¹åœ¨ `script module` ä¸­ä½œä¸ºä»£ç†çš„ `location`ï¼Œè§ï¼šæµç¨‹å›¾ [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]
- æ²™ç®± `location`ï¼šæ²™ç®± `iframe` ä¸‹çš„ `location` å¯¹è±¡

è¿™æ ·å°±æ„å‘³ç€ï¼š

- åº”ç”¨ä¸­æ‰€æœ‰çš„å†…è” `script` çš„ `location` æ“ä½œéƒ½æŒ‡å‘ `proxyLocation`
- åº”ç”¨çš„ `window` æŒ‡å‘ `proxyWindow`ï¼Œè€Œ `proxyWindow` çš„ `location` æŒ‡å‘ `proxyLocation`
- è€Œæ²™ç®± `iframe` è¯»å–æ“ä½œçš„ `location` å¯¹è±¡ï¼Œä¸ä¼šå—åˆ°æ¥è‡ª `proxyLocation` å¯¹è±¡ä»»ä½•æ±¡æŸ“

`location` ä¸åŒçš„æŒ‡å‘ï¼š

- å¤–è” `script` å’Œ `script module`ï¼šæ²™ç®± `location`
- å†…è” `script` æ ¹æ®ç¯å¢ƒå’Œè·å–çš„å¯¹è±¡ä¸åŒï¼ŒæŒ‡å‘ä¹Ÿä¸åŒ

| åˆ†ç±»                | `shadowRoot`    | `iframe` å®¹å™¨   |
| ------------------- | --------------- | --------------- |
| `window.location`   | `proxyLocation` | æ²™ç®± `location` |
| `document.location` | æ²™ç®± `location` | æ²™ç®± `location` |
| `location`          | `proxyLocation` | æ²™ç®± `location` |

> è¯¦ç»†è§ `proxyLocation` çš„é—®é¢˜ [[æŸ¥çœ‹](#proxylocation-çš„é—®é¢˜)]

æ²™ç®± `location` å’Œ `proxyLocation` æœ‰ä»€ä¹ˆä¸åŒï¼š

- æ²™ç®± `location` å’ŒåŸºåº§åŒåŸŸ
- `proxyLocation` æŒ‰ç…§å­åº”ç”¨å…¥å£é“¾æ¥å†³å®š `location`

å¦‚ä½•ç¡®ä¿æ­£ç¡®æ‹¿åˆ°å­åº”ç”¨å…¥å£é“¾æ¥çš„ `location`ï¼š

- ä¸è¦é€šè¿‡ `document` è·å– `location`
- é™çº§å®¹å™¨ä¸‹åªèƒ½é€šè¿‡ `window.__WUJIE.proxyLocation` è·å–

æ‹¦æˆªçš„æ–¹æ³•ï¼š

- `get`ï¼šå–å€¼
- `set`ï¼šèµ‹å€¼
- `ownKeys`ï¼šæšä¸¾æ‰€æœ‰å±æ€§
- `getOwnPropertyDescriptor` è·å–æè¿°ä¿¡æ¯

**`get` å–å€¼**

- æ‹¦æˆªå­åº”ç”¨è¯»å– `location` å¯¹è±¡ä¸­æ‰€æœ‰å±æ€§å’Œæ–¹æ³•

ä»å­åº”ç”¨å…¥å£é“¾æ¥è·å–ä¿¡æ¯ï¼ŒåŒ…å«ï¼š

- `host`ã€`hostname`ã€`protocol`ã€`port`ã€`origin`

è·å– `href`ï¼šå°† `origin` ä¿®æ”¹ä¸ºå­åº”ç”¨

- è·å–æ²™ç®± `iframe` çš„ `location.href`ï¼Œè¿”å›ä¹‹å‰è¦å°†ä¸»åº”ç”¨çš„ `origin` æ›¿æ¢ä¸ºå­åº”ç”¨çš„ `origin`
- å› ä¸ºæ²™ç®± `iframe` å’ŒåŸºåº§åŒåŸŸï¼Œè€Œåº”ç”¨ä¸­èµ„æºçš„ `url` æ˜¯åŸºäºå­åº”ç”¨çš„ `origin`

å±è”½ `reload` çš„ `bug`ï¼š

- åˆè¡·ï¼šæ¯•ç«Ÿè¾›è‹¦åŠ è½½çš„ `script`ï¼Œä¸èƒ½å› ä¸º `replad` æ¸…ç©ºäº†
- åŸå› ï¼šå­åº” `reload` ç”¨ä¼šå› ä¸ºè‡ªèº«çš„ `src` æ˜¯åŸºåº§çš„ `origin`ï¼Œé‡æ–°åŠ è½½åŸºåº§é€ æˆé”™è¯¯
- é—®é¢˜ï¼šä½†åŒæ—¶ä¹Ÿé˜‰å‰²å­åº”ç”¨ `location.reload` åŠŸèƒ½
- ä¿®å¤ï¼šæ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯è½¬å‘è‡ªå…¨å±€ `window.location.reload`

å¤„ç† `replace` çš„ `bug`ï¼Œå…ˆè§£è¯»æµç¨‹ï¼š

- ä»£ç†æ²™ç®±çš„ `location.replace` åœ¨ `apply` ä¸­å°†æ›´æ–° `replace` æ“ä½œçš„ `url`
- æ›´æ–° `url` çš„æ–¹å¼ï¼šå°†å­åº”ç”¨çš„ `origin` æ›¿æ¢ä¸ºåŸºåº§ `origin`
- ç›®çš„ï¼šä¿æŒæ²™ç®± `iframe` å’ŒåŸºåº§åŒæº

`replace` çš„æ¡ä»¶ï¼š

| æ¡ä»¶                                               | é€šå¸¸åšæ³•                                                                                                                                                                 |
| -------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| åªæ›¿æ¢å¸¦æœ‰å­åº”ç”¨ `origin` çš„ç»å¯¹è·¯å¾„               | é€šå¸¸ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œæ¯•ç«Ÿçº¿ä¸Šçº¿ä¸‹ `host` ä¸ä¸€æ ·ï¼Œä½†ç›¸å¯¹è·¯å¾„ä¹Ÿå­˜åœ¨é—®é¢˜                                                                                                       |
| åªæ‹¦æˆª `location.replace` ä¸æ‹¦æˆª `history.replace` | å¯¹äºå•ä¾‹åº”ç”¨æ¥è¯´é€šå¸¸æ˜¯ç”± `history` æ¥è´Ÿè´£è·¯ç”± `replace`ï¼Œè¿™ä¸ªæ“ä½œåœ¨æ²™ç®±åˆå§‹åŒ–æ—¶ç”± `patchIframeHistory` åšäº†æ‹¦æˆª [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)] |

é—®é¢˜ï¼š

- æ‹¦æˆªåæ‰€æœ‰é“¾æ¥è·³è½¬æ˜¯åœ¨æ²™ç®± `iframe` ä¸‹è¿›è¡Œçš„
- å‡å®š `replace` è·³è½¬åˆ°å­åº”ç”¨é¦–é¡µï¼Œæœ€ç»ˆä¼šæ›¿æ¢ `url` ä¸ºåŸºåº§é¦–é¡µ
- å¯¼è‡´æ²™ç®± `iframe` é“¾æ¥è·³è½¬åˆ°åŸºåº§é¦–é¡µï¼Œä»è€Œå¼•å‘å­åº”ç”¨çš„æ²™ç®±å»åŠ è½½åŸºåº§ï¼Œäº§ç”Ÿé—®é¢˜

å¤ç°ï¼š

- `vue-project` å­åº”ç”¨ä¸­å¤ç°äº†é—®é¢˜ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-vue3)]
- è¿è¡Œæ–¹æ³•ï¼šå¯åŠ¨å­åº”ç”¨å’ŒåŸºåº§ï¼Œé€‰æ‹© `Vue åº”ç”¨`ï¼Œç‚¹å‡»è¿›å…¥åº”ç”¨ä¸­ `about` è·¯ç”±
- ç‚¹å‡»æŒ‰é’® "replace go home" æŸ¥çœ‹é”™è¯¯æ¼”ç¤º

æ€ä¹ˆä¿®å¤ï¼š

- æ‹¦æˆª `location.replace`ï¼Œæ£€æµ‹è·³è½¬çš„é“¾æ¥æ˜¯åº”ç”¨å†…éƒ¨è·¯ç”±è¿˜æ˜¯å¤–éƒ¨é“¾æ¥
- å¤–éƒ¨é“¾æ¥é€šè¿‡ `locationHrefSet` åˆ›å»ºä¸´æ—¶çš„åŠ«æŒå®¹å™¨ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]
- åº”ç”¨å†…éƒ¨è·¯ç”±é€šè¿‡ `history.replace` è¿›è¡Œå¤„ç†ï¼Œå¦‚ä¸‹æ¼”ç¤º

```
iframeWindow.history.replaceState(null, "", args[0])
```

> å­åº”ç”¨çš„ `history` åœ¨æ²™ç®± `iframe` åˆå§‹åŒ–æ—¶å·²ç»æ‰“è¡¥ä¸äº†ï¼Œè§ï¼š`patchIframeHistory` [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)]

å…¶å®ƒæƒ…å†µï¼š

- é€šè¿‡ `getTargetValue` ç›´æ¥ä»æ²™ç®± `location` ä¸­è·å– [[æŸ¥çœ‹](#gettargetvalue-ä»å¯¹è±¡ä¸­è·å–å±æ€§)]

**`set` èµ‹å€¼**

èµ‹å€¼ä¼šç»‘å®šæ–°çš„å€¼åˆ°æ²™ç®± `location` å¯¹åº”çš„ `property` ä¸Šï¼Œä½† `href` é™¤å¤–

**`href` èµ‹å€¼æ“ä½œ**

æ–¹æ³•ï¼š

- æ‹¦æˆªæ“ä½œå¹¶é€šè¿‡ `locationHrefSet` åˆ›å»ºä¸€ä¸ªæ–°çš„ `iframe` ä»£æ›¿æ¸²æŸ“å®¹å™¨ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

ç»“æœï¼š

- ç”¨ `iframe` æ›¿æ¢å­åº”ç”¨å®¹å™¨ï¼Œå¹¶æ›´æ–°å½“å‰ `url` ä¸­å¯¹åº”çš„ `search`
- ç”±äºæ‹¦æˆªçš„å¾ˆç›´æ¥ç²—æš´ï¼Œåˆ‡æ¢ä¼šå¾ˆçªå…€ï¼Œéœ€è¦é€šè¿‡ `degradeAttrs` è¿›è¡Œé€‚é… [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]

è¿™æ„å‘³ç€å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå“ªæ€•æ²¡æœ‰è€ƒè™‘éœ€è¦ `degrade` ä¸»åŠ¨é™çº§ï¼š

- ä½†åªè¦åº”ç”¨ä¸­å­˜åœ¨ `location.href` æ›´æ–°é¡µé¢é“¾æ¥ï¼Œå°±éœ€è¦æ·»åŠ  `degradeAttrs` é…ç½®

è®¾è®¡åˆè¡·ï¼š

- å¯èƒ½å‡ºäºå•ä¾‹åº”ç”¨çš„è€ƒé‡ï¼Œæ‰€æœ‰é“¾æ¥éƒ½æ˜¯åŸºåº§çš„å­åº”ç”¨ï¼Œå“ªæ€•è·³åˆ°ç¬¬ä¸‰æ–¹é¡µé¢ä¹Ÿä¸èƒ½ç¦»å¼€åŸºåº§
- æ¯”å¦‚è¯´åå°ç®¡ç†ï¼Œå­åº”ç”¨ä¸­æœ‰ä¸ªç¬¬ä¸‰æ–¹æŸ¥å¿«é€’çš„é“¾æ¥ï¼Œé€šå¸¸æƒ…å†µå¯èƒ½å°±è·³è½¬èµ°äº†ï¼Œä½†æ˜¯åœ¨ `wujie` ä¸­ä¼šå°†å…¶ä¹Ÿä½œä¸ºå­åº”ç”¨æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹

é—®é¢˜æ˜¯ï¼š

- é€šå¸¸è·³è½¬é“¾æ¥ä¸éƒ½æ˜¯é€šè¿‡ `HTMLAnchorElement` å…ƒç´ å—ï¼Œè¿™ç§æƒ…å†µæ˜¯æ²¡æœ‰æ‹¦æˆªçš„
- æ—¢ç„¶è¿™æ ·ï¼Œé‚£ `location.href` ä¸åº”è¯¥æ˜¯è½¬å‘ç»™å…¨å±€ `location.href` èµ‹å€¼æ›´æ–°å—ï¼Ÿ

**`ownKeys` æšä¸¾æ‰€æœ‰å±æ€§**

- ä»æ²™ç®± `location` ä¸­è·å–æ‰€æœ‰ `property`ï¼Œä½†ä¸åŒ…æ‹¬è¢«å±è”½çš„ `reload`

**`getOwnPropertyDescriptor` è·å–æè¿°ä¿¡æ¯**

è¿”å›ä¿¡æ¯åŒ…å«æœ‰ï¼š

- `enumerable`ï¼šå¯æšä¸¾
- `configurable`ï¼šå¯é…ç½®
- `writable`ï¼šä¸å¯å†™ï¼Œè‡ªåŠ¨è¡¥å…¨
- `value`ï¼šå¾ˆæœ‰å¯èƒ½æ‹¿åˆ° `undefined`

å…³äº `value` çš„ `bug`ï¼š

- è¿™é‡Œé€šè¿‡ `this` å–å€¼ï¼Œè€Œ `this` æ˜¯ `_fakeLocation` ç©ºå¯¹è±¡ï¼Œæ‰€ä»¥æœ‰å¯èƒ½æ˜¯ `undefined`
- å½“ç„¶ç©ºå¯¹è±¡ä¹Ÿæœ‰åŸå‹é“¾ï¼Œä¾‹å¦‚ï¼š`toString` æ˜¯å¯ä»¥æ‹¿åˆ°çš„ï¼Œä½†è¿™å°±å’Œ `location` æ— å…³äº†

#### ğŸ“ `localGenerator` é™çº§æƒ…å†µä¸‹çš„ä»£ç†

é™çº§æƒ…å†µä¸‹ `document`ã€`location` çš„ä»£ç†ï¼Œ`window` é‡‡ç”¨æ²™ç®± `window`ï¼Œä¹Ÿä¸éœ€è¦åŒ…è£¹ `script module`ï¼Œç›´æ¥ä½¿ç”¨æ²™ç®± `iframe` åšéš”ç¦»ï¼Œè§ï¼šæµç¨‹å›¾ [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

ç›®å½•ï¼š`proxy.ts` - `localGenerator` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/proxy.ts#L261)]

å‚æ•°ï¼š

- `iframe`ï¼šæ²™ç®± `iframe`
- `urlElement`ï¼šå°†å­åº”ç”¨å…¥å£é“¾æ¥é€šè¿‡ `appRouteParse` è½¬æ¢æˆ `HTMLAnchorElement` å¯¹è±¡ [[æŸ¥çœ‹](#approuteparse-æå–é“¾æ¥)]
- `mainHostPath`ï¼šåŸºåº§ `origin`
- `appHostPath`ï¼šå­åº”ç”¨ `origin`

è¿”å› 1 å¯¹è±¡ï¼ŒåŒ…å« 2 ä¸ªå±æ€§ï¼š

- `proxyDocument`ï¼šä»£ç†ç©ºå¯¹è±¡ï¼Œä½†æ˜¯ä¼šä»æ¸²æŸ“å®¹å™¨å’Œå…¨å±€ `document` ä¸­è·å–å±æ€§
- `proxyLocation`ï¼šä»£ç†ç©ºå¯¹è±¡ï¼Œä½†æ˜¯ä¼šä»æ²™ç®± `location` å’Œå­åº”ç”¨å…¥å£é“¾æ¥è·å–å±æ€§

#### 1. åŠ«æŒç©ºå¯¹è±¡ä½œä¸º `proxyDocument`

å’Œ `proxyGenerator` ç›¸åŒï¼Œè§ï¼š`proxyGenerator` - `proxyDocument` [[æŸ¥çœ‹](#2-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxydocument)]

- åˆ›å»ºå…ƒç´ å’Œæ–‡æœ¬ï¼š`createElement`ã€`createTextNode`
- ä»£ç† `documentURI` å’Œ `URL`
- `getElementsByTagName`ï¼šé€šè¿‡æ ‡ç­¾è·å–å…ƒç´ é›†åˆï¼ŒåŒ…å«è·å– `script` é›†åˆ
- `getElementById`ï¼šé€šè¿‡ `id` è·å–å…ƒç´ ï¼Œå…ˆå®¹å™¨å†æ²™ç®±

å’Œ `proxyGenerator` ä¸åŒï¼š

- `proxyGenerator` é€šè¿‡ `Proxy` æ‹¦æˆªå¯¹è±¡åšä»£ç†
- `locationHrefSet` é€šè¿‡ `Object.defineProperties` åŠ«æŒç©ºå¯¹è±¡åšä»£ç†
- `documentProxyProperties` å¤„ç†æ–¹å¼ä¸åŒ

> å…³äº `documentProxyProperties`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L42)]

ä¸ºä»€ä¹ˆé™çº§åä»£ç†é‡‡ç”¨ `Object.defineProperties`ï¼š

- å› ä¸º `Proxy` ä¸å…¼å®¹ `IE`

`documentProxyProperties` çš„å¤„ç†ï¼š

- éå†é›†åˆä¸­çš„å±æ€§ï¼ŒåŠ«æŒå®¹å™¨ `document` ä¸­å¯¹åº”çš„å±æ€§
- å¦‚æœæ˜¯å¯æ‰§è¡Œçš„æ–¹æ³•ï¼Œç»‘å®š `this` ä¸ºå®¹å™¨ `document` å¹¶è¿”å›ï¼Œå¦åˆ™ç›´æ¥è¿”å›å±æ€§

å®¹å™¨ä¸­æ‰€æœ‰çš„å…ƒç´ é€šè¿‡ `patchElementEffect` å°† `ownerDocument` æŒ‡å‘æ²™ç®± `document` [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]ï¼š

- æ‰€ä»¥æ— è®ºæ˜¯ `documentProxyProperties` åŒ…å«çš„å±æ€§ï¼Œè¿˜æ˜¯ä¸éœ€è¦è€ƒè™‘çš„å±æ€§ï¼Œéƒ½å¯ä»¥ç›´æ¥ä»å®¹å™¨ `document` ä¸­è·å–ï¼Œå› ä¸ºåœ¨æ­¤ä¹‹å‰ï¼Œå®ƒä»¬çš„ `ownerDocument` å·²æŒ‡å‘æ²™ç®± `iframe.contentDocument`

#### 2. åŠ«æŒç©ºå¯¹è±¡ä½œä¸º `proxyLocation`

å’Œ `proxyGenerator` ç›¸åŒï¼Œè§ï¼š`proxyGenerator` - `proxyLocation` [[æŸ¥çœ‹](#3-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxylocation)]

- ä»å­åº”ç”¨å…¥å£é“¾æ¥è·å–ä¿¡æ¯ï¼š`host`ã€`hostname`ã€`protocol`ã€`port`ã€`origin`
- è·å– `href`ï¼šç”¨ä¸»åº”ç”¨çš„ `origin` æ›¿æ¢ä¸ºå­åº”ç”¨çš„ `origin`
- è®¾ç½® `href`ï¼šä¼šé€šè¿‡ `locationHrefSet` åˆ›å»ºä¸€ä¸ªæ–°çš„ `iframe` ä»£æ›¿åº”ç”¨å®¹å™¨ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]
- å±è”½ `reload`ï¼Œå½“ç„¶å±è”½å¯¼è‡´çš„é—®é¢˜ä¹Ÿä¸€æ ·ï¼Œè§ï¼š`proxyGenerator` - `proxyLocation` [[æŸ¥çœ‹](#3-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxylocation)]
- éå† `location` å±æ€§ç»‘å®šåœ¨ `proxyLocation`ï¼Œå¦‚æœæ˜¯ `isCallable` æ–¹æ³•ï¼Œç»‘å®š `this` ä¸ºæ²™ç®±çš„ `location` [[æŸ¥çœ‹](#iscallableåˆ¤æ–­å¯¹è±¡æ˜¯ä¸€ä¸ªå‡½æ•°)]

å’Œ `proxyGenerator` ä¸åŒï¼š

- ä¸æ‹¦æˆª `replace`ï¼Œä¹Ÿä¸å­˜åœ¨ `replace` å¸¦æ¥çš„é—®é¢˜ï¼Œè§ï¼š`proxyGenerator` - `proxyLocation` [[æŸ¥çœ‹](#3-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxylocation)]
- å› ä¸º `location` æ–¹æ³•å¹¶æ²¡æœ‰ `window` é‚£ä¹ˆå¤šï¼Œä¸éœ€è¦é€šè¿‡ `setFnCacheMap` ç¼“å­˜ç»‘å®šçš„æ–¹æ³• [[æŸ¥çœ‹](#1-setfncachemap-å­˜å‚¨ç»‘å®šä¸Šä¸‹æ–‡çš„æ–¹æ³•)]
- é™çº§åçš„ `proxyLocation` ä¸ä¼šæ†ç»‘åœ¨å­åº”ç”¨ä¸­ï¼Œè§ï¼š`proxyLocation` çš„é—®é¢˜ [[æŸ¥çœ‹](#proxylocation-çš„é—®é¢˜)]

#### ğŸ“ æ€»ç»“

#### `proxyWindow` åœ¨å“ªè°ƒç”¨

ä»…åœ¨ `insertScriptToIframe` æ³¨å…¥ `script` åˆ°æ²™ç®± `iframe` æ—¶ï¼ŒåŒ…è£¹æ¨¡å—ç”¨åˆ° [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

- `degrade` é™çº§ã€å¤–è” `script`ã€`script module` ä¸åŒ…è£¹æ¨¡å—ï¼Œä¸æä¾› `proxyWindow`

é‚£ `degrade` é™çº§æ—¶çœŸçš„ä¸éœ€è¦ä»£ç† `window` å—ï¼Ÿ

- å¹¶ä¸æ˜¯ï¼Œè‡³å°‘ `location` å°±ä¸æ˜¯
- é™çº§å `iframe` çš„ `location` å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿè§ï¼š`proxyLocation` çš„é—®é¢˜ [[æŸ¥çœ‹](#proxylocation-çš„é—®é¢˜)]

ä»¥ä¸‹å±æ€§åœ¨é™çº§æƒ…å†µçš„ç¡®ä¸ç”¨ `proxyWindow`ï¼š

| å±æ€§     | éé™çº§æ¨¡å¼                                            | `degrade` é™çº§ |
| -------- | ----------------------------------------------------- | -------------- |
| `self`   | `proxyWindow`                                         | æ²™ç®± `window`  |
| `window` | å…¨å±€ `window` æè¿°ä¿¡æ¯å­˜åœ¨ `get` å±æ€§ä¸º `proxyWindow` | æ²™ç®± `window`  |

ä»¥ä¸‹å±æ€§æ— è®ºé™ä¸é™çº§éƒ½ä»æ²™ç®± `window` ä¸­è·å–ï¼š

- å…¨å±€ `window` æè¿°ä¿¡æ¯ä¸å­˜åœ¨ `get` å±æ€§
- `__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__`ã€`__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__`
- ä¸å¯é…ç½®ä¸å¯é‡å†™çš„å±æ€§
- é€šè¿‡ `getTargetValue` ä»æ²™ç®± `window` è·å–å±æ€§ [[æŸ¥çœ‹](#gettargetvalue-ä»å¯¹è±¡ä¸­è·å–å±æ€§)]

ä¸ºä»€ä¹ˆé™çº§åå®¹å™¨ `iframe` çš„ `window` ä»æ²™ç®± `iframe` ä¸­è·å–ï¼š

- å› ä¸º `script` æ˜¯æ³¨å…¥å¹¶è¿è¡Œåœ¨æ²™ç®± `iframe` ä¸­

#### `proxyDocument` åœ¨å“ªè°ƒç”¨

æ¥è‡ªæ²™ç®± `document` æ‰“è¡¥ä¸æœ‰ 2 å¤„ï¼Œè§ï¼š`patchDocumentEffect` [[æŸ¥çœ‹](#patchdocumenteffectä¿®æ­£æ²™ç®±-document-çš„-effect)]

- éå† `documentProxyProperties` é›†åˆï¼ŒåŠ«æŒæ²™ç®± `document` å±æ€§ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L510)]
- åŠ«æŒæ²™ç®± `body`ã€`head`ï¼Œä» `proxyDocument` é‡Œè¿”å› `Dom` å…ƒç´ ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L545)]

åœ¨ `patchDocumentEffect` æ‰“è¡¥ä¸æ—¶å¦‚ä½•æŒ‡å‘ `proxyDocument`ï¼š

- éå† `documentProxyProperties` åŒ¹é… `documet` çš„å±æ€§é›†åˆ
- æ¯ä¸€é¡¹é€šè¿‡ `Object.defineProperty` åŠ«æŒ `iframeWindow.Document.prototype` ä¸Šå¯¹åº”çš„å±æ€§
- å°†å…¶ `get` æ“ä½œæŒ‡å‘ `proxyDocument` ä¸­å¯¹åº”çš„å±æ€§

åœ¨ `proxyDocument` æ”¶åˆ°è¯·æ±‚åæ€ä¹ˆå¤„ç†ï¼š

- æŒ‰ç…§ `get` çš„å±æ€§è¿”å›ç›¸åº”å¯¹è±¡ï¼Œå‚è€ƒï¼šä»£ç†ç©ºå¯¹è±¡ä½œä¸º `proxyDocument` [[æŸ¥çœ‹](#2-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxydocument)]

å…³äº `documentProxyProperties` é›†åˆï¼š

- é›†åˆä¸­æ¶µç›–äº† `document` éœ€è¦åŠ«æŒçš„å±æ€§ï¼ŒåŒ…æ‹¬ `createElement`ã€`createTextNode` ç­‰éœ€è¦åŠ«æŒè¿‡ç¨‹ä¸­ç‰¹æ®Šå¤„ç†çš„å±æ€§
- åœ¨ `Proxy` çš„ `get` ä¸­ä¼šå…ˆåŒ¹é…å¤„ç†ç‰¹æ®ŠæŒ‡å®šçš„å±æ€§ï¼Œå°†å…¶ç»“æœè¿”å›
- ç„¶åå†éå† `documentProxyProperties` æ‰¹é‡å®šä¹‰çš„å±æ€§è¿›è¡Œå¤„ç†ï¼Œé¿å…å› å†²çªè¦†ç›–å·²å¤„ç†çš„ä»£ç†å±æ€§

> å¯¹äºé™çº§çš„ `proxyDocument` åˆ™é€šè¿‡ `modifyLocalProperties` æ’é™¤å·²å®šä¹‰çš„ç‰¹æ®Šå±æ€§ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/proxy.ts#L335)]

#### `proxyLocation` åœ¨å“ªé‡Œè°ƒç”¨

| è°ƒç”¨åœºæ™¯                                                                        | æ¨¡å¼   | ç”¨é€”                                       |
| ------------------------------------------------------------------------------- | ------ | ------------------------------------------ |
| `getCurUrl` å¿…è¦å‚æ•°                                                            | é€šç”¨   | è·å–åº”ç”¨çš„ `url` ä¼ é€’ç»™ `loader` æ’ä»¶      |
| `patchElementEffect` ç»™åº”ç”¨å…ƒç´ æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)] | é€šç”¨   | è®©å…ƒç´  `baseURI` é€šè¿‡ `proxyLocation` è·å– |
| `proxyDocument` [[æŸ¥çœ‹](#2-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxydocument)]                       | é€šç”¨   | ä»£ç†ä¸­å±æ€§ `documentURI`ã€`URL` çš„æŒ‡å‘     |
| `proxyWindow` [[æŸ¥çœ‹](#1-ä»£ç†æ²™ç®±-window-ä½œä¸º-proxywindow)]                     | éé™çº§ | ä»£ç†ä¸­å±æ€§ `location` çš„æŒ‡å‘               |
| `insertScriptToIframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]         | éé™çº§ | åŒ…è£¹æ³¨å…¥æ²™ç®±çš„ `script` ä½œä¸º `location`    |

> å…¶ä¸­ `getCurUrl` å’Œ `patchElementEffect` ä¸­çš„ `baseURI` çš„æ“ä½œæ–¹å¼ä¸€æ¨¡ä¸€æ ·ï¼Œè§ï¼šé‡å¤æå–æ ·å¼çš„ `bug` [[æŸ¥çœ‹](#2-é‡å¤æå–æ ·å¼çš„-bug)]

#### `proxyLocation` çš„é—®é¢˜

é—®é¢˜ 1ï¼šåœ¨ `wujie` å­åº”ç”¨ä¸­è°¨æ…ä½¿ç”¨ `location`

- å¦‚æœæ˜¯å–å€¼é‚£ä¹ˆåœ¨ `shadowRoot` ä¸­æ­£å¸¸ï¼Œå¦‚æœè¦è·³è½¬ã€æ›´æ–° `location` å»ºè®®ä½¿ç”¨ `history`
- å¦åˆ™å¯èƒ½ä¼šå› ä¸º `location.replace` æˆ–è€…æ›´æ–° `location.href` é€ æˆæ„å¤–çš„ç»“æœ

é—®é¢˜ 2ï¼šåœ¨é™çº§æ¨¡å¼ä¸‹çš„ `location` å’Œéé™çº§æ¨¡å¼ä¸‹ä¸ä¸€è‡´

é™çº§æ¨¡å¼ä¸‹å­åº”ç”¨å’ŒåŸºåº§çš„ `location` ä¹Ÿä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹æ¯”å¦‚ä¸‹ï¼š

| åˆ†ç±»        | éé™çº§æ¨¡å¼             | `degrade` å­åº”ç”¨     | `degrade` åŸºåº§  |
| ----------- | ---------------------- | -------------------- | --------------- |
| `location`  | `proxyLocation`        | æ²™ç®± `location`      | `proxyLocation` |
| `url` è·å–  | å­åº”ç”¨å…¥å£é“¾æ¥         | `host` å’ŒåŸºåº§åŒåŸŸ    | å­åº”ç”¨å…¥å£é“¾æ¥  |
| `host`      | å­åº”ç”¨                 | åŸºåº§åŒåŸŸ             | å­åº”ç”¨          |
| `reload`    | å±è”½                   | ä¸å±è”½               | å±è”½            |
| `href` æ›´æ–° | åˆ›å»º `iframe` ä»£æ›¿å®¹å™¨ | åœ¨æ²™ç®± `iframe` è·³è½¬ | ç›®å‰ç”¨ä¸åˆ°      |
| `replace`   | æ›¿æ¢ç»å¯¹è·¯å¾„å’ŒåŸºåº§åŒåŸŸ | ä¸åšä»»ä½•å¤„ç†         | ç›®å‰ç”¨ä¸åˆ°      |

> åŸå› å‚è€ƒï¼š`proxyLocation` åœ¨å“ªé‡Œè°ƒç”¨ [[æŸ¥çœ‹](#proxylocation-åœ¨å“ªé‡Œè°ƒç”¨)]

è¦æ€ä¹ˆä¿®å¤ï¼š

- æˆ‘çš„æƒ³æ³•æ˜¯åœ¨ `proxyWindow` åŠ«æŒ `location` æŒ‡å‘ `proxyLocation`
- ä½†æ˜¯é™çº§åçš„ `iframe` å®¹å™¨ä½¿ç”¨çš„æ˜¯æ²™ç®± `window`ï¼Œè€Œä¸æ˜¯ `proxyWindow`
- è¿™æ ·å°±éœ€è¦ä» `patchWindowEffect` ç€æ‰‹æ‰“è¡¥ä¸äº† [[æŸ¥çœ‹](#patchwindoweffectä¿®æ­£-iframewindow-çš„-effect)]

é€šè¿‡ `getOwnPropertyNames` æ‰“è¡¥ä¸ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L231)]

```
const { degrade, proxyLocation } = iframeWindow__WUJIE;
Object.getOwnPropertyNames(iframeWindow).forEach((key) => {
  // æ–°å¢è¡¥ä¸
  if (key === "location" && degrade) {
    Object.defineProperty(iframeWindow, key, {
      get: () => proxyLocation,
    });
  }
});
```

> å¦‚æœå­˜åœ¨é™çº§ï¼Œé€šè¿‡ `Object.defineProperty` åŠ«æŒå¹¶æŒ‡å‘ `proxyLocation`

å¤ç°é—®é¢˜ï¼š

- åœ¨åŸºåº§ä¸­æ‰¾åˆ°ï¼š`/src/pages/VuePage.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/VuePage.tsx)]
- åœ¨ç»„å»ºä¸­æ·»åŠ  `degrade` å±æ€§ï¼Œè¿è¡Œåˆ‡æ¢åˆ° `vue` åº”ç”¨ï¼Œç‚¹å‡» `about` åˆ‡æ¢åˆ°é¡µé¢
- è¿™ä¸ªæ—¶å€™çœ‹åˆ°æ‹¿åˆ°çš„ `url` æ˜¯ `http://localhost:3000/about`
- å•ç‹¬æ‰“å¼€å­åº”ç”¨æ‹¿åˆ°çš„ `url` æ˜¯ `http://localhost:8080/about`
- å»æ‰ `degrade` æ‹¿åˆ°çš„ `url` æ˜¯ `http://localhost:8080/about`

#### ğŸ“ ä»£ç†ä¸­çš„è¾…åŠ©æ–¹æ³•

#### `locationHrefSet`ï¼šæ‹¦æˆªå­åº”ç”¨ `location.href`

ç›®å½•ï¼š`proxy.ts` - `locationHrefSet` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/proxy.ts#L19)]

å‚æ•°ï¼š

- `iframe`ï¼šæ²™ç®± `iframe`
- `value`ï¼šæ‹¦æˆª `location.href` æ›´æ–°çš„é“¾æ¥ï¼Œæ— è®ºç›¸å¯¹é“¾æ¥è¿˜æ˜¯ç»å¯¹é“¾æ¥ï¼Œä¹Ÿå¯ä»¥æ˜¯ç¬¬ä¸‰æ–¹é“¾æ¥
- `appHostPath`ï¼šå­åº”ç”¨ `origin`

ç›®çš„ï¼š

- åˆ›å»º `iframe` åŠ è½½æ‹¦æˆªçš„é“¾æ¥ï¼ŒæŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ï¼Œç”¨æ¥ä»£æ›¿å½“å‰æ¸²æŸ“å®¹å™¨

**æ“ä½œæµç¨‹**

ä»å®ä¾‹ä¸­æå–ä»¥ä¸‹å¯¹è±¡ï¼š

- æ¸²æŸ“å®¹å™¨ï¼š`shadowRoot`ã€`document`ï¼Œæ ¹æ® `degrade` å†³å®šè¦æ›¿æ¢çš„å®¹å™¨
- `id`ï¼Œç”¨å¤„ 1ï¼šé™çº§æ—¶ä» `Dom` ä¸­æ‰¾åˆ° `iframe` å®¹å™¨ï¼Œç”¨å¤„ 2ï¼šæ›´æ–°é“¾æ¥ï¼Œä» `search` æ‰¾åˆ°å½“å‰åº”ç”¨
- `degradeAttrs`ï¼šæ¥è‡ªå¯åŠ¨é…ç½®ï¼Œç”¨äºåŠ«æŒå®¹å™¨èƒ½å¤Ÿé€‚é…é¡µé¢
- `url`ï¼šé€šå¸¸æƒ…å†µä¸‹æ˜¯ `location.href` æ›´æ–°çš„é“¾æ¥ï¼Œä½†æ˜¯ç›¸å¯¹è·¯å¾„éœ€è¦è½¬æ¢ä¸€ä¸‹

è½¬æ¢ç›¸å¯¹è·¯å¾„ï¼š

- é€šè¿‡ `anchorElementGenerator` å°†é“¾æ¥è½¬æ¢æˆ `HTMLAnchorElement` å¯¹è±¡ [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]
- æå– `appHostPath` å­åº”ç”¨ `origin` + æä¾›é“¾æ¥çš„ `pathname` + `search` + `hash` ä½œä¸º `url`

æ‰§è¡Œæ›¿æ¢æœ‰ 3 æ­¥ï¼š

- æ ‡è®° `hrefFlag` ä»¥ä¾¿ç‚¹å‡»åé€€æ—¶è¿˜åŸæ¸²æŸ“å®¹å™¨
- æ›¿æ¢æ¸²æŸ“å®¹å™¨ä¸ºæ–°å»ºçš„ `iframe`
- `pushUrlToWindow` æ¨é€æŒ‡å®š `url` åˆ°ä¸»åº”ç”¨è·¯ç”± [[æŸ¥çœ‹](#pushurltowindowæ¨é€-url-åˆ°åŸºåº§è·¯ç”±)]

è‹¥æ˜¯ `degrade` ä¸»åŠ¨é™çº§ï¼Œæ›¿æ¢ `iframe` å®¹å™¨ï¼š

- é€šè¿‡ `rawDocumentQuerySelector` ï¼ˆåŸç”Ÿæ–¹æ³•ï¼‰ï¼Œæ‹¿åˆ°æ²™ç®± `body`
- é€šè¿‡ `renderElementToContainer` å°†æ¸²æŸ“å®¹å™¨ä¸­çš„ `html` å…ƒç´ æ·»åŠ åˆ°æ²™ç®± `body` ä¸­ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]
- é€šè¿‡ `renderIframeReplaceApp` åˆ›å»ºæ–°çš„ `iframe` æ›¿æ¢æ¸²æŸ“å®¹å™¨ [[æŸ¥çœ‹](#renderiframereplaceappåŠ è½½-iframe-æ›¿æ¢å­åº”ç”¨)]

é `degrade` é™çº§åˆ™æ›¿æ¢ `shadowRoot`ï¼š

- é€šè¿‡ `renderIframeReplaceApp` åˆ›å»ºæ–°çš„ `iframe` æ›¿æ¢æ¸²æŸ“å®¹å™¨ [[æŸ¥çœ‹](#renderiframereplaceappåŠ è½½-iframe-æ›¿æ¢å­åº”ç”¨)]

**å­˜åœ¨çš„ `bug`**

ä»¥ä¸Šæè¿°ä»…åœ¨æ­£å¸¸æƒ…å†µï¼Œä¸å·§ `locationHrefSet` ä¹Ÿæœ‰ `bug`ï¼š

- å› ä¸ºé™çº§æ¨¡å¼ä¸‹ä¸ä½¿ç”¨ `proxyLocation` [[æŸ¥çœ‹](#proxylocation-çš„é—®é¢˜)]
- å› æ­¤ä¹Ÿä¸ä¼šæ‹¦æˆª `location.href` çš„æ›´æ–°ï¼Œå¯¼è‡´åœ¨ `iframe` å®¹å™¨ä¸­å¹¶ä¸ä¼šå› æ­¤åˆ›å»ºåŠ«æŒå®¹å™¨

å¤ç°å’Œä¿®å¤ï¼š

- å’Œ `proxyLocation` è§£å†³æ–¹æ³•ä¸€è‡´ï¼Œè§ï¼š`proxyLocation` çš„é—®é¢˜ [[æŸ¥çœ‹](#proxylocation-çš„é—®é¢˜)]

#### `pushUrlToWindow`ï¼šæ¨é€ `url` åˆ°åŸºåº§è·¯ç”±

ç›®å½•ï¼š`sync.ts` - `pushUrlToWindow` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sync.ts#L98)]

å‚æ•°ï¼š

- `id`ï¼šåº”ç”¨å
- `url`ï¼šè·³è½¬çš„é“¾æ¥ï¼Œæ¥è‡ª `locationHrefSet` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

è°ƒç”¨åœºæ™¯ï¼š

- åªæœ‰ `locationHrefSet` æ‹¦æˆªå­åº”ç”¨ `location.href`
- ä¹Ÿè¯´æ˜ç›‘å¬ `popstate` æ—¶æ£€æµ‹å‰è¿›çš„é¡µé¢ï¼Œåªèƒ½æ¥è‡ª `pushUrlToWindow` æ¨é€çš„æ›´æ–° [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

æµç¨‹ï¼š

- é€šè¿‡ `anchorElementGenerator` æ‹¿åˆ° `HTMLAnchorElement` å¯¹è±¡ [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]
- é€šè¿‡ `getAnchorElementQueryMap` æ‹¿åˆ° `search` çš„é”®å€¼å¯¹ [[æŸ¥çœ‹](#getanchorelementquerymap-è½¬åŒ–-urlsearch-ä¸ºé”®å€¼å¯¹è±¡)]
- æ ¹æ®å½“å‰åº”ç”¨å `id` å°†å€¼æ›´æ–°ä¸º `encodeURIComponent` çš„ `url`
- å°†æ›´æ–°åçš„é”®å€¼å¯¹è¿˜åŸæˆå­—ç¬¦æ›´æ–° `url.searh`
- é€šè¿‡ `window.history.pushState` æ›´æ–°è®°å½•ï¼Œä»¥ä¾¿æµè§ˆå™¨å›é€€è¿˜åŸå®¹å™¨

### è¾…åŠ©æ–¹æ³• - æå–åº”ç”¨èµ„æº

å›´ç»•æå–åº”ç”¨èµ„æºå½’çº³ç›¸å…³çš„æ–¹æ³•

#### `importHTML` åŠ è½½èµ„æº

åŠ è½½åº”ç”¨èµ„æºã€æå–èµ„æºçš„æ–¹æ³•

ç›®å½•ï¼š`entry.ts` - `importHTML` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L200)]

ç”¨äºåŠ è½½å’Œå¤„ç†èµ„æºå†…å®¹ï¼Œç›¸å½“äºï¼š

- `qiankun` çš„ `importEntry` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-qiankun-substrate?tab=readme-ov-file#212-prefetch-%E6%89%A7%E8%A1%8C%E9%A2%84%E5%8A%A0%E8%BD%BD)]
- `micro-app` çš„ `HTMLLoader` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#12-htmlloader-%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90)]

> é™¤äº† `qiankun` ä½¿ç”¨çš„æ˜¯ `import-html-entry`ï¼Œå…¶å®ƒéƒ½æ˜¯å•ç‹¬å¼€å‘çš„ [[æŸ¥çœ‹](https://github.com/kuitos/import-html-entry)]

å‚æ•°ä¸ºåŒ…å« 3 ä¸ªå±æ€§çš„ `params` å¯¹è±¡ï¼š

- `url`ï¼šèµ„æºè¿æ¥
- `html`ï¼šé™æ€èµ„æºï¼Œæä¾›åˆ™ä¼˜å…ˆä½¿ç”¨
- `opts`ï¼šåŒ…å«åŠ è½½å’Œå¤„ç† `HTML` çš„ç›¸å…³é…ç½®

`opts` åŒ…å« 4 ä¸ªå¯é€‰å±æ€§ï¼š

- `fetch`ï¼šè‡ªå®šä¹‰çš„ `fetch`ï¼Œæ²¡æœ‰æä¾›åˆ™ä½¿ç”¨å…¨å±€ `window` æä¾›çš„ `fetch`
- `plugins`ï¼šåº”æ’ä»¶ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#plugins)]
- `loadError`ï¼šåº”ç”¨åŠ è½½èµ„æºå¤±è´¥åè§¦å‘ï¼Œ`startApp` æ—¶é…ç½®
- `fiber`ï¼šç©ºé—²åŠ è½½ï¼Œé»˜è®¤ä¸º `true`

> åœ¨ `importHTML` ä¸­ä¼šç”¨åˆ°çš„ `plugins` è§ä¸‹é¢æ€»ç»“ï¼š1. æå–å¿…è¦çš„é…ç½®

ç”±äº `importHTML` ä¸­åªèƒ½é€šè¿‡ `processTpl` æå–é™æ€èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

- å› æ­¤ä¸Šè¿° `plugins` æåˆ°çš„å¤–è” `script` å’Œå¤–è”æ ·å¼ä¹Ÿéƒ½æ˜¯é™æ€èµ„æº

æœ€ç»ˆè¿”å› `Promise<htmlParseResult>`ï¼Œå…¶ä¸­ `htmlParseResult` åŒ…å«ï¼š

- `template`ï¼šå¤„ç†åçš„èµ„æºå†…å®¹
- `assetPublicPath`ï¼šèµ„æºè·¯å¾„ï¼Œè§ï¼š`defaultGetPublicPath` [[æŸ¥çœ‹](#defaultgetpublicpathè·å–èµ„æºé“¾æ¥çš„-path)]
- `getExternalScripts`ï¼šåŠ è½½åº”ç”¨ä¸­é™æ€ `script` çš„åŒ…è£…æ–¹æ³• [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- `getExternalStyleSheets`ï¼šåŠ è½½åº”ç”¨ä¸­é™æ€æ ·å¼çš„åŒ…è£…æ–¹æ³• [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]

> è¿”å›çš„ `Promise` ä¼šæ ¹æ® `plugins` æ˜¯å¦ä¸å­˜åœ¨ `htmlLoader` æ¥ç¼“å­˜ç»“æœï¼Œè§ï¼šèµ„æºç¼“å­˜é›†åˆ [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]

è°ƒç”¨åœºæ™¯æœ‰ 3 å¤„ï¼š

- `preloadApp` é¢„åŠ è½½ [[æŸ¥çœ‹](#3-é¢„åŠ è½½å¾®ä»»åŠ¡-runpreload)]
- `startApp` åˆæ¬¡åŠ è½½æ²™ç®±å®ä¾‹ [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)]
- `alive` æ¨¡å¼åº”ç”¨é¢„åŠ è½½å `startApp` ä¼šå†æ¬¡æå–èµ„æº [[æŸ¥çœ‹](#21-alive-ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨)]

é¢„åŠ è½½åä¼šé‡å¤æ‰§è¡Œï¼ˆæ‰§è¡Œé¡ºåºä»ä¸Šè‡³ä¸‹ï¼‰ï¼š

| é¢„åŠ è½½æµç¨‹                                                                                                      | `alive` æ¨¡å¼                                                                       | é‡å»ºæ¨¡å¼                                            |
| --------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------- | --------------------------------------------------- |
| å£°æ˜å®ä¾‹ `WuJie` [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]                                                               | â æ˜ å°„åœ¨ `idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)] | âœ…                                                  |
| è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `beforeLoad`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/lifecycle.html#beforeload)] | âœ…                                                                                 | âœ…                                                  |
| åŠ è½½èµ„æº `importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]                                                            | â å­˜å‚¨åœ¨å®ä¾‹ `template` [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]                             | âœ…                                                  |
| æå–èµ„æº `processTpl` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]                                                            | â å­˜å‚¨åœ¨å®ä¾‹ `template` [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]                             | âœ…                                                  |
| å¤„ç†æ ·å¼ `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]                                          | â å­˜å‚¨åœ¨å®ä¾‹ `template` [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]                             | âœ…                                                  |
| æ¿€æ´»åº”ç”¨ `active` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]                                                                   | âœ…                                                                                 | âœ…                                                  |
| `getExternalScripts` åŠ è½½ `script` [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]                                | âœ… é€šè¿‡ `start` å†æ¬¡è·å– [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]                                | âœ… é€šè¿‡ `start` å†æ¬¡è·å– [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)] |

- é¢„åŠ è½½æœ€åä¼šé€šè¿‡ `getExternalScripts` æå‰è·å– `script` [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- é¢„æ‰§è¡Œåˆ™æ˜¯å°† `getExternalScripts` ä¼ å…¥ `start` æå‰è·å– `script` å¹¶æ³¨å…¥æ²™ç®± [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

`umd` é¢„æ‰§è¡Œåå¯åŠ¨å’Œ `alive` æµç¨‹ä¸€æ ·çš„ï¼Œä¸åŒåœ¨äºï¼š

- ä¸é‡å¤è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `beforeLoad`ï¼Œä¸é‡å¤è°ƒç”¨ `start` å¯åŠ¨åº”ç”¨
- è€Œæ˜¯é€šè¿‡ `mount` å‘èµ·æŒ‚è½½ [[æŸ¥çœ‹](#22-umd-æ¨¡å¼åˆ‡æ¢åº”ç”¨)]

> ç„¶è€Œ `umd` é¢„æ‰§è¡Œæ—¶é€šè¿‡ `start` å·²å‘èµ·äº† `mount`ï¼Œæ‰€ä»¥ `startApp` æ—¶éœ€è¦å…ˆ `unmount` åå†æ¬¡ `mount`

ä»¥ä¸Šé‡å¤æ‰§è¡Œçš„æµç¨‹ä¸­ï¼Œèµ„æºä¼šåœ¨é¦–æ¬¡åŠ è½½æ—¶å­˜å…¥ç¼“å­˜

- ä¹‹åé‡å¤è°ƒç”¨å°†ä¼šä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œè§ï¼šèµ„æºç¼“å­˜é›†åˆ [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]

**1. æå–å¿…è¦çš„é…ç½®**

- ä» `opts` æå–ï¼š`fetch`ã€`fiber`ã€`plugins`ã€`loadError`ï¼Œè§ä¸Šè¿°æ€»ç»“
- `htmlLoader`ï¼šä½œä¸ºæ›¿æ¢èµ„æºå…¥å£ `template` çš„æ–¹æ³•ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#html-loader)]
- é€šè¿‡ `getEffectLoaders` æå– `plugins`
- å£°æ˜ä¸€ä¸ªèµ„æºè·¯å¾„è®¡ç®—å‡½æ•° `getPublicPath`ï¼Œè§ï¼š`defaultGetPublicPath` [[æŸ¥çœ‹](#defaultgetpublicpathè·å–èµ„æºé“¾æ¥çš„-path)]

`htmlLoader` å£°æ˜è§„åˆ™ï¼š

- æä¾› `plugin` ä½†ä¸æä¾› `htmlLoader`ï¼Œé€šè¿‡ `compose` è·å–çš„å‡½æ•°ï¼Œç›´æ¥è¿”å›ä¼ å…¥çš„èµ„æº [[æŸ¥çœ‹](#compose-ç”¨æŸ¯é‡ŒåŒ–çš„æ–¹å¼æ‹å¹³ä¸€ç»„å‡½æ•°)]
- é€šè¿‡ `plugin` æä¾› `htmlLoader`ï¼Œé€šè¿‡ `compose` ä¾æ¬¡ä½¿ç”¨è‡ªå®šä¹‰çš„ `htmlLoader` æ›¿æ¢èµ„æº [[æŸ¥çœ‹](#compose-ç”¨æŸ¯é‡ŒåŒ–çš„æ–¹å¼æ‹å¹³ä¸€ç»„å‡½æ•°)]
- ä¸æä¾› `plugins` ä½¿ç”¨ `defaultGetTemplate` ç›´æ¥è¿”å›ä¼ å…¥çš„èµ„æº

`getEffectLoaders` æå–çš„ `plugins` åŒ…å«ï¼š

- `jsExcludes`ï¼šå¤–è” `script` æ’é™¤åˆ—è¡¨ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-excludes)]
- `cssExcludes`ï¼šå¤–è”æ ·å¼æ’é™¤åˆ—è¡¨ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-excludes)]
- `jsIgnores`ï¼šå¤–è” `script` å¿½ç•¥åˆ—è¡¨ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-ignores)]
- `cssIgnores`ï¼šå¤–è”æ ·å¼å¿½ç•¥åˆ—è¡¨ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-ignores)]

> `getEffectLoaders` æå–çš„èµ„æºé€šè¿‡ `reduce` æœ€ç»ˆæ‹·è´è¿”å›ä¸€ä¸ªæ–°çš„ `Array<string | RegExp>` å¯¹è±¡

é€šè¿‡ `ignore` åŒ¹é…çš„åˆ—è¡¨èµ„æºï¼Œå°†ä½¿ç”¨å¤–è”çš„æ–¹å¼åŠ è½½èµ„æºï¼Œè¿™æ ·æœ‰æ•ˆè§£å†³è·¨åŸŸé—®é¢˜ï¼š

- `jsIgnores` è§ï¼š`getExternalScripts` [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- `cssIgnores` è§ï¼š`getExternalStyleSheets` [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]

> å¯¹äºå­åº”ç”¨ä¸­é™æ€èµ„æºæ ‡è®° `ignore` çš„ç­–ç•¥æ˜¯ç”¨æ³¨é‡Šæ›¿æ¢ï¼Œå°†ä¸ä¼šä½œä¸ºåº”ç”¨ä¸­çš„èµ„æºåŠ è½½

**2. è·å–èµ„æº**

é€šè¿‡ `getHtmlParseResult` è·å–èµ„æºï¼Œæ¥å— 3 ä¸ªå‚æ•°ï¼š

- `url`ï¼šèµ„æºè¿œç¨‹é“¾æ¥
- `html`ï¼šç°æœ‰çš„èµ„æº
- `htmlLoader`ï¼šä»å£°æ˜çš„é…ç½®é€ä¼ è¿‡æ¥ï¼Œè§ä¸Šè¿°æ€»ç»“

æä¾› `html` æ—¶ä¼˜å…ˆä½¿ç”¨ï¼Œå¦åˆ™é€šè¿‡ `fetch` è·å–èµ„æºé“¾æ¥

> `getHtmlParseResult` ç›¸å½“äº `micro-app` ä¸­çš„ `extractSourceDom` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#13-extractsourcedom-%E6%88%90%E5%8A%9F%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E5%9B%9E%E8%B0%83)]

**3. å¤„ç†è¿”å›èµ„æº**

- åº”ç”¨å…¥å£é“¾æ¥é€šè¿‡ `getPublicPath` è·å–èµ„æºè·¯å¾„é“¾æ¥ï¼Œè§ï¼š`defaultGetPublicPath` [[æŸ¥çœ‹](#defaultgetpublicpathè·å–èµ„æºé“¾æ¥çš„-path)]
- ä½¿ç”¨ `processTpl` å°†èµ„æºä¸­çš„æ ·å¼å’Œ `script` æå–å‡ºæ¥ï¼Œå¹¶ç”¨æ³¨é‡Šæ›¿æ¢ [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- è¿”å› `Promise<htmlParseResult>` è§ä¸Šè¿°æ€»ç»“

`qiankun` å’Œ `micro-app` é€šè¿‡ `__webpack_public_path__` é…ç½®èµ„æºè·¯å¾„ï¼š

- `qiankun`ï¼šé€šè¿‡ `window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__` è·å–ï¼Œè§ï¼šç¤ºä¾‹ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-qiankun-app-cra/blob/main/src/public-path.ts)]
- `micro-app`ï¼šé€šè¿‡ `window.__MICRO_APP_PUBLIC_PATH__` è·å–ï¼Œè§ï¼šç¤ºä¾‹ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-react-project/blob/main/src/public-path.ts)]

> ç›¸å¯¹æ¥è¯´ `wujie` å¯¹å­åº”ç”¨çš„å€¾å…¥æ˜¯æœ€å°‘çš„

**4. åŒ…è£…è·å–æ ·å¼å’Œ `script` çš„æ–¹æ³•**

åœ¨è¿”å›çš„å¯¹è±¡ä¸­åŒ…å«äº† 2 ä¸ªåŒ…è£…æ–¹æ³•ï¼š

- `getExternalScripts`ï¼šæå–åº”ç”¨ä¸­é™æ€ `script` [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- `getExternalStyleSheets`ï¼šæå–åº”ç”¨ä¸­é™æ€æ ·å¼ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]

> æå–çš„èµ„æºã€æ ·å¼ã€`script` æ¥è‡ª `processTpl` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

æå–èµ„æºä¼ é€’çš„å‚æ•°ï¼š

- æå–çš„èµ„æºé›†åˆï¼šå¦‚ `script` é›†åˆæˆ–æ ·å¼é›†åˆ
- `fetch`ï¼šé€ä¼ è‡ª `opts` ä¸­çš„å‚æ•°
- `loadError`ï¼šå¤–è”èµ„æºåŠ è½½å¤±è´¥é€šçŸ¥æ–¹æ³•ï¼Œæ¥è‡ªé…ç½®çš„å¯é€‰å‚æ•°
- `fiber`ï¼šæ˜¯å¦ç©ºé—²åŠ è½½ï¼Œä»…é™ `script` åŠ è½½

æä¾›çš„èµ„æºç­›é€‰è§„åˆ™ï¼š

- é€šè¿‡æ’ä»¶æ’é™¤çš„å¤–è”èµ„æºå°†ç›´æ¥è¢«è¿‡æ»¤ï¼Œå¦‚ï¼š`jsExcludes`ã€`cssExcludes`
- é€šè¿‡æ’ä»¶å¿½ç•¥çš„å¤–è”èµ„æºå°†æ·»åŠ  `ignore` å±æ€§ï¼Œå¦‚ï¼š`jsIgnores`ã€`cssIgnores`

**5. ä»ç¼“å­˜ä¸­æå–èµ„æº**

é‡å»ºæ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡åˆ‡æ¢åº”ç”¨å°±æ˜¯ä¸€æ¬¡å®ä¾‹åˆå§‹åŒ–ï¼Œä¼šé‡å¤è°ƒç”¨ `importHTML` æå–èµ„æºï¼Œæ­¤æ—¶ä¼šå°½é‡é€šè¿‡ç¼“å­˜è·å–èµ„æºï¼Œè§ï¼šèµ„æºç¼“å­˜é›†åˆ [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]

- `embedHTMLCache`ï¼šåº”ç”¨å…¥å£èµ„æºç¼“å­˜ï¼Œä»…é™æ²¡æœ‰æä¾› `htmlLoader`
- `styleCache`ï¼šç¼“å­˜æ‰€æœ‰å¤–è”æ ·å¼ï¼ŒåŒ…æ‹¬é™æ€æå–å’ŒåŠ¨æ€åŠ è½½
- `scriptCache`ï¼šç¼“å­˜æ‰€æœ‰å¤–è” `script`ï¼ŒåŒ…æ‹¬é™æ€æå–å’ŒåŠ¨æ€åŠ è½½

> `alive` å’Œ `umd` æ¨¡å¼å†æ¬¡åˆ‡æ¢åº”ç”¨æ—¶ï¼Œä¸ä¼šé‡å¤è°ƒç”¨ `importHTML`

`alive` æ¨¡é¢„åŠ è½½åå¯åŠ¨ä¹Ÿä¼šé‡å¤è°ƒç”¨ `importHTML`ï¼š

- `preloadApp`ï¼šé¢„åŠ è½½æ‰§è¡Œ 1 æ¬¡ï¼Œä¼šæå‰åŠ è½½èµ„æº [[æŸ¥çœ‹](#3-é¢„åŠ è½½å¾®ä»»åŠ¡-runpreload)]
- `startApp`ï¼šå¯åŠ¨åº”ç”¨æ‰§è¡Œ 1 æ¬¡ï¼Œä¼šä½¿ç”¨é¢„åŠ è½½å·²ç¼“å­˜çš„èµ„æº [[æŸ¥çœ‹](#21-alive-ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨)]

`umd` æ¨¡å¼é¢„åŠ è½½åå¯åŠ¨ä¹Ÿä¼šé‡å¤è°ƒç”¨ `importHTML`ï¼š

- å› ä¸º `umd` é¦–æ¬¡åŠ è½½æ–¹æ³• `__WUJIE_MOUNT` è¿˜æ²¡æœ‰æŒ‚è½½åˆ°æ²™ç®± `window`

é‡å¤åŠ è½½èµ„æºå¯ä»¥ç¼“å­˜ï¼Œä½†å­˜åœ¨é‡å¤å¤„ç†èµ„æºçš„é—®é¢˜ï¼Œå¦‚ï¼š`processTpl` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

- é™¤äº†é‡å»ºæ¨¡å¼å¯ä»¥é€šè¿‡é¢„åŠ è½½é…ç½® `exec` é¢„æ‰§è¡Œè§£å†³è¿™ä¸ªé—®é¢˜ [[æŸ¥çœ‹](#5-é€šè¿‡-exec-é¢„æ‰§è¡Œ)]

**6. ä» `fetch` çœ‹å…¼å®¹æ€§**

- `fetch` æ˜¯ä¸å…¼å®¹ `IE` çš„ï¼Œåœ¨æ–‡æ¡£æè¿°é€šè¿‡ `degrade` å®ç°å®¹å™¨å’Œ `proxy` å…¼å®¹ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#degrade)]
- ä¸ºäº†è§£å†³è¯·æ±‚å…¼å®¹çš„é—®é¢˜ï¼Œå¯ä»¥è‡ªè¡Œé…ç½® `fetch` é€šè¿‡ `ajax` è¯·æ±‚èµ„æºï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#fetch)]

> æœ‰ 2 ä¸ªåœºæ™¯éœ€è¦æ‰‹åŠ¨é…ç½® `fetch`ï¼šâ‘  å…¼å®¹ `IE`ï¼Œâ‘¡ ç»Ÿä¸€ `authentication`

#### `processTpl` æå–èµ„æº

ç›®å½•ï¼š`template.ts` - `processTpl` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/template.ts#L143)]

ç”¨äºä»åŠ è½½å†…å®¹ä¸­æå–å‡º `scripts` å’Œæ ·å¼ï¼Œç›¸å½“äºï¼š

- `micro-app` ä¸­çš„ `flatChildren`ï¼Œè§ï¼š`micro-app` æºç åˆ†æï¼Œæ³¨ â‘­ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#13-extractsourcedom-%E6%88%90%E5%8A%9F%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E5%9B%9E%E8%B0%83)]

æ¥å— 3 ä¸ªå‚æ•°ï¼š

- `tpl`ï¼šå­—ç¬¦ç±»å‹ï¼Œè¦æå–çš„æºå†…å®¹
- `baseURI`ï¼šæ¥è‡ª `importHTML` ä¸­çš„èµ„æºè·¯å¾„ `assetPublicPath` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- `postProcessTemplate`ï¼šå¯é€‰å‚æ•°ï¼Œç”¨äºè¿”å›å‰æ›´æ–°æå–çš„èµ„æºï¼Œç›®å‰æ²¡æœ‰ç”¨åˆ°ï¼Œå¯å¿½ç•¥

è¿”å›ä¸€ä¸ª `TemplateResult` å¯¹è±¡åŒ…å« 4 ä¸ªå±æ€§ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/template.ts#L64)]

- `template`ï¼šæ›¿æ¢æ ·å¼å’Œ `script` ä¸ºæ³¨é‡Šåçš„èµ„æº
- `scripts`ï¼šæå–çš„ `script` é›†åˆï¼Œç±»å‹å’Œ `getExternalScripts` è¿”å›å¯¹è±¡ä¸€è‡´ [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- `styles`ï¼šæå–çš„æ ·å¼é›†åˆï¼Œç±»å‹å’Œ `getExternalStyleSheets` è¿”å›å¯¹è±¡ä¸€è‡´ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]
- `entry`ï¼šå…¥å£ `script`ï¼Œä¸å­˜åœ¨åˆ™æ˜¯ `null`ï¼Œç›®å‰æ²¡æœ‰ç”¨åˆ°ï¼Œå¯å¿½ç•¥

å‡½æ•°å†…éƒ¨ä½œäº† 2 ä»¶äº‹ï¼š

- å£°æ˜å¯¹è±¡ç”¨äºæ”¶é›†æå–çš„èµ„æºï¼Œåˆ†åˆ«æ˜¯ï¼š`scripts`ã€`styles`ã€`entry`ã€`moduleSupport`
- æ›¿æ¢ `tpl`ï¼ŒæŒ‰ç…§ `replace` åˆ†ç»„æ›¿æ¢èµ„æºç»‘å®šåœ¨ `template`

**1.æ›¿æ¢å¤‡æ³¨ï¼š**

å…¨éƒ¨æ›¿æ¢ä¸ºç©ºå­—ç¬¦

**2.æå–æˆ–æ›¿æ¢ `link` æ ‡ç­¾ï¼š**

æœ‰ 2 ä¸ªæƒ…å†µä¼šå°† `link` æ ‡ç­¾æ›¿æ¢ä¸ºå¤‡æ³¨ï¼š

1. `ref="stylesheet"` å¼•å…¥çš„å¤–è”æ ·å¼
2. é™¤äº†å­—ä½“ä»¥å¤–ï¼Œæ‰€æœ‰ `preload|prefetch|modulepreload` æ¨¡å¼ä¸‹å¤–è”èµ„æº

> ä»¥ä¸Šæƒ…å†µéƒ½ä¸ç¬¦åˆï¼Œä¼šåŸå°ä¸åŠ¨å°†æ•°æ®è¿”å›ï¼Œå¯¹äº `link` æ ‡ç­¾ä¸åšæ›¿æ¢ï¼Œä¾‹å¦‚ï¼š`favicon`

å¼•å…¥çš„æ ·å¼ï¼Œæ›¿æ¢å¤‡æ³¨æœ‰ 2 ç§æ–¹å¼ï¼š

- `genIgnoreAssetReplaceSymbol`ï¼šå¸¦æœ‰ `ignore` å±æ€§çš„å¤–è”æ ·å¼
- `genLinkReplaceSymbol`ï¼šæ›¿æ¢é `ignore` çš„å¤–è”å¼•å…¥æ ·å¼

> å¸¦æœ‰ `ignore` å±æ€§çš„å¤–è”æ ·å¼æ›¿æ¢å¤‡æ³¨åå°†å½»åº•åºŸå¼ƒä¸å†è¿˜åŸ

é¢„åŠ è½½å’Œç©ºé—²åŠ è½½çš„èµ„æºæ›¿æ¢å¤‡æ³¨çš„æ–¹å¼ï¼š

- `genLinkReplaceSymbol`ï¼šç¬¬ 2 ä¸ªå‚æ•°ä¸º `true`ï¼Œæ›¿æ¢å¤‡æ³¨åå°†å½»åº•åºŸå¼ƒä¸å†è¿˜åŸ
- å› ä¸ºé™æ€æ ·å¼ä¼šé€šè¿‡ `getExternalStyleSheets` åœ¨æ¸²æŸ“å‰å®ç°é¢„åŠ è½½ï¼Œä¸éœ€è¦é€šè¿‡æµè§ˆå™¨é‡å¤é¢„åŠ è½½ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]

> åœ¨ `getEmbedHTML` æ—¶ä¼šå› æä¾›çš„å‚æ•°ä¸åŒï¼Œè€Œå¿½ç•¥è¿˜åŸè¿™éƒ¨åˆ†èµ„æº [[æŸ¥çœ‹](#getembedhtmlè½¬æ¢æ ·å¼)]

é€šè¿‡ `rel` åŒºåˆ†å¼•å…¥çš„èµ„æºç±»å‹

- `stylesheet`ï¼šå¼•å…¥çš„å¤–è”æ ·å¼ï¼Œéœ€è¦åŠ è½½å¹¶è¿˜åŸçš„é™æ€æ ·å¼
- `preload`ï¼šé¢„åŠ è½½èµ„æº
- `modulepreload` ç”¨äºé¢„åŠ è½½ `esModule`ï¼Œä¸åŒ¹é… `link`
- `prefetch`ï¼šç©ºé—²åŠ è½½èµ„æº

> æµè§ˆå™¨é€šå¸¸ä¸åŠ è½½ä¸å­˜åœ¨ `rel` å±æ€§çš„ `link` å…ƒç´ ï¼Œå…³äºè¿™ä¸ªç‰¹æ€§ç”¨ `codepen` åšäº†æ¼”ç¤º [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/rNEJxZr)]

æ”¶é›†å¤–è”æ ·å¼åªæœ‰ 1 ç§æƒ…å†µï¼š

- é `ignore` é™æ€å¼•å…¥æ ·å¼ï¼šè®°å½• `src` åœ¨ `styles` é›†åˆä¸­

> é€šè¿‡ `processCssLoader` ä»…è¿˜åŸæ”¶é›†åœ¨ `styles` é›†åˆçš„æ ·å¼ [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]

å¤–è”æ ·å¼æ”¶é›†çš„ `src` æ ¡æ­£ï¼š

- ç»å¯¹è·¯å¾„ä¸å˜ï¼Œç›¸å¯¹è·¯å¾„é€šè¿‡ `getEntirePath` åŸºäºå…¥å£èµ„æºè·¯å¾„ `baseURI` è½¬ä¸ºç»å¯¹è·¯å¾„
- å‚è€ƒ `defaultGetPublicPath`ï¼Œèµ„æºé“¾æ¥ä¸º `entry`ï¼Œ`baseURI` ä¸º `location.href` [[æŸ¥çœ‹](#defaultgetpublicpathè·å–èµ„æºé“¾æ¥çš„-path)]

> `getEntirePath` è§„åˆ™å’Œ `defaultGetPublicPath` ä¸€è‡´ï¼Œä½†ä¸éœ€è¦æå–ä¸Šä¸€çº§é“¾æ¥

è¡¥å……è¯´æ˜ï¼š

- `processTpl` æå–çš„å¤–è”æ ·å¼ï¼Œå…¨éƒ¨æ˜¯åº”ç”¨ä¸­çš„é™æ€æ ·å¼
- åŠ¨æ€æ ·å¼éœ€è¦é€šè¿‡ `patchRenderEffect` é‡å†™æ–¹æ³•æ‹¦æˆªå†™å…¥ [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

é‚£é¢„åŠ è½½çš„é“¾æ¥èµ„æºï¼Œæ¯”å¦‚ `NextJS` ä¸­é¢„åŠ è½½çš„é“¾æ¥ï¼Œä¸æ˜¯è¢«æ³¨é‡Šäº†ï¼Ÿ

- çš„ç¡®ï¼Œå¯¹äºå±è”½é¢„åŠ è½½èµ„æºè¿™å—çš„ä¼˜åŒ–è¿˜æ˜¯åº”è¯¥å†è€ƒè™‘çš„
- æ¯”å¦‚è¯´åªæœ‰å½“ `stylesheet` åŒ¹é…åˆ°å¤–è”æ ·å¼ï¼Œä¸”åˆå­˜åœ¨é¢„åŠ è½½èµ„æºçš„æƒ…å†µè¿›è¡Œå±è”½
- å…¶ä»–çš„æƒ…å†µä¿®æ­£ `link` é¢„åŠ è½½ç›¸å¯¹è·¯å¾„åï¼Œæ›¿æ¢å…¥å£èµ„æº `template`

**3.æå–æˆ–æ›¿æ¢ `style` å†…è”æ ·å¼ï¼š**

æ‰€æœ‰å†…è”æ ·å¼éƒ½ä¼šè¢«æ³¨é‡Šæ›¿æ¢ï¼Œæ›¿æ¢æ³¨é‡Šæœ‰ 2 ç§ï¼š

- `genIgnoreAssetReplaceSymbol`ï¼šå¸¦æœ‰ `ignore` å±æ€§çš„å†…è”æ ·å¼ï¼Œæ³¨é‡Šä¸­çš„ `url` ä¸º `style file`
- `getInlineStyleReplaceSymbol`ï¼šé `ignore` çš„å†…è”æ ·å¼ï¼Œå¤‡æ³¨ä¸­æŒ‰ç…§é›†åˆä¸­çš„ç´¢å¼•æ›¿æ¢æˆå¤‡æ³¨

æ”¶é›†å†…è”æ ·å¼åªæœ‰ 1 ç§æƒ…å†µï¼š

- é `ignore` é™æ€å¼•å…¥æ ·å¼ï¼šè®°å½•æ ·å¼ä»£ç ä¸º `content` åœ¨ `styles` é›†åˆä¸­

**4.æå–æˆ–æ›¿æ¢ `script`ï¼š**

å…ˆå£°æ˜ä»¥ä¸‹å¯¹è±¡ï¼š

- `scriptIgnore`ï¼šæå–çš„ `script` å¸¦æœ‰ `ignore` å±æ€§
- `isModuleScript`ï¼šåˆ¤æ–­æ˜¯å¦æ˜¯ `esModule`
- `isCrossOriginScript`ï¼šæå–çš„ `script` å­˜åœ¨è·¨åŸŸè¡Œä¸º `crossorigin`
- `crossOriginType`ï¼šè·¨åŸŸç±»å‹ï¼Œåªå– `anonymous` ä¸å‘é€å‡­æ®ï¼Œ`use-credentials` å‘é€å‡­æ®ï¼Œå¦åˆ™ä¸ºç©ºå­—ç¬¦
- `moduleScriptIgnore`ï¼šè¢«å¿½ç•¥çš„ `esModule`
- `matchedScriptTypeMatch`ï¼šæå–å¸¦æœ‰ `type` å±æ€§çš„ `script`ï¼Œä¸å­˜åœ¨ä¸º `null`
- `matchedScriptType`ï¼š`script` çš„ `type` å€¼ï¼Œä¸å­˜åœ¨ä¸º `undefined`

`esModule` æœ‰ 2 ç§æƒ…å†µä¼šè¢«å¿½ç•¥ï¼š

- è§ˆå™¨æ”¯æŒ `esModule`ï¼šä½† `script` å¸¦æœ‰å±æ€§ `nomodule`
- æµè§ˆå™¨ä¸æ”¯æŒ `esModule`ï¼šä½† `isModuleScript` ä¸º `true`ï¼Œå³å½“å‰ `script` æ˜¯ `esModule`

å¤–è” `script` è¿˜éœ€è¦å£°æ˜ 3 ä¸ªå¯¹è±¡ï¼š

- `matchedScriptEntry`ï¼šåŒ¹é…å¸¦æœ‰ `entry` çš„ `script`
- `matchedScriptSrcMatch`ï¼šåŒ¹é…å¸¦æœ‰ `src` çš„ `script`
- `matchedScriptSrc`ï¼šæå–å¤–è” `script` çš„ `src` å€¼

> `matchedScriptSrcMatch` å€¼åº”è¯¥æ”¾å…¥ `if` æ¨¡å—å¤–éƒ¨å£°æ˜ï¼Œ ç”¨äºå‡å°‘åŒ¹é…æ¬¡æ•°

æ‰€æœ‰å¤–è” `script` æ˜¯ä¸åŒ…å« `type="text/ng-template"` çš„ï¼š

- `ng-template` ä¹Ÿæ˜¯å†…è” `script`ï¼Œåªæ˜¯å…è®¸åŒ…å« `src` å±æ€§çš„ `template`ï¼Œè§ï¼š`issue` [[æŸ¥çœ‹](https://github.com/angular/angular.js/issues/2820#issuecomment-18806961)]

å†…è” `script` è¿˜éœ€è¦å£°æ˜ 2 ä¸ªå¯¹è±¡ï¼š

- `code`ï¼šå†…è” `script` çš„ä»£ç å†…å®¹
- `isPureCommentBlock`ï¼š`script` æ¯ä¸€è¡Œä¸ºç©ºï¼Œæˆ–è€…æ˜¯ä»¥ `//` å¼€å¤´çš„å•ä¾‹æ³¨é‡Š

ä¸æ›¿æ¢ `script` ä¸ºæ³¨é‡Šçš„æƒ…å†µæœ‰ 3 ç§ï¼š

| ç±»å‹          | æ¡ä»¶                                   | åŸå›                                      |
| ------------- | -------------------------------------- | ---------------------------------------- |
| æ‰€æœ‰          | `isValidJavaScriptType` æ£€æµ‹ä¸ç¬¦åˆè¦æ±‚ | è¯´æ˜ä¸æ˜¯å¯æ‰§è¡Œçš„ `script`                |
| å¤–è” `script` | å­˜åœ¨å¤šä¸ªå…¥å£ `script`                  | `entry` å’Œ `matchedScriptEntry` åŒæ—¶å­˜åœ¨ |
| å¤–è” `script` | `src` å±æ€§å€¼ä¸ºç©º                       | æ²¡æœ‰èµ„æºé“¾æ¥                             |

> é™¤äº†å¤šä¸ªå…¥å£ `script` ä¼šæŠ›å‡º `Error`ï¼Œå…¶ä»–æƒ…å†µéƒ½ç›´æ¥å‘æŒ¥èµ„æºä¸åšå¤„ç†

`entry` å…¥å£èµ„æºæŒ‰ç…§ `matchedScriptEntry` å†³å®šè®¾ç½®ä¸ºå¤–è” `script` çš„ `src`ï¼š

- ä½† `entry` ä»…ä½œä¸ºå¯¼å‡ºå¯¹è±¡çš„å±æ€§ï¼Œç›®å‰æ²¡æœ‰è¢«è°ƒç”¨

ç”¨æ³¨é‡Šæ›¿æ¢ `script` æœ‰ 4 ç§ï¼š

| æ³¨é‡Š                           | åŒ¹é…æ¡ä»¶                   | æ³¨é‡Šæ–¹å¼                                                                  |
| ------------------------------ | -------------------------- | ------------------------------------------------------------------------- |
| `genIgnoreAssetReplaceSymbol`  | `scriptIgnore`             | ä¼˜å…ˆæä¾› `src`ï¼Œå¦åˆ™ç”¨ `js file`                                          |
| `genModuleScriptReplaceSymbol` | `moduleScriptIgnore`       | ä¼˜å…ˆæä¾› `src`ï¼Œå¦åˆ™ç”¨ `js file`ï¼Œé™¤æ­¤ä¹‹å¤–æä¾›ç¬¬ 2 ä¸ªå‚æ•° `moduleSupport` |
| `genScriptReplaceSymbol`       | æœ‰ `src` å€¼çš„å¤–è” `script` | `src` å±æ€§å€¼ï¼Œä»¥åŠå¼‚æ­¥æˆ–å»¶è¿Ÿå±æ€§ï¼Œä¸å­˜åœ¨ä¸ºç©ºå­—ç¬¦                          |
| `inlineScriptReplaceSymbol`    | å†…è” `script`              | ç»Ÿä¸€æ³¨é‡Šä¿¡æ¯                                                              |

> æ³¨é‡Šçš„å‡½æ•°è§æºç ï¼ŒåŒ¹é…æ¡ä»¶è§ä¸Šè¿°å£°æ˜å¯¹è±¡

å…³äº `script` çš„æ³¨é‡Šï¼š

- ä¸åŒçš„æ³¨é‡Šåªèƒ½ä½œä¸ºæºç å‚è€ƒï¼ŒåŠ è½½çš„ `script` æœ€ç»ˆæ³¨å…¥çš„æ˜¯æ²™ç®±ï¼Œè€Œæ›¿æ¢æˆæ³¨é‡Šçš„èµ„æºæ³¨å…¥çš„æ˜¯æ¸²æŸ“å®¹å™¨

æ”¶é›† `script` æƒ…å†µæœ‰ 2 ç§ï¼Œå¤–è” `script`ã€å†…è” `src`ï¼Œéƒ½è¦æ±‚ï¼š

- ä¸èƒ½æ˜¯ `scriptIgnore`ï¼šå¸¦æœ‰ `ignore` å±æ€§
- ä¸èƒ½æ˜¯ `moduleScriptIgnore`ï¼šè¢«å¿½ç•¥çš„ `esModule`

> é™¤æ­¤ä¹‹å¤–å†…è” `script` è¿˜è¦æ±‚ï¼šå­˜åœ¨ä»£ç  `code` ä¸”ä¸èƒ½å…¨éƒ¨ä¸ºç©ºæˆ–è¡Œæ³¨é‡Š

å¤–è” `script` æ’å…¥é›†åˆçš„å¯¹è±¡ï¼š

```
{
    src: matchedScriptSrc,
    module: isModuleScript,
    crossorigin: !!isCrossOriginScript,
    crossoriginType: crossOriginType,
    attrs: parseTagAttributes(match),
}
```

> èµ‹å€¼å±æ€§çš„å¯¹è±¡è§ä¸Šè¿°æ€»ç»“

å¤–è” `script` æ”¶é›†çš„ `src` æ ¡æ­£ï¼š

- ç»å¯¹è·¯å¾„ä¸å˜ï¼Œç›¸å¯¹è·¯å¾„é€šè¿‡ `getEntirePath` åŸºäºå…¥å£èµ„æºè·¯å¾„ `baseURI` è½¬ä¸ºç»å¯¹è·¯å¾„

> å’Œä¸Šè¿°ï¼šå¤–è”æ ·å¼æ”¶é›†çš„ `src` æ ¡æ­£ï¼Œå¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„

`parseTagAttributes` æå–å±æ€§ï¼š

- `<script(.*)>` æ ‡ç­¾ä¸­æ‰€æœ‰å¸¦æœ‰ `=` çš„å±æ€§ï¼Œå°†å…¶ä½œä¸ºé”®å€¼å¯¹è±¡è¿”å›
- å› æ­¤å¯¹äºåªæœ‰å±æ€§åçš„ `async` å’Œ `defer`ï¼Œä¸ä¼šæå–ä¹Ÿä¸ä¼šæ¢å¤

å› ä¸¢å¤± `async` å’Œ `defer` é€ æˆçš„é—®é¢˜ï¼š

- `async`ï¼šä¸ä¼šæœ‰ä»»ä½•é—®é¢˜ï¼Œä½œä¸ºå¼‚æ­¥ä»£ç æ³¨å…¥æ²™ç®±ï¼Œè§ï¼šé˜Ÿåˆ—æ‰§è¡Œé¡ºåº [[æŸ¥çœ‹](#3-é˜Ÿåˆ—æ‰§è¡Œé¡ºåº)]
- `defer`ï¼šæ“ä½œ `Dom` ä¸å­˜åœ¨é—®é¢˜ï¼Œå› ä¸ºåœ¨æ­¤ä¹‹å‰èµ„æºå·²é€šè¿‡ `active` æ³¨å…¥ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
- `defer`ï¼šå¤šä¸ªé™æ€ `script` ç›¸äº’ä¾èµ–ï¼Œå¯èƒ½å›  `defer` ä¸¢å¤±è€Œç«‹å³æ‰§è¡Œï¼Œä»è€Œæ‰¾ä¸åˆ°ä¾èµ–

å¤–è” `script` ä¸­å­˜åœ¨ `async` æˆ– `defer` å±æ€§ï¼Œä¼šåœ¨ä¸Šè¿°æ’å…¥é›†åˆçš„å¯¹è±¡ä¸­æ·»åŠ  2 ä¸ªå±æ€§ï¼š

```
{
    async: isAsyncScript,
    defer: isDeferScript,
}
```

æå–çš„ `async` å’Œ `defer` æœ‰ä»€ä¹ˆç”¨ï¼š

- `getExternalScripts` åˆ¤æ–­åŠ è½½æ–¹å¼ [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- `start` åº”ç”¨æ—¶æ˜¯åŒæ­¥ä»£ç è¿˜æ˜¯å¼‚æ­¥ä»£ç  [[æŸ¥çœ‹](#1-æ”¶é›†é˜Ÿåˆ—)]

å†…è” `script` æ’å…¥é›†åˆçš„å¯¹è±¡å’Œå¤–è” `script` åŸºæœ¬ä¸€æ ·ï¼Œä¸åŒåœ¨äºï¼š

- `src`ï¼šç©ºå­—ç¬¦
- `content`ï¼šä»£ç  `code`
- ä¸å­˜åœ¨å±æ€§ `async` å’Œ `defer`

> ç±»å‹ä¸º `type="text/ng-template"` ä¹Ÿä¼šä½œä¸ºå†…è” `script` è¿›è¡Œæ”¶é›†

#### `processCssLoader`ï¼šå¤„ç† `css-loader`

ç›®å½•ï¼š`entry.ts` - `processCssLoader` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L56)]

å¤„ç† `css-loader` æ¥è‡ªå¤‡æ³¨ï¼Œä¸»è¦åšäº† 3 ä»¶äº‹ï¼š

1. æå–æ’ä»¶ä¸­çš„ `css-loader` ä¸ºæ¯ä¸ªæå–çš„æ ·å¼é›†åˆé¡¹æ·»åŠ å¾®ä»»åŠ¡æ›¿æ¢æ ·å¼ [[æŸ¥çœ‹](#compose-ç”¨æŸ¯é‡ŒåŒ–çš„æ–¹å¼æ‹å¹³ä¸€ç»„å‡½æ•°)]
2. é€šè¿‡ `getEmbedHTML` åŠ è½½æ ·å¼ï¼Œæ‰§è¡Œ `css-loader` [[æŸ¥çœ‹](#getembedhtmlè½¬æ¢æ ·å¼)]
3. é€šè¿‡ `replace` æ›¿æ¢èµ„æºï¼Œç›®å‰å­˜åœ¨é—®é¢˜ï¼Œæ— æ•ˆ

å‚æ•°ï¼š

- `sandbox`ï¼šåº”ç”¨å®ä¾‹ï¼Œç”¨äºè·å– `proxyLocation`ã€`replace` ä»¥åŠ `cssLoader` [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]
- `template`ï¼šå·²æ›¿æ¢èµ„æºä¸ºæ³¨é‡Šçš„åº”ç”¨å…¥å£èµ„æºï¼Œè§ï¼š`processTpl` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- `getExternalStyleSheets`ï¼šé€šè¿‡ `importHTML` è·å–çš„åŒ…è£…æ–¹æ³•ï¼Œç”¨äºæå–é™æ€æ ·å¼ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]

è§¦å‘åœºæ™¯æœ‰ 3 ä¸ªï¼š

- `preloadApp`ï¼šé¢„åŠ è½½åº”ç”¨ [[æŸ¥çœ‹](#3-é¢„åŠ è½½å¾®ä»»åŠ¡-runpreload)]
- `startApp`ï¼š`umd` æ¨¡å¼åˆæ¬¡åŠ è½½ï¼Œé‡å»ºæ¨¡å¼æ¯æ¬¡åŠ è½½ [[æŸ¥çœ‹](#2-å­˜åœ¨åº”ç”¨å®ä¾‹è¿è¡Œæˆ–é”€æ¯åº”ç”¨)]

> é¢„åŠ è½½åº”ç”¨æ—¶ä¼šå°†åº”ç”¨çš„èµ„æºæå–å¹¶æ›¿æ¢æ ·å¼åï¼Œä¿å­˜åˆ°å®ä¾‹ `template` ä¸­ï¼Œ`alive` æ¨¡å¼çš„åº”ç”¨å¯åŠ¨æ—¶æ— éœ€å†æ¬¡æå–æ ·å¼

**ç¬¬ä¸€æ­¥ï¼šè·å–å¹¶æ›´æ–°æ ·å¼é›†åˆ**

- é€šè¿‡ `getCurUrl` è·å–åº”ç”¨çš„ `base url`ï¼Œä¸º `proxyLocation` çš„ï¼š`origin` + `pathname`
- é€šè¿‡ `compose` è·å– `cssLoader` [[æŸ¥çœ‹](#compose-ç”¨æŸ¯é‡ŒåŒ–çš„æ–¹å¼æ‹å¹³ä¸€ç»„å‡½æ•°)]
- é€šè¿‡ `getExternalStyleSheets` éå†æ ·å¼é›†åˆï¼Œä¸ºæ¯ä¸€ä¸ª `contentPromise` æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]

å¾®ä»»åŠ¡åªåš 1 ä»¶äº‹ï¼š

- ç”¨ `cssLoader` æ›¿æ¢å·²åŠ è½½çš„æ ·å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-loader)]

**ç¬¬äºŒæ­¥ï¼šæ›¿æ¢èµ„æºä¸­çš„æ ·å¼ï¼š**

- é€šè¿‡ `getEmbedHTML` å°†æ ·å¼å…ƒç´ æ›¿æ¢å¯¹åº”çš„æ³¨é‡Š [[æŸ¥çœ‹](#getembedhtmlè½¬æ¢æ ·å¼)]
- æ›´æ–°çš„èµ„æºè¿”å›

`processCssLoader` ä¸­åº”ç”¨å®ä¾‹çš„ `replace` ä¸å¯ç”¨ï¼š

- å› ä¸ºæ‰§è¡Œæ—¶åº”ç”¨å®ä¾‹è¿˜æ²¡æœ‰ç»‘å®š `replace` æ–¹æ³•ï¼Œè§ï¼šé€šè¿‡é…ç½®æ›¿æ¢èµ„æº [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]

#### `getEmbedHTML`ï¼šè½¬æ¢æ ·å¼

ç›®å½•ï¼š`entry.ts` - `getEmbedHTML` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L77)]

ä»…é™åº”ç”¨ä¸­çš„é™æ€æ ·å¼æ›¿æ¢ï¼š

- åœ¨ `processTpl` ä¸­æå–èµ„æºä¸­çš„æ ·å¼ï¼Œæ›¿æ¢æˆç‰¹å®šçš„æ³¨é‡Š [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- ä¹‹åé€šè¿‡ `getEmbedHTML` å°†æå–çš„æ ·å¼åŠ è½½åï¼Œæ›¿æ¢å¯¹åº”çš„æ³¨é‡Šï¼Œä¿®æ­£å›æ¥

> åŠ¨æ€æ·»åŠ çš„æ ·å¼é€šè¿‡ `rewriteAppendOrInsertChild` æ‹¦æˆªå¹¶æ³¨å…¥å®¹å™¨ï¼Œä¸éœ€è¦æ›¿æ¢æ³¨é‡Š

å‚æ•°ï¼š

- `template`ï¼šåº”ç”¨èµ„æºï¼Œæºç æ˜¯ `any` å®é™…æ˜¯ `string`ï¼Œå› ä¸º `processCssLoader` ä¼ è¿‡æ¥å°±æ˜¯å­—ç¬¦ [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
- `styleResultList`ï¼šé€šè¿‡ `importHTML` æå–çš„ `styles` é›†åˆï¼Œè§ï¼š`getExternalStyleSheets` [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]

è¿”å›ï¼š

- ç”¨é™æ€æ ·å¼æ›¿æ¢æ‰æ³¨é‡Šåçš„èµ„æºå¯¹è±¡ï¼Œç±»å‹ä¸º `Promise<string>`

é€šè¿‡ `Promise.all` æ‰¹é‡å¤„ç† `style` é›†åˆä¸­æ¯ä¸€é¡¹çš„ `contentPromise`ï¼š

| èµ„æºç±»å‹               | æ›¿æ¢çš„æ³¨é‡Š                    | å¤„ç†æ–¹å¼                     |
| ---------------------- | ----------------------------- | ---------------------------- |
| å¤–è”æ ·å¼ - `ignore`    | `genLinkReplaceSymbol`        | ç”¨ `link` å…ƒç´ åŠ è½½æ ·å¼å¹¶æ›¿æ¢ |
| å¤–è”æ ·å¼ - é `ignore` | `genLinkReplaceSymbol`        | ç”¨å†…è”æ ·å¼æ›¿æ¢               |
| å†…è”æ ·å¼               | `getInlineStyleReplaceSymbol` | ç”¨å†…è”æ ·å¼æ›¿æ¢               |

- `ignore` æ¥è‡ª `cssIgnores` æ‰‹åŠ¨é…ç½®ï¼Œè§ï¼š`getExternalStyleSheets` [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]
- æ³¨é‡Šå…ƒç´ åˆ†ç±»ï¼Œè§ï¼š`processTpl` æå–èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

> åœ¨åº”ç”¨èµ„æºä¸­ï¼Œå¸¦æœ‰ `ignore` å±æ€§çš„é™æ€æ ·å¼å°†è¢«å½»åº•æ³¨é‡Šï¼Œä¸åšä»»ä½•æ“ä½œ

#### `fetchAssets`ï¼šåŠ è½½èµ„æºï¼Œç¼“å­˜åè¿”å› `Promise`

ç›®å½•ï¼š`entry.ts` - `fetchAssets` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L103)]

å‚æ•°ï¼š

- `src`ï¼šèµ„æºé“¾æ¥ï¼Œç”¨äº `fetch` è¯·æ±‚ç”¨
- `cache`ï¼šç¼“å­˜é›†åˆï¼ŒåŒ…å«ï¼š`scriptCache`ã€`styleCache` [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]
- `fetch`ï¼šé…ç½®æä¾›çš„åŠ è½½çš„æ–¹æ³•ï¼Œæ²¡æœ‰æä¾›é‡‡ç”¨å…¨å±€ `window` é»˜è®¤æä¾›çš„ `fetch`
- `cssFlag`ï¼šåŠ è½½çš„èµ„æºæ˜¯å¦æ˜¯æ ·å¼ï¼Œå¦åˆ™å°±ä½œä¸º `script`
- `loadError`ï¼šé…ç½®æ—¶æä¾›ï¼Œå¯é€‰å‚æ•°ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#loaderror)]

è¿”å›ï¼š

- é€šè¿‡ `fetch` è¿”å›çš„ `Promise<string>`

è°ƒç”¨åœºæ™¯ï¼š

- `getExternalScripts`ï¼šåŠ è½½ `script` èµ„æº [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- `getExternalStyleSheets`ï¼šåŠ è½½æ ·å¼èµ„æº [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]

åªåš 2 ä»¶äº‹ï¼š

- ä» `cache` ç¼“å­˜é›†åˆä¸­è·å–åŠ è½½èµ„æº
- ç¼“å­˜é›†åˆä¸å­˜åœ¨èµ„æºï¼Œé€šè¿‡ `fetch` åŠ è½½åç¼“å­˜åˆ° `cache` ç„¶åè¿”å›

ç¼“å­˜æœºåˆ¶ï¼š

- é€šè¿‡ `fetch` è·å–èµ„æºåï¼Œå°† `Promise` ä¿å­˜åˆ° `cache` ä¸­ï¼Œé”®å€¼ä¸º `url`
- è¿™æ ·ä½¿ç”¨ `url` å†æ¬¡è¯·æ±‚æ—¶ï¼Œå°†ä¼˜å…ˆé€šè¿‡ç¼“å­˜å¤„ç†

> ä½¿ç”¨ `codepen` æŒ‰ç…§ `fetchAssets` åšçš„æ¼”ç¤º [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/qBzPwZe)]

æ•è·å¤±è´¥ï¼š

- ä¸¤ç§æƒ…å†µï¼Œé€šè¿‡ `catch` æ•è·è¯·æ±‚å¤±è´¥ï¼Œé€šè¿‡ `status` åˆ¤æ–­æœåŠ¡å™¨åé¦ˆçŠ¶æ€å¼‚å¸¸

> é»˜è®¤æƒ…å†µä¸‹ `fetch` ä¸ä¼šæŠŠæœåŠ¡å™¨åé¦ˆçš„å¼‚å¸¸çŠ¶æ€è®¤ä¸ºæ˜¯é”™è¯¯

å¤±è´¥æ€ä¹ˆåšï¼š

- æ ¹æ® `cssFlag` èµ„æºç±»å‹æ‰“å°é”™è¯¯ï¼Œå¹¶é€šè¿‡ `loadError` å‘èµ·é€šçŸ¥
- æ›´æ–°ç¼“å­˜ä¸­çš„é”®å `url` å€¼ä¸º `null`ï¼Œä»¥ä¾¿ä¸‹æ¬¡åŠ è½½æ—¶èƒ½å¤Ÿé‡æ–°åŠ è½½

> æ¯æ¬¡è¿”å›è¯·æ±‚å‰éƒ½ä¼šå…ˆå°† `Promise` ä¿å­˜åˆ° `cache`ï¼Œå¤±è´¥åéœ€è¦æ›´æ–°ä¸º `null`

æ›´æ–°ç¼“å­˜ä¼šå½±å“è¿”å›çš„ `Promise` å—ï¼Ÿ

- ä¸ä¼šï¼Œä»è¿™ç‚¹è¯´æ˜ `return` èµ‹å€¼è¿”å›çš„å¯¹è±¡ä¸€å®šæ˜¯ç­‰å·å³è¾¹çš„å¯¹è±¡

```
// è¿™é‡Œè¿”å›çš„ä¸€å®šæ˜¯ç­‰å·å³è¾¹çš„ `Promise`ï¼Œè€Œä¸æ˜¯ `cache`
return (cache[key] = Promise.resolve());
```

#### `getExternalScripts`ï¼šåŠ è½½ `script` èµ„æº

æœ‰ 2 ä¸ªåŒåçš„æ–¹æ³•ï¼Œä¸ºäº†åšåŒºåˆ†è¿™é‡Œç§°å‘¼ä¸ºï¼šåŠ è½½æ–¹æ³•å’Œ `importHTML` ä¸­çš„åŒ…è£…æ–¹æ³•

**1. åŠ è½½æ–¹æ³• `getExternalScripts`**

åº”ç”¨ä¸­æ‰€æœ‰ `script` åŠ è½½ã€ç¼“å­˜çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ `importHTML` ä¸­é™æ€ `script` æå–ï¼Œä¹Ÿæ˜¯åŒ…è£… `getExternalScripts` ä½œä¸ºå±æ€§è¿”å›

ç›®å½•ï¼š`entry.ts` - `getExternalScripts` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L167)]

å‚æ•°ï¼š

- `scripts`ï¼šæå–çš„ `script` é›†åˆï¼ŒåŒ…å«çš„ `script` å¯ä»¥æ˜¯å¤–è”ä¹Ÿå¯ä»¥æ˜¯å†…è”
- `fetch`ï¼šé€ä¼ ç»™ `fetchAssets` çš„è¯·æ±‚æ–¹æ³• [[æŸ¥çœ‹](#fetchassetsåŠ è½½èµ„æºç¼“å­˜åè¿”å›-promise)]
- `loadError`ï¼šèµ„æºåŠ è½½å¤±è´¥é€šçŸ¥ï¼Œå¹¶éå¿…é€‰å‚æ•°ï¼ŒåŒæ ·é€ä¼ ç»™ `fetchAssets`
- `fiber`ï¼šæ˜¯å¦ç©ºé—²æ—¶é—´åŠ è½½èµ„æºï¼Œé»˜è®¤æ˜¯ `true`

è¿”å›ï¼š

- æå– `script` ç»“æœçš„é›†åˆ `ScriptResultList[]`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L19)]

ä¸»è¦åšçš„ 1 ä»¶äº‹ï¼š

- éå† `script` é›†åˆï¼Œä¸ºæ¯ä¸€é¡¹å¢åŠ ä¸€ä¸ª `Promise` ç±»å‹çš„å±æ€§ `contentPromise`

`contentPromise` å†…è” `script` åŠ è½½æƒ…å†µï¼š

- å…¨éƒ¨åœ¨ `Promise` ä¸­è¿”å›ä»£ç å­—ç¬¦ï¼ŒåŒ…æ‹¬å­˜åœ¨ `module` ç­‰å…¶å®ƒå±æ€§
- å†…è” `script` è™½ç„¶åˆ¤æ–­äº† `ignore`ï¼Œä½†æ˜¯ä¸å­˜åœ¨è¿™ç§æƒ…å†µï¼Œè§ä¸‹æ–¹ `ignore` è¯´æ˜

`contentPromise` å¤–è” `script` åŠ è½½æƒ…å†µï¼š

- `module`ï¼šåœ¨ `Promise` ä¸­ä»¥ç©ºå­—ç¬¦è¿”å›
- `ignore`ï¼šé™ `async` æˆ– `defer` é `module` å°†é€šè¿‡ `fetchAssets` åŠ è½½èµ„æºï¼Œå¦åˆ™åœ¨ `Promise` ä¸­è¿”å›ç©ºå­—ç¬¦
- å…¶å®ƒæƒ…å†µéƒ½ä¼šé€šè¿‡ `fetchAssets` åŠ è½½èµ„æº [[æŸ¥çœ‹](#fetchassetsåŠ è½½èµ„æºç¼“å­˜åè¿”å›-promise)]

`Promise` è¿”å›ç©ºå­—ç¬¦çš„æƒ…å†µï¼Œä¹‹åä¼šé€šè¿‡ `insertScriptToIframe` ä½œä¸ºå¤–è” `script` åŠ è½½ [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]ï¼š

- å› ä¸º `contentPromise` åªèƒ½å†³å®š `script` ä¸­çš„ `content`
- `content` ä¸å­˜åœ¨çš„è¯ï¼Œä¼šé€šè¿‡ `src` å»åŠ è½½ `script`ï¼Œè¿™æ ·é€šè¿‡æµè§ˆå™¨æœºåˆ¶æœ‰æ•ˆé¿å¼€è·¨åŸŸé—®é¢˜
- å…¶ä¸­åŒ…å«äº†ï¼šæ‰€æœ‰å¤–è”çš„ `module`ï¼Œé `async` å’Œ `defer` çš„ `ignore`

`ignore` é€š `fetchAssets` åŠ è½½ `async` æˆ– `defer`ï¼Œä»…é™æå–é™æ€ `script`ï¼š

- åŠ¨æ€æ·»åŠ å¤–è” `script` å¿½ç•¥äº†æ­¤å±æ€§
- æ‰‹åŠ¨æ·»åŠ å¸¦æœ‰ `src` çš„ `js-loader`ï¼Œä¸ä¼šåŠ è½½è€Œæ˜¯ä½œä¸ºå¤–è” `script` æ³¨å…¥æ²™ç®±

éœ€è¦å¼ºè°ƒçš„æ˜¯èƒ½å¤Ÿè¢«æå–çš„é™æ€ `script`ï¼Œä¸€å®šæ˜¯é€šè¿‡æ‰‹åŠ¨æ ‡è®°çš„ `ignore`ï¼š

- å› ä¸ºåŒ…å« `ignore` å±æ€§çš„é™æ€ `script` å°†è¢«æ³¨é‡Šæ›¿æ¢ä¸å†æ¢å¤

> è¿™å¯èƒ½æ˜¯å¼€å‘äººå‘˜çš„é—æ¼ï¼Œå› ä¸ºæ–‡æ¡£ä¸­æè¿° `ignore` çš„è®¾è®¡å°±æ˜¯ä¸ºäº†è§£å†³è·¨åŸŸè¯·æ±‚èµ„æºçš„é—®é¢˜ï¼Œè€Œé¿å¼€ä½¿ç”¨ `fetchAssets` åŠ è½½èµ„æºï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-ignores)]

é€šè¿‡ `fetchAssets` ä¸åŒçš„åŠ è½½æ–¹å¼ï¼š

- `async` æˆ– `defer` ä¸‹ä½¿ç”¨ `fiber` å†³å®šæ˜¯å¦é€šè¿‡å®ä»»åŠ¡ `requestIdleCallback` ç©ºé—²åŠ è½½
- å…¶å®ƒå…¨éƒ¨ç›´æ¥åŠ è½½

åŠ è½½å¤–è” `script` æ—¶ä¼ é€’ç»™ `fetchAssets` çš„å‚æ•°ï¼š

- `src`ï¼šèµ„æºé“¾æ¥
- `scriptCache`ï¼šç”¨äºç¼“å­˜ `script` åŠ è½½çš„èµ„æºï¼Œè§ï¼šèµ„æºç¼“å­˜é›†åˆ [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]
- `fetch`ï¼šé€ä¼ è‡ªèº«å‚æ•° `fetch`
- `cssFlag`ï¼šä¸æ˜¯æ ·å¼èµ„æºï¼Œå…¨éƒ¨è®¾ä¸º `false`
- `loadError`ï¼šé€ä¼ è‡ªèº«å‚æ•° `loadError`

é™¤æ­¤ä¹‹å¤–åšäº†ä»€ä¹ˆï¼š

- `module` é `async` çš„ `script`ï¼Œéœ€è¦æ ‡è®° `defer` ä¸º `true`
- åœ¨ `start` å¯åŠ¨åº”ç”¨æ—¶ï¼Œä¼šå°†å…¶ä½œä¸ºåŒæ­¥ä»£ç  [[æŸ¥çœ‹](#1-æ”¶é›†é˜Ÿåˆ—)]

è°ƒç”¨åœºæ™¯ï¼š

- `importHTML`ï¼šåŒ…è£…åä½œä¸ºè¿”å›å¯¹è±¡çš„å±æ€§ï¼Œç”¨äºåŠ è½½åº”ç”¨ä¸­é™æ€ `script`ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜
- `rewriteAppendOrInsertChild`ï¼šå¤„ç†åº”ç”¨ä¸­åŠ¨æ€åŠ è½½çš„ `script` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

> å•ä¾‹åº”ç”¨å¦‚ `React` é€šå¸¸ä¼šé™æ€åŠ è½½å…¥å£æ–‡ä»¶ï¼Œç„¶ååŠ¨æ€æ³¨å…¥ `script`

æ‰‹åŠ¨é…ç½®çš„ `js-loader` ä¸ä¼šé€šè¿‡ `getExternalScripts` åŠ è½½èµ„æºï¼š

- åŒ…å« `jsBeforeLoaders`ã€`jsAfterLoaders`

æ ¹æ®ä»¥ä¸Šæ€»ç»“ï¼Œä»¥ä¸‹æƒ…å†µå°†é€šè¿‡ `src` åœ¨æ²™ç®±ä¸­åŠ è½½ `script`ï¼š

- ç±»å‹ä¸º `module` çš„å¤–è” `script`ï¼Œæ— è®ºæ˜¯é™æ€æå–è¿˜æ˜¯åŠ¨æ€æ·»åŠ 
- æ‰‹åŠ¨é…ç½® `ignore` é `async` æˆ– `defer` çš„å¤–è” `script`
- æ‰‹åŠ¨é…ç½® `js-loader` çš„å¤–è” `script`

å…³äº `ignore` çš„è¡¥å……ï¼š

- åº”ç”¨ä¸­æå–çš„é™æ€ `script` å­˜åœ¨ `ignore` å±æ€§å°†è¢«æ³¨é‡Šï¼Œèµ„æºä¸ä¼šè¢«æ”¶é›†ï¼Œæ— è®ºå†…è”è¿˜æ˜¯å¤–è”
- åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„ `script`ï¼Œä¸æ”¶é›†å…ƒç´  `ignore` å±æ€§ï¼Œé™¤äº† `jsIgnores` éƒ½åŠ è½½ä¸ºå†…è” `script`
- é€šè¿‡ `jsIgnores` æ‰‹åŠ¨å¿½ç•¥å¤–è” `script`ï¼Œä½†ä¸å¿½ç•¥ `async` æˆ– `defer` é `module` çš„å¤–è” `script`
- `ignore` çš„ `script` å°†åœ¨ `Promise` è¿”å›ç©ºå­—ç¬¦ï¼Œéœ€è¦é€šè¿‡ `src` åŠ è½½ `script`

ç”±æ­¤å¾—å‡ºåœ¨ `getExternalScripts` ä¸­åŠ è½½çš„ `script`ï¼š

- å†…è” `script` ä¸å­˜åœ¨ `ignore`ï¼Œå› ä¸ºåŠ è½½å‰è¢«ç­›é€‰å‡ºå»ï¼Œæˆ–æ— æ³•åŒ¹é… `jsIgnores`
- å¤–è” `script` é€šè¿‡ `jsIgnores` æ·»åŠ çš„ `ignore`

é€šè¿‡ `src` åŠ è½½ `script` éœ€è¦æ³¨æ„ï¼š

- å¤–è” `script` æ²¡æœ‰åŒ…è£¹ `proxyLocation`ï¼Œè°ƒç”¨ `location` æ˜¯å»ºç«‹åœ¨åŸºåº§ `url` ä¸Š [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]
- éœ€è¦é€šè¿‡ `window.$wujie.location` æ¥ä»£æ›¿ `location`

**2. `importHTML` ä¸­çš„åŒ…è£…æ–¹æ³•**

åªèƒ½ç”¨äºåº”ç”¨ä¸­çš„é™æ€ `script` åŠ è½½ï¼Œä¾‹å¦‚å…¥å£æ–‡ä»¶

ç›®å½•ï¼š`entry.ts` - `importHTML` - `getExternalScripts` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L239)]

è°ƒç”¨æ–¹æ³•ä¸éœ€è¦æä¾›å‚æ•°ï¼Œä½†å†…éƒ¨ä¼šå°†ä»¥ä¸‹å‚æ•°ä¼ é€’ç»™åŠ è½½æ–¹æ³• `getExternalScripts`ï¼š

- `scripts`ï¼šç­›é€‰åçš„é™æ€ `script` é›†åˆ
- `fetch`ï¼šè‡ªå®šä¹‰æ–¹æ³•ï¼Œæ²¡æœ‰æä¾›åˆ™ä½¿ç”¨å…¨å±€ `window` æä¾›çš„ `fetch`
- `loadError`ï¼šåŠ è½½å¤±è´¥é€šçŸ¥æ–¹æ³•ï¼Œé…ç½®æ—¶æä¾›ï¼Œå¯é€‰å‚æ•°
- `fiber`ï¼šé€ä¼  `importHTML` çš„å‚æ•°ï¼Œé…ç½®æ—¶æä¾›ï¼Œé»˜è®¤ `true` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

`scripts` ç­›é€‰è§„åˆ™ï¼š

- å†…è”çš„é™æ€ `script` éƒ½å…è®¸
- å¤–è”çš„ `script` ä¸åœ¨ `jsExcludes` é…ç½®åˆ—è¡¨ä¸­ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-excludes)]
- æ‰€æœ‰ç¬¦åˆè¦æ±‚ä¸”åŒ¹é… `jsIgnores` çš„å¤–è” `script`ï¼Œéœ€è¦æ ‡è®° `ignore` ä¸º `true`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-ignores)]

`scripts` ä»å“ªé‡Œæ¥ï¼š

- ç”± `processTpl` ä»æå–çš„å…¥å£èµ„æºç­›é€‰å‡ºé™æ€ `script` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

è°ƒç”¨åœºæ™¯ï¼š

- `preloadApp`ï¼šé¢„åŠ è½½ [[æŸ¥çœ‹](#3-é¢„åŠ è½½å¾®ä»»åŠ¡-runpreload)]
- `startApp`ï¼š`alive` åˆæ¬¡åŠ è½½ã€é‡åŠ æ¨¡å¼æ¯æ¬¡å¯åŠ¨ [[æŸ¥çœ‹](#2-å­˜åœ¨åº”ç”¨å®ä¾‹è¿è¡Œæˆ–é”€æ¯åº”ç”¨)]

å‘æŒ¥çš„ä½œç”¨ï¼š

- åœ¨ `importHTML` åŒ…è£¹ `getExternalScripts` æ–¹æ³•ç¡®ä¿ä¸ä¼šç«‹å³æ‰§è¡Œ [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- è€Œåœ¨è°ƒç”¨åœºæ™¯ä¸­é€šè¿‡ `await` å¯ä»¥ç¡®ä¿æ‰§è¡Œå‰ä¼˜å…ˆå‘èµ·ä»»åŠ¡åŠ è½½ `script`

å‘èµ·çš„ä»»åŠ¡ç”± `scripts` é›†åˆä¸­çš„ `contentPromise` å†³å®šï¼š

- ç±»å‹ä¸º `Promise` çš„å¾®ä»»åŠ¡ï¼Œå°†ç¡®ä¿èµ„æº `resolve`
- ç±»å‹ä¸º `fetchAssets` è¿”å›çš„å¾®ä»»åŠ¡ï¼Œå°†ç¡®ä¿å‘èµ·è¯·æ±‚

> ä¸ºäº†å¾ˆå¥½çš„ç†è§£åŒºåˆ«ï¼Œç”¨ `codepen` åšäº†ä¸€ä¸ªæ¼”ç¤º [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/qBzPwZe?editors=1111)]

é‚£æ³¨å…¥ `script` åˆ°æ²™ç®±æ—¶ï¼Œ`fetchAssets` è¿˜æ²¡æœ‰åŠ è½½å®Œæ€ä¹ˆåŠï¼Ÿ

- åœ¨ `start` æ—¶åº”ç”¨ä¸­çš„èµ„æºå°†è¢«åˆ†é…åˆ°åŒæ­¥å’Œå¼‚æ­¥ä»£ç ä¸­æ‰§è¡Œ [[æŸ¥çœ‹](#1-æ”¶é›†é˜Ÿåˆ—)]
- æ— è®ºæ˜¯åŒæ­¥ä»£ç è¿˜æ˜¯å¼‚æ­¥ä»£ç ï¼Œéƒ½æ˜¯ `Promise` é˜Ÿåˆ—ï¼Œå¿…é¡»ç­‰å¾…ä¸Šæ¡æ‰§è¡Œå®Œæ¯•åæ‰èƒ½å‘èµ·æ–°çš„å¾®ä»»åŠ¡

#### `getExternalStyleSheets`ï¼šåŠ è½½æ ·å¼èµ„æº

æœ‰ 2 ä¸ªåŒåçš„æ–¹æ³•ï¼Œä¸ºäº†åšåŒºåˆ†è¿™é‡Œç§°å‘¼ä¸ºï¼šåŠ è½½æ–¹æ³•å’Œ `importHTML` ä¸­çš„åŒ…è£…æ–¹æ³•

**1. åŠ è½½æ–¹æ³• `getExternalStyleSheets`**

åº”ç”¨ä¸­æ‰€æœ‰æ ·å¼åŠ è½½ã€ç¼“å­˜çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬ `importHTML` ä¸­é™æ€æ ·å¼æå–ï¼Œä¹Ÿæ˜¯åŒ…è£… `getExternalStyleSheets` ä½œä¸ºå±æ€§è¿”å›

ç›®å½•ï¼š`entry.ts` - `getExternalStyleSheets` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L143)]

å‚æ•°ï¼š

- `styles`ï¼šæå–çš„æ ·å¼é›†åˆï¼ŒåŒ…å«çš„æ ·å¼å¯ä»¥æ˜¯å¤–è”ä¹Ÿå¯ä»¥æ˜¯å†…è”
- `fetch`ï¼šé€ä¼ ç»™ `fetchAssets` çš„è¯·æ±‚æ–¹æ³• [[æŸ¥çœ‹](#fetchassetsåŠ è½½èµ„æºç¼“å­˜åè¿”å›-promise)]
- `loadError`ï¼šèµ„æºåŠ è½½å¤±è´¥é€šçŸ¥ï¼Œå¹¶éå¿…é€‰å‚æ•°ï¼ŒåŒæ ·é€ä¼ ç»™ `fetchAssets`

è¿”å›ï¼š

- æå–æ ·å¼ç»“æœçš„é›†åˆ `StyleResultList[]`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L20)]

ä¸»è¦åšçš„ 1 ä»¶äº‹ï¼š

- éå†æ ·å¼é›†åˆï¼Œä¸ºæ¯ä¸€é¡¹å¢åŠ ä¸€ä¸ª `Promise` ç±»å‹çš„å±æ€§ `contentPromise`

`contentPromise` åŠ è½½æƒ…å†µæœ‰ 4 ç§ï¼š

| åˆ†ç±»               | æ¡ä»¶          | å¤„ç†æ–¹å¼                                                                     |
| ------------------ | ------------- | ---------------------------------------------------------------------------- |
| `content` å†…è”æ ·å¼ | æ—             | åœ¨ `Promise` ä¸­ä»¥å†…è”ä»£ç è¿”å›                                                |
| `src` ä¸ºå…ƒç´        | åŒ…å«æ ‡ç­¾ `<>` | æå–å…ƒç´ ä¸­çš„æ ·å¼ï¼Œä»¥ `Promise` è¿”å›å†…è”ä»£ç                                   |
| `src` å¤–è”æ ·å¼     | `ignore`      | åœ¨ `Promise` ä¸­ä»¥ç©ºå­—ç¬¦è¿”å›                                                  |
| `src` å¤–è”æ ·å¼     | æ—             | é€šè¿‡ `fetchAssets` åŠ è½½èµ„æº [[æŸ¥çœ‹](#fetchassetsåŠ è½½èµ„æºç¼“å­˜åè¿”å›-promise)] |

> `src` ä½œä¸ºå…ƒç´  `outHTML`ï¼Œè™½ç„¶çœ‹ä¸Šå»ä¸åˆç†ï¼Œä½†è¿™æ˜¯ç”¨äºå’Œå†…è”æ ·å¼åŒºåˆ†çš„å”¯ä¸€åŠæ³•ï¼Œç›®å‰æ²¡æœ‰ç”¨åˆ°

åŠ è½½å¤–è”æ ·å¼æ—¶ä¼ é€’ç»™ `fetchAssets` çš„å‚æ•°ï¼š

- `src`ï¼šèµ„æºé“¾æ¥
- `styleCache`ï¼šç”¨äºç¼“å­˜æ ·å¼åŠ è½½çš„èµ„æºï¼Œè§ï¼šèµ„æºç¼“å­˜é›†åˆ [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]
- `fetch`ï¼šé€ä¼ è‡ªèº«å‚æ•° `fetch`
- `cssFlag`ï¼šæ ·å¼èµ„æºè®¾ä¸º `true`
- `loadError`ï¼šé€ä¼ è‡ªèº«å‚æ•° `loadError`

é™¤æ­¤ä¹‹å¤–åšäº†ä»€ä¹ˆï¼š

- å†…è”æ ·å¼ä¼šå°† `src` æ›´æ–°ä¸ºç©ºå­—ç¬¦ï¼Œå› ä¸ºå­˜åœ¨ `src` ä¸ºå…ƒç´  `outHTML` çš„æƒ…å†µ

è°ƒç”¨åœºæ™¯ï¼š

- `importHTML`ï¼šåŒ…è£…åä½œä¸ºè¿”å›å¯¹è±¡çš„å±æ€§ï¼Œç”¨äºåŠ è½½åº”ç”¨ä¸­é™æ€æ ·å¼ï¼Œä¸‹é¢ä¼šè¯¦ç»†è¯´æ˜
- `rewriteAppendOrInsertChild`ï¼šå¤„ç†åº”ç”¨ä¸­åŠ¨æ€åŠ è½½çš„å¤–è”æ ·å¼ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]
- `processCssLoaderForTemplate`ï¼šé€šè¿‡é…ç½®æ‰‹åŠ¨æ³¨å…¥æ ·å¼åˆ°åº”ç”¨å¤´éƒ¨å’Œå°¾éƒ¨ [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)]

> åº”ç”¨ä¸­åŠ¨æ€åŠ è½½çš„å†…è”æ ·å¼ä¸éœ€è¦è°ƒç”¨ `getExternalStyleSheets`ï¼›åœ¨å•ä¾‹åº”ç”¨ï¼Œå¦‚ `React` ä¸­é€šå¸¸ä¼šé€šè¿‡å…¥å£æ–‡ä»¶åŠ¨æ€åŠ è½½æ ·å¼ï¼Œä»¥å†…è”çš„æ–¹å¼å°†ä»£ç æ³¨å…¥æ ·å¼ï¼Œè§ï¼šåŠ è½½æµç¨‹ [[æŸ¥çœ‹](https://github.com/cgfeel/zf-micro-app/blob/main/doc/wujie-umd-patch_css_rules.md)]

å…³äº `ignore` çš„è¡¥å……ï¼š

- åº”ç”¨ä¸­æå–çš„é™æ€æ ·å¼å­˜åœ¨ `ignore` å±æ€§å°†è¢«æ³¨é‡Šï¼Œèµ„æºä¸ä¼šè¢«æ”¶é›†ï¼Œæ— è®ºå†…è”è¿˜æ˜¯å¤–è”
- åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„æ ·å¼ï¼Œä¸æ”¶é›†å…ƒç´  `ignore` å±æ€§ï¼Œé™¤äº† `cssIgnores` éƒ½èƒ½é¡ºåˆ©åŠ è½½
- é€šè¿‡ `cssIgnores` å°†æ‰‹åŠ¨å¿½ç•¥å¤–è”æ ·å¼
- æ‰‹åŠ¨å¿½ç•¥ `ignore` çš„å¤–è”æ ·å¼å°†åœ¨ `Promise` è¿”å›ç©ºå­—ç¬¦ï¼Œé€šè¿‡ `link` åŠ è½½æ ·å¼

ç”±æ­¤å¾—å‡ºåœ¨ `getExternalStyleSheets` ä¸­åŠ è½½çš„æ ·å¼ï¼š

- å†…è”æ ·å¼ä¸å­˜åœ¨ `ignore`ï¼Œå› ä¸ºåŠ è½½å‰è¢«ç­›é€‰å‡ºå»ï¼Œæˆ–æ— æ³•åŒ¹é… `cssIgnores`
- å¤–è”æ ·å¼é€šè¿‡ `cssIgnores` æ·»åŠ çš„ `ignore`

`ignore` åœ¨ä¸åŒåœºæ™¯ä¸‹çš„è¡¨ç°ï¼š

- `processTpl`ï¼šæå–é™æ€æ ·å¼ï¼Œç”¨æ³¨é‡Šæ›¿æ¢æ‰æ ·å¼ [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- `cssIgnores`ï¼šæ‰‹åŠ¨å¿½ç•¥æ ·å¼ï¼Œé‡‡ç”¨ `link` åŠ è½½æ ·å¼ï¼Œè§ï¼š`getEmbedHTML` [[æŸ¥çœ‹](#getembedhtmlè½¬æ¢æ ·å¼)]
- `processCssLoaderForTemplate`ï¼šæ‰‹åŠ¨é…ç½®æ ·å¼ï¼Œç›´æ¥è·³å‡ºä¸åšä»»ä½•æ“ä½œ [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)]

**2. `importHTML` ä¸­çš„åŒ…è£…æ–¹æ³•**

åªèƒ½ç”¨äºåº”ç”¨ä¸­çš„é™æ€æ ·å¼åŠ è½½ï¼Œä¾‹å¦‚æ‰‹åŠ¨ä¸ºå…¥å£ `template` æ·»åŠ äº†é™æ€æ ·å¼

ç›®å½•ï¼š`entry.ts` - `importHTML` - `getExternalStyleSheets` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L248)]

è°ƒç”¨æ–¹æ³•ä¸éœ€è¦æä¾›å‚æ•°ï¼Œä½†å†…éƒ¨ä¼šå°†ä»¥ä¸‹å‚æ•°ä¼ é€’ç»™åŠ è½½æ–¹æ³• `getExternalStyleSheets`ï¼š

- `styles`ï¼šç­›é€‰åçš„é™æ€æ ·å¼é›†åˆ
- `fetch`ï¼šè‡ªå®šä¹‰æ–¹æ³•ï¼Œæ²¡æœ‰æä¾›åˆ™ä½¿ç”¨å…¨å±€ `window` æä¾›çš„ `fetch`
- `loadError`ï¼šåŠ è½½å¤±è´¥é€šçŸ¥æ–¹æ³•ï¼Œé…ç½®æ—¶æä¾›ï¼Œå¯é€‰å‚æ•°

æ ·å¼ç­›é€‰è§„åˆ™ï¼š

- å†…è”çš„é™æ€æ ·å¼éƒ½å…è®¸
- å¤–è”çš„æ ·å¼ä¸åœ¨ `cssExcludes` é…ç½®åˆ—è¡¨ä¸­ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-excludes)]
- æ‰€æœ‰ç¬¦åˆè¦æ±‚ä¸”åŒ¹é… `cssIgnores` çš„å¤–è”æ ·å¼ï¼Œå°†ä½œä¸ºå¤–è”æ ·å¼é€šè¿‡æµè§ˆå™¨åŠ è½½ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-ignores)]

æ ·å¼ä»å“ªé‡Œæ¥ï¼š

- ç”± `processTpl` ä»æå–çš„å…¥å£èµ„æºç­›é€‰å‡ºé™æ€æ ·å¼ [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

è°ƒç”¨åœºæ™¯ï¼š

- `processCssLoader` åŠ è½½æ ·å¼èµ„æº [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]

å‘æŒ¥çš„ä½œç”¨ï¼š

- åœ¨ `importHTML` åŒ…è£¹ `getExternalStyleSheets` æ–¹æ³•ç¡®ä¿ä¸ä¼šç«‹å³æ‰§è¡Œ [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- è€Œåœ¨è°ƒç”¨åœºæ™¯ä¸­é€šè¿‡ `await` å¯ä»¥ç¡®ä¿æ‰§è¡Œå‰ä¼˜å…ˆå‘èµ·ä»»åŠ¡åŠ è½½æ ·å¼

å‘èµ·çš„ä»»åŠ¡ç”±æ ·å¼é›†åˆä¸­çš„ `contentPromise` å†³å®šï¼š

- ç±»å‹ä¸º `Promise` çš„å¾®ä»»åŠ¡ï¼Œå°†ç¡®ä¿èµ„æº `resolve`
- ç±»å‹ä¸º `fetchAssets` è¿”å›çš„å¾®ä»»åŠ¡ï¼Œå°†ç¡®ä¿å‘èµ·è¯·æ±‚

> ä¸ºäº†å¾ˆå¥½çš„ç†è§£åŒºåˆ«ï¼Œç”¨ `codepen` åšäº†ä¸€ä¸ªæ¼”ç¤º [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/qBzPwZe?editors=1111)]

å’Œ `script` ä¸åŒçš„åŠ è½½æ–¹å¼ï¼š

- æ ·å¼åŠ è½½æ¯ä¸€æ­¥éƒ½ç”± `await` ç¡®ä¿æ‰§è¡Œå®Œæ¯•ï¼Œä¸å­˜åœ¨è¿˜æ²¡æœ‰æ‹¿åˆ° `fetchAssets` è¯·æ±‚ç»“æœçš„æƒ…å†µ

#### é€šè¿‡é…ç½®æ›¿æ¢èµ„æº

åŒ…å« 2 ä¸ªæ’ä»¶å’Œä¸€ä¸ªå¯åŠ¨é…ç½®ï¼Œåˆ†åˆ«æ˜¯

- `css-loader`ï¼šæ’ä»¶ï¼Œåœ¨è¿è¡Œæ—¶å¯¹å­åº”ç”¨çš„ `css` æ–‡æœ¬è¿›è¡Œä¿®æ”¹ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-loader)]
- `js-loader`ï¼šæ’ä»¶ï¼Œåœ¨è¿è¡Œæ—¶å¯¹å­åº”ç”¨çš„ `script` è„šæœ¬è¿›è¡Œæ›¿æ¢ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-loader)]
- `replace`ï¼šå¯åŠ¨é…ç½®ï¼Œåœ¨è¿è¡Œæ—¶å¤„ç†å­åº”ç”¨çš„ `html`ã€`js`ã€`css` è¿›è¡Œæ›¿æ¢ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/preloadApp.html#replace)]

> è¿™äº›æ–¹æ³•å°†åœ¨ä¸åŒçš„åœºæ™¯ä¸‹è°ƒç”¨å¹¶æ›¿æ¢èµ„æº

`processCssLoader` åŠ è½½åº”ç”¨ä¸­çš„é™æ€æ ·å¼æ›¿æ¢ `template` ä¸­çš„æ³¨é‡Š [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]ï¼š

- ä¸ºæ ·å¼èµ„æºå±æ€§ `contentPromise` è¿½åŠ ä¸€ä¸ªå¾®ä»»åŠ¡ï¼Œé€šè¿‡ `css-loader` æ›¿æ¢æ ·å¼
- é€šè¿‡ `getEmbedHTML` å°†åŠ è½½çš„æ ·å¼æ›¿æ¢ `template` ä¸­å¯¹åº”çš„æ³¨é‡Š [[æŸ¥çœ‹](#getembedhtmlè½¬æ¢æ ·å¼)]
- æœ€åé€šè¿‡ `replace` æ›¿æ¢å·²æ›´æ–°èµ„æºåçš„ `template`

> è°ƒç”¨ `processCssLoader` ä¹‹å‰å°±ä¸€å®šä¼šé€šè¿‡ `importHTML` æå–èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

å­˜åœ¨ 2 ä¸ªé—®é¢˜ï¼š

- `replace` ä¸èƒ½æ›¿æ¢åº”ç”¨ä¸­çš„é™æ€æ ·å¼ï¼Œåªèƒ½ç”¨ `css-loader` ä»£æ›¿
- `replace` åœ¨ `processCssLoader` ä¸å¯ç”¨

å› ä¸º `replace` å¿…é¡»åœ¨åº”ç”¨ `active` æ—¶ç»‘å®šåœ¨å®ä¾‹ï¼š

- è€Œ `processCssLoader` æ˜¯åœ¨ `active` ä¹‹å‰è°ƒç”¨ï¼Œæ‰§è¡Œæ—¶åº”ç”¨å®ä¾‹ä¸­è¿˜ä¸å­˜åœ¨æ–¹æ³• `replace`

`getCssLoader` æŸ¯é‡ŒåŒ–å¤„ç†è¿è¡Œæ—¶çš„æ ·å¼ï¼š

- æ¥å— 2 ä¸ªå‚æ•°ï¼Œå…¨éƒ¨æ¥è‡ªæ‰‹åŠ¨é…ç½®ï¼š`plugins` æ’ä»¶é›†åˆã€`replace` ç”¨äºæ›¿æ¢èµ„æº
- è¿”å›å‡½æ•°ï¼Œå‚æ•°æœ‰ï¼š`code` æ ·å¼å†…å®¹ã€`src` èµ„æºé“¾æ¥ã€`base` å­åº”ç”¨ `origin` + `pathname`

å¤„ç†æ–¹å¼ï¼š

- å…ˆé€šè¿‡ `replace` æ›¿æ¢ `code` æ ·å¼ï¼Œç„¶åå°†å‚æ•°é€ä¼ ç»™ `compose` è¿”å›çš„å‡½æ•°
- `compose` ä¹Ÿæ˜¯æŸ¯é‡ŒåŒ–å‡½æ•°ï¼Œé€šè¿‡ `reduce` ä¾æ¬¡è°ƒç”¨ `css-loader` æ›¿æ¢æ ·å¼ [[æŸ¥çœ‹](#compose-ç”¨æŸ¯é‡ŒåŒ–çš„æ–¹å¼æ‹å¹³ä¸€ç»„å‡½æ•°)]

> åœ¨è¿™é‡Œ `replace` ä¼šä¼˜å…ˆäº `css-loader` æ‰§è¡Œæ›¿æ¢

`getCssLoader` è°ƒç”¨åœºæ™¯ï¼š

- `processCssLoaderForTemplate`ï¼šå¤„ç†æ‰‹åŠ¨æ·»åŠ æ ·å¼ [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)]
- `rewriteAppendOrInsertChild`ï¼šå¤„ç†åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„å†…è”å’Œå¤–è”æ ·å¼ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

> `getCssLoader` æ—¶ `replace` ä¼šæ ¹æ®é…ç½®ç»‘å®šåœ¨å®ä¾‹ï¼Œå› ä¸ºä¸Šè¿°æ–¹æ³•éƒ½åœ¨åº”ç”¨ `active` ä¹‹åè°ƒç”¨

`processCssLoaderForTemplate` æ¥è‡ªæ¿€æ´»åº”ç”¨æ—¶æ¸²æŸ“å®¹å™¨ï¼Œè§ï¼šåˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]

- `renderTemplateToShadowRoot` [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]
- `renderTemplateToIframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe-å®¹å™¨)]

`rewriteAppendOrInsertChild` ä¼šé€šè¿‡ `patchRenderEffect` é‡å†™æ–¹æ³• [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

- `patchRenderEffect` åŒæ ·æ¥è‡ª `active` æ¿€æ´»åº”ç”¨æ—¶æ¸²æŸ“å®¹å™¨ï¼Œè§ï¼šåˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]
- ä½†æ˜¯æ‹¦æˆªåŠ¨æ€æ ·å¼æ˜¯åœ¨ `start` å¯åŠ¨åº”ç”¨æ—¶æ³¨å…¥ `script` åˆ°æ²™ç®±ä¹‹å [[æŸ¥çœ‹](#2-æ‰§è¡Œé˜Ÿåˆ—)]

> `replace` çš„å‚æ•°åªæœ‰ `code`ï¼Œæ‹¿ä¸åˆ°èµ„æºç±»å‹ï¼Œåªèƒ½æ ¹æ®å…·ä½“ä»£ç è¿›è¡Œæ›¿æ¢ï¼Œå¦‚æœéœ€è¦æ›´å¤šçš„ä¿¡æ¯ï¼Œå»ºè®®é€šè¿‡ `css-loader` æˆ– `js-loader`

`getJsLoader` æŸ¯é‡ŒåŒ–å¤„ç†è¿è¡Œæ—¶çš„ `script`ï¼š

- æ‰§è¡Œæ–¹å¼å’Œ `getCssLoader` æ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€çš„ä¸åŒæ˜¯æå– `plugins` çš„å±æ€§å
- æŸ¯é‡ŒåŒ–åä¼ é€’ `replace` æ›¿æ¢çš„èµ„æºï¼Œé€šè¿‡ `compose` å°†æ‹¿åˆ°çš„èµ„æºä¾æ¬¡è°ƒç”¨ `jsLoader` [[æŸ¥çœ‹](#compose-ç”¨æŸ¯é‡ŒåŒ–çš„æ–¹å¼æ‹å¹³ä¸€ç»„å‡½æ•°)]

> åœ¨è¿™é‡Œ `replace` ä¼šä¼˜å…ˆäº `js-loader` æ‰§è¡Œæ›¿æ¢

`getJsLoader` åªèƒ½é€šè¿‡ `insertScriptToIframe` è°ƒç”¨ï¼Œåˆ†åˆ«æ¥è‡ªä»¥ä¸‹åœºæ™¯ [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]ï¼š

- `start` å¯åŠ¨åº”ç”¨ï¼šæ‰‹åŠ¨æ·»åŠ  `script`ã€åº”ç”¨å†…é™æ€ `script`ï¼ˆå«å…¥å£æ–‡ä»¶ï¼‰[[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
- `rewriteAppendOrInsertChild`ï¼šåº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„ `script`ï¼ŒåŒ…æ‹¬ `chunk script`

> åº”ç”¨å†…åŠ¨æ€æ·»åŠ çš„æ ·å¼å’Œ `script`ï¼Œä¼šå…ˆæ³¨å…¥é™æ€ `script` åˆ°æ²™ç®±åï¼Œç„¶åå†æ‹¦æˆªåŠ¨æ€æ·»åŠ çš„æ ·å¼å’Œ `script`ï¼Œåœ¨å•ä¾‹åº”ç”¨ä¸­é€šå¸¸å°†å…¥å£ `script` æ³¨å…¥åï¼Œè¿›è¡ŒåŠ¨æ€æ‹¦æˆª

### è¾…åŠ©æ–¹æ³• - å®¹å™¨æ¸²æŸ“

å›´ç»•åº”ç”¨çš„æ¸²æŸ“å®¹å™¨å½’çº³ç›¸å…³çš„æ–¹æ³•ï¼ŒåŒ…å«ï¼š`shadowRoot` å®¹å™¨ã€`iframe` å®¹å™¨ä»¥åŠåŠ«æŒå®¹å™¨

#### åˆ›å»º `iframe` å®¹å™¨

åˆ† 2 éƒ¨åˆ†ï¼šåˆ›å»º `iframe` å®¹å™¨å’ŒæŒ‚è½½å®¹å™¨

**åˆ›å»º `iframe` å®¹å™¨ï¼š**

| åˆ†ç±»     | `iframe` å®¹å™¨                                                                                                                                                     | åŠ«æŒå®¹å™¨                                                                                                                                     |
| -------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- |
| åˆ›å»ºæ–¹æ³• | `createIframeContainer`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L238)] | `renderIframeReplaceApp` [[æŸ¥çœ‹](#renderiframereplaceappåŠ è½½-iframe-æ›¿æ¢å­åº”ç”¨)]                                                             |
| åˆ›å»ºæ–¹å¼ | `document.createElement("iframe");`                                                                                                                               | `window.document.createElement("iframe")`                                                                                                    |
| é»˜è®¤æ ·å¼ | `height:100%;width:100%`                                                                                                                                          | `height:100%;width:100%`                                                                                                                     |
| è®¾ç½®å±æ€§ | è‡ªå®šä¹‰å±æ€§ã€æ ·å¼ã€`flag_id`                                                                                                                                       | è‡ªå®šä¹‰å±æ€§ã€æ ·å¼ã€`src`                                                                                                                      |
| æ‰§è¡Œç»“æœ | è¿”å› `iframe` å®¹å™¨                                                                                                                                                | å°†åŠ«æŒå®¹å™¨æ¸²æŸ“åˆ° `el` æŒ‚è½½èŠ‚ç‚¹                                                                                                               |
| è°ƒç”¨åœºæ™¯ | `initRenderIframeAndContainer`ï¼Œç»§ç»­å¾€ä¸‹çœ‹                                                                                                                        | `locationHrefSet` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]ã€`processAppForHrefJump` [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)] |

ä¸ºä»€ä¹ˆè¦æ”¾åˆ°ä¸€èµ·æ€»ç»“ï¼Ÿ

- å› ä¸ºä½œä¸ºå®¹å™¨å®ƒä»¬åªæ˜¯è°ƒç”¨åœºæ™¯ä¸ä¸€æ ·ï¼Œä½†åˆ›å»ºçš„æ–¹å¼æ˜¯ä¸€æ ·çš„
- ä»è¿™ç‚¹ä¹Ÿèƒ½çœ‹å‡ºæ¥ `wujie` çš„æºç ç›¸å¯¹ä¼š `micro-app` é›¶æ•£å¾ˆå¤š [[æŸ¥çœ‹](#2-é‡å¤æå–æ ·å¼çš„-bug)]

**`initRenderIframeAndContainer` æŒ‚è½½å®¹å™¨åˆ°æŒ‡å®šèŠ‚ç‚¹**

ç›®å½•ï¼š`shadow.ts` - `initRenderIframeAndContainer` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L92)]

å‚æ•°ï¼š

- `id`ï¼šåº”ç”¨åï¼Œé€ä¼ ç»™ `createIframeContainer` ç”¨äºç»™å®¹å™¨æ·»åŠ å±æ€§
- `parent`ï¼šæŒ‚è½½èŠ‚ç‚¹ï¼Œç”¨äºæŒ‚è½½å®¹å™¨ï¼Œæ¥è‡ªé…ç½® `el`
- `degradeAttrs`ï¼š`iframe` å±æ€§ [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]

æµç¨‹ï¼š

- ä½¿ç”¨ `id` å’Œ `degradeAttrs`ï¼Œé€šè¿‡ `createIframeContainer` åˆ›å»º `iframe` å®¹å™¨
- é€šè¿‡ `renderElementToContainer` æŒ‚è½½å®¹å™¨åˆ°æŒ‡å®šèŠ‚ç‚¹ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]
- æ‹¿åˆ° `iframe` å®¹å™¨çš„ `document`ï¼Œå¹¶å†™å…¥ç©ºç™½ `html`
- å°† `iframe` å®¹å™¨å’ŒæŒ‚è½½èŠ‚ç‚¹éƒ½è¿”å›

> `renderIframeReplaceApp` ä¹Ÿæ˜¯é€šè¿‡ `renderElementToContainer` å°†åŠ«æŒå®¹å™¨æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ï¼ŒæŒ‚è½½å‰ `renderElementToContainer` ä¼šæ¸…ç©ºæŒ‚è½½èŠ‚ç‚¹ï¼Œè¿™æ ·å°±å®Œæˆäº†åŠ«æŒå®¹å™¨æ›¿æ¢æ¸²æŸ“å®¹å™¨çš„è¿‡ç¨‹

è°ƒç”¨åœºæ™¯ï¼š

- `active` æ¿€æ´»åº”ç”¨ï¼š`degrade` é™çº§æ—¶åˆ›å»ºå®¹å™¨ [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]
- `processAppForHrefJump` ç›‘å¬åé€€æ“ä½œï¼šç”¨é™çº§çš„ `iframe` å®¹å™¨æ›¿æ¢åŠ«æŒå®¹å™¨ [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

> ä¸Šè¿°åœºæ™¯ä¼šå…ˆé€šè¿‡ `initRenderIframeAndContainer` åˆ›å»ºç©ºç™½å®¹å™¨ï¼Œä¹‹åå†æ³¨å…¥èµ„æº

#### `renderElementToContainer`ï¼šå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨

ç›®å½•ï¼š`shadow.ts` - `renderElementToContainer` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L70)]

å‚æ•°ï¼š

- `element`ï¼šæŒ‚è½½çš„èŠ‚ç‚¹ï¼Œç±»å‹ï¼š`Element | ChildNode`
- `selectorOrElement`ï¼šå®¹å™¨ï¼Œç±»å‹ï¼š`string | HTMLElement`

> è‹¥ `selectorOrElement` æä¾›å­—ç¬¦ä¼šé€šè¿‡ `document.querySelector` æŸ¥æ‰¾å…ƒç´ ï¼Œç›®å‰æ²¡æœ‰ç”¨åˆ°

æµç¨‹ï¼š

- ä½¿ç”¨ `selectorOrElement` é€šè¿‡ `getContainer` å®šä½åˆ°å®¹å™¨ `container`
- å¦‚æœ `container` å­˜åœ¨ï¼Œä¸”ä¸åŒ…å«æä¾›çš„ `element`ï¼Œå°†å…¶æ·»åŠ åˆ° `container`
- è¿”å›å®šä½çš„å®¹å™¨ `container`

> ä¸Šé¢å·²è¯´æ˜ç›®å‰ `selectorOrElement` åªæä¾› `HTMLElement`ï¼Œæ‰€ä»¥ `container` å¿…é¡»å­˜åœ¨

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

- ä¸å­˜åœ¨ `LOADING_DATA_FLAG` èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼ŒæŒ‚è½½å‰éœ€è¦é€šè¿‡ `clearChild` æ¸…ç©ºå®¹å™¨

ä»€ä¹ˆæ—¶å€™ä¼šæä¾› `LOADING_DATA_FLAG`ï¼š

- `startApp` å¯åŠ¨åº”ç”¨æ—¶é€šè¿‡ `addLoading` è®¾ç½®ï¼Œè§ï¼šå¯åŠ¨åº”ç”¨æ—¶æ·»åŠ ã€åˆ é™¤ `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]

> `addLoading` æ—¶å®¹å™¨å°±å·²æ¸…ç©ºï¼Œä¹‹åä¸å†éœ€è¦æ¸…ç©ºï¼Œåªéœ€è¦æ ¹æ®æƒ…å†µåˆ é™¤ `loading` çŠ¶æ€

è°ƒç”¨åœºæ™¯ï¼š

- `renderIframeReplaceApp`ï¼šåŠ«æŒ `url` åˆ›å»º `iframe` æ›¿æ¢å®¹å™¨ [[æŸ¥çœ‹](#renderiframereplaceappåŠ è½½-iframe-æ›¿æ¢å­åº”ç”¨)]
- `locationHrefSet`ï¼šé™çº§å¤„ç†æ—¶å°† `iframe` å®¹å™¨çš„ `html` æ·»åŠ åˆ°æ²™ç®± `body` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]
- `active` æ¿€æ´»åº”ç”¨æ—¶ï¼Œå°† `shadowRoot` æ·»åŠ åˆ°æŒ‚è½½èŠ‚ç‚¹ [[æŸ¥çœ‹](#42-æŒ‚è½½å­åº”ç”¨åˆ‡æ¢åˆå§‹åŒ–é¢„åŠ è½½)]
- `initRenderIframeAndContainer`ï¼šåˆ›å»º `iframe` å®¹å™¨æ·»åŠ åˆ°æŒ‚è½½ç‚¹ [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]
- `processAppForHrefJump` ç›‘å¬åé€€æ“ä½œï¼šç”¨ `shadowRoot` å®¹å™¨æ›¿æ¢åŠ«æŒå®¹å™¨ [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

#### `renderTemplateToIframe` æ¸²æŸ“èµ„æºåˆ° `iframe` å®¹å™¨

ç›®å½•ï¼š`shadow.ts` - `renderTemplateToIframe` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L252)]

å‚æ•°ï¼š

- `renderDocument`ï¼šé™çº§ `iframe` å®¹å™¨çš„ `document`
- `iframeWindow`ï¼šæ²™ç®±çš„ `window`
- `template`ï¼šé€šè¿‡ `active` é€ä¼ è¿‡æ¥çš„åº”ç”¨å…¥å£èµ„æº [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]

è°ƒç”¨åœºæ™¯å…¨éƒ¨æ¥è‡ª `degrade` é™çº§ä¸‹ `active` æ¿€æ´»åº”ç”¨ [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]

- é¦–æ¬¡ `aclive`ï¼šå°†åº”ç”¨èµ„æºæ³¨å…¥ `iframe` å®¹å™¨
- é `alive` æ¨¡å¼å†æ¿€æ´»ï¼šåŒé¦–æ¬¡æ¿€æ´»ä¸€æ ·ï¼Œæ¯æ¬¡æ¿€æ´»éƒ½ä¼šæ–°å»º `iframe` å®¹å™¨

> `umd` å†æ¬¡æ¿€æ´»æ—¶ï¼Œä½¿ç”¨çš„ `template` æ¥è‡ªé¦–æ¬¡ `active` ç»‘å®šåœ¨å®ä¾‹çš„èµ„æº

`alive` å†æ¬¡æ¿€æ´»ä¸ä¼šç”¨åˆ° `renderTemplateToIframe`ï¼š

- å°†é€šè¿‡å®ä¾‹çš„ `document` å°†é¦–æ¬¡æ³¨å…¥å®¹å™¨çš„ `html` å…ƒç´ ï¼Œ`replace` æ–°å®¹å™¨ä¸­çš„ `html` å…ƒç´ 

æµç¨‹å’Œ `renderTemplateToShadowRoot` ä¸€æ · [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]

#### `renderTemplateToShadowRoot` æ¸²æŸ“èµ„æºåˆ° `shadowRoot`

ç›®å½•ï¼š`shadow.ts` - `renderTemplateToShadowRoot` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L212)]

å‚æ•°ï¼š

- `shadowRoot`ï¼šæ³¨å…¥çš„å®¹å™¨
- `iframeWindow`ï¼šæ²™ç®±çš„ `window`
- `template`ï¼šé€šè¿‡ `active` é€ä¼ è¿‡æ¥çš„åº”ç”¨å…¥å£èµ„æº [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]

è°ƒç”¨åœºæ™¯

- æ¥è‡ªé `degrade` é™çº§ä¸‹ `active` æ¿€æ´»åº”ç”¨ [[æŸ¥çœ‹](#42-æŒ‚è½½å­åº”ç”¨åˆ‡æ¢åˆå§‹åŒ–é¢„åŠ è½½)]

æ‰€æœ‰æ¨¡å¼é¦–æ¬¡æ¿€æ´»éƒ½ä¼šå°† `template` æ³¨å…¥ `shadowRoot`ï¼Œå†æ¬¡æ¿€æ´»è§„åˆ™å¦‚ä¸‹ï¼š

- `aclive` æ¨¡å¼ï¼šåˆ‡æ¢å®¹å™¨æŒ‚åœ¨ç‚¹ï¼Œä¸é‡æ–°æ³¨å…¥èµ„æº
- `umd` æ¨¡å¼ï¼šæ¿€æ´»åº”ç”¨å‰ä¼šæ¸…ç©º `shadowRoot`ï¼Œæ¿€æ´»æ—¶é‡æ–°æ³¨å…¥ `template`
- é‡å»ºæ¨¡å¼ï¼šé”€æ¯é‡å»ºåº”ç”¨å®ä¾‹ï¼Œæ¯æ¬¡æ¿€æ´»éƒ½ä¼šæ³¨å…¥ `template`

`alive` å†æ¬¡æ¿€æ´»ä¸ä¼šç”¨åˆ° `renderTemplateToShadowRoot`ï¼š

- å®¹å™¨ä¼šç»‘å®šåœ¨å®ä¾‹å±æ€§ `shadowRoot` ä¸­ï¼Œå†æ¬¡æ¿€æ´»ç›´æ¥æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ `el`

æµç¨‹å’Œ `renderTemplateToIframe` ä¸€æ ·ï¼š

| åˆ†ç±»                                                                             | `renderTemplateToIframe` | `renderTemplateToShadowRoot` |
| -------------------------------------------------------------------------------- | ------------------------ | ---------------------------- |
| `renderTemplateToHtml` [[æŸ¥çœ‹](#rendertemplatetohtmlæ¸²æŸ“-template-ä¸º-html-å…ƒç´ )] | åˆ›å»º `html` å…ƒç´          | åˆ›å»º `html` å…ƒç´              |
| `processCssLoaderForTemplate` [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)] | æ‰‹åŠ¨æ·»åŠ æ ·å¼             | æ‰‹åŠ¨æ·»åŠ æ ·å¼                 |
| æ³¨å…¥ `html`                                                                      | æ›¿æ¢å®¹å™¨ `html` å…ƒç´      | `appendChild` åˆ°å®¹å™¨         |
| ä¿®å¤ `parentNode`                                                                | éœ€è¦                     | éœ€è¦                         |
| `patchRenderEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]                    | ç»™å®¹å™¨æ‰“è¡¥ä¸             | ç»™å®¹å™¨æ‰“è¡¥ä¸                 |

å¦‚ä½•ä¿®å¤ `parentNode`ï¼š

- é€šè¿‡ `Object.defineProperty` åŠ«æŒå®¹å™¨ `html` å…ƒç´ çš„ `parentNode`ï¼ŒæŒ‡å‘æ²™ç®± `document`

ä¸åŒåœ¨äºï¼š

| åˆ†ç±»           | `renderTemplateToIframe` | `renderTemplateToShadowRoot`   |
| -------------- | ------------------------ | ------------------------------ |
| å®¹å™¨æ ¹èŠ‚ç‚¹     | `iframe.document`        | `shadowRoot`                   |
| æŒ‡å‘å®ä¾‹å±æ€§   | `this.document`          | `this.shadowRoot`              |
| å®¹å™¨ `head`    | `this.document.head`     | `this.shadowRoot.head`         |
| å®¹å™¨ `body`    | `this.document.body`     | `this.shadowRoot.body`         |
| é®ç½©å±‚ `shade` | ä¸æ”¯æŒ                   | ä½œä¸ºåœ¨å®¹å™¨ `html` ç¬¬ä¸€ä¸ªå­å…ƒç´  |

> å› æ­¤ `patchRenderEffect` æ‰“è¡¥ä¸çš„å®¹å™¨å¯¹è±¡ä¹Ÿä¸ä¸€æ · [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

å…³äº `head`ã€`body`ï¼š

- å®¹å™¨çš„ `head`ã€`body` ä¸»è¦ç”¨äºå®¹å™¨äº‹ä»¶ã€å…ƒç´ æ“ä½œçš„ä»£ç†å’ŒåŠ«æŒ
- é™¤æ­¤ä¹‹å¤–æ— è®ºæ˜¯ `iframe` è¿˜æ˜¯ `shadowRoot`ï¼Œéƒ½æœ‰ä¸€ä¸ªå®ä¾‹çš„ `head`ã€`body`ï¼Œç”¨äºæ¸²æŸ“å­åº”ç”¨çš„ `template`ï¼Œè§ï¼š`renderTemplateToHtml` [[æŸ¥çœ‹](#rendertemplatetohtmlæ¸²æŸ“-template-ä¸º-html-å…ƒç´ )]

é®ç½©å±‚ `shade`ï¼š

- åœ¨å®¹å™¨ä¸­ä¸å¯è§ï¼Œä¸ºäº†æ’‘å¼€å®¹å™¨ç”¨æ¥å±•ç¤ºåº”ç”¨ä¸­çš„å¼¹çª—å’Œæµ®å±‚ï¼Œå°†ä½œä¸º `html` èŠ‚ç‚¹ä¸‹ç¬¬ 1 ä¸ªå…ƒç´ 
- ç”±äºåœ¨ `iframe` å®¹å™¨ä¸­æ— æ³•æ’‘å¼€å®¹å™¨åŒºåŸŸï¼Œæ‰€ä»¥ä»…é™ `shadowRoot`

#### `renderTemplateToHtml`ï¼šæ¸²æŸ“ `template` ä¸º `html` å…ƒç´ 

ç›®å½•ï¼š`shadow.ts` - `renderTemplateToHtml` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L176)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window`
- `template`ï¼šé€šè¿‡ `active` é€ä¼ è¿‡æ¥çš„åº”ç”¨å…¥å£èµ„æº [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]

è¿”å›ï¼š

- å®Œæˆæ¸²æŸ“å¹¶æ›´æ–°èµ„æºçš„ `html` å…ƒç´ 

è°ƒç”¨åœºæ™¯ï¼š

- `renderTemplateToShadowRoot` [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]
- `renderTemplateToIframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe-å®¹å™¨)]

åšäº† 3 ä»¶äº‹ï¼š

- é€šè¿‡æ²™ç®± `document` åˆ›å»ºä¸€ä¸ª `html` å…ƒç´ ï¼Œå¹¶å°† `template` ä½œä¸º `innerHTML`
- éå† `html` ä¸‹æ‰€æœ‰å¯è§å…ƒç´ ï¼Œé€šè¿‡ `patchElementEffect` ä¸ºæ¯ä¸ªå…ƒç´ æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]
- è·å–æ‰€æœ‰ `a`ã€`img`ã€`source` å…ƒç´ ï¼Œä¿®æ­£èµ„æºç›¸å¯¹è·¯å¾„

ä¼˜åŒ– `umd` æ¨¡å¼åŠ è½½çš„åº”ç”¨ï¼Œå°†`head` å’Œ `body`ç»‘å®šåœ¨åº”ç”¨å®ä¾‹ä¸­ï¼š

- ç»„ä»¶å¤šæ¬¡æ¸²æŸ“ï¼Œ`head` å’Œ `body` å¿…é¡»ä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªæ¥åº”å¯¹è¢«ç¼“å­˜çš„åœºæ™¯ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰
- åˆæ¬¡å£°æ˜èŠ‚ç‚¹ä¼šç»‘å®šåˆ°åº”ç”¨å®ä¾‹ï¼Œå†æ¬¡è°ƒç”¨ `renderTemplateToHtml`ï¼Œå°†é€šè¿‡ `replaceHeadAndBody` æ¢å¤æœ€åˆè®°å½•çš„èŠ‚ç‚¹åˆ° `html` å…ƒç´ 

åœ¨æœ«å°¾å¯èƒ½æ˜¯æ‹…å¿ƒä¸å­˜åœ¨ `head` æˆ– `body` çš„æƒ…å†µè¿›è¡Œäº†è¡¥å…¨ï¼š

- ä½†ç›®å‰æ¥çœ‹ä¼¼ä¹åšäº†å¤šä½™çš„å·¥ä½œ
- ä¸º `html` å…ƒç´ è®¾ç½® `innerHTML` æ—¶å€™ï¼Œä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨è¡¥å…¨ `head` å’Œ `body`
- å¹¶ä¸”ä¼šä¸¢å¼ƒå¤–éƒ¨åŒ…è£¹çš„ `html` æ ¹å…ƒç´ åŠå…¶å®ƒç›¸å…³å£°æ˜

> ç”¨ `code` åšäº†ä¸€ä¸ªé™æ€çš„èµ„æºè¡¥å…¨çš„æ¼”ç¤º [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/JjQpQbb)]

ä¿®æ­£ç›¸å¯¹è·¯å¾„çš„ç»†èŠ‚ï¼š

- é€šè¿‡ `patchElementEffect` ä¸ºéå†ä¸­æ¯ä¸€ä¸ªå¯è§å…ƒç´ æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]
- é€šè¿‡ `relativeElementTagAttrMap` æ‹¿åˆ°èµ„æºå±æ€§ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L185)]

åªæœ‰å½“å…ƒç´ å­˜åœ¨èµ„æºå±æ€§æ—¶æ‰ä¼šé€šè¿‡ `getAbsolutePath` è½¬æ¢èµ„æºè·¯å¾„ [[æŸ¥çœ‹](#getabsolutepathè·å–ç»å¯¹è·¯å¾„)]

æœ‰ 2 ç§æƒ…å†µï¼š

- ç»å¯¹è·¯å¾„ï¼šåŸå°ä¸åŠ¨è¿”å›ç»å¯¹è·¯å¾„
- ç›¸å¯¹è·¯å¾„ï¼šè¿”å›ï¼š`baseUrl/ç›¸å¯¹è·¯å¾„`

> `baseUrl` é€šè¿‡ `patchElementEffect` å¤„ç†æŒ‡å‘ `proxyLocation`ï¼š`origin` + `pathname` [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]

å®¹å™¨ä¸­æ‰€æœ‰å…ƒç´ éƒ½é€šè¿‡æ²™ç®± `document` åˆ›å»ºï¼Œå› ä¸ºï¼š

- é€šè¿‡æ²™ç®± `window` è·å–åº”ç”¨å®ä¾‹ï¼Œä»¥ä¾¿åšå‡ºå¯¹åº”æ“ä½œï¼Œä¾‹å¦‚ï¼šè®°å½• `head` å’Œ `body`
- `patchElementEffect` é€šè¿‡æ²™ç®±çš„ `window` ä¸ºæ¯ä¸ªå…ƒç´ æ‰“è¡¥ä¸

#### `processCssLoaderForTemplate`ï¼šæ‰‹åŠ¨æ·»åŠ æ ·å¼

ç›®å½•ï¼š`shadow.ts` - `processCssLoaderForTemplate` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L109)]

å‚æ•°ï¼š

- `sandbox`ï¼šåº”ç”¨å®ä¾‹ï¼Œä½œç”¨ï¼šâ‘  è·å–æ²™ç®± `document` åˆ›å»ºå…ƒç´ ï¼›â‘¡ ä¸ºåŠ è½½æ ·å¼é€ä¼ å®ä¾‹å±æ€§
- `html`ï¼šç”± `renderTemplateToHtml` æ¸²æŸ“çš„ `html` å…ƒç´  [[æŸ¥çœ‹](#rendertemplatetohtmlæ¸²æŸ“-template-ä¸º-html-å…ƒç´ )]

> æ ·å¼é€šè¿‡ `getExternalStyleSheets` åŠ è½½ï¼Œéœ€è¦çš„å‚æ•°ä¹Ÿç»‘å®šåœ¨å®ä¾‹å±æ€§ä¸­ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]

è¿”å›ï¼š

- å°†æ›´æ–°åçš„ `html` å…ƒç´ ä½œä¸º `Promise` è¿”å›ï¼Œæ— è®ºæ˜¯ `resolve` æˆåŠŸï¼Œè¿˜æ˜¯ `reject` æ‹’ç»

å…ˆæå– 3 ç»„ `plugins`ï¼š

- `cssLoader`ï¼šç”¨äºæ¯æ¡æ ·å¼åŠ è½½æˆåŠŸåè‡ªå®šä¹‰å¤„ç†ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-loader)]
- `cssBeforeLoaders`ï¼šæ’å…¥åº”ç”¨å®¹å™¨ `head` å¤´éƒ¨çš„æ ·å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-before-loaders)]
- `cssAfterLoaders`ï¼šæ’å…¥åº”ç”¨å®¹å™¨ `body` å°¾éƒ¨çš„æ ·å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-after-loaders)]

> å…¶ä¸­ `cssLoader` é€šè¿‡ `getCssLoader` æŸ¯é‡ŒåŒ–è¿”å›å‡½æ•°ï¼Œè§ï¼šé€šè¿‡é…ç½®æ›¿æ¢èµ„æº [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]

å…¶ä¸­ `cssLoader` å’Œ `cssBeforeLoaders` ä¼šåœ¨åº”ç”¨å®ä¾‹åˆå§‹åŒ–æ—¶æ·»åŠ  2 ä¸ªé»˜è®¤çš„ `plugin`ï¼š

- è§ï¼šæå–é…ç½®åˆå§‹åŒ–å±æ€§ [[æŸ¥çœ‹](#2-æå–é…ç½®åˆå§‹åŒ–å±æ€§)]

é™¤æ­¤ä¹‹å¤–ï¼š

- ä»å®ä¾‹ä¸­è·å– `proxyLocation`ï¼Œé€šè¿‡ `getCurUrl` æ‹¿åˆ°åº”ç”¨ `origin` + `pathname` ä½œä¸ºåº”ç”¨å…¥å£é“¾æ¥
- åœ¨ `cssLoader` ä¸­éœ€è¦æä¾›ï¼šåŠ è½½çš„æ ·å¼å†…å®¹ã€æ ·å¼çš„é“¾æ¥ï¼Œåº”ç”¨å…¥å£é“¾æ¥

æå–æ ·å¼çš„æ­¥éª¤å’Œ `processCssLoader` æå–åº”ç”¨é™æ€æ ·å¼ä¸€æ · [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]

- é€šè¿‡ `getExternalStyleSheets` ä¸ºæ¯ä¸ªæ‰‹åŠ¨æ ·å¼æ·»åŠ ä¸€ä¸ª `Promise` å¯¹è±¡ `contentPromise`
- é€šè¿‡ `Promis.all` åŠ è½½æ‰€æœ‰ `contentPromise`ï¼Œæå–åˆ—è¡¨ä¸­æ¯ä¸€é¡¹ `src`ã€`content`
- éå†åŠ è½½åçš„åˆ—è¡¨ï¼Œåˆ›å»ºä¸€ä¸ªå†…è”æ ·å¼ï¼Œé€šè¿‡ `cssLoader` æ›¿æ¢æ ·å¼åï¼Œä½œä¸ºå†…è”æ ·å¼å†…å®¹
- æ ¹æ®åŠ è½½çš„æ ·å¼ç±»å‹å†³å®šå°†æ ·å¼æ’å…¥ `head` å¤´éƒ¨ï¼Œè¿˜æ˜¯ `body` å°¾éƒ¨
- é€šè¿‡ `Promise.all` å°†æœ€ç»ˆå¤„ç†çš„ `html` å…ƒç´ è¿”å›

æ‰‹åŠ¨æ·»åŠ æ ·å¼å…ƒç´ å¿˜è®°é€šè¿‡ `patchElementEffect` æ‰“è¡¥ä¸äº† [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]

- åŸå› åº”è¯¥æ˜¯ï¼šæ‰‹åŠ¨æ·»åŠ çš„æ ·å¼ï¼Œåœ¨å­åº”ç”¨ä¸­ä¸ä¼šåŒ¹é…åšç›¸åº”æ“ä½œ

åº”ç”¨ä¸­çš„å…ƒç´ å¦‚ä½•æ‰“è¡¥ä¸ï¼š

- `renderTemplateToHtml`ï¼šä¸ºåº”ç”¨ä¸­æå–çš„é™æ€èµ„æºæ‰“è¡¥ä¸ [[æŸ¥çœ‹](#rendertemplatetohtmlæ¸²æŸ“-template-ä¸º-html-å…ƒç´ )]
- `rewriteAppendOrInsertChild`ï¼šä¸ºåº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„å…ƒç´ æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

#### å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ ã€åˆ é™¤ `loading`

ç›®å½•ï¼š

- `shadow.ts` - `addLoading` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L286)]
- `shadow.ts` - `removeLoading` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L321)]

**`addLoading` æ·»åŠ  `loading`**

å‚æ•°ï¼š

- `el`ï¼šæŒ‚è½½å®¹å™¨çš„èŠ‚ç‚¹ï¼Œé…ç½®æ—¶æä¾›
- `loading`ï¼šåŠ è½½çŠ¶æ€çš„ `HTMLElement`ï¼Œé…ç½®æ—¶æä¾›ï¼Œåº”è¯¥æ˜¯å¯é€‰ç±»å‹

> `wujie` çš„ `tsconfig.json` å¹¶æ²¡æŒ‰ç…§ä¸¥æ ¼æ¥ç”³æ˜ï¼Œå¾ˆå¤šç±»å‹ä¸å¤ªæ­£ç¡®

è°ƒç”¨åœºæ™¯ï¼š

- `startApp` å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)]

ç”¨é€”ï¼š

- æ¸…ç©ºæŒ‚è½½èŠ‚ç‚¹ã€ç»™èŠ‚ç‚¹ä¸­æ·»åŠ  `loading` å…ƒç´ 

æµç¨‹ï¼š

- é€šè¿‡ `getContainer` æ ¹æ® `el` è·å–æŒ‚è½½èŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨ `clearChild` æ¸…ç©ºèŠ‚ç‚¹
- é€šè¿‡ `getComputedStyle` è·å–å½“å‰æŒ‚è½½èŠ‚ç‚¹çš„æ ·å¼ï¼Œæ ¹æ®æ ·å¼æ›´æ–°èŠ‚ç‚¹ï¼šå®šä½ã€`overflow`ã€å±æ€§
- åˆ›å»ºä¸€ä¸ª `loading` å…ƒç´ æ·»åŠ åˆ°æŒ‚è½½èŠ‚ç‚¹é‡Œ

æ ¹æ®æŒ‚è½½èŠ‚ç‚¹çš„ `position` æ‰§è¡Œä¸åŒçš„æ“ä½œï¼š

| è¡Œä¸º            | `static`                            | `relative`ã€`sticky`                |
| --------------- | ----------------------------------- | ----------------------------------- |
| è®°å½• `position` | æ ‡ç­¾ `CONTAINER_POSITION_DATA_FLAG` | ä¸è®°å½•                              |
| è®°å½• `overflow` | æ ‡ç­¾ `CONTAINER_OVERFLOW_DATA_FLAG` | æ ‡ç­¾ `CONTAINER_OVERFLOW_DATA_FLAG` |
| æ›´æ–° `position` | `relative`                          | ä¸æ›´æ–°                              |
| æ›´æ–° `overflow` | `hidden`                            | `hidden`                            |

> å…¶å®ƒ `position` çŠ¶æ€ä¸åšå¤„ç†

åˆ›å»º `loadingContainer` å…ƒç´ ï¼š

- ä½œä¸º `loading` çˆ¶èŠ‚ç‚¹ï¼Œæ·»åŠ æ ·å¼ `position` ä¸º `absolute`ï¼Œå±…ä¸­å±•ç¤º
- æ·»åŠ æ ‡ç­¾ `LOADING_DATA_FLAG`ï¼Œé¿å…æ¿€æ´»åº”ç”¨æ—¶é€šè¿‡ `renderElementToContainer` æ¸…ç©ºæŒ‚è½½ç‚¹ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]
- å°†å‚æ•° `loading` æ·»åŠ åˆ° `loadingContainer`ï¼Œæ²¡æœ‰å°±ä½¿ç”¨é»˜è®¤çš„ `svg`ï¼Œä¹‹åå°†æ•´ä¸ªå…ƒç´ æ·»åŠ åˆ°æŒ‚è½½èŠ‚ç‚¹

æ­¤æ—¶çš„ `loading` æ˜¯ä¸å¯è§çš„ï¼š

- å› ä¸ºçˆ¶çº§çš„ `position` ä¸æ˜¯ `static`ï¼Œä¸” `overflow` ä¼šéšè—å­é›†ï¼Œè‡ªèº«åˆæ²¡æœ‰é«˜åº¦
- å­é›†åªæœ‰ä¸€ä¸ª `absolute` çš„ `loadingContainer` æ— æ³•æ’‘å¼€æŒ‚è½½èŠ‚ç‚¹çš„é«˜åº¦

ä»€ä¹ˆæ—¶å€™å¯è§ï¼š

- `active` æ¿€æ´»åº”ç”¨æ—¶ï¼Œé€šè¿‡ `renderTemplateToShadowRoot` æˆ– `renderTemplateToIframe`ï¼Œå°†å®¹å™¨æ·»åŠ åˆ°æŒ‚è½½èŠ‚ç‚¹æ’‘å¼€èŠ‚ç‚¹é«˜åº¦æ—¶ [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]

åœ¨å“ªæ¸…é™¤ï¼š

- åªèƒ½é€šè¿‡ `removeLoading`ï¼Œç»§ç»­å¾€ä¸‹çœ‹

**`removeLoading` åˆ é™¤ `loading`**

å‚æ•°ï¼š

- `el`ï¼šæŒ‚è½½å®¹å™¨çš„èŠ‚ç‚¹ï¼Œé…ç½®æ—¶æä¾›

åšäº† 3 ä»¶äº‹ï¼š

- æ ¹æ®æ·»åŠ çš„æ ‡ç­¾è¿˜åŸ `position` å’Œ `overflow`
- åˆ é™¤æ·»åŠ çš„æ ‡ç­¾ï¼š`CONTAINER_POSITION_DATA_FLAG`ã€`CONTAINER_OVERFLOW_DATA_FLAG`
- åˆ é™¤ `loadingContainer` å…ƒç´ 

è°ƒç”¨åœºæ™¯ï¼š

- `start` å¯åŠ¨åº”ç”¨ï¼Œè§ï¼šé˜Ÿåˆ—å‰çš„å‡†å¤‡ [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]
- `mount` æŒ‚è½½åº”ç”¨æ—¶ [[æŸ¥çœ‹](#1-umd-æ–¹å¼å¯åŠ¨)]

è§„åˆ™ï¼š

- `alive` å’Œ `umd` åªæœ‰åˆæ¬¡åŠ è½½ä¼šè°ƒç”¨ `start`ï¼Œé‡å»ºæ¨¡å¼æ¯æ¬¡å¯åŠ¨éƒ½ä¼š `start`
- `mount` ä¹Ÿå¿…é¡»æ˜¯é€šè¿‡ `start` å‘èµ·æŒ‚è½½ï¼Œä¸”ä»…é™ `umd` åˆæ¬¡å¯åŠ¨

> `umd` æ¨¡å¼åˆæ¬¡åŠ è½½ä¼šé‡å¤è°ƒç”¨ `removeLoading` [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]

#### è®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶

ä»…ç”¨äº `degrade` ä¸»åŠ¨é™çº§

ç›®å½•ï¼š

- `iframe.ts` - `recordEventListeners` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L286)]
- `iframe.ts` - `recoverEventListeners` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L324)]
- `iframe.ts` - `recoverDocumentListeners` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L348)]

**1. `recordEventListeners`ï¼šè®°å½•å®¹å™¨ä¸­æ‰€æœ‰äº‹ä»¶**

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`

æµç¨‹ï¼š

- é‡å†™æ²™ç®± `Node` èŠ‚ç‚¹å±æ€§ `addEventListener` å’Œ `removeEventListener`
- æ ¹æ®æ“ä½œä»å®ä¾‹ `elementEventCacheMap` æ˜ å°„è¡¨ä¸­æ·»åŠ æˆ–åˆ é™¤è®°å½•ï¼Œè§ï¼šé™çº§å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#elementeventcachemapé™çº§å®¹å™¨äº‹ä»¶)]
- ç„¶åå†ç›‘å¬æˆ–åˆ é™¤å­åº”ç”¨ä¸­ `Node` èŠ‚ç‚¹ç›¸å…³äº‹ä»¶

è®°å½•äº‹ä»¶æ–¹å¼ï¼š

- é”®åï¼š`Node` ç›‘å¬äº‹ä»¶çš„èŠ‚ç‚¹
- é”®å€¼ï¼šåŒ…å«ï¼š`type`ã€`handle`ã€`options` çš„æ•°ç»„é›†åˆ

> è‹¥åˆ é™¤ç›‘å¬çš„äº‹ä»¶åï¼Œå‘ç°æ•°ç»„é›†åˆç©ºäº†ï¼ŒåŒæ—¶åœ¨æ˜ å°„è¡¨ä¸­åˆ é™¤å½“å‰ç›‘å¬çš„äº‹ä»¶èŠ‚ç‚¹

è°ƒç”¨åœºæ™¯ï¼š

- `initIframeDom`ï¼šåˆå§‹åŒ– `iframe` çš„ `dom` ç»“æ„ [[æŸ¥çœ‹](#initiframedomåˆå§‹åŒ–-iframe-çš„-dom-ç»“æ„)]

**2. `recoverEventListeners`ï¼šæ¢å¤å®¹å™¨ä¸­æ‰€æœ‰å…ƒç´ äº‹ä»¶**

å‚æ•°ï¼š

- `rootElement`ï¼š`iframe` å®¹å™¨ä¸­ `html` å…ƒç´ 
- `iframeWindow`ï¼šæ²™ç®± `window`

æµç¨‹ï¼š

- é€šè¿‡ `createTreeWalker` æ‹¿åˆ° `rootElement` ä¸‹æ‰€æœ‰ `Element` èŠ‚ç‚¹
- éå†å…ƒç´ é€šè¿‡ `elementEventCacheMap` è·å–äº‹ä»¶ç›‘å¬å¯¹è±¡ï¼Œè®°å½•åˆ°ä¸€ä¸ªæ–°çš„ `WeakMap` å¯¹è±¡ä¸Š [[æŸ¥çœ‹](#elementeventcachemapé™çº§å®¹å™¨äº‹ä»¶)]
- å°†æ‹¿åˆ°äº‹ä»¶é›†åˆé‡æ–°åœ¨èŠ‚ç‚¹ä¸Šç›‘å¬
- å°†ç­›é€‰èµ‹å€¼åçš„ `WeakMap` æ›´æ–°å®ä¾‹æ˜ å°„è¡¨ `elementEventCacheMap` [[æŸ¥çœ‹](#elementeventcachemapé™çº§å®¹å™¨äº‹ä»¶)]

è°ƒç”¨åœºæ™¯ï¼š

- `alive` æ¨¡å¼åˆ‡æ¢åº”ç”¨æ—¶é€šè¿‡ `active` æ¿€æ´»æ—¶æ¢å¤äº‹ä»¶ [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]

> `umd`ï¼šæ¯æ¬¡éƒ½æ¸…ç©ºå®¹å™¨ï¼Œé‡å»ºæ¨¡å¼ï¼šæ¯æ¬¡éƒ½é”€æ¯å®ä¾‹ï¼Œå› æ­¤ä¸å­˜åœ¨æ¢å¤å®¹å™¨ä¸­å…ƒç´ ç›‘å¬çš„äº‹ä»¶

**3. `recoverDocumentListeners`ï¼šæ¢å¤å®¹å™¨ `document` äº‹ä»¶**

å‚æ•°ï¼š

- `oldRootElement`ï¼šåˆ‡æ¢åº”ç”¨å‰ `active` æ—¶ç»‘å®šå®¹å™¨çš„ `html` å…ƒç´ 
- `newRootElement`ï¼šå†æ¬¡æ¿€æ´»æ—¶ `active` é‡æ–°åˆ›å»ºçš„å®¹å™¨ `html` å…ƒç´ 
- `iframeWindow`ï¼šæ²™ç®± `window`

æµç¨‹ï¼š

- å’Œ `recoverEventListeners` ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯ä»…æ¢å¤å®¹å™¨ `document` çš„ç›‘å¬äº‹ä»¶

è°ƒç”¨åœºæ™¯ï¼š

- `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨æ—¶é€šè¿‡ `active` æ¿€æ´»æ—¶æ¢å¤äº‹ä»¶ [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]

> é‡å»ºæ¨¡å¼æ¯æ¬¡ `startApp` éƒ½æ˜¯é”€æ¯åé‡æ–°å£°æ˜å®ä¾‹ï¼Œä¸å­˜åœ¨äº‹ä»¶æ¢å¤ï¼Œè§ï¼šåˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹ [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)]

ç›®çš„ï¼š

- é˜²æ­¢ `react16` ç›‘å¬äº‹ä»¶ä¸¢å¤±ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰ï¼Œ`React 16` åŠä¹‹å‰çš„ç‰ˆæœ¬äº‹ä»¶è®°å½•åœ¨ `document`

> `React 16` ä¹‹åäº‹ä»¶ç»‘å®šåœ¨åº”ç”¨æ ¹èŠ‚ç‚¹ï¼Œå¦‚ï¼š`#root`ï¼›`umd` å¯åŠ¨åº”ç”¨åä¼šé€šè¿‡ `__WUJIE_MOUNT` é‡æ–°å§”æ‰˜äº‹ä»¶æ•è·

ä¸éœ€è¦æ¢å¤ `document` äº‹ä»¶ï¼š

- `shadowRoot`ï¼šå› ä¸ºæœ¬èº«å°±æ˜¯æ ¹èŠ‚ç‚¹ï¼Œ`degrade` é™çº§æ—¶æ¯æ¬¡éƒ½æ˜¯æ–°å»º `iframe` å®¹å™¨
- é‡å»ºæ¨¡å¼ï¼šæ¯æ¬¡æ¿€æ´»éƒ½æ˜¯æ–°çš„åº”ç”¨å®ä¾‹

> `degrade` é™çº§ä¸‹ï¼Œ`alive` æ¨¡å¼é€šè¿‡ `recoverEventListeners` æ¢å¤äº‹ä»¶

### è¾…åŠ©æ–¹æ³• - æ‰“è¡¥ä¸

å›´ç»• `patch*` æ‰“è¡¥ä¸å½’çº³æ–¹æ³•

#### `patchRenderEffect` ä¸ºå®¹å™¨æ‰“è¡¥ä¸

ç›®å½•ï¼š`effect.ts` - `patchRenderEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L427)]

å‚æ•°ï¼š

- `render`ï¼š`shadowRoot` æˆ–æ²™ç®± `document`
- `id`ï¼šåº”ç”¨åç§°ï¼Œç”¨äºé€ä¼ ç»™é‡å†™æ–¹æ³•ç”¨äºè·å–å®ä¾‹
- `degrade`ï¼šä¸»åŠ¨é™çº§ï¼Œéé™çº§æ¨¡å¼è®°å½•äº‹ä»¶

å¿…åšï¼šåŠ«æŒå¯¹è±¡é‡å†™æ–¹æ³•

| åŠ«æŒæ–¹æ³•       | `render` | `render.head` | `render.body` | é‡å†™æ–¹æ³•                                                                                           |
| -------------- | -------- | ------------- | ------------- | -------------------------------------------------------------------------------------------------- |
| `appendChild`  | â       | âœ…            | âœ…            | `rewriteAppendOrInsertChild` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)] |
| `insertBefore` | â       | âœ…            | âœ…            | `rewriteAppendOrInsertChild` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)] |
| `removeChild`  | â       | âœ…            | â            | `rewriteRemoveChild` [[æŸ¥çœ‹](#rewriteremovechildé‡å†™-removechild)]                                 |
| `contains`     | âœ…       | âœ…            | â            | `rewriteContains` [[æŸ¥çœ‹](#rewritecontainsé‡å†™-contains)]                                          |

é€‰åšï¼šéé™çº§æƒ…å†µä¸‹ï¼Œé€šè¿‡ `patchEventListener` è®°å½•å®¹å™¨ `body`ã€`head` äº‹ä»¶

- äº‹ä»¶ä¼šè®°å½•åœ¨ç›‘å¬å¯¹è±¡çš„å±æ€§ `_cacheListeners` ä¸Šï¼Œç›®çš„å’Œæ„ä¹‰è§ï¼šå®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#shadowrootbodyhead_cachelistenerså®¹å™¨äº‹ä»¶)]

**è®°å½•ã€åˆ é™¤å®¹å™¨äº‹ä»¶**

æä¾›ä¸¤ä¸ªæ–¹æ³•ï¼š

- `patchEventListener`ï¼šè®°å½•å®¹å™¨ `head`ã€`body` äº‹ä»¶ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L385)]
- `removeEventListener`ï¼šåˆ é™¤å®¹å™¨ `head`ã€`body` äº‹ä»¶ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L416)]

éƒ½æ¥å— 1 ä¸ªå‚æ•°ï¼š

- `element`ï¼šå®¹å™¨çš„ `head` æˆ– `body`

è¦æ±‚ï¼š

- `umd` æ¨¡å¼ï¼Œä¸”é `degrapde` é™çº§ï¼ŒåŸå› è§ï¼šå®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#shadowrootbodyhead_cachelistenerså®¹å™¨äº‹ä»¶)]

é‡å†™ `[body|head].addEventListener`ï¼š

- å°†äº‹ä»¶å’Œå›è°ƒæ–¹æ³•è®°å½•åœ¨æ˜ å°„è¡¨ `listenerMap`ï¼Œä¹‹åæ·»åŠ  `element` ç›‘å¬äº‹ä»¶
- è®°å½•åç§°ä¸ºäº‹ä»¶ç±»å‹ï¼Œè®°å½•çš„å€¼æ˜¯å›è°ƒé›†åˆçš„æ•°ç»„

> ç›‘å¬äº‹ä»¶ä¸­çš„å‚æ•° `options` ä»…ç”¨äºå‘èµ·ç›‘å¬ï¼Œä¸åœ¨è®°å½•ä¸­ç¼“å­˜ï¼Œå› ä¸ºè®°å½•äº‹ä»¶çš„ç›®çš„æ˜¯ä¸ºäº†æ³¨é”€å®¹å™¨å‰åˆ é™¤å¯¹åº”äº‹ä»¶

é‡å†™ `[body|head].removeEventListener`ï¼š

- é€šè¿‡äº‹ä»¶å’Œå›è°ƒæ–¹æ³•ä»æ˜ å°„è¡¨ `listenerMap` ä¸­åˆ é™¤å¯¹åº”çš„äº‹ä»¶ï¼Œä¹‹ååˆ é™¤ `element` ç›‘å¬äº‹ä»¶
- å¦‚æœåˆ é™¤äº‹ä»¶åï¼Œè®°å½•äº‹ä»¶ç±»å‹å¯¹åº”çš„é›†åˆä¸ºç©ºæ•°ç»„ï¼Œå°†å…¶ä»æ˜ å°„è¡¨ä¸­åˆ é™¤

å°† `listenerMap` ç»‘å®šåœ¨ `element` å¯¹è±¡å±æ€§ `_cacheListeners`ï¼š

- `unmount` æ—¶ä¼šé€šè¿‡ `removeEventListener` åˆ é™¤ç»‘å®šåœ¨å®¹å™¨ `head`ã€`body` ä¸Šçš„äº‹ä»¶
- åˆ‡æ¢åº”ç”¨æ—¶ï¼Œåœ¨æ³¨å…¥èµ„æºæ—¶é€šè¿‡åˆæ¬¡è®°å½•åœ¨å®ä¾‹ä¸­çš„ `head`ã€`body` é‡æ–°æ¸²æŸ“ï¼Œå¹¶å†æ¬¡è®°å½•äº‹ä»¶

> æ¸…ç†å’Œé‡æ–°è®°å½•ä»…é™ `umd` æ¨¡å¼ï¼ŒåŸå› è§ï¼šå®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#shadowrootbodyhead_cachelistenerså®¹å™¨äº‹ä»¶)]

`removeEventListener` åˆ é™¤äº‹ä»¶ï¼š

- éå†æ˜ å°„è¡¨ `listenerMap`ï¼Œæ‹¿åˆ° `type` å’Œå›è°ƒæ–¹æ³•é›†åˆï¼Œä¾æ¬¡ä» `element` ä¸­å–æ¶ˆäº‹ä»¶

#### `patchElementEffect`ï¼šä¸ºå…ƒç´ æ‰“è¡¥ä¸

ç›®å½•ï¼š`iframe.ts` - `patchElementEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L668)]

å‚æ•°ï¼š

- `element`ï¼šè¦æ‰“è¡¥ä¸çš„ `html` å…ƒç´ ã€`Node` èŠ‚ç‚¹ã€`ShadowRoot`
- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºè·å–å®ä¾‹å’Œæ²™ç®±ä¸­æŒ‡å®šå¯¹è±¡

**å†…éƒ¨è¡¥ä¸ 1ï¼š`baseURI`**

- é€šè¿‡ `proxyLocation` å®šä½åˆ°å½“å‰åº”ç”¨çš„ `protocol` + `host` + `pathname`

ç”¨é€”ï¼š

- é€šè¿‡è·å–å…ƒç´ çš„ `baseURI` å»çº æ­£å­åº”ç”¨ä¸­å¸¦æœ‰ç›¸å¯¹è·¯å¾„çš„èµ„æºï¼Œæ¯”å¦‚ï¼š`a`ã€`img` ç­‰
- ä½¿å…¶è·¯å¾„ç›¸å¯¹äºå­åº”ç”¨ï¼Œè€Œä¸æ˜¯åŸºåº§

**å†…éƒ¨è¡¥ä¸ 2ï¼š`ownerDocument`**

- æŒ‡å‘å½“å‰æ²™ç®± `iframe.contentDocument`

ç”¨é€”ï¼š

- è®©æ¸²æŸ“å®¹å™¨æ‰€æœ‰çš„å…ƒç´ æ ¹èŠ‚ç‚¹éƒ½æŒ‡å‘æ²™ç®± `document`ï¼Œå®¹å™¨ä¸­åˆ›å»ºçš„å…ƒç´ éƒ½éœ€è¦é€šè¿‡æ²™ç®± `document`
- é€šè¿‡ `ownerDocument` å¯ä»¥ä»å®¹å™¨å…ƒç´ ç›´æ¥è·å–æ²™ç®± `document` ç”¨æ¥åˆ›å»ºå…ƒç´ 

**å†…éƒ¨è¡¥ä¸ 3ï¼š`_hasPatch`**

è¡¨æ˜å·²ç»™å…ƒç´ æ‰“è¿‡è¡¥ä¸ï¼Œä¸ç”¨å†æ‰“è¡¥ä¸

**å¤–éƒ¨è¡¥ä¸ï¼š`patchElementHook`**

é€šè¿‡ `execHooks` æå– `plugins`ï¼Œæä¾›åˆ™ä½¿ç”¨ `patchElementHook` ä¸ºæ¯ä¸ªå…ƒç´ æ‰“è¡¥ä¸ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#patchelementhook)]

> æ‰‹åŠ¨é…ç½®çš„å¤–éƒ¨è¡¥ä¸å¯è¦†ç›–å†…éƒ¨è¡¥ä¸

#### `patchIframeVariable` ä¸ºå­åº”ç”¨ `window` æ·»åŠ å±æ€§

ç›®å½•ï¼š`iframe.ts` - `patchIframeVariable` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L155)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºå­åº”ç”¨ç»‘å®šå…¨å±€å±æ€§
- `wujie`ï¼šåº”ç”¨å®ä¾‹
- `appHostPath`ï¼šå­åº”ç”¨çš„ `origin`

æ·»åŠ çš„å±æ€§ï¼š

- `__WUJIE`ï¼šæŒ‡å‘åº”ç”¨å®ä¾‹ `wujie`
- `__WUJIE_PUBLIC_PATH__`ï¼šå­åº”ç”¨çš„ `origin` + `/`
- `$wujie`ï¼šå­åº”ç”¨çš„ `provide`ï¼Œè§ï¼š`WuJie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- `__WUJIE_RAW_WINDOW__`ï¼šæŒ‡å‘æ²™ç®± `window`

#### `patchIframeHistory` åŠ«æŒæ²™ç®± `iframe` çš„ `history`

ç›®å½•ï¼š`iframe.ts` - `patchIframeHistory` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L170)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äº â‘  è·å– `history`ï¼›â‘¡ çº æ­£é“¾æ¥
- `appHostPath`ï¼šå­åº”ç”¨çš„ `origin`
- `mainHostPath`ï¼šåŸºåº§çš„ `origin`

è°ƒç”¨åœºæ™¯ï¼š

- `initIframeDom`ï¼šåˆå§‹åŒ– `iframe` çš„ `dom` ç»“æ„ [[æŸ¥çœ‹](#initiframedomåˆå§‹åŒ–-iframe-çš„-dom-ç»“æ„)]

è®¾è®¡åˆè¡·ï¼š

- åŠ«æŒ `history` ä¹‹å‰ï¼Œä¼šé€šè¿‡ `initBase` ä¿®æ­£åº”ç”¨ä¸­ç›¸å¯¹è·¯å¾„ï¼ŒåŸºäºå­åº”ç”¨ï¼š`origin` + `pathname` [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]
- é€šè¿‡ `history` è·³è½¬æ—¶ï¼Œéœ€è¦æ‹¦æˆªé“¾æ¥æ›¿æ¢ä¸ºåŸºåº§ `origin` åï¼Œæ›´æ–°æ²™ç®± `iframe` çš„ `url`
- é€šè¿‡ `updateBase` æ ¹æ®æ²™ç®±çš„ `url` æ›´æ–° `base` å…ƒç´ ï¼Œé‡æ–°åŸºäºå­åº”ç”¨ [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]

åŠ«æŒ `history` çš„æ–¹æ³•ï¼š

- `pushState`ï¼šæ’å…¥è®°å½•
- `replaceState`ï¼šæ›¿æ¢è®°å½•

æµç¨‹æœ‰ 3 æ­¥ï¼š

1. è®¡ç®—å¾—åˆ° `mainUrl`ï¼Œé€šè¿‡ `rawHistoryPushState` åŸç”Ÿæ–¹æ³•æ›´æ–° `history` è®°å½•
2. é€šè¿‡ `updateBase` æ›´æ–°å‘¢ `base` å…ƒç´ ï¼Œç”¨äºä¿®æ­£åº”ç”¨ä¸­ç›¸å¯¹è·¯å¾„çš„åŸºç¡€é“¾æ¥ [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]
3. é€šè¿‡ `syncUrlToWindow` åŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°åŸºåº§ï¼Œä»¥ `hash` å½¢å¼å­˜åœ¨ [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)]

> è‹¥æ›´æ–° `history` è®°å½•ä¸­æ²¡æœ‰æä¾› `url`ï¼Œåªæ‰§è¡Œ `rawHistoryPushState` æ›´æ–°

`mainUrl` è®¡ç®—æ–¹å¼ï¼š

- `url`ï¼šæ›´æ–° `history` è®°å½•çš„é“¾æ¥ï¼Œé“¾æ¥åŸºäºå­åº”ç”¨ `origin`
- `baseUrl`ï¼šåŸºåº§ `origin` + æ²™ç®±çš„ `pathname` + `search` + `hash`
- `entry`ï¼šå°† `url` ä¸­å­åº”ç”¨ `origin` æ›¿æ¢ä¸ºç©ºï¼Œå¾—åˆ°è®¡åˆ’æ›´æ–°çš„ï¼š`pathname` + `search` + `hash`
- `mainUrl`ï¼šé€šè¿‡ `getAbsolutePath` åŸºäº `entry` å’Œ `baseUrl` è·å–é“¾æ¥ [[æŸ¥çœ‹](#getabsolutepathè·å–ç»å¯¹è·¯å¾„)]

> åªè¦ `entry` ä¸ä¸ºç©ºï¼Œ`baseUrl` é»˜è®¤å¿½ç•¥ `search` + `hash`ï¼Œè§ï¼š`defaultGetPublicPath` [[æŸ¥çœ‹](#defaultgetpublicpathè·å–èµ„æºé“¾æ¥çš„-path)]

`rawHistoryPushState.call` æŒ‡å®šçš„ä¸Šä¸‹æ–‡æ˜¯æ²™ç®±çš„ `history`ï¼š

- è¿™æ ·å°±ä¸º `syncIframeUrlToWindow` ä¸­ç›‘å¬æ²™ç®±çš„ `popstate` å’Œ `hashchange` æä¾›äº†æ”¯æŒ [[æŸ¥çœ‹](#synciframeurltowindow-ç›‘å¬æ²™ç®±å‰è¿›åé€€)]
- å½“æ²™ç®±è·¯ç”±çš„ `hash` æ”¹å˜ï¼Œæˆ–æ˜¯å‰è¿›åé€€æ—¶ï¼Œå°±ä¼šå‘èµ·åŒæ­¥è·¯ç”±çš„æ“ä½œ

#### `patchIframeEvents` åŠ«æŒæ²™ç®± `iframe` çš„ `EventListener`

ç›®å½•ï¼š`iframe.ts` - `patchIframeEvents` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L115)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºé‡å†™äº‹ä»¶ç›‘å¬

è°ƒç”¨åœºæ™¯ï¼š

- `initIframeDom`ï¼šåˆå§‹åŒ– `iframe` çš„ `dom` ç»“æ„ [[æŸ¥çœ‹](#initiframedomåˆå§‹åŒ–-iframe-çš„-dom-ç»“æ„)]

é‡å†™çš„æ²™ç®± `window` æ–¹æ³•ï¼š

- `addEventListener`ï¼šæ·»åŠ ç›‘å¬äº‹ä»¶
- `removeEventListener`ï¼šåˆ é™¤ç›‘å¬äº‹ä»¶

**1. é€šè¿‡ `execHooks` æå–å¹¶æ‰§è¡Œæ’ä»¶å‡½æ•°**

- `addEventListener`ï¼š`windowAddEventListenerHook` è§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#windowaddeventlistenerhook)]
- `removeEventListener`ï¼š`windowRemoveEventListenerHook` è§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#windowremoveeventlistenerhook)]

ç›®çš„ï¼š

- å­åº”ç”¨çš„ `Dom` æ¸²æŸ“åœ¨å®¹å™¨ä¸­ï¼Œ`script` åœ¨ æ²™ç®± `iframe` ä¸­è¿è¡Œ
- å½“å­åº”ç”¨éœ€è¦ç›‘å¬ `window` äº‹ä»¶æ—¶ï¼Œå¯ä»¥é€šè¿‡æ’ä»¶ä»åŸºåº§æ·»åŠ å…¨å±€ç›‘å¬å¯¹è±¡

**2. `__WUJIE_EVENTLISTENER__` è®°å½•è½¬å‘äº‹ä»¶**

ç›®çš„ï¼š

- è½¬å‘å­åº”ç”¨äº‹ä»¶æŒ‡å‘æ²™ç®± `window`ï¼Œè§ï¼šè½¬å‘ `window` äº‹ä»¶ [[æŸ¥çœ‹](#__wujie_eventlistener__è½¬å‘-window-äº‹ä»¶)]
- è½¬å‘åŒæ—¶éœ€è¦å°†äº‹ä»¶è®°å½•åœ¨é›†åˆä¸­ï¼Œä»¥ä¾¿ `destroy` æ—¶èƒ½å¤Ÿå¸è½½äº‹ä»¶ [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]

è®°å½•å’Œåˆ é™¤æ–¹æ³•ï¼š

- é€šè¿‡ `set` è®°å½•ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ï¼š`type`ã€`listener`ã€`options`ï¼Œç¡®ä¿æ¯ä¸€æ¡è®°å½•å”¯ä¸€æ€§
- åˆ é™¤äº‹ä»¶æ—¶éå†é›†åˆï¼Œå¯¹ç…§ï¼š`type`ã€`listener`ã€`options` å°†å…¶åˆ é™¤

**3. æ‰§è¡Œå›è°ƒæ–¹æ³•**

æ— è®ºäº‹ä»¶æ€ä¹ˆè½¬å‘ã€è®°å½•æœ€ç»ˆéƒ½ä¼šé€šè¿‡åŸç”Ÿæ–¹æ³•æ‰§è¡Œæ“ä½œï¼š

- `rawWindowAddEventListener`ï¼šåŸç”Ÿæ·»åŠ äº‹ä»¶
- `rawWindowRemoveEventListener`ï¼šåŸç”Ÿåˆ é™¤äº‹ä»¶

æ‰§è¡Œçš„æ–¹æ³•éƒ½ä¼šæä¾› `type`ã€`listener`ã€`options`ï¼Œä¸åŒçš„æ˜¯ä¸Šä¸‹æ–‡ `window` æŒ‡å‘ï¼š

| å‚è€ƒæ¡ä»¶                                                                                                                                                                                  | `window` æŒ‡å‘                                            |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------- |
| `options.targetWindow` å­˜åœ¨                                                                                                                                                               | `options.targetWindow`                                   |
| äº‹ä»¶åŒ…å«åœ¨ `appWindowAddEventListenerEvents` ä¸­ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L169)] | ä¼˜å…ˆé‡‡ç”¨ `options.targetWindow`ï¼Œä¸å­˜åœ¨é‡‡ç”¨æ²™ç®± `window` |
| `__WUJIE_RAW_WINDOW__` å­˜åœ¨ï¼Œè§ï¼š`patchIframeVariable` [[æŸ¥çœ‹](#patchiframevariable-ä¸ºå­åº”ç”¨-window-æ·»åŠ å±æ€§)]                                                                            | æ²™ç®± `window`                                            |
| å…¶å®ƒæƒ…å†µ                                                                                                                                                                                  | å…¨å±€ `window`                                            |

> ä¼˜å…ˆæƒï¼š`targetWindow` > æ²™ç®± `window` > å…¨å±€ `window`

`targetWindow` ä»å“ªæ¥çš„ï¼š

- æ‰‹åŠ¨é…ç½®ï¼Œåœ¨ `mdn` æ–‡æ¡£ä¸­ `EventTarget` çš„ `options` å¹¶ä¸åŒ…å« `targetWindow` [[æŸ¥çœ‹](https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/addEventListener)]

ä¾‹å¦‚éœ€è¦åœ¨å­åº”ç”¨ä¸­ç›‘å¬å…¨å±€ `window` çš„ `popstate`ï¼š

```
window.addEventListener('popstate', () => {}, { target: window.parent });
```

> å½“ç„¶ä¹ŸåŒ…å«æ³¨å…¥ `message` ç­‰æ–¹æ³•ï¼Œç”¨äºçˆ¶å­åº”ç”¨ç›¸äº’é€šä¿¡

**4. ä¼šé€ æˆäº‹ä»¶é‡å¤ç›‘å¬å—**

å­˜åœ¨é‡å¤ç›‘å¬ä½†ä¸å½±å“ä½¿ç”¨ï¼Œä¾‹å¦‚ `resize`ï¼š

- é€šè¿‡ `execHooks` è½¬å‘ç»™å…¨å±€ `window` å¤„ç†äº‹ä»¶
- æ²™ç®± `iframe` åŒæ ·ä¹Ÿä¼š `addEventListener`ï¼Œä½†ç”±äºæ²™ç®± `iframe` ä¸å¯è§ï¼Œæ‰€ä»¥é™¤äº† `removeEventListener` ä¹‹å¤–æ²™ç®±ä¸ä¼šæ‰§è¡Œä»»ä½• `resize` äº‹ä»¶

ä¸å­˜åœ¨é‡å¤ç›‘å¬ï¼Œä¾‹å¦‚ï¼š`DOMContentLoaded`ï¼š

- æ²™ç®± `iframe` ä¸­ç”¨äºç›‘å¬æ²™ç®± `window` å¯¹è±¡
- è‹¥ä½¿ç”¨ `execHooks` è½¬å‘äº‹ä»¶ï¼Œç›¸å½“äºåœ¨å…¨å±€ `window` ä¸Šæ‰‹åŠ¨ç›‘å¬ï¼Œé€‰æ‹©æƒåœ¨ä½¿ç”¨è€…

å­˜åœ¨æ­§ä¹‰æ€ä¹ˆåŠï¼Œæ¯”å¦‚ `message` çˆ¶å­é€šä¿¡ï¼Œæ—¢å¯ä»¥æ˜¯å…¨å±€ `window`ï¼Œä¹Ÿå¯ä»¥æ˜¯æ²™ç®± `window`ï¼š

- è¿™ä¸ªæ—¶å€™ `targetWindow` å°±èƒ½å¤Ÿå¾ˆå¥½çš„è§£å†³é—®é¢˜äº†

#### `patchWindowEffect`ï¼šä¿®æ­£ `iframeWindow` çš„ `effect`

ç›®å½•ï¼š`iframe.ts` - `patchWindowEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L215)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window`ï¼Œç”¨äºç»‘å®šã€é‡å†™å±æ€§å’Œäº‹ä»¶

åšäº† 3 ä»¶äº‹ï¼š

1. å°†å…¨å±€ `window` ä¸Šçš„å±æ€§ç»‘å®šåˆ°æ²™ç®± `window`
2. å°†å…¨å±€ `window` ä¸Šçš„äº‹ä»¶å›è°ƒç”¨æ²™ç®± `window` åšåŠ«æŒ
3. é€šè¿‡æ’ä»¶ `windowPropertyOverride` ç»™æ²™ç®± `window` æ‰“è¡¥ä¸

**ç»‘å®š `window` ä¸Šçš„å±æ€§**

å†…éƒ¨å®šä¹‰å‡½æ•° `processWindowProperty`ï¼š

- ä»æ²™ç®±æå–æŒ‡å®šçš„å±æ€§ `key`ï¼Œç„¶åä»å…¨å±€ `window` ä¸Šè·å–å€¼ï¼Œç»‘å®šåˆ°æ²™ç®± `window` ä¸Š

åˆ¤å®šå‰éœ€è¦é€šè¿‡ `isConstructable` æ¥åˆ¤æ–­ï¼Œæä¾›çš„å±æ€§æ˜¯å¦å¯ä»¥å®ä¾‹åŒ– [[æŸ¥çœ‹](#isconstructableåˆ¤æ–­å‡½æ•°æ˜¯å¦å¯ä»¥å®ä¾‹åŒ–)]ï¼š

| æ¡ä»¶                     | ç»‘å®šæ–¹å¼               | ä¸Šä¸‹æ–‡         |
| ------------------------ | ---------------------- | -------------- |
| å¯å®ä¾‹åŒ–çš„æ„é€ å‡½æ•°       | ç›´æ¥ç»‘å®š               | å®ä¾‹åŒ–åçš„å¯¹è±¡ |
| ä¸èƒ½å®ä¾‹åŒ–çš„å‡½æ•°         | é€šè¿‡ `bind` æŒ‡å®šä¸Šä¸‹æ–‡ | å…¨å±€ `window`  |
| éå‡½æ•°ï¼ŒåŒ…æ‹¬ `undefined` | ç›´æ¥ç»‘å®š               | æ²™ç®± `window`  |

æ–¹æ³•ï¼š

- é€šè¿‡ `Object.getOwnPropertyNames` éå†æ²™ç®± `window` åŒ¹é…å±æ€§åæ‰§è¡Œç»‘å®š

åŒ¹é… â‘ ï¼š`getSelection`ï¼š

- é€šè¿‡ `Object.defineProperty` æŒ‡å‘æ²™ç®± `document.getSelection`
- ç”¨å¤„ï¼šä¿®æ­£åº”ç”¨ä¸­æ–‡æœ¬èŒƒå›´æˆ–å…‰æ ‡çš„å½“å‰ä½ç½®
- åŸç†ï¼šå®¹å™¨è´Ÿè´£æ¸²æŸ“ï¼Œæ²™ç®±è´Ÿè´£æ‰§è¡Œ `script`ï¼Œå…ƒç´ é€šè¿‡ `patchElementEffect` æŒ‡å‘æ²™ç®± `document` [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]

åŒ¹é… â‘¡ï¼š`windowProxyProperties` é›†åˆåŒ…å«çš„å±æ€§ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L192)]

- é›†åˆä¸­åŒ…å«çš„å±æ€§é€šè¿‡ `processWindowProperty` ç»‘å®šåˆ°æ²™ç®± `window`

åŒ¹é… â‘¢ï¼š`windowRegWhiteList` æ­£åˆ™åŒ¹é…å±æ€§è§„åˆ™ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L195)]

- é€šè¿‡ `processWindowProperty` ç»‘å®šåˆ°æ²™ç®± `window`ï¼Œæ‰§è¡Œå‰éœ€ç¡®ä¿å…¨å±€ `window` å±æ€§å­˜åœ¨

**ç»‘å®šå…¨å±€ `window` ä¸Šæ‰€æœ‰çš„ `on` å¼€å¤´çš„äº‹ä»¶**

- ç›‘å¬é™¤äº† `onload`ã€`onbeforeunload`ã€`onunload` ä¹‹å¤–æ‰€æœ‰ `on` å¼€å¤´çš„äº‹ä»¶
- é€šè¿‡ `Object.getOwnPropertyNames` éå† `window` ç­›é€‰åŒ¹é…çš„äº‹ä»¶

æµç¨‹ï¼š

- é€šè¿‡ `Object.getOwnPropertyDescriptor` ä»æ²™ç®± `window` ä¸Šè·å–äº‹ä»¶æè¿°ä¿¡æ¯
- é€šè¿‡ `Object.defineProperty` åŠ«æŒæ²™ç®± `window` ä¸Šçš„ç›‘å¬äº‹ä»¶
- é€šè¿‡ `set` å°†æ²™ç®± `window` ç›‘å¬çš„äº‹ä»¶ç»‘å®šåˆ°å…¨å±€ `window`
- é€šè¿‡ `get` ç›´æ¥è¿”å›ç»‘å®šåœ¨å…¨å±€ `window` ä¸Šçš„ç›‘å¬äº‹ä»¶

> åœ¨ `set` ä¸­å¯¹äºç±»å‹ä¸ºå‡½æ•°çš„ `handle` é€šè¿‡ `bind` å°†ä¸Šä¸‹æ–‡ `this` æŒ‡å‘æ²™ç®± `window`

è·å–æè¿°äº‹ä»¶ä¿¡æ¯ç”¨å¤„ï¼š

- `enumerable`ï¼šåˆ¤æ–­æ˜¯å¦å¯æšä¸¾
- `set`ï¼šé‡å†™æ–¹æ³•å‰åˆ¤æ–­äº‹ä»¶æ˜¯å¦å¯å†™æˆ–æè¿°ä¸­å­˜åœ¨ `set`ï¼Œä¸æ»¡è¶³è®¾ä¸º `undefined`

é‡å†™æ–¹æ³•çš„æ„ä¹‰ï¼Œä¸¾ä¸ªä¾‹å­ï¼š

```
// å­åº”ç”¨å†…
(function(window, self, global, location) {
  window.onfocus = () => {
    this;
  }
}).bind(window.__WUJIE.proxy)(
  window.__WUJIE.proxy,
  window.__WUJIE.proxy,
  window.__WUJIE.proxy,
  window.__WUJIE.proxyLocation,
);

// é€šè¿‡ `Object.getOwnPropertyDescriptor` ç›¸å½“äºå°†äº‹ä»¶ç»‘å®šåœ¨åŸºåº§ `window`
window.onfocus = () => {
  this; // è¿™é‡Œ this æŒ‡å‘æ²™ç®±  window
}
```

- è¿™æ ·å½“åŸºåº§è§¦å‘ `window.onfocus` æ—¶ï¼Œå°±ä¼šè°ƒç”¨æ¥è‡ªå­åº”ç”¨çš„ç›‘å¬äº‹ä»¶
- å­åº”ç”¨ä¸­åªéœ€ä¸º `window` ç»‘å®šäº‹ä»¶æ–¹æ³•ï¼Œä¸ç”¨å…³å¿ƒ `window` æŒ‡å‘ï¼Œå’Œå•ç‹¬æ‰§è¡Œä¸€æ ·å¤„ç†

**é€šè¿‡æ’ä»¶ `windowPropertyOverride` æ‰“è¡¥ä¸**

å®˜æ–¹æ–‡æ¡£é—æ¼äº†è¿™ä¸ªæ’ä»¶ï¼ŒåŸç†å’Œå…¶å®ƒæ’ä»¶ä¸€æ ·ï¼Œé€šè¿‡ `execHooks` æå–å¹¶æ‰§è¡Œï¼š

- æ‰§è¡Œæ—¶ä¼šå°†æ²™ç®± `window` ä¼ è¿‡å»ï¼Œç”¨äºæ‰‹åŠ¨æ‰“è¡¥ä¸

#### `patchDocumentEffect`ï¼šä¿®æ­£æ²™ç®± `document` çš„ `effect`

ç›®å½•ï¼š`iframe.ts` - `patchDocumentEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L384)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window`ï¼Œç”¨äº â‘  è·å–æ²™ç®±åŠæ’ä»¶ï¼Œâ‘¡ æå–æ¥å£å’Œå¯¹è±¡ç”¨äºé‡å†™å±æ€§

**1. å¤„ç† `addEventListener` å’Œ `removeEventListener`**

æ²™ç®±è¿è¡Œ `script`ï¼Œæ¸²æŸ“æ˜¯åœ¨å®¹å™¨ã€æ“ä½œåœ¨åŸºåº§ï¼Œéœ€åŠ«æŒæ²™ç®± `document`ï¼ŒæŒ‰æƒ…å†µåˆ†åˆ«æŒ‡å‘å®¹å™¨å’ŒåŸºåº§ã€‚

é‡å†™æ–¹æ³•ï¼š

- `iframeWindow.Document.prototype.addEventListener`ï¼šæ²™ç®± `document` ç›‘å¬äº‹ä»¶
- `iframeWindow.Document.prototype.removeEventListener`ï¼šæ²™ç®± `document` åˆ é™¤äº‹ä»¶

> åº”ç”¨ä¸­ `script` è¿è¡Œåœ¨æ²™ç®±ï¼Œ`document` ä¹ŸæŒ‡å‘æ²™ç®± `document`

**1.1. è®°å½•äº‹ä»¶**

å£°æ˜ 2 ä¸ª `WeakMap` ç±»å‹çš„æ˜ å°„è¡¨ï¼Œè§ï¼šè®°å½•æ²™ç®± `document` ä¸Šçš„äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ²™ç®±-document-ä¸Šçš„äº‹ä»¶)]

`handlerCallbackMap`ï¼šè®°å½•ç›‘å¬çš„æ–¹æ³•

- ä½¿ç”¨ `handle` ä»é›†åˆä¸­è·å–å›è°ƒå¯¹è±¡ `callback`ï¼Œä¸å­˜åœ¨åˆ™ä¿®æ­£å¹¶è®°å½• `handle`
- åˆ é™¤ï¼šé€šè¿‡ `handle` æŸ¥æ‰¾å¯¹åº”çš„ `callback`ï¼Œå°†å…¶åˆ é™¤

> ä¿®æ­£ä¸Šä¸‹æ–‡ï¼šè‹¥ `handle` æ˜¯å‡½æ•°é€šè¿‡ `bind` æŒ‡å‘æ²™ç®± `document`ï¼Œå¦åˆ™ç›´æ¥è®°å½• `handle`

`handlerTypeMap`ï¼šè®°å½•ç›‘å¬çš„äº‹ä»¶

- ç”¨ `handle` è·å–äº‹ä»¶ç±»å‹é›†åˆ `typeList`ï¼Œä¸å­˜åœ¨å°†äº‹ä»¶ç±»å‹ä¿å­˜åœ¨æ•°ç»„ä¸­è®°å½•åˆ°é›†åˆ
- å¦åˆ™åˆ¤æ–­é›†åˆä¸­æ˜¯å¦åŒ…å«äº‹ä»¶ç±»å‹ï¼Œä¸åŒ…å«è´£æ’å…¥åæ›´æ–°è®°å½•ï¼ŒåŒ…å«åˆ™ä¸åšä»»ä½•æ“ä½œ
- åˆ é™¤è®°å½•åˆ™æ˜¯ä»é›†åˆä¸­åˆ é™¤äº‹ä»¶ç±»å‹ï¼Œè‹¥åˆ é™¤åé›†åˆä¸ºç©ºï¼Œå°†å…¶ä»æ˜ å°„è¡¨ä¸­åˆ é™¤

è®°å½•ä¸­åªæœ‰ `callback` æ˜¯æœ‰å¿…è¦çš„ï¼š

- ç”¨äºè½¬å‘äº‹ä»¶æ—¶ä½œä¸ºå›è°ƒå¯¹è±¡ï¼Œå¯ä»¥æ˜¯å‡½æ•°ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªåŒ…å« `handleEvent` çš„å¯¹è±¡

> `handlerTypeMap` ç›®å‰é™¤äº†è®°å½•å¤–ï¼Œæ²¡æœ‰å…¶å®ƒç”¨é€”ï¼Œè§ï¼šè®°å½•æ²™ç®± `document` ä¸Šçš„äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ²™ç®±-document-ä¸Šçš„äº‹ä»¶)]

**1.2. é€šè¿‡ `execHooks` æå–å¹¶æ‰§è¡Œæ’ä»¶å‡½æ•°**

ç”¨äºè½¬å‘æ²™ç®± `document` ä¸Šçš„äº‹ä»¶åˆ°åŸºåº§ï¼Œå› ä¸ºéƒ¨åˆ†æ“ä½œæ¥è‡ªåŸºåº§ï¼Œè€Œä¸æ˜¯æ²™ç®± `iframe`

- `documentAddEventListenerHook`ï¼šæ·»åŠ äº‹ä»¶ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#documentaddeventlistenerhook)]
- `documentRemoveEventListenerHook`ï¼šåˆ é™¤äº‹ä»¶ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#documentremoveeventlistenerhook)]

**1.3. æ‰§è¡Œæ·»åŠ æˆ–åˆ é™¤äº‹ä»¶ç›‘å¬**

æ— è®ºæ·»åŠ è¿˜æ˜¯åˆ é™¤äº‹ä»¶ï¼Œéƒ½è¦æä¾›å‚æ•°ï¼š`type`ã€`callback`ã€`options`ï¼Œä¸åŒçš„æ˜¯ç›‘å¬å¯¹è±¡ï¼š

| æ¡ä»¶                                                                                                                                                                                  | ç›‘å¬å¯¹è±¡                                |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------- |
| `appDocumentAddEventListenerEvents`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L151)]         | æ²™ç®± `document`                         |
| `degrade` é™çº§ï¼Œè§ï¼šæå–é…ç½®åˆå§‹åŒ–å±æ€§ [[æŸ¥çœ‹](#2-æå–é…ç½®åˆå§‹åŒ–å±æ€§)]                                                                                                                | é™çº§å®¹å™¨ `document`                     |
| `mainDocumentAddEventListenerEvents`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L154)]        | åŸºåº§ `document`                         |
| `mainAndAppAddEventListenerEvents` äº‹ä»¶äº’æ–¥ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L166)] | åˆ†åˆ«è°ƒç”¨ï¼šåŸºåº§ `document`ã€`shadowRoot` |
| å…¶å®ƒ                                                                                                                                                                                  | `shadowRoot`                            |

å¦‚æœåŸºåº§ä¹Ÿæ˜¯å­åº”ç”¨ä¼šæ€æ ·ï¼š

- ç›‘å¬å¯¹è±¡æ˜¯ï¼šæ²™ç®± `iframe`ã€é™çº§ `document`ã€`shadowRoot`ï¼Œä¿æŒä¸å˜
- ç›‘å¬å¯¹è±¡æ˜¯åŸºåº§ `window`ï¼Œç›‘å¬æˆ–åˆ é™¤äº‹ä»¶æ—¶ä¼šå†æ¬¡è¢«é‡å†™ï¼Œç»§ç»­å‘ä¸Šè°ƒç”¨ç›´è‡³æœ€é¡¶å±‚

æ— è®ºç›‘å¬å¯¹è±¡å¦‚ä½•æ”¹å˜ï¼Œå¯¹äºå›è°ƒæ–¹æ³•ä¸­çš„ä¸Šä¸‹æ–‡å§‹ç»ˆéµå¾ª `callback`ï¼š

- æ²™ç®± `iframe`ï¼šé€šè¿‡ `bind` ä¿®æ­£ä¸Šä¸‹æ–‡
- å’Œç›‘å¬å¯¹è±¡ç›¸åŒï¼šåŒ…å« `handleEvent` æ–¹æ³•çš„å›è°ƒå¯¹è±¡

> ä¸ºæ­¤å†™äº†ä¸€ä¸ªç®€å•çš„æ¼”ç¤ºï¼Œè§ï¼š`codepen` [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/rNEKrdg)]

**2. å¤„ç† `onEvent`**

é‡æ–°å®šä¹‰æ²™ç®± `document` ä¸­ `on` å¼€å¤´çš„äº‹ä»¶ï¼Œå°†å…¶ç»‘å®šåœ¨å®¹å™¨æŒ‡å®šå¯¹è±¡ä¸­

| å­åº”ç”¨ç»‘å®šå¯¹è±¡  | å®¹å™¨          | ç›‘å¬å¯¹è±¡         |
| --------------- | ------------- | ---------------- |
| æ²™ç®± `document` | é™çº§ `iframe` | å®¹å™¨ `document`  |
| æ²™ç®± `document` | `shadowRoot`  | å®¹å™¨ `html` å…ƒç´  |

ä¸¾ä¾‹ï¼š

```
// åœ¨å­åº”ç”¨ä¸­ç»‘å®šäº‹ä»¶åˆ° `document`
document.onscroll = function() {};

// `degrade` ä¸­ç›¸å½“äºæŒ‚è½½äº‹ä»¶åˆ° `iframe` å®¹å™¨çš„ `document` ä¸Š
sandbox.document.onscroll = function() {};

// é `degrade` ç›¸å½“äºæŒ‚è½½åˆ° `shadowRoot` çš„ `html` å…ƒç´ ä¸Š
sandbox.shadowRoot.firstElementChild.onscroll = function() {};
```

ç”±äºè¦ç»‘å®šäº‹ä»¶åˆ°ç›‘å¬å¯¹è±¡ä¸Šï¼Œæ‰€ä»¥å¿…é¡»ä»æŒ‡å®šå¯¹è±¡æå– 2 ä¸ªé›†åˆï¼š

- `elementOnEvents`ï¼šæ²™ç®± `html` å…ƒç´ ä¸Šæ‰€æœ‰ `on` å¼€å¤´çš„äº‹ä»¶
- `documentOnEvent`ï¼šæ²™ç®± `document` å…ƒç´ ä¸Šæ‰€æœ‰ `on` å¼€å¤´çš„äº‹ä»¶ï¼Œä½†è¦æ’é™¤ `onreadystatechange`

> å–æ²™ç®± `iframe` æŒ‡å®šå¯¹è±¡çš„ `property` ç»‘å®šåˆ°å®¹å™¨ç›¸åŒå¯¹è±¡ä¸Šï¼Œç±»å‹ç›¸åŒçš„å…ƒç´ åŒ…å«çš„ `property` ä¹Ÿç›¸åŒ

ä¸ºäº†å…¼å®¹ä¸åŒçš„å®¹å™¨èŠ‚ç‚¹ï¼Œå– 2 ä¸ªå±æ€§é›†åˆçš„äº¤é›†ï¼š

- æ’é™¤çš„äº‹ä»¶ç»§ç»­å¾€ä¸‹çœ‹ï¼Œè§ï¼š4. å¤„ç† `document` ä¸“å±äº‹ä»¶

æµç¨‹å’Œ `patchWindowEffect` ä¸­å¤„ç† `onEvent` ä¸€æ · [[æŸ¥çœ‹](#patchwindoweffectä¿®æ­£-iframewindow-çš„-effect)]ï¼š

- é€šè¿‡ `Object.getOwnPropertyDescriptor` ä»æ²™ç®± `Document` è·å–äº‹ä»¶æè¿°ä¿¡æ¯
- é€šè¿‡ `Object.defineProperty ` åŠ«æŒæ²™ç®± `Document` ä¸Šçš„ç›‘å¬äº‹ä»¶
- é€šè¿‡ `set` å°†æ²™ç®± `Document` ç›‘å¬çš„äº‹ä»¶ç»‘å®šåˆ°å®¹å™¨æŒ‡å®šèŠ‚ç‚¹
- é€šè¿‡ `get` ç›´æ¥è¿”å›ç»‘å®šåœ¨å®¹å™¨èŠ‚ç‚¹ä¸Šçš„ç›‘å¬äº‹ä»¶

> åœ¨ `set` ä¸­å¯¹äºç±»å‹ä¸ºå‡½æ•°çš„ `handle` é€šè¿‡ `bind` å°†ä¸Šä¸‹æ–‡ `this` æŒ‡å‘æ²™ç®± `document`

è·å–æè¿°ä¿¡æ¯çš„ç”¨å¤„ï¼š

- `enumerable`ï¼šåˆ¤æ–­æ˜¯å¦å¯æšä¸¾
- `set`ï¼šé‡å†™æ–¹æ³•å‰åˆ¤æ–­äº‹ä»¶æ˜¯å¦å¯å†™æˆ–æè¿°ä¸­å­˜åœ¨ `set`ï¼Œä¸æ»¡è¶³è®¾ä¸º `undefined`

**3. è·å–æ²™ç®± `document` å±æ€§æ—¶æŒ‡å‘ `proxyDocument`**

å¯ä»¥é€šè¿‡æµç¨‹å›¾äº†è§£æ²™ç®± `document` å’Œ `proxyDocument` çš„å…³ç³» [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

å±æ€§æ¥è‡ªï¼š

- `documentProxyProperties`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L42)]

æµç¨‹å’Œ `onEvent` åŸºæœ¬ä¸€æ ·ï¼š

- é€šè¿‡ `Object.getOwnPropertyDescriptor` ä»æ²™ç®± `Document` è·å–å±æ€§æè¿°ä¿¡æ¯
- é€šè¿‡ `Object.defineProperty ` åŠ«æŒæ²™ç®± `Document` ä¸Šçš„å±æ€§
- é€šè¿‡ `get` ç›´æ¥ä» `proxyDocument` è¿”å›å¯¹åº”å±æ€§å€¼
- é€šç”¨æè¿°ä¿¡æ¯ï¼Œå†³å®š `enumerable` æ˜¯å¦å¯æšä¸¾

> ä¸åŒåœ¨äºï¼šä¸èƒ½é€šè¿‡ `set` é‡å†™å±æ€§å€¼

`proxyDocument` ä¼šæ ¹æ®å®¹å™¨ä¸åŒç•¥æœ‰å·®å¼‚ï¼š

- `shadowRoot` [[æŸ¥çœ‹](#2-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxydocument)]
- `iframe` å®¹å™¨ [[æŸ¥çœ‹](#1-åŠ«æŒç©ºå¯¹è±¡ä½œä¸º-proxydocument)]

**4. å¤„ç† `document` ä¸“å±äº‹ä»¶**

æ ¹æ®æ¸²æŸ“çš„æ–¹å¼ï¼Œå°†æ²™ç®± `document` è½¬å‘ç»™å®¹å™¨æˆ–åŸºåº§ `document`ï¼š

| æ¸²æŸ“æ–¹å¼      | è½¬å‘å¯¹è±¡            |
| ------------- | ------------------- |
| `shadowRoot`  | åŸºåº§ `document`     |
| é™çº§ `iframe` | é™çº§å®¹å™¨ `document` |

å±æ€§æ¥è‡ªï¼š

- `documentEvents`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L131)]

æµç¨‹å’Œ `onEvent` ä¸€æ ·ï¼š

- é€šè¿‡ `Object.getOwnPropertyDescriptor` ä»æ²™ç®± `Document` è·å–äº‹ä»¶æè¿°ä¿¡æ¯
- é€šè¿‡ `Object.defineProperty ` åŠ«æŒæ²™ç®± `Document` ä¸Šçš„ç›‘å¬äº‹ä»¶
- é€šè¿‡ `set` å°†æ²™ç®± `Document` è½¬å‘ç›‘å¬äº‹ä»¶åˆ°æŒ‡å®š `document` å¯¹è±¡
- é€šè¿‡ `get` ç›´æ¥ä»è½¬å‘çš„ `document` å¯¹è±¡ä¸Šè·å–è·å–ç›‘å¬äº‹ä»¶

> åœ¨ `set` ä¸­å¯¹äºç±»å‹ä¸ºå‡½æ•°çš„ `handle` é€šè¿‡ `bind` å°†ä¸Šä¸‹æ–‡ `this` æŒ‡å‘æ²™ç®± `document`

**5. å¤„ç† `head` å’Œ `body`**

æµç¨‹å’Œï¼š3. è·å–æ²™ç®± `document` å±æ€§æ—¶æŒ‡å‘ `proxyDocument`ï¼ŒåŸºæœ¬ä¸€æ ·ï¼š

- éå† `ownerProperties` é›†åˆåŠ«æŒ `head` å’Œ `body`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L147)]
- ä»æ²™ç®± `document` ä¸­åŠ«æŒå¯¹è±¡è®¾ç½®ä¸ºä¸å¯é‡å†™ï¼Œ`get` æ—¶æŒ‡å‘ `proxyDocument`

**6. è¿è¡Œæ’ä»¶é’©å­å‡½æ•°**

æ–‡æ¡£æ²¡æï¼Œæµç¨‹å’Œ `windowPropertyOverride` ä¸€æ ·ï¼Œè§ï¼š`patchWindowEffect` [[æŸ¥çœ‹](#patchwindoweffectä¿®æ­£-iframewindow-çš„-effect)]

- é€šè¿‡ `execHooks` æå–å¹¶æ‰§è¡Œæ’ä»¶ `documentPropertyOverride`ï¼Œå°†æ²™ç®± `window` ä½œä¸ºå‚æ•°ä¼ è¿‡å»æ‰“è¡¥ä¸

#### `patchNodeEffect`ï¼šä¿®æ­£å®¹å™¨èŠ‚ç‚¹çš„ `effect`

ä¸ºå®¹å™¨ä¸­æ¯ä¸ªå…ƒç´ é‡å†™ 3 ä¸ªæ–¹æ³•

ç›®å½•ï¼š`iframe.ts` - `patchNodeEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L563)]

`getRootNode`ï¼šä½¿ç”¨åŸç”Ÿæ–¹æ³•è·å– `document`ï¼Œä¹‹åæ ¹æ®å®¹å™¨è¿”å›æ ¹èŠ‚ç‚¹

| å®¹å™¨          | `options`                       | æ ¹èŠ‚ç‚¹          |
| ------------- | ------------------------------- | --------------- |
| `shadowRoot`  | `composed` ä¸º `true`            | å…¨å±€ `document` |
| `shadowRoot`  | ä¸è®¾ç½® `composed`ï¼Œæˆ–ä¸º `false` | æ²™ç®± `document` |
| æ²™ç®± `iframe` | å¿½ç•¥                            | æ²™ç®± `document` |
| é™çº§ `iframe` | å¿½ç•¥                            | é™çº§ `document` |

`appendChild`ï¼šåœ¨å…ƒç´ å†…è¿½åŠ å­å…ƒç´ ã€`insertBefore`ï¼šåœ¨å…ƒç´ ä¹‹å‰æ’å…¥å…ƒç´ 

- é€šè¿‡åŸç”Ÿæ–¹æ³•åŠ¨æ€æ·»åŠ å…ƒç´ ï¼Œç„¶åä½¿ç”¨ `patchElementEffect` ä¸ºå…ƒç´ æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]
- è¿”å›æ·»åŠ çš„å…ƒç´ 

#### `patchRelativeUrlEffect`ï¼šä¿®å¤åŠ¨æ€æ·»åŠ å…ƒç´ èµ„æº

ä¿®å¤èµ„æºå…ƒç´ çš„ç›¸å¯¹è·¯å¾„é—®é¢˜ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰

ç›®å½•ï¼š`iframe.ts` - `patchRelativeUrlEffect` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L588)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®±çš„ `window`ï¼Œç”¨äº â‘  é€ä¼ ç»™ `fixElementCtrSrcOrHref`ï¼Œâ‘¡ æå–èµ„æºæ¥å£

æµç¨‹ï¼š

- é€šè¿‡ `fixElementCtrSrcOrHref` æ‹¦æˆªå…ƒç´ èµ„æºå±æ€§è®¾ç½®ï¼Œä¿®æ­£ç›¸å¯¹è·¯å¾„ä¸ºç»å¯¹è·¯å¾„ [[æŸ¥çœ‹](#fixelementctrsrcorhrefå¯¹å…ƒç´ èµ„æºæ‰“è¡¥ä¸)]

ä¿®å¤çš„å…ƒç´ ï¼š

- `HTMLImageElement`ï¼šå›¾ç‰‡ `src`
- `HTMLAnchorElement`ï¼šé“¾æ¥ `href`
- `HTMLSourceElement`ï¼šåª’ä½“ `src`
- `HTMLLinkElement`ï¼šèµ„æº `href`
- `HTMLScriptElement`ï¼šè„šæœ¬ `src`
- `HTMLMediaElement`ï¼šéŸ³è§†é¢‘ `src`

#### `fixElementCtrSrcOrHref`ï¼šå¯¹å…ƒç´ èµ„æºæ‰“è¡¥ä¸

é€šè¿‡é‡å†™æ–¹æ³•ã€åŠ«æŒå…ƒç´ åŸå‹ï¼Œå¯¹èµ„æºå±æ€§ä¸­ç›¸å¯¹è·¯å¾„è½¬åŒ–ä¸ºç»å¯¹åœ°å€

ç›®å½•ï¼š`utils.ts` - `fixElementCtrSrcOrHref` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L167)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºè·å–æ²™ç®± `Element` åŸç”Ÿå±æ€§ `setAttribute`
- `elementCtr`ï¼šèµ„æºå…ƒç´ æ¥å£
- `attr`ï¼šèµ„æºå±æ€§ï¼Œå¦‚ï¼š`src`

ç›®çš„ï¼š

- æ¥è‡ªå­åº”ç”¨åŠ¨æ€è®¾ç½®èµ„æºé“¾æ¥ï¼Œé€šè¿‡ `getAbsolutePath` é‡æ–°é…ç½®æœ€ç»ˆçš„é“¾æ¥ [[æŸ¥çœ‹](#getabsolutepathè·å–ç»å¯¹è·¯å¾„)]

å¤„ç†é“¾æ¥æœ‰ 3 ç§æƒ…å†µï¼š

- ç›¸å¯¹è·¯å¾„ï¼šæŒ‰ç…§ `baseURI` å–è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
- ç»å¯¹è·¯å¾„æˆ–æ˜¯ `hash`ï¼šä¸å¤„ç†ç›´æ¥è¿”å›

> `baseURI` ä¸ºå­åº”ç”¨ `origin` + `pathname`ï¼Œè§ï¼š`patchElementEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

è°ƒç”¨åœºæ™¯ï¼š

- `patchRelativeUrlEffect`ï¼šä¿®å¤åŠ¨æ€æ·»åŠ å…ƒç´ èµ„æº [[æŸ¥çœ‹](#patchrelativeurleffectä¿®å¤åŠ¨æ€æ·»åŠ å…ƒç´ èµ„æº)]

é‡å†™ `setAttribute`ï¼š

- è¦æ±‚è®¾ç½®çš„å±æ€§å’Œ `attr` ä¸€è‡´ï¼Œè·å–ç»å¯¹è·¯å¾„åé€šè¿‡åŸç”Ÿæ–¹æ³•æ›´æ–°å±æ€§

èµ‹å€¼æ›´æ–°æ—¶é€šè¿‡ `defineProperty` åŠ«æŒèµ„æºå±æ€§ï¼š

- é€šè¿‡ `getOwnPropertyDescriptor` è·å–èµ„æºå±æ€§æè¿°ä¿¡æ¯
- `set` æ—¶é€šè¿‡ `getAbsolutePath` è½¬æ¢èµ„æºè·¯å¾„ã€`get` æ—¶é€šè¿‡åŸç”Ÿæ–¹æ³•è·å–

### è¾…åŠ©æ–¹æ³• - æ²™ç®± `iframe`

å›´ç»•æ²™ç®± `iframe` å½’çº³ç›¸å…³çš„æ–¹æ³•

#### `insertScriptToIframe`ï¼šä¸ºæ²™ç®±æ’å…¥ `script`

å‘æ²™ç®± `iframe` ä¸­æ’å…¥ `script`ï¼ŒåŒ…å«é™æ€æå–å’ŒåŠ¨æ€æ·»åŠ 

ç›®å½•ï¼š`iframe.ts` - `insertScriptToIframe` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L710)]

å‚æ•°ï¼š

- `scriptResult`ï¼šéœ€è¦æ’å…¥çš„ `script` å¯¹è±¡
- `iframeWindow`ï¼šæ²™ç®± `window`
- `rawElement`ï¼šåŠ¨æ€æ·»åŠ çš„ `script` å…ƒç´ ï¼Œç”¨äº `setTagToScript` æ‰“æ ‡è®°ï¼Œå¯é€‰å‚æ•°

`scriptResult` æœ‰ 2 ä¸ªç±»å‹ï¼š

| ç±»å‹                                                                                                                                                         | æ¥è‡ª                 | ç¼ºå°‘å±æ€§          |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------ | -------------------- | ----------------- |
| `ScriptObject`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/template.ts#L45)]    | é™æ€æå–ã€åŠ¨æ€æ·»åŠ çš„ | `callback`        |
| `ScriptObjectLoader`ï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L22)] | æ‰‹åŠ¨é…ç½® `jsLoader`  | `defer`ã€`ignore` |

> å…¶ä¸­ `defer`ã€`ignore` åœ¨è¿™é‡Œç”¨ä¸åˆ°ï¼Œå‡½æ•°ä¸­ä¼šå¼ºåˆ¶æ–­è¨€ä¸º `ScriptObjectLoader`ã€‚ã€‚ã€‚

è°ƒç”¨åœºæ™¯æœ‰ 2 ä¸ªï¼š

- `rewriteAppendOrInsertChild`ï¼šæ‹¦æˆªåº”ç”¨ä¸­åŠ¨æ€æ·»åŠ  `script` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]
- `start` å¯åŠ¨åº”ç”¨ï¼šæå–åº”ç”¨ä¸­é™æ€ `script`ï¼Œæ‰‹åŠ¨é…ç½® `jsLoader` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

> `rewriteAppendOrInsertChild` æ¥è‡ªï¼šæ¿€æ´»åº”ç”¨æ—¶ï¼Œé€šè¿‡æ¸²æŸ“èµ„æºåˆ°å®¹å™¨è°ƒç”¨ `patchRenderEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

æ•´ä¸ªå‡½æ•°å›´ç»• 2 ä¸ªå¯¹è±¡å±•å¼€ï¼š

- `scriptElement`ï¼šæ ¹æ®æä¾›çš„å¯¹è±¡ï¼Œåˆ›å»º `script` å…ƒç´ æ’å…¥æ²™ç®± `iframe`
- `nextScriptElement`ï¼šæ‰§è¡Œå®Œæ¯•åæ’å…¥åˆ°æ²™ç®±ï¼Œç”¨äºæå–å¹¶æ‰§è¡Œä¸‹ä¸ªé˜Ÿåˆ—ï¼Œè§ï¼š`start` å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

**1. è·å–é…ç½®**

ä» `scriptResult` æå–é…ç½®ï¼Œè¯¦ç»†è§ï¼š`processTpl` æå–èµ„æº - 4.æå–æˆ–æ›¿æ¢ `script` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

- `src`ï¼š`script` é“¾æ¥
- `module`ï¼šæ˜¯å¦ä¸º `esModule` æ¨¡å—
- `content`ï¼š`script` å†…å®¹
- `crossorigin`ï¼šæ˜¯å¦è·¨åŸŸ
- `crossoriginType`ï¼šè·¨åŸŸç±»å‹ï¼ŒåŒ…å« `"" | "anonymous" | "use-credentials"`
- `async`ï¼šæ˜¯å¦ä¸ºå¼‚æ­¥åŠ è½½ï¼Œåœ¨è¿™é‡Œåªæœ‰ä¸€ä¸ªç”¨é€”ï¼Œå¼‚æ­¥æƒ…å†µä¸‹ä¸æå–å¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—
- `attrs`ï¼š`script` å…ƒç´ ä¸­çš„å±æ€§é”®å€¼å¯¹è±¡
- `callback`ï¼šæ‰‹åŠ¨è®¾ç½®ï¼Œä¼šåœ¨æ³¨å…¥ `script` åè°ƒç”¨ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-before-loaders)]
- `onload`ï¼šå¤–è” `script` å®ŒæˆåŠ è½½æˆ–åŠ è½½å¤±è´¥æ—¶è°ƒç”¨

ä»¥ä¸Šé…ç½®å…¨éƒ¨ä¸ºå¯é€‰ç±»å‹ï¼ŒæŒ‰ç…§ `content` åˆ’åˆ†å¦‚ä¸‹ï¼š

| `content`    | `src`        | ç±»å‹            | `textContent`  |
| ------------ | ------------ | --------------- | -------------- |
| å­˜åœ¨ä¸”ä¸ä¸ºç©º | ä¸è®¾ç½®       | å†…è” `script`   | æŒ‰æ¡ä»¶åŒ…è£…ä»£ç  |
| ä¸å­˜åœ¨æˆ–ä¸ºç©º | å­˜åœ¨ä¸”ä¸ä¸ºç©º | å¤–è” `script`   | ç©ºå­—ç¬¦         |
| ä¸å­˜åœ¨æˆ–ä¸ºç©º | ä¸å­˜åœ¨æˆ–ä¸ºç©º | `script` ä¸åŠ è½½ | ç©ºå­—ç¬¦         |

> `degrade` é™çº§æˆ– `esModule` ä¸åŒ…è£¹åœ¨æ¨¡å—å†…ï¼Œå…¶ä½™æƒ…å†µä»£ç å‡åœ¨ `proxy` æ¨¡å—å†…æ‰§è¡Œï¼Œè§ï¼šæµç¨‹å›¾ [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

é€šè¿‡æ²™ç®± `iframe` è·å–åº”ç”¨å®ä¾‹ï¼Œç”¨äºæå–å¯¹è±¡ï¼š`replace`ã€`plugins`ã€`proxyLocation`ï¼š

- ç”¨äºè·å– `jsLoader` æ›¿æ¢ `content`ï¼Œè§ï¼šé€šè¿‡é…ç½®æ›¿æ¢èµ„æº [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]
- `proxyLocation` ä¼šé€šè¿‡ `getCurUrl` é€ä¼ é“¾æ¥ä¸ºå­åº”ç”¨ï¼š`origin` + `pathname`

> é™¤æ­¤ä¹‹å¤– `proxyLocation` è¿˜ç”¨äºä½œä¸º `proxy` æ¨¡å—ä¸­çš„ `location`

`script` æ³¨å…¥ç±»å‹ï¼š

| æ¥æº                                                                 | å…ƒç´ ç±»å‹      |
| -------------------------------------------------------------------- | ------------- |
| `jsLoader` æ‰‹åŠ¨æä¾›çš„å¤–è” `script`                                   | å¤–è” `script` |
| `jsIgnores` å±è”½ `fetch` åŠ è½½çš„å¤–è” `script`                         | å¤–è” `script` |
| `jsIgnores` å±è”½å¸¦æœ‰å±æ€§ `async` æˆ– `defer` çš„å¤–è” `script`          | å†…è” `script` |
| ç±»å‹ä¸º `module` çš„å¤–è” `script`                                      | å¤–è” `script` |
| å¸¦æœ‰ `ignore` å±æ€§çš„é™æ€ `script`                                    | æ³¨é‡Šå…ƒç´       |
| ä¸å…è®¸çš„ `esModule`ï¼Œè§ï¼š`processTpl` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)] | æ³¨é‡Šå…ƒç´       |
| `jsExcludes` å±è”½ `script`                                           | æ’é™¤ä¸æ³¨å…¥    |
| å…¶å®ƒç±»å‹çš„ `script`                                                  | å†…è” `script` |

**2. é…ç½® `script`**

2.1. ä¸º `scriptElement` æ·»åŠ å±æ€§ï¼š

| å±æ€§                           | æ¡ä»¶                                                     |
| ------------------------------ | -------------------------------------------------------- |
| æ³¨å…¥ `script` çš„é”®å€¼å¯¹ `attrs` | é”®åä¸å’Œ `ScriptObject`ã€`ScriptObjectLoader` çš„å±æ€§åŒå |
| `src`                          | é“¾æ¥ä¸ä¸ºç©ºçš„å¤–è” `script`                                |
| `crossorigin`                  | è·¨åŸŸçš„å¤–è” `script`ï¼Œå±æ€§å€¼ä¸º `crossoriginType`          |
| `type`                         | æ³¨å…¥çš„ `script` ç±»å‹ä¸º `module`                          |
| `async`                        | ä¸¢å¼ƒ                                                     |
| `defer`                        | ä¸¢å¼ƒ                                                     |

2.2. `content` å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œä½œä¸ºå†…è” `script`ï¼š

è¦æ±‚ï¼šéé™çº§ `degrade` ä¸æ˜¯ `esModule`ï¼Œè§ï¼šæµç¨‹å›¾ [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

å°†æ•´ä¸ª `script` å†…å®¹åŒ…è£¹åœ¨ä¸€ä¸ªå‡½æ•°æ¨¡å—é‡Œï¼š

- ä½¿ç”¨ `proxy` ä½œä¸ºæ¨¡å—çš„ï¼š`this`ã€`window`ã€`self`ã€`global` [[æŸ¥çœ‹](#1-ä»£ç†æ²™ç®±-window-ä½œä¸º-proxywindow)]
- ä½¿ç”¨ `proxyLocation` ä½œä¸ºæ¨¡å—çš„ `location` [[æŸ¥çœ‹](#3-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxylocation)]

ä¿®å¤ `webpack` å½“ `publicPath` ä¸º `auto` æ— æ³•åŠ è½½èµ„æºçš„é—®é¢˜ï¼š

- é€šè¿‡ `Object.getOwnPropertyDescriptor` è·å– `scriptElement` å±æ€§ `src` çš„æè¿°ä¿¡æ¯
- å½“æè¿°ä¿¡æ¯ä¸å­˜åœ¨æ—¶ï¼Œæˆ–æè¿°ä¿¡æ¯çš„ç±»å‹ä¸å¯ä»¥æ›´æ”¹æ—¶éœ€è¦ä¿®å¤é—®é¢˜
- ä¿®å¤æ–¹å¼ï¼šé€šè¿‡ `defineProperty` å®šä¹‰ `scriptElement` å±æ€§ `src`

> ä»…é™å†…è” `script` éœ€è¦æ ¹æ®æƒ…å†µä¿®å¤ï¼Œå¤–è” `script` æœ¬èº«æ‹¥æœ‰ `src` å±æ€§

2.3. `content` ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œä½œä¸ºå¤–è” `script`ï¼š

è®¾ç½®å±æ€§ï¼š`src`ï¼Œ`crossorigin` ä¸º `crossoriginType`ï¼Œå¦‚æœå±æ€§å­˜åœ¨çš„è¯

> å¤–è” `script` å’Œ `esModule` ä¸€æ ·ï¼Œä¸ä¼šåŒ…è£¹åœ¨ `proxy module` ä¸­ï¼Œè§ï¼šæµç¨‹å›¾ [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

2.4. `script` è¡¥å……æ“ä½œï¼š

- æ ¹æ® `module` å†³å®šæ˜¯å¦æ·»åŠ  `type` å±æ€§ä¸º `module`
- è®¾ç½® `textContent`ï¼Œå¤–è” `script` ä¹Ÿä¼šè®¾ç½®ï¼Œä½† `script` ä¼šä¼˜å…ˆé‡‡ç”¨ `src`
- è®¾ç½® `nextScriptElement` çš„ä»£ç ï¼Œç”¨äº `script` æ’å…¥å®Œæˆåï¼Œæå–å¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—

**3. å£°æ˜æ³¨å…¥ `script` çš„æ–¹æ³•**

å£°æ˜å‡½æ•° `execNextScript`ï¼Œç”¨äºæ³¨å…¥ `scriptElement` åˆ°å®¹å™¨ï¼š

- æŒ‡å®šæ²™ç®± `head` ä½œä¸ºå®¹å™¨ï¼Œåªè¦ `async` ä¸å­˜åœ¨ï¼Œå°±ä¼šæ‰§è¡Œ `appendChild`

> è¿™é‡Œåˆ¤æ–­ `async` æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œè§ï¼š`start` å¯åŠ¨åº”ç”¨çš„ `bug` [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)]

å£°æ˜å‡½æ•° `afterExecScript`ï¼Œç”¨äºå®Œæˆæ³¨å…¥åæ‰§è¡Œï¼š

- è§¦å‘ `onload`ï¼šç”¨äºé€šçŸ¥ `script` å·²å®ŒæˆåŠ è½½
- è§¦å‘ `execNextScript`ï¼šæå–æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè§ï¼šæ‰§è¡Œé˜Ÿåˆ— [[æŸ¥çœ‹](#2-æ‰§è¡Œé˜Ÿåˆ—)]

`onload` æ·»åŠ æ–¹å¼ï¼š

- é€šè¿‡ `jsLoader` æ‰‹åŠ¨æ·»åŠ ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-before-loaders)]
- åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ  `script`ï¼Œç”¨äºè§¦å‘ `onload` äº‹ä»¶ï¼Œè§ï¼š`rewriteAppendOrInsertChild` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

> é—®é¢˜ï¼šå¤–è” `script` æ³¨å…¥æ²™ç®±åŠ è½½å¤±è´¥åï¼Œè§¦å‘çš„ä¹Ÿæ˜¯ `onload`ï¼Œå›è°ƒå‡½æ•°å’Œå‚æ•°æ²¡åšåŒºåˆ†

é”™è¯¯çš„æƒ…å†µï¼šæ³¨å…¥ `script` ä»£ç æ˜¯ `html` æ ¼å¼ï¼Œè¯´æ˜åŠ è½½å¤±è´¥äº†

- é”™è¯¯æ¡ä»¶ï¼šâ‘  å†…è” `script`ï¼›â‘¡ `degrade` é™çº§æˆ–æ˜¯ `esModule`
- å¤„ç†æ–¹æ³•ï¼šè¾“å‡º `error`ï¼Œè°ƒç”¨ `execNextScript` ä»¥ä¾¿æ‰§è¡Œä¸‹ä¸ªé˜Ÿåˆ—

> é—®é¢˜ï¼šé `degrade` ä¸”ä¸æ˜¯ `esModule` çš„å†…è” `script` éš¾é“å°±ä¸ä¼šåŠ è½½å¤±è´¥äº†å—ï¼Ÿ

æ‰“æ ‡è®°ï¼š

- é€šè¿‡ `setTagToScript` ä¸ºæ³¨å…¥æ²™ç®±çš„ `script` æ‰“æ ‡è®° [[æŸ¥çœ‹](#ä¸ºåŠ¨æ€æ·»åŠ çš„-script-æ‰“æ ‡è®°)]
- ä»…é™é€šè¿‡ `rewriteAppendOrInsertChild` åŠ¨æ€æ·»åŠ çš„ `script` æ‰éœ€è¦æ‰“æ ‡è®° [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

åŸå› ï¼š

- æ³¨å…¥æ²™ç®±çš„ `script` éƒ½æ˜¯é‡å»ºçš„ï¼Œé€šè¿‡æ‰“æ ‡è®°çš„æ–¹å¼å’ŒåŠ¨æ€åˆ›å»ºçš„ `script` å…³è”èµ·æ¥
- å¦åˆ™æ³¨å…¥ `script` ä¹‹åï¼Œåœ¨åº”ç”¨å†…ç»§ç»­æ“ä½œåˆ›å»ºçš„å…ƒç´ ï¼Œæ²™ç®±ä¸­ `script` æ²¡æœ‰ä»»ä½•æ•ˆæœ

**4. æ³¨å…¥ `script` åˆ°æ²™ç®±**

ä¸ºå¤–è” `script` æ·»åŠ å›è°ƒå‡½æ•°ï¼š

- è¦æ±‚ï¼š`script` å¸¦æœ‰ `src`ï¼Œ `content` ä¸ºç©º
- æ»¡è¶³æ¡ä»¶æ— è®ºæ˜¯ `onload` è¿˜æ˜¯ `onerror` éƒ½ä¼šè°ƒç”¨ `afterExecScript`

æ³¨å…¥æ“ä½œï¼š

- åœ¨å®¹å™¨ä¸­æ·»åŠ  `scriptElement`ï¼Œä½¿ç”¨æ²™ç®± `window` è°ƒç”¨ `callback` é€šçŸ¥å®Œæˆæ³¨å…¥
- é€šè¿‡ `execHooks` æå–å¹¶æ‰§è¡Œ `appendOrInsertElementHook`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#appendorinsertelementhook)]
- å¯¹äºå†…è” `script` å…ƒç´ æ— æ³•è§¦å‘ `onload`ï¼Œç›´æ¥è°ƒç”¨ `afterExecScript`

> `callback` åªèƒ½é€šè¿‡ `jsLoader` é…ç½®

#### `iframeGenerator`ï¼šåˆ›å»ºæ²™ç®± `iframe`

ç›®å½•ï¼š`iframe.ts` - `iframeGenerator` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L815)]

`js` æ²™ç®±ï¼Œæ¥è‡ªå¤‡æ³¨ï¼š

- åˆ›å»ºå’Œä¸»åº”ç”¨åŒæºçš„ `iframe`ï¼Œè·¯å¾„æºå¸¦äº†å­è·¯ç”±çš„è·¯ç”±ä¿¡æ¯
- `iframe` å¿…é¡»ç¦æ­¢åŠ è½½ `html`ï¼Œé˜²æ­¢è¿›å…¥ä¸»åº”ç”¨çš„è·¯ç”±é€»è¾‘

å‚æ•°ï¼š

- `sandbox`ï¼šåº”ç”¨å®ä¾‹ï¼Œç”¨äºæ‰“è¡¥ä¸ã€ç»‘å®š `iframeReady` ç”¨äºç¡®ä¿æ²™ç®±åˆå§‹åŒ–
- `attrs`ï¼šæ‰‹åŠ¨é…ç½® `iframe` å…ƒç´ å±æ€§ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#attrs)]
- `mainHostPath`ï¼šåŸºåº§ `origin`
- `appHostPath`ï¼šå­åº”ç”¨çš„ `origin`
- `appRoutePath`ï¼šå­åº”ç”¨çš„ `pathname` + `search` + `hash`

**ç¬¬ä¸€æ­¥ï¼šåˆ›å»º `iframe`**

åˆ›å»ºä¸€ä¸ª `iframe` å…ƒç´ ä½œä¸ºæ²™ç®±ï¼Œå¹¶è®¾ç½®å±æ€§ï¼š

| `src`          | `style`         | å±æ€§é›†åˆ | `name` | æ ‡è®°              |
| -------------- | --------------- | -------- | ------ | ----------------- |
| `mainHostPath` | `display: none` | `attrs`  | åº”ç”¨å | `WUJIE_DATA_FLAG` |

å°† `iframe` æ·»åŠ åˆ° `body` æœ«å°¾ï¼Œé€šè¿‡ `patchIframeVariable` ä¸ºæ²™ç®± `window` æ·»åŠ å±æ€§ [[æŸ¥çœ‹](#patchiframevariable-ä¸ºå­åº”ç”¨-window-æ·»åŠ å±æ€§)]

- æ¥è‡ªå¤‡æ³¨ï¼šå˜é‡éœ€è¦æå‰æ³¨å…¥ï¼Œåœ¨å…¥å£å‡½æ•°é€šè¿‡å˜é‡é˜²æ­¢æ­»å¾ªç¯ã€‚

**ç¬¬äºŒæ­¥ï¼šå‘èµ·å¾®ä»»åŠ¡**

- å‘èµ·å¾®ä»»åŠ¡ `stopIframeLoading` å¹¶ç»‘å®šåˆ°å®ä¾‹å±æ€§ `iframeReady` ä¸Š [[æŸ¥çœ‹](#stopiframeloadingå®ç°ä¸€ä¸ªçº¯å‡€çš„æ²™ç®±-iframe)]
- è¿”å›åˆ›å»ºçš„æ²™ç®± `iframe`

`iframeReady` ç”¨äºç¡®ä¿ `iframe` å®Œæˆåˆå§‹åŒ–ï¼Œå› æ­¤ä¼šåœ¨ä¸‹ä¸ª `fetch` æ‹¿åˆ°ç»“æœå‰æ‰§è¡Œå®Œæ¯•ï¼š

| `importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)] | `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)] | `active` [[æŸ¥çœ‹](#1-æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯)] |
| ------------------------------------------- | ------------------------------------------------------------- | -------------------------------------- |
| é€šè¿‡ `src` åŠ è½½åº”ç”¨èµ„æº                     | å·²å®Œæˆ                                                        | å·²å®Œæˆ                                 |
| æä¾› `html` èµ„æº                            | `getEmbedHTML` åŠ è½½æ ·å¼ [[æŸ¥çœ‹](#getembedhtmlè½¬æ¢æ ·å¼)]       | å·²å®Œæˆ                                 |
| æä¾› `html` èµ„æº                            | æ²¡æœ‰é™æ€æ ·å¼ï¼Œæˆ–è¢« `ignore`                                   | `await this.iframeReady` ç¡®ä¿å®Œæˆ      |

> æ‰§è¡Œé¡ºåºä»å·¦åˆ°å³ï¼Œå› ä¸º `fetch` æ—¢ä¸æ˜¯å¾®ä»»åŠ¡ä¹Ÿä¸æ˜¯å®ä»»åŠ¡ï¼Œåœ¨æ‹¿åˆ°ç»“æœå‰ä¼šæ‰§è¡Œå·²æŒ‚è½½çš„å®ä»»åŠ¡

åŸå› ï¼š

- `stopIframeLoading` é€šè¿‡ `Promise` åŒæ­¥å‡½æ•°å†…éƒ¨é€šè¿‡ `setTimeout` å‘èµ· `resolve`
- è€Œ `setTimeout` ç”±æ²™ç®±åŠ è½½çŠ¶æ€è¿›è¡Œé€’å½’ï¼Œå› æ­¤ä¼šåœ¨ä¸‹ä¸€ä¸ª `fetch` ä¹‹å‰å®Œæˆåˆå§‹åŒ–

æ²™ç®± `iframe` çš„åŠ è½½å˜åŒ–ï¼š

- `src` ä» `about:blank` åˆ°åŸºåº§ `origin`ï¼Œä¼šåœ¨ `document` å˜æ›´çš„ç¬¬ä¸€æ—¶é—´ `resolve`

**`iframeReady` éƒ½åšäº†ä»€ä¹ˆï¼š**

å‘èµ·å®ä»»åŠ¡ï¼šæ£€æµ‹å¹¶åœæ­¢åŠ è½½ `iframe`

- åœ¨ `stopIframeLoading` ä¸­é€šè¿‡ `setTimeout` è§‚å¯Ÿ `document` [[æŸ¥çœ‹](#stopiframeloadingå®ç°ä¸€ä¸ªçº¯å‡€çš„æ²™ç®±-iframe)]

ç”±å®ä»»åŠ¡å‘èµ· `resolve` æ·»åŠ å¾®ä»»åŠ¡ï¼šç»™ `iframe` æ‰“è¡¥ä¸

- è‹¥å›  `iframe` åŠ è½½å¯¼è‡´æ³¨å…¥çš„å…¨å±€å±æ€§ä¸¢å¤±ï¼Œé€šè¿‡ `patchIframeVariable` é‡æ–°æ³¨å…¥ [[æŸ¥çœ‹](#patchiframevariable-ä¸ºå­åº”ç”¨-window-æ·»åŠ å±æ€§)]
- é€šè¿‡ `initIframeDom` åˆå§‹åŒ– `iframe` çš„ `dom` ç»“æ„ [[æŸ¥çœ‹](#initiframedomåˆå§‹åŒ–-iframe-çš„-dom-ç»“æ„)]
- ä»å½“å‰ `url` æŸ¥æ‰¾å‡ºæ˜¯å¦å­˜åœ¨åº”ç”¨åçš„ `query`ï¼Œå¦‚æœæ²¡æœ‰å…ˆæ›´æ–°æ²™ç®±çš„ `history`

> é€šè¿‡åŸºåº§ `origin` + å­åº”ç”¨ `pathname` æ›´æ–° `history`ï¼Œä¸ºäº†ç›¸äº’é€šä¿¡æ²™ç®±éœ€è¦å’ŒåŸºåº§åŒåŸŸ

#### `initIframeDom`ï¼šåˆå§‹åŒ– `iframe` çš„ `dom` ç»“æ„

ç›®å½•ï¼š`iframe.ts` - `initIframeDom` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L616)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºï¼šâ‘  æ‰“è¡¥ä¸ï¼›â‘¡ å­˜åŸç”Ÿæ–¹æ³•
- `wujie`ï¼šåº”ç”¨å®ä¾‹ï¼Œç”¨äºï¼šè·å–èµ„æºé“¾æ¥å’Œ `degrade`
- `mainHostPath`ï¼šåŸºåº§ `origin`
- `appHostPath`ï¼šå­åº”ç”¨ `origin`

**ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ–°çš„ `html`**

- é€šè¿‡ `iframeWindow` æ‹¿åˆ°æ²™ç®± `document`
- é€šè¿‡ `window.document.implementation.createHTMLDocument` åˆ›å»ºä¸€ä¸ªæ–°çš„ç©ºç™½ `html` å…ƒç´ 
- å¦‚æœæ²™ç®± `iframe` ä¸­ `html` å…ƒç´ å­˜åœ¨å°±æ˜¯ç”¨æ–°çš„ `html` æ›¿æ¢ï¼Œå¦åˆ™æ·»åŠ åˆ°æ²™ç®± `document`

ä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸€ä¸ªæ–°çš„ `html`ï¼š

- å› ä¸º `initIframeDom` ä¹‹å‰é€šè¿‡ `stopIframeLoading` æ£€æµ‹æ²™ç®± `document` æ”¹å˜ [[æŸ¥çœ‹](#stopiframeloadingå®ç°ä¸€ä¸ªçº¯å‡€çš„æ²™ç®±-iframe)]
- æ²™ç®± `document` å› é…ç½®äº† `src`ï¼Œå®ä¾‹åŒ–ååŠ è½½åŸºåº§ `origin` å®Œæˆå˜æ›´
- å› æ­¤æ‰§è¡Œ `initIframeDom` æ—¶è¦ä½¿ç”¨ä¸€ä¸ªç©ºç™½çš„ ` html` å»æ›¿æ¢åŸå…ˆåŠ è½½çš„é¡µé¢

**ç¬¬äºŒæ­¥ï¼šæ³¨å…¥ `iframeWindow` å…¨å±€å±æ€§**

- `__WUJIE_RAW_DOCUMENT_HEAD__`ï¼šæŒ‡å‘æ²™ç®± `head` å…ƒç´ 

åœ¨é€šè¿‡æ‰“è¡¥ä¸æ–¹å¼è¦†ç›–åŸç”Ÿæ–¹æ³•å‰ï¼Œå…ˆè®°å½• `Document` å‡ ä¸ªåŸç”Ÿçš„æ–¹æ³•ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š

- `__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR__`ï¼š`querySelector`
- `__WUJIE_RAW_DOCUMENT_QUERY_SELECTOR_ALL__`ï¼š`querySelectorAll`
- `__WUJIE_RAW_DOCUMENT_CREATE_ELEMENT__`ï¼š`createElement`
- `__WUJIE_RAW_DOCUMENT_CREATE_TEXT_NODE__`ï¼š`createTextNode`

**ç¬¬ä¸‰æ­¥ï¼šæ‰“è¡¥ä¸**

- `initBase`ï¼šåˆå§‹åŒ– `base` æ ‡ç­¾ [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]
- `patchIframeHistory`ï¼šåŠ«æŒæ²™ç®± `iframe` çš„ `history` [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)]
- `patchIframeEvents`ï¼šåŠ«æŒæ²™ç®± `iframe` çš„ `EventListener` [[æŸ¥çœ‹](#patchiframeevents-åŠ«æŒæ²™ç®±-iframe-çš„-eventlistener)]
- `recordEventListeners`ï¼šå¦‚æœ `degrade` é™çº§å¤„ç†ï¼Œè®°å½• `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]
- `syncIframeUrlToWindow`ï¼šç›‘å¬æ²™ç®±å‰è¿›åé€€ [[æŸ¥çœ‹](#synciframeurltowindow-ç›‘å¬æ²™ç®±å‰è¿›åé€€)]
- `patchWindowEffect`ï¼šä¿®æ­£ `iframeWindow` çš„ `effect` [[æŸ¥çœ‹](#patchwindoweffectä¿®æ­£-iframewindow-çš„-effect)]
- `patchDocumentEffect`ï¼šä¿®æ­£æ²™ç®± `document` çš„ `effect` [[æŸ¥çœ‹](#patchdocumenteffectä¿®æ­£æ²™ç®±-document-çš„-effect)]
- `patchNodeEffect`ï¼šä¿®æ­£ `node` çš„ `effect` [[æŸ¥çœ‹](#patchnodeeffectä¿®æ­£å®¹å™¨èŠ‚ç‚¹çš„-effect)]
- `patchRelativeUrlEffect`ï¼šä¿®å¤åŠ¨æ€æ·»åŠ å…ƒç´ èµ„æº [[æŸ¥çœ‹](#patchrelativeurleffectä¿®å¤åŠ¨æ€æ·»åŠ å…ƒç´ èµ„æº)]

#### `base`ï¼šæ ‡ç­¾æ“ä½œ

ç›®çš„ï¼šåœ¨æ²™ç®± `iframe` ä¸­æ·»åŠ ä¸€ä¸ª `base` å…ƒç´ 

- ç”±äºå®¹å™¨æ¸²æŸ“æ—¶é€šè¿‡ `patchElementEffect` å°†æ¯ä¸ªå…ƒç´  `ownerDocument` æŒ‡å‘æ²™ç®± `document` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]
- æ‰€ä»¥éœ€è¦åœ¨æ²™ç®± `iframe` é€šè¿‡ `base` å…ƒç´ ï¼Œä¿®æ­£å®¹å™¨ä¸­æ‰€æœ‰èµ„æºçš„ç›¸å¯¹é“¾æ¥

æ“ä½œåˆ† 2 éƒ¨åˆ†ï¼Œå³ï¼šåˆå§‹åŒ–å’ŒåŠ¨æ€æ›´æ–°

**`initBase` åˆå§‹åŒ– `base` æ ‡ç­¾**

ç›®å½•ï¼š`iframe.ts` - `initBase` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L600)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºè·å–æ²™ç®± `document` å’Œåˆå§‹åŒ–çš„ `href`
- `url`ï¼šå­åº”ç”¨çš„å…¥å£é“¾æ¥

æµç¨‹ï¼š

- é€šè¿‡ `iframeWindow` æ‹¿åˆ°æ²™ç®±çš„ `document` å¹¶åˆ›å»º `base` å…ƒç´ 
- é€šè¿‡ `anchorElementGenerator` åˆ›å»º 2 ä¸ªé“¾æ¥å…ƒç´ ï¼šåŸºåº§ `origin`ï¼Œå­åº”ç”¨å…¥å£é“¾æ¥ [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]
- ä½¿ç”¨å­åº”ç”¨ `origin` + åŸºåº§ `pathname` ä½œä¸º `base` å…ƒç´ çš„ `href`ï¼Œä¹‹åæ’å…¥æ²™ç®± `head` ä¸­

> åˆå§‹åŒ–æ—¶æ²™ç®± `iframe` çš„é“¾æ¥ä¸º `mainHostPath`ï¼šåŸºåº§ `origin`ï¼Œè€Œ `pathname` ä¸ºç©º

**`updateBase` åŠ¨æ€æ›´æ–° `base` æ ‡ç­¾**

ç›®å½•ï¼š`iframe.ts` - `updateBase` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L204)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºè·å–æ²™ç®± `document` å’Œå½“å‰çš„ `href`
- `appHostPath`ï¼šå­åº”ç”¨ `origin`
- `mainHostPath`ï¼šåŸºåº§ `origin`

æµç¨‹ï¼š

- é€šè¿‡ `new URL` å°†æ²™ç®±å½“å‰çš„ `url` ä¸­åŸºåº§çš„ `origin` æ›¿æ¢æˆå­åº”ç”¨ `origin`
- è°ƒç”¨ `iframe` åŸç”Ÿçš„æ–¹æ³•æŸ¥æ‰¾ `base` å…ƒç´ å¹¶æ›´æ–° `href` å±æ€§

> æºç ä¸­ `baseUrl.href` å³æ˜¯ `appHostPath + baseUrl.pathname`ï¼Œæ²¡å¿…è¦ç®— 2 æ¬¡

#### `stopIframeLoading`ï¼šå®ç°ä¸€ä¸ªçº¯å‡€çš„æ²™ç®± `iframe`

é˜²æ­¢è¿è¡Œä¸»åº”ç”¨çš„ `js` ä»£ç ï¼Œç»™å­åº”ç”¨å¸¦æ¥å¾ˆå¤šå‰¯ä½œç”¨ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰

ç›®å½•ï¼š`iframe.ts` - `stopIframeLoading` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L644)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºï¼šâ‘  è·å–æ²™ç®± `document`ï¼Œâ‘¡ åœæ­¢åŠ è½½

åŸå› ï¼š

- å­åº”ç”¨çš„ `script` è¿è¡Œåœ¨ä¸€ä¸ªå’ŒåŸºåº§åŒåŸŸçš„ `iframe` æ²™ç®±ä¸­
- è®¾ç½® `src` ä¸º `mainHostPath`ï¼Œå³åŸºåº§ `origin` ä¼šä¸»åŠ¨åŠ è½½åŸºåº§
- æ‰€ä»¥å¿…é¡»åœ¨ `iframe` å®ä¾‹åŒ–å®Œæˆå‰ï¼Œè¿˜æ²¡æœ‰åŠ è½½å®Œ `html` æ—¶ä¸­æ–­åŠ è½½ï¼Œé˜²æ­¢æ±¡æŸ“å­åº”ç”¨

æ¥è‡ªæ–‡æ¡£çš„æé†’ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/information.html#%E7%BB%86%E8%8A%82)]ï¼š

- è‹¥æ²™ç®±æ²¡æœ‰å®Œæˆå®ä¾‹åŒ–å°± `stop`ï¼Œæ­¤æ—¶é“¾æ¥ä¸º `about:blank` ä¼šå¯¼è‡´å­åº”ç”¨è·¯ç”±æ— æ³•è¿è¡Œ
- å¦‚æœæ²™ç®±å®ä¾‹åŒ–æ—¶é‡‡ç”¨ `document.write` æ“¦é™¤ï¼Œè·¯ç”±çš„åŒæ­¥åŠŸèƒ½å°†å¤±è´¥

æµç¨‹ï¼š

- è®°å½•æ²™ç®± `document` åˆå§‹åŒ–æ—¶ä½œä¸º `oldDoc`ï¼Œæ­¤æ—¶é“¾æ¥æ˜¯ `about:blank`
- å‘èµ·å¹¶è¿”å›å¾®ä»»åŠ¡ï¼Œ`Promise` åŒæ­¥å‡½æ•°ä¸­åˆ›å»ºå¹¶æ‰§è¡Œå‡½æ•° `loop` ä½œä¸º `document` æ£€æµ‹
- åœ¨ `loop` ä¸­å‘èµ·å®ä»»åŠ¡ï¼Œç”±äº `appendChild` æ²™ç®±æ˜¯åŒæ­¥æ“ä½œï¼Œæ‰€ä»¥åœ¨å®ä»»åŠ¡æ‰§è¡Œå‰ä¼šåŠ è½½æ²™ç®± `iframe`
- åœ¨å®ä»»åŠ¡ä¸­è·å–æ²™ç®±å½“å‰ `document` å’Œ `oldDoc` è¿›è¡Œæ¯”è¾ƒ
- å¦‚æœæ²™ç®± `iframe` æ²¡æœ‰å®Œæˆå®ä¾‹åŒ–å¯¼è‡´ `document` ä¸å˜ï¼Œå°†é‡æ–°å‘èµ·ä¸€è½® `loop` å®ä»»åŠ¡
- ç›´åˆ° `iframe` å®Œæˆå®ä¾‹åŒ–ï¼Œ`document` å‘ç”Ÿæ”¹å˜ï¼Œåœæ­¢åŠ è½½å¹¶é€šè¿‡ `resolve` åœ¨è¿”å›çš„å¾®ä»»åŠ¡ä¸­æ·»åŠ é˜Ÿåˆ—

> ç”±äºæ²™ç®± `iframe` åœ¨åˆå§‹åŒ–ä¹‹å‰å·²ç»è®¾ç½®ä¸å¯è§ï¼Œæ‰€ä»¥åŠ è½½è¿‡ç¨‹ä¹Ÿå…¨ç¨‹ä¸å¯è§

#### `syncIframeUrlToWindow` ç›‘å¬æ²™ç®±å‰è¿›åé€€

æ²™ç®± `iframe` ä¸­ç›‘å¬ `popstate` å‰è¿›åé€€ã€`hashchange` ç›‘å¬ `hash` å˜åŒ–ï¼ŒåŒæ­¥è·¯ç”±åˆ°ä¸»åº”ç”¨

ç›®å½•ï¼š`iframe.ts` - `syncIframeUrlToWindow` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L697)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºæ·»åŠ ç›‘å¬äº‹ä»¶

æµç¨‹ï¼šå½“æ²™ç®±è·¯ç”±å‘ç”Ÿæ”¹å˜é€šè¿‡ `syncUrlToWindow` åŒæ­¥åˆ°åŸºåº§ [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)]

è°ƒç”¨åœºæ™¯ï¼š

- `patchIframeHistory`ï¼šæ‹¦æˆªå­åº”ç”¨è·¯ç”±æ›´æ–°ï¼ŒåŒæ­¥æ›´æ–°æ²™ç®± `history` [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)]
- `iframeGenerator`ï¼šæ²™ç®±åˆå§‹åŒ–æœ€åä¸€æ­¥åŒæ­¥è·¯ç”± [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]
- `syncUrlToIframe`ï¼šåŒæ­¥è·¯ç”±åˆ°å­åº”ç”¨ [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]

> è€Œæµè§ˆå™¨çš„å‰è¿›åé€€ï¼Œä»¥åŠ `url` çš„å˜æ›´ï¼Œä¼šå¯¼è‡´åŸºåº§é‡æ–°æ¸²æŸ“ï¼Œæ ¹æ®æƒ…å†µé‡æ–°å¯åŠ¨å­åº”ç”¨

#### `renderIframeReplaceApp`ï¼šåŠ è½½ `iframe` æ›¿æ¢å­åº”ç”¨

ç›®å½•ï¼š`iframe.ts` - `renderIframeReplaceApp` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/iframe.ts#L799)]

å‚æ•°ï¼š

- `src`ï¼šè®¡åˆ’åˆ›å»º `iframe` çš„é“¾æ¥
- `element`ï¼šè¦æ›¿æ¢çš„æ¸²æŸ“å®¹å™¨çš„çˆ¶çº§æŒ‚è½½ç‚¹
- `degradeAttrs`ï¼šåˆ›å»º `iframe` çš„å±æ€§ï¼Œç”±é…ç½®æä¾›ï¼Œè§ï¼š`degrade` [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]

è°ƒç”¨åœºæ™¯ï¼š

- é€šè¿‡ `locationHrefSet` æ‹¦æˆªå­åº”ç”¨ `location.href` è·³è½¬ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]
- é€šè¿‡ `processAppForHrefJump` æ‹¦æˆªå‰è¿›çš„é“¾æ¥æ¥è‡ªç¬¬ä¸‰æ–¹ç½‘é¡µ [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

åŠ«æŒå®¹å™¨å’Œé™çº§çš„ `iframe` å®¹å™¨åˆ›å»ºæ–¹å¼æ˜¯ä¸€æ ·çš„ [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]ï¼š

- åˆ›å»º `iframe` å…ƒç´ ï¼Œå®šä¹‰ä¸€ä¸ªå®½é«˜ `100%` çš„æ ·å¼
- é€šè¿‡ `setAttrsToElement` ä¸º `iframe` æ·»åŠ æ ·å¼ã€`src`ã€`degradeAttrs`
- é€šè¿‡ `renderElementToContainer` æ¸…ç©ºå®¹å™¨æŒ‚è½½å…ƒç´ ï¼Œå¹¶æ·»åŠ  `iframe` å…ƒç´  [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]

### è¾…åŠ©æ–¹æ³• - è·¯ç”±åŒæ­¥å’Œé“¾æ¥å¤„ç†

å›´ç»•åº”ç”¨ä¸­çš„è·¯ç”±ã€é“¾æ¥å½’çº³ç›¸å…³æ–¹æ³•

#### `syncUrlToWindow`ï¼šåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨

ç›®å½•ï¼š`sync.ts` - `syncUrlToWindow` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sync.ts#L9)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºè·å–ï¼šåº”ç”¨å®ä¾‹ã€æ²™ç®± `location`

è°ƒç”¨åœºæ™¯ï¼š

- `active` æ¿€æ´»åº”ç”¨æ—¶åŒæ­¥è·¯ç”±ï¼Œè§ï¼šåŒæ­¥è·¯ç”± [[æŸ¥çœ‹](#3-åŒæ­¥è·¯ç”±)]
- `syncIframeUrlToWindow`ï¼šç›‘å¬æ²™ç®± `window`ï¼š`popstate`ã€`hashchange` [[æŸ¥çœ‹](#synciframeurltowindow-ç›‘å¬æ²™ç®±å‰è¿›åé€€)]
- `patchIframeHistory`ï¼šåŠ«æŒæ²™ç®± `history`ï¼š`pushState`ã€`replaceState` [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)]

ä¸åšå¤„ç†çš„æƒ…å†µï¼š

- æ²¡æœ‰é…ç½® `sync` åŒæ­¥è·¯ç”±å¹¶ä¸”åœ¨åŸºåº§é“¾æ¥ `search` ä¸­æ‰¾ä¸åˆ°å½“å‰åº”ç”¨å

**ç¬¬ä¸€æ­¥ï¼šæå–é…ç½®**

- ä»åº”ç”¨å®ä¾‹ä¸­è·å–ï¼š`sync` åŒæ­¥è·¯ç”±ã€`id` åº”ç”¨åã€`prefix` çŸ­é“¾æ¥ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]
- æå–å½“å‰çš„ `url` è½¬å˜ä¸º `HTMLAnchorElement` å¯¹è±¡ï¼Œè§ï¼š`anchorElementGenerator` [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]
- é€šè¿‡ `HTMLAnchorElement` æ‹¿åˆ° `queryMap`ï¼Œè§ï¼š`getAnchorElementQueryMap` [[æŸ¥çœ‹](#getanchorelementquerymap-è½¬åŒ–-urlsearch-ä¸ºé”®å€¼å¯¹è±¡)]
- ä»æ²™ç®± `location` ä¸­æå– `pathname` + `search` + `hash`ï¼Œä½œä¸ºå½“å‰å­åº”ç”¨ç›®æ ‡è·¯ç”± `curUrl`
- å£°æ˜ä¸€ä¸ªå˜é‡ `validShortPath` ç”¨äºè®°å½•åŒ¹é…çš„çŸ­é“¾æ¥å

**ç¬¬äºŒæ­¥ï¼šå¤„ç†çŸ­è·¯å¾„**

éå† `prefix` æ‹¿åˆ°çŸ­é“¾å `shortPath` å’Œå¯¹åº”çš„é•¿é“¾æ¥ `longPath`ï¼š

- è¦æ±‚ `curUrl` å¿…é¡»ä»¥ `longPath` å¼€å¤´ï¼Œæ›´æ–° `validShortPath` ä¸º `shortPath`
- æ›´æ–°ä¼šå–æœ€å¤§ `longPath` ç»“æœï¼Œä¾‹å¦‚ï¼š`/a/b/c` ä¼šä¼˜å…ˆäº `/a/b`

**ç¬¬ä¸‰æ­¥ï¼šåŒæ­¥è·¯ç”±**

`sync` å·²é…ç½®ï¼š

- é€šè¿‡ `encodeURIComponent` æ›´æ–° `queryMap[id]` çš„å€¼ä¸º `curUrl`
- å¦‚æœ `validShortPath` åŒ¹é…åˆ°å€¼ï¼Œä¼˜å…ˆæ›¿æ¢ `curUrl` ä¸­ `longPath` éƒ¨åˆ†ä¸º `{çŸ­é“¾å}`

> `sync` æœªé…ç½®ï¼šä» `queryMap` ä¸­åˆ é™¤åº”ç”¨å¯¹åº”çš„å€¼

**ç¬¬å››æ­¥ï¼šæ›´æ–°è·¯ç”±**

- å°†åŒæ­¥åçš„ `queryMap` è¿˜åŸæˆ `url.search`ï¼Œå¹¶æ›´æ–° `winUrlElement` å¯¹è±¡
- å½“ `winUrlElement` é“¾æ¥å‘ç”Ÿæ”¹å˜ï¼Œé€šè¿‡ `window.history.replaceState` æ›´æ–°å½“å‰ `url`

#### `syncUrlToIframe`ï¼šåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨

ç›®å½•ï¼š`sync.ts` - `syncUrlToIframe` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sync.ts#L51)]

å‚æ•°ï¼š

- `iframeWindow`ï¼šæ²™ç®± `window`ï¼Œç”¨äºè·å–ï¼šåº”ç”¨å®ä¾‹ã€æ²™ç®± `location`ã€æ²™ç®± `history`

è°ƒç”¨åœºæ™¯ï¼š

- `active` æ¿€æ´»åº”ç”¨æ—¶åŒæ­¥è·¯ç”±ï¼Œè§ï¼šåŒæ­¥è·¯ç”± [[æŸ¥çœ‹](#3-åŒæ­¥è·¯ç”±)]

> éœ€è¦åŸºåº§å’Œåº”ç”¨éƒ½åŒæ­¥è·¯ç”±æ—¶ï¼Œä¸€å®šä¼šå…ˆæ‰§è¡Œ `syncUrlToIframe` åŒæ­¥è·¯ç”±åˆ°å­åº”ç”¨

**ç¬¬ä¸€æ­¥ï¼šè·å–é…ç½®**

- ä»æ²™ç®± `location` ä¸­æå–ï¼š`pathname`ã€`search`ã€`hash`ï¼Œå†³å®šæ˜¯å¦æ›´æ–°è·¯ç”±
- ä»åº”ç”¨å®ä¾‹ä¸­è·å–ï¼š`id`ã€`url`ã€`sync`ï¼Œ`execFlag`ã€`prefix`ï¼Œç”¨äºè®¡ç®—åº”ç”¨è·¯ç”±
- ä»åº”ç”¨å®ä¾‹ä¸­è·å–ï¼š`inject` å¾—åˆ°åŸºåº§ `origin` ä¸ºæ²™ç®± `iframe` æ›´æ–° `history`

åŒæ­¥è·¯ç”±åˆ°å­åº”ç”¨æœ€ç»ˆç›®çš„ï¼š

- ä»¥èµ„æºå…¥å£é“¾æ¥ä½œä¸ºåˆå§‹è·¯ç”±ï¼šåŸºåº§ `origin` + èµ„æºå…¥å£ `pathname` + `search` + `hash`
- ä½†åŒæ­¥è·¯ç”±åˆ°åŸºåº§æœ‰å¯èƒ½ä¼šé€šè¿‡ `prefix` è½¬æ¢è¿æ¥ï¼Œè¿™å°±è¦é€šè¿‡ `getSyncUrl` è·å–èµ„æºé“¾æ¥ [[æŸ¥çœ‹](#getsyncurlè·å–éœ€è¦åŒæ­¥çš„-url)]

> `getSyncUrl` ä¼šæ ¹æ®å½“å‰æµè§ˆçš„é“¾æ¥ï¼Œæå–åº”ç”¨å¯¹åº”çš„è·¯ç”±

å› æ­¤å¯¹äºé…ç½® `sync` åŒæ­¥è·¯ç”±ï¼Œä¸” `execFlag` åº”ç”¨è¿˜æœªå¯åŠ¨æ‰éœ€è¦è½¬æ¢ï¼š

- `sync` å†³å®šäº† `syncUrlToWindow` è¦ä¸è¦é€šè¿‡ `prefix` è½¬æ¢ä¸ºçŸ­è¿æ¥ [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)]
- `execFlag` å†³å®šäº†å½“å‰æ˜¯å¦ä¸ºé¦–æ¬¡åŠ è½½ï¼Œå†æ¬¡åŠ è½½æ²™ç®± `iframe` çš„è·¯ç”±å·²å®Œæˆäº†è½¬æ¢

é¦–æ¬¡åŠ è½½åŒ…æ‹¬ï¼šåˆ·æ–°é¡µé¢ã€åˆ‡æ¢æœªåŠ è½½è¿‡çš„åº”ç”¨ï¼Œè¿™æ ·å¾—åˆ° 2 ä¸ªè·¯ç”±ï¼š

- `preAppRoutePath`ï¼šé¦–æ¬¡åŠ è½½æ²™ç®± `location` ä¸ºåŸºåº§ `origin`ï¼Œè®¡ç®—çš„åˆ°çš„è·¯ç”±ä¸º `/`
- `appRoutePath`ï¼šæ ¹æ®èµ„æºå…¥å£é“¾æ¥ï¼Œå¾—åˆ° `pathname` + `search` + `hash`

> `appRoutePath` å°†ä½œä¸ºè®¡åˆ’åŒæ­¥çš„è·¯ç”±ï¼Œä¸€æ—¦åŒæ­¥ï¼Œä¸‹æ¬¡åˆ‡æ¢åº”ç”¨æ— éœ€å†æ›´æ–°è·¯ç”±

åªæœ‰ `umd` æ¨¡å¼éœ€è¦åŒºåˆ†é¦–æ¬¡åŠ è½½ï¼š

- `alive` åªæœ‰é¦–æ¬¡åŠ è½½æ‰éœ€è¦åŒæ­¥è·¯ç”±åˆ°å­åº”ç”¨ï¼Œé‡å»ºæ¨¡å¼æ¯æ¬¡éƒ½æ˜¯é¦–æ¬¡åŠ è½½

é€šè¿‡ `getSyncUrl` è·å–èµ„æºé“¾æ¥ï¼Œæœ‰å¯èƒ½æ¥è‡ª `locationHrefSet` è·¯ç”±åŠ«æŒ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]ï¼š

- åŠ«æŒè·¯ç”±ä¼šè®°å½•å®Œæ•´çš„ `url`ï¼Œä¾‹å¦‚ï¼š`project={https://example.com}`
- å¯¹äº `http` å¼€å¤´çš„é“¾æ¥å…¨éƒ¨ä»¥èµ„æºå…¥å£ä½œä¸ºé“¾æ¥

**ç¬¬äºŒæ­¥ï¼šæ¯”è¾ƒè·¯ç”±è¿›è¡ŒåŒæ­¥**

- `appRoutePath` éœ€è¦é€šè¿‡ `appRouteParse` è®¡ç®—å¾—åˆ° [[æŸ¥çœ‹](#approuteparse-æå–é“¾æ¥)]
- æ¯”è¾ƒ `preAppRoutePath` å’Œ `appRoutePath`ï¼Œè‹¥ä¸ç›¸ç­‰åˆ™é€šè¿‡æ²™ç®± `replaceState` æ›´æ–°è·¯ç”±

å­åº”ç”¨è·¯ç”±å’Œèµ„æºå…¥å£é“¾æ¥æå–çš„è·¯ç”±ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œä¸éœ€è¦æ›´æ–°è·¯ç”±ï¼š

- é¦–æ¬¡åŠ è½½æ²™ç®±çš„è·¯ç”±æ˜¯ `/`ï¼Œåº”ç”¨å…¥å£é“¾æ¥è™½ç„¶å’ŒåŸºåº§ä¸åŒï¼Œä½†è·¯ç”±ä¹Ÿæœ‰å¯èƒ½æ˜¯ `/`
- åˆ‡æ¢åº”ç”¨ï¼Œæ²™ç®±é“¾æ¥å·²ä¸ºï¼šåŸºåº§ `origin` + `appRoutePath`ï¼Œè·¯ç”±éƒ½æ˜¯ `appRoutePath`

#### `clearInactiveAppUrl`ï¼šæ¸…ç†è·¯ç”±

ç›®å½•ï¼š`sync.ts` - `clearInactiveAppUrl` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sync.ts#L72)]

æ¸…ç†å­åº”ç”¨è¿‡æœŸçš„åŒæ­¥å‚æ•°ï¼š

- é€šè¿‡ `anchorElementGenerator` å°†å½“å‰çš„é“¾æ¥è½¬æ¢ä¸º `HTMLAnchorElement` å¯¹è±¡ [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]
- é€šè¿‡ `getAnchorElementQueryMap` å°†é“¾æ¥å¯¹è±¡çš„ `search` è½¬åŒ–ä¸ºé”®å€¼å¯¹ [[æŸ¥çœ‹](#getanchorelementquerymap-è½¬åŒ–-urlsearch-ä¸ºé”®å€¼å¯¹è±¡)]

éå† `search` å¯¹è±¡æ‰€æœ‰çš„ `key`ï¼Œä½œä¸ºåº”ç”¨åæå–å¹¶ç­›é€‰åº”ç”¨ï¼Œè¦æ±‚ï¼š

| åº”ç”¨å®ä¾‹ | `execFlag` | `activeFlag`                                         | `sync`   | `hrefFlag`                                     |
| -------- | ---------- | ---------------------------------------------------- | -------- | ---------------------------------------------- |
| å­˜åœ¨     | å·²å¯åŠ¨     | é€šè¿‡ `unmount` å¤±æ´» [[æŸ¥çœ‹](#1-å¸è½½åº”ç”¨---æ‰€æœ‰æ¨¡å¼)] | åŒæ­¥è·¯ç”± | å¹¶é `hrefFlag` åŠ«æŒé“¾æ¥ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)] |

> å°†æ¡ä»¶åŒ¹é…çš„åº”ç”¨ä»è·¯ç”±ä¸­åˆ é™¤

ç­›é€‰åè½¬æ¢ä¸º `search` æ›´æ–° `HTMLAnchorElement` å¯¹è±¡ï¼Œä¹‹åæ¯”è¾ƒå…¨å±€ `location.href`ï¼š

- å¦‚æœä¸ä¸€è‡´ `replace` æ›¿æ¢ `history` é“¾æ¥

è°ƒç”¨åœºæ™¯ï¼š

- ä»…é™ `unmount` å¸è½½åº”ç”¨ [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]

#### `appRouteParse` æå–é“¾æ¥

ç›®å½•ï¼š`utils.ts` - `appRouteParse` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L122)]

å‚æ•°ï¼š

- `url`ï¼šå­—ç¬¦ç±»å‹çš„é“¾æ¥

è¿”å›ï¼šæ ¹æ®ä¼ å…¥çš„é“¾æ¥æå–å¯¹è±¡åŒ…å« 3 ä¸ªå±æ€§

- `urlElement`ï¼šé€šè¿‡ `anchorElementGenerator` è½¬æ¢é“¾æ¥ä¸º `HTMLAnchorElement` å¯¹è±¡ [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]
- `appHostPath`ï¼šæå–é“¾æ¥ `origin`
- `appRoutePath`ï¼šåŒ…å«é“¾æ¥çš„ `pathname` + `search` + `hash`

è°ƒç”¨åœºæ™¯æœ‰ 2 ä¸ªï¼š

- åº”ç”¨å®ä¾‹åˆå§‹åŒ–ï¼Œç”¨äºæ‹†è§£èµ„æºå…¥å£é“¾æ¥ç”¨äºåˆ›å»ºæ²™ç®±å’Œä»£ç†ï¼Œè§ï¼šåˆ›å»ºæ²™ç®± `iframe` [[æŸ¥çœ‹](#3-åˆ›å»ºæ²™ç®±-iframe)]
- `syncUrlToIframe` åŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨ [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]

#### `anchorElementGenerator`ï¼šè½¬æ¢ `url`

å°† `url` è½¬æ¢ä¸º `HTMLAnchorElement` å¯¹è±¡

ç›®å½•ï¼š`utils.ts` - `anchorElementGenerator` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L138)]

å‚æ•°ï¼š

- `url`ï¼šé“¾æ¥ `string` ç±»å‹

è¿”å›ï¼š

- `HTMLAnchorElement` å¯¹è±¡

`syncUrlToIframe` åŒæ­¥è·¯ç”±æ—¶å¯èƒ½ä¼šé€šè¿‡ `appRouteParse` é€ä¼ ç›¸å¯¹è·¯å¾„ä½œä¸º `url` [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]ï¼š

- è¿™æ—¶åˆ›å»ºçš„èµ„æºä¼šæ ¹æ®æ²™ç®±ä¸­ `base` å…ƒç´ å†³å®š `href` [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)]

#### `getAnchorElementQueryMap` è½¬åŒ– `url.search` ä¸ºé”®å€¼å¯¹è±¡

ç›®å½•ï¼š`utils.ts` - `getAnchorElementQueryMap` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L145)]

å‚æ•°ï¼š

- `anchorElement`ï¼š`HTMLAnchorElement` ç±»å‹çš„å¯¹è±¡

è¿”å›ï¼š

- `search` é”®å€¼å¯¹è±¡ï¼šç±»å‹ `{ [key: string]: string }`

æµç¨‹ï¼š

- å°†é“¾æ¥ä¸­ `search` æŒ‰ç…§ `&` æ‹†åˆ†æˆæ•°ç»„ï¼Œéå†å¹¶æ ¹æ® `=` æ‹†åˆ†æˆ `key` å’Œ `value`
- å¦‚æœ `key` å’Œ `value` éƒ½å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œåˆ™ä½œä¸ºé”®å€¼å¯¹æ·»åŠ åˆ°å¯¹è±¡
- æœ€åè¿”å›é”®å€¼å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•åŒ¹é…çš„é”®å€¼ï¼Œè¿”å›ä¸€ä¸ªç©ºå¯¹è±¡

#### `getSyncUrl`ï¼šè·å–éœ€è¦åŒæ­¥çš„ `url`

ä»åŸºåº§æµè§ˆé“¾æ¥ä¸­æå– `search`ï¼ŒåŒ¹é…å¹¶å¤„ç†åè¿”å›å½“å‰åº”ç”¨è·¯ç”±

ç›®å½•ï¼š`utils.ts` - `getSyncUrl` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L221)]

å‚æ•°ï¼š

- `id`ï¼šåº”ç”¨åï¼Œç”¨äºä» `search` é”®å€¼å¯¹ä¸­å–å‡ºè·¯ç”±
- `prefix`ï¼šé…ç½®çš„çŸ­é“¾æ¥é›†åˆï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/sync.html#%E7%9F%AD%E8%B7%AF%E5%BE%84)]

è¿”å›å­—ç¬¦ç±»å‹çš„å­åº”ç”¨è·¯ç”±ï¼Œæœ‰ 3 ç§æƒ…å†µï¼š

- `pathname`ï¼šåŒ¹é…åˆ°å­åº”ç”¨è·¯ç”±
- ç»å¯¹è·¯å¾„çš„ `url`ï¼šåŠ«æŒ `href` å®ç°çš„æ‹¦æˆªè·¯ç”±ï¼Œè§ï¼š`pushUrlToWindow` [[æŸ¥çœ‹](#pushurltowindowæ¨é€-url-åˆ°åŸºåº§è·¯ç”±)]
- ç©ºå­—ç¬¦ï¼šæ²¡æœ‰åŒ¹é…åˆ°å­åº”ç”¨è·¯ç”±

æå–è·¯ç”±ï¼š

- é€šè¿‡ `anchorElementGenerator` è½¬æ¢åŸºåº§é“¾æ¥ä¸º `HTMLAnchorElement` å¯¹è±¡ [[æŸ¥çœ‹](#anchorelementgeneratorè½¬æ¢-url)]
- é€šè¿‡ `getAnchorElementQueryMap` è½¬æ¢åŸºåº§é“¾æ¥ `search` æ‹¿åˆ°é”®å€¼å¯¹ `queryMap` [[æŸ¥çœ‹](#getanchorelementquerymap-è½¬åŒ–-urlsearch-ä¸ºé”®å€¼å¯¹è±¡)]
- ä½¿ç”¨åº”ç”¨åæå– `queryMap` æ‹¿åˆ°å­åº”ç”¨è·¯ç”±ï¼Œé€šè¿‡ `decodeURIComponent` è§£æè·¯ç”±

> å¦‚æœåº”ç”¨åä¸å­˜åœ¨ `queryMap` çš„é”®åä¸­ï¼Œæ‹¿åˆ°çš„æ˜¯ç©ºå­—ç¬¦

å¤„ç†è·¯ç”±çš„å‰ææ˜¯è·¯ç”±é€šè¿‡ `prefix` æ›¿æ¢äº†è·¯ç”±ä¸ºçŸ­è¿æ¥ `project={short-name}`ï¼š

- åˆ¤æ–­ä¾æ®ï¼šæä¾›äº† `prefix`ï¼Œé€šè¿‡æ­£åˆ™åŒ¹é…è·¯ç”±å¤§æ‹¬å·ä¸­é—´çš„çŸ­è¿æ¥
- å°†çŸ­è¿æ¥ä» `prefix` æ‰¾åˆ°å¯¹åº”çš„å®Œæ•´è·¯å¾„ï¼Œæ›¿æ¢åè¿”å› `pathname`

> å¦‚æœå› ä¸ºä¸åŒ¹é…å¾—åˆ°ç©ºå­—ç¬¦ï¼Œæ˜¯æ— æ³•é€šè¿‡æ­£åˆ™åŒ¹é…ï¼Œä»æ—§æ˜¯ç©ºå­—ç¬¦

å­˜åœ¨ä¸€ä¸ªè¯­æ„ä¸Šçš„ `bug`ï¼š

- æ­£åˆ™åŒ¹é…å¾—åˆ°çŸ­è¿æ¥ï¼Œå¦‚æœåœ¨ `prefix` é›†åˆä¸­æ‰¾ä¸åˆ°å¯¹åº”è·¯ç”±æ€ä¹ˆåŠï¼Ÿ

æ­£å¸¸åŠ è½½çš„æƒ…å†µä¸‹ä¸ä¼šå‡ºç°é—®é¢˜ï¼Œå…ˆçœ‹åŒæ­¥è·¯ç”±çš„æµç¨‹ï¼š

| æµç¨‹                           | æ‰§è¡Œæ–¹æ³•                                                           | æ“ä½œ                                                                                      |
| ------------------------------ | ------------------------------------------------------------------ | ----------------------------------------------------------------------------------------- |
| åˆæ¬¡åŠ è½½ï¼ŒåŒæ­¥è·¯ç”±åˆ°å­åº”ç”¨     | `syncUrlToIframe` [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)] | å‡å®šåŸºåº§è·¯ç”±ä¸º `/react`                                                                   |
| è·å–éœ€è¦åŒæ­¥çš„è·¯ç”±             | `getSyncUrl` [[æŸ¥çœ‹](#getsyncurlè·å–éœ€è¦åŒæ­¥çš„-url)]               | æ‰¾ä¸åˆ° `search`ï¼Œè¿”å›ç©ºå­—ç¬¦                                                               |
| å›åˆ°åŒæ­¥è·¯ç”±åˆ°å­åº”ç”¨           | `syncUrlToIframe` [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)] | å› æ‹¿åˆ°ç©ºå­—ç¬¦ï¼Œé‡‡ç”¨èµ„æºå…¥å£é“¾æ¥ä½œä¸ºæ²™ç®±è·¯ç”±                                                |
| åŒæ­¥è·¯ç”±åˆ°åŸºåº§                 | `syncUrlToWindow` [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)] | å‡å®šå­åº”ç”¨è·¯ç”±æ˜¯ `/home/path`ï¼ŒçŸ­è¿æ¥å¯¹åº” `home`ï¼ŒåŸºåº§è·¯ç”±æ›´æ–°ä¸ºï¼š`/react?project={home}` |
| åˆ·æ–°é¡µé¢ï¼Œå†æ¬¡åŒæ­¥è·¯ç”±åˆ°å­åº”ç”¨ | `syncUrlToIframe` [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)] | åŸºåº§è·¯ç”±ä¸ºï¼š`/react?project={home}`                                                       |
| è·å–éœ€è¦åŒæ­¥çš„è·¯ç”±             | `getSyncUrl` [[æŸ¥çœ‹](#getsyncurlè·å–éœ€è¦åŒæ­¥çš„-url)]               | åŒ¹é…è¿”å› `/home/path` ä½œä¸ºå­åº”ç”¨è·¯ç”±                                                      |
| å†æ¬¡åŒæ­¥è·¯ç”±åˆ°åŸºåº§             | `syncUrlToWindow` [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)] | åŸºåº§è·¯ç”± `search` æ²¡æœ‰å˜åŒ–ï¼Œä¸åšæ›´æ–°                                                      |

ç”±æ­¤å¯ä»¥çœ‹å‡ºè·¯ç”±ä¸­çš„çŸ­è¿æ¥éƒ½æ¥è‡ª `syncUrlToWindow` æ›´æ–°åˆ°åŸºåº§ï¼Œæ›´æ–°å‰å·²é€šè¿‡ `prefix` åŒ¹é…å¹¶æå–

> ä¸Šé¢çš„ä¾‹å­ä¸­ `{home}` åº”è¯¥é€šè¿‡ `endecodeURIComponent` ç¼–è¯‘ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºç›´æ¥å±•ç¤ºäº†

é™¤éæ‰‹åŠ¨æä¾›é”™è¯¯çš„é“¾æ¥ï¼Œè¿˜æ˜¯ä¸Šé¢çš„ä¾‹å­ï¼š

- æ‰‹åŠ¨è®¿é—®è·¯ç”± `/react?project={test}`ï¼Œä¼šå›  `prefix` æ‰¾ä¸åˆ°è¿”å›å­—ç¬¦ç±»å‹çš„è·¯ç”±ï¼š`undefined`

#### `getAbsolutePath`ï¼šè·å–ç»å¯¹è·¯å¾„

ç›®å½•ï¼š`utils.ts` - `getAbsolutePath` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L206)]

å‚æ•°ï¼š

- `url`ï¼šä»»æ„å­—ç¬¦ï¼ŒåŒ…æ‹¬ `url`ã€`pathname`ã€`search`ã€`hash`ã€ç©ºå­—ç¬¦
- `base`ï¼šå‚è€ƒçš„ `url`ï¼Œå¿…é¡»ä¸º `http` å¼€å¤´çš„ç»å¯¹è·¯å¾„ï¼Œå¿…å¡«é¡¹
- `hash`ï¼šæå– `hash`ï¼Œå¯é€‰ `boolean` å‹

`base` æä¾›é `http` å¼€å¤´çš„è·¯å¾„æœ‰ä¸¤ç§æƒ…å†µï¼š

- æ— æ•ˆï¼šå‚æ•° `url` æ˜¯ `http` å¼€å¤´çš„ç»å¯¹è·¯å¾„å°†å¿½ç•¥ `base`
- æŠ¥é”™ï¼šå‚æ•° `url` æ˜¯ç›¸å¯¹è·¯å¾„

ç›´æ¥è¿”å› `url` æœ‰ 2 ä¸ªæƒ…å†µï¼š

- ç©ºå­—ç¬¦
- `hash` ä¸º `true`ï¼Œä¸” `url` ä»¥ `#` å¼€

å…¶ä½™è¿”å›ï¼Œè§ï¼š`defaultGetPublicPath` [[æŸ¥çœ‹](#defaultgetpublicpathè·å–èµ„æºé“¾æ¥çš„-path)]

- `url` ä½œä¸º `entry`ï¼Œä¸”ä¸€å®šæ˜¯å­—ç¬¦å‹
- `base` ä½œä¸º `location.href`

#### `defaultGetPublicPath`ï¼šè·å–èµ„æºé“¾æ¥çš„ `path`

ç›®å½•ï¼š`utils.ts` - `defaultGetPublicPath` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L253)]

å‚æ•°ï¼š

- `entry`ï¼šç±»å‹ä¸º `URL` å¯¹è±¡æˆ– `string`ï¼Œä½†ç›®å‰åªèƒ½æ˜¯ `string`

è¡¥å……è¯´æ˜ï¼š

- å› ä¸ºè°ƒç”¨åœºæ™¯åªæœ‰ `importHTML`ï¼Œé€ä¼ å‚æ•° `url` ç±»å‹ä¸º `string` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- åœ¨æºç ä¸­æœ‰åˆ¤æ–­å‚æ•°ç±»å‹æ˜¯å¦ä¸º `object`ï¼Œé€šè¿‡ `fetch` åˆ†æå¾—å‡ºæ¥è¿™ä¸ªå¯¹è±¡åªèƒ½ä¸º `URL`

è¿”å›ï¼šæ ¹æ®å‚æ•° `entry` èµ„æºé“¾æ¥æœ‰ 4 ç§ä¸å¯å˜çš„æƒ…å†µ

| `entry` ç±»å‹        | `location.href` | è¿”å›                                     | ä½¿ç”¨é¢‘ç‡ |
| ------------------- | --------------- | ---------------------------------------- | -------- |
| `URL`               | ä¸è€ƒè™‘          | `/`                                      | ä¸ä½¿ç”¨   |
| `http` å¼€å¤´ç»å¯¹è·¯å¾„ | ä¸è€ƒè™‘          | `entry` ä¸Šçº§ + `/`                       | åŸºæœ¬æ˜¯   |
| ä»¥ `/` å¼€å¤´çš„å­—ç¬¦   | `http` å¼€å¤´é“¾æ¥ | `location.origin` + `entry` ä¸Šçº§ + `/`   | æå°‘     |
| ç©ºå­—ç¬¦              | `http` å¼€å¤´é“¾æ¥ | `location.origin` + `pathame` ä¸Šçº§ + `/` | æœ‰é”™è¯¯   |

> å¦‚æœ `entry` æˆ– `pathname` ä¸å­˜åœ¨ä¸Šçº§ï¼Œè¿”å›ç©ºå­—ç¬¦

`entry` å­˜åœ¨çš„é—®é¢˜ï¼š

- `URL`ç±»å‹ï¼šåº”è¿”å›å¯¹è±¡é“¾æ¥å¼€å¤´åˆ°æœ€åä¸€ä¸ª `/`ï¼ŒåŒæ—¶ä¿ç•™å¯¹ `object` çš„åˆ¤æ–­è¿”å› `/`
- æä¾›ç©ºå­—ç¬¦ï¼šå‡½æ•°æœ¬èº«å¹¶æ²¡æœ‰é”™ï¼Œä½†ä¼šé€ æˆé‡å¤åŠ è½½åŸºåº§é€ ï¼Œè§ï¼š`startApp` çš„ `bug` [[æŸ¥çœ‹](#4-startapp-çš„-bug)]

é€šå¸¸æƒ…å†µä¸‹åº”ç”¨å…¥å£é“¾æ¥æ˜¯å®Œæ•´çš„ç»å¯¹è·¯å¾„ï¼Œä½†å­åº”ç”¨ä¸åŒç¯å¢ƒä¸‹ `origin` ä¸ä¸€æ ·æ€ä¹ˆåŠï¼Ÿ

- é…ç½®ç¯å¢ƒå˜é‡ï¼Œç”¨æ¥åŒºåˆ†ç”Ÿæˆç¯å¢ƒå’Œå¼€å‘ç¯å¢ƒ

è¿”å›ï¼š`entry` æ˜¯éé“¾æ¥ã€é `/` å¼€å¤´çš„å­—ç¬¦ï¼Œä¼šæ ¹æ® `location.pathname` æä¾›èµ„æºé“¾æ¥

| `location.pathname` | è¿”å›                                     |
| ------------------- | ---------------------------------------- |
| é `/` ç»“å°¾         | `location.origin` + `entry` ä¸Šçº§ + `/`   |
| ä»¥ `/` ç»“å°¾         | `location.origin` + `pathname` + `entry` |

> åªè¦ `entry` ä¸æ˜¯é“¾æ¥ï¼Œä¹Ÿä¸æ˜¯éç©ºå­—ç¬¦ï¼Œä¼šä¸¢å¼ƒ `location` ä¸­çš„ `search` å’Œ `hash` åè®¡ç®—èµ„æºé“¾æ¥

è·å–èµ„æºé“¾æ¥æ€»ç»“ï¼š

- é€šå¸¸æä¾›çš„ `entry` æ˜¯ `http` å¼€å¤´çš„ç»å¯¹è·¯å¾„
- éç»å¯¹è·¯å¾„é€šå¸¸åŠ è½½åŸºåº§è‡ªèº«è·¯ç”±ä½œä¸ºèµ„æºï¼Œè¿™ç§æƒ…å†µä½¿ç”¨è·¯ç”±åº“æ¥å¤„ç†æ›´åˆé€‚

#### å­åº”ç”¨ä¸­çš„é“¾æ¥æŒ‡å‘

| ä½ç½®          | åˆ†ç±»                        | é“¾æ¥æŒ‡å‘                     | è¡¥å……è¯´æ˜                                                   |
| ------------- | --------------------------- | ---------------------------- | ---------------------------------------------------------- |
| åŸºåº§          | `window`                    | åŸºåº§æ‰€åœ¨ä½œç”¨åŸŸ               | æŒ‰ç…§å…¨å±€ `window` å†³å®šé“¾æ¥                                 |
| åŸºåº§          | æ²™ç®± `iframe` çš„ `src` å±æ€§ | åŸºåº§ `origin`                | æ²™ç®±å’ŒåŸºåº§åŒåŸŸä»¥ä¾¿ç›¸äº’é€šä¿¡                                 |
| æ²™ç®± `iframe` | `location`                  | éšå­åº”ç”¨è·¯ç”±å˜åŒ–ï¼ˆä¸‹æ–¹æ€»ç»“ï¼‰ | æ²™ç®±å’ŒåŸºåº§åŒåŸŸä»¥ä¾¿ç›¸äº’é€šä¿¡                                 |
| æ²™ç®± `iframe` | `base` å…ƒç´                  | å­åº”ç”¨ `origin` + æ²™ç®±è·¯ç”±   | ä¿®æ­£å­åº”ç”¨ä¸­æ‰€æœ‰ç›¸å¯¹è·¯å¾„çš„èµ„æºé“¾æ¥ [[æŸ¥çœ‹](#baseæ ‡ç­¾æ“ä½œ)] |

æ²™ç®± `location` éšè·¯ç”±å˜åŒ–ï¼š

| æ‰§è¡Œå‡½æ•°                                                                      | é˜¶æ®µ                          | `location`                 |
| ----------------------------------------------------------------------------- | ----------------------------- | -------------------------- |
| `iframeGenerator` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]                   | åˆå§‹åŒ–                        | åŸºåº§ `origin`              |
| `syncUrlToIframe` [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]            | åŒæ­¥è·¯ç”±åˆ°å­åº”ç”¨              | åŸºåº§ `origin` + å­åº”ç”¨è·¯ç”± |
| `patchIframeHistory` [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)] | åŠ«æŒå­åº”ç”¨ `history` çŠ¶æ€æ›´æ–° | åŸºåº§ `origin` + å­åº”ç”¨è·¯ç”± |

é—®é¢˜ï¼šæ²™ç®±ä¸­è·å– `location`

- å‡å®šåº”ç”¨å…¥å£é“¾æ¥ä¸º `http://localhost:8080/pathname`ï¼ŒåŸºåº§ä¸º `http://localhost:3000`
- å› ä¸ºæ²™ç®±å’ŒåŸºåº§åŒåŸŸï¼Œå¾—åˆ°ç»“æœä¸ºï¼š`http://localhost:3000/pathname`

äºæ˜¯åœ¨ `proxyLocation` ä¸­åšäº†ä¸€æ¬¡æ‹¦æˆªï¼Œç”¨æ¥ä¿®æ­£å–å€¼ [[æŸ¥çœ‹](#3-ä»£ç†ç©ºå¯¹è±¡ä½œä¸º-proxylocation)]ï¼š

- ä½† `degrade` ä¸‹æ²™ç®±çš„ `location` æŒ‡å‘æ²™ç®± `window`ï¼Œè§ï¼š`proxyLocation` çš„é—®é¢˜ [[æŸ¥çœ‹](#proxylocation-çš„é—®é¢˜)]

`degrade` ä¸‹æ²™ç®± `location` å’Œ `proxyLocation` å–å€¼çš„åŒºåˆ«ï¼š

| ç›¸å…³å±æ€§å’Œå¯¹è±¡                                   | `proxyLocation`                                                 | æ²™ç®± `location`                       |
| ------------------------------------------------ | --------------------------------------------------------------- | ------------------------------------- |
| `host`ã€`hostname`ã€`protocol`ã€`port`ã€`origin` | æŒ‰ç…§å­åº”ç”¨çš„å…¥å£èµ„æºæ¥                                          | æŒ‰ç…§åŸºåº§æ¥                            |
| `href`                                           | é€šè¿‡ `relace` æ›¿æ¢æˆå­åº”ç”¨ `origin`                             | æŒ‰ç…§åŸºåº§æ¥                            |
| `replace`                                        | é€šè¿‡ `relace` æ›¿æ¢æˆåŸºåº§ `origin`ï¼Œå› ä¸ºæ²™ç®± `iframe` å’ŒåŸºåº§åŒåŸŸ | æŒ‰ç…§åŸºåº§æ¥                            |
| å…¶å®ƒå±æ€§                                         | ä»æ²™ç®± `location` ä¸­å–                                          | ä»æ²™ç®± `location` ä¸­å–                |
| `fetch` è¯·æ±‚                                     | ç›¸å¯¹è·¯å¾„æŒ‰ç…§ `base` å…ƒç´ æ¥è¡¥å…¨                                  | ç›¸å¯¹è·¯å¾„æŒ‰ç…§ `base` å…ƒç´ æ¥è¡¥å…¨        |
| é…ç½®å¹¶é‡å†™ `fetch`                               | ç›¸å¯¹è·¯å¾„å°†é€šè¿‡ `proxyLocation` æ¥è¡¥å…¨                           | ç›¸å¯¹è·¯å¾„å°†é€šè¿‡ `proxyLocation` æ¥è¡¥å…¨ |

> `fetch` æ— è®ºæ˜¯é€šè¿‡ `base` å…ƒç´ è¿˜æ˜¯ `proxyLocation`ï¼Œç›¸å¯¹è·¯å¾„éƒ½ä»¥å­åº”ç”¨ `origin` æ¥è¡¥å…¨

### è¾…åŠ©æ–¹æ³• - åº”ç”¨åŠ¨æ€æ³¨å…¥ `DOM`

#### `handleStylesheetElementPatch`ï¼šä¸ºåº”ç”¨ä¸­åŠ¨æ€æ ·å¼æ‰“è¡¥ä¸

ç›®å½•ï¼š`effect.ts` - `handleStylesheetElementPatch` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L64)]

å‚æ•°ï¼š

- `stylesheetElement`ï¼š`style` å…ƒç´ ï¼Œå¸¦æœ‰å±æ€§ `_patcher` ç”¨äºå­˜æ”¾å®ä»»åŠ¡
- `sandbox`ï¼šåº”ç”¨å®ä¾‹ï¼Œç”¨äºè·å– `degrade`ã€`shadowRoot`

ä¸å¤„ç†çš„æƒ…å†µï¼š

- `degrade` é™çº§ï¼šæ²¡æœ‰ `shadowRoot`ï¼Œ`iframe` å®¹å™¨ä¹Ÿä¸å­˜åœ¨å…¼å®¹æ ·å¼çš„é—®é¢˜
- é€šè¿‡ `cssIgnores` åŠ¨æ€æ·»åŠ çš„å¤–è”æ ·å¼

ç”¨é€”ï¼š

- å’Œ `WuJie` ç±»ä¸­çš„ `patchCssRules` ä¸€æ ·ï¼Œä¸ºåº”ç”¨æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]

> åŒ…æ‹¬ä¸ºä»€ä¹ˆè¦æ‰“è¡¥ä¸ï¼Œä»¥åŠå­˜åœ¨çš„é—®é¢˜éƒ½å‚è€ƒ `patchCssRules`

ä¸åŒä¹‹å¤„ï¼š

- `patchCssRules`ï¼šè·å– `shadowRoot` ä¸‹æ‰€æœ‰çš„å†…è”æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]
- `handleStylesheetElementPatch`ï¼šåªå¤„ç†é€šè¿‡ `rewriteAppendOrInsertChild` åŠ¨æ€æ·»åŠ çš„æ ·å¼ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

æµç¨‹ï¼š

- å®šä¹‰æ‰“è¡¥ä¸å‡½æ•° `patcher`ï¼Œè®¡åˆ’ä½œä¸ºå®ä»»åŠ¡ä¸­æ‰§è¡Œçš„æ–¹æ³•
- è‹¥å…ƒç´ å­˜åœ¨ `_patcher` å±æ€§ï¼Œé€šè¿‡ `clearTimeout` å–æ¶ˆç»‘å®šçš„å®ä»»åŠ¡é¿å…é‡å¤æ‰§è¡Œ
- é€šè¿‡ `setTimeout` å°†å®ä»»åŠ¡ç»‘å®šåœ¨å…ƒç´ çš„ `_patcher` å±æ€§ä¸Š

`patcher` å’Œ `patchCssRules` æ‰“è¡¥ä¸çš„æµç¨‹ä¸€æ · [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]ï¼š

- é€šè¿‡ `getPatchStyleElements` ä»æä¾›çš„ `stylesheet` ä¸­æå–æŒ‡å®šçš„æ ·å¼
- è‹¥å­˜åœ¨ `hostStyleSheetElement`ï¼š`:host` æ ·å¼å…ƒç´ ï¼Œå°†å…¶æ’å…¥ `shadowRoot.head`
- è‹¥å­˜åœ¨ `fontStyleSheetElement`ï¼šå­—ä½“æ ·å¼å…ƒç´ ï¼Œå°†å…¶æ’å…¥ `shadowRoot.host` æœ«å°¾
- å°†å±æ€§ `_patcher` è®¾ä¸º `undefined`ï¼Œå…è®¸åç»­ç»§ç»­æ“ä½œ

è°ƒç”¨åœºæ™¯æœ‰ 6 å¤„ï¼š

- `rewriteAppendOrInsertChild`ï¼šåŠ¨æ€æ·»åŠ å†…è”å’Œå¤–è”æ ·å¼ 2 å¤„ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]
- `patchStylesheetElement`ï¼šæ‹¦æˆªæ ·å¼æ“ä½œæœ‰ 4 å¤„ [[æŸ¥çœ‹](#patchstylesheetelementåŠ«æŒå¤„ç†æ ·å¼å…ƒç´ çš„å±æ€§)]

å•é¡µåº”ç”¨åŠ¨æ€æ·»åŠ æ ·å¼çš„æ­¥éª¤ï¼š

1. é€šè¿‡ `active` æ³¨å…¥èµ„æºåˆ°å®¹å™¨åï¼Œé€šè¿‡ `patchRenderEffect` é‡å†™æ·»åŠ  `Dom` çš„æ–¹æ³• [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]
2. é€šè¿‡ `start` å°†å…¥å£ `script` æ·»åŠ åˆ°æ²™ç®± `iframe`ï¼Œå¼€å§‹æ¸²æŸ“ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
3. é€šè¿‡ `rewriteAppendOrInsertChild` æ‹¦æˆªåŠ¨æ€æ·»åŠ çš„æ ·å¼å…ƒç´ æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

åŠ¨æ€æ·»åŠ æ ·å¼ï¼Œä¸åŒçš„æ‰“è¡¥ä¸æ–¹å¼ï¼š

| åˆ†ç±»     | åŠ è½½æ–¹å¼                                    | å¦‚ä½•æ‰“è¡¥ä¸                                                                       |
| -------- | ------------------------------------------- | -------------------------------------------------------------------------------- |
| å¤–è”æ ·å¼ | åŠ è½½åä½œä¸ºå†…è”æ ·å¼æ·»åŠ åˆ°å®¹å™¨                | `handleStylesheetElementPatch`                                                   |
| å¤–è”æ ·å¼ | é…ç½® `cssIgnores`ï¼Œä½œä¸ºæµè§ˆå™¨åŠ è½½çš„å¤–è”æ ·å¼ | ä¸æ‰“è¡¥ä¸                                                                         |
| å†…è”æ ·å¼ | ç”±å•é¡µåº”ç”¨åˆ›å»ºç©ºçš„åŠ¨æ€æ ·å¼                  | `patchStylesheetElement` [[æŸ¥çœ‹](#patchstylesheetelementåŠ«æŒå¤„ç†æ ·å¼å…ƒç´ çš„å±æ€§)] |
| å†…è”æ ·å¼ | å¼€å‘äººå‘˜åŠ¨æ€æ·»åŠ çš„å†…è”æ ·å¼                  | `handleStylesheetElementPatch`                                                   |

> åº”ç”¨ä¸­æå–çš„é™æ€æ ·å¼é€šè¿‡ `patchCssRules` æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]

ä»ä¸Šé¢å¯ä»¥çŸ¥é“åŠ¨æ€æ·»åŠ æ ·å¼æ¥æº `start`ï¼Œå› æ­¤ï¼š

- `alive` æ¨¡å¼ï¼šåªæœ‰é¦–æ¬¡å¯åŠ¨ä¼šåŠ¨æ€åŠ è½½æ ·å¼
- `umd` æ¨¡å¼ï¼šç†è®ºä¸Šå’Œ `alive` ä¸€æ ·ï¼Œä½†æ˜¯å­˜åœ¨é—®é¢˜ï¼Œè§ï¼šé‡å¤æå–æ ·å¼çš„ `bug` [[æŸ¥çœ‹](#2-é‡å¤æå–æ ·å¼çš„-bug)]
- é‡å»ºæ¨¡å¼ï¼šæ¯æ¬¡å¯åŠ¨éƒ½ä¼šé‡æ–°åŠ¨æ€è·å–æ ·å¼

#### `patchStylesheetElement`ï¼šåŠ«æŒå¤„ç†æ ·å¼å…ƒç´ çš„å±æ€§

ç›®å½•ï¼š`effect.ts` - `patchStylesheetElement` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L85)]

å‚æ•°ï¼š

- `stylesheetElement`ï¼š`style` å…ƒç´ ï¼Œå¸¦æœ‰å±æ€§ `_hasPatchStyle` ç”¨äºæ ‡è®°æ˜¯å¦å·²åŠ«æŒ
- `cssLoader`ï¼šæ’ä»¶ `cssLoader` ç”¨äºæ›¿æ¢æ ·å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-loader)]
- `sandbox`ï¼šåº”ç”¨å®ä¾‹ï¼Œç”¨äºé€ä¼ ç»™ `handleStylesheetElementPatch` [[æŸ¥çœ‹](#handlestylesheetelementpatchä¸ºåº”ç”¨ä¸­åŠ¨æ€æ ·å¼æ‰“è¡¥ä¸)]
- `curUrl`ï¼šé€ä¼ è‡ª `rewriteAppendOrInsertChild`ï¼Œå­åº”ç”¨ `origin` + `pathname` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

ç”±äº `cssLoader` æ˜¯é€šè¿‡ `getCssLoader` æŸ¯é‡ŒåŒ–æ‹¿åˆ°çš„å‡½æ•° [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]ï¼š

- æ‰€ä»¥ä¼šå› æ²¡æœ‰æä¾›æ’ä»¶è€Œä¸åšå¤„ç†ï¼Œä½† `cssLoader` ä¸€å®šæ˜¯å¯æ‰§è¡Œçš„å‡½æ•°

ä¸å¤„ç†çš„æƒ…å†µï¼š

- `_hasPatchStyle` å·²æ ‡è®°ï¼Œè¯´æ˜ `style` å…ƒç´ å·²åŠ«æŒè¿‡äº†
- `patchStylesheetElement` åªå¤„ç†æ¥è‡ªåº”ç”¨å†…åŠ¨æ€æ·»åŠ çš„å†…è”æ ·å¼ï¼Œé™¤æ­¤ä¹‹å¤–çš„æ ·å¼éƒ½ä¸å¤„ç†

åŠ«æŒçš„å±æ€§ï¼š

- å†™å…¥æ“ä½œï¼š`innerHTML`ã€`innerText`ã€`textContent`
- é‡å†™æ–¹æ³•ï¼š`appendChild`
- é¢å¤–å±æ€§ï¼š`_hasPatchStyle` ç”¨äºé¿å…é‡å¤åŠ«æŒ

**ç¬¬ä¸€æ­¥ï¼šæå–åŸç”Ÿå±æ€§**

- æå–å±æ€§ï¼š`innerHTML`ã€`innerText`ã€`textContent`
- é€šè¿‡ `patchSheetInsertRule` é‡å†™ `stylesheetElement.sheet.insertRule`

ä¸ºä»€ä¹ˆé‡å†™ `insertRule`ï¼š

- æ·»åŠ  `CSSRule` åŒæ—¶ï¼Œå°†æ ·å¼é€šè¿‡ `innerHTML` æˆ– `innerText` å†™å…¥ `style` å…ƒç´ 

å› ä¸º `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨åä¸ä¼šé‡å¤åŠ¨æ€æ·»åŠ æ ·å¼ï¼Œè§£å†³åŠæ³•æ˜¯æŠŠæ ·å¼å†™å…¥å…ƒç´ ï¼š

- åŠ¨æ€æ·»åŠ çš„æ ·å¼å…ƒç´ ä¼šè®°å½•åœ¨ `styleSheetElements` é›†åˆ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]
- å½“åˆ‡æ¢ `umd` æ¨¡å¼çš„åº”ç”¨æ—¶ï¼Œä¼šé€šè¿‡ `rebuildStyleSheets` æ¢å¤æ ·å¼ [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]

`insertRule` å…¼å®¹æ€§ï¼š

- ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒã€`IE` æ”¯æŒåˆ° 9ï¼Œè€Œè¿™æ­£æ˜¯ `wujie` ç†è®ºä¸Šæœ€ä½å…¼å®¹ç‰ˆæœ¬
- å¯¹äºä¸å…¼å®¹çš„æµè§ˆå™¨å°†å¿½ç•¥æ“ä½œ

**ç¬¬äºŒæ­¥ï¼šåŠ«æŒå±æ€§è¯»å–å’Œå†™å…¥**

åŒ…å«ï¼š`innerHTML`ã€`innerText`ã€`textContent`ï¼ŒåŠ«æŒå±æ€§çš„æ–¹å¼ä¸€è‡´ï¼š

- `get` æ“ä½œï¼šç”¨åŸç”Ÿæ–¹æ³•è·å–å¯¹åº”çš„å±æ€§
- `set` æ“ä½œï¼š
  - ç”¨åŸç”Ÿæ–¹æ³•è·å–å¯¹åº”çš„å±æ€§æ‰§è¡Œæ›´æ–°
  - æ›´æ–°å‰ä¼šé€šè¿‡ `cssLoader` ä½¿ç”¨æ›´æ–°çš„æ ·å¼å’Œ `baseUrl` è¿›è¡Œæ›¿æ¢
  - é€šè¿‡ `nextTick` å‘èµ·ä¸€ä¸ªå¾®ä»»åŠ¡ï¼šé€šè¿‡ `handleStylesheetElementPatch` æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#handlestylesheetelementpatchä¸ºåº”ç”¨ä¸­åŠ¨æ€æ ·å¼æ‰“è¡¥ä¸)]

ä¸ºä»€ä¹ˆ `cssLoader` ä¸æä¾›æ ·å¼çš„ `url`ï¼š

- å› ä¸º `patchStylesheetElement` å¤„ç†çš„æ˜¯åº”ç”¨å†…åŠ¨æ€æ·»åŠ çš„å†…è”æ ·å¼

**ç¬¬ä¸‰æ­¥ï¼šé‡å†™æ–¹æ³• `appendChild`**

å’ŒåŠ«æŒå±æ€§çš„æ–¹æ³•ç›¸åŒï¼š

- é€šè¿‡ `nextTick` å‘èµ·ä¸€ä¸ªå¾®ä»»åŠ¡ï¼šé€šè¿‡ `handleStylesheetElementPatch` æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#handlestylesheetelementpatchä¸ºåº”ç”¨ä¸­åŠ¨æ€æ ·å¼æ‰“è¡¥ä¸)]
- ä½¿ç”¨åŸç”Ÿçš„æ–¹æ³• `appendChild` æ–°å¢å…ƒç´ 

ä¸åŒåœ¨äºå¦‚æœæ’å…¥çš„æ ·å¼æ˜¯æ–‡æœ¬ï¼Œè¿˜éœ€è¦ç‰¹æ®Šå¤„ç†ï¼š

- æ›´æ–°å‰ä¼šé€šè¿‡ `cssLoader` ä½¿ç”¨æ›´æ–°çš„æ ·å¼å’Œ `baseUrl` è¿›è¡Œæ›¿æ¢
- å°†æ›´æ–°åçš„æ ·å¼æ’å…¥ `style` å…ƒç´ åï¼Œå†æ¬¡é€šè¿‡ `patchSheetInsertRule` é‡å†™ `insertRule`

> æ— è®ºæ’å…¥çš„å…ƒç´ æ˜¯ä»€ä¹ˆç±»å‹ï¼Œæœ€ç»ˆéƒ½è¦å°†æ–°å¢çš„å…ƒç´ è¿”å›

éœ€è¦è¯´æ˜çš„æ˜¯ï¼š

- åŠ«æŒæ ·å¼å…ƒç´ çš„å±æ€§æ‰“è¡¥ä¸ï¼Œæ¯æ¬¡ `handleStylesheetElementPatch` éƒ½ä¼šæå–å®Œæ•´çš„æ ·å¼è¿›è¡ŒåŒ¹é…
- å¯¹äºåŠ¨æ€æ“ä½œï¼Œå¯èƒ½ä¼šé€ æˆé‡å¤æ‰§è¡Œï¼Œä½†ä¸ä¼šå½±å“ä½¿ç”¨ï¼Œè§ï¼šé¢å¤–è¯´æ˜ [[æŸ¥çœ‹](https://github.com/cgfeel/zf-micro-app/blob/main/doc/wujie-umd-patch_css_rules.md#4-%E9%A2%9D%E5%A4%96%E8%AF%B4%E6%98%8E)]

#### `rewriteAppendOrInsertChild`ï¼šé‡å†™ `appendChild` å’Œ `insertBefore`

ç›®å½•ï¼š`effect.ts` - `rewriteAppendOrInsertChild` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L158)]

æ¥å—ä¸€ä¸ª `opt` å¯¹è±¡ï¼ŒåŒ…å« 2 ä¸ªå±æ€§ï¼š

- `rawDOMAppendOrInsertBefore`ï¼šåŸç”Ÿæ·»åŠ  `Dom` çš„æ–¹æ³•ï¼Œé€ä¼ è‡ª `patchRenderEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]
- `wujieId`ï¼šåº”ç”¨åï¼Œç”¨äºè·å–åº”ç”¨å®ä¾‹

æ·»åŠ  `Dom` çš„æ–¹æ³•ï¼š

| é‡å†™æ–¹æ³•                   | æä¾›æ–¹æ³•              | å¼•ç”¨å¯¹è±¡                                 |
| -------------------------- | --------------------- | ---------------------------------------- |
| `render.head.appendChild`  | `rawAppendChild`      | `Node.prototype.appendChild`             |
| `render.body.appendChild`  | `rawAppendChild`      | `Node.prototype.appendChild`             |
| `render.head.insertBefore` | `rawHeadInsertBefore` | `HTMLHeadElement.prototype.insertBefore` |
| `render.body.insertBefore` | `rawBodyInsertBefore` | `HTMLBodyElement.prototype.insertBefore` |

> é‡å†™æ–¹æ³•ä¸­çš„ `render` ä»¥åŠæä¾›æ–¹æ³•ï¼Œè§ï¼š`patchRenderEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

`rawDOMAppendOrInsertBefore` çš„ç±»å‹ï¼š

- `<T extends Node>(newChild: T, refChild?: Node | null) => T;`ï¼Œå…¶ä¸­ `refChild` ä¸ºå¯é€‰å‚æ•°
- è¿™æ · `refChild` åœ¨ `appendChild` ä¸­æ˜¯æ— æ•ˆå‚æ•°ï¼Œåœ¨ `insertBefore` ä¸­æ˜¯å‚è€ƒå…ƒç´ 

è¿”å›å‡½æ•°ï¼š

- ç±»å‹å’Œ `rawDOMAppendOrInsertBefore` ä¸€è‡´ï¼Œä½†ä¼šåœ¨ `patchRenderEffect` é€šè¿‡ `as` æ–­è¨€çº æ­£ [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]
- å³ `rawDOMAppendOrInsertBefore` æä¾›ä»€ä¹ˆç±»å‹ï¼Œå°±ä¼šæ–­è¨€è¿”å›çš„å‡½æ•°æ˜¯ä»€ä¹ˆç±»å‹

è¿”å›å‡½æ•°æ‰€éœ€å‚æ•°ï¼š

- `this`ï¼šç”¨äº `TS` æŒ‡å®šä¸Šä¸‹æ–‡ç±»å‹ï¼Œè§ï¼šå®˜æ–¹æ–‡æ¡£ [[æŸ¥çœ‹](https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-0.html#specifying-the-type-of-this-for-functions)]
- `newChild`ï¼šæ·»åŠ çš„èŠ‚ç‚¹
- `refChild`ï¼šæ›¿æ¢çš„èŠ‚ç‚¹ï¼Œå¯é€‰å‚æ•°

æ‰§è¡Œå‡½æ•°è¿”å›å¯¹è±¡ï¼š

- æŒ‰ç…§åŸç”Ÿæ–¹æ³•ï¼š`appendChild`ã€`insertBefore` ä¸€æ ·ï¼Œè¿”å›æ·»åŠ çš„å…ƒç´ 
- ä½†æ˜¯å½“æ·»åŠ çš„å…ƒç´ æ˜¯ `script` æˆ–æ˜¯å¤–è”æ ·å¼æ—¶ï¼Œä¼šåœ¨æ²™ç®± `iframe` åˆ›å»ºæ³¨é‡Šå¹¶è¿”å›

åŸå› åœ¨äºæ·»åŠ å…ƒç´ å±äºä¸Šä¸‹æ–‡åŒæ­¥æ“ä½œï¼š

- æ·»åŠ å¤–è”æ ·å¼é€šè¿‡ `getExternalStyleSheets` å‘èµ·å¾®ä»»åŠ¡ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]
- æ·»åŠ å¤–è” `script` é€šè¿‡ `getExternalScripts` å‘èµ·å¾®ä»»åŠ¡ [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- æ·»åŠ å†…è” `script` åœ¨ `fiber` ä¸‹é€šè¿‡ `requestIdleCallback` å‘èµ·å®ä»»åŠ¡
- åªæœ‰å†…è” `script` ä¸”å–æ¶ˆ `fiber` æ‰æ˜¯åŒæ­¥æ“ä½œï¼Œä½†è¿”å›çš„ä»æ—§æ˜¯åˆ›å»ºçš„æ³¨é‡Šå…ƒç´ 

ç”±æ­¤å¾—å‡ºï¼š

| åŠ¨æ€æ·»åŠ             | `ignore` | æ·»åŠ æ–¹å¼            | æ³¨å…¥åå¦‚ä½•æ“ä½œ                                                                            |
| ------------------- | -------- | ------------------- | ----------------------------------------------------------------------------------------- |
| å¤–è”å’Œå†…è” `script` | ä¸åŒ¹é…   | åŠ è½½ä¸ºå†…è” `script` | `findScriptElementFromIframe` [[æŸ¥çœ‹](#findscriptelementfromiframeæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„-script)] |
| å¤–è” `script`       | åŒ¹é…     | åˆ›å»ºå¤–è” `script`   | `findScriptElementFromIframe` [[æŸ¥çœ‹](#findscriptelementfromiframeæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„-script)] |
| å¤–è”æ ·å¼            | åŒ¹é…     | å…ƒç´ ä¸å˜            | ç›´æ¥æ“ä½œ                                                                                  |
| å†…è”æ ·å¼            | ä¸åŒ¹é…   | å…ƒç´ ä¸å˜            | ç›´æ¥æ“ä½œ                                                                                  |
| å¤–è”æ ·å¼            | ä¸åŒ¹é…   | åŠ è½½ä¸ºå†…è”æ ·å¼      | æ— æ³•å…³è”                                                                                  |
| å…¶å®ƒå…ƒç´             | ä¸åŒ¹é…   | å…ƒç´ ä¸å˜            | ç›´æ¥æ“ä½œ                                                                                  |

> é™¤äº†ä¸Šè¿°ç½—åˆ—çš„æ“ä½œæ–¹å¼å¤–ï¼Œå‡å¯ä»¥é€šè¿‡ç»™å…ƒç´ æ·»åŠ ç‰¹å®šå±æ€§ï¼Œæ¥æŸ¥æ‰¾å¹¶æ“ä½œå…ƒç´ 

æ·»åŠ è¿‡ç¨‹ä¸­ï¼Œå…ƒç´ ä¸å˜çš„æƒ…å†µéƒ½ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š

- `rawDOMAppendOrInsertBefore`ï¼šè°ƒç”¨åŸç”Ÿæ–¹æ³•æ·»åŠ å…ƒç´ 
- `execHooks`ï¼šæå–æ’ä»¶ `appendOrInsertElementHook`ï¼Œè°ƒç”¨æ—¶ä¼ é€’æ·»åŠ çš„å…ƒç´ å’Œæ²™ç®± `window`
- æŒ‰ç…§æ¡ä»¶è¿”å›æ·»åŠ çš„å…ƒç´ 

> ä¸ºäº†ä¾¿äºæ€»ç»“å°†ä»¥ä¸Š 3 æ­¥æ“ä½œæµç¨‹ç§°ä¸ºï¼šæ·»åŠ å…ƒç´ å¹¶è¿”å›

åŠ¨æ€æ·»åŠ çš„ `newChild` å°†å¼•ç”¨ä¸ºæ–°çš„å¯¹è±¡ `element`ï¼š

- å¤–è”å…ƒç´ ï¼šæ— è®ºåŠ è½½æˆåŠŸæˆ–å¤±è´¥ï¼Œåœ¨è§¦å‘åŠ è½½äº‹ä»¶åéƒ½ä¼šæ›´æ–°ä¸º `null`
- éå¤–è”çš„å…ƒç´ ï¼šé€šè¿‡ `rawDOMAppendOrInsertBefore` æ·»åŠ åˆ°å®¹å™¨åï¼Œè¿”å›å…ƒç´ 

åŠ è½½å¤–è”èµ„æºå¤±è´¥æ€ä¹ˆå¤„ç†ï¼š

- é€šè¿‡ `manualInvokeElementEvent` å‘èµ· `error` äº‹ä»¶ [[æŸ¥çœ‹](#manualinvokeelementeventæ‰‹åŠ¨è§¦å‘äº‹ä»¶å›è°ƒ)]

é‡å†™çš„æ–¹æ³•æ ¹æ®æ·»åŠ çš„å…ƒç´ åˆ†ä¸º 5 ç§æƒ…å†µï¼š

**1. ä»…æ·»åŠ å…ƒç´ å¹¶æ‰“è¡¥ä¸**

- å¯¹äº `link`ã€`style`ã€`script`ã€`iframe` ä¹‹å¤–çš„å…ƒç´ å…¨éƒ¨ï¼šæ·»åŠ å…ƒç´ å¹¶è¿”å›
- è¿”å›å‰å°†é€šè¿‡ `patchElementEffect` ä¸ºæ–°å¢å…ƒç´ æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]

**2. `link`ï¼šèµ„æºå…ƒç´ **

`link` å…ƒç´ ä¸æ˜¯æ ·å¼ï¼š

- æ·»åŠ å…ƒç´ å¹¶è¿”å›ï¼Œä¸åšå…¶å®ƒå¤„ç†
- åˆ¤å®šæ ·å¼çš„ 3 ä¸ªæ¡ä»¶ï¼š`rel`ã€`type`ã€é“¾æ¥ä»¥ `.css` ç»“å°¾

> `link` æ˜¯å¤–è”æ ·å¼ï¼Œå°†åˆ›å»ºä¸€ä¸ªæ³¨é‡Šå…ƒç´ å¹¶è¿”å›

å¤–è”æ ·å¼ `href` ä¸ºç©ºæˆ–ä¸åœ¨ `cssExcludes` åˆ—è¡¨ï¼Œè¿”å›æ³¨é‡Šå‰éœ€è¦ï¼š

- é€šè¿‡ `getExternalStyleSheets` å¤„ç†æ ·å¼ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]ï¼š
- æ‰§è¡Œåå°†å¾—åˆ°å¸¦æœ‰ `contentPromise` å¾®ä»»åŠ¡çš„æ ·å¼é›†åˆï¼Œéå†é›†åˆè¿½åŠ å¾®ä»»åŠ¡æ¥æ·»åŠ æ ·å¼

> å¦åˆ™æ·»åŠ æ³¨é‡Šå¹¶è¿”å›ä¸åšä»»ä½•å¤„ç†

æä¾›ç»™ `getExternalStyleSheets` å‚æ•°ï¼š

- æ ·å¼é›†åˆï¼Œæ¯ä¸ªå¯¹è±¡åŒ…å«ï¼š`src` é“¾æ¥ã€`ignore` æ˜¯å¦é€šè¿‡æµè§ˆå™¨åŠ è½½ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-ignores)]
- `fetch`ï¼šæ¥è‡ªåº”ç”¨å®ä¾‹ `active` æ‰“è¡¥ä¸åçš„ `fetch` [[æŸ¥çœ‹](#2-åŠ¨æ€ä¿®æ”¹-fetch)]
- `loadError`ï¼šåŠ è½½å¤±è´¥é€šçŸ¥ï¼Œæ‰‹åŠ¨é…ç½®ï¼Œç»‘å®šåœ¨åº”ç”¨å®ä¾‹ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/lifecycle.html#loaderror)]

`ignore` å¤–è”æ ·å¼å¦‚ä½•æ·»åŠ ï¼š

- é€šè¿‡ `rawDOMAppendOrInsertBefore` å°†å¤–è”æ ·å¼æ·»åŠ åˆ°å®¹å™¨ï¼Œç”¨æµè§ˆå™¨åŠ è½½é¿å…è·¨åŸŸé—®é¢˜

é `ignore` å¤–è”æ ·å¼å¦‚ä½•åŠ è½½ï¼š

- ç”¨ `parseTagAttributes` æå–å¤–è”æ ·å¼å±æ€§çš„é”®å€¼å¯¹ `rawAttrs`
- ç”¨æ²™ç®± `document` åˆ›å»ºä¸€ä¸ªå†…è”æ ·å¼å…ƒç´ 
- ä»å®ä¾‹è·å–æ’ä»¶ `getCssLoader` å¤„ç†åŠ è½½åçš„æ ·å¼ï¼Œå°†å…¶ä½œä¸ºå†…è”æ ·å¼çš„å†…å®¹ [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]
- å°†å†…è”æ ·å¼æ’å…¥é›†åˆ `styleSheetElements`ï¼Œä»¥ä¾¿ `umd` æ¨¡å¼æ¢å¤æ ·å¼ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]
- é€šè¿‡ `setAttrsToElement` å°†å±æ€§é”®å€¼å¯¹ `rawAttrs` æ·»åŠ åˆ°åˆ›å»ºçš„æ ·å¼
- é€šè¿‡ `rawDOMAppendOrInsertBefore` å°†åˆ›å»ºçš„æ ·å¼æ·»åŠ åˆ°å®¹å™¨
- é€šè¿‡ `handleStylesheetElementPatch` ä¸ºåŠ è½½åçš„å†…è”æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#handlestylesheetelementpatchä¸ºåº”ç”¨ä¸­åŠ¨æ€æ ·å¼æ‰“è¡¥ä¸)]
- é€šè¿‡ `manualInvokeElementEvent` å‘èµ· `load` äº‹ä»¶ [[æŸ¥çœ‹](#manualinvokeelementeventæ‰‹åŠ¨è§¦å‘äº‹ä»¶å›è°ƒ)]

**3. `style`ï¼šå†…è”æ ·å¼**

- å°†å†…è”æ ·å¼æ’å…¥é›†åˆ `styleSheetElements`ï¼Œä»¥ä¾¿ `umd` æ¨¡å¼æ¢å¤æ ·å¼ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]
- ä»å®ä¾‹è·å–æ’ä»¶ `getCssLoader`ï¼Œåªæœ‰å†…è”æ ·å¼å†…å®¹ä¸ä¸ºç©ºæ—¶æ‰æ‰§è¡Œæ›¿æ¢ [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]
- é€šè¿‡ `patchStylesheetElement` åŠ«æŒå¤„ç†æ ·å¼å…ƒç´ çš„å±æ€§ [[æŸ¥çœ‹](#patchstylesheetelementåŠ«æŒå¤„ç†æ ·å¼å…ƒç´ çš„å±æ€§)]
- é€šè¿‡ `handleStylesheetElementPatch` ä¸ºåŠ¨æ€æ·»åŠ çš„å†…è”æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#handlestylesheetelementpatchä¸ºåº”ç”¨ä¸­åŠ¨æ€æ ·å¼æ‰“è¡¥ä¸)]
- æ·»åŠ å…ƒç´ å¹¶è¿”å›

åœ¨ `React` ä¸­å…ˆæ·»åŠ ç©ºçš„å†…è”æ ·å¼å…ƒç´ ï¼Œç„¶åæ ¹æ®æƒ…å†µè®¾ç½®å…ƒç´ æ ·å¼å†…å®¹ï¼š

- `getCssLoader` ä¸ä¼šå¤„ç† `React` å†…åº”ç”¨åŠ¨æ€æ·»åŠ çš„æ ·å¼ï¼ˆæ·»åŠ å…ƒç´ æ—¶å†…å®¹ä¸ºç©ºï¼‰ [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]
- è€Œæ˜¯é€šè¿‡ `patchStylesheetElement` æ‹¦æˆªå…ƒç´ å±æ€§æ·»åŠ æ ·å¼ [[æŸ¥çœ‹](#patchstylesheetelementåŠ«æŒå¤„ç†æ ·å¼å…ƒç´ çš„å±æ€§)]

**4. `script`ï¼šåŠ¨æ€æ·»åŠ **

æ•´ä½“åˆ† 3 æ­¥éª¤ï¼š

- é€šè¿‡ `setTagToScript` ä¸ºå†…è”æ‰“æ ‡è®° [[æŸ¥çœ‹](#ä¸ºåŠ¨æ€æ·»åŠ çš„-script-æ‰“æ ‡è®°)]
- åŠ è½½ `script` é€šè¿‡ `insertScriptToIframe` æ³¨å…¥æ²™ç®± `iframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]
- åˆ›å»ºä¸€ä¸ªæ³¨é‡Šå¹¶è¿”å›

æ— è®º `script` æ˜¯å¤–è”è¿˜æ˜¯å†…è”ï¼Œéƒ½ä¼šæ’å…¥åˆ°åº”ç”¨å®ä¾‹é˜Ÿåˆ— `execQueue` ä¸­æ‰§è¡Œï¼š

- æå–é˜Ÿåˆ—é•¿åº¦ï¼Œç”¨äºåˆ¤æ–­æ’å…¥é˜Ÿåˆ—åæ˜¯å¦è¦ç«‹å³æ‰§è¡Œ
- é˜Ÿåˆ—ä¸­æ·»åŠ ä¸€ä¸ªå‡½æ•°ï¼Œå°† `script` æ³¨å…¥æ²™ç®±ï¼Œå¼€å¯ `fiber` ä¸‹ä¼šåŒ…è£¹åœ¨ `requestIdleCallback` æ‰§è¡Œ

> ä¸ºäº†ä¾¿äºå½’çº³ï¼Œä¸Šè¿°æ­¥éª¤ç§°å‘¼ä¸ºï¼šæ’å…¥ `execQueue` é˜Ÿåˆ—ä¸­æ‰§è¡Œ

`insertScriptToIframe` æ³¨å…¥ `script` é™¤äº†æä¾›æ³¨å…¥çš„ä¿¡æ¯å’Œæ²™ç®± `window` å¤–ï¼š

- è¿˜ä¼šå°†åŠ¨æ€æ·»åŠ çš„ `script` ä½œä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œç”¨äºæå–å…ƒç´ ä¸­çš„æ ‡ç­¾å€¼

> ç”¨äºå…³è”åŠ¨æ€æ·»åŠ çš„ `script` å’Œæ³¨å…¥æ²™ç®±çš„ `script`ï¼Œè§ï¼š`findScriptElementFromIframe` [[æŸ¥çœ‹](#findscriptelementfromiframeæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„-script)]

4.1 åŠ è½½å¤–è” `script`

è¦æ±‚å­˜åœ¨å±æ€§ `src`ï¼Œä¸”é“¾æ¥ä¸åœ¨ `jsExcludes` åˆ—è¡¨ä¸­ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-excludes)]

å…ˆå£°æ˜ä¸€ä¸ªæ³¨å…¥ `script` æ–¹æ³• `execScript`ï¼š

- è¦æ±‚åº”ç”¨å®ä¾‹ä¸­æ²™ç®± `iframe` å­˜åœ¨ï¼ˆåªæœ‰æ³¨é”€å®ä¾‹æ²™ç®±æ‰ä¼šè¢«é”€æ¯ï¼‰
- åˆ›å»º `onload` æ–¹æ³•ï¼Œç”¨äºé€šè¿‡ `manualInvokeElementEvent` å‘èµ· `load` äº‹ä»¶ [[æŸ¥çœ‹](#manualinvokeelementeventæ‰‹åŠ¨è§¦å‘äº‹ä»¶å›è°ƒ)]
- é€šè¿‡ `insertScriptToIframe` æ³¨å…¥ `script` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

> é—®é¢˜ï¼šæ³¨å…¥å¤–è” `script` å³ä¾¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿä¼šè§¦å‘ `onload`ï¼Œè§ï¼š3. å£°æ˜æ³¨å…¥ `script` çš„æ–¹æ³• [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

å£°æ˜ä¸€ä¸ª `script` å±æ€§é›†åˆ `scriptOptions`ï¼š

- é›†åˆä¸­çš„å±æ€§å’Œ `processTpl` æå–å¤–è” `script` ä¸€æ ·ï¼Œä½†ä¸åŒ…å«ï¼š`async`ã€`defer` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- é™¤æ­¤ä¹‹å¤–é€šè¿‡ `jsIgnores` æŒ‰æ¡ä»¶æ·»åŠ å±æ€§ `ignore` ç”¨äºæµè§ˆå™¨åŠ è½½

`scriptOptions` çš„ä½¿ç”¨æµç¨‹ï¼š

- æä¾›ç»™ `getExternalScripts` å¤„ç†åå¾—åˆ°å¸¦æœ‰ `contentPromise` çš„ `scriptResult` [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- å°† `scriptResult` æä¾›ç»™ `execScript`ï¼Œä¼šç»“åˆ `onload` é€ä¼ ç»™ `insertScriptToIframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

é€šè¿‡ `getExternalScripts` åŠ è½½ `script`ï¼Œå‚æ•°å’ŒåŠ¨æ€åŠ è½½å¤–è”æ ·å¼ä¸€æ ·ï¼Œä¸åŒåœ¨äºï¼š

- é›†åˆå¯¹è±¡é‡‡ç”¨ `scriptOptions`
- ä»å®ä¾‹ä¸­è·å– `fiber` å†³å®šæ˜¯å¦é€šè¿‡ `requestIdleCallback` ç©ºé—²åŠ è½½

`getExternalScripts` æå–çš„é›†åˆï¼Œä¼šé€šè¿‡ `dynamicScriptExecStack` å‘èµ·å¾®ä»»åŠ¡ï¼š

```
dynamicScriptExecStack = dynamicScriptExecStack.then(() =>
  scriptResult.contentPromise.then(() => {})
);
```

> ä¿è¯é›†åˆä¸­çš„ `script` ä»¥å¾®ä»»åŠ¡é˜Ÿåˆ—çš„å½¢å¼ï¼ŒåŠ è½½å®Œä¸€ä¸ªå‘èµ·ä¸‹ä¸€ä¸ªåŠ è½½

æå–åŠ è½½çš„ `script` ä¸ä¼šç«‹å³æ³¨å…¥æ²™ç®±ï¼Œè€Œæ˜¯ï¼šæ’å…¥ `execQueue` é˜Ÿåˆ—ä¸­æ‰§è¡Œ

- æ’å…¥é˜Ÿåˆ—å‰éœ€ç¡®ä¿åº”ç”¨å®ä¾‹ä¸­å­˜åœ¨ `execQueue`ï¼ˆåªæœ‰å®ä¾‹æ³¨é”€åæ‰ä¼šé”€æ¯ï¼‰
- é˜Ÿåˆ—æ–¹æ³•ä¸­ä¸ä¼šç›´æ¥è°ƒç”¨ `insertScriptToIframe`ï¼Œè€Œæ˜¯é€šè¿‡ `execScript` å‘èµ·æ³¨å…¥
- å¦‚æœæ³¨å…¥é˜Ÿåˆ—å‰ `execQueue` å·²ä¸ºç©ºï¼Œéœ€è¦æ‰‹åŠ¨æå–å¹¶æ‰§è¡Œé˜Ÿåˆ—

ä»æ³¨å…¥ `script` çš„è¿‡ç¨‹ä¹Ÿèƒ½å¤Ÿçœ‹å‡ºé›†åˆä¸­æ²¡æœ‰ `asyc` çš„åŸå› ï¼š

- å¦‚æœ `ignore` åŒ¹é…çš„æƒ…å†µä¸‹ä½œä¸ºå¤–è” `script` æ³¨å…¥æ²™ç®±
- ç”±äº `async` å¯¼è‡´åŠ è½½åä¸ä¼šæå–æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè§ï¼š`start` å¯åŠ¨åº”ç”¨çš„ `bug` [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)]

åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„å¤–è” `script` æœ‰ 2 ç§æƒ…å†µä¼šä½¿ç”¨æµè§ˆå™¨åŠ è½½ï¼š

- `jsIgnores` æ‰‹åŠ¨åŒ¹é…ï¼Œä»¥åŠ `module` ç±»å‹çš„ `script`
- å¤–è” `script` å°†ä¸ä¼šåŒ…è£¹åœ¨ `proxy module` ä¸­æ‰§è¡Œï¼Œè§ï¼šæµç¨‹å›¾ [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

> é€šè¿‡ `jsExcludes` æ’é™¤çš„å¤–è” `script` ä¼šä½œä¸ºå†…è” `script` åŠ è½½ï¼Œä½†æ˜¯ç”±äºæ²¡æœ‰è„šæœ¬å†…å®¹ï¼Œå¯¼è‡´æ’å…¥çš„æ²™ç®±çš„ `script` æ˜¯ä¸€ä¸ªç©ºå…ƒç´ ã€‚

4.2 åŠ è½½å†…è” `script`

æµç¨‹å’Œå¤–è”åŸºæœ¬ä¸€è‡´ï¼Œä¹Ÿæ˜¯ï¼šæ’å…¥ `execQueue` é˜Ÿåˆ—ä¸­æ‰§è¡Œ

ä¸åŒåœ¨äºï¼š

- æ’å…¥é˜Ÿåˆ—çš„æ–¹æ³•ä¼šç›´æ¥é€šè¿‡ `insertScriptToIframe` æ³¨å…¥ `script`ï¼Œè€Œä¸éœ€è¦åŠ è½½
- æ³¨å…¥æ–¹æ³• `insertScriptToIframe` æä¾›çš„å‚æ•°ä¸åŒ [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

`insertScriptToIframe` å‚æ•°ï¼š

- `script` ä¿¡æ¯ï¼š`src` ä¸º `null`ï¼Œ`content` å†…è”ä»£ç ï¼Œ`attrs` æå–å…ƒç´ å±æ€§é”®å€¼å¯¹
- æ²™ç®± `window`
- å°†åŠ¨æ€æ·»åŠ çš„ `element` ä½œä¸ºç¬¬ 3 ä¸ªå‚æ•°ï¼Œç”¨äºå…³è”åŠ¨æ€æ·»åŠ å’Œæ³¨å…¥çš„ `script`

> `React` è¿™æ ·çš„å•é¡µåº”ç”¨ï¼Œé€šå¸¸æ˜¯å…¥å£ `script` ä¸ºé™æ€çš„ï¼Œæ³¨å…¥æ²™ç®±ååŠ¨æ€æ·»åŠ å†…è” `chunk script`

**5. `iframe`ï¼šåŠ¨æ€æ·»åŠ **

æ ¹æ®åŠ¨æ€æ·»åŠ å…ƒç´ çš„å±æ€§ `WUJIE_DATA_FLAG` å†³å®šå¦‚ä½•æ·»åŠ å…ƒç´ ï¼š

- å­˜åœ¨ `WUJIE_DATA_FLAG`ï¼šè¯´æ˜æ·»åŠ çš„æ˜¯åº”ç”¨æ²™ç®± `iframe`ï¼Œè¿½åŠ åˆ°å½“å‰æ²™ç®± `html` å…ƒç´ æœ«å°¾
- ä¸å­˜åœ¨ `WUJIE_DATA_FLAG`ï¼šæ·»åŠ åˆ°å®¹å™¨ `body` ä¸‹ï¼Œå› ä¸ºæ‹¦æˆªçš„å¯¹è±¡å°±æ˜¯ `body` å’Œ `head`

> ä¹Ÿå¯ä»¥å°† `iframe` æ·»åŠ åˆ°å®¹å™¨ `head`ï¼Œä½†æ˜¯æ²¡æœ‰æ„ä¹‰

#### `rewriteRemoveChild`ï¼šé‡å†™ `removeChild`

ç›®å½•ï¼š`effect.ts` - `rewriteRemoveChild` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L367)]

æ¥å—ä¸€ä¸ª `opts` å¯¹è±¡ï¼ŒåŒ…å« 2 ä¸ªå±æ€§ï¼š

- `rawElementRemoveChild`ï¼šåŸç”Ÿåˆ é™¤ `Dom` çš„æ–¹æ³•ï¼Œé€ä¼ è‡ª `patchRenderEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]
- `wujieId`ï¼šåº”ç”¨åï¼Œé€ä¼ ç»™ `findScriptElementFromIframe` è·å–æ²™ç®± `iframe` å’Œ `script` [[æŸ¥çœ‹](#findscriptelementfromiframeæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„-script)]

> `patchRenderEffect` æä¾› `rawElementRemoveChild` æ—¶éœ€è¦é€šè¿‡ `bind` å°†ä¸Šä¸‹æ–‡æŒ‡å‘å®¹å™¨ `head`

è¿”å›ä¸€ä¸ªæ–¹æ³•ç”¨äºé‡å†™ `removeChild`ï¼Œæ–¹æ³•éœ€è¦çš„å‚æ•°ï¼š

- `child`ï¼šåˆ é™¤çš„èŠ‚ç‚¹å…ƒç´ 

é‡å†™æ–¹æ³•è¿”å›ï¼š

| å‚æ•°ç±»å‹    | å¤„ç†æ–¹å¼                                                                                                               | å…ƒç´ ä¸å­˜åœ¨  |
| ----------- | ---------------------------------------------------------------------------------------------------------------------- | ----------- |
| `script`    | `findScriptElementFromIframe` æ‰¾åˆ° `script` åˆ é™¤å¹¶è¿”å›å…ƒç´  [[æŸ¥çœ‹](#findscriptelementfromiframeæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„-script)] | è¿”å› `null` |
| é `script` | `rawElementRemoveChild` æ‰¾åˆ° `script` åˆ é™¤å¹¶è¿”å›å…ƒç´                                                                    | æŠ¥é”™        |

> `rawElementRemoveChild` åˆ é™¤å…ƒç´ å‰éœ€è¦ç¡®ä¿å­˜åœ¨äº `head` ä¸‹

è®¾è®¡åˆè¡·ï¼šå’ŒåŸç”Ÿæ–¹æ³• `rawElementRemoveChild` ç›®çš„ä¸€æ ·åˆ é™¤ `head` ä¸‹çš„å…ƒç´ 

- è€Œåº”ç”¨ä¸­å­˜åœ¨ 2 ä¸ªå®¹å™¨ï¼šå­˜æ”¾ `script` çš„æ²™ç®±å®¹å™¨ï¼Œé™¤äº† `script` çš„åº”ç”¨æ¸²æŸ“å®¹å™¨
- å› æ­¤éœ€è¦æ ¹æ®åˆ é™¤çš„å…ƒç´ ï¼Œåˆ†å¼€æŸ¥æ‰¾å¹¶åˆ é™¤

æ²™ç®±ä¸­çš„ `script` å…¨éƒ¨é€šè¿‡ `insertScriptToIframe` é‡å»ºæ³¨å…¥æ²™ç®± [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]ï¼š

- æ²¡æœ‰ç‰¹å®šå±æ€§ä¸‹ï¼Œåº”ç”¨ä¸­åªèƒ½æ‹¿åˆ°åŠ¨æ€æ·»åŠ çš„ `script` è€Œæ‹¿ä¸åˆ°æ³¨å…¥æ²™ç®±çš„ `script`
- äºæ˜¯éœ€è¦ `findScriptElementFromIframe` æ ¹æ®æä¾›çš„å…ƒç´ ï¼Œæ‰¾å‡ºæ³¨å…¥æ²™ç®±çš„ `script` å¹¶åˆ é™¤ [[æŸ¥çœ‹](#findscriptelementfromiframeæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„-script)]

> åˆ é™¤åŠ¨æ€æ·»åŠ çš„ `script` æ— è®ºæ˜¯å†…è”è¿˜æ˜¯å¤–è”ï¼Œéƒ½ä¼šåŒæ—¶ä¸ºåŠ¨æ€æ·»åŠ çš„ `script` å’Œæ³¨å…¥æ²™ç®±çš„ `script` æ‰“ä¸Šç›¸åŒçš„æ ‡è®°ï¼Œè§ï¼šä¸ºåŠ¨æ€æ·»åŠ çš„ `script` æ‰“æ ‡è®° [[æŸ¥çœ‹](#ä¸ºåŠ¨æ€æ·»åŠ çš„-script-æ‰“æ ‡è®°)]

åˆ é™¤é™æ€ `script` çš„é—®é¢˜ï¼š

- å½“æ³¨å…¥çš„ `script` æå–è‡ªåº”ç”¨ä¸­é™æ€ `script`ï¼Œæ˜¯ä¸ä¼šæ‰“ä¸Šä»»ä½•æ ‡è®°çš„
- åˆ é™¤å…ƒç´ æ—¶å‘ç°å…ƒç´ æ˜¯ `script` ä½†æ²¡æœ‰æ ‡ç­¾ï¼Œè¿”å› `null` ä¸åšä»»ä½•æ“ä½œ

> è¿™ä¸ªé—®é¢˜ä¹Ÿå­˜åœ¨æ‰‹åŠ¨æ·»åŠ  `script`ï¼Œä½†æ˜¯è¿™ç§æƒ…å†µä¸å­˜åœ¨é€šè¿‡å­åº”ç”¨åˆ é™¤çš„åœºæ™¯ï¼Œå¯ä»¥å¿½ç•¥

å¦‚ä½•è§£å†³ï¼š

- ä¸ºé™æ€ `script` æ‰‹åŠ¨åŠ ä¸Š `data-wujie-script-id` å±æ€§ï¼Œå±æ€§å€¼å»ºè®®å”¯ä¸€çš„éçº¯æ•°å­—
- å½“åˆ é™¤å…ƒç´ æ—¶ï¼Œå‘ç°ç±»å‹ä¸º `script` ä¸”å­˜åœ¨æ ‡ç­¾ï¼Œåœ¨æ²™ç®± `head` ä¸­æ‰¾åˆ°å¹¶åˆ é™¤

> å±æ€§å€¼å”¯ä¸€èƒ½å¤Ÿå‡†ç¡®æ‰¾åˆ°å…ƒç´ ï¼Œéæ•°å­—æ˜¯ä¸ºäº†å’Œ `setTagToScript` é»˜è®¤æ‰“æ ‡ç­¾åŒºåˆ†å¼€æ¥ [[æŸ¥çœ‹](#ä¸ºåŠ¨æ€æ·»åŠ çš„-script-æ‰“æ ‡è®°)]

ç¼ºç‚¹æ˜¯æ‰‹åŠ¨ï¼Œä¸”æœ‰ä¾µå…¥æ€§ï¼š

- åœ¨ `processTpl` æä¾›äº†å‚æ•° `postProcessTemplate` ç”¨æ¥æ›´æ–°æå–çš„èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- ä½†ç›®å‰æ²¡æœ‰ç”¨åˆ°ï¼Œä¸”åˆä¸æ˜¯ `plugin`ï¼Œæ‰€ä»¥æš‚ä¸”è¿˜ä¸èƒ½é€šè¿‡é…ç½®ä¸ºé™æ€æå–çš„èµ„æºæ‰“æ ‡ç­¾

> `postProcessTemplate` å¯èƒ½æ˜¯å·¥ä½œäººå‘˜ä½ ä¸ºåç»­æ›´æ–°ç•™ä¸‹çš„ä¸€ä¸ªå£å­

#### `rewriteContains`ï¼šé‡å†™ `contains`

ç›®å½•ï¼š`effect.ts` - `rewriteContains` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L355)]

æ¥å—ä¸€ä¸ª `opts` å¯¹è±¡ï¼ŒåŒ…å« 2 ä¸ªå±æ€§ï¼š

- `rawElementContains`ï¼šåŸç”ŸæŸ¥æ‰¾ `Dom` çš„æ–¹æ³•ï¼Œé€ä¼ è‡ª `patchRenderEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]
- `wujieId`ï¼šåº”ç”¨åï¼Œé€ä¼ ç»™ `findScriptElementFromIframe` è·å– `script` [[æŸ¥çœ‹](#findscriptelementfromiframeæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„-script)]

> `patchRenderEffect` æä¾› `rawElementContains` æ—¶ï¼Œé€šè¿‡ `bind` å°†ä¸Šä¸‹æ–‡æ ¹æ®é‡å†™æ–¹æ³•æ¥è‡ªå®¹å™¨ `head` è¿˜æ˜¯å®¹å™¨ï¼Œçº æ­£ `this` çš„æŒ‡å‘

è¿”å›ä¸€ä¸ªæ–¹æ³•ç”¨äºé‡å†™ `contains`ï¼Œæ–¹æ³•éœ€è¦çš„å‚æ•°ï¼š

- `other`ï¼šæŸ¥æ‰¾çš„èŠ‚ç‚¹å…ƒç´ æˆ– `null`

é‡å†™æ–¹æ³•è¿”å›ï¼š

- å’ŒåŸç”Ÿ `rawElementContains` ä¸€æ ·ï¼Œä¸Šä¸‹æ–‡æ‰¾åˆ°å…ƒç´ ä¸º `true` å¦åˆ™ `false`

æµç¨‹å’Œè®¾è®¡åˆè¡·ã€æŸ¥æ‰¾æ–¹å¼ã€å­˜åœ¨é—®é¢˜å’Œ `rewriteRemoveChild` ä¸€æ · [[æŸ¥çœ‹](#rewriteremovechildé‡å†™-removechild)]

åŒºåˆ«åœ¨äºï¼š

| åˆ†ç±»   | `rewriteRemoveChild`        | `rewriteContains` |
| ------ | --------------------------- | ----------------- |
| ç”¨é€”   | åˆ é™¤å…ƒç´                     | æ£€æŸ¥æ˜¯å¦åŒ…å«å…ƒç´   |
| è¿”å›å€¼ | åˆ é™¤çš„å…ƒç´ ï¼Œæ‰¾ä¸åˆ°ä¸º `null` | `boolean`         |

#### `manualInvokeElementEvent`ï¼šæ‰‹åŠ¨è§¦å‘äº‹ä»¶å›è°ƒ

ç›®å½•ï¼š`effect.ts` - `manualInvokeElementEvent` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L51)]

å‚æ•°ï¼š

- `element`ï¼šè§¦å‘äº‹ä»¶çš„å…ƒç´ ï¼Œåªæ¥å— `HTMLLinkElement` å’Œ `HTMLScriptElement`
- `event`ï¼šäº‹ä»¶åï¼Œç›®å‰æä¾›çš„äº‹ä»¶åªæœ‰ `load` å’Œ `error`

> ä¼ è¿‡æ¥çš„ `element` å¿…é¡»æ˜¯å­åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„å…ƒç´ ï¼Œä¸ç„¶å°±å¤±å»è½¬å‘äº‹ä»¶çš„æ„ä¹‰äº†

è°ƒç”¨åœºæ™¯ï¼š

- `rewriteAppendOrInsertChild`ï¼šåŠ¨æ€æ·»åŠ å…ƒç´  [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

è®¾è®¡åˆè¡·ï¼š

- åœ¨åº”ç”¨ä¸­ç›‘å¬ `script` å’Œæ ·å¼åŠ è½½æƒ…å†µæ—¶ï¼Œä¼šé€šè¿‡ `onload` å’Œ `onerror`
- å¯¹äºåŠ¨æ€æ·»åŠ çš„å…ƒç´ ä¼šé€šè¿‡ `rewriteAppendOrInsertChild` è¿›è¡Œæ‹¦æˆª [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]
- æœ€ç»ˆæ³¨å…¥çš„å…ƒç´ å¯èƒ½å’ŒåŠ¨æ€æ·»åŠ çš„ä¸ä¸€æ ·ï¼Œå› æ­¤éœ€è¦ä»æ³¨å…¥çš„å…ƒç´ è½¬å‘äº‹ä»¶ç»™åŠ¨æ€æ·»åŠ çš„å…ƒç´ 

> ä½œä¸ºå­åº”ç”¨å†…éƒ¨ï¼Œæ­£å¸¸ç›‘å¬ `onload` å’Œ `onerror` å³å¯ï¼Œæ— éœ€åšä»»ä½•æ”¹å˜

å¯¹äºæ·»åŠ çš„å…ƒç´ ä¸åŒï¼Œäº‹ä»¶é€šçŸ¥æ–¹å¼ç•¥æœ‰å·®å¼‚ï¼š

- å¤–è” `script`ï¼šæ— è®ºæ˜¯å¦ `ignore`ï¼Œæ³¨å…¥åˆ°æ²™ç®±åä¼šé€šè¿‡ `loade` è°ƒç”¨ `manualInvokeElementEvent`
- å†…è” `script`ï¼šå¿½ç•¥é€šçŸ¥
- å¤–è”æ ·å¼ - `ignore`ï¼šç›´æ¥å°†åŠ¨æ€æ·»åŠ çš„æ ·å¼æ·»åŠ åˆ°å®¹å™¨ï¼ŒåŠ è½½äº‹ä»¶ä¸å˜
- å¤–è”æ ·å¼ - é `ignore`ï¼šåŠ è½½åä½œä¸ºå†…è”æ ·å¼æ³¨å…¥å®¹å™¨ï¼Œç„¶åè°ƒç”¨ `manualInvokeElementEvent`
- å…¶å®ƒå…ƒç´ ï¼šå¿½ç•¥é€šçŸ¥

æµç¨‹ï¼š

- é€šè¿‡ `CustomEvent` å®šä¹‰äº‹ä»¶ï¼Œå¹¶ä½¿ç”¨ `patchCustomEvent` åŠ«æŒäº‹ä»¶å¯¹è±¡æ·»åŠ å±æ€§
- å¦‚æœåŠ¨æ€æ·»åŠ çš„å…ƒç´ é€šè¿‡ `on` ç»‘å®šçš„äº‹ä»¶ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå¦åˆ™é€šè¿‡ `dispatchEvent` æ´¾å‘äº‹ä»¶

`patchCustomEvent` é€šè¿‡ ` Object.defineProperties` åŠ«æŒäº‹ä»¶ï¼š

- æ·»åŠ  2 ä¸ª å±æ€§ï¼š`srcElement`ã€`target`ï¼Œå…¨éƒ¨è¿”å›åŠ¨æ€æ·»åŠ çš„å…ƒç´  `element`

#### `findScriptElementFromIframe`ï¼šæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„ `script`

ç›®å½•ï¼š`effect.ts` - `findScriptElementFromIframe` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/effect.ts#L342)]

å‚æ•°ï¼š

- `rawElement`ï¼šåº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„ `script`
- `wujieId`ï¼šåº”ç”¨åï¼Œç”¨äºè·å–åº”ç”¨å®ä¾‹ä¸­çš„æ²™ç®± `iframe`

è¿”å›ä¸€ä¸ªå¯¹è±¡åŒ…å« 2 ä¸ªå±æ€§ï¼š

- `targetScript`ï¼šæ³¨å…¥æ²™ç®±çš„ `script`ï¼Œæ²¡æœ‰æ‰¾åˆ°è¿”å› `null`
- `iframe`ï¼šæ²™ç®± `iframe`ï¼Œä½œä¸º `script` çš„å®¹å™¨ï¼Œç”¨äºæŸ¥æ‰¾ã€åˆ é™¤ `script` æ—¶ä½¿ç”¨

è°ƒç”¨åœºæ™¯ï¼š

- `rewriteContains`ï¼šæŸ¥æ‰¾åº”ç”¨ä¸­æ˜¯å¦å­˜åœ¨å…ƒç´  [[æŸ¥çœ‹](#rewritecontainsé‡å†™-contains)]
- `rewriteRemoveChild`ï¼šä»åº”ç”¨ä¸­åˆ é™¤å…ƒç´  [[æŸ¥çœ‹](#rewriteremovechildé‡å†™-removechild)]

è®¾è®¡åˆè¡·ï¼š

- å¯¹äºåŠ¨æ€æ·»åŠ çš„å…ƒç´ ä¼šé€šè¿‡ `rewriteAppendOrInsertChild` è¿›è¡Œæ‹¦æˆª [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]
- æ³¨å…¥çš„ `script` å’ŒåŠ¨æ€æ·»åŠ çš„ä¸ä¸€æ ·ï¼Œå› æ­¤éœ€è¦æœ‰ä¸ªæ–¹æ³•ï¼Œèƒ½å¤ŸæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„ `script`

åŸç†ï¼š

- é€šè¿‡ `setTagToScript` ä¸ºåŠ¨æ€æ·»åŠ çš„ `script` å’Œæœ€ç»ˆæ³¨å…¥çš„ `script` æ‰“ç›¸åŒæ ‡è®° [[æŸ¥çœ‹](#ä¸ºåŠ¨æ€æ·»åŠ çš„-script-æ‰“æ ‡è®°)]

æµç¨‹ï¼š

- ä½¿ç”¨åŠ¨æ€æ·»åŠ çš„ `script` é€šè¿‡ `getTagFromScript` è·å–å…ƒç´ ä¸Šçš„æ ‡ç­¾ [[æŸ¥çœ‹](#ä¸ºåŠ¨æ€æ·»åŠ çš„-script-æ‰“æ ‡è®°)]
- ä½¿ç”¨åº”ç”¨åé€šè¿‡ `getWujieById` è·å–å®ä¾‹ä¸­çš„æ²™ç®± `iframe` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]
- å°†æ‹¿åˆ°çš„æ ‡ç­¾åœ¨æ²™ç®±ä¸­æŸ¥æ‰¾å¹¶è¿”å›æ³¨å…¥çš„ `script`ï¼Œæ‰¾ä¸åˆ°è¾“å‡ºè­¦å‘Šè¿”å› `null`

### è¾…åŠ©æ–¹æ³• - å®ç”¨å·¥å…·

#### `isConstructable`ï¼šåˆ¤æ–­å‡½æ•°æ˜¯å¦å¯ä»¥å®ä¾‹åŒ–

ç›®å½•ï¼š`utils.ts` - `isConstructable` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L60)]

å‚æ•°ï¼š

- `fn`ï¼šä»»æ„å¯¹è±¡ï¼Œå› ä¸ºå‚æ•°å·²ç»å…è®¸ `any` äº†

è¿”å›ï¼š

- `true`ï¼šå¯ä»¥å®ä¾‹åŒ–ï¼Œå¦åˆ™ `false`

> åˆ¤æ–­å¯¹äºä¸å¯å®ä¾‹åŒ–çš„å‡½æ•°ï¼Œé€šè¿‡ `call` ç»‘å®šä¸Šä¸‹æ–‡

ä»¥ä¸‹æƒ…å†µéƒ½å°†è®¤ä¸ºæ˜¯å¯å®ä¾‹åŒ–çš„å‡½æ•°ï¼š

- åŸå‹ `constructor` æŒ‡å‘è‡ªèº«çš„æ™®é€šå‡½æ•°ï¼ŒåŸå‹é™¤äº† `constructor` å¤–è¿˜æœ‰å…¶å®ƒå±æ€§
- ä»¥å¤§å†™å¼€å¤´çš„å‡½æ•°ï¼š`/^function\b\s[A-Z].*/`
- ä»¥ `class` å¼€å¤´çš„ç±»

> ä»¥ä¸Šå¯ä»¥æ’é™¤ç®­å¤´å‡½æ•°ï¼Œå› ä¸ºå‰ªå¤´å‡½æ•°æ²¡æœ‰ `prototype`ï¼Œè½¬æ¢å­—ç¬¦ä¸²ä¸º `() => {}`

è¿”å›ç»“æœå‰éœ€è¦ä»æ˜ å°„è¡¨ `fnRegexCheckCacheMap` ä¸­è·å–ç»“æœï¼š

- æŸ¥åˆ°ç»“æœä¸å†æ­£åˆ™åŒ¹é… `fn`ï¼Œç›´æ¥è¿”å›ç»“æœ
- å¦åˆ™å°†è®¡ç®—çš„ç»“æœå“¦ä¿å­˜åˆ°æ˜ å°„è¡¨åçƒ¦è¿”å›

#### `isCallable`ï¼šåˆ¤æ–­å¯¹è±¡æ˜¯ä¸€ä¸ªå‡½æ•°

ç›®å½•ï¼š`utils.ts` - `isCallable` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L37)]

å‚æ•°ï¼š

- `fn`ï¼šä»»æ„å¯¹è±¡

è¿”å›ï¼š

- `true`ï¼šæ˜¯å‡½æ•°ï¼Œå¦åˆ™ `false`

æµç¨‹ï¼š

- åˆ¤æ–­ `fn` æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¼šä¼˜å…ˆä»æ˜ å°„è¡¨ `callableFnCacheMap` è·å–
- ä¸å­˜åœ¨ç¼“å­˜åˆ™åˆ¤æ–­ï¼Œæ˜¯å‡½æ•°è®°å½•åˆ°æ˜ å°„è¡¨ï¼Œç„¶åè¿”å›åˆ¤æ–­ç»“æœ

åˆ¤æ–­ä¸­å¯¹äºè€çš„æµè§ˆå™¨åšäº†å…¼å®¹ï¼š

```
const naughtySafari = typeof document.all === "function" && typeof document.all === "undefined";
```

#### `isBoundedFunction`ï¼šåˆ¤æ–­é€šè¿‡ `Function.prototype.bind` è¿”å›çš„å‡½æ•°

ç›®å½•ï¼š`utils.ts` - `isBoundedFunction` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L50)]

å‚æ•°ï¼š

- `fn`ï¼š`CallableFunction`

> ç›®çš„ï¼šåˆ¤æ–­å‡½æ•°æ˜¯å¦æ¥è‡ª `Function.prototype.bind`ï¼Œé¿å…é‡å¤ `bind`

è¿”å›ï¼š

- é€šè¿‡ `bind` ç»‘å®šçš„å‡½æ•°è¿”å› `true`ï¼Œå¦åˆ™ `false`

é€šè¿‡ `bind` è¿”å›çš„å‡½æ•°ï¼šå‡½æ•°åç§°ä»¥ `bound ` å¼€å¤´ï¼ˆæ³¨æ„æœ‰ä¸ªç©ºæ ¼ï¼‰ï¼Œæ²¡æœ‰ `prototype`

```
function originalFunction() {}
const boundFunction = originalFunction.bind(this);

console.log(originalFunction.name);    // originalFunction
console.log(boundFunction.name);    // bound originalFunction

console.log(originalFunction.prototype);    // {}
console.log(boundFunction.prototype);    // undefined
```

æµç¨‹ï¼š

- ä¼˜å…ˆä»æ˜ å°„è¡¨ `boundedMap` è·å–ï¼Œä¸å­˜åœ¨åˆ™åˆ¤æ–­ï¼Œå°†ç»“æœè®°å½•åˆ°æ˜ å°„è¡¨å¹¶è¿”å›

åˆ¤æ–­æ–¹æ³•ï¼š

```
const bounded = fn.name.indexOf("bound ") === 0 && !fn.hasOwnProperty("prototype");
```

åªè¦ `bind` è¿‡çš„å‡½æ•°éƒ½è¿”å› `true`ï¼ŒåŒ…æ‹¬ï¼šç®­å¤´å‡½æ•°ã€æ™®é€šå‡½æ•°

- ä½†ä¸èƒ½é€šè¿‡ `bind` æŒ‡å®šç®­å¤´å‡½æ•°ä¸Šä¸‹æ–‡ï¼Œå› ä¸ºç®­å¤´å‡½æ•°ä¸Šä¸‹æ–‡å–å†³äºæ‰€åœ¨ä½œç”¨åŸŸçš„ `this`

#### `getTargetValue` ä»å¯¹è±¡ä¸­è·å–å±æ€§

ç›®å½•ï¼š`utils.ts` - `getTargetValue` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L91)]

å‚æ•°ï¼š

- `target`ï¼šæºç ä¸­æ˜¯ `any`ï¼Œå®åˆ™åº”è¯¥æ˜¯ `{ [key: PropertyKey]: any }` å¯¹è±¡
- `p`ï¼šæºç ä¸­æ˜¯ `any`ï¼Œå®åˆ™åº”è¯¥æ˜¯ `PropertyKey`

è¿”å›ï¼š

- å¯¹è±¡ä¸­æ‰¾åˆ°çš„å±æ€§ï¼Œæ²¡æœ‰åˆ™æ˜¯ `undefined`

ä¼˜å…ˆä»æ˜ å°„è¡¨ `setFnCacheMap` è·å–å¯¹è±¡å±æ€§ [[æŸ¥çœ‹](#1-setfncachemap-å­˜å‚¨ç»‘å®šä¸Šä¸‹æ–‡çš„æ–¹æ³•)]ï¼š

| `setFnCacheMap` | ç¬¦åˆæ¡ä»¶çš„å‡½æ•°                 | å…¶å®ƒ                                   |
| --------------- | ------------------------------ | -------------------------------------- |
| å­˜åœ¨ä¼˜å…ˆè¿”å›    | ä¸å†è€ƒè™‘                       | ä¸å†è€ƒè™‘                               |
| ä¸å­˜åœ¨          | ç»‘å®šä¸Šä¸‹æ–‡åä¿å­˜åœ¨æ˜ å°„è¡¨å¹¶è¿”å› | ä¸è€ƒè™‘                                 |
| ä¸å­˜åœ¨          | ä¸ç¬¦åˆ                         | ç›´æ¥è¿”å›ï¼Œè‹¥å±æ€§ä¸å­˜åœ¨è¿”å› `undefined` |

ç¬¦åˆçš„æ¡ä»¶ï¼š

- `isCallable`ï¼šåªæœ‰å‡½æ•°æ‰èƒ½é€šè¿‡ `bind` ç»‘å®šä¸Šä¸‹æ–‡ [[æŸ¥çœ‹](#iscallableåˆ¤æ–­å¯¹è±¡æ˜¯ä¸€ä¸ªå‡½æ•°)]
- `!isBoundedFunction`ï¼šç¡®ä¿å‡½æ•°æ²¡æœ‰ç»‘å®šè¿‡ä¸Šä¸‹æ–‡ [[æŸ¥çœ‹](#isboundedfunctionåˆ¤æ–­é€šè¿‡-functionprototypebind-è¿”å›çš„å‡½æ•°)]
- `!isConstructable`ï¼šç¡®ä¿å‡½æ•°ä¸å¯å®ä¾‹åŒ–ï¼Œå› ä¸ºå®ä¾‹åŒ–çš„å‡½æ•°æœ‰è‡ªå·±çš„ä¸Šä¸‹æ–‡ [[æŸ¥çœ‹](#isconstructableåˆ¤æ–­å‡½æ•°æ˜¯å¦å¯ä»¥å®ä¾‹åŒ–)]

> è¡¥å……ï¼šå½“å‡½æ•°é€šè¿‡ `bind` ç»‘å®šè¿‡ä¸Šä¸‹æ–‡ï¼Œå†æ¬¡ `bind` é‡‡ç”¨é¦–æ¬¡ç»‘å®šçš„ä¸Šä¸‹æ–‡

ç”±æ­¤å¾—çŸ¥ç¬¦åˆæ¡ä»¶æœ‰ 2 ç±»ï¼š

| åˆ†ç±»     | ç»‘å®šåä¸Šä¸‹æ–‡                    |
| -------- | ------------------------------- |
| ç®­å¤´å‡½æ•° | ä¸å—å½±å“ï¼Œä¿æŒæ‰€åœ¨ä½œç”¨åŸŸ `this` |
| æ™®é€šå‡½æ•° | æä¾›çš„å¯¹è±¡                      |

> åªè¦å‡½æ•°è¿˜æœª `bind` è¿‡ï¼Œä¸”ä¸åœ¨ `isConstructable` å¯å®ä¾‹åŒ–èŒƒå›´éƒ½ç¬¦åˆè¦æ±‚ [[æŸ¥çœ‹](#isconstructableåˆ¤æ–­å‡½æ•°æ˜¯å¦å¯ä»¥å®ä¾‹åŒ–)]

ä¸ºç¬¦åˆæ¡ä»¶çš„å±æ€§ç»‘å®šä¸Šä¸‹æ–‡ï¼š

- é€šè¿‡ `Function.prototype.bind.call` ç»‘å®š `target` ä¸ºå‡½æ•°ä¸Šä¸‹æ–‡
- å°†ç»‘å®šåçš„å‡½æ•°ä¿å­˜åœ¨æ˜ å°„è¡¨ `setFnCacheMap`ï¼Œä»¥ä¾¿ä¸‹æ¬¡è·å–
- å°†åŸå‡½æ•°æµ…æ‹·è´å±æ€§åˆ°ç»‘å®šçš„æ–¹æ³•ä¸­
- é€šè¿‡ `Object.defineProperty` ä¸ºç»‘å®šçš„æ–¹æ³•æ·»åŠ  `prototype` æŒ‡å‘åŸå‡½æ•°çš„ `prototype`

æ·»åŠ  `property` æ„ä¹‰ï¼š

- æ·»åŠ åŸå‹é“¾ï¼Œè§ï¼š`qiankun` å¼€å‘äººå‘˜çš„æ€»ç»“ [[æŸ¥çœ‹](https://github.com/kuitos/kuitos.github.io/issues/47)]

> éœ€è¦æ³¨æ„çš„æ˜¯ç®­å¤´å‡½æ•°æ˜¯æ²¡æœ‰ `prototype`ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦æ·»åŠ åŸå‹é“¾

æµ…æ‹·è´å±æ€§æ˜¯è®©ç»‘å®šçš„æ–¹æ³•å’ŒåŸæ¥çš„æ–¹æ³•å±æ€§ä¸€è‡´ï¼Œè§ä¸‹æ–¹æ¼”ç¤ºï¼š

```
function exampleFunc() {
  console.log("Hello");
}

exampleFunc.customProperty = "I am a custom property";
exampleFunc.customMethod = function() {
  console.log("I am a custom method");
};

const boundExampleFunc = Function.prototype.bind.call(exampleFunc, null);

for (const key in exampleFunc) {
  boundExampleFunc[key] = exampleFunc[key];
}

console.log(boundExampleFunc.customProperty); // "I am a custom property"
boundExampleFunc.customMethod(); // "I am a custom method"
```

å…³äº `bind.call` é€Ÿè®°æ–¹æ³•ï¼Œå…¨éƒ¨ä»¥ `call` ä½œä¸ºè®°å¿†ç‚¹ï¼š

- `call`ï¼šç«‹å³æ‰§è¡Œæä¾›çš„çš„æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å‘ `this`ï¼Œåé¢å‚æ•°é€ä¼ ç»™æ‰§è¡Œæ–¹æ³•
- `apply`ï¼šå’Œ `call` ä¸€æ ·ï¼Œä¸åŒçš„æ˜¯é€ä¼ çš„å‚æ•°æ˜¯ä»¥æ•°ç»„å½¢å¼
- `bind`ï¼šå¯ä»¥çœ‹åšå°† `call` æŸ¯é‡ŒåŒ–ä¹‹åè¿”å›æ–°çš„å‡½æ•°

`Function.prototype.bind.call` å’Œ `bind` ä¸€æ ·ï¼Œä¸åŒå¤„ï¼š

- ç»‘å®šçš„å‡½æ•°ä¸ºç¬¬ 1 ä¸ªå‚æ•°ï¼Œå…¶ä½™å‚æ•°é¡ºå»¶ä¾æ¬¡æ˜¯ä¸Šä¸‹æ–‡å’Œé€ä¼ çš„å‚æ•°
- `bind.call` ä½œä¸º `prototype` é€‚ç”¨äºç»‘å®šä¸æ˜ç¡®çš„å‡½æ•°ï¼Œ`bind` é€‚ç”¨äºç»‘å®šå·²æ˜ç¡®çš„å‡½æ•°

åŒç† `Function.prototype.bind.apply` å’Œ `Function.prototype.bind.call` æ˜¯ä¸€æ ·çš„ï¼š

- ç»‘å®šçš„å‡½æ•°ä¸ºç¬¬ 1 ä¸ªå‚æ•°ï¼Œä¸åŒåœ¨äºå…¶ä½™çš„å‚æ•°å…¨éƒ¨é›†åˆåœ¨ä¸€ä¸ªæ•°ç»„ä¸­é€ä¼ è¿‡å»

ä¸ºä»€ä¹ˆè¦ç”¨ `getTargetValue`ï¼š

- æ­¤å‡½æ•°ç”¨äº `Proxy` ä»£ç†å¯¹è±¡ `get` æ“ä½œæ—¶ï¼Œè‹¥ä¸æä¾› `get` æˆ– `get` ä¸­ç›´æ¥è¿”å›å±æ€§ä¼šæŠ¥é”™
- æ­£ç¡®çš„åšæ³•æ˜¯ä»ä»£ç†çš„åŸå§‹å¯¹è±¡ä¸­æ‰¾åˆ°å¯¹åº”çš„å±æ€§å¹¶è¿”å›

é”™è¯¯æ¼”ç¤ºï¼š

```
// ä»£ç†ä¸æä¾› `get` æ–¹æ³•ï¼Œè°ƒç”¨æ–¹æ³•æ—¶æŠ¥é”™
const proxyWindow = new Proxy(window);
proxyWindow.addEventListener;

// ç›´æ¥è¿”å›å±æ€§åŒæ ·ä¹Ÿä¼šæŠ¥é”™
const proxyWindow = new Proxy(window, {
  get: (target, key) => target[key],
});
proxyWindow.addEventListener;
```

#### `compose` ç”¨æŸ¯é‡ŒåŒ–çš„æ–¹å¼æ‹å¹³ä¸€ç»„å‡½æ•°

æä¾›ä¸€ä¸ªæ•°ç»„å‡½æ•°ï¼Œé€šè¿‡ `reduce` æ‹å¹³æ‰§è¡Œ

ç›®å½•ï¼š`utils.ts` - `compose` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L270)]

å‚æ•°ï¼š

- `fnList`ï¼šä¸€ç»„æ‰§è¡Œå‡½æ•°

> æºç ä¸­ `fnList` çš„ç±»å‹æ˜¯ `Array<Function>`ï¼Œå®é™…åº”è¯¥æ˜¯ `Array<(...args: Array<string>) => string>`

è¿”å›ï¼š

- è¿”å›ä¸€ä¸ªæ–¹æ³•ï¼Œç±»å‹å’Œ `fnList` ä¸­çš„å‡½æ•°æ˜¯ä¸€è‡´çš„ï¼Œç¡®ä¿æ— è®ºå¦‚ä½•éƒ½èƒ½æ‰§è¡Œ

è°ƒç”¨åœºæ™¯ï¼š

| è°ƒç”¨å‡½æ•°                                                      | æå– `plugin`                                                                                    | ç”¨å¤„                         |
| ------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ | ---------------------------- |
| `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)] | `cssLoader`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-loader)]   | æ›¿æ¢åº”ç”¨ä¸­æå–çš„é™æ€æ ·å¼     |
| `importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]                   | `htmlLoader`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#html-loader)] | æ›¿æ¢åº”ç”¨å…¥å£èµ„æº             |
| `getCssLoader` [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]                    | `cssLoader`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-loader)]   | æ›¿æ¢æ‰‹åŠ¨æ³¨å…¥å’ŒåŠ¨æ€æ·»åŠ çš„æ ·å¼ |
| `getJsLoader` [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]                     | `jsLoader`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-loader)]     | æ›¿æ¢æ³¨å…¥æ²™ç®±çš„ `script`      |

æ›¿æ¢çš„æ ·å¼å’Œ `script` å¿…é¡»æ˜¯å†…è”çš„ï¼š

- å¤–è”èµ„æºä¼ é€’ç»™ `plugin` æ˜¯ç©ºå­—ç¬¦ï¼Œä¹Ÿå¯ä»¥è¿”å› `code`ï¼Œä½†æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºä¼˜å…ˆä½¿ç”¨ `src` åŠ è½½èµ„æº
- åº”ç”¨ä¸­çš„å¤–è”èµ„æºä»…é™æ‰‹åŠ¨é…ç½® `ignore` èµ„æºé›†åˆï¼Œé»˜è®¤æƒ…å†µå¤–è”èµ„æºä¼šåŠ è½½åä½œä¸ºå†…è”èµ„æºæ³¨å…¥

æ‰§è¡Œè¿”å›çš„æ–¹æ³•å°†è¿”å› `string`ï¼Œæä¾›çš„å‚æ•°ä¹Ÿå…¨éƒ¨æ˜¯ `string`ï¼š

- `htmlLoader`ï¼šä»…æä¾›æå–çš„èµ„æº `html` ä½œä¸ºå‚æ•°
- å…¶ä½™çš„ `plugins` å°†æä¾› 3 ä¸ªå‚æ•°ï¼š
  - `code`ï¼šèµ„æºå†…å®¹ï¼Œæ ¹æ® `plugin` æä¾›æ ·å¼æˆ– `script`
  - `src`ï¼šèµ„æºé“¾æ¥ï¼Œå¦‚æœä¸å­˜åœ¨ä¸ºç©ºå­—ç¬¦ï¼Œä¾‹å¦‚ï¼šå†…è”èµ„æº
  - `base`ï¼šå­åº”ç”¨ `origin` + `pathname`

æ“ä½œåŸç†ï¼š

- é€šè¿‡ `reduce` å°† `fnList` æ•°ç»„ä¸­çš„å‡½æ•°æ‹å¹³æ‰§è¡Œï¼Œåˆå§‹å€¼ä¸ºæä¾›çš„åŸå§‹ `code`
- è¿™æ ·å³ä¾¿ `fnList` æ•°ç»„æ²¡æœ‰ä»»ä½•å‡½æ•°ï¼Œä¹Ÿèƒ½å¤Ÿå°†åŸå§‹çš„ `code` è¿”å›
- å¦‚æœ `fnList` ä¸­æä¾›äº†å‡½æ•°ï¼Œå°† `code` åŠå…¶å®ƒå‚æ•°ä¼ è¿‡å»ï¼Œè¿”å›æ–°çš„å€¼ä¾æ¬¡æ‰§è¡Œå¹¶è¿”å›æœ€ç»ˆæ›¿æ¢ç»“æœ

ç”±äºè°ƒç”¨æ—¶ï¼Œä¼ é€’è¿‡æ¥çš„æ•°ç»„ä»…ä»…æ˜¯é€šè¿‡ `map` è¿‡æ»¤äº† `plugins`ï¼š

- æ‰€ä»¥ `compose` é€šè¿‡ `reduce` éå†æ•°ç»„æ—¶ï¼Œæœ‰å¯èƒ½èƒ½æ‹¿åˆ°çš„æ˜¯ `udefined`
- å¯¹äºè¿™ç§æƒ…å†µç›´æ¥è¿”å› `code` ä¸ºä¸‹ä¸€ä¸ª `loader` æ›¿æ¢èµ„æº

#### ä¸ºåŠ¨æ€æ·»åŠ çš„ `script` æ‰“æ ‡è®°

åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„ `script` ä¼šè¢« `rewriteAppendOrInsertChild` åŠ«æŒï¼Œå› æ­¤æœ€ç»ˆæ³¨å…¥æ²™ç®±çš„ `script` ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚åœ¨ `wujie` ä¸­é€šè¿‡æ‰“æ ‡è®°çš„æ–¹å¼ç›¸äº’å…³è”ã€‚

**1. `setTagToScript` æ·»åŠ æ ‡è®°**

ç›®å½•ï¼š`utils.ts` - `setTagToScript` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L300)]

å‚æ•°ï¼š

- `element`ï¼š`HTMLScriptElement` å…ƒç´ 
- `tag`ï¼šè®¾ç½®æ ‡è®°åï¼Œé€‰å¡«

> ä½¿ç”¨ç›¸åŒçš„ `tag` æ‰“æ ‡è®°ï¼Œèƒ½å¤Ÿå…³è”ä¸¤ä¸ªä¸åŒçš„ `script` å…ƒç´ 

æµç¨‹ï¼š

- åˆ¤æ–­ `element` æ˜¯å¦ä¸º `script` å…ƒç´ ï¼Œæ˜¯åˆ™æ‰“ä¸Šæ ‡è®° `WUJIE_SCRIPT_ID`
- æ ‡è®°å€¼ä¸º `tag`ï¼Œæ²¡æœ‰æä¾›çš„è¯é‡‡ç”¨è‡ªå¢ `id`

é€šè¿‡æ‰“æ ‡è®° `WUJIE_SCRIPT_ID`ï¼Œæ–¹ä¾¿é€šè¿‡ï¼š

- `getTagFromScript`ï¼šæå– `script` ä¸­çš„æ ‡ç­¾ï¼Œè§ä¸‹æ–¹è¯¦ç»†è¯´æ˜
- `findScriptElementFromIframe`ï¼šæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„ `script` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

è°ƒç”¨åœºæ™¯ï¼Œæ‰§è¡Œè¿‡ç¨‹ä»ä¸Šè‡³ä¸‹ï¼š

| æ‰§è¡Œæ–¹æ³•                                                                                           | æ“ä½œæ–¹å¼                   | å¦‚ä½•æ‰“æ ‡è®°                   |
| -------------------------------------------------------------------------------------------------- | -------------------------- | ---------------------------- |
| `rewriteAppendOrInsertChild` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)] | æ‹¦æˆªåŠ¨æ€æ·»åŠ çš„ `script`    | è‡ªå¢ç¼–å·                     |
| `insertScriptToIframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]                            | åˆ›å»ºå¹¶æ³¨å…¥ `script` åˆ°æ²™ç®± | æ ¹æ®åŠ¨æ€æ·»åŠ çš„ `script` ç¼–å· |

> åŠ¨æ€æ·»åŠ å’Œæ³¨å…¥æ²™ç®±çš„ `script` æ ‡ç­¾ç¼–å·æ˜¯ä¸€è‡´çš„ï¼ŒåŸå› è§ï¼š`findScriptElementFromIframe` [[æŸ¥çœ‹](#findscriptelementfromiframeæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„-script)]

ä¸éœ€è¦æ‰“æ ‡è®°çš„æƒ…å†µï¼š

- é€šè¿‡ `processTpl` é™æ€æå–çš„ `script` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- `start` å¯åŠ¨åº”ç”¨ä¸­ï¼Œæ‰‹åŠ¨æ·»åŠ çš„ `script`ï¼Œè§ï¼šæ”¶é›†é˜Ÿåˆ— [[æŸ¥çœ‹](#1-æ”¶é›†é˜Ÿåˆ—)]

**2. `getTagFromScript` æå– `script` ä¸­æ ‡è®°å€¼**

ç›®å½•ï¼š`utils.ts` - `getTagFromScript` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L307)]

å‚æ•°ï¼š

- `element`ï¼š`HTMLScriptElement` å…ƒç´ 

æµç¨‹ï¼š

- åˆ¤æ–­ `element` æ˜¯å¦ä¸º `script` å…ƒç´ ï¼Œæ˜¯åˆ™æå–æ ‡è®° `WUJIE_SCRIPT_ID`
- ä¸æ˜¯ `script` æˆ–å±æ€§ä¸å­˜åœ¨éƒ½è¿”å› `null`

è°ƒç”¨åœºæ™¯ï¼š

- `findScriptElementFromIframe`ï¼šæŸ¥æ‰¾åŠ¨æ€æ·»åŠ çš„ `script` [[æŸ¥çœ‹](#findscriptelementfromiframeæŸ¥æ‰¾æ³¨å…¥æ²™ç®±çš„-script)]
- `insertScriptToIframe`ï¼šæ³¨å…¥ `script` åˆ°æ²™ç®± `iframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

### æ˜ å°„è¡¨å’Œé˜Ÿåˆ—

#### ğŸ“ å…¨å±€æ˜ å°„è¡¨

#### 1. `idToSandboxCacheMap`ï¼šå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®

ç›®å½•ï¼š`common.ts` - `idToSandboxCacheMap` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/common.ts#L11)]

å…¨éƒ¨æ— ç•Œå®ä¾‹å’Œé…ç½®å­˜å‚¨ `map`ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰ï¼š

- ç±»å‹ï¼š`new Map<String, SandboxCache>()`ï¼Œåº”ç”¨åä¸º `key`ï¼Œå®ä¾‹ä¸º `SandboxCache`

`SandboxCache` åŒ…å« 2 ä¸ªå±æ€§ï¼š

- `wujie`ï¼š`Wujie` ç±»çš„å®ä¾‹ [[æŸ¥çœ‹](#wujie-åº”ç”¨ç±»)]
- `options`ï¼šæ¥è‡ª `setupApp` å­˜å‚¨çš„é…ç½®ä¿¡æ¯ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

æ·»åŠ æ˜ å°„è¡¨æœ‰ 2 ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ä¸ºï¼š

- `addSandboxCacheWithWujie`ï¼šæ”¶é›† `Wujie` å®ä¾‹å¯¹è±¡ï¼Œè§ï¼šå°†å®ä¾‹æ·»åŠ åˆ°æ˜ å°„è¡¨ [[æŸ¥çœ‹](#5-å°†å®ä¾‹æ·»åŠ åˆ°æ˜ å°„è¡¨)]
- `addSandboxCacheWithOptions`ï¼šé€šè¿‡ `setupApp` æ”¶é›†åº”ç”¨é…ç½®ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

é€šè¿‡åˆ›å»º `Wujie` å®ä¾‹æ·»åŠ æ˜ å°„è¡¨æœ‰ 2 ä¸ªå¤„ï¼š

- `preloadApp`ï¼šé¢„åŠ è½½ï¼Œè§ï¼šå£°æ˜ä¸€ä¸ªå®ä¾‹ [[æŸ¥çœ‹](#2-å£°æ˜ä¸€ä¸ªå®ä¾‹)]
- `startApp`ï¼šå¯åŠ¨åº”ç”¨ï¼Œè§ï¼šåˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹ [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)]

ä»è¿™é‡Œå¯ä»¥çŸ¥é“ï¼š

- `preloadApp`ï¼šé¢„åŠ è½½å¯ä»¥æå¤§çš„æå‡å­åº”ç”¨é¦–æ¬¡æ‰“å¼€é€Ÿåº¦
- `startApp`ï¼šæ ¹æ®é…ç½®ä¿¡æ¯å’Œæ¨¡å¼æ¥å†³å®šåœ¨å¯åŠ¨åº”ç”¨å‰æ˜¯å¦åˆ›å»ºå®ä¾‹
- `setupApp`ï¼šå¯ä»¥é¢„å…ˆä¸º `startApp` å’Œ `preloadApp` æä¾›é…ç½®ä¿¡æ¯

> `startApp` æ¯æ¬¡éƒ½ä¼šä»æ˜ å°„è¡¨è·å–å®ä¾‹ï¼Œä½†é»˜è®¤çš„é‡å»ºæ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰å®ä¾‹éƒ½ä¼šé€šè¿‡ `destroy` æ³¨é”€åé‡å»º

è·å–æ˜ å°„è¡¨çš„æ–¹æ³•æœ‰ 2 ä¸ªï¼š

- `getWujieById`ï¼šé€šè¿‡åº”ç”¨åè·å–å¼•ç”¨å®ä¾‹ï¼Œå¦‚æœæ²¡æœ‰æ‹¿åˆ°è¿”å› `null`
- `getOptionsById`ï¼šé€šè¿‡åº”ç”¨åè·å–ç¼“å­˜çš„å®ä¾‹é…ç½®ï¼Œå¦‚æœæ²¡æœ‰æ‹¿åˆ°è¿”å› `null`

åˆ é™¤æ˜ å°„è¡¨çš„æ–¹æ³•åªæœ‰ 1 ä¸ªï¼š

- `deleteWujieById`ï¼šä¼šä»æ˜ å°„è¡¨ `idToSandboxCacheMap` ä¸­åˆ é™¤å®ä¾‹å’Œç¼“å­˜å®ä¾‹çš„é…ç½®

> ä»…èƒ½é€šè¿‡ `destroy` é”€æ¯åº”ç”¨å®ä¾‹æ—¶æ‰èƒ½åˆ é™¤æ˜ å°„è¡¨ [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]

å®ä¾‹æ˜ å°„è¡¨åœ¨åº”ç”¨ä¸­å…·æœ‰å”¯ä¸€æ€§ï¼š

- é€šè¿‡ `window.__WUJIE.inject` æŒ‡å‘ä¸Šä¸€çº§æ˜ å°„è¡¨ï¼Œè§ï¼šæ„é€ å‡½æ•° `inject` [[æŸ¥çœ‹](#1-inject-æ³¨å…¥å­åº”ç”¨-3-ä¸ªå¯¹è±¡)]

#### 2. `appEventObjMap`ï¼šå­˜å‚¨ `eventBus` æ‰˜ç®¡çš„äº‹ä»¶

ç›®å½•ï¼š`event.ts` - `appEventObjMap` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/event.ts#L7)]

å…¨éƒ¨äº‹ä»¶å­˜å‚¨ `map`ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰ï¼š

- ç±»å‹ï¼š`new Map<String, EventObj>()`ï¼Œå®ä¾‹åä¸º `key`ï¼Œç›‘å¬äº‹ä»¶ä¸º `EventObj`
- `key` åˆ†ä¸¤ç§æƒ…å†µï¼šåŸºåº§ä»¥æ—¶é—´æˆ³å­—ç¬¦å‘½åã€å­åº”ç”¨ä»¥åº”ç”¨åå‘½å
- `EventObj`ï¼šæ˜¯ä¸€ä¸ªäº‹ä»¶é›†åˆï¼Œé”®åæ˜¯ `event_name`ï¼Œé”®å€¼æ˜¯ç›‘å¬å‡½æ•°é›†åˆçš„æ•°ç»„

äº‹ä»¶æ˜ å°„è¡¨å…³è”æµç¨‹å›¾ï¼ˆç‚¹å¼€æ–°çª—å£æ”¾å¤§ç¼©å°æŸ¥çœ‹ç»†èŠ‚ï¼‰ï¼š

![eventBus](https://github.com/user-attachments/assets/be5e9b09-770f-406d-96d2-5eff0ad549ee)

è·å–æ˜ å°„è¡¨æœ‰ 3 ç§æ–¹å¼ï¼š

| è·å–æ˜ å°„è¡¨                             | å¯ç”¨ç¯å¢ƒ                   | è¡¥å……è¯´æ˜       |
| -------------------------------------- | -------------------------- | -------------- |
| `import { bus } "wujie";`              | åŸºåº§ï¼ŒåŒ…æ‹¬å­åº”ç”¨ä¸­çš„åŸºåº§   | æ¨è           |
| `window.$wujie.bus`                    | å­åº”ç”¨                     | æ¨è           |
| `window.$wujie.bus`                    | å­åº”ç”¨ä¸­çš„åŸºåº§             | å¯ä»¥ï¼Œä½†ä¸æ¨è |
| `window.__WUJIE.inject.appEventObjMap` | å­åº”ç”¨ï¼ŒåŒ…æ‹¬å­åº”ç”¨ä¸­çš„åŸºåº§ | ä¸æ¨è         |

> `appEventObjMap` çš„ä½œç”¨æ˜¯æ˜ å°„è¡¨ä¸åŒå±‚çº§é“¾è·¯å¼•ç”¨ï¼Œä½œä¸ºä½¿ç”¨è€…å»ºè®®é€šè¿‡ `bus` æ¥å¤„ç†é€šä¿¡

é€šè¿‡ `window.__POWERED_BY_WUJIE__` åˆ¤å®šåµŒå¥—åœ¨å­åº”ç”¨ä¸­æ—¶ï¼Œå°†é€šè¿‡ `inject` å‘ä¸Šå¼•ç”¨ï¼š

- å®ä¾‹ä¸­ä¼šä¿å­˜ `inject` ä½œä¸ºé“¾è·¯å¼•ç”¨ï¼Œè§ï¼šæ„é€ å‡½æ•° `inject` [[æŸ¥çœ‹](#1-inject-æ³¨å…¥å­åº”ç”¨-3-ä¸ªå¯¹è±¡)]
- æ˜ å°„è¡¨é“¾æœ€åº•å±‚æ˜¯ `Map` å¯¹è±¡

> é€‚ç”¨äºå®ä¾‹åˆå§‹åŒ–ï¼Œä»¥åŠè·å– `appEventObjMap` æ˜ å°„è¡¨

**`EventBus` çš„åŸç†æ¦‚è¿°**

ä»é€šä¿¡æ–¹é¢æ¦‚è¿°åŸç†ï¼Œä½¿ç”¨æ–¹æ³•è§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/bus.html)]

é€šè¿‡ `$on` æ”¶é›†è®¢é˜…çš„äº‹ä»¶ï¼š

- æ„é€ å‡½æ•°ä¸­ä½¿ç”¨åº”ç”¨åä½œä¸º `key`ï¼Œä»æ˜ å°„è¡¨æ‰¾å‡ºäº‹ä»¶å¯¹è±¡ï¼Œæ²¡æœ‰åˆ™åˆ›å»ºç©ºå¯¹è±¡ `{}`
- å°†äº‹ä»¶åå’Œæ–¹æ³•æŒ‰ç…§ç±»å‹ `[event: string]: Array<Function>` æ·»åŠ åˆ° `eventObj`

é€šè¿‡ `$emit` æ´¾å‘äº‹ä»¶ï¼š

- éå†æ•´ä¸ªæ˜ å°„è¡¨ï¼Œæ”¶é›†äº‹ä»¶åŒåçš„å›è°ƒå‡½æ•°ï¼Œä»¥åŠæ‰€æœ‰äº‹ä»¶éƒ½ä¼šè§¦å‘çš„å‡½æ•°
- åˆ†åˆ«éå†æ‹¿åˆ°çš„å‡½æ•°é›†åˆï¼Œé€ä¼ æä¾›é€šä¿¡çš„å‚æ•°

> å¦‚æœæ²¡æœ‰æä¾›äº‹ä»¶åï¼Œæˆ–æ²¡æœ‰åŒ¹é…åˆ°ç¬¦åˆè¦æ±‚çš„å‡½æ•°é›†åˆï¼Œå°†è¾“å‡ºè­¦å‘Š

ç¼ºç‚¹ï¼šäº‹ä»¶å¯¹è±¡åªæœ‰ 1 çº§

- ç”±äºå­åº”ç”¨æ˜¯é€šè¿‡ `inject` æ³¨å…¥é“¾ä¸€çº§çº§å¾€ä¸Šæ‰¾ï¼Œæ‰€ä»¥æ— è®ºå±‚çº§ï¼Œæœ€ç»ˆåªä¼šæœ‰ 1 çº§ç›‘å¬å¯¹è±¡
- ä¸è¿‡å¥½åœ¨åº”ç”¨å®ä¾‹ `idToSandboxCacheMap` ä¹Ÿåªæœ‰ 1 çº§ï¼Œå®ä¾‹åä¸èƒ½é‡å¤

å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼š

- é—®é¢˜ 1ï¼šäº‹ä»¶é‡åé€ æˆé”™è¯¯è®¢é˜…ï¼Œä¾‹å¦‚ï¼šä¸åŒçš„åº”ç”¨éƒ½æœ‰åŒåäº‹ä»¶
- é—®é¢˜ 2ï¼šåµŒå¥—è‡ªèº«ä½œä¸ºå­åº”ç”¨ï¼Œäº‹ä»¶è®¢é˜…ä¼šé€ æˆé‡å¤ç›‘å¬

è§£å†³åŠæ³•ï¼š

- é—®é¢˜ 1ï¼šç›‘å¬çš„äº‹ä»¶ååŠ ä¸Šåº”ç”¨åä½œä¸ºå‰ç¼€ï¼Œä½¿å…¶æˆä¸ºå‘½åç©ºé—´ï¼Œå¦‚ï¼š`{project_name}_{event_name}`
- é—®é¢˜ 2ï¼šè¿™æ˜¯ä¸ªæ— è§£çš„é—®é¢˜ï¼Œä½†é€šå¸¸ä¼šç”¨ç¬¬ä¸‰æ–¹è·¯ç”±åšåˆ‡æ¢ï¼Œè€Œä¸æ˜¯è‡ªæˆ‘åµŒå¥—

é™¤æ­¤ä¹‹å¤–è¿˜æä¾›äº† `props`ã€`window` è¿›è¡Œé€šä¿¡ï¼š

- ç”¨äºé¿å… `EventBus`æ‰¿è½½è¿‡å¤šï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/communication.html)]

ä¸åŒçš„é€šä¿¡æ–¹å¼ä¼˜ç¼ºç‚¹ï¼š

| é€šä¿¡æ–¹å¼   | ä¼˜ç‚¹                 | å®šå‘é€šä¿¡     | ç¼ºç‚¹                       |
| ---------- | -------------------- | ------------ | -------------------------- |
| `props`    | ç®€å•ã€é«˜æ•ˆ           | åªèƒ½æŒ‡å®šæ¥æ”¶ | åªèƒ½ä»åŸºåº§å‘åº”ç”¨ä¼ æ•°æ®     |
| `window`   | çµæ´»ã€æ— éœ€é…ç½®       | åŒå‘æŒ‡å®š     | è·¨ç«™é—®é¢˜ï¼Œä¼šæ±¡æŸ“å…¨å±€ä½œç”¨åŸŸ |
| `eventBus` | å¼ºå¤§ï¼Œå¯æŒ‡å®šæ‰§è¡Œæœºåˆ¶ | ä¸å¯ä»¥       | æ•ˆç‡ä¸é«˜                   |

> `eventBus` é‡‡ç”¨å¹¿åŸŸé€šä¿¡çš„æ–¹å¼ï¼Œåªè¦äº‹ä»¶åç›¸åŒå°±ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œå¯ä»¥æŒ‡å®šå‚æ•°æ¥è¿›è¡ŒåŒºåˆ†

#### ğŸ“ ä½œç”¨åŸŸä¸‹çš„æ˜ å°„è¡¨

#### 1. `setFnCacheMap` å­˜å‚¨ç»‘å®šä¸Šä¸‹æ–‡çš„æ–¹æ³•

ç›®å½•ï¼š`utils.ts` - `setFnCacheMap` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/utils.ts#L82)]

ä»¥ä¸‹è¦æ±‚å¿…é¡»å…¨éƒ¨éƒ½æ»¡è¶³ï¼š

- `isCallable`ï¼šå¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•° [[æŸ¥çœ‹](#iscallableåˆ¤æ–­å¯¹è±¡æ˜¯ä¸€ä¸ªå‡½æ•°)]
- `!isBoundedFunction`ï¼šä¸èƒ½é€šè¿‡ `bind` æŒ‡å®šè¿‡ä¸Šä¸‹æ–‡çš„å‡½æ•° [[æŸ¥çœ‹](#isboundedfunctionåˆ¤æ–­é€šè¿‡-functionprototypebind-è¿”å›çš„å‡½æ•°)]
- `!isConstructable`ï¼šä¸èƒ½æ˜¯å¯å®ä¾‹åŒ–çš„å‡½æ•° [[æŸ¥çœ‹](#isconstructableåˆ¤æ–­å‡½æ•°æ˜¯å¦å¯ä»¥å®ä¾‹åŒ–)]

> ç¬¦åˆæ¡ä»¶çš„å‡½æ•°ï¼šç®­å¤´å‡½æ•°ã€æ™®é€šå‡½æ•°

å­˜å‚¨ç±»å‹ä¸º `WeakMap` çš„å¯¹è±¡ï¼š

- é”®åï¼šä»å¯¹è±¡ä¸­æå–çš„åŸå§‹æ–¹æ³•
- é”®å€¼ï¼šé€šè¿‡ `bind` ç»‘å®šä¸Šä¸‹æ–‡çš„æ–¹æ³•

> é€šè¿‡ `bind` ç»‘å®šç®­å¤´å‡½æ•°ä¸Šä¸‹æ–‡æ— æ•ˆï¼Œå‰ªå¤´å‡½æ•°çš„ä¸Šä¸‹æ–‡ä¸ºæ‰€åœ¨ä½œç”¨åŸŸçš„ `this`

ä½¿ç”¨åœºæ™¯ï¼š

- `checkProxyFunction`ï¼šæ·»åŠ æ–¹æ³•åˆ°æ˜ å°„è¡¨
- `getTargetValue`ï¼šä»å¯¹è±¡ä¸­è·å–å±æ€§ [[æŸ¥çœ‹](#gettargetvalue-ä»å¯¹è±¡ä¸­è·å–å±æ€§)]

#### 2. èµ„æºç¼“å­˜é›†åˆ

ç›®å½•ï¼š`entry.ts` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/entry.ts#L39)]

èµ„æºé›†åˆæœ‰ 3 ä¸ªï¼Œå½“ä½¿ç”¨é‡å»ºæ¨¡å¼æ—¶ï¼Œé€šè¿‡èµ„æºç¼“å­˜é›†åˆå¯ä»¥é¿å…é‡å¤è¯·æ±‚èµ„æºã€‚

**`embedHTMLCache`ï¼šç¼“å­˜åº”ç”¨å…¥å£é“¾æ¥èµ„æº**

ç±»å‹ä¸º `Partial<Record<string, Promise<htmlParseResult>>>`ï¼š

- é”®åä¸ºèµ„æºå…¥å£é“¾æ¥
- é”®å€¼ç±»å‹ä¸ºåº”ç”¨é™æ€èµ„æºä¿¡æ¯ï¼Œè§ï¼š`importHTML` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

å¦‚ä½•æ”¶é›†ç¼“å­˜ï¼š

- `importHTML`ï¼šåŠ è½½èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

ä¸ç¼“å­˜çš„æƒ…å†µï¼š

- é€šè¿‡æ’ä»¶é…ç½® `htmlLoader`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#html-loader)]

åº”ç”¨å®ä¾‹ä¸­é€šè¿‡ `template` ç¼“å­˜å…¥å£èµ„æºï¼š

- åº”ç”¨é€šè¿‡ `active` æ¿€æ´»æ—¶å€™è®°å½•èµ„æºï¼Œè§ï¼šåˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]
- ä¸€æ ·éƒ½æ¥è‡ª `importHTML`ï¼Œä¸åŒçš„æ˜¯ `template` çš„èµ„æºå·²é€šè¿‡ `processCssLoader` è¿˜åŸæ ·å¼ [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]

ä¸åŒæ¨¡å¼ä¸‹ç¼“å­˜ä½¿ç”¨ï¼š

| åœºæ™¯                  | `embedHTMLCache`             | `template`           |
| --------------------- | ---------------------------- | -------------------- |
| åˆæ¬¡å¯åŠ¨åº”ç”¨          | `importHTML` æŒ‰æ¡ä»¶è®°å½•      | åº”ç”¨ `active` æ—¶è®°å½• |
| é¢„åŠ è½½&é¢„æ‰§è¡Œ         | `importHTML` æŒ‰æ¡ä»¶è®°å½•      | åº”ç”¨ `active` æ—¶è®°å½• |
| `active` é¢„åŠ è½½åå¯åŠ¨ | å­˜åœ¨åˆ™ä½¿ç”¨ï¼Œä½†ä¸å‚ä¸æ¸²æŸ“     | ä¸ä½¿ç”¨               |
| `active` æ¨¡å¼åˆ‡æ¢     | å®¹å™¨åˆ‡æ¢ï¼Œä¸éœ€è¦ç¼“å­˜         | ä½¿ç”¨ä½†ä¸å‚ä¸æ¸²æŸ“     |
| `umd` æ¨¡å¼åˆ‡æ¢        | ä½¿ç”¨ `template` æ¢å¤ï¼Œä¸éœ€è¦ | ç”¨äºæ¢å¤å®¹å™¨èµ„æº     |
| é‡å»ºæ¨¡å¼åˆ‡æ¢          | å­˜åœ¨åˆ™ä½¿ç”¨                   | é‡æ–°è®°å½•             |

> `alive` é¢„åŠ è½½åèµ„æºå­˜å‚¨åœ¨ `template` ä¸­ï¼Œå¯åŠ¨æ—¶æ¸²æŸ“ï¼›è€Œåˆ‡æ¢åº”ç”¨æ—¶ä»…éœ€æŒ‚è½½å®¹å™¨ï¼Œä¸éœ€è¦ç¼“å­˜

**`styleCache`ï¼šç¼“å­˜å¤–è”æ ·å¼èµ„æº**

ç±»å‹ä¸º `Partial<Record<string, Promise<string>|null>>`ï¼š

- é”®åæ˜¯æå–çš„å¤–è”æ ·å¼ `src`
- å¦‚æœè·å–èµ„æºæˆåŠŸï¼Œé”®å€¼å’Œ `fetchAssets` è¿”å›ç±»å‹ä¸€è‡´ï¼Œå¦åˆ™ä¸º `null` [[æŸ¥çœ‹](#fetchassetsåŠ è½½èµ„æºç¼“å­˜åè¿”å›-promise)]

ä¸ç¼“å­˜çš„æƒ…å†µï¼š

- é…ç½®æ’ä»¶ `cssExcludes` å°†å½»åº•å¿½ç•¥å¤–è”æ ·å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-excludes)]
- é…ç½®æ’ä»¶ `cssIgnores` å°†é€šè¿‡æµè§ˆå™¨åŠ è½½å¤–è”æ ·å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#css-ignores)]

> æ‰€æœ‰ç¬¦åˆè¦æ±‚çš„å¤–è”æ ·å¼ï¼Œä¼šåŠ è½½ä½œä¸ºå†…è”æ ·å¼ç¼“å­˜åˆ° `styleCache`

åŠ è½½ç¬¦åˆè¦æ±‚çš„å¤–è”æ ·å¼ï¼Œå¹¶ç¼“å­˜åŠ è½½ç»“æœï¼ŒåŒ…å«ï¼š

- `processTpl`ï¼šæå–åº”ç”¨å†…é™æ€æ ·å¼ [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- `processCssLoaderForTemplate`ï¼šæ‰‹åŠ¨é…ç½®åº”ç”¨æ ·å¼ [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)]
- `rewriteAppendOrInsertChild`ï¼šåº”ç”¨ä¸­åŠ¨æ€æ·»åŠ æ ·å¼ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

å¦‚ä½•æ”¶é›†ç¼“å­˜ï¼š

- `getExternalStyleSheets` åŒ¹é…æ ·å¼å‘èµ·è¯·æ±‚ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)]
- `fetchAssets` å¤„ç†è¯·æ±‚ï¼Œè®°å½•ç¼“å­˜ [[æŸ¥çœ‹](#fetchassetsåŠ è½½èµ„æºç¼“å­˜åè¿”å›-promise)]

åº”ç”¨å®ä¾‹ä¸­é€šè¿‡ `styleSheetElements` ç¼“å­˜æ ·å¼ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]

å’Œ `styleCache` åŒºåˆ«ï¼š

| åˆ†ç±»     | `styleCache`                                                     | `styleSheetElements`                                                               | `styleSheetElements`                              |
| -------- | ---------------------------------------------------------------- | ---------------------------------------------------------------------------------- | ------------------------------------------------- |
| æ”¶é›†æ–¹æ³• | `getExternalStyleSheets`                                         | `rewriteAppendOrInsertChild`                                                       | `patchCssRules`                                   |
| ç”¨å¤„     | å¤„ç†è¯·æ±‚ï¼Œè®°å½•ç¼“å­˜ [[æŸ¥çœ‹](#getexternalstylesheetsåŠ è½½æ ·å¼èµ„æº)] | åŠ¨æ€æ·»åŠ æ ·å¼ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)] | æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)] |
| ç¼“å­˜ç±»å‹ | é™æ€æ ·å¼                                                         | åŠ¨æ€æ ·å¼                                                                           | æ‰€æœ‰ `:root` å’Œå­—ä½“æ ·å¼                           |

ç¼“å­˜çš„ä½¿ç”¨ï¼š

- `styleCache`ï¼šé€šè¿‡ `processCssLoader` è¿˜åŸå…¥å£èµ„æºæ ·å¼åï¼Œè®°å½•åœ¨å®ä¾‹å±æ€§ `template` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
- `styleSheetElements`ï¼šè®°å½•ä¹‹åé€šè¿‡ `rebuildStyleSheets` æ¢å¤æ ·å¼ [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]

ä¸åŒæ¨¡å¼ä¸‹ç¼“å­˜ä½¿ç”¨ï¼š

| åœºæ™¯                  | `styleCache`                 | `styleSheetElements`                 |
| --------------------- | ---------------------------- | ------------------------------------ |
| åˆæ¬¡å¯åŠ¨åº”ç”¨          | ç¼“å­˜æ‰€æœ‰å¤–è”æ ·å¼             | æ”¶é›†åŠ¨æ€æ ·å¼å’Œè¡¥ä¸ï¼Œä¸å‚ä¸æ¸²æŸ“       |
| é¢„åŠ è½½&é¢„æ‰§è¡Œ         | é¢„åŠ è½½ç¼“å­˜å¤–è”æ ·å¼           | é¢„æ‰§è¡Œæ”¶é›†åŠ¨æ€æ ·å¼ï¼Œæ¯æ¬¡æ¸²æŸ“æ”¶é›†è¡¥ä¸ |
| `active` é¢„åŠ è½½åå¯åŠ¨ | å®¹å™¨åˆ‡æ¢ï¼Œä¸éœ€è¦æ ·å¼ç¼“å­˜     | ä¸ä½¿ç”¨                               |
| `active` æ¨¡å¼åˆ‡æ¢     | å®¹å™¨åˆ‡æ¢ï¼Œä¸éœ€è¦æ ·å¼ç¼“å­˜     | ä¸ä½¿ç”¨                               |
| `umd` æ¨¡å¼åˆ‡æ¢        | ä½¿ç”¨ `template` æ¢å¤ï¼Œä¸éœ€è¦ | ç”¨äºæ¢å¤å®¹å™¨æ ·å¼                     |
| é‡å»ºæ¨¡å¼åˆ‡æ¢          | ä½¿ç”¨ç¼“å­˜çš„å¤–è”æ ·å¼æ›¿æ¢èµ„æº   | é‡æ–°è®°å½•ï¼Œä¸å‚ä¸æ¸²æŸ“                 |

- `styleSheetElements` ä»…é™ `umd` æ¨¡å¼åˆ‡æ¢æ—¶ä½¿ç”¨ï¼Œå…¶å®ƒæƒ…å†µåªä¿ç•™è®°å½•ä¸ä½¿ç”¨
- `styleCache` ç¼“å­˜æ‰€æœ‰å¤–è”æ ·å¼ï¼ŒåŒ…æ‹¬é™æ€æå–ã€åŠ¨æ€åŠæ‰‹åŠ¨æ·»åŠ ï¼Œä¸€æ—¦ç¼“å­˜ä¸‹æ¬¡ç›´æ¥ä»ç¼“å­˜ä¸­è·å–

**`scriptCache`ï¼šç¼“å­˜å¤–è” `script` èµ„æº**

ç±»å‹ä¸º `Partial<Record<string, Promise<string>|null>>`ï¼š

- é”®åæ˜¯æå–çš„å¤–è” `script` çš„ `src`
- å¦‚æœè·å–èµ„æºæˆåŠŸï¼Œé”®å€¼å’Œ `fetchAssets` è¿”å›ç±»å‹ä¸€è‡´ï¼Œå¦åˆ™ä¸º `null` [[æŸ¥çœ‹](#fetchassetsåŠ è½½èµ„æºç¼“å­˜åè¿”å›-promise)]

ä¸ç¼“å­˜çš„æƒ…å†µï¼š

- é…ç½®æ’ä»¶ `jsExcludes` å°†å½»åº•å¿½ç•¥å¤–è” `script`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-excludes)]
- é…ç½®æ’ä»¶ `jsIgnores` å°†é€šè¿‡æµè§ˆå™¨åŠ è½½å¤–è” `script`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-ignores)]

> æ‰€æœ‰ç¬¦åˆè¦æ±‚çš„å¤–è” `script`ï¼Œä¼šåŠ è½½ä½œä¸ºå†…è” `script` ç¼“å­˜åˆ° `scriptCache`

åŠ è½½ç¬¦åˆè¦æ±‚çš„å¤–è” `script`ï¼Œå¹¶ç¼“å­˜åŠ è½½ç»“æœï¼ŒåŒ…å«ï¼š

- `processTpl`ï¼šæå–åº”ç”¨å†…é™æ€ `script` [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
- `start`ï¼šåŠ è½½æ‰‹åŠ¨é…ç½®çš„ `script`ï¼Œæ”¶é›†å¹¶æ‰§è¡Œé˜Ÿåˆ— [[æŸ¥çœ‹](#1-æ”¶é›†é˜Ÿåˆ—)]
- `rewriteAppendOrInsertChild`ï¼šåº”ç”¨ä¸­åŠ¨æ€æ·»åŠ  `script` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]

å¦‚ä½•æ”¶é›†ç¼“å­˜ï¼š

- `getExternalScripts` åŒ¹é… `script` å‘èµ·è¯·æ±‚ [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- `fetchAssets` å¤„ç†è¯·æ±‚ï¼Œè®°å½•ç¼“å­˜ [[æŸ¥çœ‹](#fetchassetsåŠ è½½èµ„æºç¼“å­˜åè¿”å›-promise)]

åº”ç”¨å®ä¾‹ä¸­é€šè¿‡ `execQueue` ä½œä¸ºæ³¨å…¥ `script` é˜Ÿåˆ—ï¼Œä¸åšç¼“å­˜ [[æŸ¥çœ‹](#1-execqueue-åº”ç”¨å¯åŠ¨æ‰§è¡Œé˜Ÿåˆ—)]ï¼š

- `scriptCache`ï¼šç¼“å­˜æ‰€æœ‰å¤–è” `script`
- `execQueue`ï¼šä»…ç”¨äºæ”¶é›† `script`ï¼Œæå–å¹¶æ³¨å…¥æ²™ç®± `iframe`

`scriptCache` å’Œ `execQueue` çš„ä½¿ç”¨éƒ½å–å†³äºåº”ç”¨ä»€ä¹ˆæ—¶å€™ `start` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]ï¼š

| åœºæ™¯                  | `scriptCache`          | `execQueue`        |
| --------------------- | ---------------------- | ------------------ |
| åˆæ¬¡å¯åŠ¨ã€é¢„æ‰§è¡Œ      | ç¼“å­˜æ‰€æœ‰å¤–è” `script`  | æ”¶é›†å¹¶æ‰§è¡Œé˜Ÿåˆ—     |
| é¢„åŠ è½½                | ç¼“å­˜æ‰€æœ‰å¤–è” `script`  | ä¸ä½¿ç”¨             |
| `active` é¢„åŠ è½½åå¯åŠ¨ | å¤–è” `script` ä½¿ç”¨ç¼“å­˜ | æ”¶é›†å¹¶æ‰§è¡Œé˜Ÿåˆ—     |
| é‡å»ºæ¨¡å¼åˆ‡æ¢          | å¤–è” `script` ä½¿ç”¨ç¼“å­˜ | é‡æ–°æ”¶é›†å¹¶æ‰§è¡Œé˜Ÿåˆ— |
| å…¶å®ƒæ¨¡å¼åˆ‡æ¢          | ä¸ä½¿ç”¨                 | ä¸ä½¿ç”¨             |

- `scriptCache`ï¼šä»…é¦–æ¬¡åŠ è½½æ—¶æ”¶é›†å¤–è” `script`ï¼ŒåŒ…æ‹¬é™æ€æå–ã€åŠ¨æ€åŠæ‰‹åŠ¨æ·»åŠ ï¼Œå†æ¬¡åŠ è½½ä½¿ç”¨ç¼“å­˜
- `execQueue`ï¼šé¦–æ¬¡å¯åŠ¨ä¼šæ‰§è¡Œæ”¶é›†æå–é˜Ÿåˆ—ï¼Œå†æ¬¡å¯åŠ¨ä»…é‡å»ºæ¨¡å¼éœ€è¦é‡æ–°æ“ä½œ

> å› ä¸º `execQueue` éšæ²™ç®±ä¸€èµ·ï¼Œåªåœ¨é‡å»ºæ¨¡å¼ä¸‹éšåº”ç”¨åˆ‡æ¢é”€æ¯é‡å»º

`active` é¢„åŠ è½½åå¯åŠ¨ä¼šé€šè¿‡ `importHTML` é‡å¤æå– `getExternalScripts`ï¼š

- åŸå› å’Œè§£å†³åŠæ³•è§ï¼š`importHTML` - 5. ä»ç¼“å­˜ä¸­æå–èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]

#### ğŸ“ `Wujie` å®ä¾‹ä¸­æ˜ å°„è¡¨å’Œé˜Ÿåˆ—

å¸¸è§å±æ€§åˆå§‹å’Œæ³¨é”€çŠ¶æ€è§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

#### 1. `execQueue` åº”ç”¨å¯åŠ¨æ‰§è¡Œé˜Ÿåˆ—

é˜Ÿåˆ—æ”¶é›†æ¥è‡ª 2 ä¸ªåŒºåŸŸï¼š

| æ‰€åœ¨ä½ç½®                                                                                           | ç”¨é€”                                             |
| -------------------------------------------------------------------------------------------------- | ------------------------------------------------ |
| `rewriteAppendOrInsertChild` [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)] | æ”¶é›†åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„å†…è”å’Œå¤–è” `script`ï¼Œå…± 2 å¤„ |
| `start` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]                                                                 | æ”¶é›†é˜Ÿåˆ—æ³¨å…¥æ²™ç®±çš„ `script` ä»¥åŠäº‹ä»¶é€šçŸ¥å…± 7 å¤„  |

> åœ¨å•ä¾‹åº”ç”¨ä¸­é€šå¸¸ä¿ç•™ä¸€ä¸ªé™æ€çš„å…¥å£ `script`ï¼Œæ³¨å…¥æ²™ç®±ååŠ¨æ€åŠ è½½ `chunk script` [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]

**`scriptCache` ç¼“å­˜å¤–è” `script`**

`execQueue` å’Œ `scriptCache` ç”¨é€”ä¸ä¸€æ ·ï¼š

- ä½†æ˜¯ä»–ä»¬è°ƒç”¨åœºæ™¯éƒ½ä¸€æ ·æ¥è‡ª `start` å¯åŠ¨åº”ç”¨ï¼Œè§ï¼šèµ„æºç¼“å­˜é›†åˆ [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]

#### 2. `styleSheetElements` æ”¶é›†æ ·å¼è¡¨

æ”¶é›†åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„æ ·å¼ï¼Œ`:root` ä»¥åŠå­—ä½“æ ·å¼ï¼Œæ”¶é›†çš„æ ·å¼ä»¥å…ƒç´ ç±»å‹å­˜å‚¨åœ¨é›†åˆï¼š

- ç›®çš„ä¸ºäº† `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨æ—¶ï¼Œé€šè¿‡ `rebuildStyleSheets` æ¢å¤æ ·å¼ [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]

**é›†åˆæ”¶é›†æœ‰ 3 å¤„**

æ³¨å…¥èµ„æºåˆ°å®¹å™¨åé€šè¿‡ `patchCssRules` æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]ï¼š

- ä»…æ”¶é›†å®¹å™¨ä¸­æ‰€æœ‰ `:root` å’Œå­—ä½“æ ·å¼

æ”¶é›†çš„æ ·å¼æ¥è‡ª `rewriteAppendOrInsertChild` æ‹¦æˆªåŠ¨æ€æ·»åŠ çš„æ ·å¼ [[æŸ¥çœ‹](#rewriteappendorinsertchildé‡å†™-appendchild-å’Œ-insertbefore)]ï¼š

- `link` å¤–è”æ ·å¼ï¼šä¸‹è½½ååˆ›å»ºå†…è”å…ƒç´ è®°å½•åœ¨é›†åˆä¸­
- `style` å†…è”æ ·å¼ï¼šç›´æ¥è®°å½•åœ¨é›†åˆä¸­

**`styleCache` ç¼“å­˜å¤–è”æ ·å¼**

`styleSheetElements` å’Œ `styleCache` å­˜åœ¨é‡å çš„æƒ…å†µï¼š

- ä½†ä»–ä»¬ç”¨é€”ä¸ä¸€æ ·ï¼Œè°ƒç”¨åœºæ™¯ä¹Ÿä¸ç›¸åŒï¼Œè§ï¼šèµ„æºç¼“å­˜é›†åˆ [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]

#### 3. `elementEventCacheMap` è®°å½•é™çº§å®¹å™¨äº‹ä»¶

- è®°å½•æ–¹æ³•è§ï¼šè®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]
- åŸç†è§ï¼šé™çº§å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#elementeventcachemapé™çº§å®¹å™¨äº‹ä»¶)]

### `wujie` ä¸­è®°å½•çš„äº‹ä»¶

æ€»ç»“è®°å½•äº‹ä»¶çš„ç›®çš„å’Œæ„ä¹‰

#### `shadowRoot.[body|head]._cacheListeners`ï¼šå®¹å™¨äº‹ä»¶

ç›®çš„ï¼š`umd` ä¸‹å¸è½½åº”ç”¨æ—¶æ¸…ç©º `head`ã€`body` ä¸‹çš„äº‹ä»¶

- è®°å½•ï¼š`patchEventListener`ï¼Œè§ï¼š`patchRenderEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]
- æ¸…é™¤ï¼š`removeEventListener`ï¼Œç”±åº”ç”¨ `unmount` æ—¶å€™è§¦å‘ [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]
- æ¡ä»¶ï¼š`shadowRoot` å®¹å™¨ã€`umd` æ¨¡å¼

ä¸ºä»€ä¹ˆè®°å½•æ¸…ç©ºäº‹ä»¶ï¼š

- `renderTemplateToHtml` å°†èµ„æºè½¬æ¢ä¸º `html` æ—¶ï¼Œä¼šå°† `head` å’Œ `body` è®°å½•åœ¨åº”ç”¨å®ä¾‹ [[æŸ¥çœ‹](#rendertemplatetohtmlæ¸²æŸ“-template-ä¸º-html-å…ƒç´ )]
- `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨æ—¶ä¼šè¿˜åŸå®ä¾‹ä¸­çš„ `head` å’Œ `body`ï¼Œå¦‚æœå¸è½½æ—¶ä¸æ¸…ç©ºäº‹ä»¶ä¼šå¯¼è‡´é‡å¤ç›‘å¬

ä¸ºå•¥å…¶å®ƒæ¨¡å¼ä¸éœ€è¦ï¼š

- `alive`æ¨¡å¼ï¼šä¸é”€æ¯èµ„æºã€ä¸è®°å½•äº‹ä»¶ã€å†æ¬¡åˆ‡æ¢åº”ç”¨ä¸é‡æ–°æ³¨å…¥èµ„æºã€ä¹Ÿä¸éœ€è¦ `start`
- é‡å»ºæ¨¡å¼ï¼šæ¯æ¬¡éƒ½é‡å»ºå®¹å™¨ã€é‡å¯åº”ç”¨ï¼Œè™½ä¹Ÿè®°å½•å’Œæ¸…ç†äº‹ä»¶ï¼Œä½†æœ€ç»ˆéƒ½ä¼šé€šè¿‡ `destroy` å½»åº•é”€æ¯

> é™¤äº† `umd` æ¨¡å¼å¤–ï¼Œåªè®°å½•äº‹ä»¶ï¼Œè®°å½•çš„äº‹ä»¶æ¸…ç†éšåŒ `destroy` é”€æ¯åº”ç”¨ä¸€åŒæ¸…ç†

ä¸ºä»€ä¹ˆ `iframe` å®¹å™¨ä¸éœ€è¦è®°å½•å’Œæ¸…é™¤ï¼š

- `degrade` æ¯æ¬¡æ¿€æ´»éƒ½ä¼šé‡å»º `iframe` å®¹å™¨ï¼Œ`iframe` ç§»é™¤åäº‹ä»¶è‡ªåŠ¨é”€æ¯ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰
- ç›¸å `iframe` å®¹å™¨åœ¨ `alive` æ¨¡å¼æˆ– `umd` æ¨¡å¼ä¸‹éœ€è¦è®°å½•å¹¶æ¢å¤äº‹ä»¶ï¼Œå¾€ä¸‹ç»§ç»­çœ‹

ä¸ºä»€ä¹ˆåªè®°å½•å’Œæ¶ˆé™¤ `head` å’Œ `body`ï¼š

- `shadowRoot` åœ¨ `unmount` æ—¶ä¼šæ¸…ç©ºå®¹å™¨ã€å®ä¾‹ `head`ã€å®ä¾‹ `body` ä¸‹æ‰€æœ‰çš„å…ƒç´  [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]

#### `elementEventCacheMap`ï¼šé™çº§å®¹å™¨äº‹ä»¶

å’Œ `shadowRoot.[body|head]._cacheListeners` ç›®çš„æ­£å¥½ç›¸åï¼š

| è®°å½•å¯¹è±¡               | å®¹å™¨         | è®°å½•äº‹ä»¶ç”¨é€”                                       |
| ---------------------- | ------------ | -------------------------------------------------- |
| `_cacheListeners`      | `shadowRoot` | `unmount` æ¸…ç†äº‹ä»¶ï¼Œé¿å… `active` åˆ‡æ¢åº”ç”¨é‡å¤ç›‘å¬ |
| `elementEventCacheMap` | `iframe`     | åˆ‡æ¢åº”ç”¨ `active` æ—¶æ¢å¤è®°å½•ï¼Œä»¥ä¾¿é‡æ–°ç›‘å¬         |

æµç¨‹å‚è€ƒï¼š

- `active` æ¿€æ´»åº”ç”¨ï¼Œè§ï¼š`degrade` ä¸»åŠ¨é™çº§æ¸²æŸ“ [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]

åˆ‡æ¢åº”ç”¨æ¢å¤å®¹å™¨äº‹ä»¶ï¼Œæ˜¯å› ä¸ºï¼š`iframe` ç§»é™¤åäº‹ä»¶è‡ªåŠ¨é”€æ¯ï¼ˆæ¥è‡ªå¤‡æ³¨ï¼‰

- äº‹ä»¶è®°å½•å’Œæ¢å¤ã€é€‚ç”¨æ¨¡å¼ï¼Œè§ï¼šè®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]
- äº‹ä»¶æ¸…é™¤ï¼šæ¯æ¬¡æ¿€æ´»æ—¶å°†ä½¿ç”¨æ–°çš„å®¹å™¨ä»£æ›¿è€çš„çš„å®¹å™¨

> é‡å»ºæ¨¡å¼æ¯æ¬¡å¯åŠ¨åº”ç”¨éƒ½é‡å»ºå®¹å™¨ï¼Œä¸éœ€è¦ç”¨åˆ° `elementEventCacheMap`

ä¸ºä»€ä¹ˆ `shadowRoot` ä¸éœ€è¦è®°å½•å’Œæ¢å¤ï¼š

| æ¨¡å¼    | `iframe` å®¹å™¨                                              | `shadowRoot` å®¹å™¨                                                |
| ------- | ---------------------------------------------------------- | ---------------------------------------------------------------- |
| `alive` | é‡å»ºå®¹å™¨ï¼Œéœ€è¦æ¢å¤æ‰€æœ‰äº‹ä»¶                                 | éœ€è¦å°† `shadowRoot` é‡æ–°æŒ‚è½½åˆ° `el` èŠ‚ç‚¹ï¼Œä¸é‡å»ºä¹Ÿä¸éœ€è¦æ¢å¤äº‹ä»¶ |
| `umd`   | é‡å»ºå®¹å™¨ï¼Œéœ€è¦ä¸º `React 16` åŠä»¥ä¸‹ç‰ˆæœ¬æ¢å¤ `document` äº‹ä»¶ | æ ¹èŠ‚ç‚¹ `shadowRoot` æ²¡å˜ï¼Œä¸éœ€è¦æ¢å¤äº‹ä»¶                         |

#### `__WUJIE_EVENTLISTENER__`ï¼šè½¬å‘ `window` äº‹ä»¶

å­åº”ç”¨ä¸­å¯¹ `window` ä¸Šç›‘å¬çš„äº‹ä»¶ï¼Œéœ€è½¬å‘åˆ°æ²™ç®± `window`ï¼š

- è®°å½•ï¼š`patchIframeEvents` [[æŸ¥çœ‹](#patchiframeevents-åŠ«æŒæ²™ç®±-iframe-çš„-eventlistener)]
- æ¸…é™¤ï¼š`destroy` æ³¨é”€åº”ç”¨å®ä¾‹ [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]
- æ¡ä»¶ï¼šæ‰€æœ‰æ¨¡å¼ã€ä¹Ÿä¸å—æ¸²æŸ“å®¹å™¨é™åˆ¶

åŸå› ï¼š

- åº”ç”¨ä¸­ `script` åŒ…è£¹åœ¨æ¨¡å—ä¸­æ‰§è¡Œï¼Œ`window` æŒ‡å‘ `proxyWindow`ï¼Œè§ï¼š`insertScriptToIframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]
- æ‰§è¡Œäº‹ä»¶å›è°ƒæ—¶ï¼Œéœ€è¦å°†ä¸Šä¸‹æ–‡æŒ‡å‘æ²™ç®± `window`

> å…³äºä»£ç†å…³ç³»ï¼Œè§ï¼š`wujie` ä¸­çš„ä»£ç†çš„å›¾è°± [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

`degrade` é™çº§æ—¶å­åº”ç”¨ `widnow` å°±æ˜¯æ²™ç®± `window`ï¼ŒåŒæ ·ä¹Ÿä¼šè®°å½•äº‹ä»¶å¹¶ä¿®æ­£ä¸Šä¸‹æ–‡ï¼Œå› ä¸ºï¼š

- åŸç”Ÿæ–¹æ³•åªèƒ½é€šè¿‡ `call` æ¥è°ƒç”¨ï¼›
- å­˜åœ¨é€šè¿‡ `options.targetWindow` æŒ‡å®šä¸Šä¸‹æ–‡ [[æŸ¥çœ‹](#patchiframeevents-åŠ«æŒæ²™ç®±-iframe-çš„-eventlistener)]

#### è®°å½•æ²™ç®± `document` ä¸Šçš„äº‹ä»¶

å› ä¸ºæ²™ç®±è¿è¡Œ `script`ï¼Œè€Œæ¸²æŸ“åœ¨å®¹å™¨ï¼ŒåŒæ—¶æœ‰éƒ¨åˆ†äº‹ä»¶éœ€è¦è½¬å‘ç»™åŸºåº§ï¼Œæ‰€ä»¥éœ€è¦è½¬å‘å’Œè®°å½•å…³è”çš„äº‹ä»¶ã€‚

è®°å½•å’Œæ¸…ç†ï¼š

- `patchDocumentEffect`ï¼šé‡å†™è®°å½•å’Œæ¸…ç†æ–¹æ³•ï¼Œä¸æ”¯æŒ `document` é”€æ¯å‰æ‰¹é‡æ¸…ç† [[æŸ¥çœ‹](#patchdocumenteffectä¿®æ­£æ²™ç®±-document-çš„-effect)]

è®°å½•ä¸­åŒ…å« 2 ä¸ª `WeakMap` ç±»å‹å¯¹è±¡ï¼Œé”®åæ˜¯å›è°ƒæ–¹æ³• `handle`ï¼Œé”®å€¼ä¸åŒï¼š

- `handlerCallbackMap`ï¼šå¦‚æœæ˜¯å‡½æ•°é€šè¿‡ `bind` æŒ‡å‘æ²™ç®± `document`ï¼Œå¦åˆ™ç­‰åŒ `handle`
- `handlerTypeMap`ï¼šäº‹ä»¶ç±»å‹é›†åˆï¼Œå¦‚ï¼š`click` å’Œ `mouseup` å›è°ƒç›¸åŒï¼Œåˆ™ä¸º `['click', 'mouseup']`

> `handle` çš„ç±»å‹å¯ä»¥æ˜¯å‡½æ•°ã€ä¹Ÿå¯ä»¥æ˜¯åŒ…å« `handleEvent` æ–¹æ³•çš„å¯¹è±¡

å¦‚ä½•æ¸…ç†ï¼š

- æ¥è‡ªæ¡†æ¶è‡ªåŠ¨æ¸…ç†ï¼Œå¦‚ï¼š`React 16` ä¼šè‡ªåŠ¨åœ¨ `document` æŒ‚è½½ã€æ¸…ç†åˆæˆäº‹ä»¶
- æ‰‹åŠ¨æ¸…ç†è‡ªå®šä¹‰åœ¨ `document` ä¸Šçš„ç›‘å¬äº‹ä»¶

> å¦‚æœæ²¡æœ‰æ¸…ç†æ‰‹åŠ¨ç›‘å¬åœ¨ `document` ä¸Šçš„äº‹ä»¶ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æ³„éœ²

æ— è®ºæ˜¯è‡ªåŠ¨æ¸…ç†è¿˜æ˜¯æ‰‹åŠ¨æ¸…ç†ï¼Œ`handlerTypeMap` å­˜åœ¨çš„æ„ä¹‰å°±æ²¡é‚£ä¹ˆå¿…è¦äº†ï¼š

- æ¯•ç«Ÿæ‰€æœ‰çš„æ¸…ç†æ–¹æ³•éƒ½ä¸æ˜¯æ¥è‡ªäº‹ä»¶è®°å½•çš„å¯¹è±¡

`handlerCallbackMap` å­˜åœ¨çš„æ„ä¹‰ï¼š

- è®°å½•å·²ä¿®æ­£çš„å›è°ƒå¯¹è±¡ `handle`ï¼Œä½¿ç”¨ç›¸åŒçš„å›è°ƒå‡½æ•°ï¼Œä¸ç”¨é‡å¤åˆ¤æ–­æ˜¯å¦è¦ä¿®æ­£ä¸Šä¸‹æ–‡

### å¼•å…¥ `wujie` åŒ…æ—¶é»˜è®¤å°±æ‰§è¡Œ

å…¨éƒ¨åœ¨ `wujie` å…¥å£æ–‡ä»¶ `index.ts` ä¸­ï¼Œå½“å¼•å…¥ `wujie` å³ä¼šç«‹å³æ‰§è¡Œï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts)]

#### `EventBus`

æä¾›ç»™åŸºåº§ä¸å­åº”ç”¨é€šä¿¡ï¼Œå¯¼å‡ºå¯¹è±¡ä¸º `bus`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/bus.html)]

#### `stopMainAppRun`

ç»ˆæ­¢ä»£ç è¿è¡Œï¼Œå‰ææ¡ä»¶ï¼š

- `window.__WUJIE`ï¼šè¯´æ˜ä¸ºå­åº”ç”¨ï¼Œåœ¨æ²™ç®± `iframe` åˆå§‹åŒ–æ—¶é€šè¿‡ `patchIframeVariable` è®¾ç½® [[æŸ¥çœ‹](#patchiframevariable-ä¸ºå­åº”ç”¨-window-æ·»åŠ å±æ€§)]
- `!window.__POWERED_BY_WUJIE__`ï¼šè¯´æ˜æ­¤æ—¶æ²¡æœ‰é€šè¿‡ `start` å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]

> æ¡ä»¶ç¬¦åˆçš„æƒ…å†µä¸‹ `stopMainAppRun` ä¼šè¾“å‡ºè­¦å‘Šï¼ŒæŠ›å‡ºå¼‚å¸¸

é€šå¸¸æƒ…å†µä¸‹å­åº”ç”¨æ˜¯ä¸ä¼šæ£€æµ‹å…¨å±€å˜é‡çš„ï¼š

- åªæœ‰å½“å­åº”ç”¨æ˜¯åŸºåº§çš„æ—¶å€™æ‰ä¼šä¸»åŠ¨æ£€æµ‹

`start` å¯åŠ¨åº”ç”¨æ³¨å…¥ `script` å‰ä¸€å®šä¼šå…ˆæ›´æ–°æ²™ç®±å…¨å±€å˜é‡ `__POWERED_BY_WUJIE__`ï¼š

- æ›´æ–°åå†æ³¨å…¥ `script`ï¼ŒåŒ…æ‹¬ï¼šåº”ç”¨å…¥å£ `script` æ³¨å…¥ï¼Œåˆ°åŠ¨æ€åŠ è½½ `script`ï¼Œåˆ°å‘èµ·æ£€æµ‹
- æ­£å¸¸å¯åŠ¨ä¸‹ï¼Œæ²™ç®±ä¸­ `__WUJIE` ä¸€å®šæ˜¯å­˜åœ¨çš„ä¸” `__POWERED_BY_WUJIE__` ä¸€å®šæ˜¯ `true`

å‡è®¾ä¸¢å¤±äº† `__POWERED_BY_WUJIE__`ï¼Œå¹¶ä¸”åŠ è½½è¿‡ç¨‹æ²¡æœ‰æ•è·é”™è¯¯ï¼š

- æŠ›å‡ºçš„å¼‚å¸¸ä¼šç›´è‡³æ•´ä¸ªåº”ç”¨æœ€é¡¶å±‚ï¼Œå¯¼è‡´åŸºåº§å¼‚å¸¸

#### `processAppForHrefJump` ç›‘å¬å‰è¿›å’Œåç«¯

æ•´ä¸ªæµç¨‹å›´ç»• 3 ç‚¹å±•å¼€ï¼š

**1. ä» `window` ç›‘å¬ `popstate`**

è¿™å°±æ„å‘³ç€ç›‘å¬çš„å¯¹è±¡æ¥è‡ªåŸºåº§ï¼š

- å¯ä»¥æ˜¯æœ€é¡¶å±‚çš„åŸºåº§ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½œä¸ºå­åº”ç”¨çš„åŸºåº§ï¼Œä½†ä¸€å®šä¸æ˜¯æ²™ç®± `iframe`
- æ¢ä¸ªè¯´æ³•ï¼Œå½“æ›´æ–°æ²™ç®± `history` åï¼Œå‰è¿›åé€€æ˜¯ä¸ä¼šç”± `processAppForHrefJump` å‘èµ·äº‹ä»¶ç›‘å¬

è¡¨æ ¼ä¸­æ‰€åœ¨ `window` åˆ—ä¸­ï¼Œå°†ç”± `processAppForHrefJump` è´Ÿè´£ç›‘å¬äº‹ä»¶ï¼š

| æ–¹æ³•                                                                          | ç”¨é€”                                                                                   | `window`       | æ²™ç®± `iframe`               |
| ----------------------------------------------------------------------------- | -------------------------------------------------------------------------------------- | -------------- | --------------------------- |
| `patchIframeHistory` [[æŸ¥çœ‹](#patchiframehistory-åŠ«æŒæ²™ç®±-iframe-çš„-history)] | é‡å†™åº”ç”¨ä¸­è·¯ç”±è·³è½¬ã€åŒæ­¥è·¯ç”±åˆ°åŸºåº§                                                     | `replaceState` | `pushState`ã€`replaceState` |
| `syncIframeUrlToWindow` [[æŸ¥çœ‹](#synciframeurltowindow-ç›‘å¬æ²™ç®±å‰è¿›åé€€)]     | é€šè¿‡ `syncUrlToWindow` åŒæ­¥è·¯ç”±åˆ°åŸºåº§ [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)] | `replaceState` | æ—                           |
| `locationHrefSet` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]           | é€šè¿‡ `pushUrlToWindow` åŒæ­¥è·¯ç”±åˆ°åŸºåº§ [[æŸ¥çœ‹](#pushurltowindowæ¨é€-url-åˆ°åŸºåº§è·¯ç”±)]    | `pushState`    | æ—                           |
| `constructor` [[æŸ¥çœ‹](#3-åˆ›å»ºæ²™ç®±-iframe)]                                    | é€šè¿‡ `iframeGenerator` æ›´æ–°æ²™ç®± `history` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]    | æ—              | `replaceState`              |
| `active` [[æŸ¥çœ‹](#3-åŒæ­¥è·¯ç”±)]                                                | é€šè¿‡ `syncUrlToIframe` åŒæ­¥è·¯ç”±åˆ°åº”ç”¨ [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)] | æ—              | `replaceState`              |
| `active` [[æŸ¥çœ‹](#3-åŒæ­¥è·¯ç”±)]                                                | é€šè¿‡ `syncUrlToWindow` åŒæ­¥è·¯ç”±åˆ°åŸºåº§ [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)] | `replaceState` | æ—                           |
| `unmount` [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]                                        | é€šè¿‡ `clearInactiveAppUrl` è¿˜åŸåŸºåº§è·¯ç”± [[æŸ¥çœ‹](#clearinactiveappurlæ¸…ç†è·¯ç”±)]         | `replaceState` | æ—                           |

å¦‚æœåŸºåº§æ˜¯å­åº”ç”¨ï¼Œæœ¬èº«å°±åœ¨æ²™ç®±ä¸­ï¼Œå‰è¿›åé€€çœ‹ `state` å¯¹è±¡æ¥è‡ªå“ªé‡Œï¼š

- å¦‚æœæ¥è‡ªåŸºåº§ä¸‹çš„æ²™ç®± ` history`ï¼Œé‚£ä¹ˆä¸ä¼šé€šè¿‡ `processAppForHrefJump` å‘èµ·ç›‘å¬ `popstate`
- ä½†åº”ç”¨å†…çš„è·¯ç”±æ›´æ–°ä¼šé€šè¿‡ `syncIframeUrlToWindow` åŒæ­¥åŸºåº§è·¯ç”± [[æŸ¥çœ‹](#synciframeurltowindow-ç›‘å¬æ²™ç®±å‰è¿›åé€€)]

> å¯ä»¥æŸ¥çœ‹ä¸Šè¿°è¡¨æ ¼ä¸­æ²™ç®± `iframe` é‚£ä¸€åˆ—ï¼Œå…¨éƒ¨æ¥è‡ªæ²™ç®± `history`

**2. åªå¤„ç†åº”ç”¨å†…çš„è·¯ç”±å‰è¿›å’Œåé€€**

å³ `search` ä¸­åº”ç”¨åä¿æŒä¸å˜ï¼Œä¾‹å¦‚å½“å‰è·¯ç”±ï¼š`?react=/%7B%2F%7D`

| å˜æ›´è·¯ç”±                        | åˆ†ç±»             | åŸå›                     |
| ------------------------------- | ---------------- | ----------------------- |
| `?react=%7B%2Fabout%7D`         | åº”ç”¨å†…è·¯ç”±       | åº”ç”¨å `react` æ²¡æœ‰å˜åŒ– |
| `?react=https%3A%2F%2Ftest.com` | åº”ç”¨å†…çš„åŠ«æŒè·¯ç”± | åº”ç”¨å `react` æ²¡æœ‰å˜åŒ– |
| `?vue=/%7B%2F%7D`               | åº”ç”¨å¤–çš„è·¯ç”±     | åº”ç”¨åä¸å†æ˜¯ `react`    |

> éœ€è¦è¯´æ˜çš„æ˜¯ `processAppForHrefJump` åªå¤„ç†åº”ç”¨å†…åŠ«æŒè·¯ç”±ï¼ŒåŸå› å¾€ä¸‹çœ‹ç¬¬ 3 ç‚¹

æ¯”å¦‚ï¼šåº”ç”¨æ˜¯ `react` ä»¥åŠ«æŒå®¹å™¨æ¸²æŸ“ï¼Œå½“ç‚¹å‡»åŸºåº§é“¾æ¥åˆ‡å‡ºåº”ç”¨åï¼Œæ‰§è¡Œåé€€æ“ä½œ

- ä¸ä¼šå›é€€åˆ°ä¸Šä¸€ä¸ªåŠ«æŒå®¹å™¨é¡µï¼Œè€Œæ˜¯ä¸Šä¸€ä¸ªåº”ç”¨çš„å…¥å£é¡µï¼Œåœ¨ä½¿ç”¨ä¸Šä¼šæœ‰å‰²è£‚æ„Ÿ

> é‚£è¿™éš¾é“ç®—ä¸ç®— `bug` å—ï¼Ÿ

åŸå› ï¼š

- æ‰§è¡Œåé€€æ“ä½œï¼Œè§¦å‘ `popstate` æ£€æµ‹åé€€çš„è·¯ç”±æ˜¯ `http` å¼€å¤´
- æ‰§è¡Œ `renderIframeReplaceApp` åŠ è½½ `iframe` æ›¿æ¢å­åº”ç”¨ [[æŸ¥çœ‹](#renderiframereplaceappåŠ è½½-iframe-æ›¿æ¢å­åº”ç”¨)]
- å› æä¾›çš„ç¬¬ 2 ä¸ªå‚æ•°æŒ‚è½½èŠ‚ç‚¹ä¸º `null`ï¼Œå¯¼è‡´æ•´ä¸ªåº”ç”¨ç©ºç™½

ä¸ºä»€ä¹ˆæŒ‚è½½èŠ‚ç‚¹æ˜¯ `null`

- å½“åˆ‡å‡ºåº”ç”¨æ—¶æ”¹å˜äº†è·¯ç”±ï¼Œå¯¼è‡´åŸºåº§ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼ŒåŸå…ˆçš„æŒ‚è½½ç‚¹é”€æ¯

æœ€ç»ˆå¦‚ä½•ä»ç©ºç™½é¡µå˜ä¸ºåº”ç”¨å…¥å£é¡µé¢çš„ï¼š

- å½“è·¯ç”±åˆ‡æ¢å›åº”ç”¨æ—¶ï¼Œå†æ¬¡é‡æ–°æ¸²æŸ“ç»„ä»¶ï¼ŒæŒ‰ç…§é…ç½®é‡æ–°åŠ è½½åº”ç”¨

åº”ç”¨å†…çš„è·¯ç”±å˜æ›´ä¸ä¹Ÿä¼šé‡æ–°æ¸²æŸ“ç»„ä»¶å—ï¼Ÿ

- æ˜¯çš„ï¼Œä¼šæŒ‰ç…§åº”ç”¨åå’Œè·¯ç”±é‡æ–°å¯åŠ¨ä¸€éï¼Œæ¡ä»¶ä¸€è‡´çš„æƒ…å†µä¸‹è§†è§‰ä¸Šæ²¡æœ‰å˜åŒ–
- åŠ«æŒå®¹å™¨ä¸èƒ½è¿˜åŸä» `syncUrlToIframe` åŒæ­¥è·¯ç”±åˆ°åº”ç”¨çš„æºç ä¸­ä¹Ÿèƒ½çœ‹å‡ºæ¥ [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]

```
  // æ’é™¤hrefè·³è½¬æƒ…å†µ
  const syncUrl = (/^http/.test(idUrl) ? null : idUrl) || url;
```

è¢«å¼€å‘äººå‘˜æ’é™¤äº†ï¼Œä½¿ç”¨å…¥å£ `url` ä½œä¸ºäº† `history`ï¼š

- è¿™ç‚¹ä¼¼ä¹ä¹Ÿåˆç†ï¼Œå› ä¸ºåŠ«æŒå®¹å™¨é™¤äº†å‰è¿›åé€€æ˜¯æ— æ³•è¿˜åŸåº”ç”¨æœ¬èº«çš„å®¹å™¨
- å½“é€šè¿‡åé€€è¿˜åŸåŠ«æŒå®¹å™¨ï¼Œä¸æ˜æ‰€ä»¥çš„äººå¯èƒ½éƒ½ä¸çŸ¥é“æ€ä¹ˆè¿”å›æœ€åˆçš„é¡µé¢

åº”ç”¨å†…è·¯ç”±å˜åŒ–æ—¶ä¹Ÿä¼šå› ç»„ä»¶é‡æ–°æ¸²æŸ“é”€æ¯æŒ‚è½½èŠ‚ç‚¹ï¼š

- ä½†å¯åŠ¨åº”ç”¨æ—¶ä¼šå°†æ–°çš„æŒ‚è½½èŠ‚ç‚¹é€šè¿‡é…ç½®ä¼ è¿‡å»
- è€Œ `processAppForHrefJump` åœ¨æ¢å¤åŠ«æŒå®¹å™¨æ—¶ä½¿ç”¨çš„æŒ‚è½½èŠ‚ç‚¹åœ¨åˆ‡å‡ºåº”ç”¨æ—¶å·²é”€æ¯

å¦‚æœä½¿ç”¨é `React` è¿™æ ·å•ä¾‹åº”ç”¨ï¼Œè·¯ç”±å˜æ›´ä¸åˆ·æ–°ç»„ä»¶æ˜¯ä¸æ˜¯èƒ½é¿å…è¿™ä¸ªé—®é¢˜ï¼Ÿ

- æ˜¯ä¸ªå¥½æƒ³æ³•ï¼Œä½†è¿™æ ·ä¼šäº§ç”Ÿæ–°çš„é—®é¢˜ï¼Œæ¯”å¦‚è·¯ç”±æ›´æ–°åå­åº”ç”¨æ²¡ååº”

**3. åªå¤„ç†åº”ç”¨å†…åŠ«æŒè·¯ç”±å‰è¿›å’Œåé€€**

ä»ä¸Šè¯‰æ€»ç»“å¯ä»¥æ’é™¤ä»¥ä¸‹ `popstate` å˜æ›´çš„æƒ…å†µï¼š

- æ¥è‡ªæ²™ç®± `iframe` è·¯ç”±å˜æ›´ä¸è§¦å‘å½“å‰æ“ä½œï¼Œè§ä¸Šè¿°è¡¨æ ¼ `iframe` åˆ—
- æ¥è‡ªåº”ç”¨å¤–çš„è·¯ç”±å˜æ›´è§¦å‘äº‹ä»¶ï¼Œä½†è¿˜åŸå®¹å™¨æ— æ•ˆï¼Œæœ€ç»ˆç”±ç»„ä»¶é‡æ–°æ¸²æŸ“é‡å¯åº”ç”¨
- æ¥è‡ªåº”ç”¨å†…çš„è·¯ç”±å˜æ›´è§¦å‘äº‹ä»¶ï¼Œä½†ä¸åœ¨å½“å‰æ“ä½œèŒƒå›´ï¼Œä¸‹é¢å°†å±•å¼€è¯´æ˜

ä»¥ä¸‹æè¿°å°†é»˜è®¤ä»¥ï¼š`history` ä¸­åŒ…å«åŠ«æŒè·¯ç”±ï¼Œåœ¨åº”ç”¨å†…æ‰§è¡Œå‰è¿›å’Œåé€€æ“ä½œ

- å…³äºåŠ«æŒå®¹å™¨è¯¦ç»†è¯´æ˜è§ï¼š`locationHrefSet` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

å‰è¿›æˆ–åé€€æ—¶åšäº†ä»€ä¹ˆï¼š

- é€šè¿‡å½“å‰çš„ `url` è·å– `queryMap`ï¼Œè§ï¼š`getAnchorElementQueryMap` [[æŸ¥çœ‹](#getanchorelementquerymap-è½¬åŒ–-urlsearch-ä¸ºé”®å€¼å¯¹è±¡)]
- é€šè¿‡ `queryMap` ç­›é€‰è·å–åº”ç”¨å®ä¾‹é›†åˆï¼Œéå†é›†åˆæ ¹æ®å‰è¿›æˆ–åé€€é‡æ–°æ¸²æŸ“å®¹å™¨

2 ä¸ªæƒ…å†µï¼š

| ç›‘å¬ | åˆ¤æ–­ä¾æ®   | åˆ¤å®šä¸ºåŠ«æŒå®¹å™¨           | å¦åˆ™åº”ç”¨å†…è·¯ç”±ä¸æ“ä½œ |
| ---- | ---------- | ------------------------ | -------------------- |
| å‰è¿› | `queryMap` | æ‰¾åˆ°å¼€å¤´ä¸º `http` çš„é“¾æ¥ | æ‰¾åˆ°çš„æ˜¯éé“¾æ¥çš„è·¯ç”± |
| åé€€ | `herfFlag` | `true`                   | `false`              |

åº”ç”¨å†…è·¯ç”±è·³è½¬æµç¨‹ï¼š

| åº”ç”¨å…¥å£é¡µ         | åº”ç”¨å†…è·¯ç”±                         | `http` å¼€å¤´çš„åŠ«æŒè·¯ç”±     |
| ------------------ | ---------------------------------- | ------------------------- |
| å‰è¿›åé€€éƒ½ä¸åšå¤„ç† | --                                 | --                        |
| --                 | â­• åé€€ä¸å¤„ç†ï¼Œå‰è¿›æ›¿æ¢åŠ«æŒå®¹å™¨ â–¶ï¸ | --                        |
| --                 | --                                 | â—€ï¸ åªèƒ½åé€€ï¼Œè¿˜åŸæ¸²æŸ“å®¹å™¨ |

- åŠ«æŒå®¹å™¨æ˜¯ `iframe` ç½‘é¡µï¼Œå†…éƒ¨çš„é“¾æ¥å°†ä¸å†è¢«åŠ«æŒè®°å½• `history`ï¼Œå› æ­¤åªèƒ½åé€€
- è€Œé€šè¿‡åŸºåº§é“¾æ¥åˆ‡æ¢åˆ°å…¶å®ƒåº”ç”¨ï¼Œåé€€å°†æ— æ³•è¿˜åŸåŠ«æŒå®¹å™¨ï¼ŒåŸå› åœ¨ä¸Šè¿°ç¬¬ 2 ç‚¹å·²è¯´æ˜

å¦‚ä½•åˆ¤æ–­æ‰§è¡Œçš„æ˜¯å‰è¿›è¿˜æ˜¯åé€€ï¼š

- å‰è¿›ï¼šæ‰§è¡Œåå½“å‰è·¯ç”±ä¸º `http` å¼€å¤´ï¼Œè€Œ `popstate` åˆ°åŠ«æŒå®¹å™¨åªèƒ½å‰è¿›
- åé€€ï¼š`hrefFlag`ï¼Œåªæœ‰åœ¨åŠ«æŒå®¹å™¨çš„æƒ…å†µä¸‹ä¸º `true`ï¼Œè€ŒåŠ«æŒå®¹å™¨åªèƒ½åé€€

> å…³äº `hrefFlag` è§ï¼šç‰¹æ®Šå±æ€§ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)]

ä¸åœ¨å¤„ç†èŒƒå›´çš„æƒ…å†µä¸‹ `history` å˜æ›´ï¼Œå°†å¯¼è‡´åŸºåº§ä¸‹åŠ è½½åº”ç”¨çš„ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼š

- ç”±äºé…ç½®ä¿¡æ¯æ²¡æœ‰å˜åŒ–ï¼Œè§†è§‰ä¸Šåªçœ‹åˆ°åº”ç”¨å†…éƒ¨å› è·¯ç”±æ›´æ–°åˆ‡æ¢é¡µé¢

> é‡å»ºæ¨¡å¼ä¼šå› è·¯ç”±å˜æ›´é‡æ–°æ¸²æŸ“åº”ç”¨ï¼Œå¦‚æœå› æ­¤çœ‹åˆ°é—ªå±ï¼Œå»ºè®®ä½¿ç”¨ `alive` æˆ– `umd` æ¨¡å¼

å‰è¿›æ—¶åŒ¹é…åˆ°é“¾æ¥ä¸ºåŠ«æŒçš„ `http` æ€ä¹ˆåšï¼š

| åˆ†ç±»                                                                                                              | `iframe` å®¹å™¨ | `shadowRoot` å®¹å™¨ |
| ----------------------------------------------------------------------------------------------------------------- | ------------- | ----------------- |
| `renderElementToContainer` å°†å®¹å™¨ä¸­ `html` å…ƒç´ æ·»åŠ åˆ°æ²™ç®± [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)] | æ‰§è¡Œ          | ä¸æ‰§è¡Œ            |
| `renderIframeReplaceApp` åˆ›å»º `iframe` ä»£æ›¿å½“å‰å®¹å™¨ [[æŸ¥çœ‹](#renderiframereplaceappåŠ è½½-iframe-æ›¿æ¢å­åº”ç”¨)]       | æ‰§è¡Œ          | æ‰§è¡Œ              |
| æ ‡è®° `hrefFlag` ä»¥ä¾¿åé€€æ—¶èƒ½å¤Ÿè¿”å›åº”ç”¨                                                                            | æ‰§è¡Œ          | æ‰§è¡Œ              |

`shadowRoot` ç»‘å®šåœ¨åº”ç”¨å®ä¾‹ä¸­ï¼Œ`iframe` å®¹å™¨åªæœ‰ `document` ç»‘å®šåˆ°å®ä¾‹ä¸­

- ä¸€æ—¦å®¹å™¨è¢«é”€æ¯ï¼Œ`iframe` å®¹å™¨éœ€è¦é€šè¿‡è¿˜åŸ `html` å…ƒç´ æ¢å¤å®¹å™¨
- å› æ­¤å…ˆå°† `iframe` å®¹å™¨ä¸‹çš„ `html` å…ƒç´ è½¬ç§»åˆ°æ²™ç®± `body` ä¸­

> åœ¨æ²™ç®± `body` ä¸­é™¤äº†ä½œä¸ºå®¹å™¨ `html` å…ƒç´ ä¸´æ—¶å­˜æ”¾ç‚¹ä»¥å¤–ï¼Œå…¶ä½™æƒ…å†µéƒ½æ˜¯ç©ºçš„

å¦‚æœæ˜¯ä»åº”ç”¨å¤–éƒ¨åé€€ï¼Œæ˜¯æ— æ³•è¿”å›åˆ°åŠ«æŒå®¹å™¨ï¼š

- å› ä¸ºåˆ‡å‡ºåº”ç”¨æ—¶ä¹‹å‰æä¾›å®¹å™¨çš„æŒ‚è½½ç‚¹å·²é”€æ¯ï¼Œæ— æ³•ç»§ç»­æŒ‚è½½ï¼Œå°†ä¼šåˆ‡æ¢åˆ°åº”ç”¨å…¥å£é¡µ

åé€€æ—¶ `hrefFlag` å­˜åœ¨ï¼Œ`shadowRoot` å®¹å™¨æ€ä¹ˆåšï¼š

- é€šè¿‡ `renderElementToContainer` å°† `shadowRoot` é‡æ–°æ›¿æ¢æŒ‚è½½åˆ°èŠ‚ç‚¹ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]

åé€€æ—¶ `hrefFlag` å­˜åœ¨ï¼Œ`iframe` å®¹å™¨å’Œé™çº§æ¸²æŸ“æ—¶æ“ä½œä¸€æ · [[æŸ¥çœ‹](#41-degrade-ä¸»åŠ¨é™çº§æ¸²æŸ“)]ï¼š

- é€šè¿‡ `initRenderIframeAndContainer` åˆ›å»º `iframe` æ²™ç®±å¹¶æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]
- é€šè¿‡ `patchEventTimeStamp` ä¿®å¤ `vue` çš„ `event.timeStamp` é—®é¢˜
- ç»‘å®š `onunload` åˆ° `iframe` å®¹å™¨ä¸Šç”¨äºé”€æ¯æ—¶ä¸»åŠ¨ `unmount` åº”ç”¨
- å°†ä¹‹å‰è¿ç§»åˆ°æ²™ç®± `body` ä¸­çš„ `html` å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ `document` ä¸‹
- å°†å®¹å™¨ `document` ç»‘å®šåœ¨åº”ç”¨å®ä¾‹çš„ `document` ä¸Š

é—®é¢˜ï¼š

- å› ä¸º `locationHrefSet` å­˜åœ¨ `bug`ï¼Œ`degrade` æ¨¡å¼ä¸‹ä¸èƒ½åŠ«æŒ `location.href` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

#### `defineWujieWebComponent` å®šä¹‰è‡ªå®šä¹‰ç»„ä»¶

- å½“å¼•å…¥ `wujie` çš„æ—¶å€™é€šè¿‡ `defineWujieWebComponent` ç¡®ä¿å·²å®šä¹‰äº† `web component` äº†
- è€Œåœ¨ `active` ä¸­é€šè¿‡ `createWujieWebComponent` ä¼šè‡ªåŠ¨åˆ›å»ºç»„ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨å¼•å…¥ [[æŸ¥çœ‹](#42-æŒ‚è½½å­åº”ç”¨åˆ‡æ¢åˆå§‹åŒ–é¢„åŠ è½½)]

> åœ¨ `wujie` ä¸­åªèƒ½é€šè¿‡ `active` è‡ªåŠ¨åˆ›å»º `web component`ï¼Œä¸æ”¯æŒæ‰‹åŠ¨æ·»åŠ  `wujie-app` åˆ° `Dom tree`

#### å…¶å®ƒé»˜è®¤æä¾›çš„æ–¹æ³•

- `setupApp`ï¼šç¼“å­˜é…ç½®ï¼Œæä¾›å¯¹å¤–æ¥å£é»˜è®¤ä¸æ‰§è¡Œï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]
- `destroyApp`ï¼šæ³¨é”€åº”ç”¨ï¼Œå¯¹å¤–æä¾›çš„åŒ…è£…æ–¹æ³•ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/destroyApp.html)]

é™¤æ­¤ä¹‹å¤–ä¼šé»˜è®¤æ‰§è¡Œ `wujieSupport` è¿›è¡Œæ£€æµ‹ï¼š

- æµè§ˆå™¨ä¸æ”¯æŒ `Proxy` æˆ– `CustomElementRegistry` è¾“å‡ºè­¦å‘Šï¼Œæ­¤æ—¶é‡‡ç”¨ `degrade` æ¨¡å¼

### `packages` - `wujie-react`

`WujieReact` æ˜¯å®˜æ–¹æä¾›çš„å°è£…ç»„ä»¶ï¼Œå’ŒåŸºåº§æ¼”ç¤ºçš„è‡ªå®šä¹‰ç»„ä»¶æ˜¯ä¸€æ ·çš„ï¼Œè§ï¼šè‡ªå®šä¹‰ç»„ä»¶ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/components/Wujie.tsx)]

- å®˜æ–¹åªæä¾›äº† 1 ä¸ªç»„ä»¶ï¼Œç”¨äºå¯åŠ¨å­åº”ç”¨ï¼Œè§ï¼š`index.js` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-react/index.js)]

**1. å±æ€§**

é™æ€å±æ€§ï¼š

- `propTypes`ï¼šå®šä¹‰ç»„ä»¶çš„å±æ€§ç±»å‹ï¼Œç”¨äºç±»å‹æ£€æŸ¥ã€‚
- `bus`ï¼Œ`setupApp`ï¼Œ`preloadApp`ï¼Œ`destroyApp`ï¼šå¼•å…¥æ–¹æ³•å’Œå¯¹è±¡ï¼Œåˆ†åˆ«ç”¨äºåº”ç”¨é€šä¿¡ã€é¢„åŠ è½½å’Œæ³¨é”€

> å¤–éƒ¨å¯ä»¥ç›´æ¥é€šè¿‡ `WujieReact` è¿™ä¸ªç±»è·å–é™æ€å±æ€§

çŠ¶æ€å’Œå¼•ç”¨ï¼š

- `state`ï¼šå®šä¹‰ `myRef` é€šè¿‡ `ref` çš„æ–¹å¼å¼•å…¥ `div` æŒ‚è½½èŠ‚ç‚¹
- `destroy` ç»‘å®š `startApp` å¯åŠ¨åº”ç”¨åè¿”å›çš„æ³¨é”€æ–¹æ³•

`destroy` å®šä¹‰äº†ä½†æ²¡æœ‰ä½¿ç”¨ï¼Œå¦‚æœè‡ªè¡Œæ‰©å±•çš„è¯å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š

```
// ç»„ä»¶å¸è½½æ—¶é”€æ¯åº”ç”¨
componentWillUnmount() {
  this.destroy();
}

// ä¹Ÿå¯ä»¥åœ¨éœ€è¦é‡æ–°å¯åŠ¨åº”ç”¨æ—¶è°ƒç”¨ `destroy`ï¼Œä¾‹å¦‚åœ¨ `props` å˜æ›´æ—¶
componentDidUpdate(prevProps) {
  if(needRestart) {
    this.destroy();
    this.startApp();
  }
}
```

> ä½†æ–‡æ¡£ä¸­å¹¶ä¸å»ºè®®æ‰‹åŠ¨æ³¨é”€åº”ç”¨ï¼Œå¦‚æœåç»­è¿˜éœ€è¦ä½¿ç”¨çš„è¯ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]

æ­¤å¤–è¿˜å®šä¹‰äº† `startAppQueue`ï¼Œç”¨äºå‘èµ·å¾®ä»»åŠ¡ä½†æ²¡æœ‰ä½¿ç”¨ï¼Œè‹¥è¦ä½¿ç”¨å¯ä»¥è¿™æ ·ä¿®æ”¹ï¼š

```
startApp = async (props) => {
  try {
    const { current: el } = this.state.myRef;
    this.destroy = await startApp({
      ...props,
      el,
    });
  } catch (error) {
    console.log(error);
  }
}

componentDidMount () {
  const list = this.props;
  list.forEach(props => {
    this.startAppQueue = this.startAppQueue.then(() => this.startApp(props))
  });
}
```

**2. æ–¹æ³•**

å¼‚æ­¥æ–¹æ³• `startApp` ç”¨äºå¯åŠ¨å­åº”ç”¨ï¼š

- é™¤äº†é€ä¼  `props` ä½œä¸ºé…ç½®ä»¥å¤–ï¼Œè¿˜éœ€è¦å°† `myRef` ä½œä¸ºåº”ç”¨å®¹å™¨æŒ‚è½½ç‚¹

ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼š

- `componentDidMount`ï¼šåœ¨ç»„ä»¶æŒ‚è½½åè°ƒç”¨ `startApp` æ–¹æ³•å¯åŠ¨å­åº”ç”¨
- `componentDidUpdate`ï¼šå½“ç»„ä»¶çš„ `name` æˆ– `url` å±æ€§å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°å¯åŠ¨å­åº”ç”¨

> å³ä½¿ä¸æ³¨é”€åº”ç”¨ä¹Ÿå¯ä»¥é‡å¯ï¼Œåœ¨åº”ç”¨å®ä¾‹ä¸­ä¼šæ¸…ç©ºå®¹å™¨æŒ‚è½½ç‚¹ï¼Œç„¶åæ ¹æ®é…ç½®é‡æ–°æŒ‚è½½å®¹å™¨

`render` æ–¹æ³•ï¼š

- å®šä¹‰æ¸²æŸ“ `div` å…ƒç´ ï¼Œé€šè¿‡ `ref` ç»‘å®šåœ¨ `myRef` ä¸­ï¼Œå¹¶æŒ‰ç…§ `props` è®¾ç½®å®½å’Œé«˜

æ–‡æ¡£ï¼š

- `React` å°è£…ç»„ä»¶ä½¿ç”¨ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/pack/react.html)]
- å°è£…ç»„ä»¶çš„ `props` å‚è€ƒ `startApp` [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]

å®˜æ–¹ `react` ç»„ä»¶å°è£…æ€»ç»“ï¼š

- `WujieReact` é€šè¿‡ `react` ç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ¥ç®¡ç† `wujie` å­åº”ç”¨
- é€šè¿‡ `startApp` æ–¹æ³•å¯åŠ¨å­åº”ç”¨ï¼Œå¹¶åœ¨ç»„ä»¶æ›´æ–°æ—¶é‡æ–°å¯åŠ¨å­åº”ç”¨
- é€šè¿‡é™æ€å±æ€§å’Œç±»å‹æ£€æŸ¥ç¡®ä¿ç»„ä»¶çš„ä½¿ç”¨ç¬¦åˆé¢„æœŸ

> å»ºè®®æ‰‹åŠ¨å®šä¹‰ç»„ä»¶ä»£æ›¿å®˜æ–¹æä¾›çš„ç»„ä»¶ï¼Œå› ä¸ºçµæ´»åº¦æ›´é«˜
