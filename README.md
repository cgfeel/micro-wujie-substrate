# micro-wujie-substrate

ä¸€ä¸ª `wujie` åŸºåº§ï¼Œå®Œæ•´å†…å®¹æŸ¥çœ‹å¾®å‰ç«¯ä¸»ä»“åº“ï¼šhttps://github.com/cgfeel/zf-micro-app

`wujie` å’Œå…¶ä»–çš„å¾®å‰ç«¯ï¼ˆ`qiankun`ã€`micro-app`ï¼‰è§£å†³æ–¹æ¡ˆä¸åŒç‚¹ï¼š

| å¯¹æ¯”é¡¹   | `wujie`                                    | å…¶ä»–å¾®å‰ç«¯                                  |
| -------- | ------------------------------------------ | ------------------------------------------- |
| `script` | æ”¾åˆ°æ²™ç®± `iframe`                          | æ”¾åˆ°è‡ªå·±å®ç°çš„æ²™ç®±ï¼Œå¦‚ï¼š`proxy`ã€å¿«ç…§ä¸­å®ç° |
| `css`    | é€šè¿‡ `web component` æ”¾åˆ° `shadowDOM` æ¸²æŸ“ | ä¿®æ”¹ `css` ä½œç”¨åŸŸ `scopedCSS`               |

ä¼˜ç‚¹ï¼Œå¤©ç„¶éš”ç¦»ï¼š

- ä¸éœ€è¦è‡ªå®šä¹‰æ²™ç®±ï¼Œç›´æ¥ä½¿ç”¨ `iframe`ï¼Œä¸éœ€è¦éå† `css` è®¡ç®— `scoped`

äº®ç‚¹ï¼š

- ç†è®ºä¸Š `wujie` å¯ä»¥æŠŠä»»ä½•å¯¹å¤–æä¾›è®¿é—®çš„ç½‘é¡µåšæˆå­åº”ç”¨
- æä¾› `iframe` é™çº§æ–¹æ¡ˆï¼Œå¯¹äºä¸æ”¯æŒ `proxy` å’Œ `shadowDOM` çš„æƒ…å†µ

ç¼ºç‚¹ï¼š

- å¯¹ `React v18` å¹¶ä¸å‹å¥½ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šäº§ç”Ÿåè®®é”™è¯¯ï¼Œè§ï¼šissue [[æŸ¥çœ‹](https://github.com/Tencent/wujie/issues/672)]
- è·¯ç”±åŒæ­¥å¹¶ä¸å‹å¥½ï¼Œå­åº”ç”¨è·¯ç”±åªèƒ½é€šè¿‡ `search` ååº”åˆ°ä¸»åº”ç”¨ä¸­ï¼Œä¸èƒ½ä½¿ç”¨ `pathname`

> è·¯ç”±åŒæ­¥çœ‹è¿‡æºç ï¼Œç›®å‰è®¾è®¡åªèƒ½é€šè¿‡ `search` æ¥å®ç°ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ç²—æš´

ç–‘æƒ‘ï¼š`wujie` é¢‘ç¹æ“ä½œ `Dom` ç›´æ¥å½±å“ `js` æ€§èƒ½

- æ¯”å¦‚è¯´é `alive`æ¨¡å¼æˆ– `umd`æ¨¡å¼ä¸‹ï¼Œ`wuijie` çš„æ¯æ¬¡åº”ç”¨åˆ‡æ¢ï¼Œå°±æ˜¯ä¸€æ¬¡æ³¨é”€å’Œé‡å»º
- `wujie` ä¸éœ€è¦ä¿®æ­£ `css` çš„ `scope`ï¼Œä½†è¦ä¸ºå­åº”ç”¨æ¯ä¸€ä¸ªå…ƒç´ æ‰“è¡¥ä¸ï¼Œè§ `patchElementEffect` [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]

æ¸²æŸ“åŸç†ï¼š

| åˆ†ç±»        | åŸç†                                                                        |
| ----------- | --------------------------------------------------------------------------- |
| `wujie`     | æ‹‰å– `template` æ”¾å…¥ `web component`ï¼Œå°†å…¶æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹                    |
| `micro-app` | åˆ›å»º `web component` æ‹‰å–èµ„æºï¼Œæ›¿æ¢æ ‡ç­¾ä¸ºè‡ªå®šä¹‰ç»„ä»¶ï¼Œç”± `Dom tree` æ¸²æŸ“ç»„ä»¶ |
| `qiankun`   | åŸºäº `single-spa`ï¼Œæ‹‰å– `template`ï¼ŒåŠ«æŒ `url` ç»è¿‡è®¡ç®—å°†èµ„æºæ¸²æŸ“åˆ°æŒ‡å®šå®¹å™¨ |

> `micro-app` ä¹Ÿæ”¯æŒ `shadowDom` å’Œ `iframe` æ²™ç®±ï¼Œä½†éœ€è¦åœ¨ `start` æ—¶æ‰‹åŠ¨å¯ç”¨

æ€»ç»“åˆ†æˆ 3 ä¸ªéƒ¨åˆ†ï¼š`wujie` ä½¿ç”¨ã€å¤ç°å’ŒåŸç†ï¼Œé¡¹ç›®å…¨éƒ¨æ•´åˆåœ¨ï¼š

- `/wujie` [[æŸ¥çœ‹](https://github.com/cgfeel/zf-micro-app/tree/main/wujie)]

## `wujie` ä½¿ç”¨

åŒ…å«é¡¹ç›®ï¼š

- `react-project`ï¼šé€šè¿‡ `create-react-app` æ­å»ºçš„å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra)]
- `static-project`ï¼šè‡ªå®šä¹‰é™æ€åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static)]
- `substrate`ï¼šé€šè¿‡ `create-react-app` æ­å»ºçš„åŸºåº§ä¸»åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-qiankun-substrate)]
- `vue-project`ï¼šé€šè¿‡ `vue-cli` æ­å»ºçš„å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-vue3)]

### æ­å»ºåŸºåº§ä¸»åº”ç”¨

å…ˆå›é¡¾ä¸‹ `micro-app` åŸºåº§æµç¨‹ï¼š

- å…¥å£æ–‡ä»¶ `start` é…ç½®å¯åŠ¨é¡¹
- æŒ‡å®šé¡µé¢æ’å…¥è‡ªå®šä¹‰ç»„ä»¶ `<micro-app />`

> `micro-app` ä¼šå°†åŠ è½½çš„èµ„æºæ³¨å…¥ `web component`

`wujie` å¯ä»¥ä¸ä½¿ç”¨ `start` å¯åŠ¨é…ç½®ï¼š

- åˆ›å»ºä¸€ä¸ªå…¬å…±çš„ç»„ä»¶ `Wujie.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/components/Wujie.tsx)]
- é€šè¿‡ `startApp` å°† `web component` æ·»åŠ çš„å­åº”ç”¨æŒ‚è½½åˆ°æŒ‡å®šçš„ `ref` èŠ‚ç‚¹ [[æŸ¥çœ‹](#startapp-å¯åŠ¨æµç¨‹)]
- å¯ä»¥é€šè¿‡è°ƒç”¨ç»„ä»¶çš„æ–¹å¼åŠ è½½å­åº”ç”¨ï¼Œä¾‹å¦‚: `react` å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/ReactPage.tsx)]

> `wujie` ä¸éœ€è¦é€šè¿‡ `start` å¼ºåˆ¶é…ç½®å¯åŠ¨ï¼Œä½†æä¾› `setupApp` ç”¨æ¥ç¼“å­˜é…ç½®ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

ç å³°çš„è¯¾ç¨‹ä¸­æœ‰ä¸¤ä¸ªé”™è¯¯ï¼š

- å®˜æ–¹æ–‡æ¡£ä¸å»ºè®®æ‰‹åŠ¨æ³¨é”€ `destroyApp` å­åº”ç”¨ï¼Œå¦‚æœè¿˜éœ€è¦ä½¿ç”¨å­åº”ç”¨çš„è¯ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/destroyApp.html)]
- `startApp` ä¼šè¿”å›ä¸€ä¸ªæ–¹æ³• `destory`ï¼Œå¯ä»¥ç›´æ¥ç”¨äºæ³¨é”€åº”ç”¨ï¼Œè€Œä¸ç”¨ä¼ ç»™ `destroyApp`ï¼ŒåŒæ ·ä¹Ÿä¸å»ºè®®ä¸»åŠ¨æ³¨é”€ï¼Œä¼šå¯¼è‡´ä¸‹æ¬¡æ‰“å¼€è¯¥å­åº”ç”¨æœ‰ç™½å±æ—¶é—´

### æ­å»ºå­åº”ç”¨

`react` å­åº”ç”¨ï¼š

- `.env`ï¼šéœ€è¦ä¿®æ”¹ç«¯å£å· [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra/blob/main/.env)]

`vue` å­åº”ç”¨ï¼š

- `vue.config.js`ï¼šéœ€è¦å…è®¸ `cors` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-vue3/blob/main/vue.config.js)]

å¯é€‰ï¼šå¯¹äº `umd` åº”ç”¨

- `global.d.ts`ï¼šæ·»åŠ å…¨å±€ç±»å‹å£°æ˜ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra/blob/main/src/global.d.ts)]
- å…¥å£æ–‡ä»¶æš´éœ² `__WUJIE_MOUNT` å’Œ `__WUJIE_UNMOUNT` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-cra/blob/main/src/index.tsx)]

é€šè¿‡ä»¥ä¸Šäº†è§£å¯¹ `wujie` åˆæ­¥å°è±¡ï¼š

- `Tencent` å¯¹é€šä¿¡éå¸¸åçˆ±ï¼Œæ¯”å¦‚ï¼š`alloy-worker` [[æŸ¥çœ‹](https://github.com/AlloyTeam/alloy-worker)]ï¼Œè¿˜æœ‰å°ç¨‹åº `postMessage`

---- åˆ†å‰²çº¿ ----

## `wujie` å¤ç°

ç®€å•å®ç° `iframe` å’Œ `shadowRoot` é€šä¿¡ï¼Œè¯¦ç»†è§é¡¹ç›®ä¸­çš„æºç ï¼š

- é¡¹ç›®ï¼š`static-project` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static)]
- æ–‡ä»¶ï¼š`ifram2shadow-dom.html` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static/blob/main/ifram2shadow-dom.html)]
- è¿è¡Œæ–¹å¼ï¼šç›´æ¥ç‚¹å¼€æµè§ˆå™¨é¢„è§ˆã€æˆ– `http-server`

æ•´ä½“åˆ† 4 éƒ¨åˆ†ï¼š

- `index.html`ï¼šåŸºåº§ `html` æ–‡ä»¶
- `template`ï¼šå­åº”ç”¨è¦è¿è¡Œçš„ `css` å’Œ `html`ï¼Œè¦æ”¾å…¥ `shadowDOM` ä¸­
- `strScript`ï¼šå­åº”ç”¨è¦æ‰§è¡Œçš„è„šæœ¬å­—ç¬¦ï¼Œè¦æ”¾å…¥ `iframe` ä¸­
- `createCustomElement`ï¼šä¸»åº”ç”¨è‡ªå®šä¹‰ç»„ä»¶

`createCustomElement` æµç¨‹åˆ† 4 éƒ¨åˆ†ï¼š

1. `createSandbox`ï¼šåˆ›å»ºæ²™ç®±
2. `attachShadow`ï¼šåˆ›å»º `shadowRoot`
3. `injectTemplate`ï¼šå°† `css` å’Œ `html` æ³¨å…¥ `shadowRoot`
4. `runScriptInSandbox`ï¼šå°† `js` æ³¨å…¥ `iframe`

æ²™ç®±åˆ† 2 ä¸ªï¼š

- `shadowRoot`ï¼šç›´æ¥å°† `css` å’Œ `html` å…¨éƒ¨æ‰“åŒ…åˆ°ä¸€ä¸ª `div`ï¼Œå¡å…¥ `shadowRoot`
- `iframe`ï¼šåˆ›å»ºä¸€ä¸ª `script` å…ƒç´ ï¼Œå°†æ‰§è¡Œçš„ `js` ä½œä¸ºå…ƒç´ å†…å®¹æ’å…¥ `iframe` çš„ `head`

åœ¨ `script` æ·»åŠ åˆ° `iframe` ä¹‹å‰ï¼š

- éœ€è¦åŠ«æŒ `iframe` å†… `script` çš„æ–¹æ³•ï¼Œå°†ä¸Šä¸‹æ–‡æŒ‡å‘ `shadowRoot`

æµç¨‹ï¼š

- é€šè¿‡ `Object.defineProperty` åŠ«æŒ `iframe` ä¸­çš„ `document.querySelector`
- è¿”å›ä¸€ä¸ª `Proxy` å¯¹è±¡ï¼Œä»£ç† `sandbox.shadowRoot.querySelector`
- åœ¨ `Proxy` ä¸­é€šè¿‡ `apply` çº æ­£ä¸Šä¸‹æ–‡ `this` æŒ‡å‘ `shadowDOM`

`Object.defineProperty` åŠ«æŒå¯¹è±¡ä¼šæ‰§è¡Œä¸¤æ¬¡ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static/blob/d89ae52aa0418d9f7e3cec8ff289cd8dd5edbb1e/index.html#L80)]

ç¬¬ä¸€æ¬¡ï¼šç”± `iframe` ä¸­çš„å­åº”ç”¨å‘èµ· `document.querySelector`

- é€šè¿‡ `Object.defineProperty` åŠ«æŒ `iframeWindow.Document.prototype` å¹¶è¿”å› `Proxy` å¯¹è±¡
- åœ¨ `Proxy` å¯¹è±¡é¦–æ¬¡ `apply` æ—¶ï¼Œå‚æ•° `thisArgs` æŒ‡å‘åŠ«æŒçš„å¯¹è±¡ `iframeWindow.Document.prototype`
- è¿”å› `thisArgs.querySelector` ç›¸å½“äº `iframeWindow.Document.prototype.querySelector.apply(sandbox.shadowRoot, args)`
- é€šè¿‡ `apply` å°†ä¸Šä¸‹æ–‡æŒ‡å‘ `sandbox.shadowRoot`

ç¬¬äºŒæ¬¡ï¼šç”±äº `Proxy` å¯¹è±¡å†æ¬¡è°ƒç”¨äº† `iframe` çš„ `querySelector`ï¼Œäºæ˜¯å†æ¬¡ `Object.defineProperty`

- è¿™ä¸ªæ—¶å€™è¿”å›çš„ `Proxy` å¯¹è±¡ `apply` ä¸­ `thisArgs` æŒ‡å‘ `sandbox.shadowRoot`
- è¿”å› `thisArgs.querySelector` ç›¸å½“äºï¼š`sandbox.shadowRoot.querySelector.apply(sandbox.shadowRoot, args)`
- ç”±äºè¿™æ¬¡æ˜¯é€šè¿‡ `sandox` å‘èµ· `querySelector`ï¼Œå°†ä¸å†è¢« `iframe` åŠ«æŒ

> å¯ä»¥æ‰“å¼€è°ƒè¯•çª—å£ `sources` åœ¨ `Proxy` å¯¹è±¡çš„ `apply` æ–¹æ³•ä¸­æ‰“ä¸Šæ–­ç‚¹ï¼Œåˆ·æ–°æŸ¥çœ‹æ¯æ¬¡æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ `thisArgs` çš„å˜åŒ–

åŠ«æŒå¯¹è±¡åœºæ™¯å‘æ•£ï¼š

- æµ®çª—ï¼šåŠ«æŒ `document`ï¼Œæ•è· `Dom` å¯¹è±¡æŒ‡å‘ `shadowRoot`
- `iframe` ä¸­ `history` å¯¹è±¡ï¼šå®ç°åŒæ­¥åŒæ­¥

> è¿™éƒ¨åˆ†å°†é€šè¿‡ `wujie` æºç è§£è¯»åœ¨ä¸‹æ–¹æ€»ç»“

---- åˆ†å‰²çº¿ ----

## `wujie` åŸç†

å’Œ `qiankun` è§£è¯»ä¸€æ ·ï¼Œä¸ºäº†ä¾¿äºé˜…è¯»å…¨éƒ¨ä»¥å½“å‰å®˜æ–¹ç‰ˆæœ¬ `9733864b0b5e27d41a2dc9fac216e62043273dd3` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/tree/9733864b0b5e27d41a2dc9fac216e62043273dd3)] ä¸ºå‡†

> è¿™ä¸€ç« èŠ‚é“¾æ¥æŒ‡å‘å®˜æ–¹ä»“åº“ï¼Œç”±äºå†…å®¹æ¯”è¾ƒé•¿ï¼Œæ¯ä¸€æ¡ä¿¡æ¯æˆ‘éƒ½æš´éœ²äº†å…³é”®çš„å¯¹è±¡åï¼Œå¯ä»¥æ‰“å¼€é“¾æ¥å¤åˆ¶å…³é”®çš„å¯¹è±¡åï¼ŒæŸ¥çœ‹ä¸Šä¸‹æ–‡å¯¹ç…§ç†è§£ã€‚

å…ˆå¤§è‡´çœ‹ä¸‹ `wujie` æä¾›çš„åŒ…ï¼Œåˆ†åˆ«ä¸º [[æŸ¥çœ‹](https://github.com/Tencent/wujie/tree/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages)]ï¼š

- `wujie-core`ï¼šæ ¸å¿ƒåŒ… [[æŸ¥çœ‹](#å®šä¹‰-web-component)]
- `wujie-react`ï¼š`React` å°è£…ç»„ä»¶ [[æŸ¥çœ‹](#packages---wujie-react)]
- `wujie-vue2`ï¼š`Vue2` å°è£…ç»„ä»¶
- `wujie-vue3`ï¼š`Vue3` å°è£…ç»„ä»¶

> ä¸æ˜¯ `vue` æŠ€æœ¯æ ˆï¼Œå¹¶ä¸”å°è£…çš„åŒ…æ˜¯ä½œä¸ºå¯é€‰ä½¿ç”¨çš„å•ä¸ªç»„ä»¶ï¼Œä¸æ˜¯å¿…é¡»ä½¿ç”¨çš„

ç”±äºæ€»ç»“ä¼šå¾ˆé•¿ï¼Œæ‰€ä»¥æˆ‘å°†æ•´ä¸ªæµç¨‹æ€»ç»“ç²¾ç®€æ”¾åœ¨å‰é¢ï¼š

1. `preloadApp` é¢„åŠ è½½ï¼ˆé `alive` æ¨¡å¼å’Œéé¢„æ‰§è¡Œä¸‹çš„ `umd` æ¨¡å¼ä¸æ¨èï¼‰[[æŸ¥çœ‹](#preloadapp-é¢„åŠ è½½æµç¨‹)]
2. `startApp` æ ¹æ®å®ä¾‹æƒ…å†µå†³å®šåˆå§‹åŒ–è¿˜æ˜¯åˆ‡æ¢åº”ç”¨ [[æŸ¥çœ‹](#startapp-å¯åŠ¨æµç¨‹)]
3. é¦–æ¬¡å¯åŠ¨å’Œåˆ‡æ¢é‡å»ºæ¨¡å¼çš„åº”ç”¨ï¼Œä¼š `destroy` é”€æ¯åé‡æ–°åˆå§‹åŒ– [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]
4. å£°æ˜å®ä¾‹ï¼Œåˆ›å»ºæ²™ç®± `iframe`ã€ä»£ç† `proxy`ã€é€šä¿¡ `EventBus` ç­‰ [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]
5. `importHTML` åŠ è½½èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
6. `processCssLoader` å¤„ç† `css-loader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
7. `active` æ¿€æ´»åº”ç”¨ï¼šå°† `template` æ ¹æ® `degrade` æ”¾å…¥ `iframe` å®¹å™¨æˆ– `shadowRoot` å®¹å™¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
8. `start` å¯åŠ¨åº”ç”¨ï¼šå°† `script` æ”¾å…¥æ²™ç®± `iframe`ï¼Œå‘èµ·é€šçŸ¥äº‹ä»¶å’Œ `mount` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
9. è¿”å› `destroy` ä»¥ä¾¿æ‰‹åŠ¨é”€æ¯ [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]

> é˜…è¯»å»ºè®®ï¼Œå¦‚æœä½ åšå¥½å‡†å¤‡é˜…è¯»ä»¥ä¸‹å†…å®¹ï¼Œè¿™æ ·å¯ä»¥æé«˜æ•ˆç‡ï¼š
>
> - â€œæŸ¥çœ‹â€æŒ‡å‘æºç é“¾æ¥æˆ–è¯¦ç»†è¯´æ˜ï¼Œè®°å½•ç½—åˆ—äº†å…³é”®å†…å®¹ï¼Œå¯ä»¥é€šè¿‡å¤åˆ¶æŸ¥æ‰¾å®šä½
> - å»ºè®®æŒ‰ç…§æµç¨‹çº¿å»é˜…è¯»
>
> æ¯”å¦‚è¯´ï¼š
>
> - é¦–æ¬¡åŠ è½½åº”ç”¨ï¼šä» `startApp` å¼€å§‹ï¼Œå¿½ç•¥å·²å­˜åœ¨åº”ç”¨å®ä¾‹çš„æƒ…å†µï¼Œåªçœ‹å£°æ˜å®ä¾‹
> - åˆ‡æ¢åº”ç”¨ï¼šä» `startApp` å¼€å§‹ï¼Œåªçœ‹å­˜åœ¨åº”ç”¨å®ä¾‹çš„æƒ…å†µ
> - é¢„åŠ è½½ï¼šä» `preloadApp` å¼€å§‹çœ‹

### å®šä¹‰ `web component`

`wujie` å’Œ `micro-app` ç»„ä»¶å®šä¹‰ä¸åŒå¤„ï¼š

| åˆ†ç±»                       | `micro-app`                                                                                                                                                                                       | `wujie`                                                                                                                |
| -------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------- |
| æŒ‚è½½æ–¹å¼                   | æ‰‹åŠ¨æŒ‚è½½ `web component` åˆ°æŒ‡å®š `components tree` ä¸­æ¸²æŸ“                                                                                                                                          | è‡ªåŠ¨æŒ‚è½½ï¼Œ`active` æ¿€æ´»åº”ç”¨æ—¶é€šè¿‡ `createWujieWebComponent` åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶ï¼ŒæŒ‚è½½åˆ°æŒ‡å®šå®¹å™¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)] |
| è‡ªå®šä¹‰ç»„ä»¶å               | æ”¯æŒ                                                                                                                                                                                              | ä¸æ”¯æŒ                                                                                                                 |
| æ¥å—çš„å±æ€§                 | `name`ã€`url`ã€`iframe` ç­‰é…ç½®ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://micro-zoe.github.io/micro-app/docs.html#/zh-cn/configure?id=%e9%85%8d%e7%bd%ae%e9%a1%b9)]                                                | ä»…æ”¯æŒ `WUJIE_APP_ID` [[æŸ¥çœ‹](#æ¿€æ´»åº”ç”¨çš„è¡¥å……)]                                                                        |
| `attributeChangedCallback` | æ£€æŸ¥å­åº”ç”¨ `name` å’Œ `url` å±æ€§å˜æ›´ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#11-attributechangedcallback-%E8%A7%82%E5%AF%9F%E5%B1%9E%E6%80%A7%E4%BF%AE%E6%94%B9)] | ä¸æ”¯æŒï¼Œä½†æ˜¯å­åº”ç”¨çš„ `name` å’Œ `url` å¯ä»¥ä½œä¸º `React` ç»„ä»¶çš„ `props`ï¼Œæ›´æ–°åé‡æ–°æ¸²æŸ“å¹¶æŒ‚è½½åˆ°å®¹å™¨                       |
| `connectedCallback`        | ä½¿ç”¨ç»„ä»¶è‡ªå¢ç¼–å·æ·»åŠ å½“å‰ç»„ä»¶åˆ°æ˜ å°„è¡¨ï¼Œå¹¶å‘èµ·åº”ç”¨æŒ‚è½½                                                                                                                                              | æ ¹æ®åº”ç”¨åæ‹¿åˆ°å®ä¾‹ï¼Œæ‰“è¡¥ä¸åå°† `shadowRoot` ç»‘å®šåˆ°å®ä¾‹ä¸­ [[æŸ¥çœ‹](#connectedcallbackæŒ‚è½½ç»„ä»¶)]                          |
| `disconnectedCallback`     | ç”¨ç»„ä»¶ç¼–å·ä»æ˜ å°„è¡¨ä¸­ä¸‹çº¿ç»„ä»¶ï¼Œå¹¶å‘èµ·åº”ç”¨å¸è½½                                                                                                                                                      | æ ¹æ®åº”ç”¨åæ‹¿åˆ°å®ä¾‹å¹¶å‘èµ·å¸è½½ [[æŸ¥çœ‹](#disconnectedcallback-å¸è½½ç»„ä»¶)]                                                  |
| è‡ªå®šä¹‰æ›´æ–°ç»„ä»¶             | è§„åˆ™ç»„ä»¶å†…éƒ¨å®šä¹‰å¥½äº†ï¼Œåªæ¥å— `name` å’Œ `url` çš„å˜æ›´åˆ™                                                                                                                                             | ä¸€æ—¦æ›´æ–°åº”ç”¨å°±ä¸€å®šæ˜¯é‡æ–°æ¸²æŸ“                                                                                           |
| ç»„ä»¶ç”¨é€”                   | åº”ç”¨é€šä¿¡ã€èµ„æºå®¹å™¨ã€æ´¾å‘äº‹ä»¶ã€å†³å®šå¯åŠ¨å’Œæ³¨é”€æ–¹å¼                                                                                                                                                  | èµ„æºå®¹å™¨                                                                                                               |
| ä¼˜ç¼ºç‚¹                     | å¼ºå¤§ï¼Œä½†åŠŸèƒ½ä¸Šåˆ†å·¥ä¸æ¸…æ™°ï¼Œ`MicroAppElement` å¤„ç†å®Œä¹‹å `CreateApp` è¿˜è¦åšä¸€éå¯¹åº”æ“ä½œï¼Œå¦‚ï¼šç»„ä»¶å’Œåº”ç”¨åˆ†åˆ« `mount`                                                                                 | ç®€å•ï¼Œå‡ ä¹ä¸ç”¨å…³å¿ƒ `web component`ï¼Œä½†å¾ˆç²—æš´ï¼Œåªå­˜åœ¨æŒ‚è½½å’Œå¸è½½ï¼Œä¸€æ—¦æ›´æ–°å°±ä¸€å®šæ˜¯é”€æ¯åé‡æ–°æŒ‚è½½ï¼Œæ•ˆç‡ä¸é«˜               |

#### å…³äº `defineWujieWebComponent`

ç›®å½•ï¼š`shadow.ts` - `defineWujieWebComponent` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/shadow.ts#L39)]

å£°æ˜ `WujieApp` è‡ªå®šä¹‰ç»„ä»¶ï¼š

- åœ¨å…¥å£æ–‡ä»¶ä¸­é»˜è®¤æ‰§è¡Œï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L170)]

> å› æ­¤ï¼Œå¼•å…¥ `wujie` åŒ…çš„æ—¶å€™å°±å·²ç»å®šä¹‰äº† `web component`

`WujieApp` æä¾›äº†æŒ‚è½½å’Œå¸è½½ 2 ä¸ªæ–¹æ³•

#### `connectedCallback`ï¼šæŒ‚è½½ç»„ä»¶

- è®¾ç½® `shadowRoot` æ¨¡å¼ä¸º `open`
- é€šè¿‡ `getWujieById` ä½¿ç”¨å±æ€§ `WUJIE_APP_ID` æ‹¿åˆ°åº”ç”¨å®ä¾‹ï¼Œè§ï¼š`idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]
- é€šè¿‡ `patchElementEffect` ä¸º `shadowRoot` æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#patchelementeffectä¸ºå…ƒç´ æ‰“è¡¥ä¸)]
- å°† `shadowRoot` ç»‘å®šåˆ°å®ä¾‹ä¸Š

å‡ ä¸ªæ¦‚å¿µåè¯ï¼š

- `web component`ï¼šé€šè¿‡ `WujieApp` å®šä¹‰çš„ç»„ä»¶ï¼Œè¿™é‡Œå®šä¹‰çš„ç»„ä»¶åæ˜¯ `wujie-app`
- `shadowRoot`ï¼š`shadowDom` çš„æ ¹èŠ‚ç‚¹ï¼Œä¸ä¹‹ç›¸ä¼¼æœ‰ `document` æ˜¯ `Dom` çš„æ ¹èŠ‚ç‚¹
- `shadowRoot.host`ï¼šè¿”å› `shadowRoot` é™„åŠ åˆ° `Dom` å…ƒç´ çš„å¼•ç”¨ï¼Œå³ï¼š`web component`
- `shadowRoot.host.parentElement`ï¼š`web component` çš„çˆ¶èŠ‚ç‚¹ï¼Œç”¨äºè·å– `shadowRoot` æŒ‚è½½èŠ‚ç‚¹
- `shadowRoot.firstChild`ï¼š`shadowRoot` ä¸‹ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨ `wujie` ä¸­æ˜¯ `html` å…ƒç´ 
- `documet.documentElement`ï¼š`document` ä¸‹çš„æ ¹å…ƒç´ ï¼Œå¦‚ï¼š`html` å…ƒç´ 

> ä»¥ä¸Šå‡ ä¸ªå¯¹è±¡å°†ä¼šåœ¨ `wujie` ä¸­é«˜é¢‘å‡ºç°

#### `disconnectedCallback` å¸è½½ç»„ä»¶

- é€šè¿‡ `getWujieById` ä½¿ç”¨å±æ€§ `WUJIE_APP_ID` æ‹¿åˆ°åº”ç”¨å®ä¾‹ï¼Œè§ï¼š`idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]
- å‘èµ·å¸è½½æ“ä½œï¼Œè§ï¼š`unmount` [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]

### `startApp` å¯åŠ¨æµç¨‹

ç›®å½•ï¼š`index.ts` - `startApp` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L185)]

åˆ† 3 æ­¥ï¼š

1. è·å–ã€æ›´æ–°é…ç½®ä¿¡æ¯
2. å­˜åœ¨æ²™ç®±å®ä¾‹å°±åˆ‡æ¢æˆ–é”€æ¯åº”ç”¨
3. ä¸å­˜åœ¨æ²™ç®±å®ä¾‹æˆ–è¢«é”€æ¯çš„åº”ç”¨ï¼Œåˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹

è¿è¡Œåº”ç”¨åˆ†ä¸º 3 ä¸ªæ¨¡å¼ï¼š

1. `alive` ä¿æ´»æ¨¡å¼ï¼Œå¯åŠ¨å’Œåˆ‡æ¢åº”ç”¨ä¸ä¼šé”€æ¯å®ä¾‹ [[æŸ¥çœ‹](#21-alive-ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨)]
2. `umd` å•ä¾‹æ¨¡å¼ï¼Œå­åº”ç”¨é€šè¿‡ `window.__WUJIE_MOUNT` é‡æ–°æ¸²æŸ“ [[æŸ¥çœ‹](#22-umd-æ¨¡å¼åˆ‡æ¢åº”ç”¨)]
3. é‡å»ºæ¨¡å¼ï¼Œå…¶ä»–æ–¹å¼éƒ½æ³¨é”€å½“å‰å®ä¾‹ï¼Œç­‰å¾…é‡æ–°åˆ›å»º [[æŸ¥çœ‹](#23-destroy-æ³¨é”€åº”ç”¨)]

æœ‰å…³ `wujie` çš„è¿è¡Œæ¨¡å¼ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/mode.html)]

![`wujie` çš„è¿è¡Œæ¨¡å¼](https://github.com/cgfeel/micro-wujie-substrate/assets/578141/c4473f5d-9845-4df4-bac6-4506f8202a3d)

å¤‡æ³¨ï¼š

- `umd` åœ¨æ–‡æ¡£ä¸­ç§°ä¸ºå•ä¾‹æ¨¡å¼ï¼Œä¸ºäº†å’Œ `qiankun`ã€`micro-app` å¯¹é½ï¼Œä»¥ä¸‹ç»Ÿç§° `umd` æ¨¡å¼
- å¦‚æœä½ çš„åº”ç”¨åœ¨åˆ‡æ¢æ—¶çœ‹åˆ°ç™½å±å»ºè®®ä½¿ç”¨ `alive` æ¨¡å¼æˆ– `umd` æ¨¡å¼

#### 1. è·å–åº”ç”¨å®ä¾‹å’Œé…ç½®

ä»æ˜ å°„è¡¨ `idToSandboxCacheMap` è·å–å·²è®°å½•çš„å®ä¾‹å’Œé…ç½® [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]ï¼š

- `getWujieById`ï¼šä½¿ç”¨åº”ç”¨åè·å–åº”ç”¨å®ä¾‹ï¼Œä¸å­˜åœ¨è¿”å› `null`
- `getOptionsById`ï¼šä½¿ç”¨åº”ç”¨åè·å–å·²ç¼“å­˜çš„é…ç½®ï¼Œä¸å­˜åœ¨è¿”å› `null`

> é…ç½®åªèƒ½é€šè¿‡ `setupApp` ç¼“å­˜ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

åˆå¹¶å¹¶æå–é…ç½®ï¼š

- é€šè¿‡ `mergeOptions` åˆå¹¶å‚æ•°æä¾›çš„é…ç½®å’Œç¼“å­˜çš„é…ç½®
- è§£æ„å¹¶æå–å¿…è¦çš„é…ç½®ï¼Œå…³äºé…ç½®è§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html)]

#### 2. å­˜åœ¨æ²™ç®±å®ä¾‹ï¼Œè¿è¡Œæˆ–é”€æ¯åº”ç”¨

åº”ç”¨åœºæ™¯ï¼š

| æ¨¡å¼    | é¢„åŠ è½½åå¯åŠ¨ | é¢„æ‰§è¡Œåå¯åŠ¨ | åˆ‡æ¢åº”ç”¨ |
| ------- | ------------ | ------------ | -------- |
| `alive` | è¿è¡Œ         | è¿è¡Œ         | è¿è¡Œ     |
| `umd`   | é”€æ¯         | è¿è¡Œ         | è¿è¡Œ     |
| é‡å»º    | é”€æ¯         | é”€æ¯         | é”€æ¯     |

> æ²¡æœ‰é¢„åŠ è½½åˆæ¬¡ `startApp` ä¸å­˜åœ¨åº”ç”¨å®ä¾‹ï¼Œæ‰€æœ‰æ¨¡å¼éƒ½å¿…é¡»åˆ›å»ºå®ä¾‹ [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)]

æ¸²æŸ“å‰çš„å‡†å¤‡ï¼š

- é€šè¿‡ `getPlugins` æ›´æ–°å®ä¾‹çš„ `plugins`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#plugins)]
- æ›´æ–°å®ä¾‹çš„ `lifecycles`ï¼Œ è§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/lifecycle.html)]
- è·å–å®ä¾‹çš„ `iframeWindow` å¯¹è±¡ï¼Œç”¨äºæŸ¥çœ‹å­åº”ç”¨æŒ‚è½½æ–¹æ³• `__WUJIE_MOUNT`
- å¦‚æœæ˜¯é¢„åŠ è½½åº”ç”¨ï¼Œéœ€è¦ç­‰å¾…é¢„åŠ è½½æ‰§è¡Œå®Œæ¯•ï¼Œè§ï¼š`runPreload` [[æŸ¥çœ‹](#3-é¢„åŠ è½½å¾®ä»»åŠ¡-runpreload)]

#### 2.1 `alive` ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨

å’Œ `micro-app` çš„ `keep-alive` æ¨¡å¼ä¸€æ ·ï¼š

- ä¼˜ç‚¹ï¼šåˆ‡æ¢è·¯ç”±ä¸é”€æ¯åº”ç”¨å®ä¾‹ï¼Œè·¯ç”±ã€çŠ¶æ€ä¸ä¼šä¸¢å¤±ï¼Œåœ¨æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„æƒ…å†µä¸‹ï¼Œå‡å°‘ç™½å±æ—¶é—´
- ç¼ºç‚¹ï¼šå¤šä¸ªèœå•æ è·³è½¬åˆ°å­åº”ç”¨çš„ä¸åŒé¡µé¢ï¼Œä¸åŒèœå•æ æ— æ³•è·³è½¬åˆ°æŒ‡å®šå­åº”ç”¨è·¯ç”±

æµç¨‹åˆ† 3 æ­¥ï¼š

**ç¬¬ä¸€æ­¥ï¼šæ¿€æ´»åº”ç”¨**

- æ¿€æ´»åº”ç”¨æ—¶ä¼šå°† `shadowRoot.host` æŒ‚è½½åˆ°æŒ‡å®š `el` èŠ‚ç‚¹ï¼Œè§ï¼š`active` [[æŸ¥çœ‹](#1-active-æ¿€æ´»åº”ç”¨)]
- ç”±äº `alive` æ¨¡å¼ä¸ä¼šé”€æ¯å®¹å™¨ï¼Œæ‰€ä»¥æ¿€æ´»æ—¶ä¹Ÿä¸éœ€è¦æ³¨å…¥èµ„æºï¼Œè§ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]

**ç¬¬äºŒæ­¥ï¼š`start` åº”ç”¨**

é¢„åŠ è½½ä½†æ˜¯æ²¡æœ‰ `exec` é¢„æ‰§è¡Œçš„æƒ…å†µä¸‹éœ€è¦ `start` åº”ç”¨ï¼š

- è°ƒç”¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ `beforeLoad`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#beforeload)]
- é€šè¿‡ `importHTML` æå–éœ€è¦åŠ è½½çš„ `script` [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- å°†æå–çš„æ–¹æ³• `getExternalScripts` ä¼ å…¥ `sandbox.start` å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

**ç¬¬ä¸‰æ­¥ï¼š`alive` åŠ è½½å®Œæˆ**

- è°ƒç”¨ç”Ÿå‘½å‘¨æœŸä¸­çš„ `activated` å¹¶è¿”å›å­åº”ç”¨æ³¨é”€å‡½æ•° `sandbox.destroy`
- è¿™é‡Œå­˜åœ¨ `activated` è°ƒç”¨ 2 æ¬¡çš„æƒ…å†µï¼Œè§ï¼š6.é¢„åŠ è½½ä¸­çš„ `bug` [[æŸ¥çœ‹](#6é¢„åŠ è½½ä¸­çš„-bug)]

#### 2.2 `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨

é€šè¿‡ `umd` åˆ‡æ¢åº”ç”¨çš„æ¡ä»¶ï¼š

- å­åº”ç”¨å­˜åœ¨ `__WUJIE_MOUNT` æ–¹æ³•æŒ‚è½½åˆ° `iframeWindow`
- é¢„åŠ è½½æ—¶é€šè¿‡ `exec` é¢„æ‰§è¡Œå `startApp`ï¼Œæˆ–å®Œæˆé¦–æ¬¡ `startApp` åæ¯æ¬¡åˆ‡æ¢å›åº”ç”¨

**ç¬¬ä¸€æ­¥ï¼šé‡æ–°åŠ è½½èµ„æº**

- å¸è½½åº”ç”¨å®ä¾‹ï¼Œè§ï¼š`unmount` [[æŸ¥çœ‹](#-unmount-å¸è½½åº”ç”¨)]
- é‡æ–°æ¿€æ´»åº”ç”¨ï¼Œè§ï¼š`active` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
- æ¢å¤åŠ¨æ€åŠ è½½çš„æ ·å¼ï¼Œè§ `rebuildStyleSheets` [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]

`unmount` å¸è½½åº”ç”¨ï¼š

- æ¸…ç©ºå®¹å™¨ã€æ¸…ç†è·¯ç”±å’Œäº‹ä»¶ï¼Œå°†åº”ç”¨è¿˜åŸè‡³åˆå§‹çŠ¶æ€
- å¦åˆ™ `active` æ—¶å¯èƒ½ä¼šé‡å¤æ·»åŠ èµ„æºåˆ°å®¹å™¨ï¼Œè§ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]

`active` æ¿€æ´»åº”ç”¨ï¼š

- æ— è®ºæ˜¯ `preloadApp` å·²åŠ è½½è¿‡èµ„æºï¼Œè¿˜æ˜¯åˆ‡æ¢åº”ç”¨ï¼Œå®¹å™¨éƒ½ä¼šåœ¨ `unmount` æ—¶æ¸…ç©º
- æ¿€æ´»åº”ç”¨æ—¶ä¼šå†æ¬¡åŒæ­¥è·¯ç”±ï¼Œå¹¶é‡æ–°å°†èµ„æºæ³¨å…¥å®¹å™¨

`rebuildStyleSheets` æ¢å¤æ ·å¼ï¼š

- `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨åï¼Œåªä¿ƒå‘ `mount` å‡½æ•°æŒ‚è½½åº”ç”¨
- åº”ç”¨ä¸­åŠ¨æ€æ·»åŠ çš„æ ·å¼éœ€è¦é€šè¿‡ `styleSheetElements` æ”¶é›†å¹¶æ¢å¤ [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]
- å®Œæ•´çš„æ ·å¼æ¢å¤è¡¨ï¼Œè§ï¼šåº”ç”¨ä¸­çš„ `css` åœ¨å“ªé‡ŒåŠ è½½ [[æŸ¥çœ‹](#5-åº”ç”¨ä¸­çš„-css-åœ¨å“ªé‡ŒåŠ è½½)]

**ç¬¬äºŒæ­¥ï¼šæŒ‚è½½åº”ç”¨**

å’Œ `mount` æŒ‚è½½ `umd` æ¨¡å¼çš„åº”ç”¨æ˜¯ä¸€æ ·çš„ï¼Œè§ï¼š`umd` æ–¹å¼å¯åŠ¨ [[æŸ¥çœ‹](#1-umd-æ–¹å¼å¯åŠ¨)]

åšäº† 4 ä»¶äº‹ï¼š

1. æŒ‚è½½å‰ä½¿ç”¨æ²™ç®±çš„ `iframeWindow` è°ƒç”¨ `beforeMount`
2. æŒ‚è½½åº”ç”¨ï¼Œè°ƒç”¨å­åº”ç”¨ `__WUJIE_MOUNT`
3. æŒ‚è½½åä½¿ç”¨æ²™ç®±çš„ `iframeWindow` è°ƒç”¨ `afterMount`
4. æ¿€æ´» `mountFlag` è¡¨æ˜å·²æŒ‚è½½ï¼Œé¿å…é‡å¤æŒ‚è½½ï¼Œå°† `destroy` æ³¨é”€æ–¹æ³•è¿”å›

#### 2.3 `destroy` æ³¨é”€åº”ç”¨

æµç¨‹ï¼š

- è§ï¼š`WuJie` åº”ç”¨ç±»çš„ `destroy` æ–¹æ³• [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]

æ³¨é”€åº”ç”¨çš„åœºæ™¯ï¼š

- è§ï¼šå­˜åœ¨æ²™ç®±å®ä¾‹ï¼Œè¿è¡Œæˆ–é”€æ¯åº”ç”¨ - åº”ç”¨åœºæ™¯è¡¨æ ¼ [[æŸ¥çœ‹](#2-å­˜åœ¨æ²™ç®±å®ä¾‹è¿è¡Œæˆ–é”€æ¯åº”ç”¨)]

æ¡ä»¶åŒ¹é…çš„åº”ç”¨ä¼šæ³¨é”€å·²ç¼“å­˜å®ä¾‹åï¼Œå†é‡æ–°åˆ›å»ºæ–°å®ä¾‹ï¼š

- åŒ…æ‹¬é‡æ–°æå–èµ„æºã€æ›¿æ¢èµ„æºã€è½¬å˜ä¸º `html` æ³¨å…¥å®¹å™¨ï¼ŒæŒ‚è½½å®¹å™¨ï¼Œç­‰ä¸€ç³»åˆ—æ“ä½œ
- å› æ­¤å¯èƒ½ä¼šå¯¼è‡´çŸ­æš‚ç™½å±çš„ç°è±¡ï¼Œè¦é¿å…è¿™ç§æƒ…å†µå»ºè®®ä½¿ç”¨ `alive` æˆ– `umd` æ¨¡å¼

> æ³¨é”€åº”ç”¨åå†æ¬¡åˆ›å»ºå®ä¾‹ï¼Œä¼šä¼˜å…ˆä½¿ç”¨ç¼“å­˜æå–å¹¶åŠ è½½èµ„æº [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]

#### 3. åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹

è¿™ä¸€è¿‡ç¨‹å’Œ `preloadApp` é¢„åŠ è½½åº”ç”¨æµç¨‹æ˜¯ä¸€æ ·çš„ [[æŸ¥çœ‹](#preloadapp-é¢„åŠ è½½æµç¨‹)]ï¼š

| æµç¨‹               | æè¿°                                                                                                                   | `preloadApp`                   | `startApp`                                                               |
| ------------------ | ---------------------------------------------------------------------------------------------------------------------- | ------------------------------ | ------------------------------------------------------------------------ |
| `addLoading`       | å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ  `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]                                                         | ä¸éœ€è¦                         | éœ€è¦                                                                     |
| `sandbox`          | é€šè¿‡ `WuJie` å£°æ˜å®ä¾‹ï¼Œè§ï¼š`constructor` [[æŸ¥çœ‹](#-constructor-æ„é€ å‡½æ•°)]                                              | éœ€è¦                           | éœ€è¦                                                                     |
| `beforeLoad`       | ä¼ é€’ `iframeWindow` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/lifecycle.html#beforeload)] | éœ€è¦                           | éœ€è¦                                                                     |
| `importHTML`       | æå–åº”ç”¨èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]                                                                            | éœ€è¦                           | éœ€è¦                                                                     |
| `processCssLoader` | å¤„ç† `css-loader`ï¼Œå¹¶æ›´æ–°å·²æå–çš„èµ„æº [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]                                       | éœ€è¦                           | éœ€è¦                                                                     |
| `alive`            | æ¿€æ´»åº”ç”¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]                                                                                   | éœ€è¦                           | é™¤äº†é¢„åŠ è½½æä¾›çš„å‚æ•°å¤–ï¼Œè¿˜åŒ…æ‹¬ï¼š`sync` åŒæ­¥è·¯ç”±ã€`el` æŒ‚è½½å®¹å™¨           |
| `start`            | å¯åŠ¨åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]                                                                                    | ä»…åœ¨æä¾› `exec` é¢„åŠ è½½æ—¶æ‰æ‰§è¡Œ | éœ€è¦                                                                     |
| `destroy`          | è¿”å›æ³¨é”€æ–¹æ³• [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]                                                                              | ä¸è¿”å›                         | ä»…åœ¨ `start` æ­£å¸¸æƒ…å†µä¸‹è¿”å›ï¼Œè§ï¼š`bug` [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)] |

#### 4. `startApp` çš„ `bug`

åŒæ ·é€‚ç”¨äº `preloadApp`ï¼š

- å¯åŠ¨æˆ–é¢„åŠ è½½åº”ç”¨æ—¶ä¸æä¾› `name` å’Œ `url` æ€ä¹ˆå¤„ç†

è™½ç„¶åœ¨ `ts` ä¸­å·²å´æ˜è¦æ±‚è¿™ä¸¤ä¸ªå‚æ•°å¿…é¡»æä¾›ï¼š

- ä½†å¦‚æœ `ignore` æˆ–ä½¿ç”¨ `js` çš„æƒ…å†µæ²¡æœ‰æä¾›å‚æ•°æ€ä¹ˆå¤„ç†

`micro-app` ä¸­çš„å¤„ç†æ–¹å¼ï¼š

- åœ¨ `defineElement` çš„ `attributeChangedCallback` ä¸­è§‚å¯Ÿ `name` å’Œ `url` ä¸¤ä¸ªå±æ€§
- åªæœ‰éƒ½ç¬¦åˆè¦æ±‚æ‰å¼€å§‹æŒ‚è½½ç»„ä»¶

#### 5. åº”ç”¨ä¸­çš„ `css` åœ¨å“ªé‡ŒåŠ è½½

| åˆ†ç±»                  | åŠ è½½æ–¹å¼                                                                         | åœºæ™¯                                        |
| --------------------- | -------------------------------------------------------------------------------- | ------------------------------------------- |
| åº”ç”¨å†…çš„é™æ€æ ·å¼      | `processCssLoader` [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]                    | `preloadApp`ã€é¦–æ¬¡ `startApp` åˆå§‹åŒ–å®ä¾‹    |
| æ‰‹åŠ¨é…ç½® `css-loader` | `processCssLoaderForTemplate` [[æŸ¥çœ‹](#processcssloaderfortemplateæ‰‹åŠ¨æ·»åŠ æ ·å¼)] | `alive` é¦–æ¬¡æ¿€æ´»ã€å…¶ä»–æ¨¡å¼æ¯æ¬¡æ¿€æ´»          |
| åº”ç”¨å†…çš„åŠ¨æ€æ ·å¼      | `patchRenderEffect` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]                    | `alive` å’Œ `umd` é¦–æ¬¡æ¿€æ´»ã€é‡å»ºæ¨¡å¼æ¯æ¬¡æ¿€æ´» |
| `umd` æ¨¡å¼æ¢å¤æ ·å¼    | `rebuildStyleSheets` [[æŸ¥çœ‹](#-rebuildstylesheets-é‡æ–°æ¢å¤æ ·å¼)]                 | åˆ‡æ¢ `umd` åº”ç”¨ã€`umd` é¢„æ‰§è¡Œåå¯åŠ¨         |

> åŠ è½½çš„é¡ºåºä¹ŸæŒ‰ç…§è¡¨æ ¼ä»ä¸Šè‡³ä¸‹

`spa` åº”ç”¨åŸºæœ¬éƒ½æ˜¯åŠ¨æ€åŠ è½½æ ·å¼ï¼š

- `alive` æ¨¡å¼ï¼šåˆ‡æ¢åº”ç”¨ä¸ä¼šé”€æ¯å®ä¾‹ï¼Œæ‰€ä»¥ä¸‹æ¬¡æ¿€æ´»æ—¶ä¸ç”¨é‡å¤åŠ è½½æ ·å¼
- `umd` æ¨¡å¼ï¼šåˆ‡æ¢åº”ç”¨æ—¶åªæ‰§è¡Œ `mount` æ–¹æ³•ï¼Œä¹‹å‰åŠ è½½çš„æ ·å¼éœ€è¦é€šè¿‡ `rebuildStyleSheets` æ¢å¤
- é‡å»ºæ¨¡å¼ï¼šæ¯æ¬¡å¯åŠ¨éƒ½ä¼šé‡æ–°æ³¨å…¥ `css`

#### 6. åº”ç”¨ä¸­çš„ `script` åœ¨å“ªé‡ŒåŠ è½½

- `start`ï¼šé€šè¿‡ `execQueue` é˜Ÿåˆ—åŠ è½½ï¼š`js-loader`ã€å­åº”ç”¨é™æ€ `script` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
- `patchRenderEffect`ï¼šæ¿€æ´»åº”ç”¨æ—¶ï¼Œå°†å…¥å£ `script` æ³¨å…¥æ²™ç®±ä¸­ï¼ŒåŠ¨æ€æ·»åŠ  `script chunk` [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

`spa` åº”ç”¨åŸºæœ¬éƒ½æ˜¯åŠ¨æ€åŠ è½½ `script chunk`ï¼š

- `alive` æ¨¡å¼ï¼šåˆ‡æ¢åº”ç”¨ä¸ä¼šé”€æ¯å®ä¾‹ï¼Œæ‰€ä»¥ä¸‹æ¬¡æ¿€æ´»æ—¶ä¸ç”¨é‡å¤åŠ è½½ `script`
- `umd` æ¨¡å¼ï¼šå¸è½½åº”ç”¨ `unmount` æ—¶ï¼Œåªæ¸…ç©º `shadowRoot` ä¸æ¸…ç©ºæ²™ç®±ï¼Œåˆ‡æ¢åº”ç”¨ä¸éœ€è¦é‡å¤åŠ è½½ `script`
- é‡å»ºæ¨¡å¼ï¼šæ¯æ¬¡å¯åŠ¨éƒ½ä¼šé‡æ–°æ³¨å…¥ `script`

> ç›®å‰ï¼šä¸»åŠ¨é™çº§æ—¶ `umd` æ¨¡å¼ä¸æ¸…ç©ºå®¹å™¨ï¼ŒåŸå› æˆ‘æƒ³å¯ä»¥æ˜¯å› ä¸º `hrefFlag`ï¼Œè¦åšåˆ†æ”¯åˆ¤æ–­

### `preloadApp` é¢„åŠ è½½æµç¨‹

ç›®å½•ï¼š`index.ts` - `preloadApp` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L282)]

å‚æ•°ï¼š`preOptions`ï¼Œè§å®˜æ–¹æ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/preloadApp.html)]

`preloadApp` é¢„åŠ è½½é€šè¿‡ `requestIdleCallback` åœ¨ç©ºé—²æ—¶é—´å¤„ç†ï¼Œä¸å¤„ç†çš„æƒ…å†µæœ‰ 2 ä¸ªï¼š

- åº”ç”¨å®ä¾‹å·²å­˜åœ¨
- å½“å‰çš„ `url.search` èƒ½å¤Ÿæ‰¾åˆ°é¢„åŠ è½½çš„åº”ç”¨åï¼Œæ­¤æ—¶éœ€è¦ç›´æ¥åŠ è½½

> åŒä¸€ä¸ªåº”ç”¨ä¸èƒ½é‡å¤é¢„åŠ è½½ï¼Œå¦åˆ™ä¼šé€ æˆè¯¯åˆ¤ï¼Œå¦‚ï¼š`active` æ—¶å› ä¸º `shadowRoot` å­˜åœ¨è€Œåˆæ‰¾ä¸åˆ° `el` æŒ‚è½½ç‚¹

é¢„åŠ è½½åˆ† 3 æ­¥ï¼š

#### 1. è·å–é…ç½®

- é€šè¿‡ `getOptionsById` è·å–é…ç½®ä¿¡æ¯ `cacheOptions`
- é€šè¿‡ `mergeOptions` åˆå¹¶å‚æ•° `preOptions` å’Œ `cacheOptions`ï¼Œä¼˜å…ˆé‡‡ç”¨ `preOptions`
- ä»åˆå¹¶çš„ `options` ä¸­æå–é…ç½®ç”¨äºé¢„åŠ è½½

> é…ç½®ä¿¡æ¯åªèƒ½é€šè¿‡ `setupApp` ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰ç¼“å­˜åˆ™è¿”å› `null`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

#### 2. å£°æ˜ä¸€ä¸ªå®ä¾‹

- å°†æ‹¿åˆ°çš„é…ç½®ä¿¡æ¯é€šè¿‡ `Wujie` å£°æ˜å®ä¾‹ `sandbox`
- é€šè¿‡ `runPreload` ä¸ºå®ä¾‹æŒ‚èµ·ä¸€ä¸ªå¾®ä»»åŠ¡ `preload`

> å¾®ä»»åŠ¡æŒ‚è½½åœ¨å®ä¾‹ä¸Š `sandbox.preload`ï¼Œåœ¨ `startApp` æ—¶ä¼šé€šè¿‡ `await` ç¡®ä¿é¢„åŠ è½½å·²å®Œæˆæ‰èƒ½ç»§ç»­åŠ è½½åº”ç”¨ï¼Œè¿™ç§æ–¹å¼å’Œ `qiankun` ä¸­çš„ `frameworkStartedDefer` åŸç†æ˜¯ä¸€æ ·çš„

#### 3. é¢„åŠ è½½å¾®ä»»åŠ¡ `runPreload`

- ä½¿ç”¨ `iframeWindow` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `beforeLoad`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/lifecycle.html#beforeload)]
- é€šè¿‡ `importHTML` è·å–åº”ç”¨èµ„æºï¼Œæ­¤æ—¶èµ„æºä¸­çš„æ ·å¼å’Œ `script` éƒ½æ›¿æ¢æˆæ³¨é‡Š [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
- é€šè¿‡ `processCssLoader` å¤„ç† `css-loader` å¹¶åŠ è½½èµ„æºä¸­çš„é™æ€æ ·å¼æ›¿æ¢å¯¹åº”æ³¨é‡Š [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
- æ¿€æ´»åº”ç”¨ `active` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
- æ ¹æ®é…ç½® `exec` å†³å®šæ˜¯å¦å¯åŠ¨åº”ç”¨ `start` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

é»˜è®¤ `exec` ä¸ä¼šé¢„æ‰§è¡Œï¼š

- ä» `importHTML` æå– `getExternalScripts` å¹¶æ‰§è¡Œï¼Œè§ï¼šå‘æŒ¥çš„ä½œç”¨ [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
- é€šè¿‡ `await` ä¼šå°†æ­¤å‰å·²ç»æäº¤å¾®ä»»åŠ¡çš„é˜Ÿåˆ—ä½œä¸ºä¸Šä¸‹æ–‡åŒæ­¥ä»»åŠ¡æ‰§è¡Œ

#### 4. å¯¹æ¯” `startApp` çš„é…ç½®

å¯¹æ¯”æ–‡æ¡£ä¼šå‘ç° `preloadApp` çš„é…ç½®å’Œ `startApp` å·®åˆ«æŒºå¤§ï¼š

- ä½†æ˜¯å¯ä»¥é€šè¿‡ `setupApp` æå‰ç¼“å­˜é…ç½®ï¼Œæ‰€ä»¥å•çº¯ä»æ–‡æ¡£å¯¹æ¯”å°±å¤±å»æ„ä¹‰äº†
- ä»å£°æ˜å®ä¾‹æ¯”è¾ƒï¼Œ`preloadApp` å’Œ `startApp` æä¾›çš„å‚æ•°æ˜¯ä¸€æ ·çš„
- åªæœ‰ `active` æ¿€æ´»åº”ç”¨æ—¶å‚æ•°å„æœ‰ä¸åŒ

é¢„åŠ è½½ç¼ºå°‘ `loading`ï¼š

- é¢„åŠ è½½çš„åº”ç”¨ä¸éœ€è¦ `loading`ï¼Œè€Œ `startApp` ä¼šé€šè¿‡ `addLoading` åˆ›å»º `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]
- æœ‰æ²¡æœ‰ `loading` å°†ä¼šå†³å®š `renderElementToContainer` æ³¨å…¥èµ„æºæ—¶æ˜¯å¦æ¸…ç©ºæŒ‚è½½èŠ‚ç‚¹ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]

é¢„åŠ è½½ä¸éœ€è¦æä¾›æŒ‚è½½å®¹å™¨ `el`ï¼š

- æ²™ç®±çš„ `iframe` å°†ä½œä¸ºä¸´æ—¶çš„å®¹å™¨ï¼Œåº”ç”¨ä¼šåœ¨ `active` æ¿€æ´»æ—¶æ³¨å…¥ `iframe`
- è€Œæ²™ç®± `iframe` åœ¨é¡µé¢ä¸­æ˜¯ä¸å¯è§çš„ï¼Œå› æ­¤ä¹Ÿçœ‹ä¸åˆ°é¢„åŠ è½½çš„åº”ç”¨
- `startApp` æ—¶ä¼šé€šè¿‡ `active` ä»æ²™ç®± `iframe` ä¸­é”€æ¯ï¼Œæˆ–å–å‡ºæŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ï¼Œè§ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]

å¼•å‘äº†ä¸€ä¸ªæ€è€ƒï¼š

- æŠŠæ‰€æœ‰çš„å­åº”ç”¨å…¨éƒ¨é¢„åŠ è½½åˆ° `iframe` ä¸­ï¼Œä¼šä¸ä¼šå¯¹åŸºåº§çš„ `document` äº§ç”Ÿå½±å“
- ç­”æ¡ˆæ˜¯ä¸ä¼šï¼Œå¯¹æ­¤åšäº†ä¸€ä¸ªæµ‹è¯•ï¼š10w è¡¨å•åœ¨ä¸åŒå®¹å™¨ä¸‹çš„è¡¨ç° [[æŸ¥çœ‹](https://codepen.io/levi0001/pen/xxoVLXx)]

#### 5. é€šè¿‡ `exec` é¢„æ‰§è¡Œ

- ä»… `preloadApp` æ”¯æŒçš„é…ç½®é¡¹ï¼Œ`exec` ä¼šåœ¨é¢„åŠ è½½æ—¶å¯åŠ¨åº”ç”¨ `start`
- å’Œ `startApp` ä¸€æ ·ï¼Œä¹Ÿä¼šå°†å­åº”ç”¨ä¸­çš„ `script` æ’å…¥æ²™ç®± `iframe`ï¼Œè°ƒç”¨ `mount` ç­‰ç›¸å…³äº‹ä»¶å’Œæ–¹æ³•

åœ¨ `micro-app` ä¸­ä¹Ÿæœ‰é¢„åŠ è½½ï¼ŒåŒºåˆ«åœ¨äºï¼š

| åˆ†ç±»                         | `micro-app`                                                  | `wujie`                                                  |
| ---------------------------- | ------------------------------------------------------------ | -------------------------------------------------------- |
| åŠ è½½æ–¹å¼                     | é€šè¿‡ `start` é…ç½® `preFetchApps`ï¼Œæˆ–é€šè¿‡ `microApp.preFetch` | åªèƒ½é€šè¿‡ `preloadApp`                                    |
| ä»…åŠ è½½é™æ€èµ„æº               | æ”¯æŒ                                                         | ä¸æ”¯æŒ                                                   |
| å°†è½½é™æ€èµ„æºè§£ææˆå¯æ‰§è¡Œä»£ç  | è§£æå¹¶å¤„ç†èµ„æºï¼Œä¸æ¸²æŸ“                                       | å°†èµ„æºä¸­çš„ `script` å’Œæ ·å¼æ›¿æ¢æˆæ³¨é‡Šï¼Œæš‚å­˜åœ¨æ²™ç®±ä¸­ä¸å¯è§ |
| æ‰§è¡Œä»£ç å¹¶åœ¨åå°æ¸²æŸ“         | æ”¯æŒ                                                         | `active` æ³¨å…¥èµ„æºï¼Œ`start` å¯åŠ¨åº”ç”¨                      |
| å…³é—­æ²™ç®±å’Œæ ·å¼ä½œç”¨åŸŸ         | å¯é€‰                                                         | ä¸æ”¯æŒ                                                   |
| å…³é—­å­åº”ç”¨è¯·æ±‚çš„è‡ªåŠ¨è¡¥å…¨     | å¯é€‰                                                         | ä¸æ”¯æŒ                                                   |

- `micro-app` é¢„åŠ è½½å‚è€ƒï¼Œè§ï¼š`microApp.start` - æ³¨ â‘¥ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#microappstart-%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8)]
- `micro-app` é¢„æ‰§è¡Œä¸»è¦ä½“ç°åœ¨æ²™ç®±å¯¹é¢„æ¸²æŸ“çš„å¤„ç†ï¼Œè§ï¼š2.3. `WithSandBox` é»˜è®¤æ²™ç®± - çœ‹é¢„æ¸²æŸ“ç›¸å…³éƒ¨åˆ† [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#23-withsandbox-%E9%BB%98%E8%AE%A4%E6%B2%99%E7%AE%B1)]

#### 6.é¢„åŠ è½½ä¸­çš„ `bug`

**é—®é¢˜ 1ï¼š`activated` é‡å¤è°ƒç”¨**

- é¢„åŠ è½½ `alive` æ¨¡å¼çš„åº”ç”¨ï¼Œé»˜è®¤ `exec` ä¸é¢„æ‰§è¡Œï¼Œåœ¨ `startApp` å¯åŠ¨åº”ç”¨çš„æ—¶å€™ç”Ÿå‘½å‘¨æœŸ `activated` ä¼šè°ƒç”¨ 2 æ¬¡

å“ª 2 æ¬¡ï¼š

- `start` åº”ç”¨æ—¶é˜Ÿåˆ—æ‰§è¡Œ `mount` è°ƒç”¨ 1 æ¬¡
- `start` ä¹‹åè¿”å› `destory` å‰è°ƒç”¨ 1 æ¬¡

**é—®é¢˜ 2ï¼šç¼ºå¤±å¿…è¦çš„å‚æ•°åˆ¤æ–­**

- è§ï¼š`startApp` çš„ `bug` [[æŸ¥çœ‹](#4-startapp-çš„-bug)]

#### 7.é¢„åŠ è½½çš„æ„ä¹‰

é¢„åŠ è½½ä¼˜åŒ–æœ‰ 4 ç‚¹ï¼š

1. æå‰ç¼“å­˜åº”ç”¨å…¥å£èµ„æºï¼ŒåŠ è½½å¹¶ç¼“å­˜èµ„æºä¸­çš„æ ·å¼å’Œ `script` [[æŸ¥çœ‹](#2-èµ„æºç¼“å­˜é›†åˆ)]
2. æå‰å°† `template` æ³¨å…¥æ²™ç®± `body` ä½œä¸ºä¸´æ—¶å®¹å™¨ï¼Œè§ï¼š`active` [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]
3. æå‰å°† `script` æ³¨å…¥æ²™ç®± `head`ï¼Œè§ï¼š`start` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
4. æå‰æ”¶é›†æ ·å¼å…ƒç´ æ‰“è¡¥ä¸ï¼Œè§ï¼š`styleSheetElements` [[æŸ¥çœ‹](#2-stylesheetelements-æ”¶é›†æ ·å¼è¡¨)]

ä¸åŒæ¨¡å¼ä¸‹é¢„åŠ è½½å¯¹åº”çš„ä¼˜åŒ–ç‚¹ï¼š

| æ¨¡å¼    | é¢„åŠ è½½ | é¢„æ‰§è¡Œ  |
| ------- | ------ | ------- |
| `alive` | 1ã€2   | 1ã€2ã€3 |
| `umd`   | 1      | 1ã€3ã€4 |
| é‡å»º    | 1      | 1       |

- `umd` å’Œé‡å»ºæ¨¡å¼é¢„åŠ è½½å `startApp` ä¼šé”€æ¯å®ä¾‹ï¼Œåªèƒ½ç”¨äºæå‰ç¼“å­˜èµ„æº
- `umd` é¢„æ‰§è¡Œå `startApp` ä¼šæ¸…ç©ºå®¹å™¨é‡æ–°æ³¨å…¥èµ„æº
- `umd` æ¨¡å¼éœ€è¦ç”¨åˆ° `styleSheetElements`ï¼Œå…¶ä»–æ¨¡å¼ä¸éœ€è¦

é™¤æ­¤ä¹‹å¤–å¯ä»¥é€šè¿‡ `setupApp` æå‰ç¼“å­˜é…ç½®ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/setupApp.html)]

- è¿™æ ·é¿å…é¢„åŠ è½½å’Œå¯åŠ¨åº”ç”¨æ—¶é‡å¤å¡«å†™é…ç½®ä¿¡æ¯

### `WuJie` åº”ç”¨ç±»

ç›®å½•ï¼š`sandbox.ts` - `WuJie` [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L50)]

ç”¨äºåˆ›å»ºåº”ç”¨å®ä¾‹ï¼Œå’Œ `micro-app` çš„ `CreateApp` çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#createapp-%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E7%B1%BB)]ï¼š

| åˆ†ç±»           | `micro-app`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `wujie`                                                                                                             |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------- |
| åˆ›å»ºå®ä¾‹       | `CreateApp`ï¼šåº”ç”¨å®ä¾‹ç±» [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#createapp-%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E7%B1%BB)]                                                                                                                                                                                                                                                                                                                                                                           | `WuJie`ï¼šåº”ç”¨å®ä¾‹ç±»ï¼Œä¹Ÿæ˜¯æ²™ç®±å®ä¾‹ç±»                                                                                 |
| æ˜ å°„è¡¨         | `appInstanceMap` åº”ç”¨å®ä¾‹æ˜ å°„è¡¨ï¼Œå’Œç»„ä»¶æ˜ å°„è¡¨ä¸åŒ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `idToSandboxCacheMap` å®ä¾‹æ˜ å°„è¡¨ï¼Œå¯ä»¥é€šè¿‡åº”ç”¨åä»æ˜ å°„è¡¨è·å–å®ä¾‹ [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)] |
| æ˜ å°„è¡¨æ·»åŠ æ–¹å¼ | `appInstanceMap.set`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `addSandboxCacheWithWujie` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]                                       |
| åŠ è½½èµ„æº       | è‡ªåŠ¨ï¼šæ„é€ å‡½æ•°è°ƒç”¨ `loadSourceCode` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#11-loadsourcecode-%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90)]                                                                                                                                                                                                                                                                                                                                                                | æ‰‹åŠ¨ï¼šé€šè¿‡ `importHTML` ç­‰æ–¹æ³•è·å– `template`ï¼Œä¹‹åå†é€šè¿‡ `active` æ³¨å…¥èµ„æºåˆ°å®¹å™¨ä¸­ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]     |
| å¯åŠ¨æ²™ç®±       | æ„é€ å‡½æ•°è°ƒç”¨ `createSandbox` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#21-createsandbox-%E5%88%9B%E5%BB%BA%E6%B2%99%E7%AE%B1)]                                                                                                                                                                                                                                                                                                                                                                        | æ„é€ å‡½æ•°è°ƒç”¨ `iframeGenerator` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]                                            |
| æ²™ç®± `proxy`   | `proxy`ã€`iframe`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `iframe` - `proxy` æˆ–è€…é™çº§æ—¶ä»…ç”¨ `iframe` [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]                                                |
| æ‰‹åŠ¨ `start`   | ä¸æ”¯æŒæ‰‹åŠ¨å¯åŠ¨                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `startApp` æˆ– `preloadApp` æ—¶è°ƒç”¨åº”ç”¨ `start` æ–¹æ³• [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]                                       |
| `mount` åº”ç”¨   | è‡ªåŠ¨ï¼šç”±ç»„ä»¶æˆ–èµ„æºåŠ è½½å®Œæ¯•å†³å®šï¼Œåœ¨ `mount` ä¸­ä¼š `start` æ²™ç®± [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#32-mount-%E6%8C%82%E8%BD%BD%E5%BA%94%E7%94%A8)]                                                                                                                                                                                                                                                                                                                                                | ä»…æ”¯æŒç”± `start` æ–¹æ³•é€šè¿‡é˜Ÿåˆ—æ‰§è¡ŒæŒ‚è½½ [[æŸ¥çœ‹](#-mount-æŒ‚è½½åº”ç”¨)]                                                    |
| `unmount` åº”ç”¨ | ç”±ç»„ä»¶ `disconnectedCallback` å‘èµ· [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#22-disconnectedcallback-%E5%8D%B8%E8%BD%BD%E7%BB%84%E4%BB%B6)]                                                                                                                                                                                                                                                                                                                                                           | ç»„ä»¶ `disconnectedCallback` [[æŸ¥çœ‹](#disconnectedcallback-å¸è½½ç»„ä»¶)]ã€æ‰‹åŠ¨é”€æ¯ `destroy` [[æŸ¥çœ‹](#å…¶ä»–)]            |
| å¤æ‚åº¦         | åˆ†äº† 3 ç±»ï¼Œç»„ä»¶å®ä¾‹ï¼š`MicroAppElement` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#defineelement-%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%84%E4%BB%B6-microappelement)]ï¼Œåº”ç”¨å®ä¾‹ï¼š`CreateApp` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#createapp-%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E7%B1%BB)]ï¼Œæ²™ç®±å®ä¾‹ï¼š`IframeSandbox` æˆ– `WithSandBox` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#21-createsandbox-%E5%88%9B%E5%BB%BA%E6%B2%99%E7%AE%B1)] | åªè¦å…³å¿ƒ `WuJie` åº”ç”¨å®ä¾‹ã€ç»„ä»¶å®ä¾‹å‡ ä¹å¯ä»¥å¿½ç•¥                                                                     |
| ä¼˜ç‚¹           | æ”¯æŒå¤šç§éš”ç¦»æ–¹æ¡ˆï¼Œè‡ªåŠ¨åŠ è½½èµ„æºã€é…ç½®æ²™ç®±ã€æŒ‚è½½åº”ç”¨                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ç®€å•ï¼Œåªæœ‰ `iframe` ä½œä¸ºæ²™ç®±å¤©ç„¶éš”ç¦»ï¼Œæ”¯æŒå®¹å™¨é™çº§å¤„ç†                                                              |
| ç¼ºç‚¹           | è¿‡äºå¤æ‚ï¼Œä»è¯­æ„ä¸Šçœ‹æœ‰çš„æ–¹æ³•åœ¨ 3 ä¸ªå®ä¾‹ä¸Šç›¸äº’é‡å ï¼Œå®¹æ˜“æ··æ·†ï¼›ä¸æ”¯æŒå®¹å™¨é™çº§å¤„ç†                                                                                                                                                                                                                                                                                                                                                                                                                                                      | è¿‡äºé›¶æ•£ï¼Œç¼ºä¹é€»è¾‘æŠ½è±¡åˆ†ç¦»ï¼Œæºç  `bug` æœ‰ç‚¹å¤š                                                                       |

> æ— è®ºæ˜¯ `wujie` è¿˜æ˜¯ `micro-app` åœ¨è§£è¯»çš„åˆ†æ”¯æºç ä¸­éƒ½å­˜åœ¨ä¸åŒçš„é€»è¾‘é—®é¢˜

#### ğŸ“ `constructor` æ„é€ å‡½æ•°

#### 1. `inject` æ³¨å…¥å­åº”ç”¨ 3 ä¸ªå¯¹è±¡ï¼š

- `idToSandboxMap`ï¼š`appInstanceMap` åº”ç”¨å®ä¾‹æ˜ å°„è¡¨ [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]
- `appEventObjMap`ï¼š`EventBus` äº‹ä»¶æ˜ å°„è¡¨ [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]
- `mainHostPath` ä¸»åº”ç”¨ `host`

è¿™é‡Œåšäº†ä¸ªåˆ¤æ–­ï¼š

| æ‰€åœ¨ç¯å¢ƒ                 | åµŒå¥—æƒ…å†µ   | æ³¨å…¥æ–¹å¼                                               |
| ------------------------ | ---------- | ------------------------------------------------------ |
| åŸºåº§åˆ›å»ºåº”ç”¨å®ä¾‹         | ä½œä¸ºå­åº”ç”¨ | é€šè¿‡ `window.__WUJIE.inject` ä»ä¸Šä¸€å±‚è·å–æ•´ä¸ªæ³¨å…¥å¯¹è±¡  |
| åŸºåº§åˆ›å»ºåº”ç”¨å®ä¾‹         | æœ€é¡¶å±‚åŸºåº§ | å£°æ˜æœ€åˆè¦æ³¨å…¥çš„å¯¹è±¡ `this.inject`                     |
| å­åº”ç”¨é€šè¿‡ `window` è°ƒç”¨ | ä½œä¸ºå­åº”ç”¨ | `window.__WUJIE.inject[name]` ä»ä¸Šä¸€å±‚è·å–å¯¹åº”çš„æ˜ å°„è¡¨ |

> è¿™æ ·æ— è®ºæ˜¯å­åº”ç”¨è¿˜æ˜¯åŸºåº§ï¼Œæœ€ç»ˆæ‹¿åˆ°çš„ `inject` å¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªï¼Œè§ï¼š`appEventObjMap` æµç¨‹å›¾ [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]

#### 2. æå–é…ç½®åˆå§‹åŒ–å±æ€§

è§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]ï¼Œåˆ—ä¸¾å‡ ä¸ªå…³é”®å±æ€§ï¼š

**`degrade` ä¸»åŠ¨é™çº§**

- ç”±é…ç½®æä¾›ï¼Œå¦‚æœæ²¡æœ‰æä¾›ä¹Ÿä¼šæ ¹æ®å½“å‰ç¯å¢ƒå†³å®šæ˜¯å¦é‡‡ç”¨é™çº§æ–¹æ¡ˆ

**`plugins` æ’ä»¶ç³»ç»Ÿ**

- é€šè¿‡ `getPlugins` æ‹å¹³é…ç½®ï¼Œå¹¶åˆå¹¶é»˜è®¤çš„æ’ä»¶è¿”å›ä¸€ä¸ªæ•°ç»„

**`bus` äº‹ä»¶é€šä¿¡**

- é€šè¿‡ `EventBus` è¿›è¡Œé€šä¿¡ï¼Œ`EventBus` ä¾èµ– `appEventObjMap` ç¡®ä¿çˆ¶å­é€šä¿¡å¯¹è±¡å”¯ä¸€æ€§ï¼Œè§ï¼šå­˜å‚¨ `eventBus` æ‰˜ç®¡çš„äº‹ä»¶ [[æŸ¥çœ‹](#2-appeventobjmapå­˜å‚¨-eventbus-æ‰˜ç®¡çš„äº‹ä»¶)]
- åŒæ—¶å°† `bus` èµ‹å€¼ç»™ `provide` å¯¹è±¡ï¼Œä½¿å­åº”ç”¨å†…éƒ¨å¯ä»¥é€šè¿‡ `window.$wujie?.bus` è¿›è¡Œé€šä¿¡

#### 3. åˆ›å»ºæ²™ç®± `iframe`

- é€šè¿‡ `appRouteParse` æå– `urlElement`ã€`appHostPath`ã€`appRoutePath` [[æŸ¥çœ‹](#approuteparse-æå–é“¾æ¥)]
- è·å–åŸºåº§çš„ `host`ï¼š`mainHostPath`
- é€šè¿‡ `iframeGenerator` åˆå§‹åŒ–æ²™ç®± `iframe` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]

#### 4. åˆ›å»ºä»£ç†

æ ¹æ® `degrade` å†³å®šåˆ›å»ºï¼š

- `localGenerator` é™çº§ä»£ç† [[æŸ¥çœ‹](#-localgenerator-é™çº§æƒ…å†µä¸‹çš„ä»£ç†)]
- `proxyLocation` ä»£ç† [[æŸ¥çœ‹](#-proxygenerator-éé™çº§æƒ…å†µä¸‹çš„ä»£ç†)]

åŒºåˆ«ï¼š

| åˆ†ç±»       | `degrade` é™çº§ä»£ç†  | `proxyLocation` ä»£ç† |
| ---------- | ------------------- | -------------------- |
| `window`   | æ²™ç®± `iframeWindow` | `proxyWindow`        |
| `document` | `proxyDocument`     | `proxyDocument`      |
| `location` | æ²™ç®± `location`     | `proxyLocation`      |

- é€šè¿‡æµç¨‹å›¾äº†è§£ä¸¤ä¸ªä»£ç†çš„åŒºåˆ« [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]
- `proxyDocument` çš„å·®åˆ«ï¼Œè§ï¼š`localGenerator` - `proxyDocumennt` [[æŸ¥çœ‹](#1-åŠ«æŒç©ºå¯¹è±¡ä½œä¸º-proxydocument)]
- ä»£ç†å¯¹è±¡çš„é—®é¢˜ï¼Œè§ï¼š`proxyLocation` çš„é—®é¢˜ [[æŸ¥çœ‹](#proxylocation-çš„é—®é¢˜)]

æµç¨‹ï¼š

- é€šè¿‡ä»£ç†æ–¹æ³•æ‹¿åˆ° `proxyWindow`ã€`proxyDocument`ã€`proxyLocation`ï¼ˆé™çº§æ¨¡å¼æ²¡æœ‰ `proxyWindow`ï¼‰
- å°†è¿™äº›å¯¹è±¡ç»‘å®šåœ¨ `wujie` å®ä¾‹ä¸­æ–¹ä¾¿è°ƒç”¨ï¼Œè§ï¼šä»£ç†åœ¨å“ªè°ƒç”¨ [[æŸ¥çœ‹](#proxywindow-åœ¨å“ªè°ƒç”¨)]

#### 5. å°†å®ä¾‹æ·»åŠ åˆ°æ˜ å°„è¡¨

åœ¨æ·»åŠ å®ä¾‹åˆ°æ˜ å°„è¡¨ä¹‹å‰è¦å°† `proxyLocation` ç»‘å®šåœ¨ `provide`ï¼Œè¿™æ ·ï¼š

- å­åº”ç”¨å°±å¯ä»¥é€šè¿‡ `window.$wujie.location` å»è°ƒç”¨ `proxyLocation`
- åœ¨ `WuJie` æ„é€ å‡½æ•°ä¸­ `provide` ç»‘å®šäº† `bus` å’Œ `location`ï¼Œè§ï¼šå®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

æœ€åé€šè¿‡ `addSandboxCacheWithWujie` å°†å½“å‰å®ä¾‹æ·»åŠ åˆ°æ˜ å°„è¡¨ç¼“å­˜èµ·æ¥ï¼Œè§ï¼š`idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]

#### ğŸ“ `active` æ¿€æ´»åº”ç”¨

å‚æ•°åªæœ‰ 1 ä¸ª `options` å¯¹è±¡ï¼ŒåŒ…å«ä»¥ä¸‹å±æ€§ï¼š

- `template`ï¼šæ³¨å…¥åˆ°å®¹å™¨çš„åº”ç”¨èµ„æº
- `el`ï¼šå®¹å™¨æŒ‚è½½èŠ‚ç‚¹ï¼Œé¢„åŠ è½½æ—¶ä¸æä¾›æŒ‚è½½èŠ‚ç‚¹ï¼Œå®¹å™¨æŒ‚è½½åˆ°æ²™ç®± `body`
- `props`ï¼šéœ€è¦ä¼ å…¥åº”ç”¨çš„æ•°æ®
- `alive`ï¼šæ˜¯å¦ç”¨ä¿æ´»æ¨¡å¼æ¿€æ´»åº”ç”¨
- `fetch`ï¼šè‡ªå®šä¹‰åŠ è½½æ–¹æ³•ï¼Œä¸æä¾›é‡‡ç”¨å…¨å±€ `window` çš„ `fetch` æ–¹æ³•
- `replace`ï¼šç”¨äºæ›¿æ¢èµ„æºï¼Œå­˜åœ¨ `bug`ï¼Œè§ï¼šé€šè¿‡é…ç½®æ›¿æ¢èµ„æº [[æŸ¥çœ‹](#é€šè¿‡é…ç½®æ›¿æ¢èµ„æº)]

é™¤æ­¤ä¹‹å¤–ï¼Œä»¥ä¸‹å±æ€§ç”¨äºåŒæ­¥è·¯ç”±ï¼š

| åŒæ­¥æ–¹æ³•                                                           | `sync`                                      | `url`        | `prefix`   |
| ------------------------------------------------------------------ | ------------------------------------------- | ------------ | ---------- |
| `syncUrlToIframe` [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)] | å†³å®šåŒæ­¥è·¯ç”±æ¥è‡ªå½“å‰ `url` è¿˜æ˜¯èµ„æºå…¥å£é“¾æ¥ | èµ„æºå…¥å£é“¾æ¥ | çŸ­è¿æ¥é›†åˆ |
| `syncUrlToWindow` [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)] | å†³å®šæ˜¯å¦åŒæ­¥è·¯ç”±                            | ä¸éœ€è¦       | çŸ­è¿æ¥é›†åˆ |

> åªæœ‰ `url` æ˜¯å¿…é€‰å±æ€§ï¼Œå…¶ä»–éƒ½å¯é€‰ï¼›`active` çš„ `url` å­˜åœ¨ `bug`ï¼Œè§ï¼šç‰¹æ®Šå±æ€§ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)]

åˆ† 5 éƒ¨åˆ†ï¼š

1. æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯ [[æŸ¥çœ‹](#1-æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯)]
2. å¤„ç†å­åº”ç”¨ `fetch` [[æŸ¥çœ‹](#2-åŠ¨æ€ä¿®æ”¹-fetch)]
3. å¤„ç†å­åº”ç”¨è·¯ç”±åŒæ­¥ [[æŸ¥çœ‹](#3-åŒæ­¥è·¯ç”±)]
4. å°† `template` æ³¨å…¥å®¹å™¨ï¼Œå¦‚æœå®¹å™¨ä¸å­˜åœ¨åˆ™éœ€è¦åˆ›å»ºæ–°å®¹å™¨ [[æŸ¥çœ‹](#4-åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº)]
5. å®Œæˆæ¿€æ´»åº”ç”¨ï¼šæ³¨å…¥ `template`ã€æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#5-å®Œæˆæ¿€æ´»åº”ç”¨)]

æ³¨å…¥å®¹å™¨åˆ†ä¸º 3 ç§æƒ…å†µï¼š

1. `degrade` ä¸»åŠ¨é™çº§ï¼šæ— è®ºåˆ‡æ¢åº”ç”¨è¿˜æ˜¯åˆå§‹åŒ–éƒ½ä¼šåˆ›å»ºæ–°çš„ `iframe` å®¹å™¨
2. `shadowRoot` åˆ‡æ¢åº”ç”¨ï¼šåªæœ‰ `alive` æ¨¡å¼æ›´æ¢æŒ‚è½½èŠ‚ç‚¹ï¼Œå…¶ä»–æ¨¡å¼é‡æ–°æ³¨å…¥èµ„æº
3. `shadowRoot` åº”ç”¨åˆå§‹åŒ–ï¼šåˆ›å»ºå®¹å™¨

æœ‰ 2 ç§æƒ…å†µä¼š `active` æ¿€æ´»åº”ç”¨ï¼š

- `startApp` æ— è®ºæ˜¯åˆ‡æ¢åº”ç”¨è¿˜æ˜¯åˆå§‹åŒ–å®åŠ› [[æŸ¥çœ‹](#startapp-å¯åŠ¨æµç¨‹)]
- `preloadApp` é¢„åŠ è½½åº”ç”¨ [[æŸ¥çœ‹](#preloadapp-é¢„åŠ è½½æµç¨‹)]

åœ¨ `active` æ¿€æ´»åº”ç”¨æ—¶å®¹å™¨èŠ‚ç‚¹å˜æ›´æœ‰ 4 ç§æƒ…å†µï¼š

| åœºæ™¯                     | å®¹å™¨        | `degrade` é™çº§ | `el` å®¹å™¨æŒ‚è½½ç‚¹ | å®¹å™¨æŒ‚è½½ä½ç½®    |
| ------------------------ | ----------- | -------------- | --------------- | --------------- |
| é¢„åŠ è½½åº”ç”¨ã€åˆæ¬¡å¯åŠ¨åº”ç”¨ | `iframe`    | `true`         | æ²¡æœ‰            | æ²™ç®± `iframe`   |
| å¯åŠ¨åº”ç”¨ã€æ¯æ¬¡åˆ‡æ¢åº”ç”¨   | `iframe`    | `true`         | å·²æä¾›          | `el` å®¹å™¨æŒ‚è½½ç‚¹ |
| é¢„åŠ è½½åº”ç”¨ã€åˆæ¬¡å¯åŠ¨åº”ç”¨ | `shadowDom` | `false`        | æ²¡æœ‰            | æ²™ç®± `iframe`   |
| å¯åŠ¨åº”ç”¨ã€æ¯æ¬¡åˆ‡æ¢åº”ç”¨   | `shadowDom` | `false`        | å·²æä¾›          | `el` å®¹å™¨æŒ‚è½½ç‚¹ |

> æ¯æ¬¡ `active` ä¼šæ ¹æ®å½“å‰æƒ…å†µæ¥é€‰æ‹©å®¹å™¨å’ŒæŒ‚è½½çš„èŠ‚ç‚¹ï¼Œå¯¹äºå¦‚é¢„åŠ è½½å `startApp` è¿™æ ·çš„æƒ…å†µï¼Œå»ºè®®æŸ¥çœ‹ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]

#### 1. æ›´æ–°é…ç½®åº”ç”¨ä¿¡æ¯

ç¬¬ä¸€æ­¥ï¼šç”¨å‚æ•° `options` æ›´æ–°å®ä¾‹ï¼Œéƒ¨åˆ†å±æ€§ï¼Œè§ï¼šå®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

éœ€è¦é¢å¤–è¯´æ˜çš„å±æ€§ï¼š

- `hrefFlag`ï¼šè®¾ç½®ä¸º `false` è¡¨æ˜å½“å‰å®¹å™¨æ¥è‡ªåŸºåº§ï¼Œè§ï¼šç‰¹æ®Šå±æ€§ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)]
- `provide`ï¼šç»‘å®šåœ¨ `this.provide.props`ï¼Œåº”ç”¨ä¸­é€šè¿‡ `window.$wujie.props` è·å–
- `activeFlag`ï¼šè¡¨æ˜åº”ç”¨å·²æ¿€æ´»

ç¬¬äºŒæ­¥ï¼šç­‰å¾… `iframe` åˆå§‹åŒ– `await this.iframeReady`

è§ `iframeGenerator` - `iframeReady` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]

éœ€è¦ç­‰å¾… `iframeReady` çš„åœºæ™¯ï¼š

- é™¤äº† `alive` å’Œ `umd` æ¨¡å¼åˆ‡æ¢åº”ç”¨æ—¶ `iframeReady` å·²åŠ è½½å®Œæ¯•ï¼Œå…¶ä»–æƒ…å†µéƒ½æœ‰å¯èƒ½éœ€è¦ç­‰å¾…
- å¦‚æœåŠ è½½é¡ºåˆ©çš„è¯ï¼Œ`iframeReady` ä¼šåœ¨ `active` ä¹‹å‰åŠ è½½å®Œæ¯•ï¼Œè§ï¼š`iframeGenerator` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]

> åœ¨ `qiankun` ä¸­æœ‰ä¸ª `frameworkStartedDefer`ï¼Œç”¨é€”æ˜¯ä¸€æ ·çš„ï¼Œè§ï¼š`startSingleSpa` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-qiankun-substrate?tab=readme-ov-file#23-startsinglespa-%E5%90%AF%E5%8A%A8%E5%BA%94%E7%94%A8)]
>
> - éƒ½æ˜¯å…ˆå‘èµ·ä¸€ä¸ªå¾®ä»»åŠ¡åï¼Œç»§ç»­æ‰§è¡Œåç»­æµç¨‹ï¼›
> - åœ¨å¯åŠ¨åº”ç”¨æ—¶ä¼šç­‰å¾…å¾®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œæ‰å¼€å§‹æŒ‚è½½åº”ç”¨

#### 2. åŠ¨æ€ä¿®æ”¹ `fetch`

ä»…é™æä¾› `fetch` é…ç½®ï¼ŒåŸå› ï¼š

- é…ç½®é‡å†™ `fetch` å‡½æ•°æ—¶ï¼šç›¸å¯¹è·¯å¾„é€šè¿‡åŸºåº§çš„ `url` è¿›è¡Œè¡¥å…¨
- å­åº”ç”¨ `fetch` æ—¶ï¼šç›¸å¯¹è·¯å¾„é€šè¿‡æ²™ç®±ä¸­çš„ `base` å…ƒç´ è¿›è¡Œè¡¥å…¨

äºæ˜¯ï¼š

- é‡å†™ `fetch` å‡½æ•°é€šè¿‡ `getAbsolutePath` æŒ‡å‘ `proxyLocation` [[æŸ¥çœ‹](#getabsolutepathè·å–ç»å¯¹è·¯å¾„)]
- å°†é‡å†™çš„ `fetch` ç»‘å®šåˆ° `iframeWindow` å’Œåº”ç”¨å®ä¾‹ä¸­

ä½†æ˜¯åŸºåº§ç”¨ä¸åˆ°ï¼ŒåŠ è½½èµ„æºé€šå¸¸æ˜¯ç»å¯¹è·¯å¾„ï¼š

- `importHTML`ï¼šæå–åº”ç”¨èµ„æºï¼Œç”¨çš„ `fetch` è¿˜æœªæŒ‡å‘ `proxyLocation`
- `processCssLoaderForTemplate`ï¼šæ‰‹åŠ¨åŠ è½½æ ·å¼ï¼Œè¿™é‡Œæ˜¯é’ˆå¯¹æ‰€æœ‰åº”ç”¨çš„ï¼Œé€šå¸¸ä¼šæŒ‡å®šä¸€ä¸ªå…¬å…±èµ„æºè·¯å¾„

> å½“é…ç½®æ²¡æœ‰æä¾› `fetch` æ—¶ï¼Œä¼šé»˜è®¤é€šè¿‡ `window.fetch`

å­åº”ç”¨ä¸éœ€è¦å˜æ›´è·¯å¾„ï¼š

- å­åº”ç”¨ `fetch` æ˜¯ç›¸å¯¹è·¯å¾„æ—¶ï¼Œé€šè¿‡ `base` å…ƒç´ è‡ªåŠ¨è½¬æ¢æˆç»å¯¹é“¾æ¥

åªé€‚åˆé€šè¿‡åŸºåº§ä¿®æ”¹ `fetch` è¿™ä¸€åœºæ™¯ï¼š

- å› ä¸º `fetch` æ˜¯åœ¨åŸºåº§çš„ä½œç”¨åŸŸä¸‹ï¼Œæ‹¿ä¸åˆ°åº”ç”¨çš„ `base` å…ƒç´ 
- å¦‚æœå­åº”ç”¨å‘å‡ºæ¥çš„ `fetch` è¯·æ±‚æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œéœ€è¦é€šè¿‡ `getAbsolutePath` è½¬æ¢ä¸€ä¸‹è·¯å¾„

æ¯”å¦‚è¯´ï¼š

- é€šè¿‡åŸºåº§è·å– `authorization` ç»Ÿä¸€é‡å†™æ‰€æœ‰å­åº”ç”¨çš„ `fetch` é‰´æƒ
- è€Œå¯¹äºå­åº”ç”¨ä¸­é€šè¿‡ç›¸å¯¹è·¯å¾„è·å–æœ¬åœ°èµ„æºçš„è¯·æ±‚ï¼Œä¼šè½¬æ¢æˆå’Œåº”ç”¨å¯¹åº”çš„è·¯å¾„

å…³äº `fetch` ç­‰ç›¸å…³çš„é“¾æ¥ï¼Œè§ï¼šå­åº”ç”¨ä¸­çš„é“¾æ¥æŒ‡å‘ [[æŸ¥çœ‹](#å­åº”ç”¨ä¸­çš„é“¾æ¥æŒ‡å‘)]

#### 3. åŒæ­¥è·¯ç”±

æ‰§è¡Œè¿‡ç¨‹ï¼Œä»å·¦åˆ°å³ï¼š

| æ‰§è¡Œæ–¹å¼                    | `syncUrlToIframe` | `syncUrlToWindow` |
| --------------------------- | ----------------- | ----------------- |
| `alive` é¢„æ‰§è¡Œ              | æ‰§è¡Œ              | æ‰§è¡Œ              |
| `alive` é¢„æ‰§è¡Œå `startApp` | ä¸æ‰§è¡Œ            | æ‰§è¡Œ              |
| `alive` åˆ‡æ¢åº”ç”¨            | ä¸æ‰§è¡Œ            | æ‰§è¡Œ              |
| å…¶ä»–æ¨¡å¼                    | æ‰§è¡Œ              | æ‰§è¡Œ              |

- `syncUrlToIframe`ï¼šåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨ [[æŸ¥çœ‹](#syncurltoiframeåŒæ­¥ä¸»åº”ç”¨è·¯ç”±åˆ°å­åº”ç”¨)]
- `syncUrlToWindow`ï¼šåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨ [[æŸ¥çœ‹](#syncurltowindowåŒæ­¥å­åº”ç”¨è·¯ç”±åˆ°ä¸»åº”ç”¨)]

åµŒå¥—é¡ºåºï¼š

- å…ˆä»åŸºåº§è‡³ä¸Šè€Œä¸‹ï¼Œç„¶ååº”ç”¨ä»ä¸‹å¾€ä¸Š
- åŸºåº§åµŒå¥—åŸºåº§ï¼Œä¹Ÿæ˜¯è¿™æ ·å±‚å±‚ä¼ é€’

> `alive` æ¨¡å¼ä¸éœ€è¦æ‰§è¡Œ `syncUrlToIframe` çš„æƒ…å†µæ˜¯å› ä¸ºåˆå§‹åŒ–æ—¶å·²æ‰§è¡Œï¼Œä¹‹ååªéœ€ç›‘å¬å­åº”ç”¨çš„è·¯ç”±å˜æ›´åŒæ­¥åˆ°ä¸»åº”ç”¨

#### 4. åˆ›å»ºå®¹å™¨æ¸²æŸ“èµ„æº

é€šè¿‡ `template` æ›´æ–° `this.template`ï¼Œä½œä¸ºéœ€è¦æ³¨å…¥å®¹å™¨çš„èµ„æºã€‚éœ€è¦è¯´æ˜çš„æ˜¯ `alive` å’Œ `umd` æ¨¡å¼ï¼Œå®ä¾‹å·²å­˜åœ¨çš„æƒ…å†µä¸‹ `startApp` ä¸éœ€è¦æä¾›èµ„æºã€‚å› ä¸ºåœ¨ `preloadApp` æˆ–é¦–æ¬¡ `startApp` æ—¶ `template` å·²ç»‘å®šåœ¨åº”ç”¨å®ä¾‹ä¸­ã€‚

#### 4.1. `degrade` ä¸»åŠ¨é™çº§æ¸²æŸ“

ç”¨ `iframe` ä½œä¸ºå®¹å™¨ï¼Œåº”ç”¨ä¸­çš„å¼¹çª—ç”±äºåœ¨ `iframe` å†…éƒ¨å°†æ— æ³•è¦†ç›–æ•´ä¸ªé¡µé¢ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/startApp.html#degrade)]

å…³è”å±æ€§ `degradeAttrs`ï¼Œæ–‡æ¡£æ²¡æœ‰è¯´æ˜ï¼š

- åœ¨ `wujie` ä¸­æ‰€æœ‰çš„ `iframe` å®¹å™¨åªè®¾ç½®äº†å®½é«˜ `100%`ï¼Œè¿™å¹¶ä¸èƒ½å¤Ÿé€‚åº”å®é™…æƒ…å†µ
- ä½¿ç”¨è¿™ä¸ªé…ç½®å¯ä»¥é€šè¿‡ `style` é€‚é…å®¹å™¨èŠ‚ç‚¹çš„æ ·å¼
- åŒæ ·é€‚ç”¨äºåŠ«æŒåº”ç”¨çš„ `location.href` çš„ `iframe` ä¸´æ—¶å®¹å™¨ï¼Œè§ï¼š`locationHrefSet` [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]

`degradeAttrs` æ˜¯ä¸€ä¸ªå›ºå®šçš„é…ç½®ï¼Œå¦‚ä½•æ ¹æ®åº”ç”¨é…ç½®ä¸åŒçš„å±æ€§ï¼š

- é€šè¿‡ä¸åŒçš„ç»„ä»¶åˆ†å¼€ `startApp`ï¼Œä»è€Œé…ç½®ä¸åŒçš„å±æ€§
- åŒç†ä¹Ÿé€‚ç”¨äºå…¶ä»–å›ºå®šçš„é…ç½®ä¿¡æ¯ï¼Œéœ€è¦æ ¹æ®ä¸åŒçš„åº”ç”¨åšå‡ºå·®å¼‚åŒ–çš„è¡¨ç°

> æ³¨æ„ï¼šä¸è¦è¯•å›¾é€šè¿‡æ ·å¼å»åŒ¹é…ä¸åŒ `iframe` å®¹å™¨çš„ `id`ï¼Œå› ä¸ºå½“å­åº”ç”¨å‘ç”Ÿé“¾æ¥åŠ«æŒï¼Œæ›¿æ¢ä¸ºä¸´æ—¶çš„åŠ«æŒå®¹å™¨ï¼Œè®¾å®šå¥½çš„æ ·å¼ä¼šéšå®¹å™¨ `id` ä¸€åŒä¸¢å¤±ã€‚

ä¸»åŠ¨é™çº§åˆ† 3 ä¸ªéƒ¨åˆ†ï¼š

1. åˆ›å»º `iframe` å®¹å™¨å¹¶æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹
2. é”€æ¯æ²™ç®±è®°å½•ï¼Œä¸ºåˆ›å»ºçš„ `iframe` æ–°å®¹å™¨æ‰“è¡¥ä¸
3. æ³¨å…¥ `template` åˆ° `iframe` å®¹å™¨ä¸­

ä¸ºäº†ä¾¿äºç†è§£ï¼Œæ•´ä¸ªæ€»ç»“ä¸­å°†å®¹å™¨åŠç›¸å…³å¯¹è±¡åˆ’åˆ†å¦‚ä¸‹ï¼š

- æ²™ç®± `iframe`ï¼šç”¨äºå­˜æ”¾åº”ç”¨ `script` çš„æ²™ç®±ï¼Œè§ï¼š`iframeGenerator` [[æŸ¥çœ‹](#iframegeneratoråˆ›å»ºæ²™ç®±-iframe)]
- `iframe` å®¹å™¨ï¼šé™çº§æ—¶å­˜æ”¾åº”ç”¨èµ„æºçš„å®¹å™¨ï¼Œå…¶ä¸­ `script` ä¼šè¢«æ³¨é‡Š
- åŠ«æŒå®¹å™¨ï¼šé€šè¿‡ `locationHrefSet` åŠ«æŒå­åº”ç”¨ä¸­é€šè¿‡ `location.href` è·³è½¬çš„é¡µé¢ [[æŸ¥çœ‹](#locationhrefsetæ‹¦æˆªå­åº”ç”¨-locationhref)]
- `shadowRoot`ï¼ˆå®¹å™¨ï¼‰ï¼šé»˜è®¤æƒ…å†µä¸‹å­˜æ”¾åº”ç”¨èµ„æºçš„å®¹å™¨ï¼Œå…¶ä¸­ `script` ä¼šè¢«æ³¨é‡Š [[æŸ¥çœ‹](#42-æŒ‚è½½å­åº”ç”¨åˆ‡æ¢åˆå§‹åŒ–é¢„åŠ è½½)]

> ç›¸åº”çš„ `iframeWindow`ã€`iframeBody`ã€`iframeDocument` å…¨éƒ¨ä¸ºæ²™ç®± `iframe` ä¸­çš„å¯¹è±¡

ç¬¬ä¸€æ­¥ï¼šåˆ›å»º `iframe`

- `rawDocumentQuerySelector` è·å–æ²™ç®± `iframeBody`
- `initRenderIframeAndContainer` åˆ›å»º `iframe` å®¹å™¨æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]

`iframe` å®¹å™¨çš„æŒ‚è½½ç‚¹ï¼š

- `el`ï¼š`startApp` æ—¶é€šè¿‡é…ç½®æŒ‡å®š
- `iframeBody`ï¼š`preloadApp` ä¸´æ—¶å­˜æ”¾åœ¨æ²™ç®±ä¸­

> å¦‚æœ `startApp` æ²¡æœ‰æä¾› `el` æŒ‚è½½èŠ‚ç‚¹ï¼Œä¹Ÿä¼šå­˜æ”¾åœ¨æ²™ç®± `iframeBoody` ä¸­ã€‚æ­¤æ—¶åº”ç”¨ä¸ä¼šæŠ¥é”™ä½†ä¸å¯è§ã€‚

ç¬¬äºŒæ­¥ï¼šæ›´æ–°å®¹å™¨ï¼Œé”€æ¯ `iframeBody`

- å°†æŒ‚è½½çš„èŠ‚ç‚¹ç»‘å®šåˆ° `this.el`
- è‹¥æä¾›äº† `el` å®¹å™¨ï¼Œæ¸…ç©º `iframeBody`ï¼Œç¡®ä¿æ¸²æŸ“å®¹å™¨åªæœ‰ 1 ä¸ªï¼Œè§ï¼šå®¹å™¨åœ¨å“ªæ¸…é™¤ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]
- `patchEventTimeStamp`ï¼šä¿®å¤ `vue` çš„ `event.timeStamp` é—®é¢˜
- `onunload`ï¼šå½“é”€æ¯å­åº”ç”¨æ—¶ä¸»åŠ¨ `unmount` å­åº”ç”¨

`this.el` æŒ‚è½½èŠ‚ç‚¹æœ‰å•¥ç”¨ï¼š

- `removeLoading` æ¶ˆé™¤ `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]
- å®ä¾‹ `destroy` æ—¶é€šè¿‡ `clearChild` æ¸…ç©ºæŒ‚è½½èŠ‚ç‚¹ [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]
- `popstate` åé€€æ—¶å°†æ¸²æŸ“å®¹å™¨æ›¿æ¢åŠ«æŒå®¹å™¨æŒ‚è½½åˆ°èŠ‚ç‚¹ï¼Œè§ï¼š`processAppForHrefJump` [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

`onunload` æ˜¯ä¸€ä¸ªåºŸå¼ƒçš„æ–¹æ³•ï¼Œéšæ—¶å¯èƒ½è¢«æµè§ˆå™¨å¼ƒç”¨

- ç›®çš„åº”è¯¥ç”¨äºç‚¹å‡» `iframe` å®¹å™¨ä¸­ç¬¬ä¸‰æ–¹é“¾æ¥ç¦»å¼€å­åº”ç”¨æ—¶æ³¨é”€åº”ç”¨å®ä¾‹

ç¬¬ä¸‰æ­¥ï¼šæ³¨å…¥ `template` åˆ°å®¹å™¨ä¸­

åœ¨é™çº§å¤„ç†è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡ `this.document` æ¥åŒºåˆ†æ˜¯åˆæ¬¡åŠ è½½è¿˜æ˜¯åˆ‡æ¢åº”ç”¨

- `this.document` åœ¨é™çº§çŠ¶æ€ä¸‹æ¯æ¬¡ `active` åº”ç”¨æ—¶ï¼Œç”¨äºè®°å½• `iframe` å®¹å™¨
- `this.document` ä¸»è¦ç”¨äºåŒºåˆ†æ˜¯å¦æ˜¯åˆæ¬¡åŠ è½½ï¼Œä»¥åŠè®°å½•ã€æ¢å¤äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]
- æ— è®ºæ˜¯åˆæ¬¡åŠ è½½è¿˜æ˜¯åˆ‡æ¢åº”ç”¨ï¼Œé™çº§çŠ¶æ€éƒ½ä¼šæ–°å»º `iframe` å®¹å™¨ï¼Œå³ä¾¿ `alive` æ¨¡å¼ä¹Ÿä¸ä¾‹å¤–

æ³¨å…¥ `template` æœ‰ 3 ç§æƒ…å†µï¼š

`åˆ†æ”¯ 1` - `alive` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨

- å°† `this.document` ä¸­çš„ `html` æ ¹å…ƒç´ æ›¿æ¢ `iframe` å®¹å™¨ä¸­çš„ `html` æ ¹å…ƒç´ 
- åœ¨ä¿æ´»åœºæ™¯æ¢å¤æ‰€æœ‰å…ƒç´ äº‹ä»¶ï¼Œè§ï¼šè®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]

`åˆ†æ”¯ 2` - é `alive` æ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨

- é€šè¿‡ `renderTemplateToIframe` å°† `template` æ³¨å…¥åˆ›å»º `iframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe-å®¹å™¨)]
- `recoverDocumentListeners` éä¿æ´»åœºæ™¯éœ€è¦æ¢å¤æ ¹èŠ‚ç‚¹çš„äº‹ä»¶ï¼Œé˜²æ­¢ `react16` ç›‘å¬äº‹ä»¶ä¸¢å¤±ï¼Œè§ï¼šè®°å½•ã€æ¢å¤ `iframe` å®¹å™¨äº‹ä»¶ [[æŸ¥çœ‹](#è®°å½•æ¢å¤-iframe-å®¹å™¨äº‹ä»¶)]

`åˆ†æ”¯ 3` - åˆæ¬¡æ¸²æŸ“

- é€šè¿‡ `renderTemplateToIframe` å°† `template` æ³¨å…¥åˆ›å»º `iframe` [[æŸ¥çœ‹](#rendertemplatetoiframe-æ¸²æŸ“èµ„æºåˆ°-iframe-å®¹å™¨)]

è‡³æ­¤æ•´ä¸ªé™çº§è¿‡ç¨‹å®Œæˆï¼Œç›´æ¥è¿”å›ä¸å†æ‰§è¡Œä¸‹é¢æµç¨‹

#### 4.2. æŒ‚è½½å­åº”ç”¨ï¼šåˆ‡æ¢ã€åˆå§‹åŒ–ã€é¢„åŠ è½½

ç¬¬ä¸€æ­¥ï¼šæŒ‚è½½å®¹å™¨ç”¨åˆ°æŒ‡å®šèŠ‚ç‚¹

`degrade` é™çº§çŠ¶æ€é€šè¿‡ `this.document` æ¥åŒºåˆ†åˆæ¬¡åŠ è½½è¿˜æ˜¯åˆ‡æ¢åº”ç”¨ï¼Œè€Œé»˜è®¤çŠ¶æ€é€šè¿‡ `this.shadowRoot` æ¥åŒºåˆ†ã€‚

æ³¨å…¥ `template` æœ‰ 3 ç§æƒ…å†µï¼š

`åˆ†æ”¯ 1`ï¼šåˆ‡æ¢åº”ç”¨

- é€šè¿‡ `renderElementToContainer` å°† `this.shadowRoot.host` æŒ‚è½½åˆ°æŒ‡å®šèŠ‚ç‚¹ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]
- `alive` æ¨¡å¼ï¼šå®Œæˆåˆ‡æ¢åç›´æ¥è¿”å›ï¼Œä¸å†ç»§ç»­æ‰§è¡Œèµ„æºæ³¨å…¥å®¹å™¨çš„æµç¨‹
- `umd` æ¨¡å¼ï¼šè™½ç„¶å®ä¾‹å­˜åœ¨ `shadowRoot`ï¼Œä½† `active` å‰ä¼šé€šè¿‡ `unmount` æ¸…ç©ºå®¹å™¨ [[æŸ¥çœ‹](#5-å®¹å™¨åœ¨å“ªæ¸…é™¤)]
- é‡å»ºæ¨¡å¼ï¼š`active` å‰ä¼šéšåº”ç”¨ä¸€åŒé”€æ¯ï¼Œä¸å­˜åœ¨ `shadowRoot`ï¼Œä¹Ÿä¸èµ°è¿™ä¸ªåˆ†æ”¯

`åˆ†æ”¯ 2`ï¼šåˆæ¬¡åŠ è½½

- è·å– `iframeBody`ï¼Œå¦‚æœæ²¡æœ‰æä¾›æŒ‚è½½èŠ‚ç‚¹ï¼Œä½œä¸ºå¤‡ç”¨
- é€šè¿‡ `createWujieWebComponent` åˆ›å»ºè‡ªå®šä¹‰ç»„ä»¶ï¼š`wujie-app`
- é€šè¿‡ `renderElementToContainer` å°†åˆ›å»ºçš„ç»„ä»¶æŒ‚è½½åˆ°æŒ‡å®šå®¹å™¨ [[æŸ¥çœ‹](#renderelementtocontainerå°†èŠ‚ç‚¹å…ƒç´ æŒ‚è½½åˆ°å®¹å™¨)]

> `shadowRoot` åœ¨åˆ›å»º `web component` æ—¶å€™ç»‘å®šåˆ°å®ä¾‹ï¼Œè§ï¼š`connectedCallback` [[æŸ¥çœ‹](#connectedcallbackæŒ‚è½½ç»„ä»¶)]

`åˆ†æ”¯ 3`ï¼š é¢„åŠ è½½åº”ç”¨

- é¢„åŠ è½½ä¹Ÿæ˜¯åˆæ¬¡åŠ è½½å’Œ `åˆ†æ”¯ 2` æµç¨‹ä¸€æ¨¡ä¸€æ ·
- ä¸åŒçš„æ˜¯é¢„åŠ è½½ä¸æä¾›æŒ‚è½½èŠ‚ç‚¹ `el`ï¼Œè€Œæ˜¯ç”¨ `iframeBody` ä½œä¸ºä¸´æ—¶æŒ‚è½½èŠ‚ç‚¹
- é¢„åŠ è½½ä¹‹å `startApp` å¦‚æœæ²¡æœ‰é”€æ¯å®ä¾‹çš„æƒ…å†µä¸‹ï¼Œä¼šæŒ‰ç…§ `åˆ†æ”¯ 1` æ‰§è¡Œæµç¨‹

ç¬¬äºŒæ­¥ï¼šæ³¨å…¥ `template` åˆ°å®¹å™¨ä¸­

- é€šè¿‡ `renderTemplateToShadowRoot` å°† `template` æ¸²æŸ“åˆ° `shadowRoot` [[æŸ¥çœ‹](#rendertemplatetoshadowroot-æ¸²æŸ“èµ„æºåˆ°-shadowroot)]
- åŒ…æ‹¬ `umd` æ¨¡å¼å’Œé‡å»ºæ¨¡å¼ï¼Œæ³¨å…¥ `template` ä¹‹å‰ `shadowRoot` ä»…ä»…æ˜¯ä¸ªç©ºå£³

æ³¨å…¥èµ„æºåä¼šå‘ç”Ÿä»€ä¹ˆï¼š

- ä¹‹å‰æ·»åŠ çš„ `loading` å› ä¸ºèµ„æºæ³¨å…¥ï¼Œè€Œæ’‘å¼€æŒ‚è½½èŠ‚ç‚¹å˜å¾—å¯è§ [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]
- ç”±äºå½“å‰åªæ³¨å…¥äº†å·²æ³¨é‡Š `script` çš„é™æ€èµ„æºï¼Œè€Œå¯¹äº `spa` åº”ç”¨æ¥è¯´æ­¤è¿˜æœªæ¸²æŸ“
- éœ€è¦ç­‰åˆ° `start` å¯åŠ¨åº”ç”¨ï¼Œå°†å…¥å£ `script` æ·»åŠ åˆ°æ²™ç®± `iframe` åæ‰ä¼šæ¸²æŸ“åº”ç”¨ [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

#### 5. å®Œæˆæ¿€æ´»åº”ç”¨

- é€šè¿‡ `patchCssRules` ä¸ºå­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸ [[æŸ¥çœ‹](#-patchcssrules-å­åº”ç”¨æ ·å¼æ‰“è¡¥ä¸)]
- æ›´æ–° `this.provide.shadowRoot`

`this.provide` æ˜¯å­åº”ç”¨ä¸­ `window` å…¨å±€å¯¹è±¡ä¸­çš„ `$wujie`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/api/wujie.html#wujie)]ï¼š

- åœ¨å®ä¾‹æ„é€ æ—¶é€šè¿‡ `patchIframeVariable` å°†å…¶æ³¨å…¥ `iframeWindow` [[æŸ¥çœ‹](#patchiframevariable-ä¸ºå­åº”ç”¨-window-æ·»åŠ å±æ€§)]
- `shadowRoot` ä»…é™é»˜è®¤çŠ¶æ€ä¸‹æ¿€æ´»æ—¶æ‰æä¾›ï¼Œé™çº§çŠ¶æ€ä¸‹ä¸å­˜åœ¨

åœ¨å­åº”ç”¨ä¸­è·å–è·ŸèŠ‚ç‚¹ï¼š

| åˆ†ç±»            | `iframe` å®¹å™¨                  | `shadowRoot` å®¹å™¨              |
| --------------- | ------------------------------ | ------------------------------ |
| `shadowRoot`    | ä¸å­˜åœ¨                         | `window.$wujie.shadowRoot`     |
| å®¹å™¨æ ¹èŠ‚ç‚¹      | `window.__WUJIE.document`      | `window.__WUJIE.shadowRoot`    |
| æ²™ç®± `document` | `Node.prototype.ownerDocument` | `Node.prototype.ownerDocument` |

åœ¨å­åº”ç”¨ä¸­ `document` ä¸€å®šæ˜¯æ²™ç®± `iframe.contentDocument`ï¼Œå› ä¸ºï¼š

- å­åº”ç”¨æ‰€æœ‰çš„ `script` éƒ½è¿è¡Œåœ¨æ²™ç®± `iframe`

è€Œåœ¨å­åº”ç”¨ä¸­ `document` çš„æŒ‡å®šçš„ `property` åˆ™ä¼šæŒ‡å‘ `proxyDocument`ï¼Œå› ä¸ºï¼š

- æ²™ç®± `iframe` åˆå§‹åŒ–æ—¶é€šè¿‡ `patchDocumentEffect` åŠ«æŒäº† `iframeWindow.Document.prototype` å±æ€§ [[æŸ¥çœ‹](#patchdocumenteffectä¿®æ­£æ²™ç®±-document-çš„-effect)]
- åŠ«æŒçš„å±æ€§ä¼šåœ¨ `get` æ—¶æŒ‡å‘ `proxyDocument` [[æŸ¥çœ‹](#wujie-ä¸­çš„ä»£ç†)]

> è€Œ `proxyDocument` åªæœ‰è·å– `script` æŒ‡å‘æ²™ç®± `iframe.contentDocumennt`ï¼Œå…¶ä½™å…¨éƒ¨æŒ‡å‘å®¹å™¨ï¼Œæ¯”å¦‚ `iframe` å®¹å™¨çš„ `document`ï¼Œæˆ–æ˜¯ `shadowRoot`

ä¸ºæ­¤æ²™ç®± `iframe` åˆå§‹åŒ–æ—¶ä¿ç•™äº†æ²™ç®± `document` 4 ä¸ªåŸå§‹æ–¹æ³•ï¼š

- é€šè¿‡ `initIframeDom` ç»‘å®šåœ¨ `iframe.contentWindow` [[æŸ¥çœ‹](#initiframedomåˆå§‹åŒ–-iframe-çš„-dom-ç»“æ„)]

æ­¤å¤– `document` ä¸‹çš„ `head`ã€`body` ä¹Ÿä¼šé€šè¿‡ `patchDocumentEffect` åŠ«æŒ [[æŸ¥çœ‹](#patchdocumenteffectä¿®æ­£æ²™ç®±-document-çš„-effect)]

- `head` æŒ‡å‘å®¹å™¨çš„ `head`ï¼Œ`body` æŒ‡å‘å®¹å™¨çš„ `body`

è€Œå®¹å™¨çš„ `head` å’Œ `body` åˆé€šè¿‡ `patchRenderEffect` é‡å†™äº†æŒ‡å®šçš„æ“ä½œ [[æŸ¥çœ‹](#patchrendereffect-ä¸ºå®¹å™¨æ‰“è¡¥ä¸)]

- é€šè¿‡ `head` æˆ– `body` æ’å…¥ `Dom` æ—¶ï¼Œä¼šæ ¹æ®å…ƒç´ ç±»å‹è‡ªåŠ¨åˆ†é…æ’å…¥æ²™ç®± `iframe` è¿˜æ˜¯å®¹å™¨

ä¸ºäº†æ–¹ä¾¿æ‹¿åˆ° `head` å’Œ `body`

- `shadowRoot` å®¹å™¨ï¼šé€šè¿‡å®ä¾‹ `shadowRoot['head'|'body']` è·å–
- `iframe` å®¹å™¨ï¼šé€šè¿‡å®ä¾‹ `sandbox['head'|'body']` è·å–

> å­åº”ç”¨ä¸­ä¹Ÿå¯ä»¥ç›´æ¥ä» `document['head'|'body']` è·å–

#### 6. æ¿€æ´»åº”ç”¨çš„ `bug`

å¯åŠ¨åº”ç”¨ä¸æä¾› `el` å®¹å™¨

- è™½ç„¶åœ¨ `ts` è§„èŒƒé‡Œå·²æ˜ç¡®è¦æ±‚å¿…é¡»æä¾› `el` å®¹å™¨ï¼Œä½†æ˜¯å¦‚æœ `ignore` æˆ– `js` é¡¹ç›®å°±æ²¡æä¾›æ€ä¹ˆåŠå‘¢ï¼Ÿ

è§¦å‘æƒ…å†µï¼š

- å—å½±å“ï¼šåˆ‡æ¢ `shadowDom` å®¹å™¨çš„åº”ç”¨
- ä¸å—å½±å“ï¼šé¢„åŠ è½½ã€æ²¡æœ‰é¢„åŠ è½½åˆæ¬¡å¯åŠ¨ã€é™çº§å¤„ç†ï¼Œä¼šå°†æ²™ç®± `iframe` ä½œä¸ºå¤‡ç”¨å®¹å™¨

è§£å†³åŠæ³•ï¼š

- å’Œ `micro-app` ç»„ä»¶æŒ‚è½½ä¸€æ ·åšæ¡ä»¶åˆ¤æ–­ï¼Œæ¡ä»¶ä¸æ»¡è¶³çš„æƒ…å†µç›´æ¥è¿”å›ä¸åšä»»ä½•æ¸²æŸ“

#### 7. æ¿€æ´»åº”ç”¨çš„è¡¥å……

æ— è®ºå®¹å™¨æ˜¯ `iframe` è¿˜æ˜¯ `shadowRoot`ï¼Œéƒ½è¦ç»™å®¹å™¨æ·»åŠ å±æ€§ `WUJIE_APP_ID` å€¼ä¸ºåº”ç”¨åï¼Œç”¨é€”ï¼š

- é€šè¿‡ `querySelector` æŸ¥æ‰¾ `iframe[${WUJIE_APP_ID}="${id}"]` æ‰¾åˆ° `iframe` å®¹å™¨
- é€šè¿‡è‡ªèº«å±æ€§ `WUJIE_APP_ID` è·å–åº”ç”¨å®ä¾‹

> æ·»åŠ å±æ€§æ˜¯ç”± `wujie` å†…éƒ¨å®ç°ï¼Œä½¿ç”¨è€…æ— éœ€æ‰‹åŠ¨æ·»åŠ ï¼Œè¿™é‡Œå†™å‡ºæ¥æ˜¯ä½œä¸ºå¢åŠ å¯¹ `wujie` çš„äº†è§£

`WUJIE_APP_ID` å®šä¹‰éƒ½æ¥è‡ª `active` æ¿€æ´»åº”ç”¨æ—¶åˆ›å»ºå®¹å™¨ï¼š

- `createIframeContainer`ï¼šåˆ›å»º `iframe` å®¹å™¨ [[æŸ¥çœ‹](#åˆ›å»º-iframe-å®¹å™¨)]
- `createWujieWebComponent`ï¼šåˆ›å»º `shadowRoot` å®¹å™¨

#### ğŸ“ `start` å¯åŠ¨åº”ç”¨

å‚æ•°ï¼š

- `getExternalScripts`ï¼šè¿”å›åŠ è½½åº”ç”¨ä¸­é™æ€ `script` é›†åˆçš„å‡½æ•° [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]

è¿”å›ï¼š

- ç±»å‹ `Promise<void>` çš„å¾®ä»»åŠ¡ï¼Œé€šè¿‡ `await` ç¡®ä¿åº”ç”¨æˆåŠŸå¯åŠ¨

å¦‚æœ `this.iframe` è¢«é”€æ¯çš„æƒ…å†µä¼šç›´æ¥è¿”å›ä¸å†å¤„ç†ï¼š

- `this.iframe` åªæœ‰åœ¨é”€æ¯åº”ç”¨ `destroy` è®¾ä¸º `null` [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]

`start` è°ƒç”¨åœºæ™¯æœ‰ 3 ä¸ªï¼š

- `startApp` é¢„åŠ è½½ `alive` æ¨¡å¼çš„åº”ç”¨å `startApp` [[æŸ¥çœ‹](#21-alive-ä¿æ´»æ¨¡å¼è¿è¡Œåº”ç”¨)]
- `startApp` åˆ›å»ºæ–°çš„åº”ç”¨å®ä¾‹ [[æŸ¥çœ‹](#3-åˆ›å»ºæ–°çš„æ²™ç®±å®ä¾‹)]
- `preloadApp` é…ç½® `exec` é¢„æ‰§è¡Œ [[æŸ¥çœ‹](#5-é€šè¿‡-exec-é¢„æ‰§è¡Œ)]

> æ‰§è¡Œ `start` å¯åŠ¨åº”ç”¨å‰å¿…é¡»å…ˆ `active` æ¿€æ´»åº”ç”¨ [[æŸ¥çœ‹](#-active-æ¿€æ´»åº”ç”¨)]

#### 1. æ”¶é›†é˜Ÿåˆ—

æ•´ä¸ª `start` çš„æµç¨‹å°±æ˜¯å¯¹ `this.execQueue` é˜Ÿåˆ—çš„æ”¶é›†å’Œæå–å¹¶æ‰§è¡Œï¼š

- åœ¨é˜Ÿåˆ—ä¸­ `push` è¿›æ¥çš„éƒ½æ˜¯åŒæ­¥çš„æ‰§è¡Œæ–¹æ³•ï¼Œæ‰§è¡Œé˜Ÿåˆ—é€šè¿‡ `shift` å®ç°å…ˆå…¥å…ˆå‡º
- åœ¨é˜Ÿåˆ—ä¸‹æ ‡çš„æ¯ä¸ªæ–¹æ³•ä¸­æœ‰å¯èƒ½å­˜åœ¨å¾®ä»»åŠ¡å’Œå®ä»»åŠ¡ï¼Œä½†æ‰§è¡Œé¡ºåºçœ‹æ‰€åœ¨æ‰§è¡Œçš„é˜Ÿåˆ—å‰åé¡ºåº
- å› ä¸ºæ¯ä¸ªé˜Ÿåˆ—çš„æ‰§è¡Œéƒ½æ˜¯åœ¨ä¸Šä¸€ä¸ªé˜Ÿåˆ—æ‰§è¡Œè¿‡ç¨‹ä¸­é€šè¿‡ `shift` æå–å¹¶æ‰§è¡Œ

**`this.execQueue.push` å…±è®¡ 7 å¤„ï¼š**

- `beforeScriptResultList`ï¼šæ’å…¥ä»£ç å‰é€šè¿‡æ’ä»¶æ·»åŠ çš„ `script`
- `syncScriptResultList` + `deferScriptResultList`ï¼šå­åº”ç”¨ä¸­åŒæ­¥ `script`ï¼ŒåŒ…å« `defer`
- `this.mount`ï¼šåŸºåº§ä¸»åŠ¨è°ƒç”¨ `mount` æ–¹æ³•
- `domContentLoadedTrigger`ï¼šè§¦å‘ `DOMContentLoaded` äº‹ä»¶
- `afterScriptResultList`ï¼šæ’å…¥ä»£ç åæ’ä»¶æ·»åŠ çš„ `script`
- `domLoadedTrigger`ï¼šè§¦å‘ `loaded` äº‹ä»¶
- è¿”å› `Promise`ï¼šæ‰€æœ‰çš„ `execQueue` é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•ï¼Œ`start` æ‰ä¼šåœ¨æœ€å `resolve`

**æœ‰ 1 å¤„å­˜åœ¨å³æ‰§è¡Œï¼š**

- `asyncScriptResultList`ï¼šå­åº”ç”¨ä¸­å¸¦æœ‰ `async` çš„ `script`

æ€»å…± 8 å¤„ï¼Œç„¶åæ ¹æ®ç”¨é€”è¿˜å¯ä»¥ç»†åˆ†å¦‚ä¸‹

**å¿…é¡»ä¼šæ·»åŠ åˆ°é˜Ÿåˆ—æœ‰ 4 å¤„ï¼š**

- `this.mount`ã€`domContentLoadedTrigger`ã€`domLoadedTrigger`ã€è¿”å›çš„ `Promise` å¯¹è±¡

**æ ¹æ®é›†åˆæ·»åŠ åˆ°é˜Ÿåˆ—æœ‰ 3 å¤„ï¼š**

- `beforeScriptResultList`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-before-loaders)]
- `afterScriptResultList`ï¼Œè§ï¼šæ–‡æ¡£ [[æŸ¥çœ‹](https://wujie-micro.github.io/doc/guide/plugin.html#js-after-loader)]
- `syncScriptResultList` + `deferScriptResultList`ï¼šæå–å­åº”ç”¨çš„ `script`

> `beforeScriptResultList` å’Œ `afterScriptResultList` ä¸‹æ ‡ç±»å‹æ–‡æ¡£ä»‹ç»æœ‰é™ï¼Œå»ºè®®æŸ¥çœ‹æºç ç±»å‹ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/index.ts#L22)]

**æå–å­åº”ç”¨çš„ `script`ï¼š**

é€šè¿‡ `getExternalScripts` å¾—åˆ° `scriptResultList` [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]

å£°æ˜ 3 ä¸ªé›†åˆï¼š

- `syncScriptResultList`ï¼šåŒæ­¥ä»£ç 
- `asyncScriptResultList`ï¼š`async` æ— éœ€ä¿è¯åŠ è½½é¡ºåºï¼Œæ‰€ä»¥ä¸ç”¨æ”¾å…¥æ‰§è¡Œé˜Ÿåˆ—
- `deferScriptResultList`ï¼š`defer` éœ€è¦ä¿è¯åŠ è½½é¡ºåºå¹¶ä¸”åœ¨è§¦å‘ `DOMContentLoaded` å‰å®Œæˆ

éå† `scriptResultList` æ ¹æ®å±æ€§åˆ†ç±»æ·»åŠ åˆ°ä¸Šè¿° 3 ä¸ªé›†åˆï¼Œå…³äºå±æ€§è§ï¼š`processTpl` æå–èµ„æº [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]

> æ— è®ºæ˜¯åŒæ­¥ä»£ç è¿˜æ˜¯å¼‚æ­¥ä»£ç ï¼Œ`getExternalScripts` æå–çš„ `script` éƒ½æ˜¯åº”ç”¨ä¸­çš„é™æ€èµ„æºï¼Œè€Œä¸æ˜¯åŠ¨æ€æ·»åŠ çš„ `script`ï¼›è€Œåƒ `React` å’Œ `Vue` è¿™æ ·çš„ `SPA` åº”ç”¨é€šå¸¸åªæš´éœ²ä¸€ä¸ªé™æ€çš„ `script` ä½œä¸ºå…¥å£ï¼Œå…¶ä½™çš„ `script` å’Œæ ·å¼åŠ¨æ€æ·»åŠ ï¼Œè§ï¼š`execQueue` åº”ç”¨å¯åŠ¨æ‰§è¡Œé˜Ÿåˆ— [[æŸ¥çœ‹](#1-execqueue-åº”ç”¨å¯åŠ¨æ‰§è¡Œé˜Ÿåˆ—)]

**éå†çš„é›†åˆä¸‹æ ‡æ˜¯ `promise` æœ‰ 2 å¤„ï¼š**

- åŒæ­¥å’Œå¼‚æ­¥ä»£ç æ‰§è¡Œï¼š`syncScriptResultList`ã€`asyncScriptResultList`
- å…±åŒç‚¹ï¼šé›†åˆä¸­çš„æ¯ä¸€ä¸ªæ–¹æ³•éƒ½è¿”å› `Promise`ã€éœ€è¦åœ¨å¾®ä»»åŠ¡ä¸­æ‰§è¡Œ `insertScriptToIframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]
- ä¸åŒç‚¹ï¼š`syncScriptResultList` éœ€è¦ç­‰å¾…é˜Ÿåˆ—æŒ‰é¡ºåºæå–æ‰§è¡Œï¼Œ`asyncScriptResultList` éå†åŒæ—¶ç«‹å³å‘èµ·å¾®ä»»åŠ¡

**æ’å…¥é˜Ÿåˆ— `execQueue` çš„åŠ¨ä½œå…¨éƒ¨éƒ½æ˜¯ä¸Šä¸‹æ–‡ï¼š**

- åœ¨é˜…è¯»æ‰§è¡Œé˜Ÿåˆ—å‰éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ‰€æœ‰é˜Ÿåˆ—éƒ½æ˜¯åœ¨ä¸Šä¸‹æ–‡ä¸­ `push`
- å³ä¾¿æ˜¯æœ€åè¿”å›çš„ `Promise`ï¼Œä¹Ÿæ˜¯åœ¨ `Promise` æ–¹æ³•ä¸­åŒæ­¥æ’å…¥æ‰§è¡Œçš„é˜Ÿåˆ—

#### 2. æ‰§è¡Œé˜Ÿåˆ—

æ— è®ºæ€ä¹ˆæ·»åŠ é˜Ÿåˆ—ï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡ `this.execQueue.shift()()` ä»å¤´éƒ¨å¼¹å‡ºæ’å…¥é˜Ÿåˆ—çš„æ–¹æ³•å¹¶æ‰§è¡Œ

å¼€å§‹æ‰§è¡Œï¼š

- æ‰§è¡Œé˜Ÿåˆ—ä» 334 è¡Œå¼€å§‹ï¼ŒæŒ‰ç…§ä¸Šä¸‹æ–‡ä¸»åŠ¨æå–å¹¶å‘èµ·æ‰§è¡Œï¼Œè§ï¼šæºç  [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L334)]
- `asyncScriptResultList` ä¸åŠ å…¥é˜Ÿåˆ—ï¼Œä¼šä»¥ `Promise` å¾®ä»»åŠ¡çš„å½¢å¼åœ¨å½“å‰ä¸Šä¸‹æ–‡æ‰§è¡Œå®Œæ¯•åä¾æ¬¡æ‰§è¡Œ

éœ€è¦è¯´æ˜çš„æ˜¯ï¼š

- å¼€å§‹æå– `execQueue` æ˜¯åœ¨ `start` è¿”å› `Promise` ä¹‹å‰æ‰§è¡Œï¼Œé˜Ÿåˆ—æ–¹æ³•å’Œ `Promise` å†…éƒ¨æ–¹æ³•æ˜¯ä¸Šä¸‹æ–‡å…³ç³»
- æ‰€ä»¥é˜Ÿåˆ—å¼€å§‹æ—¶ï¼Œè¿”å›çš„ `Promise` è¿˜æ²¡æœ‰å°†æœ€åè¦æ‰§è¡Œçš„é˜Ÿåˆ—æ’å…¥ `execQueue`

å¾ªç¯æ’å…¥é˜Ÿåˆ—å…±æœ‰ 3 å¤„ï¼š

- åˆ†åˆ«æ˜¯ï¼š`beforeScriptResultList`ã€`syncScriptResultList` + `deferScriptResultList`ã€`afterScriptResultList`
- æ¯ä¸ªé˜Ÿåˆ—é€šè¿‡ `insertScriptToIframe` æ³¨å…¥ `script` åˆ°æ²™ç®± `iframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]
- æ³¨å…¥ `script` ä¹‹åå†å°† `window.__WUJIE.execQueue.shift()()` æ³¨å…¥æ²™ç®± `iframe`
- è¿™æ ·æ¯ä¸ª `push` çš„é˜Ÿåˆ—ï¼Œä¼šåœ¨æ²™ç®± `iframe` åŠ è½½å®Œ `script` åé€šè¿‡ `shift` æå–ä¸‹ä¸€ä¸ªä»»åŠ¡å¹¶æ‰§è¡Œ

ä¸»åŠ¨æ’å…¥é˜Ÿåˆ—æœ‰ 4 å¤„ï¼š

- `mount`ã€`domContentLoadedTrigger`ã€`domLoadedTrigger`ã€è¿”å›çš„ `Promise`
- ä¼šåœ¨æ‰§å‡½æ•°æœ«å°¾æ·»åŠ  `this.execQueue.shift()?.();` æå–å¹¶æ‰§è¡Œæ¥ä¸‹æ¥çš„é˜Ÿåˆ—

å¦‚æœæ²¡æœ‰ä¸»åŠ¨é…ç½® `fiber` ä¸º `false` çš„æƒ…å†µä¸‹ï¼š

- é™¤æœ€åè¿”å›çš„ `Promise` ä¹‹å¤–ï¼Œæ‰€æœ‰çš„é˜Ÿåˆ—å°†åŒ…è£¹åœ¨å®ä»»åŠ¡ `requestIdleCallback` ä¸­ç©ºé—²æ‰§è¡Œ
- ä½†æ˜¯æ¯ä¸ªé˜Ÿåˆ—çš„æ‰§è¡Œï¼Œå¿…é¡»æ˜¯åœ¨ä¸Šä¸€ä¸ªé˜Ÿåˆ—ç»“æŸåé€šè¿‡ `shift` æå–å¹¶æ‰§è¡Œ

æ— è®ºé˜Ÿåˆ—ä¸­æ‰§è¡Œçš„æ˜¯ä¸Šä¸‹æ–‡ï¼Œè¿˜æ˜¯å¾®ä»»åŠ¡ï¼Œäº¦æˆ–è€…æ˜¯å®ä»»åŠ¡ï¼Œæœ€ç»ˆéƒ½éœ€è¦æŒ‰ç…§é˜Ÿåˆ—é¡ºåºæ¥

> åœ¨ `WuJie` å®ä¾‹ä¸­é€šè¿‡ `this.requestIdleCallback` æ‰§è¡Œç©ºé—²åŠ è½½ï¼Œå®ƒå’Œ `requestIdleCallback` çš„åŒºåˆ«åœ¨äºï¼Œæ¯æ¬¡æ‰§è¡Œå‰å…ˆåˆ¤æ–­å®ä¾‹æ˜¯å¦å·²é”€æ¯æ²™ç®± `iframe`

åªæœ‰ 1 ç§æƒ…å†µå¯ä»¥æ— è§†é˜Ÿåˆ—é¡ºåºï¼š

- `asyncScriptResultList`ï¼šå­åº”ç”¨ä¸­å¼‚æ­¥åŠ è½½çš„ `script`

è€Œæœ€åè¿”å›çš„ `promise` ä¹Ÿåªåš 1 ä»¶äº‹ï¼š

- æ’å…¥æœ€ç»ˆæ‰§è¡Œçš„é˜Ÿåˆ—ï¼Œåœ¨é˜Ÿåˆ—çš„æ–¹æ³•ä¸­å°†æ‰§è¡Œ `resolve` é€šçŸ¥å¤–éƒ¨ `start` å®Œæˆ

#### 3. é˜Ÿåˆ—æ‰§è¡Œé¡ºåº

é˜Ÿåˆ—æœ‰ 3 å¤„å¾®ä»»åŠ¡ï¼š

- `asyncScriptResultList`ï¼šå¼‚æ­¥ä»£ç 
- `syncScriptResultList` + `deferScriptResultList`ï¼šåŒæ­¥ä»£ç 
- è¿”å›çš„ `Promise` å¯¹è±¡

> åªæœ‰å¼‚æ­¥ä»£ç æ˜¯ç«‹å³æ·»åŠ å¾®ä»»åŠ¡ï¼Œå…¶ä»–æŒ‰ç…§ `execQueue` é˜Ÿåˆ—é¡ºåºç­‰å¾…æå–å¹¶æ‰§è¡Œ

`fiber` æ²¡æœ‰å…³é—­çš„æƒ…å†µä¸‹æœ‰ 7 å¤„å®ä»»åŠ¡ï¼š

- é™¤äº†é€šè¿‡è¿”å›çš„ `Promise` æ’å…¥æœ«å°¾çš„é˜Ÿåˆ—ï¼Œéƒ½ä¼šé€šè¿‡ `requestIdleCallback` æ’å…¥å®ä»»åŠ¡

> æ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ `execQueue` é˜Ÿåˆ—å…ˆåé¡ºåºæ‰§è¡Œ

æ‰§è¡Œé¡ºåºå¦‚ä¸‹ï¼š

1. `asyncScriptResultList` éå†å¼‚æ­¥ä»£ç ï¼Œå°†å¾®ä»»åŠ¡æ”¾å…¥å¾®é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œ
2. 334 è¡Œå¼€å§‹æå–ç¬¬ 1 ä¸ªé˜Ÿåˆ—å¹¶æ‰§è¡Œ `this.execQueue.shift()()`
3. æ‰§è¡Œ `beforeScriptResultList`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
4. æ‰§è¡Œ `syncScriptResultList` + `deferScriptResultList`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
5. ä¾æ¬¡æ‰§è¡Œ `mount`ã€`domContentLoadedTrigger`
6. æ‰§è¡Œ `afterScriptResultList`ï¼Œå¦‚æœå­˜åœ¨çš„è¯
7. æ‰§è¡Œ `domLoadedTrigger`
8. é€šè¿‡è¿”å›çš„ `Promise` æ–¹æ³•ä¸­æ‰§è¡Œæœ€åæ·»åŠ åˆ° `execQueue` çš„æ–¹æ³•

`asyncScriptResultList` æ‰§è¡Œé¡ºåºï¼š

- ä¼šåœ¨ `execQueue` é˜Ÿåˆ—ä¸­ç¬¬ 1 ä¸ªå¾®ä»»åŠ¡æˆ–å®ä»»åŠ¡ä¹‹å‰å®Œæˆæ‰€æœ‰å¼‚æ­¥ä»£ç æ³¨å…¥

`fiber` æ¨¡å¼ï¼Œç¬¬ 1 ä»»åŠ¡ï¼š

- `beforeScriptResultList` å­˜åœ¨çš„è¯ï¼Œç¬¬ 1 ä¸ªé˜Ÿåˆ—æ˜¯å®ä»»åŠ¡ï¼Œå¦åˆ™ç»§ç»­å¾€ä¸‹çœ‹
- åŒæ­¥ä»£ç å­˜åœ¨çš„è¯ï¼Œç¬¬ 1 ä¸ªé˜Ÿåˆ—æ˜¯å¾®ä»»åŠ¡ï¼Œå¦åˆ™å°±ä¸€å®šä¼šæ˜¯å®ä»»åŠ¡

é `fiber` æ¨¡å¼ï¼Œç¬¬ 1 ä¸ªä»»åŠ¡ï¼š

- `beforeScriptResultList` å­˜åœ¨å¤–è” `script`ï¼Œç¬¬ 1 ä¸ªé˜Ÿåˆ—æ˜¯å®ä»»åŠ¡
- åŒæ­¥ä»£ç å­˜åœ¨çš„è¯ï¼Œç¬¬ 1 ä¸ªé˜Ÿåˆ—æ˜¯å¾®ä»»åŠ¡
- `afterScriptResultList` å­˜åœ¨å¤–è” `script`ï¼Œç¬¬ 1 ä¸ªé˜Ÿåˆ—æ˜¯å®ä»»åŠ¡
- åœ¨æœ€åè¿”å›çš„ `Promise` å¯¹è±¡ `resolve` å®Œæˆä»»åŠ¡å‰æ‰§è¡Œ `asyncScriptResultList`

> æ‰§è¡Œé¡ºåºä»ä¸Šè‡³ä¸‹ï¼Œæœ‰ 1 æ¡æ»¡è¶³åé¢çš„å°±ä¸ç”¨å†çœ‹ï¼›ä»¥ä¸Šæ— è®ºæ˜¯ä¸æ˜¯ `fiber` æ¨¡å¼éƒ½ä¸åŒ…å«åŒæ­¥ä»»åŠ¡ï¼Œå› ä¸ºå¯¹äºå¾®ä»»åŠ¡æ¥è¯´ï¼ŒåŒæ­¥ä»»åŠ¡å¿…ç„¶ä¼šä¼˜å…ˆæ‰§è¡Œ

ä¸ºä»€ä¹ˆå¤–è” `script` å­˜åœ¨å®ä»»åŠ¡ï¼š

- é˜Ÿåˆ—ä¸­æ— è®ºæ˜¯ `appendChild` è¿˜æ˜¯ `dispatchEvent` éƒ½æ˜¯åŒæ­¥æ“ä½œ
- åªæœ‰é€šè¿‡ `src` åŠ è½½çš„ `script` ä¼šé€šè¿‡ `onload` å›è°ƒæ‰§è¡Œ `execQueue.shift()()`
- è€Œ `onload` æ˜¯å®ä»»åŠ¡ï¼Œæ‰§è¡Œå‰ï¼Œä¼šä¼˜å…ˆå®Œæˆä¸Šä¸€ä¸ªå®ä»»åŠ¡ä¸­çš„å¾®ä»»åŠ¡

å¦‚æœ `execQueue` åœ¨è¿”å› `Promise` ä¹‹å‰ï¼Œé˜Ÿåˆ—ä¸­åªæœ‰åŒæ­¥æ‰§è¡Œçš„æ–¹æ³•ï¼Œä¼šå­˜åœ¨ä¸€ä¸ª `bug`ï¼Œè§ï¼š`start` å¯åŠ¨åº”ç”¨çš„ `bug` [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)]

ä¸ºä»€ä¹ˆå…³æ³¨ `asyncScriptResultList` æ‰§è¡Œé¡ºåºï¼š

- å› ä¸º `execQueue` é˜Ÿåˆ—ä¸­æ‰€æœ‰åŒæ­¥çš„æ–¹æ³•ã€å¾®ä»»åŠ¡ã€å®ä»»åŠ¡ï¼Œéƒ½æŒ‰ç…§é˜Ÿåˆ—å…ˆåé¡ºåº `one by one`
- é€šè¿‡ `asyncScriptResultList` å¯ä»¥ä½œä¸ºå‚è€ƒå¯¹è±¡ï¼Œå¾ˆå¥½çš„äº†è§£æ•´ä¸ªé˜Ÿåˆ—çš„æ‰§è¡Œé¡ºåº

> ä¸€é“æ€è€ƒé¢˜ï¼šåœ¨å­åº”ç”¨ä¸­æ‰€æœ‰é™æ€ `script` å°†è¢«åˆ†ç±»ä¸ºâ€œåŒæ­¥ä»£ç â€å’Œâ€œå¼‚æ­¥ä»£ç â€ï¼Œè¿™äº›é™æ€çš„ `script` ä¼šæ€æ ·åŠ è½½å¹¶æ³¨å…¥æ²™ç®± `iframe` çš„ï¼Ÿè¿™ä¸ªé—®é¢˜ä¼šåœ¨ä¸‹é¢è§£ç­”ï¼Œè§ï¼šé˜Ÿåˆ—å‰çš„å‡†å¤‡ [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]

**å…³äºå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼š**

åœ¨ `micro-app` æœ‰ä¸€ä¸ª `injectFiberTask`ï¼Œè§ `micro-app` æºç åˆ†æä¸­æ³¨ â‘­ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-app-substrate?tab=readme-ov-file#13-extractsourcedom-%E6%88%90%E5%8A%9F%E5%8A%A0%E8%BD%BD%E8%B5%84%E6%BA%90%E5%9B%9E%E8%B0%83)]ï¼Œå¯¹æ¯”å¦‚ä¸‹ï¼š

| å¯¹æ¯”é¡¹   | `wujie`                                                      | `micro-app`                                                 |
| -------- | ------------------------------------------------------------ | ----------------------------------------------------------- |
| æ·»åŠ é˜Ÿåˆ— | æ ¹æ®ä¸åŒç±»å‹ï¼Œæ‰‹åŠ¨æ·»åŠ æ¯ä¸€ç»„é˜Ÿåˆ—                             | `injectFiberTask`                                           |
| é›†åˆå¯¹è±¡ | `execQueue`                                                  | `fiberLinkTasks`                                            |
| æ·»åŠ æ–¹å¼ | `push`                                                       | `push`                                                      |
| æ‰§è¡Œæ–¹å¼ | `this.execQueue.shift()?.()`ï¼Œåœ¨å½“å‰é˜Ÿåˆ—æå–ä¸‹ä¸€ä¸ªé˜Ÿåˆ—å¹¶æ‰§è¡Œ | `serialExecFiberTasks`ï¼Œé€šè¿‡ `array.redus` æ‹å¹³é˜Ÿåˆ—ä¾æ¬¡æ‰§è¡Œ |
| ç«‹å³æ‰§è¡Œ | `asyncScriptResultList`ï¼Œéå†é›†åˆæ·»åŠ åˆ°å¾®ä»»åŠ¡ä¸­æ‰§è¡Œ          | è°ƒç”¨ `injectFiberTask` æ—¶æä¾› `fiberTasks` ä¸º `null`        |

> æ¯”è¾ƒè€Œè¨€ `micro-app` çš„ `injectFiberTask`ï¼Œæ›´ç®€æ´ã€æŠ½è±¡ï¼Œçµæ´»åº¦ä¹Ÿæ›´é«˜

#### 4. `start` å¯åŠ¨åº”ç”¨çš„ `bug`

é—®é¢˜ 1ï¼š

- å¦‚æœ `execQueue` é™¤äº†æœ€åè¿”å›çš„ `Promise` å¯¹è±¡ä¹‹å¤–ï¼Œæ²¡æœ‰å¾®ä»»åŠ¡ä¹Ÿæ²¡æœ‰å®ä»»åŠ¡
- é‚£ä¹ˆè¿”å›çš„ `Promise` å†…éƒ¨æ–¹æ³•ä¸­æ’å…¥ `execQueue` æœ«å°¾çš„é˜Ÿåˆ—æ°¸è¿œæ— æ³•æ‰§è¡Œ

åŸå› ï¼š

- å¼€å§‹æå–å¹¶æ‰§è¡Œé˜Ÿåˆ—çš„æ–¹æ³•ï¼Œç›¸å¯¹äºè¿”å›çš„ `Promise` å‡½æ•°ä¼˜å…ˆæ‰§è¡Œï¼Œå®ƒä»¬æ˜¯ä¸Šä¸‹æ–‡å…³ç³»
- å¦‚æœè¿”å›çš„ `Promise` ä¹‹å‰å…¨éƒ¨éƒ½æ˜¯ä¸Šä¸‹æ–‡åŒæ­¥å…³ç³»ï¼Œé‚£ä¹ˆå½“é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•åï¼Œæ‰ä¼šå°† `Promise` ä¸­çš„é˜Ÿåˆ—æ’å…¥ `execQueue`
- è¿™æ ·å°±æ„å‘³ç€æ°¸è¿œä¸ä¼šæ‰§è¡Œæœ«å°¾é˜Ÿåˆ—ä¸­çš„ `resove`ï¼Œå› æ­¤ `start` è¢«ä¸­æ–­

é—®é¢˜ 2ï¼š

- å¦‚æœ `beforeScriptResultList` æˆ– `afterScriptResultList` å­˜åœ¨ `async` å±æ€§çš„ `script`
- å°†å¯¼è‡´æ— æ³•æå–æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé€ æˆæµç¨‹ä¸­æ–­åé¢çš„ `script` å°†ä¸èƒ½æ’å…¥æ²™ç®± `iframe`

åŸå› ï¼š

- æ²™ç®± `iframe` æ³¨å…¥ `script` åï¼Œä¼šæ ¹æ® `async` å»åˆ¤æ–­è¦ä¸è¦æ‰§è¡Œä¸‹ä¸€æ¡é˜Ÿåˆ—

é¢å¤–äº§ç”Ÿçš„å½±å“ï¼š

- é˜Ÿåˆ—æš‚åœï¼Œç­‰å¾…æ‰§è¡Œ `start` åç»­æµç¨‹å°†ä¼šåœ¨æ‰€åœ¨çš„ `async` æ–¹æ³•å†…ä¸­æ–­

`preloadApp` å‡ºç°é—®é¢˜çš„åœºæ™¯ï¼š

- é¢„åŠ è½½æœ¬èº«ä¸ä¼šå¯¼è‡´é—®é¢˜ï¼Œå› ä¸ºé¢„åŠ è½½é»˜è®¤ä¸ä¼š `start`ï¼Œå³ä¾¿é…ç½® `exec` å¯åŠ¨åº”ç”¨ `start`ï¼Œé—®é¢˜ä¹Ÿä¼šå‘ç”Ÿåœ¨ `startApp` åˆ‡æ¢åº”ç”¨æ—¶

`startApp` å¯åŠ¨åº”ç”¨ `start` é—®é¢˜çš„åœºæ™¯ï¼š

| è§¦å‘æ¡ä»¶             | åŒ…å«æ¨¡å¼                                           | é—®é¢˜ 1                                              | é—®é¢˜ 2                             |
| -------------------- | -------------------------------------------------- | --------------------------------------------------- | ---------------------------------- |
| `alive` é¢„åŠ è½½åå¯åŠ¨ | å·²æ¿€æ´»è¿˜æœªå¯åŠ¨çš„ `alive` æ¨¡å¼åº”ç”¨                  | ç”Ÿå‘½å‘¨æœŸ `activated` å¯èƒ½ä¼šä¸æ‰§è¡Œï¼Œ`destroy` ä¸è¿”å› | æµç¨‹ä¸­æ–­å¯¼è‡´åç»­ `script` åŠ è½½å¤±è´¥ |
| é `alive` åº”ç”¨å¯åŠ¨  | `umd` æ¨¡å¼é¢„åŠ è½½åé¦–æ¬¡å¯åŠ¨ï¼Œé‡å»ºæ¨¡å¼æ¯æ¬¡å¯åŠ¨å’Œåˆ‡æ¢ | `destroy` ä¸è¿”å›                                    | æµç¨‹ä¸­æ–­å¯¼è‡´åç»­ `script` åŠ è½½å¤±è´¥ |
| `exec` é¢„æ‰§è¡Œåå¯åŠ¨  | æ‰€æœ‰æ¨¡å¼                                           | å¡åœ¨ `await sandbox.preload` æš‚åœä¸å†æ‰§è¡Œ           | æµç¨‹ä¸­æ–­å¯¼è‡´åç»­ `script` åŠ è½½å¤±è´¥ |

> åœ¨è§¦å‘æ¡ä»¶ä¸­æœ‰ä¸¤ä¸ªæ¦‚å¿µï¼šé¢„åŠ è½½å’Œé¢„æ‰§è¡Œï¼Œè§ï¼šé€šè¿‡ `exec` é¢„æ‰§è¡Œ [[æŸ¥çœ‹](#5-é€šè¿‡-exec-é¢„æ‰§è¡Œ)]

é `fiber` å‡ºç°é—®é¢˜çš„æ¨¡å¼ï¼š

| æ¨¡å¼                                          | åŸå›                                                                |
| --------------------------------------------- | ------------------------------------------------------------------ |
| æ¨¡å¼ â‘ ï¼šåº”ç”¨å†…ä¸å­˜åœ¨ `script`                 | è¿”å›çš„ `Promise` å‡½æ•°ä¸­è¿˜æ²¡æœ‰æ·»åŠ  `resolve` é˜Ÿåˆ—æ—¶ï¼Œé˜Ÿåˆ—å·²åœæ­¢è°ƒç”¨ |
| æ¨¡å¼ â‘¡ï¼šåº”ç”¨å†…åªæœ‰å†…è” `script`               | å’Œæ¨¡å¼ â‘  ä¸€æ ·                                                      |
| æ¨¡å¼ â‘¢ï¼šåº”ç”¨å†…æ‰€æœ‰ `script` å¸¦æœ‰ `async` å±æ€§ | å’Œæ¨¡å¼ â‘  ä¸€æ ·                                                      |

æ‰‹åŠ¨æ³¨å…¥å¸¦æœ‰ `async` å±æ€§çš„ `script`ï¼š

| æ¨¡å¼                             | åŸå›                                                                                                           |
| -------------------------------- | ------------------------------------------------------------------------------------------------------------- |
| æ¨¡å¼ â‘£ï¼š`beforeScriptResultList` | ä¸ä¼šæ‰§è¡Œ `nextScriptElement` ä»è€Œå¯¼è‡´åç»­é˜Ÿåˆ—æ— æ³•æ‰§è¡Œ                                                         |
| æ¨¡å¼ â‘¤ï¼š`afterScriptResultList`  | å’Œæ¨¡å¼ â‘¢ ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºåªç»ˆæ­¢äº† `domLoadedTrigger`ã€è¿”å›çš„ `Promise` å¯¹è±¡ï¼Œä»¥åŠ `async` ä¸­ç­‰å¾… `start` çš„æ–¹æ³• |

`fiber` ä¸‹åœ¨æ¨¡å¼ â‘ ã€â‘¡ã€â‘¢ éƒ½æ˜¯æ­£å¸¸æ‰§è¡Œï¼š

- æ²¡æœ‰ç‰¹æ®Šå£°æ˜é»˜è®¤ä¸º `fiber`ï¼Œé™¤äº†æœ€åè¿”å›çš„ `Promise`ï¼Œæ‰€æœ‰é˜Ÿåˆ—éƒ½åŒ…è£¹åœ¨ `requestIdleCallback`
- è€Œè¿”å›çš„ `Promise` å‡½æ•°å†…éƒ¨åœ¨å½“å‰ä»»åŠ¡å±äºä¸Šä¸‹æ–‡ï¼Œä¼˜å…ˆäºå®ä»»åŠ¡ `requestIdleCallback` æ·»åŠ åˆ°é˜Ÿåˆ—

å­˜åœ¨å­åº”ç”¨åŒæ­¥ä»£ç ä¼šæ­£å¸¸æ‰§è¡Œæ¨¡å¼ â‘ ã€â‘¡ã€â‘¢ï¼š

- åŒæ­¥ä»£ç å’Œå¼‚æ­¥ä»£ç æŒ‡çš„æ˜¯å­åº”ç”¨çš„é™æ€ `script`ï¼Œä¾‹å¦‚ï¼šå…¥å£æ–‡ä»¶
- åŒæ­¥ä»£ç æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡é›†åˆï¼Œæ‰§è¡Œå¾®ä»»åŠ¡å‰ï¼Œè¿”å›çš„ `Promise` å†…éƒ¨å‡½æ•°å·² `push` æœ€åé˜Ÿåˆ—
- è€Œå¯¹äºå­åº”ç”¨ä¸­å¸¦æœ‰ `async` å±æ€§çš„é™æ€ `script` åˆ†åˆ°å¼‚æ­¥ä»£ç ä¸­æ‰§è¡Œï¼Œä¸åœ¨é˜Ÿåˆ—è€ƒè™‘èŒƒå›´

æ‰€æœ‰æ¨¡å¼ä¸‹å¼‚æ­¥ä»£ç ä¼šæ­£å¸¸æ‰§è¡Œï¼š

- å¼‚æ­¥ä»£ç é€šè¿‡éå†æ‰§è¡Œ `Promise` é˜Ÿåˆ—ï¼Œä¸å— `execQueue` å½±å“
- ä½†å¼‚æ­¥ä»£ç æ‰§è¡Œå®Œæ¯•å¹¶ä¸èƒ½è¯´æ˜åº”ç”¨å¯åŠ¨æˆåŠŸäº†

é `fiber` æ¨¡å¼æ‰‹åŠ¨æ’å…¥å¸¦æœ‰ `src` å±æ€§ä¸” `content` ä¸ºç©ºçš„ `script`ï¼Œä¸å­˜åœ¨å±æ€§ `async` å¯æ­£å¸¸æ‰§è¡Œï¼š

- å› ä¸º `window.__WUJIE.execQueue.shift()()` æ˜¯é€šè¿‡ `script` çš„ `onload` æ‰§è¡Œ
- `onload` æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼Œä¼šåœ¨å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åå†æ‰§è¡Œï¼Œæ²¡æœ‰ `async` å°±ä¸ä¼šä¸­æ–­æµç¨‹

å¤ç°é—®é¢˜ 1ï¼šæ²¡æœ‰ `script`

- `static-app`ï¼šåˆ›å»ºä¸€ä¸ªæ²¡æœ‰ `script`ï¼Œæ²¡æœ‰ `style` çš„é™æ€å­åº”ç”¨ [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static)]
- æ·»åŠ ä¸€ä¸ª `StaticPage.tsx` é¡µé¢ç»„ä»¶ï¼Œå…³é—­ `fiber`ï¼Œä¸æ·»åŠ  `js-loaders` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/StaticPage.tsx)]
- åº”ç”¨ç»„ä»¶ `Wujie.tsx`ï¼šæ·»åŠ  `startApp` è¿”å›çš„å‡½æ•° `destroy` å¹¶æ‰“å° [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/components/Wujie.tsx)]

å¤ç°ç»“æœï¼š

- ç‚¹å¼€ `static` åº”ç”¨ï¼Œæ‰“å¼€è°ƒè¯•é¢æ¿ï¼Œåˆ·æ–°é¡µé¢ä»€ä¹ˆéƒ½æ²¡è¿”å›
- ç‚¹å¼€ `react` åº”ç”¨ï¼Œè¿”å› `destroy` æ–¹æ³•

å¤ç°é—®é¢˜ 1ï¼šå­˜åœ¨ `async` çš„ `script`

- åŸç†å’Œé—®é¢˜ 1 ä¸€æ ·ï¼Œå­åº”ç”¨ä¸­æ·»åŠ è·¯ç”± `/async`ï¼Œåœ¨é¡µé¢ä¸­æ·»åŠ ä¸€æ®µ `async` å±æ€§çš„ `script` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-app-static/blob/main/async/index.html)]
- åœ¨åŸºåº§ä¸­æ·»åŠ ç›¸åº”çš„ç»„ä»¶ `AsyncPage.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/AsyncPage.tsx)]

å¤ç°ç»“æœï¼š

- å’Œé—®é¢˜ 1 ä¸€æ ·ï¼Œå­åº”ç”¨ä¸­ `script` çš„ `async` ä¼šé€šè¿‡å¼‚æ­¥é›†åˆ `asyncScriptResultList` æ·»åŠ åˆ°æ²™ç®± `iframe` ä¸­
- `asyncScriptResultList` ä¸ä¼šå½±å“ `execQueue`

ä¿®å¤é—®é¢˜ 1ï¼š

- æºç  334 è¡Œ [[æŸ¥çœ‹](https://github.com/Tencent/wujie/blob/9733864b0b5e27d41a2dc9fac216e62043273dd3/packages/wujie-core/src/sandbox.ts#L334)]ï¼Œç¬¬ 1 ä¸ªæ‰§è¡Œé˜Ÿåˆ— `this.execQueue.shift()();` å‰ä¸»åŠ¨æ·»åŠ ä¸€ä¸ªå¾®ä»»åŠ¡
- è¿™æ ·ç¡®ä¿æœ€åä¸€ä¸ªé˜Ÿåˆ—æå–ä¸€å®šæ˜¯åœ¨å¾®ä»»åŠ¡ä¸‹æ‰§è¡Œï¼Œè€Œè¿”å›çš„ `Promise` å‡½æ•°å†…éƒ¨å±äºä¸Šä¸‹æ–‡
- è¿™æ ·åœ¨æ‰§è¡Œé¢å¤–æ·»åŠ çš„å¾®ä»»åŠ¡å‰ï¼Œè¿”å›çš„ `Promise` å·²ç»å°†æœ€åçš„é˜Ÿåˆ—æ’å…¥ `execQueue`
- è¿™æ ·ç¡®ä¿äº†é˜Ÿåˆ—æœ€åèƒ½å¤Ÿé¡ºåˆ© `resolve`

```
this.execQueue.push(() => Promise.resolve().then(
  () => this.execQueue.shift()?.()
));
this.execQueue.shift()();
```

å¤ç°é—®é¢˜ 2ï¼š`jsBeforeLoaders` æ‰“æ–­åº”ç”¨åŠ è½½

- å¤ç°å‰ç¡®ä¿ `react` åº”ç”¨æ­£å¸¸ï¼Œå¤åˆ¶ä¸€ä»½ `ReactPage.tsx` ä½œä¸º `BeforePage.tsx` [[æŸ¥çœ‹](https://github.com/cgfeel/micro-wujie-substrate/blob/main/src/pages/BeforePage.tsx)]
- æ·»åŠ  `jsBeforeLoaders`ï¼šè¦æ±‚å¸¦æœ‰ `src` å’Œ `async`

å¤ç°ç»“æœï¼š

- `ReactPage.tsx` æ­£å¸¸ï¼Œ`BeforePage.tsx` åº”ç”¨åŠ è½½è¿‡ç¨‹ä¸­è¢« `jsBeforeLoaders` æ‰“æ–­ä¸ä¼š `mount` åº”ç”¨

é—®é¢˜ 2 çš„è®¾è®¡åˆè¡·ï¼š

- å› ä¸ºå¼‚æ­¥ä»£ç  `asyncScriptResultList` å®ƒæœ¬èº«å’Œ `execQueue` é˜Ÿåˆ—é›†åˆæ˜¯æ²¡æœ‰å…³ç³»çš„
- ä½†å¼‚æ­¥ä»£ç ä¹Ÿæ˜¯æ‰§è¡Œ `insertScriptToIframe` å°† `script` æ’å…¥æ²™ç®± `iframe` ä¸­
- å¦‚æœå¼‚æ­¥ä»£ç ä¹Ÿå»è°ƒç”¨ `execQueue.shift()()`ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆé˜Ÿåˆ—æ‰§è¡Œé¡ºåºé”™ä¹±äº†

ä¿®å¤é—®é¢˜ 2ï¼š

- éå† `beforeScriptResultList` å’Œ `afterScriptResultList` æ—¶å»æ‰ `script` çš„ `async`ï¼Œå¦‚ä¸‹ï¼š

```
beforeScriptResultList.forEach(({ async, ...beforeScriptResult }) => {})
afterScriptResultList.forEach(({ async, ...afterScriptResult }) => {})
```

å› ä¸ºåªæœ‰é€šè¿‡é…ç½®æ‰‹åŠ¨æ·»åŠ  `async` çš„ `script` æ‰ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜

> ç”±äºç›®å‰è¿˜åœ¨ç ”ç©¶é˜¶æ®µï¼Œæ²¡æœ‰å¯¹å®˜æ–¹æ PRã€‚

**å…³äº `bug` çš„æ€»ç»“ï¼š**

1. ä½¿ç”¨ `wujie` è¿‡ç¨‹ä¸­è°¨æ…å…³é—­ `fiber`ï¼Œé»˜è®¤æ˜¯ä¸ä¼šå…³é—­ `fiber` çš„
2. ä¸è¦åœ¨ `beforeScriptResultList` æˆ– `afterScriptResultList` ä¼ å…¥å¸¦æœ‰ `async` å±æ€§çš„å¯¹è±¡ï¼Œè™½ç„¶ `ScriptObjectLoader` è¿™ä¸ªå¯¹è±¡æ˜¯å…è®¸é…ç½® `async` çš„ï¼Œè™½ç„¶å®˜æ–¹åœ¨æ–‡æ¡£ä¸­ä¹Ÿå¹¶æ²¡æœ‰è¯´ `async` æ˜¯å¯é€‰é…ç½®ï¼Œä½†æ˜¯æ“…è‡ªæ·»åŠ  `async` åœ¨æºç ä¸­æ˜¯æœ‰é€»è¾‘é—®é¢˜çš„

#### 5. é˜Ÿåˆ—å‰çš„å‡†å¤‡

`execFlag` è®¾ç½®ä¸º `true`ï¼Œè¡¨ç¤ºå·²å¯åŠ¨åº”ç”¨ï¼š

- `execFlag` ä¼šåœ¨ `destroy` è®¾ `null`ï¼Œä»è¿™é‡ŒçŸ¥é“æ³¨é”€åº”ç”¨ååªèƒ½é‡æ–°åˆ›é€ åº”ç”¨å®ä¾‹

é€šè¿‡ `importHTML` åŒ…è£…æ–¹æ³• `getExternalScripts` æå–è¦æ³¨å…¥æ²™ç®±çš„é™æ€ `script` é›†åˆ [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]

- `getExternalScripts` è¿”å›çš„ `script` é›†åˆä¸­ï¼Œå±æ€§ `contentPromise` æ˜¯ä¸€ä¸ªå¾®ä»»åŠ¡
- è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåŒæ­¥ä»£ç å’Œå¼‚æ­¥ä»£ç éƒ½æ˜¯é€šè¿‡å¾®ä»»åŠ¡å°† `script` æ·»åŠ åˆ° `iframe` ä¸­æ‰§è¡Œçš„åŸå› 

> ä¸ºäº†ä¿è¯å…¶é¡ºåºï¼Œä¹Ÿå› æ­¤ä¸ç®¡æ˜¯å¾®ä»»åŠ¡ä¹Ÿå¥½ï¼Œè¿˜æ˜¯å®ä»»åŠ¡ä¹Ÿå¥½ï¼Œéƒ½è¦æ±‚åœ¨ä¸Šä¸€ä¸ªé˜Ÿåˆ—æ‰§è¡Œå®Œåæå–æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—

ä¸€é“æ€è€ƒé¢˜ï¼šå­åº”ç”¨ä¸­é™æ€ `script` æ˜¯æ€ä¹ˆæ³¨å…¥åˆ°æ²™ç®± `iframe`

1. é€šè¿‡ `importHTML` æå–åº”ç”¨èµ„æº [[æŸ¥çœ‹](#importhtml-åŠ è½½èµ„æº)]
2. é€šè¿‡ `processTpl` æå–èµ„æºä¸­çš„æ ·å¼å’Œ `script`ï¼Œå¹¶æ›¿æ¢æˆæ³¨é‡Š [[æŸ¥çœ‹](#processtpl-æå–èµ„æº)]
3. é€šè¿‡ `processCssLoader` æå–æ ·å¼æ›¿æ¢èµ„æºä¸­çš„æ³¨é‡Šåé€šè¿‡ `active` æ³¨å…¥å®¹å™¨ [[æŸ¥çœ‹](#processcssloaderå¤„ç†-css-loader)]
4. `start` åº”ç”¨æ—¶è°ƒç”¨ `importHTML` æä¾›çš„åŒ…è£…æ–¹æ³• `getExternalScripts` æå– `script` [[æŸ¥çœ‹](#getexternalscriptsåŠ è½½-script-èµ„æº)]
5. å°†æå–çš„ `script` åˆ†ä¸ºåŒæ­¥ä»£ç æˆ–å¼‚æ­¥ä»£ç åˆ†åˆ«å¤„ç†ï¼ŒåŒæ­¥ä»£ç åŠ ä¸Šæ‰‹åŠ¨æ³¨å…¥çš„ `script` ä¸€åŒæ·»åŠ åˆ°é˜Ÿåˆ—
6. é€šè¿‡ `insertScriptToIframe` å°†é˜Ÿåˆ—ä¸­æä¾›çš„ `script` æ³¨å…¥æ²™ç®± `iframe` [[æŸ¥çœ‹](#insertscripttoiframeä¸ºæ²™ç®±æ’å…¥-script)]

`iframeWindow` æå–æ²™ç®±çš„ `window`ï¼Œç”¨äºæ³¨å…¥ `script`

- åŒæ—¶ç»‘å®š `__POWERED_BY_WUJIE__` åˆ°æ²™ç®± `window`ï¼Œä¾¿äºå­åº”ç”¨ç¡®è®¤è¿è¡Œç¯å¢ƒ

æ‰§è¡Œé˜Ÿåˆ—ä¹‹å‰ä¼šé€šè¿‡ `removeLoading` å…³é—­ `loading` çŠ¶æ€ï¼š

- å…³äºåŠ è½½çŠ¶æ€ï¼Œè§ï¼šå¯åŠ¨åº”ç”¨æ—¶æ·»åŠ ã€åˆ é™¤ `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]

åˆ é™¤ `loading` çš„æ¡ä»¶ï¼š

- æ²¡æœ‰æä¾› `__WUJIE_UNMOUNT` çš„æ‰€æœ‰æ¨¡å¼ï¼Œå› ä¸º `start` ä¸èƒ½åƒ `active` é‚£æ ·åˆ¤æ–­å½“å‰åº”ç”¨æ˜¯åˆæ¬¡åŠ è½½è¿˜æ˜¯åˆ‡æ¢åº”ç”¨

`umd` æ¨¡å¼ `start` æ—¶ä¼šé‡å¤è°ƒç”¨ `removeLoading`ï¼š

- ç¬¬ 1 éï¼šåœ¨æ‰§è¡Œé˜Ÿåˆ—å‰ï¼Œ`__WUJIE_UNMOUNT` è¿˜æ²¡æœ‰æŒ‚è½½
- ç¬¬ 2 éï¼šå°†åº”ç”¨å…¥å£ `script` æ³¨å…¥æ²™ç®±åï¼Œ`mount` æ—¶æ²™ç®± `window` å·²ç»‘å®š `__WUJIE_MOUNT`

> é‡å¤åˆ é™¤ `loading` åªèƒ½å¯¼è‡´é‡å¤æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°ä½¿ç”¨ä¸Šçš„é—®é¢˜

#### 6. å¿…é¡»æ·»åŠ é˜Ÿåˆ—çš„ 4 ä¸ªæ–¹æ³•

**1. ä¸»åŠ¨è°ƒç”¨ `mount` æ–¹æ³•**

- è§ï¼š`mount` æŒ‚è½½åº”ç”¨ [[æŸ¥çœ‹](#-mount-æŒ‚è½½åº”ç”¨)]

**2. è§¦å‘ `DOMContentLoaded` äº‹ä»¶**

- åˆ›å»º `DOMContentLoaded` è‡ªå®šä¹‰äº‹ä»¶ï¼Œåˆ†åˆ«ç”±æ²™ç®± `iframeWindow.document` å’Œ `iframeWindow` è§¦å‘

**3. è§¦å‘ `loaded` äº‹ä»¶**

- è‡ªå®šä¹‰äº‹ä»¶ `readystatechange`ï¼Œç”±æ²™ç®± `iframeWindow.document` è§¦å‘
- è‡ªå®šä¹‰äº‹ä»¶ `load`ï¼Œç”±æ²™ç®± `iframeWindow` è§¦å‘

**4. è¿”å› `Promise`**

- é€šè¿‡åœ¨è¿”å›çš„ `Promise` å‡½æ•°ä¸­æ·»åŠ é˜Ÿåˆ—æœ€åè¦æ‰§è¡Œçš„ä»»åŠ¡
- `resolve` é‡Šæ”¾è¿”å›çš„å¾®ä»»åŠ¡ï¼Œç”¨äºé€šçŸ¥ `start` å®Œæ¯•

#### ğŸ“ `mount` æŒ‚è½½åº”ç”¨

è§¦å‘åœºæ™¯ï¼š

- åªèƒ½åœ¨åº”ç”¨ `start` æ—¶é€šè¿‡ `execQueue` é˜Ÿåˆ—æ‰§è¡Œ `mount` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]

ä¸æ‰§è¡ŒæŒ‚è½½çš„æƒ…å†µï¼š

- `alive` æ¨¡å¼ï¼šåªæœ‰ `execFlag` è¿˜æœªæ¿€æ´»æ—¶æ‰ä¼šé€šè¿‡ `start` æ‰§è¡Œ `mount`
- `umd` æ¨¡å¼ï¼š`mountFlag` å·²ç»æŒ‚è½½çš„æƒ…å†µ

é™¤äº†é‡å»ºæ¨¡å¼å¤–ï¼Œåˆ‡æ¢åº”ç”¨æ°¸è¿œä¸ä¼šè§¦å‘ `mount`ï¼š

- æŒ‚è½½åº”ç”¨åªèƒ½é€šè¿‡ `start` å¯åŠ¨åº”ç”¨ï¼Œéé‡å»ºæ¨¡å¼ä¸‹åˆ‡æ¢åº”ç”¨ä¸æ‰§è¡Œ `start` [[æŸ¥çœ‹](#-start-å¯åŠ¨åº”ç”¨)]
- ä½†æ˜¯é‡å»ºæ¨¡å¼ä¸‹ `mount` æŒ‚è½½åº”ç”¨ï¼Œé™¤äº†å‘èµ·ä¸‹ä¸€ä¸ªé˜Ÿåˆ—ä¸ä¼šæ‰§è¡Œå…¶ä»–æ“ä½œ

#### 1. `umd` æ–¹å¼å¯åŠ¨

- ä»æ²™ç®± `window` ä¸­æ£€æµ‹åˆ° `__WUJIE_MOUNT` æ‰èƒ½æ‰§è¡Œå½“å‰æµç¨‹
- å†æ¬¡å…³é—­æŒ‚è½½èŠ‚ç‚¹ `loading` çŠ¶æ€ï¼Œè§ï¼šå¯åŠ¨åº”ç”¨æ—¶æ·»åŠ ã€åˆ é™¤ `loading` [[æŸ¥çœ‹](#å¯åŠ¨åº”ç”¨æ—¶æ·»åŠ åˆ é™¤-loading)]
- ä½¿ç”¨ `iframeWindow` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `beforeMount`
- è°ƒç”¨å­åº”ç”¨çš„ `__WUJIE_MOUNT` å»æ¸²æŸ“åº”ç”¨
- ä½¿ç”¨ `iframeWindow` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `afterMount`
- è®¾ç½® `mountFlag` é¿å…é‡å¤æŒ‚è½½

> åˆ é™¤ `loading` å­˜åœ¨é‡å¤æ‰§è¡Œçš„æƒ…å†µï¼Œè§ï¼šé˜Ÿåˆ—å‰çš„å‡†å¤‡ - å…³é—­åŠ è½½çŠ¶æ€ [[æŸ¥çœ‹](#5-é˜Ÿåˆ—å‰çš„å‡†å¤‡)]

`fiber` æ¨¡å¼ä¸‹ï¼Œ`__WUJIE_MOUNT` æ‰§è¡Œé¡ºåºï¼š

- æ³¨å…¥ `script` åï¼Œæ— è®ºæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥ç»‘å®š `__WUJIE_MOUNT`ï¼Œéƒ½ä¼šåœ¨ `mount` å‰ä¼˜å…ˆç»‘å®šåˆ°æ²™ç®± `window`
- å› ä¸º `fiber` æ¨¡å¼ä¸‹ `mount` åŒ…è£¹åœ¨å®ä»»åŠ¡ `requestIdleCallback` ä¸­

é `fiber` æ¨¡å¼ä¸‹ï¼ŒåŒæ­¥ä¸Šä¸‹æ–‡ç»‘å®š `__WUJIE_MOUNT`ï¼š

- æ‰§è¡Œæ–¹å¼å’Œ `fiber` æ¨¡å¼æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºä»–ä»¬æ˜¯ä¸Šä¸‹æ–‡å…³ç³»

é `fiber` æ¨¡å¼ä¸‹ï¼Œå¼‚æ­¥ç»‘å®š `__WUJIE_MOUNT` å¯¼è‡´çš„ `bug`ï¼š

- `__WUJIE_MOUNT` æ— æ³•æ‰§è¡Œï¼Œä¸å±•ç¤ºåº”ç”¨
- å› ä¸º `mount` åº”ç”¨æ—¶ï¼Œå¼‚æ­¥çš„å¾®ä»»åŠ¡è¿˜æ²¡æœ‰ç»‘å®š `__WUJIE_MOUNT` åˆ°æ²™ç®± `windnow` ä¸Š
- å†æ¬¡åˆ‡æ¢åº”ç”¨ä¼šæ¢å¤æ­£å¸¸

è§£å†³åŠæ³•è§ï¼š`start` å¯åŠ¨åº”ç”¨çš„ `bug` - é—®é¢˜ 1 [[æŸ¥çœ‹](#4-start-å¯åŠ¨åº”ç”¨çš„-bug)]

> ä»è¿™ç‚¹å†æ¬¡è¯´æ˜ï¼šè¯·è°¨æ…å…³é—­ `fiber`

#### 2. `alive` æ¨¡å¼

- ä½¿ç”¨ `iframeWindow` è°ƒç”¨ç”Ÿå‘½å‘¨æœŸ `activated`
- è¿™é‡Œå­˜åœ¨ `activated` è°ƒç”¨ 2 æ¬¡çš„æƒ…å†µï¼Œè§ï¼šé¢„åŠ è½½ä¸­çš„ `bug` [[æŸ¥çœ‹](#6é¢„åŠ è½½ä¸­çš„-bug)]

#### 3. æ‰§è¡Œä¸‹ä¸€ä¸ªé˜Ÿåˆ—

- `this.execQueue.shift()?.()`
- è¿™æ˜¯æ‰€æœ‰æ¨¡å¼å¿…é¡»åšçš„æµç¨‹ï¼Œä¹Ÿæ˜¯é‡å»ºæ¨¡å¼åœ¨ `mount` æ—¶å”¯ä¸€åšçš„äº‹
- ç»¼ä¸Šæ‰€è¿°ï¼Œ`mount` æŒ‚è½½åº”ç”¨ä¼¼ä¹åªå…³å¿ƒ `umd` åˆæ¬¡æ¸²æŸ“åº”ç”¨ï¼Œè®¾è®¡çš„è¿‡äºé¸¡è‚‹

#### ğŸ“ `unmount` å¸è½½åº”ç”¨

å¸è½½æµç¨‹åˆ†ä¸º 3 éƒ¨åˆ†ï¼š

#### 1. å¸è½½åº”ç”¨ - æ‰€æœ‰æ¨¡å¼

- `activeFlag` å¤±æ´»ï¼Œè§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- æ¸…ç†è·¯ç”±ï¼Œè§ï¼š`clearInactiveAppUrl` [[æŸ¥çœ‹](#clearinactiveappurlæ¸…ç†è·¯ç”±)]

> é‡å»ºæ¨¡å¼åœ¨å¸è½½åº”ç”¨æ—¶ï¼Œè™½ç„¶åªåšäº†è¿™ä¸€ä¸ªæ­¥éª¤ï¼Œä½†æ˜¯æ¯æ¬¡ `startApp` æ—¶ä¼šå°†æ•´ä¸ªå®ä¾‹éƒ½é”€æ¯ `destroy` [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]

#### 2. å¸è½½ `alive` æ¨¡å¼çš„åº”ç”¨

- ä½¿ç”¨æ²™ç®± `iframeWindow` è§¦å‘ç”Ÿå‘½å‘¨æœŸ `deactivated`

#### 3. å¸è½½ `umd` æ¨¡å¼çš„åº”ç”¨

å‡†å¤‡å¸è½½ `umd` æ¨¡å¼å­åº”ç”¨ï¼Œè¦æ±‚ï¼š

- `mountFlag` çŠ¶æ€å·²æŒ‚è½½ï¼Œè§ï¼š`Wujie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]
- å­åº”ç”¨ä¸­å­˜åœ¨ `__WUJIE_UNMOUNT`
- ä¸æ˜¯ `alive` æ¨¡å¼å¹¶ä¸”ä¸æ˜¯ `hrefFlag` åŠ«æŒå®¹å™¨ï¼Œè§ï¼šç‰¹æ®Šå±æ€§ [[æŸ¥çœ‹](#2-ç‰¹æ®Šå±æ€§)]

å¸è½½ `umd` æ¨¡å¼å­åº”ç”¨ï¼š

- ä½¿ç”¨æ²™ç®± `iframeWindow` è§¦å‘ç”Ÿå‘½å‘¨æœŸ `beforeUnmount`
- è°ƒç”¨å­åº”ç”¨æŒ‚è½½åœ¨ `window` ä¸Šçš„ `__WUJIE_UNMOUNT`
- ä½¿ç”¨æ²™ç®± `iframeWindow` è§¦å‘ç”Ÿå‘½å‘¨æœŸ `afterUnmount`
- `mountFlag` æ ‡è®°ä¸ºæœªæŒ‚è½½
- `this.bus.$clear`ï¼šæ¸…ç©ºå­åº”ç”¨æ‰€æœ‰ç›‘å¬çš„äº‹ä»¶ï¼Œè§ï¼š`WuJie` å®ä¾‹ä¸­å…³é”®å±æ€§ [[æŸ¥çœ‹](#-wujie-å®ä¾‹ä¸­å…³é”®å±æ€§)]

é `degrade` é™çº§éœ€è¦å¯¹ `shadowRoot` è¡¥å……æ“ä½œï¼š

- æ¸…ç©º `shadowRoot` ä¸‹æ‰€æœ‰å…ƒç´ ï¼Œå¹¶æ¸…ç†è®°å½•åœ¨å®ä¾‹ `head`ã€`body` çš„äº‹ä»¶

æœ€åå°†å®ä¾‹çš„ `head`ã€`body` ä¸‹çš„å…ƒç´ å…¨éƒ¨åˆ é™¤

- æ‰€æœ‰åˆ é™¤çš„å…ƒç´ ä¼šåœ¨ä¸‹æ¬¡ `active` æ¿€æ´»åº”ç”¨æ—¶ï¼Œé‡æ–°æ³¨å…¥åº”ç”¨èµ„æº
- æ¸…ç©ºçš„ç›‘å¬äº‹ä»¶ï¼Œä¹Ÿä¼šåœ¨ä¸‹æ¬¡ `active` æ¿€æ´»åº”ç”¨æ—¶é‡æ–°ç›‘å¬

#### 4. è§¦å‘åœºæ™¯

å®¹å™¨æ³¨é”€ä¼šè§¦å‘åº”ç”¨ `umount`ï¼š

| æ¨¡å¼     | å¸è½½åœºæ™¯ | æµç¨‹ 1 | æµç¨‹ 2 | æµç¨‹ 3 |
| -------- | -------- | ------ | ------ | ------ |
| `alive`  | å®¹å™¨æ³¨é”€ | æ‰§è¡Œ   | æ‰§è¡Œ   | ä¸æ‰§è¡Œ |
| `umd`    | å®¹å™¨æ³¨é”€ | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | æ‰§è¡Œ   |
| é‡å»ºæ¨¡å¼ | å®¹å™¨æ³¨é”€ | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ |

> æµç¨‹ 1ã€2ã€3 åˆ†åˆ«å¯¹åº”ä¸Šè¿°å½’çº³ 3 ç±»æµç¨‹

å®¹å™¨æ³¨é”€è§¦å‘çš„æ–¹å¼ï¼š

- `iframe` å®¹å™¨ï¼š`onunload`
- `shadowRoot` å®¹å™¨ï¼š`disconnectedCallback`

`alive` æ¨¡å¼ `unmount` æ—¶åªåšäº† 3 ä»¶äº‹ï¼š

- æ ‡è®° `activeFlag`ã€æ¸…ç†è·¯ç”±ã€è§¦å‘å£°æ˜å‘¨æœŸäº‹ä»¶
- ä¸æ¸…ç†å®¹å™¨ï¼Œä¹Ÿä¸æ³¨é”€åº”ç”¨ï¼Œä¸‹æ¬¡åˆ‡æ¢å›åº”ç”¨æ—¶ä¹Ÿä¸éœ€è¦é‡å¤åŠ è½½èµ„æº

`startApp` è§¦å‘åº”ç”¨ `umount`ï¼š

| æ¨¡å¼               | å¸è½½åœºæ™¯              | æµç¨‹ 1 | æµç¨‹ 2 | æµç¨‹ 3 |
| ------------------ | --------------------- | ------ | ------ | ------ |
| `umd` åˆ‡æ¢åº”ç”¨     | `active` å‰ `unmount` | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | æ‰§è¡Œ   |
| `umd` é¢„æ‰§è¡Œåå¯åŠ¨ | `active` å‰ `unmount` | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | æ‰§è¡Œ   |
| `umd` é¢„åŠ è½½åå¯åŠ¨ | è‡ªåŠ¨ `destroy`        | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | æ‰§è¡Œ   |
| é‡å»ºæ¨¡å¼å­˜åœ¨å®ä¾‹   | è‡ªåŠ¨ `destroy`        | æ‰§è¡Œ   | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ |
| é‡å»ºæ¨¡å¼åˆå§‹å®ä¾‹   | ä¸æ‰§è¡Œ `unmount`      | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ |
| `alive`            | ä¸æ‰§è¡Œ `unmount`      | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ | ä¸æ‰§è¡Œ |

ä»¥ä¸‹æ¨¡å¼ä¼šæ‰§è¡Œ 2 æ¬¡ `umount`ï¼š

- `umd` æ¨¡å¼ï¼šå®¹å™¨æ³¨é”€ 1 æ¬¡ï¼Œ`startApp` å¯åŠ¨ 1 æ¬¡
- é‡å»ºæ¨¡å¼ï¼šå®¹å™¨æ³¨é”€ 1 æ¬¡ï¼Œ`startApp` å¯åŠ¨é€šè¿‡ `destory` é”€æ¯å®ä¾‹ 1 æ¬¡

> å‰ææ¡ä»¶ï¼šåº”ç”¨å®ä¾‹å·²å­˜åœ¨ `idToSandboxCacheMap` [[æŸ¥çœ‹](#1-idtosandboxcachemapå­˜å‚¨æ— ç•Œå®ä¾‹å’Œé…ç½®)]

å…¶ä»–è§¦å‘åº”ç”¨ `umount` çš„åœºæ™¯ï¼š

- æ‰‹åŠ¨ `destroy` æ³¨é”€åº”ç”¨ [[æŸ¥çœ‹](#-destroy-é”€æ¯å®ä¾‹)]
- ç›‘å¬ `popstate`ï¼Œæµè§ˆå™¨å‰è¿›åé€€è§¦å‘ `iframe` å®¹å™¨ `onunload`

> è¿™ 2 ä¸ªåœºæ™¯æ‰§è¡Œæ–¹å¼å‚è€ƒï¼šå®¹å™¨æ³¨é”€ `unmount` æ‰§è¡Œæµç¨‹

å…³äº `onunload`ï¼š

- ä»…å­˜åœ¨é™çº§æ—¶ `iframe` å®¹å™¨ï¼Œç”¨äºä»£æ›¿ `web component` ä¸­çš„ `disconnectedCallback`
- ä¸å·§çš„æ˜¯è¿™ä¸ªäº‹ä»¶éšæ—¶å¯èƒ½ä¼šè¢«æµè§ˆå™¨åˆ é™¤
- ç›‘å¬ `popstate` åé€€ï¼Œä¼šæ ¹æ® `hrefFlag` å†³å®šæ˜¯å¦é‡æ–°æ¸²æŸ“å¹¶ç›‘å¬ `onunload` [[æŸ¥çœ‹](#processappforhrefjump-ç›‘å¬å‰è¿›å’Œåç«¯)]

